{"repo": "matplotlib/matplotlib", "pull_number": 28649, "instance_id": "matplotlib__matplotlib-28649", "issue_numbers": ["28648"], "base_commit": "adb97e848ca88f0b9abc5b1c5085f548847e3f8f", "patch": "diff --git a/lib/matplotlib/artist.py b/lib/matplotlib/artist.py\nindex 981365d852be..24aaa349ee05 100644\n--- a/lib/matplotlib/artist.py\n+++ b/lib/matplotlib/artist.py\n@@ -1365,7 +1365,9 @@ def format_cursor_data(self, data):\n                     delta = np.diff(\n                         self.norm.boundaries[neigh_idx:cur_idx + 2]\n                     ).max()\n-\n+                elif self.norm.vmin == self.norm.vmax:\n+                    # singular norms, use delta of 10% of only value\n+                    delta = np.abs(self.norm.vmin * .1)\n                 else:\n                     # Midpoints of neighboring color intervals.\n                     neighbors = self.norm.inverse(\ndiff --git a/lib/matplotlib/cbook.py b/lib/matplotlib/cbook.py\nindex e4f60aac37a8..2411784af3ec 100644\n--- a/lib/matplotlib/cbook.py\n+++ b/lib/matplotlib/cbook.py\n@@ -2252,6 +2252,10 @@ def _g_sig_digits(value, delta):\n     it is known with an error of *delta*.\n     \"\"\"\n     if delta == 0:\n+        if value == 0:\n+            # if both value and delta are 0, np.spacing below returns 5e-324\n+            # which results in rather silly results\n+            return 3\n         # delta = 0 may occur when trying to format values over a tiny range;\n         # in that case, replace it by the distance to the closest float.\n         delta = abs(np.spacing(value))\n", "test_patch": "diff --git a/lib/matplotlib/tests/test_image.py b/lib/matplotlib/tests/test_image.py\nindex dfacfccb3e0e..6de1754f9ed7 100644\n--- a/lib/matplotlib/tests/test_image.py\n+++ b/lib/matplotlib/tests/test_image.py\n@@ -390,7 +390,8 @@ def test_cursor_data_nonuniform(xy, data):\n         ([[.123, .987]], \"[0.123]\"),\n         ([[np.nan, 1, 2]], \"[]\"),\n         ([[1, 1+1e-15]], \"[1.0000000000000000]\"),\n-        ([[-1, -1]], \"[-1.0000000000000000]\"),\n+        ([[-1, -1]], \"[-1.0]\"),\n+        ([[0, 0]], \"[0.00]\"),\n     ])\n def test_format_cursor_data(data, text):\n     from matplotlib.backend_bases import MouseEvent\n", "problem_statement": "[Bug]: format_image_data on an image of only zeros produces a large number of zeros\n### Bug summary\n\nIf you use imshow, and then mouseover the image, the value is listed at the bottom of the plot.\r\nHowever, if the image contains only zeros, the result is a comical number of zeros.\n\n### Code for reproduction\n\n```Python\nimport matplotlib\r\nimport numpy as np\r\nmatplotlib.use('TkAgg')\r\nimport matplotlib.pyplot as plt\r\nfig, ax = plt.subplots()\r\nim = ax.imshow(np.zeros((4, 4)))\r\nfig.show()\n```\n\n\n### Actual outcome\n\nWhen you mouse-over the image it shows a large number of zeros (see bottom of image).\r\n![image](https://github.com/user-attachments/assets/e1cb7d31-31a2-48f8-afd5-0dd57446ec38)\n\n### Expected outcome\n\n0.0 should be at the bottom of the page and the window should retain its original size:\r\n![image](https://github.com/user-attachments/assets/25f03995-ea55-4eea-b9ee-1763513c7cbf)\r\n\n\n### Additional information\n\ntest_image.py\u2192test_image_cursor_formatting()  should test this perscise functionality, but there is a bug in this test where \r\n```py\r\n    data = np.ma.masked_array([0], mask=[False])\r\n    assert im.format_cursor_data(data) == '[0]'\r\n```\r\nshould be\r\n```py\r\n    data = np.ma.masked_array(0, mask=[False])\r\n    assert im.format_cursor_data(data) == '[0]'\r\n```\r\nAnd this causes `im.format_cursor_data` to fallback and '0' is returned. \r\nThis test should be updated as part of a PR to fix this bug. \r\n\n\n### Operating system\n\n_No response_\n\n### Matplotlib Version\n\nmatplotlib_dev, 3.8.2\n\n### Matplotlib Backend\n\nTkAgg\n\n### Python version\n\n_No response_\n\n### Jupyter version\n\n_No response_\n\n### Installation\n\ngit checkout\n", "hints_text": "The issue is singular norms.  We do a bunch of extra logic it https://github.com/matplotlib/matplotlib/blob/adb97e848ca88f0b9abc5b1c5085f548847e3f8f/lib/matplotlib/artist.py#L1349-L1377 to estimate a \"good\" number of digits via https://github.com/matplotlib/matplotlib/blob/adb97e848ca88f0b9abc5b1c5085f548847e3f8f/lib/matplotlib/cbook.py#L2249-L2267\r\n\r\n\r\n```\r\nIn [10]: import matplotlib.cbook as mc\r\n\r\nIn [11]: mc._g_sig_digits(0, 0)\r\nOut[13]: 325\r\n\r\nIn [14]: mc._g_sig_digits(0, .1)\r\nOut[14]: 2\r\n\r\nIn [15]: mc._g_sig_digits(0, 0)\r\nOut[15]: 325\r\n\r\nIn [16]: mc._g_sig_digits(0, .00001)\r\nOut[16]: 6\r\n\r\nIn [17]: mc._g_sig_digits(0, .000001)\r\nOut[17]: 7\r\n\r\nIn [18]: mc._g_sig_digits(0, .0001)\r\nOut[18]: 5\r\n\r\nIn [19]: mc._g_sig_digits(.1, 0)\r\nOut[19]: 17\r\n```\r\n\r\nI have some ideas, will open a PR shortly.", "created_at": "2024-08-02T16:28:55Z"}
{"repo": "matplotlib/matplotlib", "pull_number": 28629, "instance_id": "matplotlib__matplotlib-28629", "issue_numbers": ["28623", "0000"], "base_commit": "30f803b2e9b5e237c5c31df57f657ae69bec240d", "patch": "diff --git a/lib/matplotlib/axis.py b/lib/matplotlib/axis.py\nindex 483c9a3db15f..158d4a02ee61 100644\n--- a/lib/matplotlib/axis.py\n+++ b/lib/matplotlib/axis.py\n@@ -1362,7 +1362,7 @@ def get_tightbbox(self, renderer=None, *, for_layout_only=False):\n         collapsed to near zero.  This allows tight/constrained_layout to ignore\n         too-long labels when doing their layout.\n         \"\"\"\n-        if not self.get_visible():\n+        if not self.get_visible() or for_layout_only and not self.get_in_layout():\n             return\n         if renderer is None:\n             renderer = self.figure._get_renderer()\n", "test_patch": "diff --git a/lib/matplotlib/tests/test_axis.py b/lib/matplotlib/tests/test_axis.py\nindex 97b5f88dede1..33af30662a33 100644\n--- a/lib/matplotlib/tests/test_axis.py\n+++ b/lib/matplotlib/tests/test_axis.py\n@@ -8,3 +8,24 @@ def test_tick_labelcolor_array():\n     # Smoke test that we can instantiate a Tick with labelcolor as array.\n     ax = plt.axes()\n     XTick(ax, 0, labelcolor=np.array([1, 0, 0, 1]))\n+\n+\n+def test_axis_not_in_layout():\n+    fig1, (ax1_left, ax1_right) = plt.subplots(ncols=2, layout='constrained')\n+    fig2, (ax2_left, ax2_right) = plt.subplots(ncols=2, layout='constrained')\n+\n+    # 100 label overlapping the end of the axis\n+    ax1_left.set_xlim([0, 100])\n+    # 100 label not overlapping the end of the axis\n+    ax2_left.set_xlim([0, 120])\n+\n+    for ax in ax1_left, ax2_left:\n+        ax.set_xticks([0, 100])\n+        ax.xaxis.set_in_layout(False)\n+\n+    for fig in fig1, fig2:\n+        fig.draw_without_rendering()\n+\n+    # Positions should not be affected by overlapping 100 label\n+    assert ax1_left.get_position().bounds == ax2_left.get_position().bounds\n+    assert ax1_right.get_position().bounds == ax2_right.get_position().bounds\n", "problem_statement": "[Bug]: `Axis.set_in_layout` not respected?\n### Bug summary\r\n\r\nIf a tick label appears right at the end of an axis, constrained layout increases the gap between the subplots to accommodate it.  This is reasonable behaviour, but sometimes I would like to turn it off.  I tried setting `xaxis.set_in_layout(False)`, but that doesn't seem to make a difference.  Should it work?\r\n\r\n### Code for reproduction\r\n\r\n```Python\r\nimport matplotlib.pyplot as plt\r\n\r\n\r\ndef example_plot(xmax):   \r\n    fig, (ax1, ax2) = plt.subplots(ncols=2, layout='constrained')\r\n    \r\n    ax1.set_xlim([0, xmax])\r\n    ax1.set_xticks([0, 100])\r\n    ax1.xaxis.set_in_layout(False)\r\n    \r\n    fig.savefig(f'example_x{xmax}.png')\r\n    \r\n    plt.close(fig)\r\n    \r\n    \r\nfor xmax in 100, 120:\r\n    example_plot(xmax)\r\n```\r\n\r\n\r\n### Actual outcome\r\n\r\n`example_x120.png`\r\n![example_x120](https://github.com/user-attachments/assets/986b6055-55c4-4c8e-beb0-10c61d36fcba)\r\n`example_x100.png`\r\n![example_x100](https://github.com/user-attachments/assets/4a3feefb-b26c-4384-b5ce-2d8ef99e200f)\r\n\r\nWhen the \"100\" tick label is at the end of the x-axis the gap between the subplots is bigger.\r\n\r\n### Expected outcome\r\n\r\nI would like the gap between the subplots to not depend on the \"100\" label.\r\n\r\n### Additional information\r\n\r\nI haven't tried, but suspect we could make this work by just returning `None` here if `for_layout_only` is `True` and `self.get_in_layout` is `False`.\r\nhttps://github.com/matplotlib/matplotlib/blob/040091e9ea35df756ee838fe8b83a9deabe16f26/lib/matplotlib/axis.py#L1365-L1366\r\n\r\n### Operating system\r\n\r\nRHEL7\r\n\r\n### Matplotlib Version\r\n\r\n3.9.1\r\n\r\n### Matplotlib Backend\r\n\r\nQtAgg\r\n\r\n### Python version\r\n\r\n3.12.4\r\n\r\n### Jupyter version\r\n\r\nN/A\r\n\r\n### Installation\r\n\r\nconda\n", "hints_text": "I don't see why it should not be allowed to work, and your propped change seems good.\nHaving semi-recently looked at #28574, I'm fairly certain that none of the `Axis`, `Spine`, or `Tick`s obey `set_in_layout`, but only because they were never set up that way.\nI assumed it  would be futile to try to set it on the individual tick because of the way they are dynamically generated (my \"real\" example uses `MaxNLocator` on a colorbar).\r\n\r\nI'm unclear why `Spine`s wouldn't work properly as they appear to be handled within the general list of artists:\r\nhttps://github.com/matplotlib/matplotlib/blob/30f803b2e9b5e237c5c31df57f657ae69bec240d/lib/matplotlib/axes/_base.py#L4391-L4421", "created_at": "2024-07-30T16:54:25Z"}
{"repo": "matplotlib/matplotlib", "pull_number": 28609, "instance_id": "matplotlib__matplotlib-28609", "issue_numbers": ["28595", "0000"], "base_commit": "e6f2b0c72be421f3b324a55fca1dbc367405cce5", "patch": "diff --git a/lib/matplotlib/backends/backend_svg.py b/lib/matplotlib/backends/backend_svg.py\nindex 84e4f96ad4a7..623e1eb9ad82 100644\n--- a/lib/matplotlib/backends/backend_svg.py\n+++ b/lib/matplotlib/backends/backend_svg.py\n@@ -715,6 +715,8 @@ def draw_markers(\n             self._markers[dictkey] = oid\n \n         writer.start('g', **self._get_clip_attrs(gc))\n+        if gc.get_url() is not None:\n+            self.writer.start('a', {'xlink:href': gc.get_url()})\n         trans_and_flip = self._make_flip_transform(trans)\n         attrib = {'xlink:href': f'#{oid}'}\n         clip = (0, 0, self.width*72, self.height*72)\n@@ -726,6 +728,8 @@ def draw_markers(\n                 attrib['y'] = _short_float_fmt(y)\n                 attrib['style'] = self._get_style(gc, rgbFace)\n                 writer.element('use', attrib=attrib)\n+        if gc.get_url() is not None:\n+            self.writer.end('a')\n         writer.end('g')\n \n     def draw_path_collection(self, gc, master_transform, paths, all_transforms,\n", "test_patch": "diff --git a/lib/matplotlib/tests/test_backend_svg.py b/lib/matplotlib/tests/test_backend_svg.py\nindex 689495eb31ac..b850a9ab6ff5 100644\n--- a/lib/matplotlib/tests/test_backend_svg.py\n+++ b/lib/matplotlib/tests/test_backend_svg.py\n@@ -343,13 +343,17 @@ def test_url():\n     s.set_urls(['https://example.com/foo', 'https://example.com/bar', None])\n \n     # Line2D\n-    p, = plt.plot([1, 3], [6, 5])\n+    p, = plt.plot([2, 3, 4], [4, 5, 6])\n     p.set_url('https://example.com/baz')\n \n+    # Line2D markers-only\n+    p, = plt.plot([3, 4, 5], [4, 5, 6], linestyle='none', marker='x')\n+    p.set_url('https://example.com/quux')\n+\n     b = BytesIO()\n     fig.savefig(b, format='svg')\n     b = b.getvalue()\n-    for v in [b'foo', b'bar', b'baz']:\n+    for v in [b'foo', b'bar', b'baz', b'quux']:\n         assert b'https://example.com/' + v in b\n \n \n", "problem_statement": "[Bug]: set_url without effect for instances of Line2D with linestyle 'none'\n### Bug summary\n\nBug summary\r\nUsing SVG-backend, set_url does nothing for for instances of Line2D with linestyle='none', whereas it works for other objects.\r\nRelated to closed issue: https://github.com/matplotlib/matplotlib/issues/17336\n\n### Code for reproduction\n\n```Python\nfrom matplotlib import pyplot as plt\r\n\r\nf = plt.figure()\r\ns = plt.scatter([1, 2, 3], [4, 5, 6])\r\ns.set_urls(['http://www.bbc.co.uk/news', 'http://www.google.com', None])\r\np = plt.plot([1, 3], [6, 5], linestyle='none', color='green', marker='x')\r\np[0].set_url('http://www.duckduckgo.com')\r\n\r\nprint(s.get_urls())\r\nprint(p[0].get_url())\r\n\r\nimport io\r\nsvg = io.StringIO()\r\nf.savefig(svg, format='svg')\r\nf.savefig('test.svg', format='svg')\r\n\r\nassert \"http://www.google.com\" in svg.getvalue()\r\nassert \"http://www.duckduckgo.com\" in svg.getvalue()\n```\n\n\n### Actual outcome\n\nException has occurred: AssertionError\r\nexception: no description\r\n  File \"/home/peunting/from matplotlib import pyplot as plt.py\", line 18, in <module>\r\n    assert \"http://www.duckduckgo.com\" in svg.getvalue()\r\nAssertionError: \n\n### Expected outcome\n\nBoth http://www.google.com and http://www.duckduckgo.com should be present in the svg. When the svg is opened in a browser, the plot markers of the line plot should be clickable as well.\n\n### Additional information\n\n_No response_\n\n### Operating system\n\nRocky\n\n### Matplotlib Version\n\n3.8.2\n\n### Matplotlib Backend\n\nQtAgg\n\n### Python version\n\n3.10.12\n\n### Jupyter version\n\n_No response_\n\n### Installation\n\npip\n", "hints_text": "I think in lines.py, line 812, the urls for the markers should be set:\r\nhttps://github.com/matplotlib/matplotlib/blob/ed17e00da9b8119c0a01290ebcace64bc0120b84/lib/matplotlib/lines.py#L809-L814\r\n@QuLogic : Do you have an idea why it is not working?\nYes, that code means the backend receives the URL, but doesn't necessarily mean the backend does anything with it. For SVG, I don't see any handling of URLs for plain markers:\r\nhttps://github.com/matplotlib/matplotlib/blob/e6f2b0c72be421f3b324a55fca1dbc367405cce5/lib/matplotlib/backends/backend_svg.py#L692-L729", "created_at": "2024-07-23T20:37:00Z"}
{"repo": "matplotlib/matplotlib", "pull_number": 28582, "instance_id": "matplotlib__matplotlib-28582", "issue_numbers": ["28567", "0000"], "base_commit": "9b8a8c7246c4a8e78095675f33e7f10c9d815dc4", "patch": "diff --git a/lib/matplotlib/axes/_base.py b/lib/matplotlib/axes/_base.py\nindex 4606e5c01aec..a29583668a17 100644\n--- a/lib/matplotlib/axes/_base.py\n+++ b/lib/matplotlib/axes/_base.py\n@@ -2962,22 +2962,16 @@ def handle_single_axis(\n \n             # Prevent margin addition from crossing a sticky value.  A small\n             # tolerance must be added due to floating point issues with\n-            # streamplot; it is defined relative to x0, x1, x1-x0 but has\n+            # streamplot; it is defined relative to x1-x0 but has\n             # no absolute term (e.g. \"+1e-8\") to avoid issues when working with\n             # datasets where all values are tiny (less than 1e-8).\n-            tol = 1e-5 * max(abs(x0), abs(x1), abs(x1 - x0))\n+            tol = 1e-5 * abs(x1 - x0)\n             # Index of largest element < x0 + tol, if any.\n             i0 = stickies.searchsorted(x0 + tol) - 1\n             x0bound = stickies[i0] if i0 != -1 else None\n-            # Ensure the boundary acts only if the sticky is the extreme value\n-            if x0bound is not None and x0bound > x0:\n-                x0bound = None\n             # Index of smallest element > x1 - tol, if any.\n             i1 = stickies.searchsorted(x1 - tol)\n             x1bound = stickies[i1] if i1 != len(stickies) else None\n-            # Ensure the boundary acts only if the sticky is the extreme value\n-            if x1bound is not None and x1bound < x1:\n-                x1bound = None\n \n             # Add the margin in figure space and then transform back, to handle\n             # non-linear scales.\n", "test_patch": "diff --git a/lib/matplotlib/tests/baseline_images/test_axes/sticky_tolerance_cf.png b/lib/matplotlib/tests/baseline_images/test_axes/sticky_tolerance_cf.png\nnew file mode 100644\nindex 000000000000..a2e185c2769d\nBinary files /dev/null and b/lib/matplotlib/tests/baseline_images/test_axes/sticky_tolerance_cf.png differ\ndiff --git a/lib/matplotlib/tests/test_axes.py b/lib/matplotlib/tests/test_axes.py\nindex 13c181b68492..3791763f323f 100644\n--- a/lib/matplotlib/tests/test_axes.py\n+++ b/lib/matplotlib/tests/test_axes.py\n@@ -701,6 +701,16 @@ def test_sticky_tolerance():\n     axs.flat[3].barh(y=1, width=width, left=-20000.1)\n \n \n+@image_comparison(['sticky_tolerance_cf.png'], remove_text=True, style=\"mpl20\")\n+def test_sticky_tolerance_contourf():\n+    fig, ax = plt.subplots()\n+\n+    x = y = [14496.71, 14496.75]\n+    data = [[0, 1], [2, 3]]\n+\n+    ax.contourf(x, y, data)\n+\n+\n def test_nargs_stem():\n     with pytest.raises(TypeError, match='0 were given'):\n         # stem() takes 1-3 arguments.\n", "problem_statement": "[Bug]: sticky edge related changes for datetime plots\n### Bug summary\r\n\r\nHaving just picked up v3.9.1, we are seeing downstream image test failures due to additional whitespace in `contourf` and `pcolor` plots that use datetimes.  The change bisects to #28393.\r\n\r\n### Code for reproduction\r\n\r\n```Python\r\nimport datetime\r\n\r\nimport numpy as np\r\nimport matplotlib.pyplot as plt\r\n\r\ndts = [datetime.datetime(2009, 9, 9, 17, 0) + datetime.timedelta(minutes=n) for n in range(10, 61, 10)]\r\nfoo = range(5)\r\ndata = np.arange(30).reshape(6, 5)\r\n\r\nplt.contourf(foo, dts, data)\r\nplt.show()\r\n```\r\n\r\n\r\n### Actual outcome\r\n\r\n![image](https://github.com/user-attachments/assets/4f616f86-14d7-4335-b0c1-e5dfc637cdbc)\r\n\r\n\r\n### Expected outcome\r\n\r\nBefore #28393 I get\r\n![image](https://github.com/user-attachments/assets/e9dc1e03-2945-428b-bb71-eceb1114f5d4)\r\n\r\n\r\n### Additional information\r\n\r\n_No response_\r\n\r\n### Operating system\r\n\r\nUbuntu\r\n\r\n### Matplotlib Version\r\n\r\nv3.9.1 and `main`\r\n\r\n### Matplotlib Backend\r\n\r\n_No response_\r\n\r\n### Python version\r\n\r\n3.12\r\n\r\n### Jupyter version\r\n\r\n_No response_\r\n\r\n### Installation\r\n\r\nconda\n", "hints_text": "If I get hold of the contourset and the axes here, I have\r\n\r\n```python\r\nIn [4]: cs.sticky_edges.y[0] == ax.dataLim.ymin\r\nOut[4]: np.True_\r\n\r\nIn [5]: cs.sticky_edges.y[1] == ax.dataLim.ymax\r\nOut[5]: np.True_\r\n\r\nIn [6]: cs.sticky_edges.x[0] == ax.dataLim.xmin\r\nOut[6]: np.True_\r\n\r\nIn [7]: cs.sticky_edges.x[1] == ax.dataLim.xmax\r\nOut[7]: np.True_\r\n\r\n```\r\n:confused: \nIt seems like, by the time we get the the relevant comparison, somehow the sticky limits got flipped:\r\n\r\n```diff\r\ndiff --git a/lib/matplotlib/axes/_base.py b/lib/matplotlib/axes/_base.py\r\nindex 4606e5c01a..9d5274d9e6 100644\r\n--- a/lib/matplotlib/axes/_base.py\r\n+++ b/lib/matplotlib/axes/_base.py\r\n@@ -2969,12 +2969,14 @@ class _AxesBase(martist.Artist):\r\n             # Index of largest element < x0 + tol, if any.\r\n             i0 = stickies.searchsorted(x0 + tol) - 1\r\n             x0bound = stickies[i0] if i0 != -1 else None\r\n+            print(f'{x0bound=}, {x0=}')\r\n             # Ensure the boundary acts only if the sticky is the extreme value\r\n             if x0bound is not None and x0bound > x0:\r\n                 x0bound = None\r\n             # Index of smallest element > x1 - tol, if any.\r\n             i1 = stickies.searchsorted(x1 - tol)\r\n             x1bound = stickies[i1] if i1 != len(stickies) else None\r\n+            print(f'{x1bound=}, {x1=}')\r\n             # Ensure the boundary acts only if the sticky is the extreme value\r\n             if x1bound is not None and x1bound < x1:\r\n                 x1bound = None\r\n```\r\n```\r\nx0bound=np.float64(14496.75), x0=np.float64(14496.715277777777)\r\nx1bound=np.float64(14496.715277777777), x1=np.float64(14496.75)\r\n```\nSo I guess the problem is basically the same as #28223 in that the data range is less than the tolerance.  If I make the tolerance only a function of the range\r\n\r\n```python\r\ntol = 1e-5 * abs(x1 - x0)\r\n```\r\nas suggested at https://github.com/matplotlib/matplotlib/pull/28393#issuecomment-2168453717, this is fixed and no existing tests break.\nYeah, I came to the same conclusion... I think that works, and makes more sense to me... I can't think of a case where the absolute magnitude is preferred to the range of the data for this computation.", "created_at": "2024-07-16T19:42:29Z"}
{"repo": "matplotlib/matplotlib", "pull_number": 28577, "instance_id": "matplotlib__matplotlib-28577", "issue_numbers": ["28574", "0000"], "base_commit": "c51103a068db018bad1152f78141d6c7360c29ff", "patch": "diff --git a/lib/matplotlib/axis.py b/lib/matplotlib/axis.py\nindex 483c9a3db15f..d1bbd095da87 100644\n--- a/lib/matplotlib/axis.py\n+++ b/lib/matplotlib/axis.py\n@@ -33,12 +33,6 @@\n _gridline_param_names = ['grid_' + name\n                          for name in _line_param_names + _line_param_aliases]\n \n-_MARKER_DICT = {\n-    'out': (mlines.TICKDOWN, mlines.TICKUP),\n-    'in': (mlines.TICKUP, mlines.TICKDOWN),\n-    'inout': ('|', '|'),\n-}\n-\n \n class Tick(martist.Artist):\n     \"\"\"\n@@ -204,18 +198,21 @@ def _set_labelrotation(self, labelrotation):\n         _api.check_in_list(['auto', 'default'], labelrotation=mode)\n         self._labelrotation = (mode, angle)\n \n+    @property\n+    def _pad(self):\n+        return self._base_pad + self.get_tick_padding()\n+\n     def _apply_tickdir(self, tickdir):\n         \"\"\"Set tick direction.  Valid values are 'out', 'in', 'inout'.\"\"\"\n-        # This method is responsible for updating `_pad`, and, in subclasses,\n-        # for setting the tick{1,2}line markers as well.  From the user\n-        # perspective this should always be called through _apply_params, which\n-        # further updates ticklabel positions using the new pads.\n+        # This method is responsible for verifying input and, in subclasses, for setting\n+        # the tick{1,2}line markers.  From the user perspective this should always be\n+        # called through _apply_params, which further updates ticklabel positions using\n+        # the new pads.\n         if tickdir is None:\n             tickdir = mpl.rcParams[f'{self.__name__}.direction']\n         else:\n             _api.check_in_list(['in', 'out', 'inout'], tickdir=tickdir)\n         self._tickdir = tickdir\n-        self._pad = self._base_pad + self.get_tick_padding()\n \n     def get_tickdir(self):\n         return self._tickdir\n@@ -425,7 +422,11 @@ def _get_text2_transform(self):\n     def _apply_tickdir(self, tickdir):\n         # docstring inherited\n         super()._apply_tickdir(tickdir)\n-        mark1, mark2 = _MARKER_DICT[self._tickdir]\n+        mark1, mark2 = {\n+            'out': (mlines.TICKDOWN, mlines.TICKUP),\n+            'in': (mlines.TICKUP, mlines.TICKDOWN),\n+            'inout': ('|', '|'),\n+        }[self._tickdir]\n         self.tick1line.set_marker(mark1)\n         self.tick2line.set_marker(mark2)\n \n@@ -1617,6 +1618,14 @@ def _copy_tick_props(self, src, dest):\n         dest.tick1line.update_from(src.tick1line)\n         dest.tick2line.update_from(src.tick2line)\n         dest.gridline.update_from(src.gridline)\n+        dest.update_from(src)\n+        dest._loc = src._loc\n+        dest._size = src._size\n+        dest._width = src._width\n+        dest._base_pad = src._base_pad\n+        dest._labelrotation = src._labelrotation\n+        dest._zorder = src._zorder\n+        dest._tickdir = src._tickdir\n \n     def get_label_text(self):\n         \"\"\"Get the text of the label.\"\"\"\n", "test_patch": "diff --git a/lib/matplotlib/tests/test_axes.py b/lib/matplotlib/tests/test_axes.py\nindex e5ae14c6e66b..2c10a93796fa 100644\n--- a/lib/matplotlib/tests/test_axes.py\n+++ b/lib/matplotlib/tests/test_axes.py\n@@ -5741,6 +5741,28 @@ def test_reset_ticks(fig_test, fig_ref):\n         ax.yaxis.reset_ticks()\n \n \n+@mpl.style.context('mpl20')\n+def test_context_ticks():\n+    with plt.rc_context({\n+            'xtick.direction': 'in', 'xtick.major.size': 30, 'xtick.major.width': 5,\n+            'xtick.color': 'C0', 'xtick.major.pad': 12,\n+            'xtick.bottom': True, 'xtick.top': True,\n+            'xtick.labelsize': 14, 'xtick.labelcolor': 'C1'}):\n+        fig, ax = plt.subplots()\n+    # Draw outside the context so that all-but-first tick are generated with the normal\n+    # mpl20 style in place.\n+    fig.draw_without_rendering()\n+\n+    first_tick = ax.xaxis.majorTicks[0]\n+    for tick in ax.xaxis.majorTicks[1:]:\n+        assert tick._size == first_tick._size\n+        assert tick._width == first_tick._width\n+        assert tick._base_pad == first_tick._base_pad\n+        assert tick._labelrotation == first_tick._labelrotation\n+        assert tick._zorder == first_tick._zorder\n+        assert tick._tickdir == first_tick._tickdir\n+\n+\n def test_vline_limit():\n     fig = plt.figure()\n     ax = fig.gca()\n", "problem_statement": "[Bug]: Nondeterministic behavior with subplot spacing and constrained layout\n### Bug summary\r\n\r\nI'm trying to get constrained layout to remove all space between subplots when no artists should be preventing it. In this example I've set all necessary rc params accordingly and changed the axes limits to ensure the x-axis tick labels don't spill beyond the axis extent. The resulting space between the axes is nondeterministic.\r\n\r\n\r\n### Code for reproduction\r\n\r\n```Python\r\n%matplotlib inline\r\n\r\nimport matplotlib.pyplot as plt\r\nrc = {\r\n    \"xtick.direction\": \"in\", \r\n    \"ytick.direction\": \"in\",\r\n    \"figure.constrained_layout.use\": True,\r\n    \"figure.constrained_layout.h_pad\": 0,\r\n    \"figure.constrained_layout.w_pad\": 0,\r\n    \"figure.constrained_layout.wspace\": 0,\r\n    \"figure.constrained_layout.hspace\": 0,\r\n    \"axes.labelpad\": 0,\r\n}\r\n\r\nfor _ in range(2):\r\n    with plt.style.context(rc):\r\n        fig, axes = plt.subplots(1, 2, figsize=(6, 2), sharey=True)\r\n        \r\n        for ax in axes.flat:\r\n            ax.set_xlim(-0.1, 1.1)\r\n```\r\n\r\n\r\n### Actual outcome\r\n\r\nExample output (ran a handful of times until one of each result showed):\r\n![image](https://github.com/user-attachments/assets/23564beb-f5c1-4a03-a2f5-35cfb4083907)\r\n\r\n### Expected outcome\r\n\r\nZero spacing between the axes, deterministically.\r\n\r\n### Additional information\r\n\r\nI noticed that the results became deterministic (with zero space between panels) when saving the figure (that is, the result that displayed in the notebook, not just the saved figure). Inserting a `fig.canvas.draw()` at the end likewise ensures zero space deterministically.\r\n\r\n### Operating system\r\n\r\nRocky Linux\r\n\r\n### Matplotlib Version\r\n\r\n3.9.1\r\n\r\n### Matplotlib Backend\r\n\r\ninline\r\n\r\n### Python version\r\n\r\n3.11.9\r\n\r\n### Jupyter version\r\n\r\n4.2.3\r\n\r\n### Installation\r\n\r\nconda\n", "hints_text": "", "created_at": "2024-07-15T03:28:04Z"}
{"repo": "matplotlib/matplotlib", "pull_number": 28573, "instance_id": "matplotlib__matplotlib-28573", "issue_numbers": ["27878", "0000"], "base_commit": "c4510cae31e37f5dd8fe7ac8c3843e72ec8492ee", "patch": "diff --git a/doc/users/next_whats_new/exception_prop_name.rst b/doc/users/next_whats_new/exception_prop_name.rst\nnew file mode 100644\nindex 000000000000..c887b879393c\n--- /dev/null\n+++ b/doc/users/next_whats_new/exception_prop_name.rst\n@@ -0,0 +1,26 @@\n+Exception handling control\n+~~~~~~~~~~~~~~~~~~~~~~~~~~\n+\n+The exception raised when an invalid keyword parameter is passed now includes\n+that parameter name as the exception's ``name`` property.  This provides more\n+control for exception handling:\n+\n+\n+.. code-block:: python\n+\n+    import matplotlib.pyplot as plt\n+\n+    def wobbly_plot(args, **kwargs):\n+        w = kwargs.pop('wobble_factor', None)\n+\n+        try:\n+            plt.plot(args, **kwargs)\n+        except AttributeError as e:\n+            raise AttributeError(f'wobbly_plot does not take parameter {e.name}') from e\n+\n+\n+    wobbly_plot([0, 1], wibble_factor=5)\n+\n+.. code-block::\n+\n+    AttributeError: wobbly_plot does not take parameter wibble_factor\ndiff --git a/lib/matplotlib/artist.py b/lib/matplotlib/artist.py\nindex baf3b01ee6e5..345a61bfc16a 100644\n--- a/lib/matplotlib/artist.py\n+++ b/lib/matplotlib/artist.py\n@@ -1190,7 +1190,8 @@ def _update_props(self, props, errfmt):\n         Helper for `.Artist.set` and `.Artist.update`.\n \n         *errfmt* is used to generate error messages for invalid property\n-        names; it gets formatted with ``type(self)`` and the property name.\n+        names; it gets formatted with ``type(self)`` for \"{cls}\" and the\n+        property name for \"{prop_name}\".\n         \"\"\"\n         ret = []\n         with cbook._setattr_cm(self, eventson=False):\n@@ -1203,7 +1204,8 @@ def _update_props(self, props, errfmt):\n                     func = getattr(self, f\"set_{k}\", None)\n                     if not callable(func):\n                         raise AttributeError(\n-                            errfmt.format(cls=type(self), prop_name=k))\n+                            errfmt.format(cls=type(self), prop_name=k),\n+                            name=k)\n                     ret.append(func(v))\n         if ret:\n             self.pchanged()\n", "test_patch": "diff --git a/lib/mpl_toolkits/mplot3d/tests/test_axes3d.py b/lib/mpl_toolkits/mplot3d/tests/test_axes3d.py\nindex be988c31ee75..f519b42098e5 100644\n--- a/lib/mpl_toolkits/mplot3d/tests/test_axes3d.py\n+++ b/lib/mpl_toolkits/mplot3d/tests/test_axes3d.py\n@@ -1501,8 +1501,9 @@ def test_calling_conventions(self):\n             ax.voxels(x, y)\n         # x, y, z are positional only - this passes them on as attributes of\n         # Poly3DCollection\n-        with pytest.raises(AttributeError):\n+        with pytest.raises(AttributeError, match=\"keyword argument 'x'\") as exec_info:\n             ax.voxels(filled=filled, x=x, y=y, z=z)\n+        assert exec_info.value.name == 'x'\n \n \n def test_line3d_set_get_data_3d():\n", "problem_statement": "[ENH]: AttributeError('... got an unexpected keyword argument ...') should set the .name attribute to the keyword\n### Problem\n\nI am in the process to write a library that uses the matplotlib library for its graphics needs. As such, most of \"our\" graphics functions are wrappers around existing matplotlib functions such as tripcolor, tricontour\u2026 A typical function of ours would be:\r\n\r\n```\r\ndef fun_name_altered(lib_objects, **kwargs):\r\n    args = prepare_args(lib_objects, **kwargs)\r\n    plt.fun_name(*args, **kwargs)\r\n```\r\n\r\nIn this case the `kwargs` dictionnary may contain keywords aimed at the `prepare_args` process and keywords aimed at controlling the plotting. At the moment, `prepare_args` removes keywords from the dictionnary when used so that in principle, when `kwargs` arrive at `plt.fun_name`, it should only contain keywords known to `plt.fun_name`\r\n\r\nHowever, if the user makes a mistake while setting the keyword for OUR part, it is not properly handled by `prepare_args` and it does remain inside `kwargs` and then is passed to `plt.fun_name` which then raises an `AttributeError('... got an unexpected keyword argument ...')`.\r\n\r\nI would like to be able to try and recover if that happens.\n\n### Proposed solution\n\nFrom the  [Built-in Exceptions documentation page](https://docs.python.org/3/library/exceptions.html#bltin-exceptions)\r\n\r\n> The name and obj attributes can be set using keyword-only arguments to the constructor. When set they represent the name of the attribute that was attempted to be accessed and the object that was accessed for said attribute, respectively.\r\nChanged in version 3.10: Added the name and obj attributes\r\n\r\nI looked at the matplotlib codebase but I am not an expert programmer so I may be wrong but I think what I would like was that `Artist._update_props`  set the `name` attribute to `k` when raising the `AttributeError`.\r\n\r\nSince I am using Python 3.11 this would allow me to try and remove spurious keywords.\n", "hints_text": "This seems reasonable to me.  My understanding is the same and it should just be a case of adding `name=k` here:\r\n\r\nhttps://github.com/matplotlib/matplotlib/blob/0da2da00d5a884db9c7991c31ee81d1b5dc57b63/lib/matplotlib/artist.py#L1193-L1194\r\n\r\nThis will break for python 3.9 but, according to the [NEP29 schedule](https://numpy.org/neps/nep-0029-deprecation_policy.html#support-table), we should be dropping support for that in April anyway.  So if we target this for Matplotlib 3.10 there will be no problem.", "created_at": "2024-07-14T07:49:51Z"}
{"repo": "matplotlib/matplotlib", "pull_number": 28541, "instance_id": "matplotlib__matplotlib-28541", "issue_numbers": ["28538", "0000"], "base_commit": "830361d544ccca824e4df745eabf25dd4afdd26f", "patch": "diff --git a/lib/matplotlib/font_manager.py b/lib/matplotlib/font_manager.py\nindex 813bee6eb623..d9560ec0cc0f 100644\n--- a/lib/matplotlib/font_manager.py\n+++ b/lib/matplotlib/font_manager.py\n@@ -965,11 +965,11 @@ def json_dump(data, filename):\n     This function temporarily locks the output file to prevent multiple\n     processes from overwriting one another's output.\n     \"\"\"\n-    with cbook._lock_path(filename), open(filename, 'w') as fh:\n-        try:\n+    try:\n+        with cbook._lock_path(filename), open(filename, 'w') as fh:\n             json.dump(data, fh, cls=_JSONEncoder, indent=2)\n-        except OSError as e:\n-            _log.warning('Could not save font_manager cache %s', e)\n+    except OSError as e:\n+        _log.warning('Could not save font_manager cache %s', e)\n \n \n def json_load(filename):\n", "test_patch": "diff --git a/lib/matplotlib/tests/test_font_manager.py b/lib/matplotlib/tests/test_font_manager.py\nindex 2dc530bf984b..c6fc422ca613 100644\n--- a/lib/matplotlib/tests/test_font_manager.py\n+++ b/lib/matplotlib/tests/test_font_manager.py\n@@ -16,7 +16,7 @@\n     json_dump, json_load, get_font, is_opentype_cff_font,\n     MSUserFontDirectories, _get_fontconfig_fonts, ttfFontProperty)\n from matplotlib import cbook, ft2font, pyplot as plt, rc_context, figure as mfigure\n-from matplotlib.testing import subprocess_run_helper\n+from matplotlib.testing import subprocess_run_helper, subprocess_run_for_testing\n \n \n has_fclist = shutil.which('fc-list') is not None\n@@ -287,6 +287,28 @@ def test_fontcache_thread_safe():\n     subprocess_run_helper(_test_threading, timeout=10)\n \n \n+def test_lockfilefailure(tmp_path):\n+    # The logic here:\n+    # 1. get a temp directory from pytest\n+    # 2. import matplotlib which makes sure it exists\n+    # 3. get the cache dir (where we check it is writable)\n+    # 4. make it not writable\n+    # 5. try to write into it via font manager\n+    proc = subprocess_run_for_testing(\n+        [\n+            sys.executable,\n+            \"-c\",\n+            \"import matplotlib;\"\n+            \"import os;\"\n+            \"p = matplotlib.get_cachedir();\"\n+            \"os.chmod(p, 0o555);\"\n+            \"import matplotlib.font_manager;\"\n+        ],\n+        env={**os.environ, 'MPLCONFIGDIR': str(tmp_path)},\n+        check=True\n+    )\n+\n+\n def test_fontentry_dataclass():\n     fontent = FontEntry(name='font-name')\n \n", "problem_statement": "[Bug]: Permission denied when importing matplotlib.pyplot\n### Bug summary\r\n\r\nOnce I type \" import matplotlib.pyplot as plt\" and run it, jupyter always returns\uff1a\r\n\uff02Matplotlib is building the font cache; this may take a moment.\uff02\r\n\uff03Then the return messages will end up as \uff1a\r\n \"PermissionError: [Errno 13] Permission denied: 'C:\\\\Users\\\\J\\\\.matplotlib\\\\fontlist-v330.json.matplotlib-lock'\r\n\r\nAnd the functions of matplotlib.pyplot can not be excuted.\r\n\r\n### Code for reproduction\r\n\r\n```Python\r\nimport matplotlib.pyplot as plt\r\n```\r\n\r\n\r\n### Actual outcome\r\n```\r\nMatplotlib is building the font cache; this may take a moment.\r\n\r\nPermissionError                           Traceback (most recent call last)\r\nCell In[3], line 1\r\n----> 1 import matplotlib.pyplot as plt\r\n\r\nFile ~\\anaconda3\\Lib\\site-packages\\matplotlib\\pyplot.py:56\r\n     54 from cycler import cycler\r\n     55 import matplotlib\r\n---> 56 import matplotlib.colorbar\r\n     57 import matplotlib.image\r\n     58 from matplotlib import _api\r\n\r\nFile ~\\anaconda3\\Lib\\site-packages\\matplotlib\\colorbar.py:19\r\n     16 import numpy as np\r\n     18 import matplotlib as mpl\r\n---> 19 from matplotlib import _api, cbook, collections, cm, colors, contour, ticker\r\n     20 import matplotlib.artist as martist\r\n     21 import matplotlib.patches as mpatches\r\n\r\nFile ~\\anaconda3\\Lib\\site-packages\\matplotlib\\contour.py:15\r\n     13 import matplotlib as mpl\r\n     14 from matplotlib import _api, _docstring\r\n---> 15 from matplotlib.backend_bases import MouseButton\r\n     16 from matplotlib.lines import Line2D\r\n     17 from matplotlib.path import Path\r\n\r\nFile ~\\anaconda3\\Lib\\site-packages\\matplotlib\\backend_bases.py:46\r\n     43 import numpy as np\r\n     45 import matplotlib as mpl\r\n---> 46 from matplotlib import (\r\n     47     _api, backend_tools as tools, cbook, colors, _docstring, text,\r\n     48     _tight_bbox, transforms, widgets, is_interactive, rcParams)\r\n     49 from matplotlib._pylab_helpers import Gcf\r\n     50 from matplotlib.backend_managers import ToolManager\r\n\r\nFile ~\\anaconda3\\Lib\\site-packages\\matplotlib\\text.py:16\r\n     14 from . import _api, artist, cbook, _docstring\r\n     15 from .artist import Artist\r\n---> 16 from .font_manager import FontProperties\r\n     17 from .patches import FancyArrowPatch, FancyBboxPatch, Rectangle\r\n     18 from .textpath import TextPath, TextToPath  # noqa # Logically located here\r\n\r\nFile ~\\anaconda3\\Lib\\site-packages\\matplotlib\\font_manager.py:1582\r\n   1578     _log.info(\"generated new fontManager\")\r\n   1579     return fm\r\n-> 1582 fontManager = _load_fontmanager()\r\n   1583 findfont = fontManager.findfont\r\n   1584 get_font_names = fontManager.get_font_names\r\n\r\nFile ~\\anaconda3\\Lib\\site-packages\\matplotlib\\font_manager.py:1577, in _load_fontmanager(try_read_cache)\r\n   1575             return fm\r\n   1576 fm = FontManager()\r\n-> 1577 json_dump(fm, fm_path)\r\n   1578 _log.info(\"generated new fontManager\")\r\n   1579 return fm\r\n\r\nFile ~\\anaconda3\\Lib\\site-packages\\matplotlib\\font_manager.py:963, in json_dump(data, filename)\r\n    946 def json_dump(data, filename):\r\n    947     \"\"\"\r\n    948     Dump `FontManager` *data* as JSON to the file named *filename*.\r\n    949 \r\n   (...)\r\n    961     processes from overwriting one another's output.\r\n    962     \"\"\"\r\n--> 963     with cbook._lock_path(filename), open(filename, 'w') as fh:\r\n    964         try:\r\n    965             json.dump(data, fh, cls=_JSONEncoder, indent=2)\r\n\r\nFile ~\\anaconda3\\Lib\\contextlib.py:137, in _GeneratorContextManager.__enter__(self)\r\n    135 del self.args, self.kwds, self.func\r\n    136 try:\r\n--> 137     return next(self.gen)\r\n    138 except StopIteration:\r\n    139     raise RuntimeError(\"generator didn't yield\") from None\r\n\r\nFile ~\\anaconda3\\Lib\\site-packages\\matplotlib\\cbook.py:1821, in _lock_path(path)\r\n   1819 for _ in range(retries):\r\n   1820     try:\r\n-> 1821         with lock_path.open(\"xb\"):\r\n   1822             break\r\n   1823     except FileExistsError:\r\n\r\nFile ~\\anaconda3\\Lib\\pathlib.py:1013, in Path.open(self, mode, buffering, encoding, errors, newline)\r\n   1011 if \"b\" not in mode:\r\n   1012     encoding = io.text_encoding(encoding)\r\n-> 1013 return io.open(self, mode, buffering, encoding, errors, newline)\r\n\r\nPermissionError: [Errno 13] Permission denied: 'C:\\\\Users\\\\happy\\\\.matplotlib\\\\fontlist-v330.json.matplotlib-lock'\r\n\r\n### Expected outcome\r\n\r\nThe expected outcome is to successful import matplotlib.pyplot. \r\n(\uff33\uff4f\uff52\uff52\uff59\u3000\uff54\uff4f\u3000\uff42\uff4f\uff54\uff48\uff45\uff52\u3000\uff59\uff4f\uff55\uff0e\r\nI have struggled with this for more than 2 weeks and searched different methods to resolve it. But, ...\r\nPlease help me to out of this, many many thanks!)\r\n\r\n### Additional information\r\n\r\n\uff0aWhat are the conditions under which this bug happens? input parameters, edge cases, etc?\r\nAns: When I type \" import matplotlib.pyplot as plt\" and run it in the Jupyter Notebook.\r\n\uff0aHas this worked in earlier versions? \r\nAns:\u3000No. \r\n\uff0aDo you know why this bug is happening?\r\n\uff21\uff4e\uff53\uff1a\u3000 No. \r\n\uff0aDo you maybe even know a fix? \r\n\uff21\uff4e\uff53\uff1aNo.\r\nI have tried a lot of times to figure out this import problem, including uninstall/reinstall anaconda, python, upgrade the version of matplotlib......\r\n Based on the google search results, I also tried to type\r\n \"import matplotlib matplotlib.use('TkAgg')\" \r\nbefore I import matplotlib.pyplot. \r\nBut it returns me \r\n\uff02Cell In[2], \r\nline 1     import matplotlib matplotlib.use('TkAgg')                       \r\n^ SyntaxError: invalid syntax\uff02\r\n```\r\n\r\n### Operating system\r\n\r\n\uff37\uff49\uff4e\uff44\uff4f\uff57\uff53\r\n\r\n### Matplotlib Version\r\n\r\nmatplotlib 3.8.4\r\n\r\n### Matplotlib Backend\r\n\r\nmatplotlib-inline 0.1.6\r\n\r\n### Python version\r\n\r\nPython 3.12.3\r\n\r\n### Jupyter version\r\n\r\n\uff2a\uff55\uff50\uff59\uff54\uff45\uff52\u30007.0.8\r\n\r\n### Installation\r\n\r\nconda\r\n\r\n\r\n[TAC edited to add markup]\n", "hints_text": "The error is that you don't have permission to create `C:\\Users\\J\\.matplotlib\\fontlist-v330.json.matplotlib-lock`. This is unusual, but I doubt there is a bug in matplotlib. You need to see what the permissions are for the `C:\\Users\\J\\.matplotlib\\` folder. I am assuming that you are logged in as the user `J`?\nAgree that this is a permissions issue and you should sort out why a process running as your user can not create the lock file.  I would try removing `C:\\Users\\J\\.matplotlib` and letting us re-generate it on the next import.  On startup we check that the path exists, is a directory, and is writable.  It would be good to sort out how you got to this state so we can make our test more correct.\r\n\r\nhttps://github.com/matplotlib/matplotlib/blob/6b7b99927458de5980f8d5590073dd81e44e4cc5/lib/matplotlib/__init__.py#L520-L534\r\n\r\nis how we are currently checking that we can write to the cache directory.\r\n\r\nThat said, we do have the behavior that if the config directory is not writable we skip writing and continue on.  \r\n\r\nhttps://github.com/matplotlib/matplotlib/blob/6b7b99927458de5980f8d5590073dd81e44e4cc5/lib/matplotlib/font_manager.py#L968-L972\r\n\r\nWe are being careful about the json writing failing, but not careful about the lock failing!  \n> The error is that you don't have permission to create `C:\\Users\\J\\.matplotlib\\fontlist-v330.json.matplotlib-lock`. This is unusual, but I doubt there is a bug in matplotlib. You need to see what the permissions are for the `C:\\Users\\J\\.matplotlib\\` folder. I am assuming that you are logged in as the user `J`?\r\n\r\n\r\n\r\nDear WeatherGod  and tacaswell,\r\nThank you so much for your suggestion.\r\nYes, I am login as \"J\". \r\nI will try what your suggestions to see whether it can be resolved or not.\r\n\r\nActually, when I bumped into that import problem, I had tried to figure it out by reinstall my Anaconda and Python, therefor I remove both of them through the \"Uninstall or change a program\"  of \"Control panel\". \r\nAfter the removing, I did the re-install of Anaconda. But one message is shown up as:\r\n \"A version of Python 3.12(64-bit) is alreadt at C:\\Program Files\\WindowsApps\\PythonSoftwareFoundation.Python.3.12_3.12.1264.O_x64_qbz5n2kfra8pO\r\nWe recommend that if you want Anaconda3 registered as your system Python, you unregister this Python first. If you really know this is what you want, click OK, otherwise click cancel to continue.\"\r\nTherefor, I went back to check the existence of Python form  the \"Uninstall or change a program\" , but there is nothing left.\r\nThen, I tried to reach the Python 3.12 mentioned in the above message to remove it. But I was prohibited from accessing the C:\\Program Files\\.\r\nSo I went back to the Anaconda installation and finish it.\r\nAfter that, I checked the versions of Anaconda, Python. Open the jupyter notebook and type the \"import matplotlib.pyplot as plt\" and run it, and, the Denied Message shown it self again to me.\r\nI am wondering whether this event being related with this import denied problem since before that, the use of jupyter and importing of matplotlib.pyplot were smooth.\r\n\r\nA lot of thanks for your great suggestions. I will try it! Thank you!\nIt is highly unlikely that the installation and uninstallation problems\r\nhave anything to do with the permission issues.\r\n\r\nOn Thu, Jul 11, 2024 at 12:24\u202fPM JCisCS ***@***.***> wrote:\r\n\r\n> The error is that you don't have permission to create\r\n> C:\\Users\\J\\.matplotlib\\fontlist-v330.json.matplotlib-lock. This is\r\n> unusual, but I doubt there is a bug in matplotlib. You need to see what the\r\n> permissions are for the C:\\Users\\J\\.matplotlib\\ folder. I am assuming\r\n> that you are logged in as the user J?\r\n>\r\n> Dear WeatherGod and tacaswell,\r\n> Thank you so much for your suggestion.\r\n> Yes, I am login as \"J\".\r\n> I will try what your suggestions to see whether it can be resolved or not.\r\n>\r\n> Actually, when I bumped into that import problem, I had tried to figure it\r\n> out by reinstall my Anaconda and Python, therefor I remove both of them\r\n> through the \"Uninstall or change a program\" of \"Control panel\".\r\n> After the removing, I did the re-install of Anaconda. But one message is\r\n> shown up as:\r\n> \"A version of Python 3.12(64-bit) is alreadt at C:\\Program\r\n> Files\\WindowsApps\\PythonSoftwareFoundation.Python.3.12_3.12.1264.O_x64_qbz5n2kfra8pO\r\n> We recommend that if you want Anaconda3 registered as your system Python,\r\n> you unregister this Python first. If you really know this is what you want,\r\n> click OK, otherwise click cancel to continue.\"\r\n> Therefor, I went back to check the existence of Python form the \"Uninstall\r\n> or change a program\" , but there is nothing left.\r\n> Then, I tried to reach the Python 3.12 mentioned in the above message to\r\n> remove it. But I was prohibited from accessing the C:\\Program Files.\r\n> So I went back to the Anaconda installation and finish it.\r\n> After that, I checked the versions of Anaconda, Python. Open the jupyter\r\n> notebook and type the \"import matplotlib.pyplot as plt\" and run it, and,\r\n> the Denied Message shown it self again to me.\r\n> I am wondering whether this event being related with this import denied\r\n> problem since before that, the use of jupyter and importing of\r\n> matplotlib.pyplot were smooth.\r\n>\r\n> A lot of thanks for your great suggestions. I will try it! Thank you!\r\n>\r\n> \u2014\r\n> Reply to this email directly, view it on GitHub\r\n> <https://github.com/matplotlib/matplotlib/issues/28538#issuecomment-2223363412>,\r\n> or unsubscribe\r\n> <https://github.com/notifications/unsubscribe-auth/AACHF6CSFKKV7AT5QNNLS7LZL2WUFAVCNFSM6AAAAABKWUVYHWVHI2DSMVQWIX3LMV43OSLTON2WKQ3PNVWWK3TUHMZDEMRTGM3DGNBRGI>\r\n> .\r\n> You are receiving this because you commented.Message ID:\r\n> ***@***.***>\r\n>\r\n\nI'm going to re-open this as we should not be failing to import due to failure to write the cache.", "created_at": "2024-07-11T20:43:11Z"}
{"repo": "matplotlib/matplotlib", "pull_number": 28503, "instance_id": "matplotlib__matplotlib-28503", "issue_numbers": ["28489", "0000"], "base_commit": "e5225b4a5d3486637852fff2d37dc129da12fce4", "patch": "diff --git a/.circleci/config.yml b/.circleci/config.yml\nindex 5b4cbf5570b8..7436698c8068 100644\n--- a/.circleci/config.yml\n+++ b/.circleci/config.yml\n@@ -216,9 +216,9 @@ commands:\n #\n \n jobs:\n-  docs-python39:\n+  docs-python310:\n     docker:\n-      - image: cimg/python:3.9\n+      - image: cimg/python:3.10\n     resource_class: large\n     steps:\n       - checkout\n@@ -259,4 +259,4 @@ workflows:\n     jobs:\n       # NOTE: If you rename this job, then you must update the `if` condition\n       # and `circleci-jobs` option in `.github/workflows/circleci.yml`.\n-      - docs-python39\n+      - docs-python310\ndiff --git a/.github/workflows/cibuildwheel.yml b/.github/workflows/cibuildwheel.yml\nindex 050ff16cfbbd..50adc91980de 100644\n--- a/.github/workflows/cibuildwheel.yml\n+++ b/.github/workflows/cibuildwheel.yml\n@@ -46,7 +46,7 @@ jobs:\n       - uses: actions/setup-python@v5\n         name: Install Python\n         with:\n-          python-version: 3.9\n+          python-version: '3.10'\n \n       # Something changed somewhere that prevents the downloaded-at-build-time\n       # licenses from being included in built wheels, so pre-download them so\n@@ -158,22 +158,14 @@ jobs:\n           CIBW_BUILD: \"cp310-*\"\n           CIBW_ARCHS: ${{ matrix.cibw_archs }}\n \n-      - name: Build wheels for CPython 3.9\n-        uses: pypa/cibuildwheel@7e5a838a63ac8128d71ab2dfd99e4634dd1bca09  # v2.19.2\n-        with:\n-          package-dir: dist/${{ needs.build_sdist.outputs.SDIST_NAME }}\n-        env:\n-          CIBW_BUILD: \"cp39-*\"\n-          CIBW_ARCHS: ${{ matrix.cibw_archs }}\n-\n       - name: Build wheels for PyPy\n         uses: pypa/cibuildwheel@7e5a838a63ac8128d71ab2dfd99e4634dd1bca09  # v2.19.2\n         with:\n           package-dir: dist/${{ needs.build_sdist.outputs.SDIST_NAME }}\n         env:\n-          CIBW_BUILD: \"pp39-*\"\n+          CIBW_BUILD: \"pp310-*\"\n           CIBW_ARCHS: ${{ matrix.cibw_archs }}\n-        if: matrix.cibw_archs != 'aarch64'\n+        if: matrix.cibw_archs != 'aarch64' && matrix.os != 'windows-latest'\n \n       - uses: actions/upload-artifact@v4\n         with:\ndiff --git a/.github/workflows/circleci.yml b/.github/workflows/circleci.yml\nindex 3aead720cf20..c96dbecda7a1 100644\n--- a/.github/workflows/circleci.yml\n+++ b/.github/workflows/circleci.yml\n@@ -3,7 +3,7 @@ name: \"CircleCI artifact handling\"\n on: [status]\n jobs:\n   circleci_artifacts_redirector_job:\n-    if: \"${{ github.event.context == 'ci/circleci: docs-python39' }}\"\n+    if: \"${{ github.event.context == 'ci/circleci: docs-python310' }}\"\n     permissions:\n       statuses: write\n     runs-on: ubuntu-latest\n@@ -16,11 +16,11 @@ jobs:\n           repo-token: ${{ secrets.GITHUB_TOKEN }}\n           api-token: ${{ secrets.CIRCLECI_TOKEN }}\n           artifact-path: 0/doc/build/html/index.html\n-          circleci-jobs: docs-python39\n+          circleci-jobs: docs-python310\n           job-title: View the built docs\n \n   post_warnings_as_review:\n-    if: \"${{ github.event.context == 'ci/circleci: docs-python39' }}\"\n+    if: \"${{ github.event.context == 'ci/circleci: docs-python310' }}\"\n     permissions:\n       contents: read\n       checks: write\ndiff --git a/.github/workflows/cygwin.yml b/.github/workflows/cygwin.yml\nindex 58c132315b6f..b8bb4400f2f3 100644\n--- a/.github/workflows/cygwin.yml\n+++ b/.github/workflows/cygwin.yml\n@@ -49,10 +49,12 @@ jobs:\n   test-cygwin:\n     runs-on: windows-latest\n     name: Python 3.${{ matrix.python-minor-version }} on Cygwin\n+    # Enable these when Cygwin has Python 3.12.\n     if: >-\n       github.event_name == 'workflow_dispatch' ||\n-      github.event_name == 'schedule' ||\n+      (false && github.event_name == 'schedule') ||\n       (\n+        false &&\n         github.repository == 'matplotlib/matplotlib' &&\n         !contains(github.event.head_commit.message, '[ci skip]') &&\n         !contains(github.event.head_commit.message, '[skip ci]') &&\n@@ -72,7 +74,7 @@ jobs:\n       )\n     strategy:\n       matrix:\n-        python-minor-version: [9]\n+        python-minor-version: [12]\n \n     steps:\n       - name: Fix line endings\ndiff --git a/.github/workflows/reviewdog.yml b/.github/workflows/reviewdog.yml\nindex fbd724571d80..12b59d866e42 100644\n--- a/.github/workflows/reviewdog.yml\n+++ b/.github/workflows/reviewdog.yml\n@@ -17,7 +17,7 @@ jobs:\n       - name: Set up Python 3\n         uses: actions/setup-python@v5\n         with:\n-          python-version: 3.9\n+          python-version: '3.10'\n \n       - name: Install flake8\n         run: pip3 install -r requirements/testing/flake8.txt\n@@ -42,7 +42,7 @@ jobs:\n       - name: Set up Python 3\n         uses: actions/setup-python@v5\n         with:\n-          python-version: 3.9\n+          python-version: '3.10'\n \n       - name: Install mypy\n         run: pip3 install -r requirements/testing/mypy.txt -r requirements/testing/all.txt\ndiff --git a/azure-pipelines.yml b/azure-pipelines.yml\nindex 91e653b033f2..35c95c3b1f94 100644\n--- a/azure-pipelines.yml\n+++ b/azure-pipelines.yml\n@@ -49,29 +49,20 @@ stages:\n       - job: Pytest\n         strategy:\n           matrix:\n-            Linux_py39:\n-              vmImage: 'ubuntu-20.04'  # keep one job pinned to the oldest image\n-              python.version: '3.9'\n             Linux_py310:\n-              vmImage: 'ubuntu-latest'\n+              vmImage: 'ubuntu-20.04'  # keep one job pinned to the oldest image\n               python.version: '3.10'\n             Linux_py311:\n               vmImage: 'ubuntu-latest'\n               python.version: '3.11'\n-            macOS_py39:\n-              vmImage: 'macOS-latest'\n-              python.version: '3.9'\n             macOS_py310:\n               vmImage: 'macOS-latest'\n               python.version: '3.10'\n             macOS_py311:\n               vmImage: 'macOS-latest'\n               python.version: '3.11'\n-            Windows_py39:\n-              vmImage: 'windows-2019'  # keep one job pinned to the oldest image\n-              python.version: '3.9'\n             Windows_py310:\n-              vmImage: 'windows-latest'\n+              vmImage: 'windows-2019'  # keep one job pinned to the oldest image\n               python.version: '3.10'\n             Windows_py311:\n               vmImage: 'windows-latest'\ndiff --git a/doc/api/next_api_changes/development/28503-ES.rst b/doc/api/next_api_changes/development/28503-ES.rst\nnew file mode 100644\nindex 000000000000..e9b109cb8515\n--- /dev/null\n+++ b/doc/api/next_api_changes/development/28503-ES.rst\n@@ -0,0 +1,14 @@\n+Increase to minimum supported versions of dependencies\n+~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n+\n+For Matplotlib 3.10, the :ref:`minimum supported versions <dependencies>` are\n+being bumped:\n+\n++------------+-----------------+----------------+\n+| Dependency |  min in mpl3.9  | min in mpl3.10 |\n++============+=================+================+\n+|   Python   |       3.9       |      3.10      |\n++------------+-----------------+----------------+\n+\n+This is consistent with our :ref:`min_deps_policy` and `SPEC0\n+<https://scientific-python.org/specs/spec-0000/>`__\ndiff --git a/doc/install/dependencies.rst b/doc/install/dependencies.rst\nindex 8da22a16753b..3d921d2d10c9 100644\n--- a/doc/install/dependencies.rst\n+++ b/doc/install/dependencies.rst\n@@ -20,7 +20,7 @@ When installing through a package manager like ``pip`` or ``conda``, the\n mandatory dependencies are automatically installed. This list is mainly for\n reference.\n \n-* `Python <https://www.python.org/downloads/>`_ (>= 3.9)\n+* `Python <https://www.python.org/downloads/>`_ (>= 3.10)\n * `contourpy <https://pypi.org/project/contourpy/>`_ (>= 1.0.1)\n * `cycler <https://matplotlib.org/cycler/>`_ (>= 0.10.0)\n * `dateutil <https://pypi.org/project/python-dateutil/>`_ (>= 2.7)\n@@ -30,8 +30,6 @@ reference.\n * `packaging <https://pypi.org/project/packaging/>`_ (>= 20.0)\n * `Pillow <https://pillow.readthedocs.io/en/latest/>`_ (>= 8.0)\n * `pyparsing <https://pypi.org/project/pyparsing/>`_ (>= 2.3.1)\n-* `importlib-resources <https://pypi.org/project/importlib-resources/>`_\n-  (>= 3.2.0; only required on Python < 3.10)\n \n \n .. _optional_dependencies:\ndiff --git a/doc/install/index.rst b/doc/install/index.rst\nindex 867e4600a77e..99ccc163a82e 100644\n--- a/doc/install/index.rst\n+++ b/doc/install/index.rst\n@@ -267,9 +267,9 @@ at the Terminal.app command line::\n \n You should see something like ::\n \n-  3.6.0 /Library/Frameworks/Python.framework/Versions/3.9/lib/python3.9/site-packages/matplotlib/__init__.py\n+  3.10.0 /Library/Frameworks/Python.framework/Versions/3.10/lib/python3.10/site-packages/matplotlib/__init__.py\n \n-where ``3.6.0`` is the Matplotlib version you just installed, and the path\n+where ``3.10.0`` is the Matplotlib version you just installed, and the path\n following depends on whether you are using Python.org Python, Homebrew or\n Macports.  If you see another version, or you get an error like ::\n \ndiff --git a/environment.yml b/environment.yml\nindex ccd5270e9149..264f02800690 100644\n--- a/environment.yml\n+++ b/environment.yml\n@@ -24,6 +24,7 @@ dependencies:\n   - pygobject\n   - pyparsing>=2.3.1\n   - pyqt\n+  - python>=3.10\n   - python-dateutil>=2.1\n   - setuptools_scm\n   - wxpython\ndiff --git a/galleries/users_explain/customizing.py b/galleries/users_explain/customizing.py\nindex b0aaee03239e..05b75ba7d0a4 100644\n--- a/galleries/users_explain/customizing.py\n+++ b/galleries/users_explain/customizing.py\n@@ -234,8 +234,8 @@ def plotting_function():\n #\n # 4. :file:`{INSTALL}/matplotlib/mpl-data/matplotlibrc`, where\n #    :file:`{INSTALL}` is something like\n-#    :file:`/usr/lib/python3.9/site-packages` on Linux, and maybe\n-#    :file:`C:\\\\Python39\\\\Lib\\\\site-packages` on Windows. Every time you\n+#    :file:`/usr/lib/python3.10/site-packages` on Linux, and maybe\n+#    :file:`C:\\\\Python310\\\\Lib\\\\site-packages` on Windows. Every time you\n #    install matplotlib, this file will be overwritten, so if you want\n #    your customizations to be saved, please move this file to your\n #    user-specific matplotlib directory.\ndiff --git a/lib/matplotlib/_api/__init__.pyi b/lib/matplotlib/_api/__init__.pyi\nindex 4baff7cd804c..8dbef9528a82 100644\n--- a/lib/matplotlib/_api/__init__.pyi\n+++ b/lib/matplotlib/_api/__init__.pyi\n@@ -1,5 +1,6 @@\n from collections.abc import Callable, Generator, Mapping, Sequence\n from typing import Any, Iterable, TypeVar, overload\n+from typing_extensions import Self  # < Py 3.11\n \n from numpy.typing import NDArray\n \n@@ -25,9 +26,8 @@ class classproperty(Any):\n         fdel: None = ...,\n         doc: str | None = None,\n     ): ...\n-    # Replace return with Self when py3.9 is dropped\n     @overload\n-    def __get__(self, instance: None, owner: None) -> classproperty: ...\n+    def __get__(self, instance: None, owner: None) -> Self: ...\n     @overload\n     def __get__(self, instance: object, owner: type[object]) -> Any: ...\n     @property\ndiff --git a/lib/matplotlib/_api/deprecation.pyi b/lib/matplotlib/_api/deprecation.pyi\nindex 9619d1b484fc..d0d04d987410 100644\n--- a/lib/matplotlib/_api/deprecation.pyi\n+++ b/lib/matplotlib/_api/deprecation.pyi\n@@ -1,8 +1,7 @@\n from collections.abc import Callable\n import contextlib\n-from typing import Any, TypedDict, TypeVar, overload\n+from typing import Any, ParamSpec, TypedDict, TypeVar, overload\n from typing_extensions import (\n-    ParamSpec,  # < Py 3.10\n     Unpack,  # < Py 3.11\n )\n \ndiff --git a/lib/matplotlib/axis.pyi b/lib/matplotlib/axis.pyi\nindex e23ae381c338..8f69fe4039a8 100644\n--- a/lib/matplotlib/axis.pyi\n+++ b/lib/matplotlib/axis.pyi\n@@ -1,6 +1,7 @@\n from collections.abc import Callable, Iterable, Sequence\n import datetime\n from typing import Any, Literal, overload\n+from typing_extensions import Self  # < Py 3.11\n \n import numpy as np\n from numpy.typing import ArrayLike\n@@ -93,9 +94,8 @@ class Ticker:\n \n class _LazyTickList:\n     def __init__(self, major: bool) -> None: ...\n-    # Replace return with Self when py3.9 is dropped\n     @overload\n-    def __get__(self, instance: None, owner: None) -> _LazyTickList: ...\n+    def __get__(self, instance: None, owner: None) -> Self: ...\n     @overload\n     def __get__(self, instance: Axis, owner: type[Axis]) -> list[Tick]: ...\n \ndiff --git a/lib/matplotlib/backends/registry.py b/lib/matplotlib/backends/registry.py\nindex e08817bb089b..3c85a9b47d7b 100644\n--- a/lib/matplotlib/backends/registry.py\n+++ b/lib/matplotlib/backends/registry.py\n@@ -132,14 +132,8 @@ def _read_entry_points(self):\n         #   [project.entry-points.\"matplotlib.backend\"]\n         #   inline = \"matplotlib_inline.backend_inline\"\n         import importlib.metadata as im\n-        import sys\n-\n-        # entry_points group keyword not available before Python 3.10\n-        group = \"matplotlib.backend\"\n-        if sys.version_info >= (3, 10):\n-            entry_points = im.entry_points(group=group)\n-        else:\n-            entry_points = im.entry_points().get(group, ())\n+\n+        entry_points = im.entry_points(group=\"matplotlib.backend\")\n         entries = [(entry.name, entry.value) for entry in entry_points]\n \n         # For backward compatibility, if matplotlib-inline and/or ipympl are installed\ndiff --git a/lib/matplotlib/dviread.pyi b/lib/matplotlib/dviread.pyi\nindex bf5cfcbe317a..270818278f17 100644\n--- a/lib/matplotlib/dviread.pyi\n+++ b/lib/matplotlib/dviread.pyi\n@@ -5,6 +5,7 @@ from enum import Enum\n from collections.abc import Generator\n \n from typing import NamedTuple\n+from typing_extensions import Self  # < Py 3.11\n \n class _dvistate(Enum):\n     pre: int\n@@ -47,8 +48,7 @@ class Dvi:\n     fonts: dict[int, DviFont]\n     state: _dvistate\n     def __init__(self, filename: str | os.PathLike, dpi: float | None) -> None: ...\n-    # Replace return with Self when py3.9 is dropped\n-    def __enter__(self) -> Dvi: ...\n+    def __enter__(self) -> Self: ...\n     def __exit__(self, etype, evalue, etrace) -> None: ...\n     def __iter__(self) -> Generator[Page, None, None]: ...\n     def close(self) -> None: ...\n@@ -83,8 +83,7 @@ class PsFont(NamedTuple):\n     filename: str\n \n class PsfontsMap:\n-    # Replace return with Self when py3.9 is dropped\n-    def __new__(cls, filename: str | os.PathLike) -> PsfontsMap: ...\n+    def __new__(cls, filename: str | os.PathLike) -> Self: ...\n     def __getitem__(self, texname: bytes) -> PsFont: ...\n \n def find_tex_file(filename: str | os.PathLike) -> str: ...\ndiff --git a/lib/matplotlib/sankey.pyi b/lib/matplotlib/sankey.pyi\nindex 4a40c31e3c6a..33565b998a9c 100644\n--- a/lib/matplotlib/sankey.pyi\n+++ b/lib/matplotlib/sankey.pyi\n@@ -2,6 +2,7 @@ from matplotlib.axes import Axes\n \n from collections.abc import Callable, Iterable\n from typing import Any\n+from typing_extensions import Self  # < Py 3.11\n \n import numpy as np\n \n@@ -56,6 +57,5 @@ class Sankey:\n         connect: tuple[int, int] = ...,\n         rotation: float = ...,\n         **kwargs\n-        # Replace return with Self when py3.9 is dropped\n-    ) -> Sankey: ...\n+    ) -> Self: ...\n     def finish(self) -> list[Any]: ...\ndiff --git a/lib/matplotlib/style/core.py b/lib/matplotlib/style/core.py\nindex 7e9008c56165..e36c3c37a882 100644\n--- a/lib/matplotlib/style/core.py\n+++ b/lib/matplotlib/style/core.py\n@@ -12,19 +12,12 @@\n \"\"\"\n \n import contextlib\n+import importlib.resources\n import logging\n import os\n from pathlib import Path\n-import sys\n import warnings\n \n-if sys.version_info >= (3, 10):\n-    import importlib.resources as importlib_resources\n-else:\n-    # Even though Py3.9 has importlib.resources, it doesn't properly handle\n-    # modules added in sys.path.\n-    import importlib_resources\n-\n import matplotlib as mpl\n from matplotlib import _api, _docstring, _rc_params_in_file, rcParamsDefault\n \n@@ -121,8 +114,7 @@ def use(style):\n             elif \".\" in style:\n                 pkg, _, name = style.rpartition(\".\")\n                 try:\n-                    path = (importlib_resources.files(pkg)\n-                            / f\"{name}.{STYLE_EXTENSION}\")\n+                    path = importlib.resources.files(pkg) / f\"{name}.{STYLE_EXTENSION}\"\n                     style = _rc_params_in_file(path)\n                 except (ModuleNotFoundError, OSError, TypeError) as exc:\n                     # There is an ambiguity whether a dotted name refers to a\ndiff --git a/pyproject.toml b/pyproject.toml\nindex 14ad28d23603..40222fe266da 100644\n--- a/pyproject.toml\n+++ b/pyproject.toml\n@@ -16,7 +16,6 @@ classifiers=[\n     \"License :: OSI Approved :: Python Software Foundation License\",\n     \"Programming Language :: Python\",\n     \"Programming Language :: Python :: 3\",\n-    \"Programming Language :: Python :: 3.9\",\n     \"Programming Language :: Python :: 3.10\",\n     \"Programming Language :: Python :: 3.11\",\n     \"Programming Language :: Python :: 3.12\",\n@@ -40,9 +39,8 @@ dependencies = [\n     \"pillow >= 8\",\n     \"pyparsing >= 2.3.1\",\n     \"python-dateutil >= 2.7\",\n-    \"importlib-resources >= 3.2.0; python_version < '3.10'\",\n ]\n-requires-python = \">=3.9\"\n+requires-python = \">=3.10\"\n \n [project.optional-dependencies]\n # Should be a copy of the build dependencies below.\n@@ -160,7 +158,7 @@ external = [\n   \"E703\",\n ]\n \n-target-version = \"py39\"\n+target-version = \"py310\"\n \n [tool.ruff.pydocstyle]\n convention = \"numpy\"\ndiff --git a/tools/boilerplate.py b/tools/boilerplate.py\nindex a0943df00866..db93b102fce9 100644\n--- a/tools/boilerplate.py\n+++ b/tools/boilerplate.py\n@@ -27,31 +27,9 @@\n import numpy as np\n from matplotlib import _api, mlab\n from matplotlib.axes import Axes\n-from matplotlib.backend_bases import MouseButton\n from matplotlib.figure import Figure\n \n \n-# we need to define a custom str because py310 change\n-# In Python 3.10 the repr and str representation of Enums changed from\n-#\n-#  str: 'ClassName.NAME' -> 'NAME'\n-#  repr: '<ClassName.NAME: value>' -> 'ClassName.NAME'\n-#\n-# which is more consistent with what str/repr should do, however this breaks\n-# boilerplate which needs to get the ClassName.NAME version in all versions of\n-# Python. Thus, we locally monkey patch our preferred str representation in\n-# here.\n-#\n-# bpo-40066\n-# https://github.com/python/cpython/pull/22392/\n-def enum_str_back_compat_patch(self):\n-    return f'{type(self).__name__}.{self.name}'\n-\n-# only monkey patch if we have to.\n-if str(MouseButton.LEFT) != 'MouseButton.Left':\n-    MouseButton.__str__ = enum_str_back_compat_patch\n-\n-\n # This is the magic line that must exist in pyplot, after which the boilerplate\n # content will be appended.\n PYPLOT_MAGIC_HEADER = (\n@@ -112,7 +90,7 @@ def __init__(self, value):\n             self._repr = \"_api.deprecation._deprecated_parameter\"\n         elif isinstance(value, Enum):\n             # Enum str is Class.Name whereas their repr is <Class.Name: value>.\n-            self._repr = str(value)\n+            self._repr = f'{type(value).__name__}.{value.name}'\n         else:\n             self._repr = repr(value)\n \ndiff --git a/tox.ini b/tox.ini\nindex cb2fcc979076..00ea746c8923 100644\n--- a/tox.ini\n+++ b/tox.ini\n@@ -4,7 +4,7 @@\n # and then run \"tox\" from this directory.\n \n [tox]\n-envlist = py38, py39, py310, stubtest\n+envlist = py310, py311, py312, stubtest\n \n [testenv]\n changedir = /tmp\n", "test_patch": "diff --git a/.github/workflows/mypy-stubtest.yml b/.github/workflows/mypy-stubtest.yml\nindex 969aacccad74..5b29a93b7533 100644\n--- a/.github/workflows/mypy-stubtest.yml\n+++ b/.github/workflows/mypy-stubtest.yml\n@@ -16,7 +16,7 @@ jobs:\n       - name: Set up Python 3\n         uses: actions/setup-python@v5\n         with:\n-          python-version: 3.9\n+          python-version: '3.10'\n \n       - name: Set up reviewdog\n         uses: reviewdog/action-setup@v1\n@@ -30,7 +30,7 @@ jobs:\n         run: |\n           set -o pipefail\n           tox -e stubtest | \\\n-              sed -e \"s!.tox/stubtest/lib/python3.9/site-packages!lib!g\" | \\\n+              sed -e \"s!.tox/stubtest/lib/python3.10/site-packages!lib!g\" | \\\n               reviewdog \\\n                 -efm '%Eerror: %m' \\\n                 -efm '%CStub: in file %f:%l' \\\ndiff --git a/.github/workflows/tests.yml b/.github/workflows/tests.yml\nindex 8875a38cc1bb..230c42c136d5 100644\n--- a/.github/workflows/tests.yml\n+++ b/.github/workflows/tests.yml\n@@ -50,31 +50,28 @@ jobs:\n         include:\n           - name-suffix: \"(Minimum Versions)\"\n             os: ubuntu-20.04\n-            python-version: 3.9\n+            python-version: '3.10'\n             extra-requirements: '-c requirements/testing/minver.txt'\n-            pyqt5-ver: '==5.12.2 sip==5.0.0'  # oldest versions with a Py3.9 wheel.\n-            pyqt6-ver: '==6.1.0 PyQt6-Qt6==6.1.0'\n-            pyside2-ver: '==5.15.1'  # oldest version with working Py3.9 wheel.\n-            pyside6-ver: '==6.0.0'\n             delete-font-cache: true\n+            # Oldest versions with Py3.10 wheels.\n+            pyqt5-ver: '==5.15.5 sip==6.3.0'\n+            pyqt6-ver: '==6.2.0 PyQt6-Qt6==6.2.0'\n+            pyside2-ver: '==5.15.2.1'\n+            pyside6-ver: '==6.2.0'\n           - os: ubuntu-20.04\n-            python-version: 3.9\n+            python-version: '3.10'\n             # One CI run tests ipython/matplotlib-inline before backend mapping moved to mpl\n-            extra-requirements: '-r requirements/testing/extra.txt \"ipython==7.19\" \"matplotlib-inline<0.1.7\"'\n+            extra-requirements:\n+              -r requirements/testing/extra.txt\n+              \"ipython==7.29.0\"\n+              \"ipykernel==5.5.6\"\n+              \"matplotlib-inline<0.1.7\"\n             CFLAGS: \"-fno-lto\"  # Ensure that disabling LTO works.\n             # https://github.com/matplotlib/matplotlib/pull/26052#issuecomment-1574595954\n             # https://www.riverbankcomputing.com/pipermail/pyqt/2023-November/045606.html\n             pyqt6-ver: '!=6.5.1,!=6.6.0'\n             # https://bugreports.qt.io/projects/PYSIDE/issues/PYSIDE-2346\n             pyside6-ver: '!=6.5.1'\n-          - os: ubuntu-20.04\n-            python-version: '3.10'\n-            extra-requirements: '-r requirements/testing/extra.txt'\n-            # https://github.com/matplotlib/matplotlib/pull/26052#issuecomment-1574595954\n-            # https://www.riverbankcomputing.com/pipermail/pyqt/2023-November/045606.html\n-            pyqt6-ver: '!=6.5.1,!=6.6.0'\n-            # https://bugreports.qt.io/projects/PYSIDE/issues/PYSIDE-2346\n-            pyside6-ver: '!=6.5.1'\n           - os: ubuntu-22.04\n             python-version: '3.11'\n             # https://www.riverbankcomputing.com/pipermail/pyqt/2023-November/045606.html\n@@ -88,8 +85,8 @@ jobs:\n             pyqt6-ver: '!=6.6.0'\n             # https://bugreports.qt.io/projects/PYSIDE/issues/PYSIDE-2346\n             pyside6-ver: '!=6.5.1'\n-          - os: macos-12  # This runnre is on Intel chips.\n-            python-version: 3.9\n+          - os: macos-12  # This runner is on Intel chips.\n+            python-version: '3.10'\n             # https://bugreports.qt.io/projects/PYSIDE/issues/PYSIDE-2346\n             pyside6-ver: '!=6.5.1'\n           - os: macos-14  # This runner is on M1 (arm64) chips.\ndiff --git a/doc/devel/testing.rst b/doc/devel/testing.rst\nindex 668d4bd56b83..72f787eca746 100644\n--- a/doc/devel/testing.rst\n+++ b/doc/devel/testing.rst\n@@ -252,7 +252,7 @@ Using tox\n \n `Tox <https://tox.readthedocs.io/en/latest/>`_ is a tool for running tests\n against multiple Python environments, including multiple versions of Python\n-(e.g., 3.7, 3.8) and even different Python implementations altogether\n+(e.g., 3.10, 3.11) and even different Python implementations altogether\n (e.g., CPython, PyPy, Jython, etc.), as long as all these versions are\n available on your system's $PATH (consider using your system package manager,\n e.g. apt-get, yum, or Homebrew, to install them).\n@@ -269,7 +269,7 @@ You can also run tox on a subset of environments:\n \n .. code-block:: bash\n \n-    $ tox -e py38,py39\n+    $ tox -e py310,py311\n \n Tox processes everything serially so it can take a long time to test\n several environments. To speed it up, you might try using a new,\ndiff --git a/lib/matplotlib/tests/test_backend_inline.py b/lib/matplotlib/tests/test_backend_inline.py\nindex 4112eb213e2c..6f0d67d51756 100644\n--- a/lib/matplotlib/tests/test_backend_inline.py\n+++ b/lib/matplotlib/tests/test_backend_inline.py\n@@ -1,7 +1,6 @@\n import os\n from pathlib import Path\n from tempfile import TemporaryDirectory\n-import sys\n \n import pytest\n \n@@ -13,7 +12,6 @@\n pytest.importorskip('matplotlib_inline')\n \n \n-@pytest.mark.skipif(sys.version_info[:2] <= (3, 9), reason=\"Requires Python 3.10+\")\n def test_ipynb():\n     nb_path = Path(__file__).parent / 'test_inline_01.ipynb'\n \ndiff --git a/lib/matplotlib/tests/test_sphinxext.py b/lib/matplotlib/tests/test_sphinxext.py\nindex 6624e3b17ba5..24efecbeae9d 100644\n--- a/lib/matplotlib/tests/test_sphinxext.py\n+++ b/lib/matplotlib/tests/test_sphinxext.py\n@@ -10,8 +10,7 @@\n import pytest\n \n \n-pytest.importorskip('sphinx',\n-                    minversion=None if sys.version_info < (3, 10) else '4.1.3')\n+pytest.importorskip('sphinx', minversion='4.1.3')\n \n \n def build_sphinx_html(source_dir, doctree_dir, html_dir, extra_args=None):\ndiff --git a/requirements/testing/extra.txt b/requirements/testing/extra.txt\nindex b3e9009b561c..a5c1bef5f03a 100644\n--- a/requirements/testing/extra.txt\n+++ b/requirements/testing/extra.txt\n@@ -1,4 +1,4 @@\n-# Extra pip requirements for the Python 3.9+ builds\n+# Extra pip requirements for the Python 3.10+ builds\n \n --prefer-binary\n ipykernel\ndiff --git a/requirements/testing/minver.txt b/requirements/testing/minver.txt\nindex 1a95367eff14..3932e68eb015 100644\n--- a/requirements/testing/minver.txt\n+++ b/requirements/testing/minver.txt\n@@ -4,12 +4,12 @@ contourpy==1.0.1\n cycler==0.10\n fonttools==4.22.0\n importlib-resources==3.2.0\n-kiwisolver==1.3.1\n+kiwisolver==1.3.2\n meson-python==0.13.1\n meson==1.1.0\n numpy==1.23.0\n packaging==20.0\n-pillow==8.0.0\n+pillow==8.3.2\n pyparsing==2.3.1\n pytest==7.0.0\n python-dateutil==2.7\ndiff --git a/requirements/testing/mypy.txt b/requirements/testing/mypy.txt\nindex a5ca15cfbdad..9e3738556a8f 100644\n--- a/requirements/testing/mypy.txt\n+++ b/requirements/testing/mypy.txt\n@@ -25,5 +25,3 @@ pyparsing>=2.3.1\n python-dateutil>=2.7\n setuptools_scm>=7\n setuptools>=64\n-\n-importlib-resources>=3.2.0 ; python_version < \"3.10\"\n", "problem_statement": "[TST] Upcoming dependency test failures\nThe weekly build with nightly wheels from numpy and pandas\nhas failed. Check the logs for any updates that need to be\nmade in matplotlib.\nhttps://github.com/matplotlib/matplotlib/actions/runs/9721989654\n", "hints_text": "It looks like Pandas just recently bumped minimum Python to 3.10, so we aren't getting any 3.9 wheels from the nightly index any more.\nIt is time for us to do the same on main.", "created_at": "2024-07-03T04:15:30Z"}
{"repo": "matplotlib/matplotlib", "pull_number": 28487, "instance_id": "matplotlib__matplotlib-28487", "issue_numbers": ["28341", "0000"], "base_commit": "74c7f9a598c4e32b3f551f75ed965f446d786ab1", "patch": "diff --git a/lib/matplotlib/axes/_axes.py b/lib/matplotlib/axes/_axes.py\nindex 328dda4a6a71..5e69bcb57d7f 100644\n--- a/lib/matplotlib/axes/_axes.py\n+++ b/lib/matplotlib/axes/_axes.py\n@@ -1028,7 +1028,7 @@ def axhspan(self, ymin, ymax, xmin=0, xmax=1, **kwargs):\n         # For Rectangles and non-separable transforms, add_patch can be buggy\n         # and update the x limits even though it shouldn't do so for an\n         # yaxis_transformed patch, so undo that update.\n-        ix = self.dataLim.intervalx\n+        ix = self.dataLim.intervalx.copy()\n         mx = self.dataLim.minposx\n         self.add_patch(p)\n         self.dataLim.intervalx = ix\n", "test_patch": "diff --git a/lib/matplotlib/tests/test_axes.py b/lib/matplotlib/tests/test_axes.py\nindex 48121ee04939..13c181b68492 100644\n--- a/lib/matplotlib/tests/test_axes.py\n+++ b/lib/matplotlib/tests/test_axes.py\n@@ -8250,10 +8250,10 @@ def test_relative_ticklabel_sizes(size):\n def test_multiplot_autoscale():\n     fig = plt.figure()\n     ax1, ax2 = fig.subplots(2, 1, sharex='all')\n-    ax1.scatter([1, 2, 3, 4], [2, 3, 2, 3])\n+    ax1.plot([18000, 18250, 18500, 18750], [2, 3, 2, 3])\n     ax2.axhspan(-5, 5)\n     xlim = ax1.get_xlim()\n-    assert np.allclose(xlim, [0.5, 4.5])\n+    assert np.allclose(xlim, [18000, 18800])\n \n \n def test_sharing_does_not_link_positions():\n", "problem_statement": "[Bug]: Incorrect X-axis scaling with date values\n### Bug summary\n\nIn matplotlib 3.9.0, when plotting dates on the X-axis, calling axhspan unexpectedly expands the X-axis range from 1970 to 2024. This behavior did not occur in version 3.8.4, where the X-axis correctly ranges from 2020 to 2024.\n\n### Code for reproduction\n\n```Python\nimport datetime\r\nimport matplotlib.pyplot as plt\r\n\r\nx = [datetime.date(year, 1, 1) for year in range(2020, 2024)]\r\ny = range(4)\r\n\r\nplt.plot(x, y)\r\nplt.axhspan(1, 2)\n```\n\n\n### Actual outcome\n\n![3 9 0](https://github.com/matplotlib/matplotlib/assets/6249977/104927cc-75f7-4a3d-abc7-d66d84b16d93)\r\n\n\n### Expected outcome\n\n![3 8 4](https://github.com/matplotlib/matplotlib/assets/6249977/3b628921-5cc3-4b9b-b2ce-1570d82d0bb4)\r\n\n\n### Additional information\n\n_No response_\n\n### Operating system\n\nFedora\n\n### Matplotlib Version\n\n3.9.0\n\n### Matplotlib Backend\n\ninline or Agg\n\n### Python version\n\n3.12.3\n\n### Jupyter version\n\n4.2.1\n\n### Installation\n\npip\n", "hints_text": "This is a regression in 3.9.\nMost likely related to https://github.com/matplotlib/matplotlib/pull/26788 \nA bisect does indeed point to that commit; I'm a bit confused though as it seems like that change is supposed to try and avoid changing the datalimits, but maybe it's something to do with using date/units.\r\n\r\ncc @anntzer\nWoops.  The fix is easy:\r\n```patch\r\ndiff --git i/lib/matplotlib/axes/_axes.py w/lib/matplotlib/axes/_axes.py\r\nindex 9a2b367fb5..7efbd6562f 100644\r\n--- i/lib/matplotlib/axes/_axes.py\r\n+++ w/lib/matplotlib/axes/_axes.py\r\n@@ -1028,7 +1028,7 @@ class Axes(_AxesBase):\r\n         # For Rectangles and non-separable transforms, add_patch can be buggy\r\n         # and update the x limits even though it shouldn't do so for an\r\n         # yaxis_transformed patch, so undo that update.\r\n-        ix = self.dataLim.intervalx\r\n+        ix = self.dataLim.intervalx.copy()\r\n         mx = self.dataLim.minposx\r\n         self.add_patch(p)\r\n         self.dataLim.intervalx = ix\r\n```\r\n(intervalx is an array and thus vulnerable to getting mutated in place).  Note that axvspan already has the necessary copy() call, only axhspan was missing it.\r\nCan you take over the patch?", "created_at": "2024-06-28T11:05:42Z"}
{"repo": "matplotlib/matplotlib", "pull_number": 28486, "instance_id": "matplotlib__matplotlib-28486", "issue_numbers": ["28383", "28383"], "base_commit": "74c7f9a598c4e32b3f551f75ed965f446d786ab1", "patch": "diff --git a/lib/matplotlib/transforms.py b/lib/matplotlib/transforms.py\nindex 5003e2113930..3575bd1fc14d 100644\n--- a/lib/matplotlib/transforms.py\n+++ b/lib/matplotlib/transforms.py\n@@ -1423,7 +1423,7 @@ def contains_branch_seperately(self, other_transform):\n                              'transforms with 2 output dimensions')\n         # for a non-blended transform each separate dimension is the same, so\n         # just return the appropriate shape.\n-        return [self.contains_branch(other_transform)] * 2\n+        return (self.contains_branch(other_transform), ) * 2\n \n     def __sub__(self, other):\n         \"\"\"\n@@ -2404,6 +2404,15 @@ def _iter_break_from_left_to_right(self):\n         for left, right in self._b._iter_break_from_left_to_right():\n             yield self._a + left, right\n \n+    def contains_branch_seperately(self, other_transform):\n+        # docstring inherited\n+        if self.output_dims != 2:\n+            raise ValueError('contains_branch_seperately only supports '\n+                             'transforms with 2 output dimensions')\n+        if self == other_transform:\n+            return (True, True)\n+        return self._b.contains_branch_seperately(other_transform)\n+\n     depth = property(lambda self: self._a.depth + self._b.depth)\n     is_affine = property(lambda self: self._a.is_affine and self._b.is_affine)\n     is_separable = property(\n", "test_patch": "diff --git a/lib/matplotlib/tests/test_transforms.py b/lib/matplotlib/tests/test_transforms.py\nindex 959814de82db..3d12b90d5210 100644\n--- a/lib/matplotlib/tests/test_transforms.py\n+++ b/lib/matplotlib/tests/test_transforms.py\n@@ -667,6 +667,13 @@ def test_contains_branch(self):\n \n         assert not self.stack1.contains_branch(self.tn1 + self.ta2)\n \n+        blend = mtransforms.BlendedGenericTransform(self.tn2, self.stack2)\n+        x, y = blend.contains_branch_seperately(self.stack2_subset)\n+        stack_blend = self.tn3 + blend\n+        sx, sy = stack_blend.contains_branch_seperately(self.stack2_subset)\n+        assert x is sx is False\n+        assert y is sy is True\n+\n     def test_affine_simplification(self):\n         # tests that a transform stack only calls as much is absolutely\n         # necessary \"non-affine\" allowing the best possible optimization with\n", "problem_statement": "[Bug]: axvspan no longer participating in limit calculations\n### Bug summary\n\nSince upgrading to matplotlib 3.9, axvspan plots no longer seem to be included in limit calculations.  I suspect this is due to the change from Polygon to Rectangle, but it does seem to have some unintended consequences.\n\n### Code for reproduction\n\n```Python\nIn [2]: fig, ax = plt.subplots()\r\n\r\nIn [3]: ax.axvspan(0.5, 1.0)\r\nOut[3]: <matplotlib.patches.Rectangle object at 0x7080118bbf80>\r\n\r\nIn [4]: ax.set(title='Matplotlib 3.9.0')\r\nOut[4]: [Text(0.5, 1.0, 'Matplotlib 3.9.0')]\n```\n\n\n### Actual outcome\n\n![image](https://github.com/matplotlib/matplotlib/assets/1190540/417455cd-c184-4c3a-a446-24994c989284)\r\n\r\nNote that the axis limits are still centered at 0, and the vspan is out of frame.\n\n### Expected outcome\n\n![image](https://github.com/matplotlib/matplotlib/assets/1190540/498e2ff9-43bd-45b0-9757-7da51357fbb2)\r\n\r\nIn 3.8.4, the limits would adapt to the location of the generated artist.\n\n### Additional information\n\nThis is causing us some problems in mir_eval, where we have high-level plot constructors that are built entirely from axvspans for showing time-series segmentation labels.\n\n### Operating system\n\nall\n\n### Matplotlib Version\n\n3.9.0\n\n### Matplotlib Backend\n\ntkagg, but shouldn't matter\n\n### Python version\n\n3.12\n\n### Jupyter version\n\nn/a\n\n### Installation\n\npip\n[Bug]: axvspan no longer participating in limit calculations\n### Bug summary\n\nSince upgrading to matplotlib 3.9, axvspan plots no longer seem to be included in limit calculations.  I suspect this is due to the change from Polygon to Rectangle, but it does seem to have some unintended consequences.\n\n### Code for reproduction\n\n```Python\nIn [2]: fig, ax = plt.subplots()\r\n\r\nIn [3]: ax.axvspan(0.5, 1.0)\r\nOut[3]: <matplotlib.patches.Rectangle object at 0x7080118bbf80>\r\n\r\nIn [4]: ax.set(title='Matplotlib 3.9.0')\r\nOut[4]: [Text(0.5, 1.0, 'Matplotlib 3.9.0')]\n```\n\n\n### Actual outcome\n\n![image](https://github.com/matplotlib/matplotlib/assets/1190540/417455cd-c184-4c3a-a446-24994c989284)\r\n\r\nNote that the axis limits are still centered at 0, and the vspan is out of frame.\n\n### Expected outcome\n\n![image](https://github.com/matplotlib/matplotlib/assets/1190540/498e2ff9-43bd-45b0-9757-7da51357fbb2)\r\n\r\nIn 3.8.4, the limits would adapt to the location of the generated artist.\n\n### Additional information\n\nThis is causing us some problems in mir_eval, where we have high-level plot constructors that are built entirely from axvspans for showing time-series segmentation labels.\n\n### Operating system\n\nall\n\n### Matplotlib Version\n\n3.9.0\n\n### Matplotlib Backend\n\ntkagg, but shouldn't matter\n\n### Python version\n\n3.12\n\n### Jupyter version\n\nn/a\n\n### Installation\n\npip\n", "hints_text": "This may be duplicate of #28341, which has a patch, but has not been put into a PR yet, I believe.\r\n\r\nThat said, the discussion there was about `axhspan` and indicated that `axvspan` was unaffected, so may not be exactly the same...\n> That said, the discussion there was about `axhspan` and indicated that `axvspan` was unaffected, so may not be exactly the same...\r\n\r\nI took a look at the proposed patch in #28341, and I don't think it addresses the issue.\r\n\r\nIn axhspan, the proposed fix was to .copy() the horizontal interval when updating the datalim:\r\nhttps://github.com/matplotlib/matplotlib/blob/54729dbcb59c6f46c44241fc3193a2e67d5983e8/lib/matplotlib/axes/_axes.py#L1028-L1031\r\nand the post in thread indicates that this is unnecessary for vspan, which already has the .copy():\r\nhttps://github.com/matplotlib/matplotlib/blob/54729dbcb59c6f46c44241fc3193a2e67d5983e8/lib/matplotlib/axes/_axes.py#L1091-L1094\r\nHowever, that's only applied to the y-axis, and it's the x-axis that is causing the issue here.\r\n\r\nSo I think these are two related, but distinct problems.\nSo the problem here is that for patches, we ask for whether it contains the data transform:\r\nhttps://github.com/matplotlib/matplotlib/blob/d347c3227f8de8a99aa327390fee619310452a96/lib/matplotlib/axes/_base.py#L2445-L2448\r\nand for `Rectangle` this returns `False` for both x&y. This is likely because a `Rectangle` is a unit rectangle, with a scaling transform + the data transform.\r\n\r\nSince `Patch.get_transform()` == patch transform + data transform, it's possible that we may want to check data transform, and then use patch transform directly for the datalim update. Something like:\r\n```patch\r\ndiff --git a/lib/matplotlib/axes/_base.py b/lib/matplotlib/axes/_base.py\r\nindex 1cf56c90cc..5f37710ee6 100644\r\n--- a/lib/matplotlib/axes/_base.py\r\n+++ b/lib/matplotlib/axes/_base.py\r\n@@ -2415,17 +2415,17 @@ class _AxesBase(martist.Artist):\r\n         if len(vertices):\r\n             vertices = np.vstack(vertices)\r\n \r\n-        patch_trf = patch.get_transform()\r\n-        updatex, updatey = patch_trf.contains_branch_seperately(self.transData)\r\n+        data_trf = patch.get_data_transform()\r\n+        updatex, updatey = data_trf.contains_branch_seperately(self.transData)\r\n         if not (updatex or updatey):\r\n             return\r\n         if self.name != \"rectilinear\":\r\n             # As in _update_line_limits, but for axvspan.\r\n-            if updatex and patch_trf == self.get_yaxis_transform():\r\n+            if updatex and data_trf == self.get_yaxis_transform():\r\n                 updatex = False\r\n-            if updatey and patch_trf == self.get_xaxis_transform():\r\n+            if updatey and data_trf == self.get_xaxis_transform():\r\n                 updatey = False\r\n-        trf_to_data = patch_trf - self.transData\r\n+        trf_to_data = patch.get_patch_transform()\r\n         xys = trf_to_data.transform(vertices)\r\n         self.update_datalim(xys, updatex=updatex, updatey=updatey)\r\n ```\nThis may be duplicate of #28341, which has a patch, but has not been put into a PR yet, I believe.\r\n\r\nThat said, the discussion there was about `axhspan` and indicated that `axvspan` was unaffected, so may not be exactly the same...\n> That said, the discussion there was about `axhspan` and indicated that `axvspan` was unaffected, so may not be exactly the same...\r\n\r\nI took a look at the proposed patch in #28341, and I don't think it addresses the issue.\r\n\r\nIn axhspan, the proposed fix was to .copy() the horizontal interval when updating the datalim:\r\nhttps://github.com/matplotlib/matplotlib/blob/54729dbcb59c6f46c44241fc3193a2e67d5983e8/lib/matplotlib/axes/_axes.py#L1028-L1031\r\nand the post in thread indicates that this is unnecessary for vspan, which already has the .copy():\r\nhttps://github.com/matplotlib/matplotlib/blob/54729dbcb59c6f46c44241fc3193a2e67d5983e8/lib/matplotlib/axes/_axes.py#L1091-L1094\r\nHowever, that's only applied to the y-axis, and it's the x-axis that is causing the issue here.\r\n\r\nSo I think these are two related, but distinct problems.\nSo the problem here is that for patches, we ask for whether it contains the data transform:\r\nhttps://github.com/matplotlib/matplotlib/blob/d347c3227f8de8a99aa327390fee619310452a96/lib/matplotlib/axes/_base.py#L2445-L2448\r\nand for `Rectangle` this returns `False` for both x&y. This is likely because a `Rectangle` is a unit rectangle, with a scaling transform + the data transform.\r\n\r\nSince `Patch.get_transform()` == patch transform + data transform, it's possible that we may want to check data transform, and then use patch transform directly for the datalim update. Something like:\r\n```patch\r\ndiff --git a/lib/matplotlib/axes/_base.py b/lib/matplotlib/axes/_base.py\r\nindex 1cf56c90cc..5f37710ee6 100644\r\n--- a/lib/matplotlib/axes/_base.py\r\n+++ b/lib/matplotlib/axes/_base.py\r\n@@ -2415,17 +2415,17 @@ class _AxesBase(martist.Artist):\r\n         if len(vertices):\r\n             vertices = np.vstack(vertices)\r\n \r\n-        patch_trf = patch.get_transform()\r\n-        updatex, updatey = patch_trf.contains_branch_seperately(self.transData)\r\n+        data_trf = patch.get_data_transform()\r\n+        updatex, updatey = data_trf.contains_branch_seperately(self.transData)\r\n         if not (updatex or updatey):\r\n             return\r\n         if self.name != \"rectilinear\":\r\n             # As in _update_line_limits, but for axvspan.\r\n-            if updatex and patch_trf == self.get_yaxis_transform():\r\n+            if updatex and data_trf == self.get_yaxis_transform():\r\n                 updatex = False\r\n-            if updatey and patch_trf == self.get_xaxis_transform():\r\n+            if updatey and data_trf == self.get_xaxis_transform():\r\n                 updatey = False\r\n-        trf_to_data = patch_trf - self.transData\r\n+        trf_to_data = patch.get_patch_transform()\r\n         xys = trf_to_data.transform(vertices)\r\n         self.update_datalim(xys, updatex=updatex, updatey=updatey)\r\n ```", "created_at": "2024-06-28T10:22:43Z"}
{"repo": "matplotlib/matplotlib", "pull_number": 28473, "instance_id": "matplotlib__matplotlib-28473", "issue_numbers": ["28432", "0000"], "base_commit": "664b45729aa6ac2d6ef9459d8c0ad04f50af847c", "patch": "diff --git a/lib/matplotlib/backends/registry.py b/lib/matplotlib/backends/registry.py\nindex 47d5f65e350e..e08817bb089b 100644\n--- a/lib/matplotlib/backends/registry.py\n+++ b/lib/matplotlib/backends/registry.py\n@@ -93,6 +93,9 @@ def __init__(self):\n         }\n \n     def _backend_module_name(self, backend):\n+        if backend.startswith(\"module://\"):\n+            return backend[9:]\n+\n         # Return name of module containing the specified backend.\n         # Does not check if the backend is valid, use is_valid_backend for that.\n         backend = backend.lower()\n@@ -224,7 +227,8 @@ def is_valid_backend(self, backend):\n         bool\n             True if backend is valid, False otherwise.\n         \"\"\"\n-        backend = backend.lower()\n+        if not backend.startswith(\"module://\"):\n+            backend = backend.lower()\n \n         # For backward compatibility, convert ipympl and matplotlib-inline long\n         # module:// names to their shortened forms.\n@@ -342,7 +346,8 @@ def resolve_backend(self, backend):\n             The GUI framework, which will be None for a backend that is non-interactive.\n         \"\"\"\n         if isinstance(backend, str):\n-            backend = backend.lower()\n+            if not backend.startswith(\"module://\"):\n+                backend = backend.lower()\n         else:  # Might be _auto_backend_sentinel or None\n             # Use whatever is already running...\n             from matplotlib import get_backend\n@@ -395,7 +400,8 @@ def resolve_gui_or_backend(self, gui_or_backend):\n         framework : str or None\n             The GUI framework, which will be None for a backend that is non-interactive.\n         \"\"\"\n-        gui_or_backend = gui_or_backend.lower()\n+        if not gui_or_backend.startswith(\"module://\"):\n+            gui_or_backend = gui_or_backend.lower()\n \n         # First check if it is a gui loop name.\n         backend = self.backend_for_gui_framework(gui_or_backend)\n", "test_patch": "diff --git a/lib/matplotlib/tests/test_backend_registry.py b/lib/matplotlib/tests/test_backend_registry.py\nindex 141ffd69c266..80c2ce4fc51a 100644\n--- a/lib/matplotlib/tests/test_backend_registry.py\n+++ b/lib/matplotlib/tests/test_backend_registry.py\n@@ -86,6 +86,15 @@ def test_is_valid_backend(backend, is_valid):\n     assert backend_registry.is_valid_backend(backend) == is_valid\n \n \n+@pytest.mark.parametrize(\"backend, normalized\", [\n+    (\"agg\", \"matplotlib.backends.backend_agg\"),\n+    (\"QtAgg\", \"matplotlib.backends.backend_qtagg\"),\n+    (\"module://Anything\", \"Anything\"),\n+])\n+def test_backend_normalization(backend, normalized):\n+    assert backend_registry._backend_module_name(backend) == normalized\n+\n+\n def test_deprecated_rcsetup_attributes():\n     match = \"was deprecated in Matplotlib 3.9\"\n     with pytest.warns(mpl.MatplotlibDeprecationWarning, match=match):\ndiff --git a/lib/matplotlib/tests/test_backend_template.py b/lib/matplotlib/tests/test_backend_template.py\nindex d7e2a5cd1266..964d15c1559a 100644\n--- a/lib/matplotlib/tests/test_backend_template.py\n+++ b/lib/matplotlib/tests/test_backend_template.py\n@@ -49,3 +49,14 @@ def test_show_old_global_api(monkeypatch):\n     mpl.use(\"module://mpl_test_backend\")\n     plt.show()\n     mock_show.assert_called_with()\n+\n+\n+def test_load_case_sensitive(monkeypatch):\n+    mpl_test_backend = SimpleNamespace(**vars(backend_template))\n+    mock_show = MagicMock()\n+    monkeypatch.setattr(\n+        mpl_test_backend.FigureManagerTemplate, \"pyplot_show\", mock_show)\n+    monkeypatch.setitem(sys.modules, \"mpl_Test_Backend\", mpl_test_backend)\n+    mpl.use(\"module://mpl_Test_Backend\")\n+    plt.show()\n+    mock_show.assert_called_with()\n", "problem_statement": "[Bug]: Backend name specified as module gets lowercased since 3.9\n### Bug summary\r\n\r\n`MPLBACKEND=\"module://foo.Bar\"` now tries to import the `foo.bar` module as opposed to `foo.Bar`, as before.\r\n\r\n### Code for reproduction\r\n\r\n```Python\r\nMPLBACKEND=\"module://foo.Bar\"\r\n```\r\n\r\n\r\n### Actual outcome\r\n\r\n`foo.bar` is imported\r\n\r\n### Expected outcome\r\n\r\n`foo.Bar` is imported\r\n\r\n### Additional information\r\n\r\nThis probably regressed in https://github.com/matplotlib/matplotlib/pull/27948.\r\n\r\n### Operating system\r\n\r\nFedora Linux 39\r\n\r\n### Matplotlib Version\r\n\r\n3.9.0\r\n\r\n### Matplotlib Backend\r\n\r\n_No response_\r\n\r\n### Python version\r\n\r\n_No response_\r\n\r\n### Jupyter version\r\n\r\n_No response_\r\n\r\n### Installation\r\n\r\nNone\n", "hints_text": "", "created_at": "2024-06-26T20:54:45Z"}
{"repo": "matplotlib/matplotlib", "pull_number": 28465, "instance_id": "matplotlib__matplotlib-28465", "issue_numbers": ["28464"], "base_commit": "57cd5eb22af1590eaf771a9e5f0d60f6bec2354d", "patch": "diff --git a/lib/matplotlib/figure.py b/lib/matplotlib/figure.py\nindex 9139b2ed262f..7bb06814f389 100644\n--- a/lib/matplotlib/figure.py\n+++ b/lib/matplotlib/figure.py\n@@ -2227,7 +2227,6 @@ def __init__(self, parent, subplotspec, *,\n         self.subplotpars = parent.subplotpars\n         self.dpi_scale_trans = parent.dpi_scale_trans\n         self._axobservers = parent._axobservers\n-        self.canvas = parent.canvas\n         self.transFigure = parent.transFigure\n         self.bbox_relative = Bbox.null()\n         self._redo_transform_rel_fig()\n@@ -2244,6 +2243,10 @@ def __init__(self, parent, subplotspec, *,\n         self._set_artist_props(self.patch)\n         self.patch.set_antialiased(False)\n \n+    @property\n+    def canvas(self):\n+        return self._parent.canvas\n+\n     @property\n     def dpi(self):\n         return self._parent.dpi\ndiff --git a/lib/matplotlib/figure.pyi b/lib/matplotlib/figure.pyi\nindex 21de9159d56c..b079312695c1 100644\n--- a/lib/matplotlib/figure.pyi\n+++ b/lib/matplotlib/figure.pyi\n@@ -263,7 +263,6 @@ class SubFigure(FigureBase):\n     figure: Figure\n     subplotpars: SubplotParams\n     dpi_scale_trans: Affine2D\n-    canvas: FigureCanvasBase\n     transFigure: Transform\n     bbox_relative: Bbox\n     figbbox: BboxBase\n@@ -282,6 +281,8 @@ class SubFigure(FigureBase):\n         **kwargs\n     ) -> None: ...\n     @property\n+    def canvas(self) -> FigureCanvasBase: ...\n+    @property\n     def dpi(self) -> float: ...\n     @dpi.setter\n     def dpi(self, value: float) -> None: ...\n", "test_patch": "diff --git a/lib/matplotlib/tests/test_pickle.py b/lib/matplotlib/tests/test_pickle.py\nindex 7e7ccc14bf8f..0cba4f392035 100644\n--- a/lib/matplotlib/tests/test_pickle.py\n+++ b/lib/matplotlib/tests/test_pickle.py\n@@ -93,6 +93,11 @@ def _generate_complete_test_figure(fig_ref):\n     plt.errorbar(x, x * -0.5, xerr=0.2, yerr=0.4, label='$-.5 x$')\n     plt.legend(draggable=True)\n \n+    # Ensure subfigure parenting works.\n+    subfigs = fig_ref.subfigures(2)\n+    subfigs[0].subplots(1, 2)\n+    subfigs[1].subplots(1, 2)\n+\n     fig_ref.align_ylabels()  # Test handling of _align_label_groups Groupers.\n \n \n", "problem_statement": "[Bug]: figure with subfigures cannot be pickled\n### Bug summary\r\n\r\nI tried to pickle figures with subfigures nested.\r\nReturns error with the following code.\r\n\r\n### Code for reproduction\r\n\r\n```Python\r\n#!/usr/bin/env python3\r\nimport pickle\r\nimport matplotlib.pyplot as plt\r\n\r\nfig = plt.figure()\r\nsubfigs = fig.subfigures(2,2)\r\nwith open('fig.p', 'wb') as file:\r\n    pickle.dump(fig, file)\r\n```\r\n\r\n\r\n### Actual outcome\r\n```\r\n---------------------------------------------------------------------------\r\nTypeError                                 Traceback (most recent call last)\r\nCell In[1], line 8\r\n      6 subfigs = fig.subfigures(2,2)\r\n      7 with open('fig.p', 'wb') as file:\r\n----> 8     pickle.dump(fig, file)\r\n\r\nTypeError: cannot pickle 'FigureCanvasQTAgg' object\r\n```\r\n\r\n### Expected outcome\r\n\r\nA pickle file should be saved to the working directory.\r\n\r\n### Additional information\r\n\r\nI know the API is still provisional but I couldn't find other reports so I decided to post.\r\nI believe this is caused by the \"subfigures\" API, as skipping that line makes the script work.\r\nIt's my first time to report a issue, so I'm a bit worried if I'm doing things right.\r\n\r\n### Operating system\r\n\r\nWindows 10\r\n\r\n### Matplotlib Version\r\n\r\n3.9.0\r\n\r\n### Matplotlib Backend\r\n\r\nqtagg\r\n\r\n### Python version\r\n\r\n3.12.1\r\n\r\n### Jupyter version\r\n\r\n_No response_\r\n\r\n### Installation\r\n\r\npip\n", "hints_text": "", "created_at": "2024-06-26T07:13:10Z"}
{"repo": "matplotlib/matplotlib", "pull_number": 28458, "instance_id": "matplotlib__matplotlib-28458", "issue_numbers": ["28448"], "base_commit": "d7d1bba818ef36b2475b5d73cad6394841710211", "patch": "diff --git a/src/_image_wrapper.cpp b/src/_image_wrapper.cpp\nindex 65c8c8324ebc..856dcf4ea3ce 100644\n--- a/src/_image_wrapper.cpp\n+++ b/src/_image_wrapper.cpp\n@@ -173,20 +173,20 @@ image_resample(py::array input_array,\n \n     if (auto resampler =\n             (ndim == 2) ? (\n-                (dtype.is(py::dtype::of<std::uint8_t>())) ? resample<agg::gray8> :\n-                (dtype.is(py::dtype::of<std::int8_t>())) ? resample<agg::gray8> :\n-                (dtype.is(py::dtype::of<std::uint16_t>())) ? resample<agg::gray16> :\n-                (dtype.is(py::dtype::of<std::int16_t>())) ? resample<agg::gray16> :\n-                (dtype.is(py::dtype::of<float>())) ? resample<agg::gray32> :\n-                (dtype.is(py::dtype::of<double>())) ? resample<agg::gray64> :\n+                (dtype.equal(py::dtype::of<std::uint8_t>())) ? resample<agg::gray8> :\n+                (dtype.equal(py::dtype::of<std::int8_t>())) ? resample<agg::gray8> :\n+                (dtype.equal(py::dtype::of<std::uint16_t>())) ? resample<agg::gray16> :\n+                (dtype.equal(py::dtype::of<std::int16_t>())) ? resample<agg::gray16> :\n+                (dtype.equal(py::dtype::of<float>())) ? resample<agg::gray32> :\n+                (dtype.equal(py::dtype::of<double>())) ? resample<agg::gray64> :\n                 nullptr) : (\n             // ndim == 3\n-                (dtype.is(py::dtype::of<std::uint8_t>())) ? resample<agg::rgba8> :\n-                (dtype.is(py::dtype::of<std::int8_t>())) ? resample<agg::rgba8> :\n-                (dtype.is(py::dtype::of<std::uint16_t>())) ? resample<agg::rgba16> :\n-                (dtype.is(py::dtype::of<std::int16_t>())) ? resample<agg::rgba16> :\n-                (dtype.is(py::dtype::of<float>())) ? resample<agg::rgba32> :\n-                (dtype.is(py::dtype::of<double>())) ? resample<agg::rgba64> :\n+                (dtype.equal(py::dtype::of<std::uint8_t>())) ? resample<agg::rgba8> :\n+                (dtype.equal(py::dtype::of<std::int8_t>())) ? resample<agg::rgba8> :\n+                (dtype.equal(py::dtype::of<std::uint16_t>())) ? resample<agg::rgba16> :\n+                (dtype.equal(py::dtype::of<std::int16_t>())) ? resample<agg::rgba16> :\n+                (dtype.equal(py::dtype::of<float>())) ? resample<agg::rgba32> :\n+                (dtype.equal(py::dtype::of<double>())) ? resample<agg::rgba64> :\n                 nullptr)) {\n         Py_BEGIN_ALLOW_THREADS\n         resampler(\n", "test_patch": "diff --git a/lib/matplotlib/tests/test_image.py b/lib/matplotlib/tests/test_image.py\nindex 599265a2d4d8..8d7970078efa 100644\n--- a/lib/matplotlib/tests/test_image.py\n+++ b/lib/matplotlib/tests/test_image.py\n@@ -1576,3 +1576,20 @@ def test_non_transdata_image_does_not_touch_aspect():\n     assert ax.get_aspect() == 1\n     ax.imshow(im, transform=ax.transAxes, aspect=2)\n     assert ax.get_aspect() == 2\n+\n+\n+@pytest.mark.parametrize(\n+    'dtype',\n+    ('float64', 'float32', 'int16', 'uint16', 'int8', 'uint8'),\n+)\n+@pytest.mark.parametrize('ndim', (2, 3))\n+def test_resample_dtypes(dtype, ndim):\n+    # Issue 28448, incorrect dtype comparisons in C++ image_resample can raise\n+    # ValueError: arrays must be of dtype byte, short, float32 or float64\n+    rng = np.random.default_rng(4181)\n+    shape = (2, 2) if ndim == 2 else (2, 2, 3)\n+    data = rng.uniform(size=shape).astype(np.dtype(dtype, copy=True))\n+    fig, ax = plt.subplots()\n+    axes_image = ax.imshow(data)\n+    # Before fix the following raises ValueError for some dtypes.\n+    axes_image.make_image(None)[0]\n", "problem_statement": "[Bug]: Making an RGB image from pickled data throws error\n### Bug summary\r\n\r\nGetting an error when saving an animated RGB image that was loaded from a pickled figure. I've isolated the error to matplotlib 3.9.0, with this code working in 3.8.3, which makes me think that this is to do with the pybind11 upgrade in https://github.com/matplotlib/matplotlib/pull/26275?\r\n\r\nThings I've tried:\r\n* Grayscale images (eg `data = np.random.rand(100, 100)`) work.\r\n* Numpy v1.26.4 and v2.0.0 show no difference in behavior\r\n* This shows up at least on WSL and Ubuntu  \r\n* In the debugger, both `data.dtype` and `out.dtype` are showing `'float64'` prior to the `_image.resample` call.\r\n    * However, if I re-cast the arrays with `data = data.astype('float64')`, `out = ...`, then the `_image.resample` call no longer fails! \r\n     * If I re-cast only one, then `out.dtype == data.dtype` returns `True`, but on the function call I get the error `ValueError: Input and output arrays have mismatched types`\r\n     * ... so something is up with the types, and the C++ code is bombing. But python is saying things line up.\r\n\r\n\r\nSee these parts of the source: \r\n\r\nhttps://github.com/matplotlib/matplotlib/blob/d7d1bba818ef36b2475b5d73cad6394841710211/lib/matplotlib/image.py#L205-L213\r\nhttps://github.com/matplotlib/matplotlib/blob/d7d1bba818ef36b2475b5d73cad6394841710211/src/_image_wrapper.cpp#L174-L199\r\n\r\n\r\n### Code for reproduction\r\n\r\n```Python\r\nimport io\r\nimport pickle\r\nimport numpy as np\r\nimport matplotlib.pyplot as plt\r\nfrom pathlib import Path\r\nfrom matplotlib.animation import FuncAnimation\r\n\r\ndir = Path(__file__).parent.resolve()\r\n\r\n# generate random rgb data\r\nfig, ax = plt.subplots()\r\nnp.random.seed(0)\r\ndata = np.random.rand(100, 100, 3)\r\nax.imshow(data)\r\n\r\n# pick the figure and reload\r\nbuf = io.BytesIO()\r\npickle.dump(fig, buf)\r\nbuf.seek(0)\r\nfig_pickled = pickle.load(buf)\r\n\r\n# Animate\r\ndef update(frame):\r\n    return ax,\r\n\r\nani = FuncAnimation(fig_pickled, update, frames=2)\r\n\r\n# Save the animation\r\nfilepath = dir / 'test.gif' \r\nani.save(filepath)\r\n```\r\n\r\n\r\n### Actual outcome\r\n\r\n```\r\nException has occurred: ValueError\r\narrays must be of dtype byte, short, float32 or float64\r\n  File \"/mnt/c/Users/Scott/Documents/Documents/Coding/matplotlib/lib/matplotlib/image.py\", line 208, in _resample\r\n    _image.resample(data, out, transform,\r\n  File \"/mnt/c/Users/Scott/Documents/Documents/Coding/matplotlib/lib/matplotlib/image.py\", line 567, in _make_image\r\n    output = _resample(  # resample rgb channels\r\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/mnt/c/Users/Scott/Documents/Documents/Coding/matplotlib/lib/matplotlib/image.py\", line 952, in make_image\r\n    return self._make_image(self._A, bbox, transformed_bbox, clip,\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/mnt/c/Users/Scott/Documents/Documents/Coding/matplotlib/lib/matplotlib/image.py\", line 653, in draw\r\n    im, l, b, trans = self.make_image(\r\n                      ^^^^^^^^^^^^^^^^\r\n  File \"/mnt/c/Users/Scott/Documents/Documents/Coding/matplotlib/lib/matplotlib/artist.py\", line 72, in draw_wrapper\r\n    return draw(artist, renderer)\r\n           ^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/mnt/c/Users/Scott/Documents/Documents/Coding/matplotlib/lib/matplotlib/image.py\", line 132, in _draw_list_compositing_images\r\n    a.draw(renderer)\r\n  File \"/mnt/c/Users/Scott/Documents/Documents/Coding/matplotlib/lib/matplotlib/axes/_base.py\", line 3110, in draw\r\n    mimage._draw_list_compositing_images(\r\n  File \"/mnt/c/Users/Scott/Documents/Documents/Coding/matplotlib/lib/matplotlib/artist.py\", line 72, in draw_wrapper\r\n    return draw(artist, renderer)\r\n           ^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/mnt/c/Users/Scott/Documents/Documents/Coding/matplotlib/lib/matplotlib/image.py\", line 132, in _draw_list_compositing_images\r\n    a.draw(renderer)\r\n  File \"/mnt/c/Users/Scott/Documents/Documents/Coding/matplotlib/lib/matplotlib/figure.py\", line 3157, in draw\r\n    mimage._draw_list_compositing_images(\r\n  File \"/mnt/c/Users/Scott/Documents/Documents/Coding/matplotlib/lib/matplotlib/artist.py\", line 72, in draw_wrapper\r\n    return draw(artist, renderer)\r\n           ^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/mnt/c/Users/Scott/Documents/Documents/Coding/matplotlib/lib/matplotlib/artist.py\", line 95, in draw_wrapper\r\n    result = draw(artist, renderer, *args, **kwargs)\r\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/mnt/c/Users/Scott/Documents/Documents/Coding/matplotlib/lib/matplotlib/backends/backend_agg.py\", line 387, in draw\r\n    self.figure.draw(self.renderer)\r\n  File \"/mnt/c/Users/Scott/Documents/Documents/Coding/matplotlib/lib/matplotlib/backends/backend_agg.py\", line 432, in print_raw\r\n    FigureCanvasAgg.draw(self)\r\n  File \"/mnt/c/Users/Scott/Documents/Documents/Coding/matplotlib/lib/matplotlib/backend_bases.py\", line 2054, in <lambda>\r\n    print_method = functools.wraps(meth)(lambda *args, **kwargs: meth(\r\n                                                                 ^^^^^\r\n  File \"/mnt/c/Users/Scott/Documents/Documents/Coding/matplotlib/lib/matplotlib/backend_bases.py\", line 2204, in print_figure\r\n    result = print_method(\r\n             ^^^^^^^^^^^^^\r\n  File \"/mnt/c/Users/Scott/Documents/Documents/Coding/matplotlib/lib/matplotlib/backends/backend_qtagg.py\", line 75, in print_figure\r\n    super().print_figure(*args, **kwargs)\r\n  File \"/mnt/c/Users/Scott/Documents/Documents/Coding/matplotlib/lib/matplotlib/figure.py\", line 3390, in savefig\r\n    self.canvas.print_figure(fname, **kwargs)\r\n  File \"/mnt/c/Users/Scott/Documents/Documents/Coding/matplotlib/lib/matplotlib/animation.py\", line 371, in grab_frame\r\n    self.fig.savefig(self._proc.stdin, format=self.frame_format,\r\n  File \"/mnt/c/Users/Scott/Documents/Documents/Coding/matplotlib/lib/matplotlib/animation.py\", line 1109, in save\r\n    writer.grab_frame(**savefig_kwargs)\r\n  File \"/mnt/c/Users/Scott/Documents/Documents/Coding/matplotlib/_test_pybind11_error.py\", line 35, in <module>\r\n    ani.save(filepath)\r\nValueError: arrays must be of dtype byte, short, float32 or float64\r\n```\r\n\r\n### Matplotlib Version\r\n\r\n3.9.0\n", "hints_text": "I am able to work around this issue by manually re-casting the image data prior to the call, so my hunch is that this is an error to do with the pickling:\r\n\r\nUpdated example with workaround:\r\n```python\r\nimport io\r\nimport pickle\r\nimport numpy as np\r\nimport matplotlib as mpl\r\nimport matplotlib.pyplot as plt\r\nfrom pathlib import Path\r\nfrom matplotlib.animation import FuncAnimation\r\n\r\ndir = Path(__file__).parent.resolve()\r\n\r\n# generate random rgb data\r\nfig, ax = plt.subplots()\r\nnp.random.seed(0)\r\ndata = np.random.rand(100, 100, 3)\r\nax.imshow(data)\r\n\r\n# pick the figure and reload\r\nbuf = io.BytesIO()\r\npickle.dump(fig, buf)\r\nbuf.seek(0)\r\nfig_pickled = pickle.load(buf)\r\n\r\n# Workaround\r\nax = fig_pickled.get_axes()[0]\r\nartists = ax.get_children()\r\nfor artist in artists:\r\n    if isinstance(artist, mpl.image.AxesImage):\r\n        array = artist.get_array()\r\n        artist.set_array(array.data.astype('float64'))\r\n\r\n# Animate\r\ndef update(frame):\r\n    return ax,\r\n\r\nani = FuncAnimation(fig_pickled, update, frames=2)\r\n\r\n# Save the animation\r\nfilepath = dir / 'test.gif' \r\nani.save(filepath)\r\n```\nI can reproduce this on macOS without animation using:\r\n```python\r\nimport io\r\nimport numpy as np\r\nimport matplotlib.pyplot as plt\r\nimport pickle\r\n\r\nfig, ax = plt.subplots()\r\n\r\nrng = np.random.default_rng(4181)\r\ndata = rng.uniform(size=(2, 2, 3))\r\naxes_image = ax.imshow(data)\r\nprint(axes_image._A.shape, axes_image._A.dtype)\r\nim = axes_image.make_image(None)[0]\r\n\r\nbuf = io.BytesIO()\r\npickle.dump(axes_image, buf)\r\nbuf.seek(0)\r\naxes_image2 = pickle.load(buf)\r\nprint(axes_image2._A.shape, axes_image2._A.dtype)\r\n\r\n#axes_image2._A = axes_image2._A.astype(\"float64\")\r\nprint(\"Same dtype?\", axes_image._A.dtype == axes_image2._A.dtype)\r\n\r\nim = axes_image2.make_image(None)[0]\r\n```\r\nUsing this you get a `ValueError: arrays must be of dtype byte, short, float32 or float64`. If you remove the # to force a dtype change it works fine.\r\n\r\nThe problem occurs on this line\r\nhttps://github.com/matplotlib/matplotlib/blob/d7d1bba818ef36b2475b5d73cad6394841710211/src/_image_wrapper.cpp#L189\r\nAfter pickling and unpickling the numpy array dtype is fine from a Python point of view, but from a C++ pybind11 point of view the dtype has all the right properties but its `PyObject` has a different address so we conclude that it is not really a `double` (i.e. `np.float64`) dtype. I haven't got any further than this yet, but If my analysis is correct it should be possible to write a reproducer that doesn't use Matplotlib at all.\nCan we fallback to eq in the c++ code instead of `is` ?  A version of this is reproducible without pickle:\r\n\r\n```python\r\nimport matplotlib.pyplot as plt\r\nimport numpy as np\r\n\r\nfig, ax = plt.subplots()\r\n\r\nrng = np.random.default_rng(4181)\r\ndata = rng.uniform(size=(2, 2, 3)).astype(np.dtype('float64', copy=True))\r\naxes_image = ax.imshow(data)\r\nprint(axes_image._A.shape, axes_image._A.dtype)\r\nim = axes_image.make_image(None)[0]\r\n```\n> Can we fallback to eq in the c++ code instead of `is` ?\r\n\r\nIt looks like `dtype1.equal(dtype2)` is good.", "created_at": "2024-06-25T17:58:44Z"}
{"repo": "matplotlib/matplotlib", "pull_number": 28436, "instance_id": "matplotlib__matplotlib-28436", "issue_numbers": ["28434", "0000"], "base_commit": "53431a424fdf624a95de5b14540cfb3b5a5e6eb0", "patch": "diff --git a/lib/matplotlib/colors.py b/lib/matplotlib/colors.py\nindex c4e5987fdf92..177557b371a6 100644\n--- a/lib/matplotlib/colors.py\n+++ b/lib/matplotlib/colors.py\n@@ -225,7 +225,7 @@ def is_color_like(c):\n         return True\n     try:\n         to_rgba(c)\n-    except ValueError:\n+    except (TypeError, ValueError):\n         return False\n     else:\n         return True\n@@ -296,6 +296,11 @@ def to_rgba(c, alpha=None):\n         Tuple of floats ``(r, g, b, a)``, where each channel (red, green, blue,\n         alpha) can assume values between 0 and 1.\n     \"\"\"\n+    if isinstance(c, tuple) and len(c) == 2:\n+        if alpha is None:\n+            c, alpha = c\n+        else:\n+            c = c[0]\n     # Special-case nth color syntax because it should not be cached.\n     if _is_nth_color(c):\n         prop_cycler = mpl.rcParams['axes.prop_cycle']\n@@ -325,11 +330,6 @@ def _to_rgba_no_colorcycle(c, alpha=None):\n     *alpha* is ignored for the color value ``\"none\"`` (case-insensitive),\n     which always maps to ``(0, 0, 0, 0)``.\n     \"\"\"\n-    if isinstance(c, tuple) and len(c) == 2:\n-        if alpha is None:\n-            c, alpha = c\n-        else:\n-            c = c[0]\n     if alpha is not None and not 0 <= alpha <= 1:\n         raise ValueError(\"'alpha' must be between 0 and 1, inclusive\")\n     orig_c = c\n", "test_patch": "diff --git a/lib/matplotlib/tests/test_colors.py b/lib/matplotlib/tests/test_colors.py\nindex c8b44b2dea14..d99dd91e9cf5 100644\n--- a/lib/matplotlib/tests/test_colors.py\n+++ b/lib/matplotlib/tests/test_colors.py\n@@ -19,7 +19,7 @@\n import matplotlib.scale as mscale\n from matplotlib.rcsetup import cycler\n from matplotlib.testing.decorators import image_comparison, check_figures_equal\n-from matplotlib.colors import to_rgba_array\n+from matplotlib.colors import is_color_like, to_rgba_array\n \n \n @pytest.mark.parametrize('N, result', [\n@@ -1702,3 +1702,16 @@ def test_to_rgba_array_none_color_with_alpha_param():\n     assert_array_equal(\n         to_rgba_array(c, alpha), [[0., 0., 1., 1.], [0., 0., 0., 0.]]\n     )\n+\n+\n+@pytest.mark.parametrize('input, expected',\n+                         [('red', True),\n+                          (('red', 0.5), True),\n+                          (('red', 2), False),\n+                          (['red', 0.5], False),\n+                          (('red', 'blue'), False),\n+                          (['red', 'blue'], False),\n+                          ('C3', True),\n+                          (('C3', 0.5), True)])\n+def test_is_color_like(input, expected):\n+    assert is_color_like(input) is expected\n", "problem_statement": "[Bug]: Setting exactly 2 colors with tuple in `plot` method gives confusing error\n### Bug summary\n\nIf one attempts to set the `color` parameter to a tuple of length 2, a nonsense error message is returned.\n\n### Code for reproduction\n\n```Python\nimport matplotlib.pyplot as plt\r\nimport numpy as np\r\n\r\nx = np.linspace(0, 10, 100)\r\ny = np.array([np.sin(x), np.cos(x)]).T\r\n\r\nplt.plot(x, y, label=(\"sin(x)\", \"cos(x)\")) # works\r\nplt.plot(x, y, label=(\"sin(x)\", \"cos(x)\"), color=(\"red\", \"blue\")) # causes strange error\r\nplt.legend()\r\nplt.show()\n```\n\n\n### Actual outcome\n\nTraceback (most recent call last):\r\n  File \"/Users/miles/Desktop/thing.py\", line 8, in <module>\r\n    plt.plot(x, y, label=(\"sin(x)\", \"cos(x)\"), color=(\"red\", \"blue\")) # causes error\r\n  File \"/Library/Frameworks/Python.framework/Versions/3.9/lib/python3.9/site-packages/matplotlib/pyplot.py\", line 3708, in plot\r\n    return gca().plot(\r\n  File \"/Library/Frameworks/Python.framework/Versions/3.9/lib/python3.9/site-packages/matplotlib/axes/_axes.py\", line 1779, in plot\r\n    lines = [*self._get_lines(self, *args, data=data, **kwargs)]\r\n  File \"/Library/Frameworks/Python.framework/Versions/3.9/lib/python3.9/site-packages/matplotlib/axes/_base.py\", line 296, in __call__\r\n    yield from self._plot_args(\r\n  File \"/Library/Frameworks/Python.framework/Versions/3.9/lib/python3.9/site-packages/matplotlib/axes/_base.py\", line 534, in _plot_args\r\n    return [l[0] for l in result]\r\n  File \"/Library/Frameworks/Python.framework/Versions/3.9/lib/python3.9/site-packages/matplotlib/axes/_base.py\", line 534, in <listcomp>\r\n    return [l[0] for l in result]\r\n  File \"/Library/Frameworks/Python.framework/Versions/3.9/lib/python3.9/site-packages/matplotlib/axes/_base.py\", line 527, in <genexpr>\r\n    result = (make_artist(axes, x[:, j % ncx], y[:, j % ncy], kw,\r\n  File \"/Library/Frameworks/Python.framework/Versions/3.9/lib/python3.9/site-packages/matplotlib/axes/_base.py\", line 335, in _makeline\r\n    seg = mlines.Line2D(x, y, **kw)\r\n  File \"/Library/Frameworks/Python.framework/Versions/3.9/lib/python3.9/site-packages/matplotlib/lines.py\", line 376, in __init__\r\n    self.set_color(color)\r\n  File \"/Library/Frameworks/Python.framework/Versions/3.9/lib/python3.9/site-packages/matplotlib/lines.py\", line 1066, in set_color\r\n    mcolors._check_color_like(color=color)\r\n  File \"/Library/Frameworks/Python.framework/Versions/3.9/lib/python3.9/site-packages/matplotlib/colors.py\", line 245, in _check_color_like\r\n    if not is_color_like(v):\r\n  File \"/Library/Frameworks/Python.framework/Versions/3.9/lib/python3.9/site-packages/matplotlib/colors.py\", line 227, in is_color_like\r\n    to_rgba(c)\r\n  File \"/Library/Frameworks/Python.framework/Versions/3.9/lib/python3.9/site-packages/matplotlib/colors.py\", line 309, in to_rgba\r\n    rgba = _to_rgba_no_colorcycle(c, alpha)\r\n  File \"/Library/Frameworks/Python.framework/Versions/3.9/lib/python3.9/site-packages/matplotlib/colors.py\", line 334, in _to_rgba_no_colorcycle\r\n    if alpha is not None and not 0 <= alpha <= 1:\r\nTypeError: '<=' not supported between instances of 'int' and 'str'\n\n### Expected outcome\n\nEither: (1) works as expected as passing a tuple to `label` does, or, if this won't be supported, (2) a more sensical error message is returned, like if `[\"red\", \"blue\"]` were passed.\n\n### Additional information\n\nThis difficult-to-interpret error seems to be caused by the `if` statement of line 328 in `_to_rgba_no_colorcycle` in `colors.py`, which says `if isinstance(c, tuple) and len(c) == 2`. If I comment out this `if` statement, then the error message gives the normal `ValueError: ('red', 'blue') is not a valid value for color...` message. Of course, it would be great if multiple colors were supported here, but I understand if there is a bigger reason why it is not supported.\n\n### Operating system\n\nmacOS 14.4.1\n\n### Matplotlib Version\n\n3.9.0\n\n### Matplotlib Backend\n\nmacosx\n\n### Python version\n\n3.9.6\n\n### Jupyter version\n\n_No response_\n\n### Installation\n\npip\n", "hints_text": "This is a result of the `(color, alpha)` version of specifying colors that was introduced in [3.8.0](https://matplotlib.org/stable/users/prev_whats_new/whats_new_3.8.0.html#add-a-new-valid-color-format-matplotlib-color-alpha)\r\n\r\nThat is why it is specifically tuples (not lists) and specifically length 2...\r\n\r\nMy gut reaction is that the new color specifier is useful enough and the workaround (casting to list) is easy enough that I'm inclined towards keeping current behavior...\r\n\r\nOn the other hand, it may be reasonable to narrow the condition further to \"is the second entry in a length 2 tuple a number\"... and if it is not, treat it as a standard sequence of 2 colors instead...\r\n\r\nAs long as numbers are not valid color specifiers, this would differentiate the cases. I believe that is the case (though _string_ floating point values _are_ valid color specifiers for shades of gray...). Because if a number were a valid color specifier, then this would be an ambiguous case.\nJust catching the `TypeError` within `is_color_like` makes the error consistent with the list case\r\n\r\n```patch\r\ndiff --git a/lib/matplotlib/colors.py b/lib/matplotlib/colors.py\r\nindex c4e5987fdf..f6e78dc3e4 100644\r\n--- a/lib/matplotlib/colors.py\r\n+++ b/lib/matplotlib/colors.py\r\n@@ -225,7 +225,7 @@ def is_color_like(c):\r\n         return True\r\n     try:\r\n         to_rgba(c)\r\n-    except ValueError:\r\n+    except (ValueError, TypeError):\r\n         return False\r\n     else:\r\n         return True\r\n\r\n```\r\n```\r\nValueError: ('red', 'blue') is not a valid value for color: supported inputs are (r, g, b) and (r, g, b, a) 0-1 float tuples; '#rrggbb', '#rrggbbaa', '#rgb', '#rgba' strings; named color strings; string reprs of 0-1 floats for grayscale values; 'C0', 'C1', ... strings for colors of the color cycle; and pairs combining one of the above with an alpha value\r\n\r\n```\nNote there is no issue with functions that do take a color sequence\r\n```python\r\nplt.scatter([1, 2], [4, 5], c=(\"red\", \"blue\"))\r\n```\r\n![image](https://github.com/matplotlib/matplotlib/assets/10599679/f2504f6e-3159-4619-b090-f6ff81d81053)\r\n\n> Note there is no issue with functions that do take a color sequence\n\nDo we want to allow this function to take a color sequence? It would be in line w/ the other PRs that are vectorizing inputs.\nIt does seem odd that by default you get 2 colors but you cannot specify 2 colors.\nThe `_is_color_like` change proposed by @rcomer [above](https://github.com/matplotlib/matplotlib/issues/28434#issuecomment-2183340319) should be applied no matter what.\r\n\r\nI'm a bit hesitant on supporting sequences for color. If we do that, we'd have to expand to all parameters consistently. Note in particular that some parameters use sequences as single-value represenations already, e.g. colors and [linestyles](https://matplotlib.org/stable/gallery/lines_bars_and_markers/linestyles.html#linestyles), so detection of sequence-of-parameters is non-trivial. It's not completely unreasonable to support seqnce-of-parameters, but adds significant complexity to an already very complex function. If somebody implements this, I'd like to see an as-clean-as possible implementation.\r\n\r\nWhen adding label sequences, we've explicitly done that as an exception without the promise to support sequences on all parameters. The argument is that all other parameters can be addressed through the property cycle, i.e. can be configured up-front to a multiple-data plot. That's not possible for labels. See https://github.com/matplotlib/matplotlib/pull/16178#issuecomment-750528043.", "created_at": "2024-06-22T08:25:09Z"}
{"repo": "matplotlib/matplotlib", "pull_number": 28430, "instance_id": "matplotlib__matplotlib-28430", "issue_numbers": ["22482", "0000"], "base_commit": "d347c3227f8de8a99aa327390fee619310452a96", "patch": "diff --git a/lib/matplotlib/widgets.py b/lib/matplotlib/widgets.py\nindex ed130e6854f2..a298f3ae3d6a 100644\n--- a/lib/matplotlib/widgets.py\n+++ b/lib/matplotlib/widgets.py\n@@ -90,22 +90,6 @@ def ignore(self, event):\n         \"\"\"\n         return not self.active\n \n-    def _changed_canvas(self):\n-        \"\"\"\n-        Someone has switched the canvas on us!\n-\n-        This happens if `savefig` needs to save to a format the previous\n-        backend did not support (e.g. saving a figure using an Agg based\n-        backend saved to a vector format).\n-\n-        Returns\n-        -------\n-        bool\n-           True if the canvas has been changed.\n-\n-        \"\"\"\n-        return self.canvas is not self.ax.figure.canvas\n-\n \n class AxesWidget(Widget):\n     \"\"\"\n@@ -131,9 +115,10 @@ class AxesWidget(Widget):\n \n     def __init__(self, ax):\n         self.ax = ax\n-        self.canvas = ax.figure.canvas\n         self._cids = []\n \n+    canvas = property(lambda self: self.ax.figure.canvas)\n+\n     def connect_event(self, event, callback):\n         \"\"\"\n         Connect a callback function with an event.\n@@ -1100,7 +1085,7 @@ def __init__(self, ax, labels, actives=None, *, useblit=True,\n \n     def _clear(self, event):\n         \"\"\"Internal event handler to clear the buttons.\"\"\"\n-        if self.ignore(event) or self._changed_canvas():\n+        if self.ignore(event) or self.canvas.is_saving():\n             return\n         self._background = self.canvas.copy_from_bbox(self.ax.bbox)\n         self.ax.draw_artist(self._checks)\n@@ -1677,7 +1662,7 @@ def __init__(self, ax, labels, active=0, activecolor=None, *,\n \n     def _clear(self, event):\n         \"\"\"Internal event handler to clear the buttons.\"\"\"\n-        if self.ignore(event) or self._changed_canvas():\n+        if self.ignore(event) or self.canvas.is_saving():\n             return\n         self._background = self.canvas.copy_from_bbox(self.ax.bbox)\n         self.ax.draw_artist(self._buttons)\n@@ -1933,7 +1918,7 @@ def __init__(self, ax, *, horizOn=True, vertOn=True, useblit=False,\n \n     def clear(self, event):\n         \"\"\"Internal event handler to clear the cursor.\"\"\"\n-        if self.ignore(event) or self._changed_canvas():\n+        if self.ignore(event) or self.canvas.is_saving():\n             return\n         if self.useblit:\n             self.background = self.canvas.copy_from_bbox(self.ax.bbox)\n@@ -2573,9 +2558,7 @@ def __init__(self, ax, onselect, direction, *, minspan=0, useblit=False,\n         self.drag_from_anywhere = drag_from_anywhere\n         self.ignore_event_outside = ignore_event_outside\n \n-        # Reset canvas so that `new_axes` connects events.\n-        self.canvas = None\n-        self.new_axes(ax, _props=props)\n+        self.new_axes(ax, _props=props, _init=True)\n \n         # Setup handles\n         self._handle_props = {\n@@ -2588,14 +2571,15 @@ def __init__(self, ax, onselect, direction, *, minspan=0, useblit=False,\n \n         self._active_handle = None\n \n-    def new_axes(self, ax, *, _props=None):\n+    def new_axes(self, ax, *, _props=None, _init=False):\n         \"\"\"Set SpanSelector to operate on a new Axes.\"\"\"\n-        self.ax = ax\n-        if self.canvas is not ax.figure.canvas:\n+        reconnect = False\n+        if _init or self.canvas is not ax.figure.canvas:\n             if self.canvas is not None:\n                 self.disconnect_events()\n-\n-            self.canvas = ax.figure.canvas\n+            reconnect = True\n+        self.ax = ax\n+        if reconnect:\n             self.connect_default_events()\n \n         # Reset\ndiff --git a/lib/matplotlib/widgets.pyi b/lib/matplotlib/widgets.pyi\nindex c85ad2158ee7..58adf85aae60 100644\n--- a/lib/matplotlib/widgets.pyi\n+++ b/lib/matplotlib/widgets.pyi\n@@ -33,8 +33,9 @@ class Widget:\n \n class AxesWidget(Widget):\n     ax: Axes\n-    canvas: FigureCanvasBase | None\n     def __init__(self, ax: Axes) -> None: ...\n+    @property\n+    def canvas(self) -> FigureCanvasBase | None: ...\n     def connect_event(self, event: Event, callback: Callable) -> None: ...\n     def disconnect_events(self) -> None: ...\n \n@@ -310,7 +311,6 @@ class SpanSelector(_SelectorWidget):\n     grab_range: float\n     drag_from_anywhere: bool\n     ignore_event_outside: bool\n-    canvas: FigureCanvasBase | None\n     def __init__(\n         self,\n         ax: Axes,\n@@ -330,7 +330,13 @@ class SpanSelector(_SelectorWidget):\n         ignore_event_outside: bool = ...,\n         snap_values: ArrayLike | None = ...,\n     ) -> None: ...\n-    def new_axes(self, ax: Axes, *, _props: dict[str, Any] | None = ...) -> None: ...\n+    def new_axes(\n+        self,\n+        ax: Axes,\n+        *,\n+        _props: dict[str, Any] | None = ...,\n+        _init: bool = ...,\n+    ) -> None: ...\n     def connect_default_events(self) -> None: ...\n     @property\n     def direction(self) -> Literal[\"horizontal\", \"vertical\"]: ...\n", "test_patch": "diff --git a/lib/matplotlib/testing/__init__.py b/lib/matplotlib/testing/__init__.py\nindex 8e60267ed608..19113d399626 100644\n--- a/lib/matplotlib/testing/__init__.py\n+++ b/lib/matplotlib/testing/__init__.py\n@@ -211,3 +211,24 @@ def ipython_in_subprocess(requested_backend_or_gui_framework, all_expected_backe\n     )\n \n     assert proc.stdout.strip().endswith(f\"'{expected_backend}'\")\n+\n+\n+def is_ci_environment():\n+    # Common CI variables\n+    ci_environment_variables = [\n+        'CI',        # Generic CI environment variable\n+        'CONTINUOUS_INTEGRATION',  # Generic CI environment variable\n+        'TRAVIS',    # Travis CI\n+        'CIRCLECI',  # CircleCI\n+        'JENKINS',   # Jenkins\n+        'GITLAB_CI',  # GitLab CI\n+        'GITHUB_ACTIONS',  # GitHub Actions\n+        'TEAMCITY_VERSION'  # TeamCity\n+        # Add other CI environment variables as needed\n+    ]\n+\n+    for env_var in ci_environment_variables:\n+        if os.getenv(env_var):\n+            return True\n+\n+    return False\ndiff --git a/lib/matplotlib/testing/__init__.pyi b/lib/matplotlib/testing/__init__.pyi\nindex 1f52a8ccb8ee..6917b6a5a380 100644\n--- a/lib/matplotlib/testing/__init__.pyi\n+++ b/lib/matplotlib/testing/__init__.pyi\n@@ -51,3 +51,4 @@ def ipython_in_subprocess(\n     requested_backend_or_gui_framework: str,\n     all_expected_backends: dict[tuple[int, int], str],\n ) -> None: ...\n+def is_ci_environment() -> bool: ...\ndiff --git a/lib/matplotlib/tests/test_backends_interactive.py b/lib/matplotlib/tests/test_backends_interactive.py\nindex 6830e7d5c845..d624b5db0ac2 100644\n--- a/lib/matplotlib/tests/test_backends_interactive.py\n+++ b/lib/matplotlib/tests/test_backends_interactive.py\n@@ -19,7 +19,7 @@\n import matplotlib as mpl\n from matplotlib import _c_internal_utils\n from matplotlib.backend_tools import ToolToggleBase\n-from matplotlib.testing import subprocess_run_helper as _run_helper\n+from matplotlib.testing import subprocess_run_helper as _run_helper, is_ci_environment\n \n \n class _WaitForStringPopen(subprocess.Popen):\n@@ -110,27 +110,6 @@ def _get_testable_interactive_backends():\n             for env, marks in _get_available_interactive_backends()]\n \n \n-def is_ci_environment():\n-    # Common CI variables\n-    ci_environment_variables = [\n-        'CI',        # Generic CI environment variable\n-        'CONTINUOUS_INTEGRATION',  # Generic CI environment variable\n-        'TRAVIS',    # Travis CI\n-        'CIRCLECI',  # CircleCI\n-        'JENKINS',   # Jenkins\n-        'GITLAB_CI',  # GitLab CI\n-        'GITHUB_ACTIONS',  # GitHub Actions\n-        'TEAMCITY_VERSION'  # TeamCity\n-        # Add other CI environment variables as needed\n-    ]\n-\n-    for env_var in ci_environment_variables:\n-        if os.getenv(env_var):\n-            return True\n-\n-    return False\n-\n-\n # Reasonable safe values for slower CI/Remote and local architectures.\n _test_timeout = 120 if is_ci_environment() else 20\n \ndiff --git a/lib/matplotlib/tests/test_pickle.py b/lib/matplotlib/tests/test_pickle.py\nindex 0cba4f392035..1474a67d28aa 100644\n--- a/lib/matplotlib/tests/test_pickle.py\n+++ b/lib/matplotlib/tests/test_pickle.py\n@@ -1,5 +1,7 @@\n from io import BytesIO\n import ast\n+import os\n+import sys\n import pickle\n import pickletools\n \n@@ -8,7 +10,7 @@\n \n import matplotlib as mpl\n from matplotlib import cm\n-from matplotlib.testing import subprocess_run_helper\n+from matplotlib.testing import subprocess_run_helper, is_ci_environment\n from matplotlib.testing.decorators import check_figures_equal\n from matplotlib.dates import rrulewrapper\n from matplotlib.lines import VertexSelector\n@@ -307,3 +309,23 @@ def test_cycler():\n     ax = pickle.loads(pickle.dumps(ax))\n     l, = ax.plot([3, 4])\n     assert l.get_color() == \"m\"\n+\n+\n+# Run under an interactive backend to test that we don't try to pickle the\n+# (interactive and non-picklable) canvas.\n+def _test_axeswidget_interactive():\n+    ax = plt.figure().add_subplot()\n+    pickle.dumps(mpl.widgets.Button(ax, \"button\"))\n+\n+\n+@pytest.mark.xfail(  # https://github.com/actions/setup-python/issues/649\n+        ('TF_BUILD' in os.environ or 'GITHUB_ACTION' in os.environ) and\n+        sys.platform == 'darwin' and sys.version_info[:2] < (3, 11),\n+        reason='Tk version mismatch on Azure macOS CI'\n+    )\n+def test_axeswidget_interactive():\n+    subprocess_run_helper(\n+        _test_axeswidget_interactive,\n+        timeout=120 if is_ci_environment() else 20,\n+        extra_env={'MPLBACKEND': 'tkagg'}\n+    )\n", "problem_statement": "[ENH]: pickle (or save) matplotlib figure with insteractive slider\n### Problem\n\nI'd like to save/pickle a matplotlib figure containing a `matplotlib.widgets.Widget` object to send it to a colleague without him having to run the code I use to generate it.\r\n\r\nI know since matplotlib version 1.2 `matplotlib.figure.Figure` are pickable. However, when the figure contains a `matplotlib.widgets.Widget`, pickle fails to save it.\r\n\r\nFor example consider this class:\r\n\r\n```\r\nimport matplotlib.pyplot as plt\r\nimport matplotlib.widgets as widgets\r\n\r\nimport numpy as np\r\n\r\nimport pickle as pkl\r\n\r\nclass interactive_plot():\r\n\r\n    def __init__(self, add_slider):\r\n\r\n        self.fig, self.axs = plt.subplots(2,1, gridspec_kw={'height_ratios':[10,1]})\r\n\r\n        self.x_plot = np.linspace(0,10,1000)\r\n        self.line = self.axs[0].plot(self.x_plot, self.x_plot*0)[0]\r\n        self.axs[0].set_ylim((0,10))\r\n        self.axs[0].grid()\r\n        self.axs[0].set_title(r'$y = x^\\alpha$')\r\n\r\n        if add_slider:\r\n            self.slider= widgets.Slider(\r\n                self.axs[1],\r\n                label   = r'$\\alpha$',\r\n                valmin  = 0,\r\n                valmax  = 5,\r\n                valinit = 0,\r\n                valstep = .01\r\n                )\r\n            self.slider.on_changed(self.update)\r\n\r\n    def update(self, val):\r\n        self.line.set_ydata(self.x_plot**val)\r\n```\r\n\r\nIf I run\r\n\r\n```\r\nh = interactive_plot(add_slider=False)\r\nwith open('test.pkl','wb') as f: pkl.dump(h, f)\r\n```\r\nall works properly. However\r\n```\r\nh = interactive_plot(add_slider=True)\r\nwith open('test.pkl','wb') as f: pkl.dump(h, f)\r\n```\r\nreturns\r\n```\r\nTraceback (most recent call last):\r\n\r\n  File \"C:\\Users\\user\\Desktop\\test.py\", line 47, in <module>\r\n    with open('test.pkl','wb') as f: pkl.dump(h, f)\r\n\r\nTypeError: cannot pickle 'FigureCanvasQTAgg' object\r\n```\r\n\r\nIs there a way to workaround this?\r\n\r\nDISCLAIMER: The same question was posted here https://stackoverflow.com/questions/71145817/pickle-or-save-matplotlib-figure-with-insteractive-slider\n\n### Proposed solution\n\n_No response_\n", "hints_text": "```patch\r\ndiff --git i/lib/matplotlib/widgets.py w/lib/matplotlib/widgets.py\r\nindex 16e03f5624..a9f1145bf2 100644\r\n--- i/lib/matplotlib/widgets.py\r\n+++ w/lib/matplotlib/widgets.py\r\n@@ -115,9 +115,10 @@ class AxesWidget(Widget):\r\n \r\n     def __init__(self, ax):\r\n         self.ax = ax\r\n-        self.canvas = ax.figure.canvas\r\n         self._cids = []\r\n \r\n+    canvas = property(lambda self: self.ax.figure.canvas)\r\n+\r\n     def connect_event(self, event, callback):\r\n         \"\"\"\r\n         Connect a callback function with an event.\r\n```\r\n\"fixes\" the pickling itself (and seems like a reasonable patch regardless), but even then, the pickling process will drop any connected callbacks as functions can generally not be pickled.\n@anntzer is the dropping of callbacks when picking a figure builtin matplotlib ? or is it a limitation of the standard pickle module ? or is there some kind of criterion that make a function pickle-able or not ?\r\n\r\nI am in the same kind of  situation as @LucaAmerio, where I create matplotlib figure (with Qt backend) and callbacks connected to the figure and/or the axes. I'd like to be able to save and re-open those figure with the callbacks still active\nThe ability to pickle functions is limited per https://docs.python.org/3/library/pickle.html#what-can-be-pickled-and-unpickled.  We could consider pickling only whatever can actually be pickled and drop the rest, but I believe dropping everything (and asking whoever does the unpickling to reconnect things as needed) is not unreasonable either.", "created_at": "2024-06-20T15:34:29Z"}
{"repo": "matplotlib/matplotlib", "pull_number": 28401, "instance_id": "matplotlib__matplotlib-28401", "issue_numbers": ["28358"], "base_commit": "fa16860f58439735ddc4d2225876496545cb8e4e", "patch": "diff --git a/lib/matplotlib/text.py b/lib/matplotlib/text.py\nindex 7fc19c042a1f..af990ec1bf9f 100644\n--- a/lib/matplotlib/text.py\n+++ b/lib/matplotlib/text.py\n@@ -606,9 +606,8 @@ def set_wrap(self, wrap):\n         \"\"\"\n         Set whether the text can be wrapped.\n \n-        Wrapping makes sure the text is completely within the figure box, i.e.\n-        it does not extend beyond the drawing area. It does not take into\n-        account any other artists.\n+        Wrapping makes sure the text is confined to the (sub)figure box. It\n+        does not take into account any other artists.\n \n         Parameters\n         ----------\n@@ -657,16 +656,16 @@ def _get_dist_to_box(self, rotation, x0, y0, figure_box):\n         \"\"\"\n         if rotation > 270:\n             quad = rotation - 270\n-            h1 = y0 / math.cos(math.radians(quad))\n+            h1 = (y0 - figure_box.y0) / math.cos(math.radians(quad))\n             h2 = (figure_box.x1 - x0) / math.cos(math.radians(90 - quad))\n         elif rotation > 180:\n             quad = rotation - 180\n-            h1 = x0 / math.cos(math.radians(quad))\n-            h2 = y0 / math.cos(math.radians(90 - quad))\n+            h1 = (x0 - figure_box.x0) / math.cos(math.radians(quad))\n+            h2 = (y0 - figure_box.y0) / math.cos(math.radians(90 - quad))\n         elif rotation > 90:\n             quad = rotation - 90\n             h1 = (figure_box.y1 - y0) / math.cos(math.radians(quad))\n-            h2 = x0 / math.cos(math.radians(90 - quad))\n+            h2 = (x0 - figure_box.x0) / math.cos(math.radians(90 - quad))\n         else:\n             h1 = (figure_box.x1 - x0) / math.cos(math.radians(rotation))\n             h2 = (figure_box.y1 - y0) / math.cos(math.radians(90 - rotation))\n", "test_patch": "diff --git a/lib/matplotlib/tests/test_text.py b/lib/matplotlib/tests/test_text.py\nindex f8837d8a5f1b..8904337f68ba 100644\n--- a/lib/matplotlib/tests/test_text.py\n+++ b/lib/matplotlib/tests/test_text.py\n@@ -15,6 +15,7 @@\n from matplotlib.font_manager import FontProperties\n import matplotlib.patches as mpatches\n import matplotlib.pyplot as plt\n+from matplotlib.gridspec import GridSpec\n import matplotlib.transforms as mtransforms\n from matplotlib.testing.decorators import check_figures_equal, image_comparison\n from matplotlib.testing._markers import needs_usetex\n@@ -707,9 +708,13 @@ def test_large_subscript_title():\n      (0.3, 0, 'right'),\n      (0.3, 185, 'left')])\n def test_wrap(x, rotation, halign):\n-    fig = plt.figure(figsize=(6, 6))\n+    fig = plt.figure(figsize=(18, 18))\n+    gs = GridSpec(nrows=3, ncols=3, figure=fig)\n+    subfig = fig.add_subfigure(gs[1, 1])\n+    # we only use the central subfigure, which does not align with any\n+    # figure boundary, to ensure only subfigure boundaries are relevant\n     s = 'This is a very long text that should be wrapped multiple times.'\n-    text = fig.text(x, 0.7, s, wrap=True, rotation=rotation, ha=halign)\n+    text = subfig.text(x, 0.7, s, wrap=True, rotation=rotation, ha=halign)\n     fig.canvas.draw()\n     assert text._get_wrapped_text() == ('This is a very long\\n'\n                                         'text that should be\\n'\n", "problem_statement": "[Bug]: Labels don't get wrapped when set_yticks() is used in subplots\n### Bug summary\r\n\r\nWhen plotting bar charts in subplots with very long labels, the option of wrapping text only works on the first plotted subplot, despite passing `wrap=True` to `set_yticks()` in both cases.\r\n\r\n### Code for reproduction\r\n\r\n```Python\r\nimport matplotlib.pyplot as plt\r\nimport numpy as np\r\n\r\nlong_text_label = 'very long category label i want to wrap'\r\nlabels = [f\"{long_text_label}_{i}\" for i in range(5)]\r\nvalues = np.arange(1, 6)\r\n\r\nfig, axes = plt.subplots(1, 2)\r\n\r\naxes[0].barh(np.arange(len(labels)), values)\r\naxes[0].set_yticks(np.arange(len(labels)), labels=labels, wrap=True)\r\n\r\naxes[1].barh(np.arange(len(labels)), values)\r\naxes[1].set_yticks(np.arange(len(labels)), labels=labels, wrap=True)\r\n```\r\n\r\n\r\n### Actual outcome\r\n\r\n![output](https://github.com/matplotlib/matplotlib/assets/35564508/137c042d-a536-4a27-9991-e4e0a67ea527)\r\n\r\n\r\n### Expected outcome\r\n\r\nThe label text on the y axis should appear wrapped on both subplots\r\n\r\n### Additional information\r\n\r\n_No response_\r\n\r\n### Operating system\r\n\r\nmacOS 14.4 (23E214)\r\n\r\n### Matplotlib Version\r\n\r\n3.8.3\r\n\r\n### Matplotlib Backend\r\n\r\nmodule://matplotlib_inline.backend_inline\r\n\r\n### Python version\r\n\r\nPython 3.11.8\r\n\r\n### Jupyter version\r\n\r\n4.2.0\r\n\r\n### Installation\r\n\r\npip\n", "hints_text": "Thanks for the clear report @soogui.  I confirm that I have reproduced this with our `main` development branch.\nI'm not clear what the correct behaviour is here though.  Currently it's wrapping on the edge of the figure.  What would the inner axes wrap on?  The axes to the left presumably, but that isn't conceptually straight forward as an axes knows about its figure but not about its neighbours, and it knows its own spine position but doesn't try to reserve space for itself outside those spines.  Note we usually do the opposite and make the axes further apart to accommodate the ytick labels.  \nFor the current architecture, this is the expected behavior. We should better document what `warp` can or can't do.\r\n\r\nI see two possible ways to improve:\r\n- hard: Assign each axes a bounding box. This should work well with subplots/subplot_mosaic, but I'm unclear how other axes creation methods would handle this. Up to now, the Axes is defined via the data area, ticks and labels just spill outside as far as they need.\r\n- medium: Expand the `wrap` functionality to allow wrapping after N characters and/or specifying a maximal width.\nI think the conceptually simplest is to not allow auto wrap for tick labels.  Folks can manually wrap if they need to.  \nWell, the case of one subplot with long tick labels works. IMHO we should not break that.\r\n\r\nJust documenting that wrapping is limited to the figure boundary is good enough to manage expectations on the current behavior.\n@jklymak When #28177 is in, we could switch the wrapping box (in `Text._get_wrap_line_width`) to subfigure instead of figure. IMHO this boundary makes more sense. And it would at least allow to get what the OP wants using subfigures:\r\n\r\n```\r\nimport matplotlib.pyplot as plt\r\nimport numpy as np\r\n\r\nlong_text_label = 'very long category label i want to wrap'\r\nlabels = [f\"{long_text_label}_{i}\" for i in range(5)]\r\nvalues = np.arange(1, 6)\r\n\r\nfig = plt.figure()\r\nsubfigs = fig.subfigures(1, 2)\r\nax0 = subfigs[0].subplots()\r\nax1 = subfigs[1].subplots()\r\n\r\nax0.barh(np.arange(len(labels)), values)\r\nax0.set_yticks(np.arange(len(labels)), labels=labels, wrap=True)\r\n\r\nax1.barh(np.arange(len(labels)), values)\r\nax1.set_yticks(np.arange(len(labels)), labels=labels, wrap=True)\r\n```\r\n\r\n--> Created a separate issue for this #28378.\nThat's likely fine. However it should be noted that even in the single subplot situation the wrap is incompatible with layout management since that adjusts the size of the axes to account for the size of the labels versus wrapping the labels. \n\nAs stated I am mildly opposed to us jumping through hoops to allow wrapping tick labels because I don't think it s a generally useful thing to do. However if the issues with wrapping tick labels also extends to other text boxes in subfigures, that might merit some effort to fix.  ", "created_at": "2024-06-15T23:21:40Z"}
{"repo": "matplotlib/matplotlib", "pull_number": 28397, "instance_id": "matplotlib__matplotlib-28397", "issue_numbers": ["28384", "0000"], "base_commit": "b19794e126c1077b83eba90fe74ab1f67362b1ba", "patch": "diff --git a/lib/matplotlib/figure.py b/lib/matplotlib/figure.py\nindex 9139b2ed262f..9f764cc2332f 100644\n--- a/lib/matplotlib/figure.py\n+++ b/lib/matplotlib/figure.py\n@@ -1636,6 +1636,8 @@ def add_subfigure(self, subplotspec, **kwargs):\n         sf = SubFigure(self, subplotspec, **kwargs)\n         self.subfigs += [sf]\n         sf._remove_method = self.subfigs.remove\n+        sf.stale_callback = _stale_figure_callback\n+        self.stale = True\n         return sf\n \n     def sca(self, a):\n", "test_patch": "diff --git a/lib/matplotlib/tests/test_figure.py b/lib/matplotlib/tests/test_figure.py\nindex e8edcf61815d..5a8894b10496 100644\n--- a/lib/matplotlib/tests/test_figure.py\n+++ b/lib/matplotlib/tests/test_figure.py\n@@ -1741,3 +1741,27 @@ def test_subfigure_row_order():\n     sf_arr = fig.subfigures(4, 3)\n     for a, b in zip(sf_arr.ravel(), fig.subfigs):\n         assert a is b\n+\n+\n+def test_subfigure_stale_propagation():\n+    fig = plt.figure()\n+\n+    fig.draw_without_rendering()\n+    assert not fig.stale\n+\n+    sfig1 = fig.subfigures()\n+    assert fig.stale\n+\n+    fig.draw_without_rendering()\n+    assert not fig.stale\n+    assert not sfig1.stale\n+\n+    sfig2 = sfig1.subfigures()\n+    assert fig.stale\n+\n+    fig.draw_without_rendering()\n+    assert not fig.stale\n+    assert not sfig2.stale\n+\n+    sfig2.stale = True\n+    assert fig.stale\n", "problem_statement": "[Bug]: subfigure artists not drawn interactively\n### Bug summary\n\nWhen artists are added to a subfigure in interactive mode, they do not appear until I force a draw by resizing the window.\n\n### Code for reproduction\n\n```Python\n$ ipython --matplotlib=qt\r\nPython 3.12.3 | packaged by conda-forge | (main, Apr 15 2024, 18:38:13) [GCC 12.3.0]\r\nType 'copyright', 'credits' or 'license' for more information\r\nIPython 8.24.0 -- An enhanced Interactive Python. Type '?' for help.\r\n\r\nIn [1]: import matplotlib.pyplot as plt\r\n\r\nIn [2]: fig = plt.figure()\r\n\r\nIn [3]: sfig1, sfig2 = fig.subfigures(ncols=2)\r\n\r\nIn [4]: sfig2.suptitle(\"My Title\")\r\nOut[4]: Text(0.5, 0.98, 'My Title')\r\n\r\nIn [5]: ax = sfig1.subplots()\r\n\r\nIn [6]: ax.plot([1, 3, 2])\r\nOut[6]: [<matplotlib.lines.Line2D at 0x73a220908ce0>]\n```\n\n\n### Actual outcome\n\nApparently empty figure\r\n![image](https://github.com/matplotlib/matplotlib/assets/10599679/c6f531b3-cdb1-4af3-89ad-7f8d24c322b5)\r\n\n\n### Expected outcome\n\nIf I resize the window, the artists appear\r\n![image](https://github.com/matplotlib/matplotlib/assets/10599679/223737ec-3f78-4d58-9e3c-c2bff4833a85)\r\n\n\n### Additional information\n\n_No response_\n\n### Operating system\n\nUbuntu\n\n### Matplotlib Version\n\n`main`\n\n### Matplotlib Backend\n\nQtAgg and TkAgg\n\n### Python version\n\n3.12.3\n\n### Jupyter version\n\n_No response_\n\n### Installation\n\ngit checkout\n", "hints_text": "Very likely the issue is that `obj.stale` is not propogating up from the sub-figure to the parent.\nHuh. I never use interactive mode so didn't test that! Seems a pretty big oversight.  Thanks for finding. ", "created_at": "2024-06-14T17:55:24Z"}
{"repo": "matplotlib/matplotlib", "pull_number": 28393, "instance_id": "matplotlib__matplotlib-28393", "issue_numbers": ["28223", "0000"], "base_commit": "b19794e126c1077b83eba90fe74ab1f67362b1ba", "patch": "diff --git a/lib/matplotlib/axes/_base.py b/lib/matplotlib/axes/_base.py\nindex 1cf56c90cc6c..b810501ec7bb 100644\n--- a/lib/matplotlib/axes/_base.py\n+++ b/lib/matplotlib/axes/_base.py\n@@ -2942,9 +2942,15 @@ def handle_single_axis(\n             # Index of largest element < x0 + tol, if any.\n             i0 = stickies.searchsorted(x0 + tol) - 1\n             x0bound = stickies[i0] if i0 != -1 else None\n+            # Ensure the boundary acts only if the sticky is the extreme value\n+            if x0bound is not None and x0bound > x0:\n+                x0bound = None\n             # Index of smallest element > x1 - tol, if any.\n             i1 = stickies.searchsorted(x1 - tol)\n             x1bound = stickies[i1] if i1 != len(stickies) else None\n+            # Ensure the boundary acts only if the sticky is the extreme value\n+            if x1bound is not None and x1bound < x1:\n+                x1bound = None\n \n             # Add the margin in figure space and then transform back, to handle\n             # non-linear scales.\n", "test_patch": "diff --git a/lib/matplotlib/tests/baseline_images/test_axes/sticky_tolerance.png b/lib/matplotlib/tests/baseline_images/test_axes/sticky_tolerance.png\nnew file mode 100644\nindex 000000000000..a3fb13d0716a\nBinary files /dev/null and b/lib/matplotlib/tests/baseline_images/test_axes/sticky_tolerance.png differ\ndiff --git a/lib/matplotlib/tests/test_axes.py b/lib/matplotlib/tests/test_axes.py\nindex dd37d3d8ee80..48121ee04939 100644\n--- a/lib/matplotlib/tests/test_axes.py\n+++ b/lib/matplotlib/tests/test_axes.py\n@@ -682,6 +682,25 @@ def test_sticky_shared_axes(fig_test, fig_ref):\n     ax0.pcolormesh(Z)\n \n \n+@image_comparison(['sticky_tolerance.png'], remove_text=True, style=\"mpl20\")\n+def test_sticky_tolerance():\n+    fig, axs = plt.subplots(2, 2)\n+\n+    width = .1\n+\n+    axs.flat[0].bar(x=0, height=width, bottom=20000.6)\n+    axs.flat[0].bar(x=1, height=width, bottom=20000.1)\n+\n+    axs.flat[1].bar(x=0, height=-width, bottom=20000.6)\n+    axs.flat[1].bar(x=1, height=-width, bottom=20000.1)\n+\n+    axs.flat[2].barh(y=0, width=-width, left=-20000.6)\n+    axs.flat[2].barh(y=1, width=-width, left=-20000.1)\n+\n+    axs.flat[3].barh(y=0, width=width, left=-20000.6)\n+    axs.flat[3].barh(y=1, width=width, left=-20000.1)\n+\n+\n def test_nargs_stem():\n     with pytest.raises(TypeError, match='0 were given'):\n         # stem() takes 1-3 arguments.\n", "problem_statement": "[Bug]: Inconsistent Visualization of Intervals in ax.barh for Different Duration Widths\n### Bug summary\n\n**Issue Description:**\r\n\r\nWhen using ax.barh to visualize intervals, the function fails to display all intervals under certain conditions, which appears to be linked to the width of the intervals specified as duration. Specifically, intervals with a duration of 3 hours are not displayed properly, while increasing the duration to 5 hours results in correct visualization. This issue suggests a potential problem with how interval widths are handled or rendered in ax.barh.\r\n\r\n**Steps to Reproduce:**\r\nRefer to \"code for reproduction\"\r\n\r\n**Expected Behavior:**\r\n\r\nAll intervals should be visualized consistently, regardless of their duration width.\r\n\r\n**Actual Behavior:**\r\n\r\nIntervals with a shorter duration (3 hours) are not visualized correctly, while longer durations (5 hours) are displayed as expected.\n\n### Code for reproduction\n\n```Python\nfrom datetime import datetime, timedelta\r\nimport matplotlib.pyplot as plt\r\n\r\nfig, ax = plt.subplots()\r\n\r\nduration = timedelta(hours=3)\r\n# duration = timedelta(hours=5)\r\nax.barh(y=0, width=duration, left=datetime(2024, 1, 1, 6))\r\nax.barh(y=1, width=duration, left=datetime(2024, 1, 1, 1))\r\n\r\nplt.xticks(rotation=45)\r\nplt.tight_layout()\r\nplt.savefig('bug.png')\n```\n\n\n### Actual outcome\n\nOnly one of two bars is rendered.\r\n![image](https://github.com/matplotlib/matplotlib/assets/78612439/9ad98184-b0bb-4f8d-a976-043ceab01e70)\r\n\n\n### Expected outcome\n\nI expect both bars to appear:\r\n![image](https://github.com/matplotlib/matplotlib/assets/78612439/e3833e42-0869-4c93-95c7-be81adc576bc)\r\n\n\n### Additional information\n\n_No response_\n\n### Operating system\n\nUbuntu and Manjaro\n\n### Matplotlib Version\n\n3.8.4\n\n### Matplotlib Backend\n\nagg\n\n### Python version\n\n3.11.8\n\n### Jupyter version\n\n_No response_\n\n### Installation\n\npip\n", "hints_text": "This is a bug with the auto-limits as first bar starts immediately on the  right limit\r\n\r\nIf you draw the edges on the patches:\r\n\r\n```python\r\nax.barh(y=0, width=duration, left=datetime(2024, 1, 1, 6), lw=10, ec='k')\r\nax.barh(y=1, width=duration, left=datetime(2024, 1, 1, 1), lw=10, ec='k')\r\n```\r\n\r\nyou can see the left edge of the blue bar peaking out\r\n\r\n![bug](https://github.com/matplotlib/matplotlib/assets/199813/90bce6a1-477c-481f-bcf2-e0605a18dcbd)\r\n\r\n\r\nWhy making the orange bar long enough to overlap \"fixes\" it is very surprising to me.\nIf you pan (or manually set the limits) the second bar renders correctly, it is just that it is off screen by default.\nWe discussed this on a call, and the problem isn't with units, but with the relative size of the positions vs the widths of the bars (i.e., when dates are made unitless, they are positioned at ~20000 vs a width of < 1 for hours). This causes some poor interaction with sticky edges. @ksunden will be opening a PR shortly.", "created_at": "2024-06-13T22:54:16Z"}
{"repo": "matplotlib/matplotlib", "pull_number": 28388, "instance_id": "matplotlib__matplotlib-28388", "issue_numbers": ["28367", "0000"], "base_commit": "bcaffa137e5724259c4bf96a658fe3a11191b25e", "patch": "diff --git a/lib/matplotlib/backends/registry.py b/lib/matplotlib/backends/registry.py\nindex 19b4cba254ab..47d5f65e350e 100644\n--- a/lib/matplotlib/backends/registry.py\n+++ b/lib/matplotlib/backends/registry.py\n@@ -168,8 +168,11 @@ def backward_compatible_entry_points(\n     def _validate_and_store_entry_points(self, entries):\n         # Validate and store entry points so that they can be used via matplotlib.use()\n         # in the normal manner. Entry point names cannot be of module:// format, cannot\n-        # shadow a built-in backend name, and cannot be duplicated.\n-        for name, module in entries:\n+        # shadow a built-in backend name, and there cannot be multiple entry points\n+        # with the same name but different modules. Multiple entry points with the same\n+        # name and value are permitted (it can sometimes happen outside of our control,\n+        # see https://github.com/matplotlib/matplotlib/issues/28367).\n+        for name, module in set(entries):\n             name = name.lower()\n             if name.startswith(\"module://\"):\n                 raise RuntimeError(\n", "test_patch": "diff --git a/lib/matplotlib/tests/test_backend_registry.py b/lib/matplotlib/tests/test_backend_registry.py\nindex eaf8417e7a5f..141ffd69c266 100644\n--- a/lib/matplotlib/tests/test_backend_registry.py\n+++ b/lib/matplotlib/tests/test_backend_registry.py\n@@ -121,6 +121,17 @@ def test_entry_point_name_duplicate(clear_backend_registry):\n             [('some_name', 'module1'), ('some_name', 'module2')])\n \n \n+def test_entry_point_identical(clear_backend_registry):\n+    # Issue https://github.com/matplotlib/matplotlib/issues/28367\n+    # Multiple entry points with the same name and value (value is the module)\n+    # are acceptable.\n+    n = len(backend_registry._name_to_module)\n+    backend_registry._validate_and_store_entry_points(\n+        [('some_name', 'some.module'), ('some_name', 'some.module')])\n+    assert len(backend_registry._name_to_module) == n+1\n+    assert backend_registry._name_to_module['some_name'] == 'module://some.module'\n+\n+\n def test_entry_point_name_is_module(clear_backend_registry):\n     with pytest.raises(RuntimeError):\n         backend_registry._validate_and_store_entry_points(\n", "problem_statement": "[Bug]: Backend entry points can be erroneously duplicated\n### Summary\n\nUnder certain circumstances outside of our control, an `entry_points`-registering backend such as `matplotlib-inline` can appear as two entry points so that we raise a `RuntimeError(f\"Entry point name '{name}' duplicated\")`. Reported on [Matplotlib Discourse](https://discourse.matplotlib.org/t/latest-versions-via-pip-jupyterlab-import-of-matplotlib-broken/24477/6).\n\n### Proposed fix\n\nThe `BackendRegistry` purposefully does not allow multiple entry points with the same name as it has no way to know which one to prefer. This has now caused a problem in the linked discussion when using system python 3.9 and a virtual environment on Rocky 9.4 Linux. Although there is only a single `entry_points.txt` file for e.g. `matplotlib-inline` the system python `importlib.metadata.entry_points` erroneously returns two identical items. I think this is because the virtualenv has both a `lib` directory and a `lib64` symlink to the `lib` directory, and this particular combination of Linux distribution, python version and use of `venv` does not check that they both refer to the same file. Regardless of where the problem really lies here, Matplotlib needs to be able to deal with it.\r\n\r\nI'll submit a PR later in the week. I think the simplest change is to allow (i.e. discard) entry points that have the same `group` (e.g. `matplotlib.backend`), `name` (e.g. `inline`) and `value` (e.g. `matplotlib_inline.backend_inline`), and then raise if there are multiple entry points of the same `group` and `name` but different `value`.\n", "hints_text": "", "created_at": "2024-06-13T12:00:20Z"}
{"repo": "matplotlib/matplotlib", "pull_number": 28363, "instance_id": "matplotlib__matplotlib-28363", "issue_numbers": ["28344", "0000"], "base_commit": "5d6acdf486d0b7ca0065ea5eef9573f2c24b07b3", "patch": "diff --git a/doc/api/next_api_changes/behavior/28363-TS.rst b/doc/api/next_api_changes/behavior/28363-TS.rst\nnew file mode 100644\nindex 000000000000..2242f3929e04\n--- /dev/null\n+++ b/doc/api/next_api_changes/behavior/28363-TS.rst\n@@ -0,0 +1,6 @@\n+Subfigures\n+~~~~~~~~~~\n+\n+`.Figure.subfigures` are now added in row-major order to be consistent with\n+`.Figure.subplots`.  The return value of `~.Figure.subfigures` is not changed,\n+but the order of ``fig.subfigs`` is.\ndiff --git a/doc/users/next_whats_new/subfigures_change_order.rst b/doc/users/next_whats_new/subfigures_change_order.rst\nnew file mode 100644\nindex 000000000000..49a018a3fd96\n--- /dev/null\n+++ b/doc/users/next_whats_new/subfigures_change_order.rst\n@@ -0,0 +1,23 @@\n+Subfigures are now added in row-major order\n+-------------------------------------------\n+\n+``Figure.subfigures`` are now added in row-major order for API consistency.\n+\n+\n+.. plot::\n+    :include-source: true\n+    :alt: Example of creating 3 by 3 subfigures.\n+\n+    import matplotlib.pyplot as plt\n+\n+    fig = plt.figure()\n+    subfigs = fig.subfigures(3, 3)\n+    x = np.linspace(0, 10, 100)\n+\n+    for i, sf in enumerate(fig.subfigs):\n+        ax = sf.subplots()\n+        ax.plot(x, np.sin(x + i), label=f'Subfigure {i+1}')\n+        sf.suptitle(f'Subfigure {i+1}')\n+        ax.set_xticks([])\n+        ax.set_yticks([])\n+    plt.show()\ndiff --git a/lib/matplotlib/figure.py b/lib/matplotlib/figure.py\nindex 0a0ff01a2571..0aa90e716b1c 100644\n--- a/lib/matplotlib/figure.py\n+++ b/lib/matplotlib/figure.py\n@@ -1550,6 +1550,9 @@ def subfigures(self, nrows=1, ncols=1, squeeze=True,\n         .. note::\n             The *subfigure* concept is new in v3.4, and the API is still provisional.\n \n+        .. versionchanged:: 3.10\n+            subfigures are now added in row-major order.\n+\n         Parameters\n         ----------\n         nrows, ncols : int, default: 1\n@@ -1583,9 +1586,9 @@ def subfigures(self, nrows=1, ncols=1, squeeze=True,\n                       left=0, right=1, bottom=0, top=1)\n \n         sfarr = np.empty((nrows, ncols), dtype=object)\n-        for i in range(ncols):\n-            for j in range(nrows):\n-                sfarr[j, i] = self.add_subfigure(gs[j, i], **kwargs)\n+        for i in range(nrows):\n+            for j in range(ncols):\n+                sfarr[i, j] = self.add_subfigure(gs[i, j], **kwargs)\n \n         if self.get_layout_engine() is None and (wspace is not None or\n                                                  hspace is not None):\n", "test_patch": "diff --git a/lib/matplotlib/tests/test_figure.py b/lib/matplotlib/tests/test_figure.py\nindex 58aecd3dea8b..e8edcf61815d 100644\n--- a/lib/matplotlib/tests/test_figure.py\n+++ b/lib/matplotlib/tests/test_figure.py\n@@ -1733,3 +1733,11 @@ def test_warn_colorbar_mismatch():\n     subfig3_1.colorbar(im3_2)   # should not warn\n     with pytest.warns(UserWarning, match=\"different Figure\"):\n         subfig3_1.colorbar(im4_1)\n+\n+\n+def test_subfigure_row_order():\n+    # Test that subfigures are drawn in row-major order.\n+    fig = plt.figure()\n+    sf_arr = fig.subfigures(4, 3)\n+    for a, b in zip(sf_arr.ravel(), fig.subfigs):\n+        assert a is b\n", "problem_statement": "[Bug]: subfigures are added in column major order\n### Bug summary\n\nsubplots() adds axes in row-major order, but subfigures() add subfigures in column-major order\n\n### Code for reproduction\n\n```Python\nfrom pylab import *\r\n\r\nf = figure()\r\nf.subplots(3, 3)\r\nfor i, ax in enumerate(f.axes): ax.set_title(i)\r\nsavefig(\"/tmp/subplots.png\")\r\n\r\nf = figure()\r\nf.subfigures(3, 3)\r\nfor i, sf in enumerate(f.subfigs): sf.suptitle(i)\r\nsavefig(\"/tmp/subfigures.png\")\n```\n\n\n### Actual outcome\n\nsubplots\r\n![subplots](https://github.com/matplotlib/matplotlib/assets/1322974/0f972af4-492c-4621-941b-440cd9dab208)\r\n\r\nsubfigures\r\n![subfigures](https://github.com/matplotlib/matplotlib/assets/1322974/56b98e97-2b2c-476f-acd7-e9ebe2716ecb)\r\n\n\n### Expected outcome\n\nSubfigures are added in row-major axis, per standard numpy defaults.\n\n### Additional information\n\nIn practice this should rarely matter, as the subfigures don't overlap so drawing order should be irrelevant... perhaps unless some artists are positioned beyond the subfigure edge and not clipped.\r\n\r\nThe behavior directly arises from the iteration in subfigures:\r\n```python\r\n        sfarr = np.empty((nrows, ncols), dtype=object)\r\n        for i in range(ncols):\r\n            for j in range(nrows):\r\n                sfarr[j, i] = self.add_subfigure(gs[j, i], **kwargs)\r\n```\n\n### Operating system\n\nmacOS\n\n### Matplotlib Version\n\n3.10.0.dev233+ga833d99e46\n\n### Matplotlib Backend\n\nqtagg\n\n### Python version\n\n3.12\n\n### Jupyter version\n\nno\n\n### Installation\n\ngit checkout\n", "hints_text": "I am in favor of flipping `subfigures` to match `subplots`.   I think this is a case where we can not warn, but should just do it (and clearly document it).  I hope this won't bite too many people who are relying on the iteration order and get us out of explaining why it is different forever.\nIt should also be noted that subfigures as of 3.9 (I think) now respect z-order so you can move them up and down if you have to.", "created_at": "2024-06-09T07:04:08Z"}
{"repo": "matplotlib/matplotlib", "pull_number": 28306, "instance_id": "matplotlib__matplotlib-28306", "issue_numbers": ["4568"], "base_commit": "81756c366400a4c7d2c3934b5ff1a359206f241a", "patch": "diff --git a/lib/matplotlib/projections/polar.py b/lib/matplotlib/projections/polar.py\nindex 8d3e03f64e7c..025155351f88 100644\n--- a/lib/matplotlib/projections/polar.py\n+++ b/lib/matplotlib/projections/polar.py\n@@ -1447,12 +1447,25 @@ def format_sig(value, delta, opt, fmt):\n                     cbook._g_sig_digits(value, delta))\n             return f\"{value:-{opt}.{prec}{fmt}}\"\n \n-        return ('\\N{GREEK SMALL LETTER THETA}={}\\N{GREEK SMALL LETTER PI} '\n-                '({}\\N{DEGREE SIGN}), r={}').format(\n+        # In case fmt_xdata was not specified, resort to default\n+\n+        if self.fmt_ydata is None:\n+            r_label = format_sig(r, delta_r, \"#\", \"g\")\n+        else:\n+            r_label = self.format_ydata(r)\n+\n+        if self.fmt_xdata is None:\n+            return ('\\N{GREEK SMALL LETTER THETA}={}\\N{GREEK SMALL LETTER PI} '\n+                    '({}\\N{DEGREE SIGN}), r={}').format(\n                     format_sig(theta_halfturns, delta_t_halfturns, \"\", \"f\"),\n                     format_sig(theta_degrees, delta_t_degrees, \"\", \"f\"),\n-                    format_sig(r, delta_r, \"#\", \"g\"),\n+                    r_label\n                 )\n+        else:\n+            return '\\N{GREEK SMALL LETTER THETA}={}, r={}'.format(\n+                        self.format_xdata(theta),\n+                        r_label\n+                        )\n \n     def get_data_ratio(self):\n         \"\"\"\n", "test_patch": "diff --git a/lib/matplotlib/tests/test_polar.py b/lib/matplotlib/tests/test_polar.py\nindex 6b3c08d2eb3f..0bb41a50b2d4 100644\n--- a/lib/matplotlib/tests/test_polar.py\n+++ b/lib/matplotlib/tests/test_polar.py\n@@ -436,6 +436,33 @@ def test_cursor_precision():\n     assert ax.format_coord(2, 1) == \"\u03b8=0.637\u03c0 (114.6\u00b0), r=1.000\"\n \n \n+def test_custom_fmt_data():\n+    ax = plt.subplot(projection=\"polar\")\n+    def millions(x):\n+        return '$%1.1fM' % (x*1e-6)\n+\n+    # Test only x formatter\n+    ax.fmt_xdata = None\n+    ax.fmt_ydata = millions\n+    assert ax.format_coord(12, 2e7) == \"\u03b8=3.8197186342\u03c0 (687.54935416\u00b0), r=$20.0M\"\n+    assert ax.format_coord(1234, 2e6) == \"\u03b8=392.794399551\u03c0 (70702.9919191\u00b0), r=$2.0M\"\n+    assert ax.format_coord(3, 100) == \"\u03b8=0.95493\u03c0 (171.887\u00b0), r=$0.0M\"\n+\n+    # Test only y formatter\n+    ax.fmt_xdata = millions\n+    ax.fmt_ydata = None\n+    assert ax.format_coord(2e5, 1) == \"\u03b8=$0.2M, r=1.000\"\n+    assert ax.format_coord(1, .1) == \"\u03b8=$0.0M, r=0.100\"\n+    assert ax.format_coord(1e6, 0.005) == \"\u03b8=$1.0M, r=0.005\"\n+\n+    # Test both x and y formatters\n+    ax.fmt_xdata = millions\n+    ax.fmt_ydata = millions\n+    assert ax.format_coord(2e6, 2e4*3e5) == \"\u03b8=$2.0M, r=$6000.0M\"\n+    assert ax.format_coord(1e18, 12891328123) == \"\u03b8=$1000000000000.0M, r=$12891.3M\"\n+    assert ax.format_coord(63**7, 1081968*1024) == \"\u03b8=$3938980.6M, r=$1107.9M\"\n+\n+\n @image_comparison(['polar_log.png'], style='default')\n def test_polar_log():\n     fig = plt.figure()\n", "problem_statement": "Add `fmt_r` and `fmt_theta` methods to polar axes\nThe example here works in Cartesian coordinates:\n\nhttp://matplotlib.org/examples/pylab_examples/coords_report.html\n\nbut if you change \n\n`subplots()`\n\nto\n\n`subplots(subplot_kw={'polar':True})`\n\nThen the `millions()` function is never even called.\n\n( no response on mailing list: http://matplotlib.1069221.n5.nabble.com/fmt-xdata-fmt-ydata-on-polar-plot-td45838.html )\n\n", "hints_text": "Because the polar plot does not use those functions.  The message shown in the the gui are generated by calls to `axes.format_coords`, which is the case the the basic Cartesian coordinates the function is: https://github.com/matplotlib/matplotlib/blob/master/lib/matplotlib/axes/_base.py#L3056 which looks at `self.fmt_xdata` and `self.fmt_ydata` (via `format_xdata` and `format_ydata`).  In contrast the same function on the `Axes` sub-class for polar axes (https://github.com/matplotlib/matplotlib/blob/master/lib/matplotlib/projections/polar.py#L589) does not.  \n\nIf you want to change the message for polar coordinates, directly assign to `ax.format_coords` as shown in http://matplotlib.org/examples/api/image_zcoord.html.\n\nIt would be sensible to have a `fmt_r` and `fmt_theta` functions attached to polar axes.\n\nThanks for the solution!\n\nAs far as naming convention goes (if you do implement the new functions), I don't know if `fmt_r` and `fmt_theta` would make things more or less consistent... there are other cases in polar where we still use functions with 'x' and 'y' in the name... e.g. `set_yticklabels`.\n\nThe problem I have always had with PolarAxes is remembering whether x maps to r or theta. We need to use the x and y notations for subclassing purposes (that way the core matplotlib code can continue to work properly by treating PolarAxes like any other 2D axes object). Aliases to x and y for r and theta would be very useful to end-users in general, like we have now for some things in PolarAxes.\n\nHowever, I don't know how valuable it would be for this particular case. The way we advertise these formatting functions, we expect users to either monkey patch the particular method they want to modify, or to subclass and override the relevant method. If we had aliases, they won't get updated to the new methods, nor would they get used anyway by the internal methods.\n\nNo, I think the correct solution here is to make PolarAxes have a `fmt_xdata` and `fmt_ydata` method like most other classes do. I think the code we see in `format_coords` is intended to be compatibility code to help transition Axes objects that had not yet been updated to provide such methods.\n\nThis issue has been marked \"inactive\" because it has been 365 days since the last comment. If this issue is still present in recent Matplotlib releases, or the feature request is still wanted, please leave a comment and this label will be removed. If there are no updates in another 30 days, this issue will be automatically closed, but you are free to re-open or create a new issue if needed. We value issue reports, and this procedure is meant to help us resurface and prioritize issues that have not been addressed yet, not make them disappear.  Thanks for your help!\nhi there, @atpage @tacaswell is this issue still open?\nHi @antara-gandhi , unless the issue is closed (as seen on the GitHub interface) you are free to propose a PR or ask for guidance \ud83d\ude04 In this case, it would be nice to check if the issue is still present in recent versions and then propose a solution. Cheers!\nIs the goal to change the example code to use fmt_r and fmt_theta and be displayed as a polar graph or a way to standardize using fmt_r and fmt_theta to change coordinate plots to polar plots?\r\n\r\nMy second question is more if there is code I can modify, or do I need to come up with a way to standardize this?\r\n\nI changed and added to the example code is this correct?\r\n\r\n`def fmt_r(r):\r\n    \r\n    return f\"R={r:.2f}\"\r\n\r\ndef fmt_theta(theta, pos=None):\r\n    \r\n    return f\"Theta={np.degrees(theta):.2f}\u00b0\"\r\n\r\ndef millions(x, pos=None):\r\n    return '$%1.1fM' % (x*1e-6)\r\n\r\nx = np.random.rand(20)\r\ny = 1e7 * np.random.rand(20)\r\n\r\nfig, ax = plt.subplots(subplot_kw={'polar': True})\r\n\r\nax.set_yticklabels([fmt_r(label) for label in ax.get_yticks()])\r\n\r\nax.set_xticklabels([fmt_theta(label) for label in ax.get_xticks()])\r\n\r\nax.yaxis.set_major_formatter(plt.FuncFormatter(millions))\r\n\r\nax.plot(x, y, 'o')\r\n\r\nplt.show()`", "created_at": "2024-05-26T19:37:02Z"}
{"repo": "matplotlib/matplotlib", "pull_number": 28261, "instance_id": "matplotlib__matplotlib-28261", "issue_numbers": ["28256"], "base_commit": "31a2e1edb756e6b42ecd7ff405e488647d8ea27a", "patch": "diff --git a/lib/mpl_toolkits/mplot3d/axes3d.py b/lib/mpl_toolkits/mplot3d/axes3d.py\nindex d0f5c8d2b23b..677c2668d4e9 100644\n--- a/lib/mpl_toolkits/mplot3d/axes3d.py\n+++ b/lib/mpl_toolkits/mplot3d/axes3d.py\n@@ -1524,6 +1524,7 @@ def _on_move(self, event):\n             dazim = -(dy/h)*180*np.sin(roll) - (dx/w)*180*np.cos(roll)\n             elev = self.elev + delev\n             azim = self.azim + dazim\n+            roll = self.roll\n             vertical_axis = self._axis_names[self._vertical_axis]\n             self.view_init(\n                 elev=elev,\n", "test_patch": "diff --git a/lib/mpl_toolkits/mplot3d/tests/test_axes3d.py b/lib/mpl_toolkits/mplot3d/tests/test_axes3d.py\nindex ed56e5505d8e..c339e35e903c 100644\n--- a/lib/mpl_toolkits/mplot3d/tests/test_axes3d.py\n+++ b/lib/mpl_toolkits/mplot3d/tests/test_axes3d.py\n@@ -1766,6 +1766,31 @@ def test_shared_axes_retick():\n     assert ax2.get_zlim() == (-0.5, 2.5)\n \n \n+def test_rotate():\n+    \"\"\"Test rotating using the left mouse button.\"\"\"\n+    for roll in [0, 30]:\n+        fig = plt.figure()\n+        ax = fig.add_subplot(1, 1, 1, projection='3d')\n+        ax.view_init(0, 0, roll)\n+        ax.figure.canvas.draw()\n+\n+        # drag mouse horizontally to change azimuth\n+        dx = 0.1\n+        dy = 0.2\n+        ax._button_press(\n+            mock_event(ax, button=MouseButton.LEFT, xdata=0, ydata=0))\n+        ax._on_move(\n+            mock_event(ax, button=MouseButton.LEFT,\n+                           xdata=dx*ax._pseudo_w, ydata=dy*ax._pseudo_h))\n+        ax.figure.canvas.draw()\n+        roll_radians = np.deg2rad(ax.roll)\n+        cs = np.cos(roll_radians)\n+        sn = np.sin(roll_radians)\n+        assert ax.elev == (-dy*180*cs + dx*180*sn)\n+        assert ax.azim == (-dy*180*sn - dx*180*cs)\n+        assert ax.roll == roll\n+\n+\n def test_pan():\n     \"\"\"Test mouse panning using the middle mouse button.\"\"\"\n \n", "problem_statement": "[Bug]: axes3d.py's _on_move() converts the roll angle to radians, but then passes it to view_init() as if it were still in degrees\n### Bug summary\n\nIn \\lib\\mpl_toolkits\\mplot3d\\axes3d.py, `_on_move()` deals with rotation of 3d axes using the mouse.  In line 1522, the roll angle (in degrees) is converted to radians:\r\n`    roll = np.deg2rad(self.roll)`\r\nThis roll in radians is used to calculate a new elevation and azimuth, like so:\r\n```\r\n    delev = -(dy/h)*180*np.cos(roll) + (dx/w)*180*np.sin(roll)\r\n    dazim = -(dy/h)*180*np.sin(roll) - (dx/w)*180*np.cos(roll)\r\n    elev = self.elev + delev\r\n    azim = self.azim + dazim\r\n```\r\nA moment later, the view is updated:\r\n```\r\n    self.view_init(\r\n        elev=elev,\r\n        azim=azim,\r\n        roll=roll,\r\n        vertical_axis=vertical_axis,\r\n        share=True,\r\n    )\r\n```\r\nHowever, `view_init()` expects its parameters to be in degrees, not radians. As a consequence, the roll now diminishes by a factor pi/180 with every mouse movement. Not intended.\r\n\n\n### Code for reproduction\n\n```Python\n# Run the surface3d.py example, adding\r\nax.roll = 45\r\n# It shows the plot, in the intended funny orientation (roll=45)\r\n# Then move the mouse - you will see the orientation jump suddenly (to roll=0)\n```\n\n\n### Actual outcome\n\nThe figure orientation has jumped to roll=0, after trying to rotate it only slightly by dragging the mouse:\r\n![Figure_rotated](https://github.com/matplotlib/matplotlib/assets/122418839/ccbc7f47-dc27-499c-bee4-296b5b5164cb)\r\n\n\n### Expected outcome\n\nThe figure is close to its original orientation (before dragging the mouse), at roll=45:\r\n![Figure_1](https://github.com/matplotlib/matplotlib/assets/122418839/6e572bc9-e1f4-4a87-87f3-4b571ef06288)\r\n\n\n### Additional information\n\nFix: add a line:\r\n`roll = self.roll`\r\nright after updating `elev` and `azim` (i.e., after line 1526).\r\n\n\n### Operating system\n\nAll, presumably; but I noticed it on Windows\n\n### Matplotlib Version\n\n3.10.0.dev191+ge5af947d1b.d20240517\n\n### Matplotlib Backend\n\ntkagg\n\n### Python version\n\nPython 3.12.3\n\n### Jupyter version\n\n_No response_\n\n### Installation\n\npip\n", "hints_text": "", "created_at": "2024-05-19T18:36:49Z"}
{"repo": "matplotlib/matplotlib", "pull_number": 28186, "instance_id": "matplotlib__matplotlib-28186", "issue_numbers": ["28180", "0000"], "base_commit": "ce15014066654ec176e3244d33dbd07137b09f8d", "patch": "diff --git a/lib/matplotlib/_mathtext.py b/lib/matplotlib/_mathtext.py\nindex 6e4df209b1f9..e47c58c72f63 100644\n--- a/lib/matplotlib/_mathtext.py\n+++ b/lib/matplotlib/_mathtext.py\n@@ -2278,14 +2278,14 @@ def symbol(self, s: str, loc: int,\n \n         if c in self._spaced_symbols:\n             # iterate until we find previous character, needed for cases\n-            # such as ${ -2}$, $ -2$, or $   -2$.\n+            # such as $=-2$, ${ -2}$, $ -2$, or $   -2$.\n             prev_char = next((c for c in s[:loc][::-1] if c != ' '), '')\n             # Binary operators at start of string should not be spaced\n             # Also, operators in sub- or superscripts should not be spaced\n             if (self._in_subscript_or_superscript or (\n                     c in self._binary_operators and (\n-                    len(s[:loc].split()) == 0 or prev_char == '{' or\n-                    prev_char in self._left_delims))):\n+                    len(s[:loc].split()) == 0 or prev_char in {\n+                        '{', *self._left_delims, *self._relation_symbols}))):\n                 return [char]\n             else:\n                 return [Hlist([self._make_space(0.2),\n", "test_patch": "diff --git a/lib/matplotlib/tests/baseline_images/test_mathtext/mathtext_cm_83.pdf b/lib/matplotlib/tests/baseline_images/test_mathtext/mathtext_cm_83.pdf\nnew file mode 100644\nindex 000000000000..31ec241a04fc\nBinary files /dev/null and b/lib/matplotlib/tests/baseline_images/test_mathtext/mathtext_cm_83.pdf differ\ndiff --git a/lib/matplotlib/tests/baseline_images/test_mathtext/mathtext_cm_83.png b/lib/matplotlib/tests/baseline_images/test_mathtext/mathtext_cm_83.png\nnew file mode 100644\nindex 000000000000..a4ce71fb244b\nBinary files /dev/null and b/lib/matplotlib/tests/baseline_images/test_mathtext/mathtext_cm_83.png differ\ndiff --git a/lib/matplotlib/tests/baseline_images/test_mathtext/mathtext_cm_83.svg b/lib/matplotlib/tests/baseline_images/test_mathtext/mathtext_cm_83.svg\nnew file mode 100644\nindex 000000000000..01650aa1cfc5\n--- /dev/null\n+++ b/lib/matplotlib/tests/baseline_images/test_mathtext/mathtext_cm_83.svg\n@@ -0,0 +1,199 @@\n+<?xml version=\"1.0\" encoding=\"utf-8\" standalone=\"no\"?>\n+<!DOCTYPE svg PUBLIC \"-//W3C//DTD SVG 1.1//EN\"\n+  \"http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd\">\n+<svg xmlns:xlink=\"http://www.w3.org/1999/xlink\" width=\"378pt\" height=\"54pt\" viewBox=\"0 0 378 54\" xmlns=\"http://www.w3.org/2000/svg\" version=\"1.1\">\n+ <metadata>\n+  <rdf:RDF xmlns:dc=\"http://purl.org/dc/elements/1.1/\" xmlns:cc=\"http://creativecommons.org/ns#\" xmlns:rdf=\"http://www.w3.org/1999/02/22-rdf-syntax-ns#\">\n+   <cc:Work>\n+    <dc:type rdf:resource=\"http://purl.org/dc/dcmitype/StillImage\"/>\n+    <dc:date>2024-05-08T19:52:27.776189</dc:date>\n+    <dc:format>image/svg+xml</dc:format>\n+    <dc:creator>\n+     <cc:Agent>\n+      <dc:title>Matplotlib v3.10.0.dev150+gec4808956b.d20240508, https://matplotlib.org/</dc:title>\n+     </cc:Agent>\n+    </dc:creator>\n+   </cc:Work>\n+  </rdf:RDF>\n+ </metadata>\n+ <defs>\n+  <style type=\"text/css\">*{stroke-linejoin: round; stroke-linecap: butt}</style>\n+ </defs>\n+ <g id=\"figure_1\">\n+  <g id=\"patch_1\">\n+   <path d=\"M 0 54 \n+L 378 54 \n+L 378 0 \n+L 0 0 \n+z\n+\" style=\"fill: #ffffff\"/>\n+  </g>\n+  <g id=\"text_1\">\n+   <!-- $a=-b-c$ -->\n+   <g transform=\"translate(162.42 30.31125) scale(0.12 -0.12)\">\n+    <defs>\n+     <path id=\"Cmmi10-61\" d=\"M 1113 -72 \n+Q 709 -72 476 233 \n+Q 244 538 244 953 \n+Q 244 1363 456 1803 \n+Q 669 2244 1030 2536 \n+Q 1391 2828 1806 2828 \n+Q 1997 2828 2147 2725 \n+Q 2297 2622 2381 2444 \n+Q 2453 2700 2663 2700 \n+Q 2744 2700 2798 2651 \n+Q 2853 2603 2853 2522 \n+Q 2853 2503 2851 2493 \n+Q 2850 2484 2847 2472 \n+L 2400 684 \n+Q 2356 494 2356 372 \n+Q 2356 97 2541 97 \n+Q 2741 97 2845 351 \n+Q 2950 606 3022 941 \n+Q 3034 978 3072 978 \n+L 3150 978 \n+Q 3175 978 3190 956 \n+Q 3206 934 3206 916 \n+Q 3094 469 2961 198 \n+Q 2828 -72 2528 -72 \n+Q 2313 -72 2147 54 \n+Q 1981 181 1941 391 \n+Q 1528 -72 1113 -72 \n+z\n+M 1119 97 \n+Q 1350 97 1567 270 \n+Q 1784 444 1941 678 \n+Q 1947 684 1947 697 \n+L 2291 2088 \n+L 2297 2106 \n+Q 2259 2334 2132 2498 \n+Q 2006 2663 1791 2663 \n+Q 1575 2663 1389 2486 \n+Q 1203 2309 1075 2069 \n+Q 950 1813 836 1366 \n+Q 722 919 722 672 \n+Q 722 450 817 273 \n+Q 913 97 1119 97 \n+z\n+\" transform=\"scale(0.015625)\"/>\n+     <path id=\"Cmr10-3d\" d=\"M 481 850 \n+Q 428 850 393 890 \n+Q 359 931 359 978 \n+Q 359 1031 393 1068 \n+Q 428 1106 481 1106 \n+L 4500 1106 \n+Q 4547 1106 4581 1068 \n+Q 4616 1031 4616 978 \n+Q 4616 931 4581 890 \n+Q 4547 850 4500 850 \n+L 481 850 \n+z\n+M 481 2094 \n+Q 428 2094 393 2131 \n+Q 359 2169 359 2222 \n+Q 359 2269 393 2309 \n+Q 428 2350 481 2350 \n+L 4500 2350 \n+Q 4547 2350 4581 2309 \n+Q 4616 2269 4616 2222 \n+Q 4616 2169 4581 2131 \n+Q 4547 2094 4500 2094 \n+L 481 2094 \n+z\n+\" transform=\"scale(0.015625)\"/>\n+     <path id=\"Cmsy10-a1\" d=\"M 653 1472 \n+Q 600 1472 565 1512 \n+Q 531 1553 531 1600 \n+Q 531 1647 565 1687 \n+Q 600 1728 653 1728 \n+L 4325 1728 \n+Q 4375 1728 4408 1687 \n+Q 4441 1647 4441 1600 \n+Q 4441 1553 4408 1512 \n+Q 4375 1472 4325 1472 \n+L 653 1472 \n+z\n+\" transform=\"scale(0.015625)\"/>\n+     <path id=\"Cmmi10-62\" d=\"M 1106 -72 \n+Q 719 -72 503 231 \n+Q 288 534 288 941 \n+Q 288 1000 317 1173 \n+Q 347 1347 347 1388 \n+L 966 3872 \n+Q 991 3981 997 4044 \n+Q 997 4147 581 4147 \n+Q 519 4147 519 4231 \n+Q 522 4247 533 4287 \n+Q 544 4328 561 4350 \n+Q 578 4372 609 4372 \n+L 1472 4441 \n+Q 1550 4441 1550 4359 \n+L 1075 2472 \n+Q 1438 2828 1806 2828 \n+Q 2078 2828 2273 2684 \n+Q 2469 2541 2566 2306 \n+Q 2663 2072 2663 1806 \n+Q 2663 1497 2542 1167 \n+Q 2422 838 2209 555 \n+Q 1997 272 1712 100 \n+Q 1428 -72 1106 -72 \n+z\n+M 1119 97 \n+Q 1338 97 1528 280 \n+Q 1719 463 1838 691 \n+Q 1966 947 2077 1386 \n+Q 2188 1825 2188 2088 \n+Q 2188 2316 2092 2489 \n+Q 1997 2663 1791 2663 \n+Q 1559 2663 1348 2492 \n+Q 1138 2322 978 2088 \n+L 800 1363 \n+Q 697 959 691 716 \n+Q 691 475 795 286 \n+Q 900 97 1119 97 \n+z\n+\" transform=\"scale(0.015625)\"/>\n+     <path id=\"Cmmi10-63\" d=\"M 750 763 \n+Q 750 484 892 290 \n+Q 1034 97 1300 97 \n+Q 1681 97 2032 272 \n+Q 2384 447 2606 756 \n+Q 2625 775 2656 775 \n+Q 2688 775 2720 739 \n+Q 2753 703 2753 672 \n+Q 2753 647 2741 634 \n+Q 2506 306 2109 117 \n+Q 1713 -72 1288 -72 \n+Q 981 -72 747 73 \n+Q 513 219 384 462 \n+Q 256 706 256 1013 \n+Q 256 1444 497 1869 \n+Q 738 2294 1138 2561 \n+Q 1538 2828 1978 2828 \n+Q 2266 2828 2495 2689 \n+Q 2725 2550 2725 2278 \n+Q 2725 2103 2623 1979 \n+Q 2522 1856 2350 1856 \n+Q 2247 1856 2176 1920 \n+Q 2106 1984 2106 2088 \n+Q 2106 2238 2215 2344 \n+Q 2325 2450 2472 2450 \n+L 2484 2450 \n+Q 2409 2559 2267 2611 \n+Q 2125 2663 1972 2663 \n+Q 1597 2663 1315 2342 \n+Q 1034 2022 892 1576 \n+Q 750 1131 750 763 \n+z\n+\" transform=\"scale(0.015625)\"/>\n+    </defs>\n+    <use xlink:href=\"#Cmmi10-61\" transform=\"translate(0 0.609375)\"/>\n+    <use xlink:href=\"#Cmr10-3d\" transform=\"translate(70.341797 0.609375)\"/>\n+    <use xlink:href=\"#Cmsy10-a1\" transform=\"translate(165.585938 0.609375)\"/>\n+    <use xlink:href=\"#Cmmi10-62\" transform=\"translate(243.271484 0.609375)\"/>\n+    <use xlink:href=\"#Cmsy10-a1\" transform=\"translate(303.75 0.609375)\"/>\n+    <use xlink:href=\"#Cmmi10-63\" transform=\"translate(398.994141 0.609375)\"/>\n+   </g>\n+  </g>\n+ </g>\n+</svg>\ndiff --git a/lib/matplotlib/tests/baseline_images/test_mathtext/mathtext_dejavusans_83.pdf b/lib/matplotlib/tests/baseline_images/test_mathtext/mathtext_dejavusans_83.pdf\nnew file mode 100644\nindex 000000000000..e09af853ea1f\nBinary files /dev/null and b/lib/matplotlib/tests/baseline_images/test_mathtext/mathtext_dejavusans_83.pdf differ\ndiff --git a/lib/matplotlib/tests/baseline_images/test_mathtext/mathtext_dejavusans_83.png b/lib/matplotlib/tests/baseline_images/test_mathtext/mathtext_dejavusans_83.png\nnew file mode 100644\nindex 000000000000..8a03c6e92bc6\nBinary files /dev/null and b/lib/matplotlib/tests/baseline_images/test_mathtext/mathtext_dejavusans_83.png differ\ndiff --git a/lib/matplotlib/tests/baseline_images/test_mathtext/mathtext_dejavusans_83.svg b/lib/matplotlib/tests/baseline_images/test_mathtext/mathtext_dejavusans_83.svg\nnew file mode 100644\nindex 000000000000..b0a6fe95cfa3\n--- /dev/null\n+++ b/lib/matplotlib/tests/baseline_images/test_mathtext/mathtext_dejavusans_83.svg\n@@ -0,0 +1,159 @@\n+<?xml version=\"1.0\" encoding=\"utf-8\" standalone=\"no\"?>\n+<!DOCTYPE svg PUBLIC \"-//W3C//DTD SVG 1.1//EN\"\n+  \"http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd\">\n+<svg xmlns:xlink=\"http://www.w3.org/1999/xlink\" width=\"378pt\" height=\"54pt\" viewBox=\"0 0 378 54\" xmlns=\"http://www.w3.org/2000/svg\" version=\"1.1\">\n+ <metadata>\n+  <rdf:RDF xmlns:dc=\"http://purl.org/dc/elements/1.1/\" xmlns:cc=\"http://creativecommons.org/ns#\" xmlns:rdf=\"http://www.w3.org/1999/02/22-rdf-syntax-ns#\">\n+   <cc:Work>\n+    <dc:type rdf:resource=\"http://purl.org/dc/dcmitype/StillImage\"/>\n+    <dc:date>2024-05-08T19:52:35.349617</dc:date>\n+    <dc:format>image/svg+xml</dc:format>\n+    <dc:creator>\n+     <cc:Agent>\n+      <dc:title>Matplotlib v3.10.0.dev150+gec4808956b.d20240508, https://matplotlib.org/</dc:title>\n+     </cc:Agent>\n+    </dc:creator>\n+   </cc:Work>\n+  </rdf:RDF>\n+ </metadata>\n+ <defs>\n+  <style type=\"text/css\">*{stroke-linejoin: round; stroke-linecap: butt}</style>\n+ </defs>\n+ <g id=\"figure_1\">\n+  <g id=\"patch_1\">\n+   <path d=\"M 0 54 \n+L 378 54 \n+L 378 0 \n+L 0 0 \n+z\n+\" style=\"fill: #ffffff\"/>\n+  </g>\n+  <g id=\"text_1\">\n+   <!-- $a=-b-c$ -->\n+   <g transform=\"translate(158.4 30.31125) scale(0.12 -0.12)\">\n+    <defs>\n+     <path id=\"DejaVuSans-Oblique-61\" d=\"M 3438 1997 \n+L 3047 0 \n+L 2472 0 \n+L 2578 531 \n+Q 2325 219 2001 64 \n+Q 1678 -91 1281 -91 \n+Q 834 -91 548 182 \n+Q 263 456 263 884 \n+Q 263 1497 752 1853 \n+Q 1241 2209 2100 2209 \n+L 2900 2209 \n+L 2931 2363 \n+Q 2938 2388 2941 2417 \n+Q 2944 2447 2944 2509 \n+Q 2944 2788 2717 2942 \n+Q 2491 3097 2081 3097 \n+Q 1800 3097 1504 3025 \n+Q 1209 2953 897 2809 \n+L 997 3341 \n+Q 1322 3463 1633 3523 \n+Q 1944 3584 2234 3584 \n+Q 2853 3584 3176 3315 \n+Q 3500 3047 3500 2534 \n+Q 3500 2431 3484 2292 \n+Q 3469 2153 3438 1997 \n+z\n+M 2816 1759 \n+L 2241 1759 \n+Q 1534 1759 1195 1570 \n+Q 856 1381 856 984 \n+Q 856 709 1029 553 \n+Q 1203 397 1509 397 \n+Q 1978 397 2328 733 \n+Q 2678 1069 2791 1631 \n+L 2816 1759 \n+z\n+\" transform=\"scale(0.015625)\"/>\n+     <path id=\"DejaVuSans-3d\" d=\"M 678 2906 \n+L 4684 2906 \n+L 4684 2381 \n+L 678 2381 \n+L 678 2906 \n+z\n+M 678 1631 \n+L 4684 1631 \n+L 4684 1100 \n+L 678 1100 \n+L 678 1631 \n+z\n+\" transform=\"scale(0.015625)\"/>\n+     <path id=\"DejaVuSans-2212\" d=\"M 678 2272 \n+L 4684 2272 \n+L 4684 1741 \n+L 678 1741 \n+L 678 2272 \n+z\n+\" transform=\"scale(0.015625)\"/>\n+     <path id=\"DejaVuSans-Oblique-62\" d=\"M 3169 2138 \n+Q 3169 2591 2961 2847 \n+Q 2753 3103 2388 3103 \n+Q 2122 3103 1889 2973 \n+Q 1656 2844 1484 2597 \n+Q 1303 2338 1198 1995 \n+Q 1094 1653 1094 1313 \n+Q 1094 881 1298 636 \n+Q 1503 391 1863 391 \n+Q 2134 391 2365 517 \n+Q 2597 644 2772 891 \n+Q 2950 1147 3059 1487 \n+Q 3169 1828 3169 2138 \n+z\n+M 1381 2969 \n+Q 1594 3256 1914 3420 \n+Q 2234 3584 2584 3584 \n+Q 3122 3584 3439 3221 \n+Q 3756 2859 3756 2241 \n+Q 3756 1734 3570 1259 \n+Q 3384 784 3041 416 \n+Q 2816 172 2522 40 \n+Q 2228 -91 1906 -91 \n+Q 1566 -91 1316 65 \n+Q 1066 222 909 531 \n+L 806 0 \n+L 231 0 \n+L 1178 4863 \n+L 1753 4863 \n+L 1381 2969 \n+z\n+\" transform=\"scale(0.015625)\"/>\n+     <path id=\"DejaVuSans-Oblique-63\" d=\"M 3431 3366 \n+L 3316 2797 \n+Q 3109 2947 2876 3022 \n+Q 2644 3097 2394 3097 \n+Q 2119 3097 1870 3000 \n+Q 1622 2903 1453 2725 \n+Q 1184 2453 1037 2087 \n+Q 891 1722 891 1331 \n+Q 891 859 1127 628 \n+Q 1363 397 1844 397 \n+Q 2081 397 2348 469 \n+Q 2616 541 2906 684 \n+L 2797 116 \n+Q 2547 13 2283 -39 \n+Q 2019 -91 1741 -91 \n+Q 1044 -91 669 257 \n+Q 294 606 294 1253 \n+Q 294 1797 489 2255 \n+Q 684 2713 1069 3078 \n+Q 1331 3328 1684 3456 \n+Q 2038 3584 2456 3584 \n+Q 2700 3584 2940 3529 \n+Q 3181 3475 3431 3366 \n+z\n+\" transform=\"scale(0.015625)\"/>\n+    </defs>\n+    <use xlink:href=\"#DejaVuSans-Oblique-61\" transform=\"translate(0 0.015625)\"/>\n+    <use xlink:href=\"#DejaVuSans-3d\" transform=\"translate(80.761719 0.015625)\"/>\n+    <use xlink:href=\"#DejaVuSans-2212\" transform=\"translate(184.033203 0.015625)\"/>\n+    <use xlink:href=\"#DejaVuSans-Oblique-62\" transform=\"translate(267.822266 0.015625)\"/>\n+    <use xlink:href=\"#DejaVuSans-2212\" transform=\"translate(350.78125 0.015625)\"/>\n+    <use xlink:href=\"#DejaVuSans-Oblique-63\" transform=\"translate(454.052734 0.015625)\"/>\n+   </g>\n+  </g>\n+ </g>\n+</svg>\ndiff --git a/lib/matplotlib/tests/baseline_images/test_mathtext/mathtext_dejavuserif_83.pdf b/lib/matplotlib/tests/baseline_images/test_mathtext/mathtext_dejavuserif_83.pdf\nnew file mode 100644\nindex 000000000000..db06e90e5490\nBinary files /dev/null and b/lib/matplotlib/tests/baseline_images/test_mathtext/mathtext_dejavuserif_83.pdf differ\ndiff --git a/lib/matplotlib/tests/baseline_images/test_mathtext/mathtext_dejavuserif_83.png b/lib/matplotlib/tests/baseline_images/test_mathtext/mathtext_dejavuserif_83.png\nnew file mode 100644\nindex 000000000000..d5c323fa9bd2\nBinary files /dev/null and b/lib/matplotlib/tests/baseline_images/test_mathtext/mathtext_dejavuserif_83.png differ\ndiff --git a/lib/matplotlib/tests/baseline_images/test_mathtext/mathtext_dejavuserif_83.svg b/lib/matplotlib/tests/baseline_images/test_mathtext/mathtext_dejavuserif_83.svg\nnew file mode 100644\nindex 000000000000..1c3ac31ac5eb\n--- /dev/null\n+++ b/lib/matplotlib/tests/baseline_images/test_mathtext/mathtext_dejavuserif_83.svg\n@@ -0,0 +1,148 @@\n+<?xml version=\"1.0\" encoding=\"utf-8\" standalone=\"no\"?>\n+<!DOCTYPE svg PUBLIC \"-//W3C//DTD SVG 1.1//EN\"\n+  \"http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd\">\n+<svg xmlns:xlink=\"http://www.w3.org/1999/xlink\" width=\"378pt\" height=\"54pt\" viewBox=\"0 0 378 54\" xmlns=\"http://www.w3.org/2000/svg\" version=\"1.1\">\n+ <metadata>\n+  <rdf:RDF xmlns:dc=\"http://purl.org/dc/elements/1.1/\" xmlns:cc=\"http://creativecommons.org/ns#\" xmlns:rdf=\"http://www.w3.org/1999/02/22-rdf-syntax-ns#\">\n+   <cc:Work>\n+    <dc:type rdf:resource=\"http://purl.org/dc/dcmitype/StillImage\"/>\n+    <dc:date>2024-05-08T19:52:37.707152</dc:date>\n+    <dc:format>image/svg+xml</dc:format>\n+    <dc:creator>\n+     <cc:Agent>\n+      <dc:title>Matplotlib v3.10.0.dev150+gec4808956b.d20240508, https://matplotlib.org/</dc:title>\n+     </cc:Agent>\n+    </dc:creator>\n+   </cc:Work>\n+  </rdf:RDF>\n+ </metadata>\n+ <defs>\n+  <style type=\"text/css\">*{stroke-linejoin: round; stroke-linecap: butt}</style>\n+ </defs>\n+ <g id=\"figure_1\">\n+  <g id=\"patch_1\">\n+   <path d=\"M 0 54 \n+L 378 54 \n+L 378 0 \n+L 0 0 \n+z\n+\" style=\"fill: #ffffff\"/>\n+  </g>\n+  <g id=\"text_1\">\n+   <!-- $a=-b-c$ -->\n+   <g transform=\"translate(158.58 30.31125) scale(0.12 -0.12)\">\n+    <defs>\n+     <path id=\"DejaVuSerif-Italic-61\" d=\"M 2325 519 \n+Q 1909 -91 1238 -91 \n+Q 688 -91 409 281 \n+Q 216 544 216 919 \n+Q 216 1078 250 1256 \n+Q 463 2359 1231 2928 \n+Q 1884 3413 2675 3413 \n+Q 3206 3413 3388 3322 \n+L 2806 331 \n+L 3300 331 \n+L 3238 0 \n+L 2225 0 \n+L 2325 519 \n+z\n+M 822 938 \n+Q 822 269 1469 269 \n+Q 1863 269 2130 583 \n+Q 2397 897 2516 1497 \n+L 2806 3003 \n+L 2806 3003 \n+Q 2806 3094 2556 3094 \n+Q 1956 3094 1491 2625 \n+Q 1028 2153 863 1297 \n+Q 822 1097 822 938 \n+z\n+\" transform=\"scale(0.015625)\"/>\n+     <path id=\"DejaVuSerif-3d\" d=\"M 678 2894 \n+L 4684 2894 \n+L 4684 2394 \n+L 678 2394 \n+L 678 2894 \n+z\n+M 678 1619 \n+L 4684 1619 \n+L 4684 1119 \n+L 678 1119 \n+L 678 1619 \n+z\n+\" transform=\"scale(0.015625)\"/>\n+     <path id=\"DejaVuSerif-2212\" d=\"M 678 2259 \n+L 4684 2259 \n+L 4684 1753 \n+L 678 1753 \n+L 678 2259 \n+z\n+\" transform=\"scale(0.015625)\"/>\n+     <path id=\"DejaVuSerif-Italic-62\" d=\"M 1153 4531 \n+L 600 4531 \n+L 666 4863 \n+L 1794 4863 \n+L 1394 2803 \n+Q 1622 3116 1912 3264 \n+Q 2203 3413 2588 3413 \n+Q 3200 3413 3494 2928 \n+Q 3688 2609 3688 2163 \n+Q 3688 1928 3634 1663 \n+Q 3481 881 3000 395 \n+Q 2519 -91 1906 -91 \n+Q 1522 -91 1289 57 \n+Q 1056 206 950 519 \n+L 850 0 \n+L 275 0 \n+L 1153 4531 \n+z\n+M 1141 1497 \n+Q 1091 1250 1091 1053 \n+Q 1091 769 1191 581 \n+Q 1359 269 1797 269 \n+Q 2238 269 2533 622 \n+Q 2828 975 2963 1663 \n+Q 3025 1978 3025 2225 \n+Q 3025 2513 2938 2703 \n+Q 2781 3053 2338 3053 \n+Q 1900 3053 1609 2737 \n+Q 1319 2422 1203 1825 \n+L 1141 1497 \n+z\n+\" transform=\"scale(0.015625)\"/>\n+     <path id=\"DejaVuSerif-Italic-63\" d=\"M 3163 997 \n+Q 2938 466 2536 187 \n+Q 2134 -91 1584 -91 \n+Q 859 -91 513 388 \n+Q 272 722 272 1203 \n+Q 272 1419 319 1663 \n+Q 475 2459 1008 2936 \n+Q 1541 3413 2266 3413 \n+Q 2581 3413 2879 3339 \n+Q 3178 3266 3463 3116 \n+L 3300 2266 \n+L 2966 2266 \n+Q 2966 2309 2966 2347 \n+Q 2966 2722 2803 2903 \n+Q 2622 3103 2213 3103 \n+Q 1747 3103 1439 2742 \n+Q 1131 2381 991 1663 \n+Q 928 1334 928 1078 \n+Q 928 778 1016 581 \n+Q 1181 219 1650 219 \n+Q 2022 219 2281 412 \n+Q 2541 606 2700 997 \n+L 3163 997 \n+z\n+\" transform=\"scale(0.015625)\"/>\n+    </defs>\n+    <use xlink:href=\"#DejaVuSerif-Italic-61\" transform=\"translate(0 0.015625)\"/>\n+    <use xlink:href=\"#DejaVuSerif-3d\" transform=\"translate(78.583984 0.015625)\"/>\n+    <use xlink:href=\"#DejaVuSerif-2212\" transform=\"translate(181.337891 0.015625)\"/>\n+    <use xlink:href=\"#DejaVuSerif-Italic-62\" transform=\"translate(265.126953 0.015625)\"/>\n+    <use xlink:href=\"#DejaVuSerif-2212\" transform=\"translate(348.105469 0.015625)\"/>\n+    <use xlink:href=\"#DejaVuSerif-Italic-63\" transform=\"translate(450.859375 0.015625)\"/>\n+   </g>\n+  </g>\n+ </g>\n+</svg>\ndiff --git a/lib/matplotlib/tests/baseline_images/test_mathtext/mathtext_stix_83.pdf b/lib/matplotlib/tests/baseline_images/test_mathtext/mathtext_stix_83.pdf\nnew file mode 100644\nindex 000000000000..6679c1e8af13\nBinary files /dev/null and b/lib/matplotlib/tests/baseline_images/test_mathtext/mathtext_stix_83.pdf differ\ndiff --git a/lib/matplotlib/tests/baseline_images/test_mathtext/mathtext_stix_83.png b/lib/matplotlib/tests/baseline_images/test_mathtext/mathtext_stix_83.png\nnew file mode 100644\nindex 000000000000..d6f17be104fa\nBinary files /dev/null and b/lib/matplotlib/tests/baseline_images/test_mathtext/mathtext_stix_83.png differ\ndiff --git a/lib/matplotlib/tests/baseline_images/test_mathtext/mathtext_stix_83.svg b/lib/matplotlib/tests/baseline_images/test_mathtext/mathtext_stix_83.svg\nnew file mode 100644\nindex 000000000000..3268d5d3d26d\n--- /dev/null\n+++ b/lib/matplotlib/tests/baseline_images/test_mathtext/mathtext_stix_83.svg\n@@ -0,0 +1,159 @@\n+<?xml version=\"1.0\" encoding=\"utf-8\" standalone=\"no\"?>\n+<!DOCTYPE svg PUBLIC \"-//W3C//DTD SVG 1.1//EN\"\n+  \"http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd\">\n+<svg xmlns:xlink=\"http://www.w3.org/1999/xlink\" width=\"378pt\" height=\"54pt\" viewBox=\"0 0 378 54\" xmlns=\"http://www.w3.org/2000/svg\" version=\"1.1\">\n+ <metadata>\n+  <rdf:RDF xmlns:dc=\"http://purl.org/dc/elements/1.1/\" xmlns:cc=\"http://creativecommons.org/ns#\" xmlns:rdf=\"http://www.w3.org/1999/02/22-rdf-syntax-ns#\">\n+   <cc:Work>\n+    <dc:type rdf:resource=\"http://purl.org/dc/dcmitype/StillImage\"/>\n+    <dc:date>2024-05-08T19:52:30.625389</dc:date>\n+    <dc:format>image/svg+xml</dc:format>\n+    <dc:creator>\n+     <cc:Agent>\n+      <dc:title>Matplotlib v3.10.0.dev150+gec4808956b.d20240508, https://matplotlib.org/</dc:title>\n+     </cc:Agent>\n+    </dc:creator>\n+   </cc:Work>\n+  </rdf:RDF>\n+ </metadata>\n+ <defs>\n+  <style type=\"text/css\">*{stroke-linejoin: round; stroke-linecap: butt}</style>\n+ </defs>\n+ <g id=\"figure_1\">\n+  <g id=\"patch_1\">\n+   <path d=\"M 0 54 \n+L 378 54 \n+L 378 0 \n+L 0 0 \n+z\n+\" style=\"fill: #ffffff\"/>\n+  </g>\n+  <g id=\"text_1\">\n+   <!-- $a=-b-c$ -->\n+   <g transform=\"translate(164.52 30.31125) scale(0.12 -0.12)\">\n+    <defs>\n+     <path id=\"STIXGeneral-Italic-61\" d=\"M 2963 710 \n+L 3046 640 \n+Q 2688 205 2518 70 \n+Q 2349 -64 2157 -64 \n+Q 1901 -64 1901 198 \n+Q 1901 358 2048 934 \n+Q 1690 397 1389 163 \n+Q 1088 -70 749 -70 \n+Q 467 -70 288 125 \n+Q 109 320 109 672 \n+Q 109 1158 387 1664 \n+Q 666 2170 1094 2496 \n+Q 1523 2822 1939 2822 \n+Q 2368 2822 2451 2451 \n+L 2522 2758 \n+L 2541 2778 \n+L 2931 2822 \n+L 2976 2803 \n+Q 2970 2778 2938 2669 \n+Q 2368 595 2368 346 \n+Q 2368 262 2458 262 \n+Q 2554 262 2790 525 \n+L 2963 710 \n+z\n+M 2336 2310 \n+Q 2336 2477 2240 2579 \n+Q 2144 2682 1978 2682 \n+Q 1542 2682 1139 2093 \n+Q 928 1779 787 1395 \n+Q 646 1011 646 717 \n+Q 646 243 1030 243 \n+Q 1408 243 1843 870 \n+Q 2336 1581 2336 2310 \n+z\n+\" transform=\"scale(0.015625)\"/>\n+     <path id=\"STIXGeneral-Regular-3d\" d=\"M 4077 2048 \n+L 307 2048 \n+L 307 2470 \n+L 4077 2470 \n+L 4077 2048 \n+z\n+M 4077 768 \n+L 307 768 \n+L 307 1190 \n+L 4077 1190 \n+L 4077 768 \n+z\n+\" transform=\"scale(0.015625)\"/>\n+     <path id=\"STIXGeneral-Regular-2212\" d=\"M 3974 1408 \n+L 410 1408 \n+L 410 1830 \n+L 3974 1830 \n+L 3974 1408 \n+z\n+\" transform=\"scale(0.015625)\"/>\n+     <path id=\"STIXGeneral-Italic-62\" d=\"M 1043 1856 \n+L 1050 1856 \n+Q 1370 2387 1654 2604 \n+Q 1939 2822 2285 2822 \n+Q 2618 2822 2822 2617 \n+Q 3027 2413 3027 2054 \n+Q 3027 1562 2726 1062 \n+Q 2426 563 1942 246 \n+Q 1459 -70 979 -70 \n+Q 685 -70 416 32 \n+Q 147 134 147 269 \n+L 147 307 \n+L 1056 3654 \n+Q 1114 3885 1114 3955 \n+Q 1114 4058 1053 4080 \n+Q 992 4102 704 4115 \n+L 704 4224 \n+Q 1184 4282 1683 4371 \n+L 1715 4339 \n+L 1581 3814 \n+L 1043 1856 \n+z\n+M 2483 1958 \n+Q 2483 2509 2035 2509 \n+Q 1594 2509 1158 1773 \n+Q 954 1427 826 1008 \n+Q 698 589 698 294 \n+Q 698 77 992 77 \n+Q 1414 77 1779 454 \n+Q 2074 762 2278 1187 \n+Q 2483 1613 2483 1958 \n+z\n+\" transform=\"scale(0.015625)\"/>\n+     <path id=\"STIXGeneral-Italic-63\" d=\"M 2240 685 \n+L 2342 621 \n+Q 2048 250 1769 90 \n+Q 1491 -70 1133 -70 \n+Q 678 -70 435 179 \n+Q 192 429 192 915 \n+Q 192 1344 409 1744 \n+Q 627 2144 979 2432 \n+Q 1472 2822 2048 2822 \n+Q 2342 2822 2531 2675 \n+Q 2720 2528 2720 2304 \n+Q 2720 2176 2630 2086 \n+Q 2541 1997 2413 1997 \n+Q 2285 1997 2224 2070 \n+Q 2163 2144 2163 2253 \n+Q 2163 2310 2211 2403 \n+Q 2259 2496 2259 2560 \n+Q 2259 2688 2022 2688 \n+Q 1619 2688 1325 2381 \n+Q 742 1766 742 890 \n+Q 742 544 889 352 \n+Q 1037 160 1312 160 \n+Q 1562 160 1766 281 \n+Q 1971 403 2240 685 \n+z\n+\" transform=\"scale(0.015625)\"/>\n+    </defs>\n+    <use xlink:href=\"#STIXGeneral-Italic-61\" transform=\"translate(0 0.703125)\"/>\n+    <use xlink:href=\"#STIXGeneral-Regular-3d\" transform=\"translate(64.539987 0.703125)\"/>\n+    <use xlink:href=\"#STIXGeneral-Regular-2212\" transform=\"translate(147.479968 0.703125)\"/>\n+    <use xlink:href=\"#STIXGeneral-Italic-62\" transform=\"translate(215.979953 0.703125)\"/>\n+    <use xlink:href=\"#STIXGeneral-Regular-2212\" transform=\"translate(280.419934 0.703125)\"/>\n+    <use xlink:href=\"#STIXGeneral-Italic-63\" transform=\"translate(363.359915 0.703125)\"/>\n+   </g>\n+  </g>\n+ </g>\n+</svg>\ndiff --git a/lib/matplotlib/tests/baseline_images/test_mathtext/mathtext_stixsans_83.pdf b/lib/matplotlib/tests/baseline_images/test_mathtext/mathtext_stixsans_83.pdf\nnew file mode 100644\nindex 000000000000..22e75bb9b0a3\nBinary files /dev/null and b/lib/matplotlib/tests/baseline_images/test_mathtext/mathtext_stixsans_83.pdf differ\ndiff --git a/lib/matplotlib/tests/baseline_images/test_mathtext/mathtext_stixsans_83.png b/lib/matplotlib/tests/baseline_images/test_mathtext/mathtext_stixsans_83.png\nnew file mode 100644\nindex 000000000000..c23070cdf8b9\nBinary files /dev/null and b/lib/matplotlib/tests/baseline_images/test_mathtext/mathtext_stixsans_83.png differ\ndiff --git a/lib/matplotlib/tests/baseline_images/test_mathtext/mathtext_stixsans_83.svg b/lib/matplotlib/tests/baseline_images/test_mathtext/mathtext_stixsans_83.svg\nnew file mode 100644\nindex 000000000000..97c40174b3ef\n--- /dev/null\n+++ b/lib/matplotlib/tests/baseline_images/test_mathtext/mathtext_stixsans_83.svg\n@@ -0,0 +1,136 @@\n+<?xml version=\"1.0\" encoding=\"utf-8\" standalone=\"no\"?>\n+<!DOCTYPE svg PUBLIC \"-//W3C//DTD SVG 1.1//EN\"\n+  \"http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd\">\n+<svg xmlns:xlink=\"http://www.w3.org/1999/xlink\" width=\"378pt\" height=\"54pt\" viewBox=\"0 0 378 54\" xmlns=\"http://www.w3.org/2000/svg\" version=\"1.1\">\n+ <metadata>\n+  <rdf:RDF xmlns:dc=\"http://purl.org/dc/elements/1.1/\" xmlns:cc=\"http://creativecommons.org/ns#\" xmlns:rdf=\"http://www.w3.org/1999/02/22-rdf-syntax-ns#\">\n+   <cc:Work>\n+    <dc:type rdf:resource=\"http://purl.org/dc/dcmitype/StillImage\"/>\n+    <dc:date>2024-05-08T19:52:33.020611</dc:date>\n+    <dc:format>image/svg+xml</dc:format>\n+    <dc:creator>\n+     <cc:Agent>\n+      <dc:title>Matplotlib v3.10.0.dev150+gec4808956b.d20240508, https://matplotlib.org/</dc:title>\n+     </cc:Agent>\n+    </dc:creator>\n+   </cc:Work>\n+  </rdf:RDF>\n+ </metadata>\n+ <defs>\n+  <style type=\"text/css\">*{stroke-linejoin: round; stroke-linecap: butt}</style>\n+ </defs>\n+ <g id=\"figure_1\">\n+  <g id=\"patch_1\">\n+   <path d=\"M 0 54 \n+L 378 54 \n+L 378 0 \n+L 0 0 \n+z\n+\" style=\"fill: #ffffff\"/>\n+  </g>\n+  <g id=\"text_1\">\n+   <!-- $a=-b-c$ -->\n+   <g transform=\"translate(164.64 30.31125) scale(0.12 -0.12)\">\n+    <defs>\n+     <path id=\"STIXGeneral-Italic-1d622\" d=\"M 1082 1933 \n+L 819 2131 \n+Q 1011 2566 1366 2764 \n+Q 1722 2963 2138 2963 \n+Q 2541 2963 2765 2793 \n+Q 2989 2624 2989 2317 \n+Q 2989 2227 2957 2086 \n+L 2554 486 \n+Q 2502 301 2502 0 \n+L 1958 0 \n+L 1990 282 \n+Q 1530 -64 954 -64 \n+Q 672 -64 512 61 \n+Q 352 186 352 422 \n+Q 352 1498 2400 1882 \n+L 2451 2093 \n+Q 2464 2157 2464 2189 \n+Q 2464 2336 2339 2422 \n+Q 2214 2509 2010 2509 \n+Q 1523 2509 1178 1933 \n+L 1082 1933 \n+z\n+M 2138 845 \n+L 2285 1421 \n+Q 890 1197 890 614 \n+Q 890 390 1197 390 \n+Q 1632 390 2138 845 \n+z\n+\" transform=\"scale(0.015625)\"/>\n+     <path id=\"STIXGeneral-Regular-3d\" d=\"M 4077 2048 \n+L 307 2048 \n+L 307 2470 \n+L 4077 2470 \n+L 4077 2048 \n+z\n+M 4077 768 \n+L 307 768 \n+L 307 1190 \n+L 4077 1190 \n+L 4077 768 \n+z\n+\" transform=\"scale(0.015625)\"/>\n+     <path id=\"STIXGeneral-Regular-2212\" d=\"M 3974 1408 \n+L 410 1408 \n+L 410 1830 \n+L 3974 1830 \n+L 3974 1408 \n+z\n+\" transform=\"scale(0.015625)\"/>\n+     <path id=\"STIXGeneral-Italic-1d623\" d=\"M 1990 4346 \n+L 1568 2650 \n+Q 1997 2963 2464 2963 \n+Q 2912 2963 3168 2704 \n+Q 3424 2445 3424 2003 \n+Q 3424 1165 2816 550 \n+Q 2208 -64 1440 -64 \n+Q 781 -64 474 301 \n+L 1453 4224 \n+L 1939 4378 \n+L 1990 4346 \n+z\n+M 1389 1933 \n+L 1056 602 \n+Q 1254 390 1587 390 \n+Q 2048 390 2470 793 \n+Q 2893 1197 2893 1843 \n+Q 2893 2150 2729 2329 \n+Q 2566 2509 2253 2509 \n+Q 2022 2509 1788 2358 \n+Q 1555 2208 1389 1933 \n+z\n+\" transform=\"scale(0.015625)\"/>\n+     <path id=\"STIXGeneral-Italic-1d624\" d=\"M 3219 2374 \n+L 2854 2029 \n+L 2752 2029 \n+Q 2662 2509 2144 2509 \n+Q 1734 2509 1347 2118 \n+Q 960 1728 960 1082 \n+Q 960 755 1142 572 \n+Q 1325 390 1619 390 \n+Q 2138 390 2611 1062 \n+L 2970 845 \n+Q 2355 -64 1466 -64 \n+Q 992 -64 710 205 \n+Q 429 474 429 960 \n+Q 429 1792 1017 2377 \n+Q 1606 2963 2285 2963 \n+Q 2637 2963 2889 2816 \n+Q 3142 2669 3219 2374 \n+z\n+\" transform=\"scale(0.015625)\"/>\n+    </defs>\n+    <use xlink:href=\"#STIXGeneral-Italic-1d622\" transform=\"translate(0 0.59375)\"/>\n+    <use xlink:href=\"#STIXGeneral-Regular-3d\" transform=\"translate(59.919986 0.59375)\"/>\n+    <use xlink:href=\"#STIXGeneral-Regular-2212\" transform=\"translate(143.539969 0.59375)\"/>\n+    <use xlink:href=\"#STIXGeneral-Italic-1d623\" transform=\"translate(212.039954 0.59375)\"/>\n+    <use xlink:href=\"#STIXGeneral-Regular-2212\" transform=\"translate(276.759943 0.59375)\"/>\n+    <use xlink:href=\"#STIXGeneral-Italic-1d624\" transform=\"translate(360.379926 0.59375)\"/>\n+   </g>\n+  </g>\n+ </g>\n+</svg>\ndiff --git a/lib/matplotlib/tests/test_mathtext.py b/lib/matplotlib/tests/test_mathtext.py\nindex e3659245d0e7..6ce327f38341 100644\n--- a/lib/matplotlib/tests/test_mathtext.py\n+++ b/lib/matplotlib/tests/test_mathtext.py\n@@ -124,6 +124,7 @@\n     r'$,$ $.$ $1{,}234{, }567{ , }890$ and $1,234,567,890$',  # github issue 5799\n     r'$\\left(X\\right)_{a}^{b}$',  # github issue 7615\n     r'$\\dfrac{\\$100.00}{y}$',  # github issue #1888\n+    r'$a=-b-c$'  # github issue #28180\n ]\n # 'svgastext' tests switch svg output to embed text as text (rather than as\n # paths).\n", "problem_statement": "[Bug]: mathtext should distinguish between unary and binary minus\n### Bug summary\n\nTeX inserts a (thin?) space after a binary minus, but not before a unary minus.  Typographically, I believe this does look nicer.\r\nmathtext does not distinguish the two cases and always puts in a thin space.  It would be nice if it followed tex's behavior.\n\n### Code for reproduction\n\n```Python\nfrom pylab import *\r\nfigtext(.2, .6, \"$a=-b-c$\")\r\nfigtext(.2, .5, \"$a=-b-c$\", usetex=True)\n```\n\n\n### Actual outcome\n\n![Figure_1](https://github.com/matplotlib/matplotlib/assets/1322974/a42a6019-eea7-4bc3-9397-fb2cafe4dc2c)\r\nCompare the spacing before the \"b\" and the \"c\": they are different with usetex, but not with mathtext.\n\n### Expected outcome\n\nRemove the space in mathtext before the unary minus.\n\n### Additional information\n\nProbably involves reading the TeXbook to figure out what is TeX's logic for distinguishing unary and binary minus.\r\nTagging as good first issue *solely* because there should be no API design at all, but medium (-hard) difficulty because that'll require both reading the TeXbook and learning about mathtext's implementation.  However I would guess there's no \"strong\" technical blockers either.\n\n### Operating system\n\nany\n\n### Matplotlib Version\n\n3.10.0.dev137+g9387431ab6\n\n### Matplotlib Backend\n\nqtagg\n\n### Python version\n\n3.12\n\n### Jupyter version\n\nno\n\n### Installation\n\ngit checkout\n", "hints_text": "### Good first issue - notes for new contributors\n\nThis issue is suited to new contributors because it does not require understanding of the\nMatplotlib internals. To get started, please see our [contributing\nguide](https://matplotlib.org/stable/devel/index).\n\n**We do not assign issues**. Check the *Development* section in the sidebar for linked pull\nrequests (PRs). If there are none, feel free to start working on it. If there is an open PR, please\ncollaborate on the work by reviewing it rather than duplicating it in a competing PR.\n\nIf something is unclear, please reach out on any of our [communication\nchannels](https://matplotlib.org/stable/devel/contributing.html#get-connected).\nI did some preliminary research and it seems TeX actually does not distinguish between the unary and binary minus symbol. Maybe I was reading an outdated version of the TeXbook, but I cannot find any mention of unary operators. I will keep looking to find out what logic TeX is using to change the spacing for unary operators.\nAnother example where I think the difference is clear:\r\n![Figure_1](https://github.com/matplotlib/matplotlib/assets/1322974/4fafabc6-0475-4cbd-808a-584b2a8c6a69)\r\n\nI have found the issue, the code contains logic to do different spacing for unary minus if the unary minus happens directly after a parenthesis or if the minus is the first character in the equation, but the code does not contain logic to create a unary minus after an equals sign. It is an easy fix, but I am still working on setting up a testing environment to verify my fix.", "created_at": "2024-05-08T20:33:52Z"}
{"repo": "matplotlib/matplotlib", "pull_number": 28177, "instance_id": "matplotlib__matplotlib-28177", "issue_numbers": ["28170", "0000"], "base_commit": "0fd212d11cf87a200eb2cfd5b0357d05fc7b3f32", "patch": "diff --git a/doc/api/next_api_changes/behavior/28177-REC.rst b/doc/api/next_api_changes/behavior/28177-REC.rst\nnew file mode 100644\nindex 000000000000..d7ea8ec0e947\n--- /dev/null\n+++ b/doc/api/next_api_changes/behavior/28177-REC.rst\n@@ -0,0 +1,7 @@\n+(Sub)Figure.get_figure\n+~~~~~~~~~~~~~~~~~~~~~~\n+\n+...in future will by default return the direct parent figure, which may be a SubFigure.\n+This will make the default behavior consistent with the\n+`~matplotlib.artist.Artist.get_figure` method of other artists.  To control the\n+behavior, use the newly introduced *root* parameter.\ndiff --git a/doc/api/next_api_changes/deprecations/28177-REC.rst b/doc/api/next_api_changes/deprecations/28177-REC.rst\nnew file mode 100644\nindex 000000000000..a3e630630aeb\n--- /dev/null\n+++ b/doc/api/next_api_changes/deprecations/28177-REC.rst\n@@ -0,0 +1,5 @@\n+(Sub)Figure.set_figure\n+~~~~~~~~~~~~~~~~~~~~~~\n+\n+...is deprecated and in future will always raise an exception.  The parent and\n+root figures of a (Sub)Figure are set at instantiation and cannot be changed.\ndiff --git a/lib/matplotlib/artist.py b/lib/matplotlib/artist.py\nindex d5b8631e95df..baf3b01ee6e5 100644\n--- a/lib/matplotlib/artist.py\n+++ b/lib/matplotlib/artist.py\n@@ -181,7 +181,7 @@ def __init__(self):\n         self._stale = True\n         self.stale_callback = None\n         self._axes = None\n-        self.figure = None\n+        self._parent_figure = None\n \n         self._transform = None\n         self._transformSet = False\n@@ -251,7 +251,7 @@ def remove(self):\n             if self.figure:\n                 if not _ax_flag:\n                     self.figure.stale = True\n-                self.figure = None\n+                self._parent_figure = None\n \n         else:\n             raise NotImplementedError('cannot remove artist')\n@@ -720,34 +720,49 @@ def set_path_effects(self, path_effects):\n     def get_path_effects(self):\n         return self._path_effects\n \n-    def get_figure(self):\n-        \"\"\"Return the `.Figure` instance the artist belongs to.\"\"\"\n-        return self.figure\n+    def get_figure(self, root=False):\n+        \"\"\"\n+        Return the `.Figure` or `.SubFigure` instance the artist belongs to.\n+\n+        Parameters\n+        ----------\n+        root : bool, default=False\n+            If False, return the (Sub)Figure this artist is on.  If True,\n+            return the root Figure for a nested tree of SubFigures.\n+        \"\"\"\n+        if root and self._parent_figure is not None:\n+            return self._parent_figure.get_figure(root=True)\n+\n+        return self._parent_figure\n \n     def set_figure(self, fig):\n         \"\"\"\n-        Set the `.Figure` instance the artist belongs to.\n+        Set the `.Figure` or `.SubFigure` instance the artist belongs to.\n \n         Parameters\n         ----------\n-        fig : `~matplotlib.figure.Figure`\n+        fig : `~matplotlib.figure.Figure` or `~matplotlib.figure.SubFigure`\n         \"\"\"\n         # if this is a no-op just return\n-        if self.figure is fig:\n+        if self._parent_figure is fig:\n             return\n         # if we currently have a figure (the case of both `self.figure`\n         # and *fig* being none is taken care of above) we then user is\n         # trying to change the figure an artist is associated with which\n         # is not allowed for the same reason as adding the same instance\n         # to more than one Axes\n-        if self.figure is not None:\n+        if self._parent_figure is not None:\n             raise RuntimeError(\"Can not put single artist in \"\n                                \"more than one figure\")\n-        self.figure = fig\n-        if self.figure and self.figure is not self:\n+        self._parent_figure = fig\n+        if self._parent_figure and self._parent_figure is not self:\n             self.pchanged()\n         self.stale = True\n \n+    figure = property(get_figure, set_figure,\n+                      doc=(\"The (Sub)Figure that the artist is on.  For more \"\n+                           \"control, use the `get_figure` method.\"))\n+\n     def set_clip_box(self, clipbox):\n         \"\"\"\n         Set the artist's clip `.Bbox`.\ndiff --git a/lib/matplotlib/artist.pyi b/lib/matplotlib/artist.pyi\nindex 50f41b7f70e5..3059600e488c 100644\n--- a/lib/matplotlib/artist.pyi\n+++ b/lib/matplotlib/artist.pyi\n@@ -31,7 +31,8 @@ class _Unset: ...\n class Artist:\n     zorder: float\n     stale_callback: Callable[[Artist, bool], None] | None\n-    figure: Figure | SubFigure | None\n+    @property\n+    def figure(self) -> Figure | SubFigure: ...\n     clipbox: BboxBase | None\n     def __init__(self) -> None: ...\n     def remove(self) -> None: ...\n@@ -87,8 +88,8 @@ class Artist:\n     ) -> None: ...\n     def set_path_effects(self, path_effects: list[AbstractPathEffect]) -> None: ...\n     def get_path_effects(self) -> list[AbstractPathEffect]: ...\n-    def get_figure(self) -> Figure | None: ...\n-    def set_figure(self, fig: Figure) -> None: ...\n+    def get_figure(self, root: bool = ...) -> Figure | SubFigure | None: ...\n+    def set_figure(self, fig: Figure | SubFigure) -> None: ...\n     def set_clip_box(self, clipbox: BboxBase | None) -> None: ...\n     def set_clip_path(\n         self,\ndiff --git a/lib/matplotlib/axes/_base.py b/lib/matplotlib/axes/_base.py\nindex 18ff80a51e5a..4606e5c01aec 100644\n--- a/lib/matplotlib/axes/_base.py\n+++ b/lib/matplotlib/axes/_base.py\n@@ -1296,7 +1296,7 @@ def __clear(self):\n         self._gridOn = mpl.rcParams['axes.grid']\n         old_children, self._children = self._children, []\n         for chld in old_children:\n-            chld.axes = chld.figure = None\n+            chld.axes = chld._parent_figure = None\n         self._mouseover_set = _OrderedSet()\n         self.child_axes = []\n         self._current_image = None  # strictly for pyplot via _sci, _gci\ndiff --git a/lib/matplotlib/axes/_base.pyi b/lib/matplotlib/axes/_base.pyi\nindex 751dcd248a5c..1fdc0750f0bc 100644\n--- a/lib/matplotlib/axes/_base.pyi\n+++ b/lib/matplotlib/axes/_base.pyi\n@@ -13,7 +13,7 @@ from matplotlib.cm import ScalarMappable\n from matplotlib.legend import Legend\n from matplotlib.lines import Line2D\n from matplotlib.gridspec import SubplotSpec, GridSpec\n-from matplotlib.figure import Figure\n+from matplotlib.figure import Figure, SubFigure\n from matplotlib.image import AxesImage\n from matplotlib.patches import Patch\n from matplotlib.scale import ScaleBase\n@@ -81,7 +81,7 @@ class _AxesBase(martist.Artist):\n     def get_subplotspec(self) -> SubplotSpec | None: ...\n     def set_subplotspec(self, subplotspec: SubplotSpec) -> None: ...\n     def get_gridspec(self) -> GridSpec | None: ...\n-    def set_figure(self, fig: Figure) -> None: ...\n+    def set_figure(self, fig: Figure | SubFigure) -> None: ...\n     @property\n     def viewLim(self) -> Bbox: ...\n     def get_xaxis_transform(\ndiff --git a/lib/matplotlib/figure.py b/lib/matplotlib/figure.py\nindex 1d522f8defa2..51bac3455a28 100644\n--- a/lib/matplotlib/figure.py\n+++ b/lib/matplotlib/figure.py\n@@ -30,6 +30,7 @@\n from contextlib import ExitStack\n import inspect\n import itertools\n+import functools\n import logging\n from numbers import Integral\n import threading\n@@ -227,6 +228,67 @@ def get_children(self):\n                 *self.legends,\n                 *self.subfigs]\n \n+    def get_figure(self, root=None):\n+        \"\"\"\n+        Return the `.Figure` or `.SubFigure` instance the (Sub)Figure belongs to.\n+\n+        Parameters\n+        ----------\n+        root : bool, default=True\n+            If False, return the (Sub)Figure this artist is on.  If True,\n+            return the root Figure for a nested tree of SubFigures.\n+\n+            .. deprecated:: 3.10\n+\n+                From version 3.12 *root* will default to False.\n+        \"\"\"\n+        if self._root_figure is self:\n+            # Top level Figure\n+            return self\n+\n+        if self._parent is self._root_figure:\n+            # Return early to prevent the deprecation warning when *root* does not\n+            # matter\n+            return self._parent\n+\n+        if root is None:\n+            # When deprecation expires, consider removing the docstring and just\n+            # inheriting the one from Artist.\n+            message = ('From Matplotlib 3.12 SubFigure.get_figure will by default '\n+                       'return the direct parent figure, which may be a SubFigure. '\n+                       'To suppress this warning, pass the root parameter.  Pass '\n+                       '`True` to maintain the old behavior and `False` to opt-in to '\n+                       'the future behavior.')\n+            _api.warn_deprecated('3.10', message=message)\n+            root = True\n+\n+        if root:\n+            return self._root_figure\n+\n+        return self._parent\n+\n+    def set_figure(self, fig):\n+        \"\"\"\n+        .. deprecated:: 3.10\n+            Currently this method will raise an exception if *fig* is anything other\n+            than the root `.Figure` this (Sub)Figure is on.  In future it will always\n+            raise an exception.\n+        \"\"\"\n+        no_switch = (\"The parent and root figures of a (Sub)Figure are set at \"\n+                     \"instantiation and cannot be changed.\")\n+        if fig is self._root_figure:\n+            _api.warn_deprecated(\n+                \"3.10\",\n+                message=(f\"{no_switch} From Matplotlib 3.12 this operation will raise \"\n+                         \"an exception.\"))\n+            return\n+\n+        raise ValueError(no_switch)\n+\n+    figure = property(functools.partial(get_figure, root=True), set_figure,\n+                      doc=(\"The root `Figure`.  To get the parent of a `SubFigure`, \"\n+                           \"use the `get_figure` method.\"))\n+\n     def contains(self, mouseevent):\n         \"\"\"\n         Test whether the mouse event occurred on the figure.\n@@ -2222,7 +2284,7 @@ def __init__(self, parent, subplotspec, *,\n \n         self._subplotspec = subplotspec\n         self._parent = parent\n-        self.figure = parent.figure\n+        self._root_figure = parent._root_figure\n \n         # subfigures use the parent axstack\n         self._axstack = parent._axstack\n@@ -2503,7 +2565,7 @@ def __init__(self,\n             %(Figure:kwdoc)s\n         \"\"\"\n         super().__init__(**kwargs)\n-        self.figure = self\n+        self._root_figure = self\n         self._layout_engine = None\n \n         if layout is not None:\ndiff --git a/lib/matplotlib/figure.pyi b/lib/matplotlib/figure.pyi\nindex b079312695c1..711f5b77783e 100644\n--- a/lib/matplotlib/figure.pyi\n+++ b/lib/matplotlib/figure.pyi\n@@ -260,7 +260,8 @@ class FigureBase(Artist):\n     ) -> dict[Hashable, Axes]: ...\n \n class SubFigure(FigureBase):\n-    figure: Figure\n+    @property\n+    def figure(self) -> Figure: ...\n     subplotpars: SubplotParams\n     dpi_scale_trans: Affine2D\n     transFigure: Transform\n@@ -298,7 +299,8 @@ class SubFigure(FigureBase):\n     def get_axes(self) -> list[Axes]: ...\n \n class Figure(FigureBase):\n-    figure: Figure\n+    @property\n+    def figure(self) -> Figure: ...\n     bbox_inches: Bbox\n     dpi_scale_trans: Affine2D\n     bbox: BboxBase\ndiff --git a/lib/matplotlib/offsetbox.pyi b/lib/matplotlib/offsetbox.pyi\nindex c222a9b2973e..05e23df4529d 100644\n--- a/lib/matplotlib/offsetbox.pyi\n+++ b/lib/matplotlib/offsetbox.pyi\n@@ -2,7 +2,7 @@ import matplotlib.artist as martist\n from matplotlib.backend_bases import RendererBase, Event, FigureCanvasBase\n from matplotlib.colors import Colormap, Normalize\n import matplotlib.text as mtext\n-from matplotlib.figure import Figure\n+from matplotlib.figure import Figure, SubFigure\n from matplotlib.font_manager import FontProperties\n from matplotlib.image import BboxImage\n from matplotlib.patches import FancyArrowPatch, FancyBboxPatch\n@@ -26,7 +26,7 @@ class OffsetBox(martist.Artist):\n     width: float | None\n     height: float | None\n     def __init__(self, *args, **kwargs) -> None: ...\n-    def set_figure(self, fig: Figure) -> None: ...\n+    def set_figure(self, fig: Figure | SubFigure) -> None: ...\n     def set_offset(\n         self,\n         xy: tuple[float, float]\n@@ -271,7 +271,7 @@ class AnnotationBbox(martist.Artist, mtext._AnnotationBase):\n         | Callable[[RendererBase], Bbox | Transform],\n     ) -> None: ...\n     def get_children(self) -> list[martist.Artist]: ...\n-    def set_figure(self, fig: Figure) -> None: ...\n+    def set_figure(self, fig: Figure | SubFigure) -> None: ...\n     def set_fontsize(self, s: str | float | None = ...) -> None: ...\n     def get_fontsize(self) -> float: ...\n     def get_tightbbox(self, renderer: RendererBase | None = ...) -> Bbox: ...\ndiff --git a/lib/matplotlib/quiver.pyi b/lib/matplotlib/quiver.pyi\nindex 2a043a92b4b5..164f0ab3a77a 100644\n--- a/lib/matplotlib/quiver.pyi\n+++ b/lib/matplotlib/quiver.pyi\n@@ -1,7 +1,7 @@\n import matplotlib.artist as martist\n import matplotlib.collections as mcollections\n from matplotlib.axes import Axes\n-from matplotlib.figure import Figure\n+from matplotlib.figure import Figure, SubFigure\n from matplotlib.text import Text\n from matplotlib.transforms import Transform, Bbox\n \n@@ -49,7 +49,7 @@ class QuiverKey(martist.Artist):\n     ) -> None: ...\n     @property\n     def labelsep(self) -> float: ...\n-    def set_figure(self, fig: Figure) -> None: ...\n+    def set_figure(self, fig: Figure | SubFigure) -> None: ...\n \n class Quiver(mcollections.PolyCollection):\n     X: ArrayLike\n", "test_patch": "diff --git a/ci/mypy-stubtest-allowlist.txt b/ci/mypy-stubtest-allowlist.txt\nindex 73dfb1d8ceb0..d6a0f373048d 100644\n--- a/ci/mypy-stubtest-allowlist.txt\n+++ b/ci/mypy-stubtest-allowlist.txt\n@@ -46,3 +46,6 @@ matplotlib.tri.*TriInterpolator.gradient\n matplotlib.backend_bases.FigureCanvasBase._T\n matplotlib.backend_managers.ToolManager._T\n matplotlib.spines.Spine._T\n+\n+# Parameter inconsistency due to 3.10 deprecation\n+matplotlib.figure.FigureBase.get_figure\ndiff --git a/lib/matplotlib/tests/test_artist.py b/lib/matplotlib/tests/test_artist.py\nindex dbb5dd2305e0..edba2c179781 100644\n--- a/lib/matplotlib/tests/test_artist.py\n+++ b/lib/matplotlib/tests/test_artist.py\n@@ -562,3 +562,37 @@ def draw(self, renderer, extra):\n \n     assert 'aardvark' == art.draw(renderer, 'aardvark')\n     assert 'aardvark' == art.draw(renderer, extra='aardvark')\n+\n+\n+def test_get_figure():\n+    fig = plt.figure()\n+    sfig1 = fig.subfigures()\n+    sfig2 = sfig1.subfigures()\n+    ax = sfig2.subplots()\n+\n+    assert fig.get_figure(root=True) is fig\n+    assert fig.get_figure(root=False) is fig\n+\n+    assert ax.get_figure() is sfig2\n+    assert ax.get_figure(root=False) is sfig2\n+    assert ax.get_figure(root=True) is fig\n+\n+    # SubFigure.get_figure has separate implementation but should give consistent\n+    # results to other artists.\n+    assert sfig2.get_figure(root=False) is sfig1\n+    assert sfig2.get_figure(root=True) is fig\n+    # Currently different results by default.\n+    with pytest.warns(mpl.MatplotlibDeprecationWarning):\n+        assert sfig2.get_figure() is fig\n+    # No deprecation warning if root and parent figure are the same.\n+    assert sfig1.get_figure() is fig\n+\n+    # An artist not yet attached to anything has no figure.\n+    ln = mlines.Line2D([], [])\n+    assert ln.get_figure(root=True) is None\n+    assert ln.get_figure(root=False) is None\n+\n+    # figure attribute is root for (Sub)Figures but parent for other artists.\n+    assert ax.figure is sfig2\n+    assert fig.figure is fig\n+    assert sfig2.figure is fig\ndiff --git a/lib/matplotlib/tests/test_figure.py b/lib/matplotlib/tests/test_figure.py\nindex 5a8894b10496..4e73d4091200 100644\n--- a/lib/matplotlib/tests/test_figure.py\n+++ b/lib/matplotlib/tests/test_figure.py\n@@ -1735,6 +1735,22 @@ def test_warn_colorbar_mismatch():\n         subfig3_1.colorbar(im4_1)\n \n \n+def test_set_figure():\n+    fig = plt.figure()\n+    sfig1 = fig.subfigures()\n+    sfig2 = sfig1.subfigures()\n+\n+    for f in fig, sfig1, sfig2:\n+        with pytest.warns(mpl.MatplotlibDeprecationWarning):\n+            f.set_figure(fig)\n+\n+    with pytest.raises(ValueError, match=\"cannot be changed\"):\n+        sfig2.set_figure(sfig1)\n+\n+    with pytest.raises(ValueError, match=\"cannot be changed\"):\n+        sfig1.set_figure(plt.figure())\n+\n+\n def test_subfigure_row_order():\n     # Test that subfigures are drawn in row-major order.\n     fig = plt.figure()\n", "problem_statement": "[Doc]: `get_figure` may return a `SubFigure`\n### Documentation Link\n\nhttps://matplotlib.org/devdocs/api/_as_gen/matplotlib.artist.Artist.get_figure.html#matplotlib.artist.Artist.get_figure\n\n### Problem\n\nI'm not sure whether this is a documentation issue or a bug.  The docstring for `get_figure` states that it returns a `Figure`, which I think implies the parent figure.  If our artist is on a subfigure, it will return that.  Note that `SubFigure` does not inherit from `Figure`.\r\n\r\n```python\r\nIn [1]: import matplotlib.pyplot as plt\r\n\r\nIn [2]: fig = plt.figure()\r\n\r\nIn [3]: sfig = fig.subfigures()\r\n\r\nIn [4]: ax = sfig.subplots()\r\n\r\nIn [5]: ax.get_figure()\r\nOut[5]: <matplotlib.figure.SubFigure at 0x7dc0ddf4a870>\r\n```\n\n### Suggested improvement\n\nEither\r\n* modify the docstring to clarify you might get the `SubFigure` (and point to how you can get the parent `Figure` if you want it)\r\nor\r\n* fix the method so it returns the parent `Figure`\n", "hints_text": "`SubFigure.get_figure` does return a `Figure`, even if the subfigures are nested.\r\n\r\n```python\r\nIn [6]: sfig2 = sfig.subfigures()\r\n\r\nIn [7]: sfig2.get_figure()\r\nOut[7]: <Figure size 640x480 with 1 Axes>\r\n```\nThis seems inconsistent and likely we haven't thought about it when subfigures were introduced.\r\n\r\nIntuitively, I'd recommend the following behavior: `get_figure()` returns the closest (sub)figure. If we were to go all the way up, it's not possible to get to the next level only.\r\n\r\nThat would imply:\r\n- Change documentation/typing of `Artist.get_figure`\r\n- Change behavior of  `Subfigure.get_figure` to return the containing (sub)figure. - Note that `get_figure` only returns `self.figure`, so `self.figure` should be changed for nested subfigures. I consider it a bug that this is not the containing subfigure. @jklymak do you agree?\r\n\r\n\nHmm that seems inconsistent at least so one way or another is a bug\n\nIt seems that a subfigure wants to know its parent rather than its root? \n\nOoops sorry crosspost w above. I'd have to look at the code a bit. \n> This seems inconsistent and likely we haven't thought about it when subfigures were introduced.\r\n> \r\n> Intuitively, I'd recommend the following behavior: `get_figure()` returns the closest (sub)figure. If we were to go all the way up, it's not possible to get to the next level only.\r\n> \r\n> That would imply:\r\n> \r\n> * Change documentation/typing of `Artist.get_figure`\r\n> * Change behavior of  `Subfigure.get_figure` to return the containing (sub)figure. - Note that `get_figure` only returns `self.figure`, so `self.figure` should be changed for nested subfigures. I consider it a bug that this is not the containing subfigure. @jklymak do you agree?\r\n\r\nHmmm, I fear it's not so simple.  I explicitly set `self.figure =  parent.figure` which therefore resolves to the root figure, and I think that is because artists have things like `self.figure.stale` and `self.figure.suppressComposite` which would somehow have to magically thread themselves through.\r\n\r\nSo I wonder if the correct course of action is to override `get_figure` to return the parent figure, but keep `self.figure` as-is.  In hindsight, it should have been private, I think?\n> So I wonder if the correct course of action is to override `get_figure` to return the parent figure, but keep `self.figure` as-is. In hindsight, it should have been private, I think?\r\n\r\nIt's bad enough that we have a mixture of attributes and getters, having both with slightly different semantics is even worse. I propse to\r\n\r\n- expand `get_figure()` with a parmeter to select between the direct parent and the top-level figure, choosing the appropriate default. - The default should become the same for artists and subfigures, which means an API change for one of them.\r\n- create whatever internal state is necessary to support the behavior (likely `self._parent_figure`)\r\n- keep `self.figure` with the current semantics, but discourate (deprecate?) it's use in favor of `get_figure()` - if needed turn it into a property.\nThe above seems good to me.  \r\nSomething like:\r\n```\r\nget_figure(root=False)\r\n\r\nroot : bool\r\n    If False return the (Sub)Figure this artist is on.  If True, return the root Figure if there is a nested tree of SubFigures.\r\n```\nAh, this also make sense as to why the `subfigure_mosaic` has problems with getting the nesting right.\r\n\r\nStrongly agree we need a version that gets the parent rather than the root.", "created_at": "2024-05-06T16:36:28Z"}
{"repo": "matplotlib/matplotlib", "pull_number": 28116, "instance_id": "matplotlib__matplotlib-28116", "issue_numbers": ["28114"], "base_commit": "199c31fa64f46d2b3dff59b0921eb0472f72570b", "patch": "diff --git a/lib/matplotlib/cm.py b/lib/matplotlib/cm.py\nindex c14973560ac3..cec9f0be4355 100644\n--- a/lib/matplotlib/cm.py\n+++ b/lib/matplotlib/cm.py\n@@ -44,10 +44,17 @@ def _gen_cmap_registry():\n             colors.LinearSegmentedColormap.from_list(name, spec, _LUTSIZE))\n \n     # Register colormap aliases for gray and grey.\n-    cmap_d['grey'] = cmap_d['gray']\n-    cmap_d['gist_grey'] = cmap_d['gist_gray']\n-    cmap_d['gist_yerg'] = cmap_d['gist_yarg']\n-    cmap_d['Grays'] = cmap_d['Greys']\n+    aliases = {\n+        # alias -> original name\n+        'grey': 'gray',\n+        'gist_grey': 'gist_gray',\n+        'gist_yerg': 'gist_yarg',\n+        'Grays': 'Greys',\n+    }\n+    for alias, original_name in aliases.items():\n+        cmap = cmap_d[original_name].copy()\n+        cmap.name = alias\n+        cmap_d[alias] = cmap\n \n     # Generate reversed cmaps.\n     for cmap in list(cmap_d.values()):\n", "test_patch": "diff --git a/lib/matplotlib/tests/test_colors.py b/lib/matplotlib/tests/test_colors.py\nindex 63f2d4f00399..c8b44b2dea14 100644\n--- a/lib/matplotlib/tests/test_colors.py\n+++ b/lib/matplotlib/tests/test_colors.py\n@@ -1689,6 +1689,11 @@ def test_set_cmap_mismatched_name():\n     assert cmap_returned.name == \"wrong-cmap\"\n \n \n+def test_cmap_alias_names():\n+    assert matplotlib.colormaps[\"gray\"].name == \"gray\"  # original\n+    assert matplotlib.colormaps[\"grey\"].name == \"grey\"  # alias\n+\n+\n def test_to_rgba_array_none_color_with_alpha_param():\n     # effective alpha for color \"none\" must always be 0 to achieve a vanishing color\n     # even explicit alpha must be ignored\n", "problem_statement": "[Bug]: mpl.colormaps[ \"Grays\" ].name is \"Greys\", not \"Grays\"\n### Bug summary\n\nA minor bug, with a simple fix: `mpl.colormaps[ \"Grays\" ].name`  is \"Greys\", not \"Greys\"\n\n### Code for reproduction\n\n```Python\nprint( f'{mpl.colormaps[ \"Grays\" ].name = }' )  # Greys\n```\n\n\n### Actual outcome\n\nmpl.colormaps[ \"Grays\" ].name = 'Greys'\n\n### Expected outcome\n\nmpl.colormaps[ \"Grays\" ].name = 'Grays'\n\n### Additional information\n\nA suggested fix: in [cm.py](https://github.com/matplotlib/matplotlib/blob/main/lib/matplotlib/cm.py), after lines 47 - 50\r\n```\r\n# Register colormap aliases for gray and grey.\r\ncmap_d['grey'] = cmap_d['gray']\r\ncmap_d['gist_grey'] = cmap_d['gist_gray']\r\ncmap_d['gist_yerg'] = cmap_d['gist_yarg']\r\ncmap_d['Grays'] = cmap_d['Greys']\r\n```\r\nchange their .name s too:\r\n```\r\ncmap_d['grey'].name = 'grey'\r\ncmap_d['gist_grey'].name = 'gist_grey'\r\ncmap_d['gist_yerg'].name = 'gist_yerg'\r\ncmap_d['Grays'].name = 'Grays'\r\n```\n\n### Operating system\n\nmacos 10.15.7\n\n### Matplotlib Version\n\n3.8.4\n\n### Matplotlib Backend\n\n_No response_\n\n### Python version\n\n3.10.0\n\n### Jupyter version\n\n_No response_\n\n### Installation\n\npip\n", "hints_text": "It's a bit more involved than just changing the name attribute. There is currently only one underlying `Colorbar` instance for both. I see two possible resolutions:\r\n- Create explicit copies for the aliases. In this case we'd not really be aliasing anymore but just have two separate colormaps that happen to have the same data values.\r\n- Make the aliasing an explicit concept of `ColormapRegistry`.\r\n\r\nNot sure which approach is better. The first is less complex, but we loose from-code accessible information on aliases (not that we have used that before). So slight tendency to go with the first. We can always build explicit aliases in later if we need to.\nMy knee-jerk reaction was \"can we just keep living with this\", but looking into it a bit, if colormaps are added through `ColorMapRegitry.register` then we mutate the passed colormap to match the name we registered it as!  I think the grays/grey miss-match exists because we pass the dictionary in rather than registering them one-by-one.\r\n\r\nThe `__eq__` check on `ColorMaps` only looks at the values of the LUT (and if it is attached to a colarbar with extends which is odd but did not track down why) and ignores the name. \r\n\r\nOn `__getitem__` we already return a copy so making a copy for the aliases is not a huge conceptual step and the users can't tell if we have one instance we are returning copies of two identical instances we are returning copies of.\r\n\r\nThis also suggests that rather than fixing the name on the way in, we should be fixing the name on the way out (as we have already paid to make a copy).\nThis issue inspired me to do https://github.com/matplotlib/matplotlib/pull/28115\n> My knee-jerk reaction was \"can we just keep living with this\"\r\n\r\nThat would be still an option.\r\n\r\n> On `__getitem__` we already return a copy\r\n\r\nThis was added to prevent users from manipulating the builtin colormaps, e.g. via `set_over()`. There is the idea to make colormaps immutable eventually. While immuatbility is the better option, I'm unsure whether we want to enforce the associated API change. But if we do, the copy could go away.\r\n\r\n> This also suggests that rather than fixing the name on the way in, we should be fixing the name on the way out (as we have already paid to make a copy).\r\n\r\nI don't follow that argument. The existing copy only means: We *can* fix the name of the way out without additional cost. I still think it's not the right way, because we have a sketchy internal state. `self._cmaps['grey'].name == \"gray\"` should not happen. Either we invest in the handful of additional copies on the way in (Option 1 from above). Or, we do not have `_cmaps['grey']` and and let `__getitem__` handle alias resolution. But this also means we have to specially handle aliases in keys, which brings us to the explicit alias concept (Option 2 from above).", "created_at": "2024-04-22T07:53:27Z"}
{"repo": "matplotlib/matplotlib", "pull_number": 28074, "instance_id": "matplotlib__matplotlib-28074", "issue_numbers": ["13435", "0000"], "base_commit": "6e8fcbbb0cf5db7bc065aae9f6708b02a7bc51aa", "patch": "diff --git a/doc/api/next_api_changes/deprecations/28074-TS.rst b/doc/api/next_api_changes/deprecations/28074-TS.rst\nnew file mode 100644\nindex 000000000000..6a8b5d4b21b8\n--- /dev/null\n+++ b/doc/api/next_api_changes/deprecations/28074-TS.rst\n@@ -0,0 +1,9 @@\n+``boxplot`` and ``bxp`` *vert* parameter, and ``rcParams[\"boxplot.vertical\"]``\n+~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n+\n+The parameter *vert: bool* has been deprecated on `~.Axes.boxplot` and\n+`~.Axes.bxp`. It is replaced by *orientation: {\"vertical\", \"horizontal\"}*\n+for API consistency.\n+\n+``rcParams[\"boxplot.vertical\"]``, which controlled the orientation of ``boxplot``,\n+is deprecated without replacement.\ndiff --git a/doc/users/next_whats_new/boxplot_orientation.rst b/doc/users/next_whats_new/boxplot_orientation.rst\nnew file mode 100644\nindex 000000000000..19193b530a9e\n--- /dev/null\n+++ b/doc/users/next_whats_new/boxplot_orientation.rst\n@@ -0,0 +1,21 @@\n+``boxplot`` and ``bxp`` orientation parameter\n+~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n+\n+Boxplots have a new parameter *orientation: {\"vertical\", \"horizontal\"}*\n+to change the orientation of the plot. This replaces the deprecated\n+*vert: bool* parameter.\n+\n+\n+.. plot::\n+    :include-source: true\n+    :alt: Example of creating 4 horizontal boxplots.\n+\n+    import matplotlib.pyplot as plt\n+    import numpy as np\n+\n+    fig, ax = plt.subplots()\n+    np.random.seed(19680801)\n+    all_data = [np.random.normal(0, std, 100) for std in range(6, 10)]\n+\n+    ax.boxplot(all_data, orientation='horizontal')\n+    plt.show()\ndiff --git a/galleries/examples/statistics/boxplot_demo.py b/galleries/examples/statistics/boxplot_demo.py\nindex f7f1078b2d27..46d6c7609807 100644\n--- a/galleries/examples/statistics/boxplot_demo.py\n+++ b/galleries/examples/statistics/boxplot_demo.py\n@@ -46,11 +46,11 @@\n axs[1, 0].set_title(\"don't show\\noutlier points\")\n \n # horizontal boxes\n-axs[1, 1].boxplot(data, sym='rs', vert=False)\n+axs[1, 1].boxplot(data, sym='rs', orientation='horizontal')\n axs[1, 1].set_title('horizontal boxes')\n \n # change whisker length\n-axs[1, 2].boxplot(data, sym='rs', vert=False, whis=0.75)\n+axs[1, 2].boxplot(data, sym='rs', orientation='horizontal', whis=0.75)\n axs[1, 2].set_title('change whisker length')\n \n fig.subplots_adjust(left=0.08, right=0.98, bottom=0.05, top=0.9,\n@@ -107,7 +107,7 @@\n fig.canvas.manager.set_window_title('A Boxplot Example')\n fig.subplots_adjust(left=0.075, right=0.95, top=0.9, bottom=0.25)\n \n-bp = ax1.boxplot(data, notch=False, sym='+', vert=True, whis=1.5)\n+bp = ax1.boxplot(data, notch=False, sym='+', orientation='vertical', whis=1.5)\n plt.setp(bp['boxes'], color='black')\n plt.setp(bp['whiskers'], color='black')\n plt.setp(bp['fliers'], color='red', marker='+')\ndiff --git a/lib/matplotlib/axes/_axes.py b/lib/matplotlib/axes/_axes.py\nindex 50540d862b5f..e7b484bc99a9 100644\n--- a/lib/matplotlib/axes/_axes.py\n+++ b/lib/matplotlib/axes/_axes.py\n@@ -3819,9 +3819,10 @@ def apply_mask(arrays, mask):\n     @_api.make_keyword_only(\"3.9\", \"notch\")\n     @_preprocess_data()\n     @_api.rename_parameter(\"3.9\", \"labels\", \"tick_labels\")\n-    def boxplot(self, x, notch=None, sym=None, vert=None, whis=None,\n-                positions=None, widths=None, patch_artist=None,\n-                bootstrap=None, usermedians=None, conf_intervals=None,\n+    def boxplot(self, x, notch=None, sym=None, vert=None,\n+                orientation='vertical', whis=None, positions=None,\n+                widths=None, patch_artist=None, bootstrap=None,\n+                usermedians=None, conf_intervals=None,\n                 meanline=None, showmeans=None, showcaps=None,\n                 showbox=None, showfliers=None, boxprops=None,\n                 tick_labels=None, flierprops=None, medianprops=None,\n@@ -3877,9 +3878,21 @@ def boxplot(self, x, notch=None, sym=None, vert=None, whis=None,\n             the fliers.  If `None`, then the fliers default to 'b+'.  More\n             control is provided by the *flierprops* parameter.\n \n-        vert : bool, default: :rc:`boxplot.vertical`\n-            If `True`, draws vertical boxes.\n-            If `False`, draw horizontal boxes.\n+        vert : bool, optional\n+            .. deprecated:: 3.10\n+                Use *orientation* instead.\n+\n+                If this is given during the deprecation period, it overrides\n+                the *orientation* parameter.\n+\n+            If True, plots the boxes vertically.\n+            If False, plots the boxes horizontally.\n+\n+        orientation : {'vertical', 'horizontal'}, default: 'vertical'\n+            If 'horizontal', plots the boxes horizontally.\n+            Otherwise, plots the boxes vertically.\n+\n+            .. versionadded:: 3.10\n \n         whis : float or (float, float), default: 1.5\n             The position of the whiskers.\n@@ -4047,8 +4060,6 @@ def boxplot(self, x, notch=None, sym=None, vert=None, whis=None,\n                                        labels=tick_labels, autorange=autorange)\n         if notch is None:\n             notch = mpl.rcParams['boxplot.notch']\n-        if vert is None:\n-            vert = mpl.rcParams['boxplot.vertical']\n         if patch_artist is None:\n             patch_artist = mpl.rcParams['boxplot.patchartist']\n         if meanline is None:\n@@ -4148,13 +4159,14 @@ def boxplot(self, x, notch=None, sym=None, vert=None, whis=None,\n                            meanline=meanline, showfliers=showfliers,\n                            capprops=capprops, whiskerprops=whiskerprops,\n                            manage_ticks=manage_ticks, zorder=zorder,\n-                           capwidths=capwidths, label=label)\n+                           capwidths=capwidths, label=label,\n+                           orientation=orientation)\n         return artists\n \n     @_api.make_keyword_only(\"3.9\", \"widths\")\n-    def bxp(self, bxpstats, positions=None, widths=None, vert=True,\n-            patch_artist=False, shownotches=False, showmeans=False,\n-            showcaps=True, showbox=True, showfliers=True,\n+    def bxp(self, bxpstats, positions=None, widths=None, vert=None,\n+            orientation='vertical', patch_artist=False, shownotches=False,\n+            showmeans=False, showcaps=True, showbox=True, showfliers=True,\n             boxprops=None, whiskerprops=None, flierprops=None,\n             medianprops=None, capprops=None, meanprops=None,\n             meanline=False, manage_ticks=True, zorder=None,\n@@ -4213,9 +4225,21 @@ def bxp(self, bxpstats, positions=None, widths=None, vert=True,\n             Either a scalar or a vector and sets the width of each cap.\n             The default is ``0.5*(width of the box)``, see *widths*.\n \n-        vert : bool, default: True\n-            If `True` (default), makes the boxes vertical.\n-            If `False`, makes horizontal boxes.\n+        vert : bool, optional\n+            .. deprecated:: 3.10\n+                Use *orientation* instead.\n+\n+                If this is given during the deprecation period, it overrides\n+                the *orientation* parameter.\n+\n+            If True, plots the boxes vertically.\n+            If False, plots the boxes horizontally.\n+\n+        orientation : {'vertical', 'horizontal'}, default: 'vertical'\n+            If 'horizontal', plots the boxes horizontally.\n+            Otherwise, plots the boxes vertically.\n+\n+            .. versionadded:: 3.10\n \n         patch_artist : bool, default: False\n             If `False` produces boxes with the `.Line2D` artist.\n@@ -4334,8 +4358,29 @@ def merge_kw_rc(subkey, explicit, zdelta=0, usemarker=True):\n         if meanprops is None or removed_prop not in meanprops:\n             mean_kw[removed_prop] = ''\n \n+        # vert and orientation parameters are linked until vert's\n+        # deprecation period expires. vert only takes precedence\n+        # if set to False.\n+        if vert is None:\n+            vert = mpl.rcParams['boxplot.vertical']\n+        else:\n+            _api.warn_deprecated(\n+                \"3.10\",\n+                name=\"vert: bool\",\n+                alternative=\"orientation: {'vertical', 'horizontal'}\"\n+            )\n+        if vert is False:\n+            orientation = 'horizontal'\n+        _api.check_in_list(['horizontal', 'vertical'], orientation=orientation)\n+\n+        if not mpl.rcParams['boxplot.vertical']:\n+            _api.warn_deprecated(\n+                \"3.10\",\n+                name='boxplot.vertical', obj_type=\"rcparam\"\n+            )\n+\n         # vertical or horizontal plot?\n-        maybe_swap = slice(None) if vert else slice(None, None, -1)\n+        maybe_swap = slice(None) if orientation == 'vertical' else slice(None, None, -1)\n \n         def do_plot(xs, ys, **kwargs):\n             return self.plot(*[xs, ys][maybe_swap], **kwargs)[0]\n@@ -4460,7 +4505,7 @@ def do_patch(xs, ys, **kwargs):\n                     artist.set_label(lbl)\n \n         if manage_ticks:\n-            axis_name = \"x\" if vert else \"y\"\n+            axis_name = \"x\" if orientation == 'vertical' else \"y\"\n             interval = getattr(self.dataLim, f\"interval{axis_name}\")\n             axis = self._axis_map[axis_name]\n             positions = axis.convert_units(positions)\ndiff --git a/lib/matplotlib/axes/_axes.pyi b/lib/matplotlib/axes/_axes.pyi\nindex 2f5f6b4f3fde..b728d24d9fe9 100644\n--- a/lib/matplotlib/axes/_axes.pyi\n+++ b/lib/matplotlib/axes/_axes.pyi\n@@ -350,6 +350,7 @@ class Axes(_AxesBase):\n         notch: bool | None = ...,\n         sym: str | None = ...,\n         vert: bool | None = ...,\n+        orientation: Literal[\"vertical\", \"horizontal\"] = ...,\n         whis: float | tuple[float, float] | None = ...,\n         positions: ArrayLike | None = ...,\n         widths: float | ArrayLike | None = ...,\n@@ -382,7 +383,8 @@ class Axes(_AxesBase):\n         positions: ArrayLike | None = ...,\n         *,\n         widths: float | ArrayLike | None = ...,\n-        vert: bool = ...,\n+        vert: bool | None = ...,\n+        orientation: Literal[\"vertical\", \"horizontal\"] = ...,\n         patch_artist: bool = ...,\n         shownotches: bool = ...,\n         showmeans: bool = ...,\ndiff --git a/lib/matplotlib/mpl-data/stylelib/classic.mplstyle b/lib/matplotlib/mpl-data/stylelib/classic.mplstyle\nindex 976ab291907b..50516d831ae4 100644\n--- a/lib/matplotlib/mpl-data/stylelib/classic.mplstyle\n+++ b/lib/matplotlib/mpl-data/stylelib/classic.mplstyle\n@@ -380,7 +380,6 @@ boxplot.showbox: True\n boxplot.showcaps: True\n boxplot.showfliers: True\n boxplot.showmeans: False\n-boxplot.vertical: True\n boxplot.whiskerprops.color: b\n boxplot.whiskerprops.linestyle: --\n boxplot.whiskerprops.linewidth: 1.0\ndiff --git a/lib/matplotlib/pyplot.py b/lib/matplotlib/pyplot.py\nindex 5d9d2f42f6ac..00e623dd649e 100644\n--- a/lib/matplotlib/pyplot.py\n+++ b/lib/matplotlib/pyplot.py\n@@ -2935,6 +2935,7 @@ def boxplot(\n     notch: bool | None = None,\n     sym: str | None = None,\n     vert: bool | None = None,\n+    orientation: Literal[\"vertical\", \"horizontal\"] = \"vertical\",\n     whis: float | tuple[float, float] | None = None,\n     positions: ArrayLike | None = None,\n     widths: float | ArrayLike | None = None,\n@@ -2967,6 +2968,7 @@ def boxplot(\n         notch=notch,\n         sym=sym,\n         vert=vert,\n+        orientation=orientation,\n         whis=whis,\n         positions=positions,\n         widths=widths,\n", "test_patch": "diff --git a/lib/matplotlib/tests/baseline_images/test_axes/boxplot_rc_parameters.pdf b/lib/matplotlib/tests/baseline_images/test_axes/boxplot_rc_parameters.pdf\nindex cc9433bebd31..c424bc5e982f 100644\nBinary files a/lib/matplotlib/tests/baseline_images/test_axes/boxplot_rc_parameters.pdf and b/lib/matplotlib/tests/baseline_images/test_axes/boxplot_rc_parameters.pdf differ\ndiff --git a/lib/matplotlib/tests/baseline_images/test_axes/boxplot_rc_parameters.png b/lib/matplotlib/tests/baseline_images/test_axes/boxplot_rc_parameters.png\nindex 07b8a5da7247..944f9451285c 100644\nBinary files a/lib/matplotlib/tests/baseline_images/test_axes/boxplot_rc_parameters.png and b/lib/matplotlib/tests/baseline_images/test_axes/boxplot_rc_parameters.png differ\ndiff --git a/lib/matplotlib/tests/baseline_images/test_axes/boxplot_rc_parameters.svg b/lib/matplotlib/tests/baseline_images/test_axes/boxplot_rc_parameters.svg\nindex 054af5b4f2f3..c3a3cda7a9a0 100644\n--- a/lib/matplotlib/tests/baseline_images/test_axes/boxplot_rc_parameters.svg\n+++ b/lib/matplotlib/tests/baseline_images/test_axes/boxplot_rc_parameters.svg\n@@ -1,538 +1,535 @@\n-<?xml version=\"1.0\" encoding=\"utf-8\" standalone=\"no\"?>\n-<!DOCTYPE svg PUBLIC \"-//W3C//DTD SVG 1.1//EN\"\n-  \"http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd\">\n-<!-- Created with matplotlib (http://matplotlib.org/) -->\n-<svg height=\"345.6pt\" version=\"1.1\" viewBox=\"0 0 460.8 345.6\" width=\"460.8pt\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\">\n- <defs>\n-  <style type=\"text/css\">\n-*{stroke-linecap:butt;stroke-linejoin:round;}\n-  </style>\n- </defs>\n- <g id=\"figure_1\">\n-  <g id=\"patch_1\">\n-   <path d=\"M 0 345.6 \n-L 460.8 345.6 \n-L 460.8 0 \n-L 0 0 \n-z\n-\" style=\"fill:#ffffff;\"/>\n-  </g>\n-  <g id=\"axes_1\">\n-   <g id=\"patch_2\">\n-    <path d=\"M 57.6 119.740235 \n-L 414.72 119.740235 \n-L 414.72 41.472 \n-L 57.6 41.472 \n-z\n-\" style=\"fill:#ffffff;\"/>\n-   </g>\n-   <g id=\"matplotlib.axis_1\">\n-    <g id=\"xtick_1\">\n-     <g id=\"line2d_1\">\n-      <defs>\n-       <path d=\"M 0 0 \n-L 0 3.5 \n-\" id=\"me3c5aad6dc\" style=\"stroke:#000000;stroke-width:0.8;\"/>\n-      </defs>\n-      <g>\n-       <use style=\"stroke:#000000;stroke-width:0.8;\" x=\"146.88\" xlink:href=\"#me3c5aad6dc\" y=\"119.740235\"/>\n-      </g>\n-     </g>\n-    </g>\n-    <g id=\"xtick_2\">\n-     <g id=\"line2d_2\">\n-      <g>\n-       <use style=\"stroke:#000000;stroke-width:0.8;\" x=\"325.44\" xlink:href=\"#me3c5aad6dc\" y=\"119.740235\"/>\n-      </g>\n-     </g>\n-    </g>\n-   </g>\n-   <g id=\"matplotlib.axis_2\">\n-    <g id=\"ytick_1\">\n-     <g id=\"line2d_3\">\n-      <defs>\n-       <path d=\"M 0 0 \n-L -3.5 0 \n-\" id=\"mb093d27a24\" style=\"stroke:#000000;stroke-width:0.8;\"/>\n-      </defs>\n-      <g>\n-       <use style=\"stroke:#000000;stroke-width:0.8;\" x=\"57.6\" xlink:href=\"#mb093d27a24\" y=\"109.067294\"/>\n-      </g>\n-     </g>\n-    </g>\n-    <g id=\"ytick_2\">\n-     <g id=\"line2d_4\">\n-      <g>\n-       <use style=\"stroke:#000000;stroke-width:0.8;\" x=\"57.6\" xlink:href=\"#mb093d27a24\" y=\"80.606118\"/>\n-      </g>\n-     </g>\n-    </g>\n-    <g id=\"ytick_3\">\n-     <g id=\"line2d_5\">\n-      <g>\n-       <use style=\"stroke:#000000;stroke-width:0.8;\" x=\"57.6\" xlink:href=\"#mb093d27a24\" y=\"52.144941\"/>\n-      </g>\n-     </g>\n-    </g>\n-   </g>\n-   <g id=\"line2d_6\">\n-    <path clip-path=\"url(#p391ee919e1)\" d=\"M 133.488 85.658488 \n-L 160.272 85.658488 \n-L 160.272 82.254409 \n-L 153.576 80.606118 \n-L 160.272 78.957826 \n-L 160.272 75.553747 \n-L 133.488 75.553747 \n-L 133.488 78.957826 \n-L 140.184 80.606118 \n-L 133.488 82.254409 \n-L 133.488 85.658488 \n-\" style=\"fill:none;stroke:#ff0000;stroke-dasharray:7.4,3.2;stroke-dashoffset:0;stroke-width:2;\"/>\n-   </g>\n-   <g id=\"line2d_7\">\n-    <path clip-path=\"url(#p391ee919e1)\" d=\"M 146.88 85.658488 \n-L 146.88 89.564222 \n-\" style=\"fill:none;stroke:#000000;stroke-linecap:square;\"/>\n-   </g>\n-   <g id=\"line2d_8\">\n-    <path clip-path=\"url(#p391ee919e1)\" d=\"M 146.88 75.553747 \n-L 146.88 71.648014 \n-\" style=\"fill:none;stroke:#000000;stroke-linecap:square;\"/>\n-   </g>\n-   <g id=\"line2d_9\">\n-    <path clip-path=\"url(#p391ee919e1)\" d=\"M 140.184 89.564222 \n-L 153.576 89.564222 \n-\" style=\"fill:none;stroke:#00bfbf;stroke-dasharray:7.4,3.2;stroke-dashoffset:0;stroke-width:2;\"/>\n-   </g>\n-   <g id=\"line2d_10\">\n-    <path clip-path=\"url(#p391ee919e1)\" d=\"M 140.184 71.648014 \n-L 153.576 71.648014 \n-\" style=\"fill:none;stroke:#00bfbf;stroke-dasharray:7.4,3.2;stroke-dashoffset:0;stroke-width:2;\"/>\n-   </g>\n-   <g id=\"line2d_11\">\n-    <path clip-path=\"url(#p391ee919e1)\" d=\"M 146.88 116.182588 \n-L 146.88 90.567529 \n-L 146.88 90.4242 \n-L 146.88 90.28087 \n-L 146.88 90.13754 \n-L 146.88 89.994211 \n-L 146.88 89.850881 \n-L 146.88 89.707551 \n-L 146.88 71.504684 \n-L 146.88 71.361354 \n-L 146.88 71.218025 \n-L 146.88 71.074695 \n-L 146.88 70.931365 \n-L 146.88 70.788036 \n-L 146.88 70.644706 \n-L 146.88 45.029647 \n-\" style=\"fill:none;stroke:#0000ff;stroke-dasharray:7.4,3.2;stroke-dashoffset:0;stroke-width:2;\"/>\n-    <defs>\n-     <path d=\"M 0 2.5 \n-C 0.663008 2.5 1.29895 2.236584 1.767767 1.767767 \n-C 2.236584 1.29895 2.5 0.663008 2.5 0 \n-C 2.5 -0.663008 2.236584 -1.29895 1.767767 -1.767767 \n-C 1.29895 -2.236584 0.663008 -2.5 0 -2.5 \n-C -0.663008 -2.5 -1.29895 -2.236584 -1.767767 -1.767767 \n-C -2.236584 -1.29895 -2.5 -0.663008 -2.5 0 \n-C -2.5 0.663008 -2.236584 1.29895 -1.767767 1.767767 \n-C -1.29895 2.236584 -0.663008 2.5 0 2.5 \n-z\n-\" id=\"mdf84968221\" style=\"stroke:#0000ff;\"/>\n-    </defs>\n-    <g clip-path=\"url(#p391ee919e1)\">\n-     <use style=\"fill:#008000;stroke:#0000ff;\" x=\"146.88\" xlink:href=\"#mdf84968221\" y=\"116.182588\"/>\n-     <use style=\"fill:#008000;stroke:#0000ff;\" x=\"146.88\" xlink:href=\"#mdf84968221\" y=\"90.567529\"/>\n-     <use style=\"fill:#008000;stroke:#0000ff;\" x=\"146.88\" xlink:href=\"#mdf84968221\" y=\"90.4242\"/>\n-     <use style=\"fill:#008000;stroke:#0000ff;\" x=\"146.88\" xlink:href=\"#mdf84968221\" y=\"90.28087\"/>\n-     <use style=\"fill:#008000;stroke:#0000ff;\" x=\"146.88\" xlink:href=\"#mdf84968221\" y=\"90.13754\"/>\n-     <use style=\"fill:#008000;stroke:#0000ff;\" x=\"146.88\" xlink:href=\"#mdf84968221\" y=\"89.994211\"/>\n-     <use style=\"fill:#008000;stroke:#0000ff;\" x=\"146.88\" xlink:href=\"#mdf84968221\" y=\"89.850881\"/>\n-     <use style=\"fill:#008000;stroke:#0000ff;\" x=\"146.88\" xlink:href=\"#mdf84968221\" y=\"89.707551\"/>\n-     <use style=\"fill:#008000;stroke:#0000ff;\" x=\"146.88\" xlink:href=\"#mdf84968221\" y=\"71.504684\"/>\n-     <use style=\"fill:#008000;stroke:#0000ff;\" x=\"146.88\" xlink:href=\"#mdf84968221\" y=\"71.361354\"/>\n-     <use style=\"fill:#008000;stroke:#0000ff;\" x=\"146.88\" xlink:href=\"#mdf84968221\" y=\"71.218025\"/>\n-     <use style=\"fill:#008000;stroke:#0000ff;\" x=\"146.88\" xlink:href=\"#mdf84968221\" y=\"71.074695\"/>\n-     <use style=\"fill:#008000;stroke:#0000ff;\" x=\"146.88\" xlink:href=\"#mdf84968221\" y=\"70.931365\"/>\n-     <use style=\"fill:#008000;stroke:#0000ff;\" x=\"146.88\" xlink:href=\"#mdf84968221\" y=\"70.788036\"/>\n-     <use style=\"fill:#008000;stroke:#0000ff;\" x=\"146.88\" xlink:href=\"#mdf84968221\" y=\"70.644706\"/>\n-     <use style=\"fill:#008000;stroke:#0000ff;\" x=\"146.88\" xlink:href=\"#mdf84968221\" y=\"45.029647\"/>\n-    </g>\n-   </g>\n-   <g id=\"line2d_12\">\n-    <path clip-path=\"url(#p391ee919e1)\" d=\"M 312.048 85.658488 \n-L 338.832 85.658488 \n-L 338.832 82.254409 \n-L 332.136 80.606118 \n-L 338.832 78.957826 \n-L 338.832 75.553747 \n-L 312.048 75.553747 \n-L 312.048 78.957826 \n-L 318.744 80.606118 \n-L 312.048 82.254409 \n-L 312.048 85.658488 \n-\" style=\"fill:none;stroke:#ff0000;stroke-dasharray:7.4,3.2;stroke-dashoffset:0;stroke-width:2;\"/>\n-   </g>\n-   <g id=\"line2d_13\">\n-    <path clip-path=\"url(#p391ee919e1)\" d=\"M 325.44 85.658488 \n-L 325.44 89.564222 \n-\" style=\"fill:none;stroke:#000000;stroke-linecap:square;\"/>\n-   </g>\n-   <g id=\"line2d_14\">\n-    <path clip-path=\"url(#p391ee919e1)\" d=\"M 325.44 75.553747 \n-L 325.44 71.648014 \n-\" style=\"fill:none;stroke:#000000;stroke-linecap:square;\"/>\n-   </g>\n-   <g id=\"line2d_15\">\n-    <path clip-path=\"url(#p391ee919e1)\" d=\"M 318.744 89.564222 \n-L 332.136 89.564222 \n-\" style=\"fill:none;stroke:#00bfbf;stroke-dasharray:7.4,3.2;stroke-dashoffset:0;stroke-width:2;\"/>\n-   </g>\n-   <g id=\"line2d_16\">\n-    <path clip-path=\"url(#p391ee919e1)\" d=\"M 318.744 71.648014 \n-L 332.136 71.648014 \n-\" style=\"fill:none;stroke:#00bfbf;stroke-dasharray:7.4,3.2;stroke-dashoffset:0;stroke-width:2;\"/>\n-   </g>\n-   <g id=\"line2d_17\">\n-    <path clip-path=\"url(#p391ee919e1)\" d=\"M 325.44 116.182588 \n-L 325.44 90.567529 \n-L 325.44 90.4242 \n-L 325.44 90.28087 \n-L 325.44 90.13754 \n-L 325.44 89.994211 \n-L 325.44 89.850881 \n-L 325.44 89.707551 \n-L 325.44 71.504684 \n-L 325.44 71.361354 \n-L 325.44 71.218025 \n-L 325.44 71.074695 \n-L 325.44 70.931365 \n-L 325.44 70.788036 \n-L 325.44 70.644706 \n-L 325.44 45.029647 \n-\" style=\"fill:none;stroke:#0000ff;stroke-dasharray:7.4,3.2;stroke-dashoffset:0;stroke-width:2;\"/>\n-    <g clip-path=\"url(#p391ee919e1)\">\n-     <use style=\"fill:#008000;stroke:#0000ff;\" x=\"325.44\" xlink:href=\"#mdf84968221\" y=\"116.182588\"/>\n-     <use style=\"fill:#008000;stroke:#0000ff;\" x=\"325.44\" xlink:href=\"#mdf84968221\" y=\"90.567529\"/>\n-     <use style=\"fill:#008000;stroke:#0000ff;\" x=\"325.44\" xlink:href=\"#mdf84968221\" y=\"90.4242\"/>\n-     <use style=\"fill:#008000;stroke:#0000ff;\" x=\"325.44\" xlink:href=\"#mdf84968221\" y=\"90.28087\"/>\n-     <use style=\"fill:#008000;stroke:#0000ff;\" x=\"325.44\" xlink:href=\"#mdf84968221\" y=\"90.13754\"/>\n-     <use style=\"fill:#008000;stroke:#0000ff;\" x=\"325.44\" xlink:href=\"#mdf84968221\" y=\"89.994211\"/>\n-     <use style=\"fill:#008000;stroke:#0000ff;\" x=\"325.44\" xlink:href=\"#mdf84968221\" y=\"89.850881\"/>\n-     <use style=\"fill:#008000;stroke:#0000ff;\" x=\"325.44\" xlink:href=\"#mdf84968221\" y=\"89.707551\"/>\n-     <use style=\"fill:#008000;stroke:#0000ff;\" x=\"325.44\" xlink:href=\"#mdf84968221\" y=\"71.504684\"/>\n-     <use style=\"fill:#008000;stroke:#0000ff;\" x=\"325.44\" xlink:href=\"#mdf84968221\" y=\"71.361354\"/>\n-     <use style=\"fill:#008000;stroke:#0000ff;\" x=\"325.44\" xlink:href=\"#mdf84968221\" y=\"71.218025\"/>\n-     <use style=\"fill:#008000;stroke:#0000ff;\" x=\"325.44\" xlink:href=\"#mdf84968221\" y=\"71.074695\"/>\n-     <use style=\"fill:#008000;stroke:#0000ff;\" x=\"325.44\" xlink:href=\"#mdf84968221\" y=\"70.931365\"/>\n-     <use style=\"fill:#008000;stroke:#0000ff;\" x=\"325.44\" xlink:href=\"#mdf84968221\" y=\"70.788036\"/>\n-     <use style=\"fill:#008000;stroke:#0000ff;\" x=\"325.44\" xlink:href=\"#mdf84968221\" y=\"70.644706\"/>\n-     <use style=\"fill:#008000;stroke:#0000ff;\" x=\"325.44\" xlink:href=\"#mdf84968221\" y=\"45.029647\"/>\n-    </g>\n-   </g>\n-   <g id=\"line2d_18\">\n-    <path clip-path=\"url(#p391ee919e1)\" d=\"M 140.184 80.606118 \n-L 153.576 80.606118 \n-\" style=\"fill:none;stroke:#000000;stroke-dasharray:7.4,3.2;stroke-dashoffset:0;stroke-width:2;\"/>\n-   </g>\n-   <g id=\"line2d_19\">\n-    <path clip-path=\"url(#p391ee919e1)\" d=\"M 318.744 80.606118 \n-L 332.136 80.606118 \n-\" style=\"fill:none;stroke:#000000;stroke-dasharray:7.4,3.2;stroke-dashoffset:0;stroke-width:2;\"/>\n-   </g>\n-   <g id=\"patch_3\">\n-    <path d=\"M 57.6 119.740235 \n-L 57.6 41.472 \n-\" style=\"fill:none;stroke:#000000;stroke-linecap:square;stroke-linejoin:miter;stroke-width:0.8;\"/>\n-   </g>\n-   <g id=\"patch_4\">\n-    <path d=\"M 414.72 119.740235 \n-L 414.72 41.472 \n-\" style=\"fill:none;stroke:#000000;stroke-linecap:square;stroke-linejoin:miter;stroke-width:0.8;\"/>\n-   </g>\n-   <g id=\"patch_5\">\n-    <path d=\"M 57.6 119.740235 \n-L 414.72 119.740235 \n-\" style=\"fill:none;stroke:#000000;stroke-linecap:square;stroke-linejoin:miter;stroke-width:0.8;\"/>\n-   </g>\n-   <g id=\"patch_6\">\n-    <path d=\"M 57.6 41.472 \n-L 414.72 41.472 \n-\" style=\"fill:none;stroke:#000000;stroke-linecap:square;stroke-linejoin:miter;stroke-width:0.8;\"/>\n-   </g>\n-  </g>\n-  <g id=\"axes_2\">\n-   <g id=\"patch_7\">\n-    <path d=\"M 57.6 213.662118 \n-L 414.72 213.662118 \n-L 414.72 135.393882 \n-L 57.6 135.393882 \n-z\n-\" style=\"fill:#ffffff;\"/>\n-   </g>\n-   <g id=\"matplotlib.axis_3\">\n-    <g id=\"xtick_3\">\n-     <g id=\"line2d_20\">\n-      <g>\n-       <use style=\"stroke:#000000;stroke-width:0.8;\" x=\"106.298182\" xlink:href=\"#me3c5aad6dc\" y=\"213.662118\"/>\n-      </g>\n-     </g>\n-    </g>\n-    <g id=\"xtick_4\">\n-     <g id=\"line2d_21\">\n-      <g>\n-       <use style=\"stroke:#000000;stroke-width:0.8;\" x=\"171.229091\" xlink:href=\"#me3c5aad6dc\" y=\"213.662118\"/>\n-      </g>\n-     </g>\n-    </g>\n-    <g id=\"xtick_5\">\n-     <g id=\"line2d_22\">\n-      <g>\n-       <use style=\"stroke:#000000;stroke-width:0.8;\" x=\"236.16\" xlink:href=\"#me3c5aad6dc\" y=\"213.662118\"/>\n-      </g>\n-     </g>\n-    </g>\n-    <g id=\"xtick_6\">\n-     <g id=\"line2d_23\">\n-      <g>\n-       <use style=\"stroke:#000000;stroke-width:0.8;\" x=\"301.090909\" xlink:href=\"#me3c5aad6dc\" y=\"213.662118\"/>\n-      </g>\n-     </g>\n-    </g>\n-    <g id=\"xtick_7\">\n-     <g id=\"line2d_24\">\n-      <g>\n-       <use style=\"stroke:#000000;stroke-width:0.8;\" x=\"366.021818\" xlink:href=\"#me3c5aad6dc\" y=\"213.662118\"/>\n-      </g>\n-     </g>\n-    </g>\n-   </g>\n-   <g id=\"matplotlib.axis_4\">\n-    <g id=\"ytick_4\">\n-     <g id=\"line2d_25\">\n-      <g>\n-       <use style=\"stroke:#000000;stroke-width:0.8;\" x=\"57.6\" xlink:href=\"#mb093d27a24\" y=\"194.095059\"/>\n-      </g>\n-     </g>\n-    </g>\n-    <g id=\"ytick_5\">\n-     <g id=\"line2d_26\">\n-      <g>\n-       <use style=\"stroke:#000000;stroke-width:0.8;\" x=\"57.6\" xlink:href=\"#mb093d27a24\" y=\"154.960941\"/>\n-      </g>\n-     </g>\n-    </g>\n-   </g>\n-   <g id=\"line2d_27\">\n-    <path clip-path=\"url(#pc019ee541c)\" d=\"M 213.107192 194.095059 \n-L 73.832727 194.095059 \n-\" style=\"fill:none;stroke:#000000;stroke-linecap:square;\"/>\n-   </g>\n-   <g id=\"line2d_28\">\n-    <path clip-path=\"url(#pc019ee541c)\" d=\"M 259.212808 194.095059 \n-L 398.487273 194.095059 \n-\" style=\"fill:none;stroke:#000000;stroke-linecap:square;\"/>\n-   </g>\n-   <g id=\"line2d_29\">\n-    <path clip-path=\"url(#pc019ee541c)\" d=\"M 73.832727 195.562588 \n-L 73.832727 192.627529 \n-\" style=\"fill:none;stroke:#000000;stroke-linecap:square;\"/>\n-   </g>\n-   <g id=\"line2d_30\">\n-    <path clip-path=\"url(#pc019ee541c)\" d=\"M 398.487273 195.562588 \n-L 398.487273 192.627529 \n-\" style=\"fill:none;stroke:#000000;stroke-linecap:square;\"/>\n-   </g>\n-   <g id=\"line2d_31\"/>\n-   <g id=\"line2d_32\">\n-    <path clip-path=\"url(#pc019ee541c)\" d=\"M 213.107192 154.960941 \n-L 73.832727 154.960941 \n-\" style=\"fill:none;stroke:#000000;stroke-linecap:square;\"/>\n-   </g>\n-   <g id=\"line2d_33\">\n-    <path clip-path=\"url(#pc019ee541c)\" d=\"M 259.212808 154.960941 \n-L 398.487273 154.960941 \n-\" style=\"fill:none;stroke:#000000;stroke-linecap:square;\"/>\n-   </g>\n-   <g id=\"line2d_34\">\n-    <path clip-path=\"url(#pc019ee541c)\" d=\"M 73.832727 156.428471 \n-L 73.832727 153.493412 \n-\" style=\"fill:none;stroke:#000000;stroke-linecap:square;\"/>\n-   </g>\n-   <g id=\"line2d_35\">\n-    <path clip-path=\"url(#pc019ee541c)\" d=\"M 398.487273 156.428471 \n-L 398.487273 153.493412 \n-\" style=\"fill:none;stroke:#000000;stroke-linecap:square;\"/>\n-   </g>\n-   <g id=\"line2d_36\"/>\n-   <g id=\"patch_8\">\n-    <path clip-path=\"url(#pc019ee541c)\" d=\"M 213.107192 197.030118 \n-L 213.107192 191.16 \n-L 259.212808 191.16 \n-L 259.212808 197.030118 \n-L 213.107192 197.030118 \n-z\n-\" style=\"fill:#1f77b4;stroke:#000000;stroke-linejoin:miter;\"/>\n-   </g>\n-   <g id=\"patch_9\">\n-    <path clip-path=\"url(#pc019ee541c)\" d=\"M 213.107192 157.896 \n-L 213.107192 152.025882 \n-L 259.212808 152.025882 \n-L 259.212808 157.896 \n-L 213.107192 157.896 \n-z\n-\" style=\"fill:#1f77b4;stroke:#000000;stroke-linejoin:miter;\"/>\n-   </g>\n-   <g id=\"line2d_37\">\n-    <path clip-path=\"url(#pc019ee541c)\" d=\"M 236.16 197.030118 \n-L 236.16 191.16 \n-\" style=\"fill:none;stroke:#ff7f0e;stroke-linecap:square;\"/>\n-   </g>\n-   <g id=\"line2d_38\">\n-    <path clip-path=\"url(#pc019ee541c)\" d=\"M 236.16 157.896 \n-L 236.16 152.025882 \n-\" style=\"fill:none;stroke:#ff7f0e;stroke-linecap:square;\"/>\n-   </g>\n-   <g id=\"patch_10\">\n-    <path d=\"M 57.6 213.662118 \n-L 57.6 135.393882 \n-\" style=\"fill:none;stroke:#000000;stroke-linecap:square;stroke-linejoin:miter;stroke-width:0.8;\"/>\n-   </g>\n-   <g id=\"patch_11\">\n-    <path d=\"M 414.72 213.662118 \n-L 414.72 135.393882 \n-\" style=\"fill:none;stroke:#000000;stroke-linecap:square;stroke-linejoin:miter;stroke-width:0.8;\"/>\n-   </g>\n-   <g id=\"patch_12\">\n-    <path d=\"M 57.6 213.662118 \n-L 414.72 213.662118 \n-\" style=\"fill:none;stroke:#000000;stroke-linecap:square;stroke-linejoin:miter;stroke-width:0.8;\"/>\n-   </g>\n-   <g id=\"patch_13\">\n-    <path d=\"M 57.6 135.393882 \n-L 414.72 135.393882 \n-\" style=\"fill:none;stroke:#000000;stroke-linecap:square;stroke-linejoin:miter;stroke-width:0.8;\"/>\n-   </g>\n-  </g>\n-  <g id=\"axes_3\">\n-   <g id=\"patch_14\">\n-    <path d=\"M 57.6 307.584 \n-L 414.72 307.584 \n-L 414.72 229.315765 \n-L 57.6 229.315765 \n-z\n-\" style=\"fill:#ffffff;\"/>\n-   </g>\n-   <g id=\"matplotlib.axis_5\">\n-    <g id=\"xtick_8\">\n-     <g id=\"line2d_39\">\n-      <g>\n-       <use style=\"stroke:#000000;stroke-width:0.8;\" x=\"146.88\" xlink:href=\"#me3c5aad6dc\" y=\"307.584\"/>\n-      </g>\n-     </g>\n-    </g>\n-    <g id=\"xtick_9\">\n-     <g id=\"line2d_40\">\n-      <g>\n-       <use style=\"stroke:#000000;stroke-width:0.8;\" x=\"325.44\" xlink:href=\"#me3c5aad6dc\" y=\"307.584\"/>\n-      </g>\n-     </g>\n-    </g>\n-   </g>\n-   <g id=\"matplotlib.axis_6\">\n-    <g id=\"ytick_6\">\n-     <g id=\"line2d_41\">\n-      <g>\n-       <use style=\"stroke:#000000;stroke-width:0.8;\" x=\"57.6\" xlink:href=\"#mb093d27a24\" y=\"293.861647\"/>\n-      </g>\n-     </g>\n-    </g>\n-    <g id=\"ytick_7\">\n-     <g id=\"line2d_42\">\n-      <g>\n-       <use style=\"stroke:#000000;stroke-width:0.8;\" x=\"57.6\" xlink:href=\"#mb093d27a24\" y=\"268.449882\"/>\n-      </g>\n-     </g>\n-    </g>\n-    <g id=\"ytick_8\">\n-     <g id=\"line2d_43\">\n-      <g>\n-       <use style=\"stroke:#000000;stroke-width:0.8;\" x=\"57.6\" xlink:href=\"#mb093d27a24\" y=\"243.038118\"/>\n-      </g>\n-     </g>\n-    </g>\n-   </g>\n-   <g id=\"line2d_44\">\n-    <path clip-path=\"url(#p8f0378e7d4)\" d=\"M 146.88 286.494063 \n-L 146.88 304.026353 \n-\" style=\"fill:none;stroke:#ff0000;stroke-dasharray:12.8,3.2,2,3.2;stroke-dashoffset:0;stroke-width:2;\"/>\n-   </g>\n-   <g id=\"line2d_45\">\n-    <path clip-path=\"url(#p8f0378e7d4)\" d=\"M 146.88 250.405701 \n-L 146.88 232.873412 \n-\" style=\"fill:none;stroke:#ff0000;stroke-dasharray:12.8,3.2,2,3.2;stroke-dashoffset:0;stroke-width:2;\"/>\n-   </g>\n-   <g id=\"line2d_46\">\n-    <path clip-path=\"url(#p8f0378e7d4)\" d=\"M 325.44 286.494063 \n-L 325.44 304.026353 \n-\" style=\"fill:none;stroke:#ff0000;stroke-dasharray:12.8,3.2,2,3.2;stroke-dashoffset:0;stroke-width:2;\"/>\n-   </g>\n-   <g id=\"line2d_47\">\n-    <path clip-path=\"url(#p8f0378e7d4)\" d=\"M 325.44 250.405701 \n-L 325.44 232.873412 \n-\" style=\"fill:none;stroke:#ff0000;stroke-dasharray:12.8,3.2,2,3.2;stroke-dashoffset:0;stroke-width:2;\"/>\n-   </g>\n-   <g id=\"line2d_48\">\n-    <path clip-path=\"url(#p8f0378e7d4)\" d=\"M 133.488 268.449882 \n-L 160.272 268.449882 \n-\" style=\"fill:none;stroke:#ff7f0e;stroke-linecap:square;\"/>\n-   </g>\n-   <g id=\"line2d_49\">\n-    <path clip-path=\"url(#p8f0378e7d4)\" d=\"M 133.488 268.449882 \n-L 160.272 268.449882 \n-\" style=\"fill:none;stroke:#00bfbf;stroke-dasharray:7.4,3.2;stroke-dashoffset:0;stroke-width:2;\"/>\n-   </g>\n-   <g id=\"line2d_50\">\n-    <path clip-path=\"url(#p8f0378e7d4)\" d=\"M 312.048 268.449882 \n-L 338.832 268.449882 \n-\" style=\"fill:none;stroke:#ff7f0e;stroke-linecap:square;\"/>\n-   </g>\n-   <g id=\"line2d_51\">\n-    <path clip-path=\"url(#p8f0378e7d4)\" d=\"M 312.048 268.449882 \n-L 338.832 268.449882 \n-\" style=\"fill:none;stroke:#00bfbf;stroke-dasharray:7.4,3.2;stroke-dashoffset:0;stroke-width:2;\"/>\n-   </g>\n-   <g id=\"patch_15\">\n-    <path d=\"M 57.6 307.584 \n-L 57.6 229.315765 \n-\" style=\"fill:none;stroke:#000000;stroke-linecap:square;stroke-linejoin:miter;stroke-width:0.8;\"/>\n-   </g>\n-   <g id=\"patch_16\">\n-    <path d=\"M 414.72 307.584 \n-L 414.72 229.315765 \n-\" style=\"fill:none;stroke:#000000;stroke-linecap:square;stroke-linejoin:miter;stroke-width:0.8;\"/>\n-   </g>\n-   <g id=\"patch_17\">\n-    <path d=\"M 57.6 307.584 \n-L 414.72 307.584 \n-\" style=\"fill:none;stroke:#000000;stroke-linecap:square;stroke-linejoin:miter;stroke-width:0.8;\"/>\n-   </g>\n-   <g id=\"patch_18\">\n-    <path d=\"M 57.6 229.315765 \n-L 414.72 229.315765 \n-\" style=\"fill:none;stroke:#000000;stroke-linecap:square;stroke-linejoin:miter;stroke-width:0.8;\"/>\n-   </g>\n-  </g>\n- </g>\n- <defs>\n-  <clipPath id=\"p391ee919e1\">\n-   <rect height=\"78.268235\" width=\"357.12\" x=\"57.6\" y=\"41.472\"/>\n-  </clipPath>\n-  <clipPath id=\"pc019ee541c\">\n-   <rect height=\"78.268235\" width=\"357.12\" x=\"57.6\" y=\"135.393882\"/>\n-  </clipPath>\n-  <clipPath id=\"p8f0378e7d4\">\n-   <rect height=\"78.268235\" width=\"357.12\" x=\"57.6\" y=\"229.315765\"/>\n-  </clipPath>\n- </defs>\n-</svg>\n+<?xml version=\"1.0\" encoding=\"utf-8\" standalone=\"no\"?>\r\n+<!DOCTYPE svg PUBLIC \"-//W3C//DTD SVG 1.1//EN\"\r\n+  \"http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd\">\r\n+<svg xmlns:xlink=\"http://www.w3.org/1999/xlink\" width=\"460.8pt\" height=\"345.6pt\" viewBox=\"0 0 460.8 345.6\" xmlns=\"http://www.w3.org/2000/svg\" version=\"1.1\">\r\n+ <metadata>\r\n+  <rdf:RDF xmlns:dc=\"http://purl.org/dc/elements/1.1/\" xmlns:cc=\"http://creativecommons.org/ns#\" xmlns:rdf=\"http://www.w3.org/1999/02/22-rdf-syntax-ns#\">\r\n+   <cc:Work>\r\n+    <dc:type rdf:resource=\"http://purl.org/dc/dcmitype/StillImage\"/>\r\n+    <dc:date>2024-04-17T16:38:51.018485</dc:date>\r\n+    <dc:format>image/svg+xml</dc:format>\r\n+    <dc:creator>\r\n+     <cc:Agent>\r\n+      <dc:title>Matplotlib v3.9.0.dev1517+g1fa7dd164e.d20240417, https://matplotlib.org/</dc:title>\r\n+     </cc:Agent>\r\n+    </dc:creator>\r\n+   </cc:Work>\r\n+  </rdf:RDF>\r\n+ </metadata>\r\n+ <defs>\r\n+  <style type=\"text/css\">*{stroke-linejoin: round; stroke-linecap: butt}</style>\r\n+ </defs>\r\n+ <g id=\"figure_1\">\r\n+  <g id=\"patch_1\">\r\n+   <path d=\"M 0 345.6 \r\n+L 460.8 345.6 \r\n+L 460.8 0 \r\n+L 0 0 \r\n+z\r\n+\" style=\"fill: #ffffff\"/>\r\n+  </g>\r\n+  <g id=\"axes_1\">\r\n+   <g id=\"patch_2\">\r\n+    <path d=\"M 57.6 119.740235 \r\n+L 414.72 119.740235 \r\n+L 414.72 41.472 \r\n+L 57.6 41.472 \r\n+z\r\n+\" style=\"fill: #ffffff\"/>\r\n+   </g>\r\n+   <g id=\"matplotlib.axis_1\">\r\n+    <g id=\"xtick_1\">\r\n+     <g id=\"line2d_1\">\r\n+      <defs>\r\n+       <path id=\"m93e2b2d225\" d=\"M 0 0 \r\n+L 0 3.5 \r\n+\" style=\"stroke: #000000; stroke-width: 0.8\"/>\r\n+      </defs>\r\n+      <g>\r\n+       <use xlink:href=\"#m93e2b2d225\" x=\"146.88\" y=\"119.740235\" style=\"stroke: #000000; stroke-width: 0.8\"/>\r\n+      </g>\r\n+     </g>\r\n+    </g>\r\n+    <g id=\"xtick_2\">\r\n+     <g id=\"line2d_2\">\r\n+      <g>\r\n+       <use xlink:href=\"#m93e2b2d225\" x=\"325.44\" y=\"119.740235\" style=\"stroke: #000000; stroke-width: 0.8\"/>\r\n+      </g>\r\n+     </g>\r\n+    </g>\r\n+   </g>\r\n+   <g id=\"matplotlib.axis_2\">\r\n+    <g id=\"ytick_1\">\r\n+     <g id=\"line2d_3\">\r\n+      <defs>\r\n+       <path id=\"m56d59f6c11\" d=\"M 0 0 \r\n+L -3.5 0 \r\n+\" style=\"stroke: #000000; stroke-width: 0.8\"/>\r\n+      </defs>\r\n+      <g>\r\n+       <use xlink:href=\"#m56d59f6c11\" x=\"57.6\" y=\"109.067294\" style=\"stroke: #000000; stroke-width: 0.8\"/>\r\n+      </g>\r\n+     </g>\r\n+    </g>\r\n+    <g id=\"ytick_2\">\r\n+     <g id=\"line2d_4\">\r\n+      <g>\r\n+       <use xlink:href=\"#m56d59f6c11\" x=\"57.6\" y=\"80.606118\" style=\"stroke: #000000; stroke-width: 0.8\"/>\r\n+      </g>\r\n+     </g>\r\n+    </g>\r\n+    <g id=\"ytick_3\">\r\n+     <g id=\"line2d_5\">\r\n+      <g>\r\n+       <use xlink:href=\"#m56d59f6c11\" x=\"57.6\" y=\"52.144941\" style=\"stroke: #000000; stroke-width: 0.8\"/>\r\n+      </g>\r\n+     </g>\r\n+    </g>\r\n+   </g>\r\n+   <g id=\"line2d_6\">\r\n+    <path d=\"M 133.488 85.658488 \r\n+L 160.272 85.658488 \r\n+L 160.272 82.254409 \r\n+L 153.576 80.606118 \r\n+L 160.272 78.957826 \r\n+L 160.272 75.553747 \r\n+L 133.488 75.553747 \r\n+L 133.488 78.957826 \r\n+L 140.184 80.606118 \r\n+L 133.488 82.254409 \r\n+L 133.488 85.658488 \r\n+\" clip-path=\"url(#p401fc79e44)\" style=\"fill: none; stroke-dasharray: 7.4,3.2; stroke-dashoffset: 0; stroke: #ff0000; stroke-width: 2\"/>\r\n+   </g>\r\n+   <g id=\"line2d_7\">\r\n+    <path d=\"M 146.88 85.658488 \r\n+L 146.88 89.564222 \r\n+\" clip-path=\"url(#p401fc79e44)\" style=\"fill: none; stroke: #000000; stroke-linecap: square\"/>\r\n+   </g>\r\n+   <g id=\"line2d_8\">\r\n+    <path d=\"M 146.88 75.553747 \r\n+L 146.88 71.648014 \r\n+\" clip-path=\"url(#p401fc79e44)\" style=\"fill: none; stroke: #000000; stroke-linecap: square\"/>\r\n+   </g>\r\n+   <g id=\"line2d_9\">\r\n+    <path d=\"M 140.184 89.564222 \r\n+L 153.576 89.564222 \r\n+\" clip-path=\"url(#p401fc79e44)\" style=\"fill: none; stroke-dasharray: 7.4,3.2; stroke-dashoffset: 0; stroke: #00bfbf; stroke-width: 2\"/>\r\n+   </g>\r\n+   <g id=\"line2d_10\">\r\n+    <path d=\"M 140.184 71.648014 \r\n+L 153.576 71.648014 \r\n+\" clip-path=\"url(#p401fc79e44)\" style=\"fill: none; stroke-dasharray: 7.4,3.2; stroke-dashoffset: 0; stroke: #00bfbf; stroke-width: 2\"/>\r\n+   </g>\r\n+   <g id=\"line2d_11\">\r\n+    <path d=\"M 146.88 116.182588 \r\n+L 146.88 90.567529 \r\n+L 146.88 90.4242 \r\n+L 146.88 90.28087 \r\n+L 146.88 90.13754 \r\n+L 146.88 89.994211 \r\n+L 146.88 89.850881 \r\n+L 146.88 89.707551 \r\n+L 146.88 71.504684 \r\n+L 146.88 71.361354 \r\n+L 146.88 71.218025 \r\n+L 146.88 71.074695 \r\n+L 146.88 70.931365 \r\n+L 146.88 70.788036 \r\n+L 146.88 70.644706 \r\n+L 146.88 45.029647 \r\n+\" clip-path=\"url(#p401fc79e44)\" style=\"fill: none; stroke-dasharray: 7.4,3.2; stroke-dashoffset: 0; stroke: #0000ff; stroke-width: 2\"/>\r\n+    <defs>\r\n+     <path id=\"mcc92cd54fb\" d=\"M 0 2.5 \r\n+C 0.663008 2.5 1.29895 2.236584 1.767767 1.767767 \r\n+C 2.236584 1.29895 2.5 0.663008 2.5 0 \r\n+C 2.5 -0.663008 2.236584 -1.29895 1.767767 -1.767767 \r\n+C 1.29895 -2.236584 0.663008 -2.5 0 -2.5 \r\n+C -0.663008 -2.5 -1.29895 -2.236584 -1.767767 -1.767767 \r\n+C -2.236584 -1.29895 -2.5 -0.663008 -2.5 0 \r\n+C -2.5 0.663008 -2.236584 1.29895 -1.767767 1.767767 \r\n+C -1.29895 2.236584 -0.663008 2.5 0 2.5 \r\n+z\r\n+\" style=\"stroke: #0000ff\"/>\r\n+    </defs>\r\n+    <g clip-path=\"url(#p401fc79e44)\">\r\n+     <use xlink:href=\"#mcc92cd54fb\" x=\"146.88\" y=\"116.182588\" style=\"fill: #008000; stroke: #0000ff\"/>\r\n+     <use xlink:href=\"#mcc92cd54fb\" x=\"146.88\" y=\"90.567529\" style=\"fill: #008000; stroke: #0000ff\"/>\r\n+     <use xlink:href=\"#mcc92cd54fb\" x=\"146.88\" y=\"90.4242\" style=\"fill: #008000; stroke: #0000ff\"/>\r\n+     <use xlink:href=\"#mcc92cd54fb\" x=\"146.88\" y=\"90.28087\" style=\"fill: #008000; stroke: #0000ff\"/>\r\n+     <use xlink:href=\"#mcc92cd54fb\" x=\"146.88\" y=\"90.13754\" style=\"fill: #008000; stroke: #0000ff\"/>\r\n+     <use xlink:href=\"#mcc92cd54fb\" x=\"146.88\" y=\"89.994211\" style=\"fill: #008000; stroke: #0000ff\"/>\r\n+     <use xlink:href=\"#mcc92cd54fb\" x=\"146.88\" y=\"89.850881\" style=\"fill: #008000; stroke: #0000ff\"/>\r\n+     <use xlink:href=\"#mcc92cd54fb\" x=\"146.88\" y=\"89.707551\" style=\"fill: #008000; stroke: #0000ff\"/>\r\n+     <use xlink:href=\"#mcc92cd54fb\" x=\"146.88\" y=\"71.504684\" style=\"fill: #008000; stroke: #0000ff\"/>\r\n+     <use xlink:href=\"#mcc92cd54fb\" x=\"146.88\" y=\"71.361354\" style=\"fill: #008000; stroke: #0000ff\"/>\r\n+     <use xlink:href=\"#mcc92cd54fb\" x=\"146.88\" y=\"71.218025\" style=\"fill: #008000; stroke: #0000ff\"/>\r\n+     <use xlink:href=\"#mcc92cd54fb\" x=\"146.88\" y=\"71.074695\" style=\"fill: #008000; stroke: #0000ff\"/>\r\n+     <use xlink:href=\"#mcc92cd54fb\" x=\"146.88\" y=\"70.931365\" style=\"fill: #008000; stroke: #0000ff\"/>\r\n+     <use xlink:href=\"#mcc92cd54fb\" x=\"146.88\" y=\"70.788036\" style=\"fill: #008000; stroke: #0000ff\"/>\r\n+     <use xlink:href=\"#mcc92cd54fb\" x=\"146.88\" y=\"70.644706\" style=\"fill: #008000; stroke: #0000ff\"/>\r\n+     <use xlink:href=\"#mcc92cd54fb\" x=\"146.88\" y=\"45.029647\" style=\"fill: #008000; stroke: #0000ff\"/>\r\n+    </g>\r\n+   </g>\r\n+   <g id=\"line2d_12\">\r\n+    <path d=\"M 312.048 85.658488 \r\n+L 338.832 85.658488 \r\n+L 338.832 82.254409 \r\n+L 332.136 80.606118 \r\n+L 338.832 78.957826 \r\n+L 338.832 75.553747 \r\n+L 312.048 75.553747 \r\n+L 312.048 78.957826 \r\n+L 318.744 80.606118 \r\n+L 312.048 82.254409 \r\n+L 312.048 85.658488 \r\n+\" clip-path=\"url(#p401fc79e44)\" style=\"fill: none; stroke-dasharray: 7.4,3.2; stroke-dashoffset: 0; stroke: #ff0000; stroke-width: 2\"/>\r\n+   </g>\r\n+   <g id=\"line2d_13\">\r\n+    <path d=\"M 325.44 85.658488 \r\n+L 325.44 89.564222 \r\n+\" clip-path=\"url(#p401fc79e44)\" style=\"fill: none; stroke: #000000; stroke-linecap: square\"/>\r\n+   </g>\r\n+   <g id=\"line2d_14\">\r\n+    <path d=\"M 325.44 75.553747 \r\n+L 325.44 71.648014 \r\n+\" clip-path=\"url(#p401fc79e44)\" style=\"fill: none; stroke: #000000; stroke-linecap: square\"/>\r\n+   </g>\r\n+   <g id=\"line2d_15\">\r\n+    <path d=\"M 318.744 89.564222 \r\n+L 332.136 89.564222 \r\n+\" clip-path=\"url(#p401fc79e44)\" style=\"fill: none; stroke-dasharray: 7.4,3.2; stroke-dashoffset: 0; stroke: #00bfbf; stroke-width: 2\"/>\r\n+   </g>\r\n+   <g id=\"line2d_16\">\r\n+    <path d=\"M 318.744 71.648014 \r\n+L 332.136 71.648014 \r\n+\" clip-path=\"url(#p401fc79e44)\" style=\"fill: none; stroke-dasharray: 7.4,3.2; stroke-dashoffset: 0; stroke: #00bfbf; stroke-width: 2\"/>\r\n+   </g>\r\n+   <g id=\"line2d_17\">\r\n+    <path d=\"M 325.44 116.182588 \r\n+L 325.44 90.567529 \r\n+L 325.44 90.4242 \r\n+L 325.44 90.28087 \r\n+L 325.44 90.13754 \r\n+L 325.44 89.994211 \r\n+L 325.44 89.850881 \r\n+L 325.44 89.707551 \r\n+L 325.44 71.504684 \r\n+L 325.44 71.361354 \r\n+L 325.44 71.218025 \r\n+L 325.44 71.074695 \r\n+L 325.44 70.931365 \r\n+L 325.44 70.788036 \r\n+L 325.44 70.644706 \r\n+L 325.44 45.029647 \r\n+\" clip-path=\"url(#p401fc79e44)\" style=\"fill: none; stroke-dasharray: 7.4,3.2; stroke-dashoffset: 0; stroke: #0000ff; stroke-width: 2\"/>\r\n+    <g clip-path=\"url(#p401fc79e44)\">\r\n+     <use xlink:href=\"#mcc92cd54fb\" x=\"325.44\" y=\"116.182588\" style=\"fill: #008000; stroke: #0000ff\"/>\r\n+     <use xlink:href=\"#mcc92cd54fb\" x=\"325.44\" y=\"90.567529\" style=\"fill: #008000; stroke: #0000ff\"/>\r\n+     <use xlink:href=\"#mcc92cd54fb\" x=\"325.44\" y=\"90.4242\" style=\"fill: #008000; stroke: #0000ff\"/>\r\n+     <use xlink:href=\"#mcc92cd54fb\" x=\"325.44\" y=\"90.28087\" style=\"fill: #008000; stroke: #0000ff\"/>\r\n+     <use xlink:href=\"#mcc92cd54fb\" x=\"325.44\" y=\"90.13754\" style=\"fill: #008000; stroke: #0000ff\"/>\r\n+     <use xlink:href=\"#mcc92cd54fb\" x=\"325.44\" y=\"89.994211\" style=\"fill: #008000; stroke: #0000ff\"/>\r\n+     <use xlink:href=\"#mcc92cd54fb\" x=\"325.44\" y=\"89.850881\" style=\"fill: #008000; stroke: #0000ff\"/>\r\n+     <use xlink:href=\"#mcc92cd54fb\" x=\"325.44\" y=\"89.707551\" style=\"fill: #008000; stroke: #0000ff\"/>\r\n+     <use xlink:href=\"#mcc92cd54fb\" x=\"325.44\" y=\"71.504684\" style=\"fill: #008000; stroke: #0000ff\"/>\r\n+     <use xlink:href=\"#mcc92cd54fb\" x=\"325.44\" y=\"71.361354\" style=\"fill: #008000; stroke: #0000ff\"/>\r\n+     <use xlink:href=\"#mcc92cd54fb\" x=\"325.44\" y=\"71.218025\" style=\"fill: #008000; stroke: #0000ff\"/>\r\n+     <use xlink:href=\"#mcc92cd54fb\" x=\"325.44\" y=\"71.074695\" style=\"fill: #008000; stroke: #0000ff\"/>\r\n+     <use xlink:href=\"#mcc92cd54fb\" x=\"325.44\" y=\"70.931365\" style=\"fill: #008000; stroke: #0000ff\"/>\r\n+     <use xlink:href=\"#mcc92cd54fb\" x=\"325.44\" y=\"70.788036\" style=\"fill: #008000; stroke: #0000ff\"/>\r\n+     <use xlink:href=\"#mcc92cd54fb\" x=\"325.44\" y=\"70.644706\" style=\"fill: #008000; stroke: #0000ff\"/>\r\n+     <use xlink:href=\"#mcc92cd54fb\" x=\"325.44\" y=\"45.029647\" style=\"fill: #008000; stroke: #0000ff\"/>\r\n+    </g>\r\n+   </g>\r\n+   <g id=\"line2d_18\">\r\n+    <path d=\"M 140.184 80.606118 \r\n+L 153.576 80.606118 \r\n+\" clip-path=\"url(#p401fc79e44)\" style=\"fill: none; stroke-dasharray: 7.4,3.2; stroke-dashoffset: 0; stroke: #000000; stroke-width: 2\"/>\r\n+   </g>\r\n+   <g id=\"line2d_19\">\r\n+    <path d=\"M 318.744 80.606118 \r\n+L 332.136 80.606118 \r\n+\" clip-path=\"url(#p401fc79e44)\" style=\"fill: none; stroke-dasharray: 7.4,3.2; stroke-dashoffset: 0; stroke: #000000; stroke-width: 2\"/>\r\n+   </g>\r\n+   <g id=\"patch_3\">\r\n+    <path d=\"M 57.6 119.740235 \r\n+L 57.6 41.472 \r\n+\" style=\"fill: none; stroke: #000000; stroke-width: 0.8; stroke-linejoin: miter; stroke-linecap: square\"/>\r\n+   </g>\r\n+   <g id=\"patch_4\">\r\n+    <path d=\"M 414.72 119.740235 \r\n+L 414.72 41.472 \r\n+\" style=\"fill: none; stroke: #000000; stroke-width: 0.8; stroke-linejoin: miter; stroke-linecap: square\"/>\r\n+   </g>\r\n+   <g id=\"patch_5\">\r\n+    <path d=\"M 57.6 119.740235 \r\n+L 414.72 119.740235 \r\n+\" style=\"fill: none; stroke: #000000; stroke-width: 0.8; stroke-linejoin: miter; stroke-linecap: square\"/>\r\n+   </g>\r\n+   <g id=\"patch_6\">\r\n+    <path d=\"M 57.6 41.472 \r\n+L 414.72 41.472 \r\n+\" style=\"fill: none; stroke: #000000; stroke-width: 0.8; stroke-linejoin: miter; stroke-linecap: square\"/>\r\n+   </g>\r\n+  </g>\r\n+  <g id=\"axes_2\">\r\n+   <g id=\"patch_7\">\r\n+    <path d=\"M 57.6 213.662118 \r\n+L 414.72 213.662118 \r\n+L 414.72 135.393882 \r\n+L 57.6 135.393882 \r\n+z\r\n+\" style=\"fill: #ffffff\"/>\r\n+   </g>\r\n+   <g id=\"matplotlib.axis_3\">\r\n+    <g id=\"xtick_3\">\r\n+     <g id=\"line2d_20\">\r\n+      <g>\r\n+       <use xlink:href=\"#m93e2b2d225\" x=\"146.88\" y=\"213.662118\" style=\"stroke: #000000; stroke-width: 0.8\"/>\r\n+      </g>\r\n+     </g>\r\n+    </g>\r\n+    <g id=\"xtick_4\">\r\n+     <g id=\"line2d_21\">\r\n+      <g>\r\n+       <use xlink:href=\"#m93e2b2d225\" x=\"325.44\" y=\"213.662118\" style=\"stroke: #000000; stroke-width: 0.8\"/>\r\n+      </g>\r\n+     </g>\r\n+    </g>\r\n+   </g>\r\n+   <g id=\"matplotlib.axis_4\">\r\n+    <g id=\"ytick_4\">\r\n+     <g id=\"line2d_22\">\r\n+      <g>\r\n+       <use xlink:href=\"#m56d59f6c11\" x=\"57.6\" y=\"202.989176\" style=\"stroke: #000000; stroke-width: 0.8\"/>\r\n+      </g>\r\n+     </g>\r\n+    </g>\r\n+    <g id=\"ytick_5\">\r\n+     <g id=\"line2d_23\">\r\n+      <g>\r\n+       <use xlink:href=\"#m56d59f6c11\" x=\"57.6\" y=\"174.528\" style=\"stroke: #000000; stroke-width: 0.8\"/>\r\n+      </g>\r\n+     </g>\r\n+    </g>\r\n+    <g id=\"ytick_6\">\r\n+     <g id=\"line2d_24\">\r\n+      <g>\r\n+       <use xlink:href=\"#m56d59f6c11\" x=\"57.6\" y=\"146.066824\" style=\"stroke: #000000; stroke-width: 0.8\"/>\r\n+      </g>\r\n+     </g>\r\n+    </g>\r\n+   </g>\r\n+   <g id=\"patch_8\">\r\n+    <path d=\"M 133.488 179.580371 \r\n+L 160.272 179.580371 \r\n+L 160.272 169.475629 \r\n+L 133.488 169.475629 \r\n+L 133.488 179.580371 \r\n+z\r\n+\" clip-path=\"url(#p9453a161d5)\" style=\"fill: #1f77b4; stroke: #000000; stroke-linejoin: miter\"/>\r\n+   </g>\r\n+   <g id=\"line2d_25\">\r\n+    <path d=\"M 146.88 179.580371 \r\n+L 146.88 210.104471 \r\n+\" clip-path=\"url(#p9453a161d5)\" style=\"fill: none; stroke: #000000; stroke-linecap: square\"/>\r\n+   </g>\r\n+   <g id=\"line2d_26\">\r\n+    <path d=\"M 146.88 169.475629 \r\n+L 146.88 138.951529 \r\n+\" clip-path=\"url(#p9453a161d5)\" style=\"fill: none; stroke: #000000; stroke-linecap: square\"/>\r\n+   </g>\r\n+   <g id=\"line2d_27\">\r\n+    <path d=\"M 140.184 210.104471 \r\n+L 153.576 210.104471 \r\n+\" clip-path=\"url(#p9453a161d5)\" style=\"fill: none; stroke: #000000; stroke-linecap: square\"/>\r\n+   </g>\r\n+   <g id=\"line2d_28\">\r\n+    <path d=\"M 140.184 138.951529 \r\n+L 153.576 138.951529 \r\n+\" clip-path=\"url(#p9453a161d5)\" style=\"fill: none; stroke: #000000; stroke-linecap: square\"/>\r\n+   </g>\r\n+   <g id=\"line2d_29\"/>\r\n+   <g id=\"patch_9\">\r\n+    <path d=\"M 312.048 179.580371 \r\n+L 338.832 179.580371 \r\n+L 338.832 169.475629 \r\n+L 312.048 169.475629 \r\n+L 312.048 179.580371 \r\n+z\r\n+\" clip-path=\"url(#p9453a161d5)\" style=\"fill: #1f77b4; stroke: #000000; stroke-linejoin: miter\"/>\r\n+   </g>\r\n+   <g id=\"line2d_30\">\r\n+    <path d=\"M 325.44 179.580371 \r\n+L 325.44 210.104471 \r\n+\" clip-path=\"url(#p9453a161d5)\" style=\"fill: none; stroke: #000000; stroke-linecap: square\"/>\r\n+   </g>\r\n+   <g id=\"line2d_31\">\r\n+    <path d=\"M 325.44 169.475629 \r\n+L 325.44 138.951529 \r\n+\" clip-path=\"url(#p9453a161d5)\" style=\"fill: none; stroke: #000000; stroke-linecap: square\"/>\r\n+   </g>\r\n+   <g id=\"line2d_32\">\r\n+    <path d=\"M 318.744 210.104471 \r\n+L 332.136 210.104471 \r\n+\" clip-path=\"url(#p9453a161d5)\" style=\"fill: none; stroke: #000000; stroke-linecap: square\"/>\r\n+   </g>\r\n+   <g id=\"line2d_33\">\r\n+    <path d=\"M 318.744 138.951529 \r\n+L 332.136 138.951529 \r\n+\" clip-path=\"url(#p9453a161d5)\" style=\"fill: none; stroke: #000000; stroke-linecap: square\"/>\r\n+   </g>\r\n+   <g id=\"line2d_34\"/>\r\n+   <g id=\"line2d_35\">\r\n+    <path d=\"M 133.488 174.528 \r\n+L 160.272 174.528 \r\n+\" clip-path=\"url(#p9453a161d5)\" style=\"fill: none; stroke: #ff7f0e\"/>\r\n+   </g>\r\n+   <g id=\"line2d_36\">\r\n+    <path d=\"M 312.048 174.528 \r\n+L 338.832 174.528 \r\n+\" clip-path=\"url(#p9453a161d5)\" style=\"fill: none; stroke: #ff7f0e\"/>\r\n+   </g>\r\n+   <g id=\"patch_10\">\r\n+    <path d=\"M 57.6 213.662118 \r\n+L 57.6 135.393882 \r\n+\" style=\"fill: none; stroke: #000000; stroke-width: 0.8; stroke-linejoin: miter; stroke-linecap: square\"/>\r\n+   </g>\r\n+   <g id=\"patch_11\">\r\n+    <path d=\"M 414.72 213.662118 \r\n+L 414.72 135.393882 \r\n+\" style=\"fill: none; stroke: #000000; stroke-width: 0.8; stroke-linejoin: miter; stroke-linecap: square\"/>\r\n+   </g>\r\n+   <g id=\"patch_12\">\r\n+    <path d=\"M 57.6 213.662118 \r\n+L 414.72 213.662118 \r\n+\" style=\"fill: none; stroke: #000000; stroke-width: 0.8; stroke-linejoin: miter; stroke-linecap: square\"/>\r\n+   </g>\r\n+   <g id=\"patch_13\">\r\n+    <path d=\"M 57.6 135.393882 \r\n+L 414.72 135.393882 \r\n+\" style=\"fill: none; stroke: #000000; stroke-width: 0.8; stroke-linejoin: miter; stroke-linecap: square\"/>\r\n+   </g>\r\n+  </g>\r\n+  <g id=\"axes_3\">\r\n+   <g id=\"patch_14\">\r\n+    <path d=\"M 57.6 307.584 \r\n+L 414.72 307.584 \r\n+L 414.72 229.315765 \r\n+L 57.6 229.315765 \r\n+z\r\n+\" style=\"fill: #ffffff\"/>\r\n+   </g>\r\n+   <g id=\"matplotlib.axis_5\">\r\n+    <g id=\"xtick_5\">\r\n+     <g id=\"line2d_37\">\r\n+      <g>\r\n+       <use xlink:href=\"#m93e2b2d225\" x=\"146.88\" y=\"307.584\" style=\"stroke: #000000; stroke-width: 0.8\"/>\r\n+      </g>\r\n+     </g>\r\n+    </g>\r\n+    <g id=\"xtick_6\">\r\n+     <g id=\"line2d_38\">\r\n+      <g>\r\n+       <use xlink:href=\"#m93e2b2d225\" x=\"325.44\" y=\"307.584\" style=\"stroke: #000000; stroke-width: 0.8\"/>\r\n+      </g>\r\n+     </g>\r\n+    </g>\r\n+   </g>\r\n+   <g id=\"matplotlib.axis_6\">\r\n+    <g id=\"ytick_7\">\r\n+     <g id=\"line2d_39\">\r\n+      <g>\r\n+       <use xlink:href=\"#m56d59f6c11\" x=\"57.6\" y=\"293.861647\" style=\"stroke: #000000; stroke-width: 0.8\"/>\r\n+      </g>\r\n+     </g>\r\n+    </g>\r\n+    <g id=\"ytick_8\">\r\n+     <g id=\"line2d_40\">\r\n+      <g>\r\n+       <use xlink:href=\"#m56d59f6c11\" x=\"57.6\" y=\"268.449882\" style=\"stroke: #000000; stroke-width: 0.8\"/>\r\n+      </g>\r\n+     </g>\r\n+    </g>\r\n+    <g id=\"ytick_9\">\r\n+     <g id=\"line2d_41\">\r\n+      <g>\r\n+       <use xlink:href=\"#m56d59f6c11\" x=\"57.6\" y=\"243.038118\" style=\"stroke: #000000; stroke-width: 0.8\"/>\r\n+      </g>\r\n+     </g>\r\n+    </g>\r\n+   </g>\r\n+   <g id=\"line2d_42\">\r\n+    <path d=\"M 146.88 286.494063 \r\n+L 146.88 304.026353 \r\n+\" clip-path=\"url(#p6bd38583d9)\" style=\"fill: none; stroke-dasharray: 12.8,3.2,2,3.2; stroke-dashoffset: 0; stroke: #ff0000; stroke-width: 2\"/>\r\n+   </g>\r\n+   <g id=\"line2d_43\">\r\n+    <path d=\"M 146.88 250.405701 \r\n+L 146.88 232.873412 \r\n+\" clip-path=\"url(#p6bd38583d9)\" style=\"fill: none; stroke-dasharray: 12.8,3.2,2,3.2; stroke-dashoffset: 0; stroke: #ff0000; stroke-width: 2\"/>\r\n+   </g>\r\n+   <g id=\"line2d_44\">\r\n+    <path d=\"M 325.44 286.494063 \r\n+L 325.44 304.026353 \r\n+\" clip-path=\"url(#p6bd38583d9)\" style=\"fill: none; stroke-dasharray: 12.8,3.2,2,3.2; stroke-dashoffset: 0; stroke: #ff0000; stroke-width: 2\"/>\r\n+   </g>\r\n+   <g id=\"line2d_45\">\r\n+    <path d=\"M 325.44 250.405701 \r\n+L 325.44 232.873412 \r\n+\" clip-path=\"url(#p6bd38583d9)\" style=\"fill: none; stroke-dasharray: 12.8,3.2,2,3.2; stroke-dashoffset: 0; stroke: #ff0000; stroke-width: 2\"/>\r\n+   </g>\r\n+   <g id=\"line2d_46\">\r\n+    <path d=\"M 133.488 268.449882 \r\n+L 160.272 268.449882 \r\n+\" clip-path=\"url(#p6bd38583d9)\" style=\"fill: none; stroke: #ff7f0e\"/>\r\n+   </g>\r\n+   <g id=\"line2d_47\">\r\n+    <path d=\"M 133.488 268.449882 \r\n+L 160.272 268.449882 \r\n+\" clip-path=\"url(#p6bd38583d9)\" style=\"fill: none; stroke-dasharray: 7.4,3.2; stroke-dashoffset: 0; stroke: #00bfbf; stroke-width: 2\"/>\r\n+   </g>\r\n+   <g id=\"line2d_48\">\r\n+    <path d=\"M 312.048 268.449882 \r\n+L 338.832 268.449882 \r\n+\" clip-path=\"url(#p6bd38583d9)\" style=\"fill: none; stroke: #ff7f0e\"/>\r\n+   </g>\r\n+   <g id=\"line2d_49\">\r\n+    <path d=\"M 312.048 268.449882 \r\n+L 338.832 268.449882 \r\n+\" clip-path=\"url(#p6bd38583d9)\" style=\"fill: none; stroke-dasharray: 7.4,3.2; stroke-dashoffset: 0; stroke: #00bfbf; stroke-width: 2\"/>\r\n+   </g>\r\n+   <g id=\"patch_15\">\r\n+    <path d=\"M 57.6 307.584 \r\n+L 57.6 229.315765 \r\n+\" style=\"fill: none; stroke: #000000; stroke-width: 0.8; stroke-linejoin: miter; stroke-linecap: square\"/>\r\n+   </g>\r\n+   <g id=\"patch_16\">\r\n+    <path d=\"M 414.72 307.584 \r\n+L 414.72 229.315765 \r\n+\" style=\"fill: none; stroke: #000000; stroke-width: 0.8; stroke-linejoin: miter; stroke-linecap: square\"/>\r\n+   </g>\r\n+   <g id=\"patch_17\">\r\n+    <path d=\"M 57.6 307.584 \r\n+L 414.72 307.584 \r\n+\" style=\"fill: none; stroke: #000000; stroke-width: 0.8; stroke-linejoin: miter; stroke-linecap: square\"/>\r\n+   </g>\r\n+   <g id=\"patch_18\">\r\n+    <path d=\"M 57.6 229.315765 \r\n+L 414.72 229.315765 \r\n+\" style=\"fill: none; stroke: #000000; stroke-width: 0.8; stroke-linejoin: miter; stroke-linecap: square\"/>\r\n+   </g>\r\n+  </g>\r\n+ </g>\r\n+ <defs>\r\n+  <clipPath id=\"p401fc79e44\">\r\n+   <rect x=\"57.6\" y=\"41.472\" width=\"357.12\" height=\"78.268235\"/>\r\n+  </clipPath>\r\n+  <clipPath id=\"p9453a161d5\">\r\n+   <rect x=\"57.6\" y=\"135.393882\" width=\"357.12\" height=\"78.268235\"/>\r\n+  </clipPath>\r\n+  <clipPath id=\"p6bd38583d9\">\r\n+   <rect x=\"57.6\" y=\"229.315765\" width=\"357.12\" height=\"78.268235\"/>\r\n+  </clipPath>\r\n+ </defs>\r\n+</svg>\r\ndiff --git a/lib/matplotlib/tests/test_axes.py b/lib/matplotlib/tests/test_axes.py\nindex c48519377290..ef0b7c7db29e 100644\n--- a/lib/matplotlib/tests/test_axes.py\n+++ b/lib/matplotlib/tests/test_axes.py\n@@ -3186,7 +3186,7 @@ def _bxp_test_helper(\n     logstats = mpl.cbook.boxplot_stats(\n         np.random.lognormal(mean=1.25, sigma=1., size=(37, 4)), **stats_kwargs)\n     fig, ax = plt.subplots()\n-    if bxp_kwargs.get('vert', True):\n+    if bxp_kwargs.get('orientation', 'vertical') == 'vertical':\n         ax.set_yscale('log')\n     else:\n         ax.set_xscale('log')\n@@ -3237,7 +3237,7 @@ def transform(stats):\n                   style='default',\n                   tol=0.1)\n def test_bxp_horizontal():\n-    _bxp_test_helper(bxp_kwargs=dict(vert=False))\n+    _bxp_test_helper(bxp_kwargs=dict(orientation='horizontal'))\n \n \n @image_comparison(['bxp_with_ylabels.png'],\n@@ -3250,7 +3250,8 @@ def transform(stats):\n             s['label'] = label\n         return stats\n \n-    _bxp_test_helper(transform_stats=transform, bxp_kwargs=dict(vert=False))\n+    _bxp_test_helper(transform_stats=transform,\n+                     bxp_kwargs=dict(orientation='horizontal'))\n \n \n @image_comparison(['bxp_patchartist.png'],\n@@ -3579,7 +3580,6 @@ def test_boxplot_rc_parameters():\n     }\n \n     rc_axis1 = {\n-        'boxplot.vertical': False,\n         'boxplot.whiskers': [0, 100],\n         'boxplot.patchartist': True,\n     }\n@@ -9102,3 +9102,42 @@ def test_violinplot_orientation(fig_test, fig_ref):\n \n         ax_test = fig_test.subplots()\n         ax_test.violinplot(all_data, orientation='horizontal')\n+\n+\n+@check_figures_equal(extensions=['png'])\n+def test_boxplot_orientation(fig_test, fig_ref):\n+    # Test the `orientation : {'vertical', 'horizontal'}`\n+    # parameter and deprecation of `vert: bool`.\n+    fig, axs = plt.subplots(nrows=1, ncols=2)\n+    np.random.seed(19680801)\n+    all_data = [np.random.normal(0, std, 100) for std in range(6, 10)]\n+\n+    axs[0].boxplot(all_data)  # Default vertical plot.\n+    # xticks and yticks should be at their default position.\n+    assert all(axs[0].get_xticks() == np.array(\n+        [1, 2, 3, 4]))\n+    assert all(axs[0].get_yticks() == np.array(\n+        [-30., -20., -10., 0., 10., 20., 30.]))\n+\n+    # Horizontal plot using new `orientation` keyword.\n+    axs[1].boxplot(all_data, orientation='horizontal')\n+    # xticks and yticks should be swapped.\n+    assert all(axs[1].get_xticks() == np.array(\n+        [-30., -20., -10., 0., 10., 20., 30.]))\n+    assert all(axs[1].get_yticks() == np.array(\n+        [1, 2, 3, 4]))\n+\n+    plt.close()\n+\n+    # Deprecation of `vert: bool` keyword and\n+    # 'boxplot.vertical' rcparam.\n+    with pytest.warns(mpl.MatplotlibDeprecationWarning,\n+                      match='was deprecated in Matplotlib 3.10'):\n+        # Compare images between a figure that\n+        # uses vert and one that uses orientation.\n+        with mpl.rc_context({'boxplot.vertical': False}):\n+            ax_ref = fig_ref.subplots()\n+            ax_ref.boxplot(all_data)\n+\n+        ax_test = fig_test.subplots()\n+        ax_test.boxplot(all_data, orientation='horizontal')\ndiff --git a/lib/matplotlib/tests/test_datetime.py b/lib/matplotlib/tests/test_datetime.py\nindex 4b693eb7d1ca..276056d044ae 100644\n--- a/lib/matplotlib/tests/test_datetime.py\n+++ b/lib/matplotlib/tests/test_datetime.py\n@@ -255,7 +255,7 @@ def test_bxp(self):\n                 datetime.datetime(2020, 1, 27)\n             ]\n         }]\n-        ax.bxp(data, vert=False)\n+        ax.bxp(data, orientation='horizontal')\n         ax.xaxis.set_major_formatter(mpl.dates.DateFormatter(\"%Y-%m-%d\"))\n         ax.set_title('Box plot with datetime data')\n \n", "problem_statement": "boxplot/violinplot orientation-setting API\n<!--To help us understand and resolve your issue, please fill out the form to the best of your ability.-->\r\n<!--You can feel free to delete the sections that do not apply.-->\r\n\r\n### Bug report\r\n\r\n**Bug summary**\r\n\r\nCurrently, boxplot(), bxp(), violin(), and violinplot() take a `vert: bool` argument to switch between vertical and horizontal; this is inconsistent with colorbar(), hist(), eventplot(), and Slider(), which take an `orientation: {\"vertical\", \"horizontal\"}` argument.\r\n\r\nFor consistency, I'd suggest adding support for `orientation` (both because I think colorbar() and hist(), in particular, are probably the most used among all these, and because I like the API better :-)), and later deprecate `vert`.  Thoughts?\r\n\r\nattn @phobson who has been involved in boxplots, IIRC.\n", "hints_text": "I think this is a good idea.\r\n\r\nShould be easy enough to capture `vert`, emit and deprecation warning, and then set `orientation` accordingly.\n(and while we're at it, the manage_xticks arg should be renamed to manage_ticks, as it covers both orientations)\njust throwing this out there: what would you say to `manage_labels`?\nwell technically it's managing ticks, tick labels, *and axis limits* so I think manage_labels is worse than manage_ticks, and perhaps manage_axis is better?\r\nI also wonder whether it really needs to manage axis limits -- can't the standard margins system do that just as well?  (needs to be investigated)\ngood points all around.\r\n\r\njust noticed a wrinkle: `boxplot.vert` is an rcParam\nWe know how to handle deprecation/renaming of rcParams too, but thanks for pointing that out.\nThis issue has been marked \"inactive\" because it has been 365 days since the last comment. If this issue is still present in recent Matplotlib releases, or the feature request is still wanted, please leave a comment and this label will be removed. If there are no updates in another 30 days, this issue will be automatically closed, but you are free to re-open or create a new issue if needed. We value issue reports, and this procedure is meant to help us resurface and prioritize issues that have not been addressed yet, not make them disappear.  Thanks for your help!\nAt least adding orientation should hopefully be uncontroversial.\nWould you want separate PRs for `boxplot` and `violinplot` to keep it simple? The review process for the `boxplot` section will probably take a bit longer because it involves the deprecation of an rcParam which Ive never done before.\nShould we simply deprecate the `boxplot.vert` rcParams without replacement? This is more of a plot-type setting rather than style. It\u2019s not useful as a global config or style parameter. The only use case would be a local context (e.g. via a context manager) if somebody wants to make multiple horizontal plots. But for that rare case using the parameter explicitly may be good enough and is more clear for the reader.\r\n\r\nI believe, we also don\u2019t have that config for `bar()` or `hist()`.\n> Should we simply deprecate the `boxplot.vert` rcParams without replacement? [snip] I believe, we also don\u2019t have that config for bar() or hist()\r\n\r\nI think that's a good idea and the justification is solid, IMO\r\n", "created_at": "2024-04-14T05:43:46Z"}
{"repo": "matplotlib/matplotlib", "pull_number": 28073, "instance_id": "matplotlib__matplotlib-28073", "issue_numbers": ["26718", "0000"], "base_commit": "f5067c16757f4cd800ae3ba0ac25ff79d2e41a7f", "patch": "diff --git a/doc/users/next_whats_new/histogram_vectorized_parameters.rst b/doc/users/next_whats_new/histogram_vectorized_parameters.rst\nnew file mode 100644\nindex 000000000000..7b9c04e71739\n--- /dev/null\n+++ b/doc/users/next_whats_new/histogram_vectorized_parameters.rst\n@@ -0,0 +1,46 @@\n+Vectorized ``hist`` style parameters\n+------------------------------------\n+\n+The parameters *hatch*, *edgecolor*, *facecolor*, *linewidth* and *linestyle*\n+of the `~matplotlib.axes.Axes.hist` method are now vectorized.\n+This means that you can pass in individual parameters for each histogram\n+when the input *x* has multiple datasets.\n+\n+\n+.. plot::\n+    :include-source: true\n+    :alt: Four charts, each displaying stacked histograms of three Poisson distributions. Each chart differentiates the histograms using various parameters: top left uses different linewidths, top right uses different hatches, bottom left uses different edgecolors, and bottom right uses different facecolors. Each histogram on the left side also has a different edgecolor.\n+\n+    import matplotlib.pyplot as plt\n+    import numpy as np\n+    np.random.seed(19680801)\n+\n+    fig, ((ax1, ax2), (ax3, ax4)) = plt.subplots(2, 2, figsize=(9, 9))\n+\n+    data1 = np.random.poisson(5, 1000)\n+    data2 = np.random.poisson(7, 1000)\n+    data3 = np.random.poisson(10, 1000)\n+\n+    labels = [\"Data 1\", \"Data 2\", \"Data 3\"]\n+\n+    ax1.hist([data1, data2, data3], bins=range(17), histtype=\"step\", stacked=True,\n+             edgecolor=[\"red\", \"green\", \"blue\"], linewidth=[1, 2, 3])\n+    ax1.set_title(\"Different linewidths\")\n+    ax1.legend(labels)\n+\n+    ax2.hist([data1, data2, data3], bins=range(17), histtype=\"barstacked\",\n+             hatch=[\"/\", \".\", \"*\"])\n+    ax2.set_title(\"Different hatch patterns\")\n+    ax2.legend(labels)\n+\n+    ax3.hist([data1, data2, data3], bins=range(17), histtype=\"bar\", fill=False,\n+             edgecolor=[\"red\", \"green\", \"blue\"], linestyle=[\"--\", \"-.\", \":\"])\n+    ax3.set_title(\"Different linestyles\")\n+    ax3.legend(labels)\n+\n+    ax4.hist([data1, data2, data3], bins=range(17), histtype=\"barstacked\",\n+             facecolor=[\"red\", \"green\", \"blue\"])\n+    ax4.set_title(\"Different facecolors\")\n+    ax4.legend(labels)\n+\n+    plt.show()\ndiff --git a/galleries/examples/statistics/histogram_multihist.py b/galleries/examples/statistics/histogram_multihist.py\nindex f1957dc38939..b9a9c5f0bf26 100644\n--- a/galleries/examples/statistics/histogram_multihist.py\n+++ b/galleries/examples/statistics/histogram_multihist.py\n@@ -15,7 +15,7 @@\n select these parameters:\n http://docs.astropy.org/en/stable/visualization/histogram.html\n \"\"\"\n-\n+# %%\n import matplotlib.pyplot as plt\n import numpy as np\n \n@@ -45,6 +45,94 @@\n fig.tight_layout()\n plt.show()\n \n+# %%\n+# -----------------------------------\n+# Setting properties for each dataset\n+# -----------------------------------\n+#\n+# You can style the histograms individually by passing a list of values to the\n+# following parameters:\n+#\n+# * edgecolor\n+# * facecolor\n+# * hatch\n+# * linewidth\n+# * linestyle\n+#\n+#\n+# edgecolor\n+# .........\n+\n+fig, ax = plt.subplots()\n+\n+edgecolors = ['green', 'red', 'blue']\n+\n+ax.hist(x, n_bins, fill=False, histtype=\"step\", stacked=True,\n+        edgecolor=edgecolors, label=edgecolors)\n+ax.legend()\n+ax.set_title('Stacked Steps with Edgecolors')\n+\n+plt.show()\n+\n+# %%\n+# facecolor\n+# .........\n+\n+fig, ax = plt.subplots()\n+\n+facecolors = ['green', 'red', 'blue']\n+\n+ax.hist(x, n_bins, histtype=\"barstacked\", facecolor=facecolors, label=facecolors)\n+ax.legend()\n+ax.set_title(\"Bars with different Facecolors\")\n+\n+plt.show()\n+\n+# %%\n+# hatch\n+# .....\n+\n+fig, ax = plt.subplots()\n+\n+hatches = [\".\", \"o\", \"x\"]\n+\n+ax.hist(x, n_bins, histtype=\"barstacked\", hatch=hatches, label=hatches)\n+ax.legend()\n+ax.set_title(\"Hatches on Stacked Bars\")\n+\n+plt.show()\n+\n+# %%\n+# linewidth\n+# .........\n+\n+fig, ax = plt.subplots()\n+\n+linewidths = [1, 2, 3]\n+edgecolors = [\"green\", \"red\", \"blue\"]\n+\n+ax.hist(x, n_bins, fill=False, histtype=\"bar\", linewidth=linewidths,\n+        edgecolor=edgecolors, label=linewidths)\n+ax.legend()\n+ax.set_title(\"Bars with Linewidths\")\n+\n+plt.show()\n+\n+# %%\n+# linestyle\n+# .........\n+\n+fig, ax = plt.subplots()\n+\n+linestyles = ['-', ':', '--']\n+\n+ax.hist(x, n_bins, fill=False, histtype='bar', linestyle=linestyles,\n+        edgecolor=edgecolors, label=linestyles)\n+ax.legend()\n+ax.set_title('Bars with Linestyles')\n+\n+plt.show()\n+\n # %%\n #\n # .. admonition:: References\ndiff --git a/lib/matplotlib/axes/_axes.py b/lib/matplotlib/axes/_axes.py\nindex 52c99b125d36..07393b1028d2 100644\n--- a/lib/matplotlib/axes/_axes.py\n+++ b/lib/matplotlib/axes/_axes.py\n@@ -6937,7 +6937,13 @@ def hist(self, x, bins=None, range=None, density=False, weights=None,\n             DATA_PARAMETER_PLACEHOLDER\n \n         **kwargs\n-            `~matplotlib.patches.Patch` properties\n+            `~matplotlib.patches.Patch` properties. The following properties\n+            additionally accept a sequence of values corresponding to the\n+            datasets in *x*:\n+            *edgecolors*, *facecolors*, *lines*, *linestyles*, *hatches*.\n+\n+            .. versionadded:: 3.10\n+               Allowing sequences of values in above listed Patch properties.\n \n         See Also\n         --------\n@@ -7210,15 +7216,35 @@ def hist(self, x, bins=None, range=None, density=False, weights=None,\n         # If None, make all labels None (via zip_longest below); otherwise,\n         # cast each element to str, but keep a single str as it.\n         labels = [] if label is None else np.atleast_1d(np.asarray(label, str))\n+\n+        if histtype == \"step\":\n+            edgecolors = itertools.cycle(np.atleast_1d(kwargs.get('edgecolor',\n+                                                                  colors)))\n+        else:\n+            edgecolors = itertools.cycle(np.atleast_1d(kwargs.get(\"edgecolor\", None)))\n+\n+        facecolors = itertools.cycle(np.atleast_1d(kwargs.get('facecolor', colors)))\n+        hatches = itertools.cycle(np.atleast_1d(kwargs.get('hatch', None)))\n+        linewidths = itertools.cycle(np.atleast_1d(kwargs.get('linewidth', None)))\n+        linestyles = itertools.cycle(np.atleast_1d(kwargs.get('linestyle', None)))\n+\n         for patch, lbl in itertools.zip_longest(patches, labels):\n-            if patch:\n-                p = patch[0]\n+            if not patch:\n+                continue\n+            p = patch[0]\n+            kwargs.update({\n+                'hatch': next(hatches),\n+                'linewidth': next(linewidths),\n+                'linestyle': next(linestyles),\n+                'edgecolor': next(edgecolors),\n+                'facecolor': next(facecolors),\n+            })\n+            p._internal_update(kwargs)\n+            if lbl is not None:\n+                p.set_label(lbl)\n+            for p in patch[1:]:\n                 p._internal_update(kwargs)\n-                if lbl is not None:\n-                    p.set_label(lbl)\n-                for p in patch[1:]:\n-                    p._internal_update(kwargs)\n-                    p.set_label('_nolegend_')\n+                p.set_label('_nolegend_')\n \n         if nx == 1:\n             return tops[0], bins, patches[0]\n", "test_patch": "diff --git a/lib/matplotlib/tests/test_axes.py b/lib/matplotlib/tests/test_axes.py\nindex dd37d3d8ee80..b1f97b3f855f 100644\n--- a/lib/matplotlib/tests/test_axes.py\n+++ b/lib/matplotlib/tests/test_axes.py\n@@ -4603,6 +4603,64 @@ def test_hist_stacked_bar():\n     ax.legend(loc='upper right', bbox_to_anchor=(1.0, 1.0), ncols=1)\n \n \n+@pytest.mark.parametrize('kwargs', ({'facecolor': [\"b\", \"g\", \"r\"]},\n+                                    {'edgecolor': [\"b\", \"g\", \"r\"]},\n+                                    {'hatch': [\"/\", \"\\\\\", \".\"]},\n+                                    {'linestyle': [\"-\", \"--\", \":\"]},\n+                                    {'linewidth': [1, 1.5, 2]},\n+                                    {'color': [\"b\", \"g\", \"r\"]}))\n+@check_figures_equal(extensions=[\"png\"])\n+def test_hist_vectorized_params(fig_test, fig_ref, kwargs):\n+    np.random.seed(19680801)\n+    xs = [np.random.randn(n) for n in [20, 50, 100]]\n+\n+    (axt1, axt2) = fig_test.subplots(2)\n+    (axr1, axr2) = fig_ref.subplots(2)\n+\n+    for histtype, axt, axr in [(\"stepfilled\", axt1, axr1), (\"step\", axt2, axr2)]:\n+        _, bins, _ = axt.hist(xs, bins=10, histtype=histtype, **kwargs)\n+\n+        kw, values = next(iter(kwargs.items()))\n+        for i, (x, value) in enumerate(zip(xs, values)):\n+            axr.hist(x, bins=bins, histtype=histtype, **{kw: value},\n+                     zorder=(len(xs)-i)/2)\n+\n+\n+@pytest.mark.parametrize('kwargs, patch_face, patch_edge',\n+                         # 'C0'(blue) stands for the first color of the\n+                         # default color cycle as well as the patch.facecolor rcParam\n+                         # When the expected edgecolor is 'k'(black),\n+                         # it corresponds to the patch.edgecolor rcParam\n+                         [({'histtype': 'stepfilled', 'color': 'r',\n+                            'facecolor': 'y', 'edgecolor': 'g'}, 'y', 'g'),\n+                          ({'histtype': 'step', 'color': 'r',\n+                            'facecolor': 'y', 'edgecolor': 'g'}, ('y', 0), 'g'),\n+                          ({'histtype': 'stepfilled', 'color': 'r',\n+                            'edgecolor': 'g'}, 'r', 'g'),\n+                          ({'histtype': 'step', 'color': 'r',\n+                            'edgecolor': 'g'}, ('r', 0), 'g'),\n+                          ({'histtype': 'stepfilled', 'color': 'r',\n+                            'facecolor': 'y'}, 'y', 'k'),\n+                          ({'histtype': 'step', 'color': 'r',\n+                            'facecolor': 'y'}, ('y', 0), 'r'),\n+                          ({'histtype': 'stepfilled',\n+                            'facecolor': 'y', 'edgecolor': 'g'}, 'y', 'g'),\n+                          ({'histtype': 'step', 'facecolor': 'y',\n+                            'edgecolor': 'g'}, ('y', 0), 'g'),\n+                          ({'histtype': 'stepfilled', 'color': 'r'}, 'r', 'k'),\n+                          ({'histtype': 'step', 'color': 'r'}, ('r', 0), 'r'),\n+                          ({'histtype': 'stepfilled', 'facecolor': 'y'}, 'y', 'k'),\n+                          ({'histtype': 'step', 'facecolor': 'y'}, ('y', 0), 'C0'),\n+                          ({'histtype': 'stepfilled', 'edgecolor': 'g'}, 'C0', 'g'),\n+                          ({'histtype': 'step', 'edgecolor': 'g'}, ('C0', 0), 'g'),\n+                          ({'histtype': 'stepfilled'}, 'C0', 'k'),\n+                          ({'histtype': 'step'}, ('C0', 0), 'C0')])\n+def test_hist_color_semantics(kwargs, patch_face, patch_edge):\n+    _, _, patches = plt.figure().subplots().hist([1, 2, 3], **kwargs)\n+    assert all(mcolors.same_color([p.get_facecolor(), p.get_edgecolor()],\n+                                  [patch_face, patch_edge]) for p in patches)\n+\n+\n def test_hist_barstacked_bottom_unchanged():\n     b = np.array([10, 20])\n     plt.hist([[0, 1], [0, 1]], 2, histtype=\"barstacked\", bottom=b)\n@@ -4614,6 +4672,15 @@ def test_hist_emptydata():\n     ax.hist([[], range(10), range(10)], histtype=\"step\")\n \n \n+def test_hist_unused_labels():\n+    # When a list with one dataset and N elements is provided and N labels, ensure\n+    # that the first label is used for the dataset and all other labels are ignored\n+    fig, ax = plt.subplots()\n+    ax.hist([[1, 2, 3]], label=[\"values\", \"unused\", \"also unused\"])\n+    _, labels = ax.get_legend_handles_labels()\n+    assert labels == [\"values\"]\n+\n+\n def test_hist_labels():\n     # test singleton labels OK\n     fig, ax = plt.subplots()\n", "problem_statement": "[Bug]: stacked histogram does not properly handle edgecolor and hatches\n### Bug summary\r\n\r\nWhen using stacked histogram in matplotlib 3.7.2 the functionality of hatch and edgecolor is broken. It simply gives an error if trying to define either a separate edgecolor or hatch value for the stacked parts of the histogram.\r\n\r\n### Code for reproduction\r\n\r\n```python\r\nimport matplotlib.pyplot as plt\r\nimport numpy as np\r\n\r\nplt.hist([np.random.uniform(size=100), np.random.uniform(size=50)],\r\n         stacked=True,\r\n         color=[\"C0\", \"C1\"],\r\n         edgecolor='black',\r\n         hatch=[\"/\", \".\"],\r\n         linewidth=1,\r\n         fill=True,\r\n         density=False, \r\n         )\r\n```\r\n\r\n\r\n### Actual outcome\r\n\r\n> Traceback (most recent call last):\r\n>   File \"/opt/anaconda3/envs/code/lib/python3.10/site-packages/IPython/core/interactiveshell.py\", line 3460, in run_code\r\n>     exec(code_obj, self.user_global_ns, self.user_ns)\r\n>   File \"<ipython-input-11-3f15e200502a>\", line 1, in <module>\r\n>     plt.hist([np.random.uniform(size=100), np.random.uniform(size=50)],\r\n>   File \"/opt/anaconda3/envs/code/lib/python3.10/site-packages/matplotlib/pyplot.py\", line 2645, in hist\r\n>     return gca().hist(\r\n>   File \"/opt/anaconda3/envs/code/lib/python3.10/site-packages/matplotlib/__init__.py\", line 1446, in inner\r\n>     return func(ax, *map(sanitize_sequence, args), **kwargs)\r\n>   File \"/opt/anaconda3/envs/code/lib/python3.10/site-packages/matplotlib/axes/_axes.py\", line 6944, in hist\r\n>     p._internal_update(kwargs)\r\n>   File \"/opt/anaconda3/envs/code/lib/python3.10/site-packages/matplotlib/artist.py\", line 1223, in _internal_update\r\n>     return self._update_props(\r\n>   File \"/opt/anaconda3/envs/code/lib/python3.10/site-packages/matplotlib/artist.py\", line 1199, in _update_props\r\n>     ret.append(func(v))\r\n>   File \"/opt/anaconda3/envs/code/lib/python3.10/site-packages/matplotlib/patches.py\", line 525, in set_hatch\r\n>     mhatch._validate_hatch_pattern(hatch)\r\n>   File \"/opt/anaconda3/envs/code/lib/python3.10/site-packages/matplotlib/hatch.py\", line 188, in _validate_hatch_pattern\r\n>     invalids = ''.join(sorted(invalids))\r\n> TypeError: sequence item 0: expected str instance, NoneType found\r\n\r\n\r\nWhile using different edgecolors for the stacked part with \r\n\r\n```\r\nplt.hist([np.random.uniform(size=100), np.random.uniform(size=50)],\r\n         stacked=True,\r\n         color=[\"C0\", \"C1\"],\r\n         edgecolor=[\"C2\", \"C3\"],\r\n         hatch=\"/\",\r\n         linewidth=1,\r\n         fill=True,\r\n         density=False, \r\n         )\r\n```\r\n\r\ndelivers the error\r\n\r\n> Traceback (most recent call last):\r\n>   File \"/opt/anaconda3/envs/code/lib/python3.10/site-packages/IPython/core/interactiveshell.py\", line 3460, in run_code\r\n>     exec(code_obj, self.user_global_ns, self.user_ns)\r\n>   File \"<ipython-input-16-4bdbf23ac913>\", line 1, in <module>\r\n>     plt.hist([np.random.uniform(size=100), np.random.uniform(size=50)],\r\n>   File \"/opt/anaconda3/envs/code/lib/python3.10/site-packages/matplotlib/pyplot.py\", line 2645, in hist\r\n>     return gca().hist(\r\n>   File \"/opt/anaconda3/envs/code/lib/python3.10/site-packages/matplotlib/__init__.py\", line 1446, in inner\r\n>     return func(ax, *map(sanitize_sequence, args), **kwargs)\r\n>   File \"/opt/anaconda3/envs/code/lib/python3.10/site-packages/matplotlib/axes/_axes.py\", line 6944, in hist\r\n>     p._internal_update(kwargs)\r\n>   File \"/opt/anaconda3/envs/code/lib/python3.10/site-packages/matplotlib/artist.py\", line 1223, in _internal_update\r\n>     return self._update_props(\r\n>   File \"/opt/anaconda3/envs/code/lib/python3.10/site-packages/matplotlib/artist.py\", line 1199, in _update_props\r\n>     ret.append(func(v))\r\n>   File \"/opt/anaconda3/envs/code/lib/python3.10/site-packages/matplotlib/patches.py\", line 341, in set_edgecolor\r\n>     self._set_edgecolor(color)\r\n>   File \"/opt/anaconda3/envs/code/lib/python3.10/site-packages/matplotlib/patches.py\", line 327, in _set_edgecolor\r\n>     self._edgecolor = colors.to_rgba(color, self._alpha)\r\n>   File \"/opt/anaconda3/envs/code/lib/python3.10/site-packages/matplotlib/colors.py\", line 299, in to_rgba\r\n>     rgba = _to_rgba_no_colorcycle(c, alpha)\r\n>   File \"/opt/anaconda3/envs/code/lib/python3.10/site-packages/matplotlib/colors.py\", line 383, in _to_rgba_no_colorcycle\r\n>     raise ValueError(\"RGBA sequence should have length 3 or 4\")\r\n> ValueError: RGBA sequence should have length 3 or 4\r\n\r\nIt seems to interpret the list of `edgecolor` [\"C2\", \"C3\"] as one color, although it is able to manage similar input for `color`.\r\n\r\n### Expected outcome\r\n\r\nIt should look similar to the following example, except that the top orange part should have dots and not slanted lines:\r\n![test_bugreport](https://github.com/matplotlib/matplotlib/assets/43748463/d29ca5f2-3f89-4c57-a608-edb4aba302ce)\r\nThe code used to generate this plot:\r\n\r\n```\r\nimport matplotlib.pyplot as plt\r\nimport numpy as np\r\nplt.hist([np.random.uniform(size=100), np.random.uniform(size=50)],\r\n         stacked=True,\r\n         color=[\"C0\", \"C1\"],\r\n         edgecolor='black',\r\n         hatch=\"/\",\r\n         linewidth=1,\r\n         fill=True,\r\n         density=False, \r\n         )\r\n```\r\n\r\nIn case of the second example it should habe two different edgecolors for the first and second part of the stacked histogram.\r\n\r\n### Additional information\r\n\r\n_No response_\r\n\r\n### Operating system\r\n\r\nMacOSX\r\n\r\n### Matplotlib Version\r\n\r\n3.7.2\r\n\r\n### Matplotlib Backend\r\n\r\nMacOSX\r\n\r\n### Python version\r\n\r\n3.10.0\r\n\r\n### Jupyter version\r\n\r\n_No response_\r\n\r\n### Installation\r\n\r\nconda\n", "hints_text": "Didn't have the chance to test on Python 3.10.0 and mpl 3.7.2 yet. But running first block of the code above with mpl 3.9.0 dev and Python 3.11.5 (conda) on Mac will give:\r\n\r\n```\r\nTraceback (most recent call last):\r\n  File \"/Users/xxxxxx/Documents/matplotlib-project/matplotlib/lib/matplotlib/backend_bases.py\", line 1215, in _on_timer\r\n    ret = func(*args, **kwargs)\r\n          ^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/Users/xxxxxx/Documents/matplotlib-project/matplotlib/lib/matplotlib/backends/backend_macosx.py\", line 70, in callback_func\r\n    callback()\r\n  File \"/Users/xxxxxx/Documents/matplotlib-project/matplotlib/lib/matplotlib/backends/backend_macosx.py\", line 93, in _draw_idle\r\n    self.draw()\r\n  File \"/Users/xxxxxx/Documents/matplotlib-project/matplotlib/lib/matplotlib/backends/backend_macosx.py\", line 52, in draw\r\n    super().draw()\r\n  File \"/Users/xxxxxx/Documents/matplotlib-project/matplotlib/lib/matplotlib/backends/backend_agg.py\", line 387, in draw\r\n    self.figure.draw(self.renderer)\r\n  File \"/Users/xxxxxx/Documents/matplotlib-project/matplotlib/lib/matplotlib/artist.py\", line 95, in draw_wrapper\r\n    result = draw(artist, renderer, *args, **kwargs)\r\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/Users/xxxxxx/Documents/matplotlib-project/matplotlib/lib/matplotlib/artist.py\", line 72, in draw_wrapper\r\n    return draw(artist, renderer)\r\n           ^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/Users/xxxxxx/Documents/matplotlib-project/matplotlib/lib/matplotlib/figure.py\", line 3101, in draw\r\n    mimage._draw_list_compositing_images(\r\n  File \"/Users/xxxxxx/Documents/matplotlib-project/matplotlib/lib/matplotlib/image.py\", line 132, in _draw_list_compositing_images\r\n    a.draw(renderer)\r\n  File \"/Users/xxxxxx/Documents/matplotlib-project/matplotlib/lib/matplotlib/artist.py\", line 72, in draw_wrapper\r\n    return draw(artist, renderer)\r\n           ^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/Users/xxxxxx/Documents/matplotlib-project/matplotlib/lib/matplotlib/axes/_base.py\", line 3095, in draw\r\n    mimage._draw_list_compositing_images(\r\n  File \"/Users/xxxxxx/Documents/matplotlib-project/matplotlib/lib/matplotlib/image.py\", line 132, in _draw_list_compositing_images\r\n    a.draw(renderer)\r\n  File \"/Users/xxxxxx/Documents/matplotlib-project/matplotlib/lib/matplotlib/artist.py\", line 72, in draw_wrapper\r\n    return draw(artist, renderer)\r\n           ^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/Users/xxxxxx/Documents/matplotlib-project/matplotlib/lib/matplotlib/patches.py\", line 588, in draw\r\n    self._draw_paths_with_artist_properties(\r\n  File \"/Users/xxxxxx/Documents/matplotlib-project/matplotlib/lib/matplotlib/patches.py\", line 573, in _draw_paths_with_artist_properties\r\n    renderer.draw_path(gc, *draw_path_args)\r\n  File \"/Users/xxxxxx/Documents/matplotlib-project/matplotlib/lib/matplotlib/backends/backend_agg.py\", line 131, in draw_path\r\n    self._renderer.draw_path(gc, path, transform, rgbFace)\r\n  File \"/Users/xxxxxx/Documents/matplotlib-project/matplotlib/lib/matplotlib/backend_bases.py\", line 1018, in get_hatch_path\r\n    return Path.hatch(hatch, density)\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^\r\nTypeError: unhashable type: 'list'\r\n```\nHi, I'm working in this issue if @stevezhang1999 is not . Right now 'color' is a parameter in hist function, but edgecolor/hatch isn't. The function that deals with this 2 other parameters is in artist.py, and accepts types 'color' or 'none'. I was thinking about adding these parameters in hist function, but that means we would have to change documentation. If someone have a better approach pls tell me \n> Hi, I'm working in this issue if @stevezhang1999 is not . Right now 'color' is a parameter in hist function, but edgecolor/hatch isn't. The function that deals with this 2 other parameters is in artist.py, and accepts types 'color' or 'none'. I was thinking about adding these parameters in hist function, but that means we would have to change documentation. If someone have a better approach pls tell me\r\n\r\nYou are welcomed to work on it if that interests you!\nhey guys, in developer mode `plt.show()` doesn't work. Do you know how can I see the plots so I know if my code is working correctly?\nThere is no reason for plt.show to not work in developer mode.  Check your installation ", "created_at": "2024-04-13T17:59:17Z"}
{"repo": "matplotlib/matplotlib", "pull_number": 28041, "instance_id": "matplotlib__matplotlib-28041", "issue_numbers": ["28052"], "base_commit": "8b32a0ba3a2e2f574abd8776c2f792e1ab871b9e", "patch": "diff --git a/lib/mpl_toolkits/mplot3d/axes3d.py b/lib/mpl_toolkits/mplot3d/axes3d.py\nindex d0f5c8d2b23b..347fbe5f6db6 100644\n--- a/lib/mpl_toolkits/mplot3d/axes3d.py\n+++ b/lib/mpl_toolkits/mplot3d/axes3d.py\n@@ -383,7 +383,7 @@ def set_box_aspect(self, aspect, *, zoom=1):\n         # of the axes in mpl3.8.\n         aspect *= 1.8294640721620434 * 25/24 * zoom / np.linalg.norm(aspect)\n \n-        self._box_aspect = aspect\n+        self._box_aspect = self._roll_to_vertical(aspect, reverse=True)\n         self.stale = True\n \n     def apply_aspect(self, position=None):\n@@ -1191,9 +1191,23 @@ def set_proj_type(self, proj_type, focal_length=None):\n                                  f\"None for proj_type = {proj_type}\")\n             self._focal_length = np.inf\n \n-    def _roll_to_vertical(self, arr):\n-        \"\"\"Roll arrays to match the different vertical axis.\"\"\"\n-        return np.roll(arr, self._vertical_axis - 2)\n+    def _roll_to_vertical(\n+        self, arr: \"np.typing.ArrayLike\", reverse: bool = False\n+    ) -> np.ndarray:\n+        \"\"\"\n+        Roll arrays to match the different vertical axis.\n+\n+        Parameters\n+        ----------\n+        arr : ArrayLike\n+            Array to roll.\n+        reverse : bool, default: False\n+            Reverse the direction of the roll.\n+        \"\"\"\n+        if reverse:\n+            return np.roll(arr, (self._vertical_axis - 2) * -1)\n+        else:\n+            return np.roll(arr, (self._vertical_axis - 2))\n \n     def get_proj(self):\n         \"\"\"Create the projection matrix from the current viewing position.\"\"\"\n", "test_patch": "diff --git a/lib/mpl_toolkits/mplot3d/tests/test_axes3d.py b/lib/mpl_toolkits/mplot3d/tests/test_axes3d.py\nindex ed56e5505d8e..7bcd121ab597 100644\n--- a/lib/mpl_toolkits/mplot3d/tests/test_axes3d.py\n+++ b/lib/mpl_toolkits/mplot3d/tests/test_axes3d.py\n@@ -2276,6 +2276,24 @@ def test_on_move_vertical_axis(vertical_axis: str) -> None:\n     )\n \n \n+@pytest.mark.parametrize(\n+    \"vertical_axis, aspect_expected\",\n+    [\n+        (\"x\", [1.190476, 0.892857, 1.190476]),\n+        (\"y\", [0.892857, 1.190476, 1.190476]),\n+        (\"z\", [1.190476, 1.190476, 0.892857]),\n+    ],\n+)\n+def test_set_box_aspect_vertical_axis(vertical_axis, aspect_expected):\n+    ax = plt.subplot(1, 1, 1, projection=\"3d\")\n+    ax.view_init(elev=0, azim=0, roll=0, vertical_axis=vertical_axis)\n+    ax.figure.canvas.draw()\n+\n+    ax.set_box_aspect(None)\n+\n+    np.testing.assert_allclose(aspect_expected, ax._box_aspect, rtol=1e-6)\n+\n+\n @image_comparison(baseline_images=['arc_pathpatch.png'],\n                   remove_text=True,\n                   style='mpl20')\n", "problem_statement": "[Bug]: set_aspect incompatible with view_init\n### Bug summary\n\nax.set_aspect('equal') doesn't work properly on axes where the view has been manipulated, i.e.  ax.view_init(vertical_axis='y').\r\nIt sets the aspect ratio as if the axes were still oriented in the standard way. \n\n### Code for reproduction\n\n```Python\nimport numpy as np\r\nimport matplotlib.pyplot as plt\r\nimport mpl_toolkits.mplot3d as a3\r\n\r\nplt.close('all')\r\nfig = plt.figure()\r\nax = fig.add_subplot(111, projection='3d')\r\nax.view_init(vertical_axis='y')\r\nax.set_xlabel('X')\r\nax.set_ylabel('Y')\r\nax.set_xlabel('Z')\r\nax.axes.set_xlim3d(left=-1, right=3.5) \r\nax.axes.set_ylim3d(bottom=0, top=10) \r\nax.axes.set_zlim3d(bottom=-0.5, top=3.5) \r\nax.set_aspect('equal')\r\n    \r\ndef a(elemList):\r\n    return np.array(elemList)\r\n\r\ndef drawTriangle(centre, size=1, color='y'):\r\n    # A neuron is a triangle\r\n    left = centre + a([- size / 2, - size / 2, 0])\r\n    right = centre + a([size / 2, - size / 2, 0])\r\n    top = centre + a([0, size / 2, 0])\r\n    coords = a([left, top, right])\r\n    tri = a3.art3d.Poly3DCollection([coords])\r\n    tri.set_color(color)\r\n    tri.set_edgecolor('k')\r\n    ax.add_collection3d(tri)\r\n\r\nfor col in range(3):\r\n    drawTriangle(a([col, 10, 0]))\n```\n\n\n### Actual outcome\n\n![image](https://github.com/matplotlib/matplotlib/assets/2457225/8599626d-857b-429f-8ba6-0d0c86d61598)\r\n\n\n### Expected outcome\n\nYou would want the vertical 'y' axis to be stretched to 10 units, instead the horizontal 'z' axis has been stretched.\n\n### Additional information\n\n_No response_\n\n### Operating system\n\n_No response_\n\n### Matplotlib Version\n\n3.7.2\n\n### Matplotlib Backend\n\n_No response_\n\n### Python version\n\n_No response_\n\n### Jupyter version\n\n_No response_\n\n### Installation\n\nNone\n", "hints_text": "", "created_at": "2024-04-07T16:26:59Z"}
{"repo": "matplotlib/matplotlib", "pull_number": 28039, "instance_id": "matplotlib__matplotlib-28039", "issue_numbers": ["28040"], "base_commit": "f799b00c76f5a0af12dd43010e817d816459f4b2", "patch": "diff --git a/lib/mpl_toolkits/mplot3d/axes3d.py b/lib/mpl_toolkits/mplot3d/axes3d.py\nindex 9ca5692c40ab..d0f5c8d2b23b 100644\n--- a/lib/mpl_toolkits/mplot3d/axes3d.py\n+++ b/lib/mpl_toolkits/mplot3d/axes3d.py\n@@ -1147,7 +1147,8 @@ def view_init(self, elev=None, azim=None, roll=None, vertical_axis=\"z\",\n         if roll is None:\n             roll = self.initial_roll\n         vertical_axis = _api.check_getitem(\n-            dict(x=0, y=1, z=2), vertical_axis=vertical_axis\n+            {name: idx for idx, name in enumerate(self._axis_names)},\n+            vertical_axis=vertical_axis,\n         )\n \n         if share:\n@@ -1318,7 +1319,7 @@ def shareview(self, other):\n             raise ValueError(\"view angles are already shared\")\n         self._shared_axes[\"view\"].join(self, other)\n         self._shareview = other\n-        vertical_axis = {0: \"x\", 1: \"y\", 2: \"z\"}[other._vertical_axis]\n+        vertical_axis = self._axis_names[other._vertical_axis]\n         self.view_init(elev=other.elev, azim=other.azim, roll=other.roll,\n                        vertical_axis=vertical_axis, share=True)\n \n@@ -1523,7 +1524,14 @@ def _on_move(self, event):\n             dazim = -(dy/h)*180*np.sin(roll) - (dx/w)*180*np.cos(roll)\n             elev = self.elev + delev\n             azim = self.azim + dazim\n-            self.view_init(elev=elev, azim=azim, roll=roll, share=True)\n+            vertical_axis = self._axis_names[self._vertical_axis]\n+            self.view_init(\n+                elev=elev,\n+                azim=azim,\n+                roll=roll,\n+                vertical_axis=vertical_axis,\n+                share=True,\n+            )\n             self.stale = True\n \n         # Pan\n", "test_patch": "diff --git a/lib/mpl_toolkits/mplot3d/tests/test_axes3d.py b/lib/mpl_toolkits/mplot3d/tests/test_axes3d.py\nindex 7662509dd9cf..731b0413bf65 100644\n--- a/lib/mpl_toolkits/mplot3d/tests/test_axes3d.py\n+++ b/lib/mpl_toolkits/mplot3d/tests/test_axes3d.py\n@@ -2250,6 +2250,31 @@ def test_view_init_vertical_axis(\n         np.testing.assert_array_equal(tickdir_expected, tickdir_actual)\n \n \n+@pytest.mark.parametrize(\"vertical_axis\", [\"x\", \"y\", \"z\"])\n+def test_on_move_vertical_axis(vertical_axis: str) -> None:\n+    \"\"\"\n+    Test vertical axis is respected when rotating the plot interactively.\n+    \"\"\"\n+    ax = plt.subplot(1, 1, 1, projection=\"3d\")\n+    ax.view_init(elev=0, azim=0, roll=0, vertical_axis=vertical_axis)\n+    ax.figure.canvas.draw()\n+\n+    proj_before = ax.get_proj()\n+    event_click = mock_event(ax, button=MouseButton.LEFT, xdata=0, ydata=1)\n+    ax._button_press(event_click)\n+\n+    event_move = mock_event(ax, button=MouseButton.LEFT, xdata=0.5, ydata=0.8)\n+    ax._on_move(event_move)\n+\n+    assert ax._axis_names.index(vertical_axis) == ax._vertical_axis\n+\n+    # Make sure plot has actually moved:\n+    proj_after = ax.get_proj()\n+    np.testing.assert_raises(\n+        AssertionError, np.testing.assert_allclose, proj_before, proj_after\n+    )\n+\n+\n @image_comparison(baseline_images=['arc_pathpatch.png'],\n                   remove_text=True,\n                   style='mpl20')\n", "problem_statement": "[Bug]: vertical_axis not respected when rotating plots interactively\n### Bug summary\r\n\r\n When setting `ax.view_init(vertical_axis=\"x\")` the plot is initialized as intended but once rotating it a little the plot and `ax._vertical_axis` is reset to the default value.\r\n\r\n### Code for reproduction\r\n\r\n```Python\r\nx = np.array([0, 1, 2, 4])\r\ny = np.array([5, 10])\r\nz = np.array([100, 150, 200])\r\nX, Y, Z = np.meshgrid(*[x, y, z], indexing=\"ij\")\r\nc = np.arange(0, X.size)\r\n\r\nplt.figure()\r\nfor j, (a, e) in enumerate([(0, 0), (-60, 30)]):\r\n    for i, vert_a in enumerate([\"z\", \"y\", \"x\"]):\r\n        ax = plt.subplot(2, 3, j * 3 + 1 + i, projection=\"3d\")\r\n        pc = ax.scatter(X, Y, Z, c=c)\r\n        # ax.view_init(vertical_axis=vert_a)\r\n        # ax.view_init(azim=0, elev=0, vertical_axis=vert_a)\r\n        # ax.view_init(azim=-60, elev=30, vertical_axis=vert_a)\r\n        ax.view_init(azim=a, elev=e, vertical_axis=vert_a)\r\n        ax.set_title(f\"azim={a}, elev={e}, vertical_axis='{vert_a}'\")\r\n        ax.set_xlabel(\"x\")\r\n        ax.set_ylabel(\"y\")\r\n        ax.set_zlabel(\"z\")\r\n```\r\n\r\n\r\n### Actual outcome\r\n\r\nInital view:\r\n![image](https://github.com/matplotlib/matplotlib/assets/14371165/62171edf-dc47-4588-abff-d7ebd12c992b)\r\n\r\nAfter a small rotation on the **bottom right** plot:\r\n![image](https://github.com/matplotlib/matplotlib/assets/14371165/f37d9609-e4c8-461d-b373-ed9e27c42d35)\r\n\r\n\r\n### Expected outcome\r\n\r\n`ax._vertical_axis` should stay the same when rotating plots. This worked correctly in earlier matplotlib version. \r\n\r\n### Additional information\r\n\r\n_No response_\r\n\r\n### Operating system\r\n\r\nWindows 10\r\n\r\n### Matplotlib Version\r\n\r\n3.8.3\r\n\r\n### Matplotlib Backend\r\n\r\nQt5Agg\r\n\r\n### Python version\r\n\r\n3.12\r\n\r\n### Jupyter version\r\n\r\n_No response_\r\n\r\n### Installation\r\n\r\nconda\n", "hints_text": "", "created_at": "2024-04-07T14:01:30Z"}
{"repo": "matplotlib/matplotlib", "pull_number": 28033, "instance_id": "matplotlib__matplotlib-28033", "issue_numbers": ["26752", "0000"], "base_commit": "380bba1d0b4f3665afdb164ad784dd234ccb8de3", "patch": "diff --git a/lib/matplotlib/axes/_axes.py b/lib/matplotlib/axes/_axes.py\nindex b65004b8c272..673998defb66 100644\n--- a/lib/matplotlib/axes/_axes.py\n+++ b/lib/matplotlib/axes/_axes.py\n@@ -7194,9 +7194,16 @@ def stairs(self, values, edges=None, *,\n             True or an array is passed to *baseline*, a closed\n             path is drawn.\n \n+            If None, then drawn as an unclosed Path.\n+\n         fill : bool, default: False\n             Whether the area under the step curve should be filled.\n \n+            Passing both ``fill=True` and ``baseline=None`` will likely result in\n+            undesired filling: the first and last points will be connected\n+            with a straight line and the fill will be between this line and the stairs.\n+\n+\n         Returns\n         -------\n         StepPatch : `~matplotlib.patches.StepPatch`\n@@ -7234,6 +7241,16 @@ def stairs(self, values, edges=None, *,\n                                    fill=fill,\n                                    **kwargs)\n         self.add_patch(patch)\n+        if baseline is None and fill:\n+            _api.warn_external(\n+                f\"Both {baseline=} and {fill=} have been passed. \"\n+                \"baseline=None is only intended for unfilled stair plots. \"\n+                \"Because baseline is None, the Path used to draw the stairs will \"\n+                \"not be closed, thus because fill is True the polygon will be closed \"\n+                \"by drawing an (unstroked) edge from the first to last point.  It is \"\n+                \"very likely that the resulting fill patterns is not the desired \"\n+                \"result.\"\n+            )\n         if baseline is None:\n             baseline = 0\n         if orientation == 'vertical':\n", "test_patch": "diff --git a/lib/matplotlib/tests/test_axes.py b/lib/matplotlib/tests/test_axes.py\nindex 819f4eb3b598..3644f0861d1b 100644\n--- a/lib/matplotlib/tests/test_axes.py\n+++ b/lib/matplotlib/tests/test_axes.py\n@@ -2342,6 +2342,18 @@ def test_hist_zorder(histtype, zorder):\n         assert patch.get_zorder() == zorder\n \n \n+def test_stairs_no_baseline_fill_warns():\n+    fig, ax = plt.subplots()\n+    with pytest.warns(UserWarning, match=\"baseline=None and fill=True\"):\n+        ax.stairs(\n+            [4, 5, 1, 0, 2],\n+            [1, 2, 3, 4, 5, 6],\n+            facecolor=\"blue\",\n+            baseline=None,\n+            fill=True\n+        )\n+\n+\n @check_figures_equal(extensions=['png'])\n def test_stairs(fig_test, fig_ref):\n     import matplotlib.lines as mlines\n", "problem_statement": "[Bug]: `ax.stairs()` creates inaccurate `fill` for the plot \n### Bug summary\r\n\r\nI was working on a code to achieve the following look: \r\n\r\n![image](https://github.com/matplotlib/matplotlib/assets/8880777/7aae54ff-ff30-4ace-8f9d-cc40804b640c)\r\n\r\nI got there by combining `ax.plot()` and `ax.fill_between()` functions. But then I've learnt about the `ax.stairs()` function which is suppose to plot in a step-like fashion and allows to add fill under the line **in one go**.\r\n\r\nHowever, when I tried `ax.stairs()` I got the following result:\r\n\r\n![image](https://github.com/matplotlib/matplotlib/assets/8880777/0c016dfe-486d-47f7-b542-76516545f77f)\r\n\r\nThe bug (I think):\r\n* the fill is completely wrong - it doesn't stretch between `x-axis` and the line\r\n\r\nSecondary issues:\r\n* I don't think there's a way to have a separate colour for line and fill at the moment, when I set a colour, line disappears - this is especially visibile when I set e.g. `alpha=0.1`\r\n* I've got a feeling that somehow the grid ends up on top of the plot when I call `ax.stairs()`\r\n\r\n### Code for reproduction\r\n\r\n```python\r\npython\r\nimport matplotlib.pyplot as plt\r\n\r\nx = [1, 4, 10, 12, 15, 20]\r\ny = [2, 4, 1, 3, 1, 4]\r\n\r\nfig, axs = plt.subplots(\r\n    2, 1,\r\n    figsize=(16,10),\r\n    facecolor=\"white\",\r\n    sharex=True,\r\n    sharey=True\r\n)\r\nfig.suptitle(\r\n    \"ax.stairs()\",\r\n    fontsize=20,\r\n)\r\n\r\n# plot points\r\nfor ax in axs:\r\n    ax.scatter(\r\n        x, y,\r\n        marker=\"X\",\r\n        s=275,\r\n        linewidth=1.5,\r\n        edgecolor=\"black\",\r\n        facecolor=\"white\",\r\n        zorder=100  # crude way to keep the points always on top\r\n    )\r\n\r\naxs[0].stairs(\r\n    values=y,  # step height\r\n    edges=[x[0], *x],  # edge width\r\n    baseline=None,\r\n    color=\"red\",\r\n    fill=True,\r\n    label=\"steps-pre: duplicate 1st element in `edges=[x[0], *x]`\"\r\n)\r\naxs[1].stairs(\r\n    values=y,  # step height\r\n    edges=[*x, x[-1]],  # edge\r\n    baseline=None,\r\n    color=\"green\",\r\n    fill=True,\r\n    alpha=0.1,\r\n    label=\"steps-post: duplicate last element in `edges=[*x, x[-1]]`\"\r\n)\r\n\r\n# set axis limits\r\naxs[0].set_ylim(0, 5.5)\r\naxs[0].set_yticks(range(1, 6))\r\naxs[0].set_xlim(0, 21)\r\naxs[1].set_xticks(range(1, 21))\r\n\r\n# add legend\r\nfor ax in axs:\r\n    ax.legend(\r\n        fontsize=16,\r\n        loc=\"upper center\",\r\n        facecolor=\"whitesmoke\",\r\n        edgecolor=\"none\"\r\n    )\r\n\r\n    # Update font size of the 'x' and 'y' axis labels\r\n    ax.tick_params(\r\n        axis=\"both\",\r\n        labelsize=16\r\n    )\r\n\r\n    ax.grid(\r\n        color=\"gainsboro\",\r\n        linewidth=0.5\r\n    )\r\n\r\n# Remove spines\r\nfor position in [\"top\", \"right\"]:\r\n    for ax in axs:\r\n        ax.spines[position].set_visible(False)\r\n\r\nplt.tight_layout()\r\n```\r\n```\r\n\r\n\r\n### Actual outcome\r\n\r\n![image](https://github.com/matplotlib/matplotlib/assets/8880777/f726f74e-5d28-488d-bf66-6536093b3227)\r\n\r\n\r\n### Expected outcome\r\n\r\n![image](https://github.com/matplotlib/matplotlib/assets/8880777/88a1c5e4-f50f-4b30-8f41-59f69aeee169)\r\n\r\n\r\n### Additional information\r\n\r\n_No response_\r\n\r\n### Operating system\r\n\r\nWindows \r\n\r\n### Matplotlib Version\r\n\r\n3.7.2\r\n\r\n### Matplotlib Backend\r\n\r\nmodule://matplotlib_inline.backend_inline\r\n\r\n### Python version\r\n\r\n3.10.2\r\n\r\n### Jupyter version\r\n\r\nIPython          : 8.14.0 ipykernel        : 6.25.1 ipywidgets       : not installed jupyter_client   : 8.3.0 jupyter_core     : 5.3.1 jupyter_server   : not installed jupyterlab       : not installed nbclient         : not installed nbconvert        : not installed nbformat         : not installed notebook         : not installed qtconsole        : not installed traitlets        : 5.9.0\r\n\r\n### Installation\r\n\r\npip\n", "hints_text": "I may be missing something here, but if you pass `baseline=0` (or skip setting it to `None`) it should solve the fill issue.\r\n\r\nWith that said, I agree that I cannot make it use different colors for the face and the edge. Also, I would suspect that even if it was possible, the edge color probably would be applied to the whole `StepPatch`, but that is pure speculation.\nThanks for the suggestion, I missed that before. \r\n\r\nIndeed, now I can get the fill that goes all the way to the bottom of the plot.\r\n\r\nHowever, I still think it's not right that I can either get a fill _or_ the line, I cannot have both - this is a bit annoying in a corner case like the bottom graph from my original example.\r\n\r\n![image](https://github.com/matplotlib/matplotlib/assets/8880777/7aec0323-d080-4874-a945-3e464a6f0cbd)\r\n\r\nOn top of that, the doc says, `baseline=None` is a valid parameter value:\r\n\r\n![image](https://github.com/matplotlib/matplotlib/assets/8880777/d3726912-31e6-4665-8bf7-a1732f0feb3f)\r\n\r\nTherefore I'd expect it produces something more sensible than a fill with a slanted line connecting start and end point of the dataset?\r\n\r\n![image](https://github.com/matplotlib/matplotlib/assets/8880777/b1d32b49-423d-4137-8667-538b1d40e1a4)\r\n\r\n\r\n\r\n\n> Therefore I'd expect it produces something more sensible than a fill with a slanted line connecting start and end point of the dataset?\r\n\r\nI think joining the first and last points is a reasonable default. I don't think we would change it at this point.  \n> > Therefore I'd expect it produces something more sensible than a fill with a slanted line connecting start and end point of the dataset?\r\n> \r\n> I think joining the first and last points is a reasonable default. I don't think we would change it at this point.\r\n\r\nI'm struggling to think of a single use case where an outcome that creates slanted shading like presented above would be a desired outcome.\r\n\r\nPerhaps, a better default would be to set the baseline to `min(y)` if `baseline=None`?\r\n\r\nThis would look as follows:\r\n\r\n![image](https://github.com/matplotlib/matplotlib/assets/8880777/70e0cefa-a1ab-4165-aeab-4f5dafe69378)\r\n\r\nAgain, without the line the plot doesn't look as good, but at least the shading seems aligned with the data.\r\n\r\nA desired outcome recreated with `ax.plot()` and `ax.fill_between` would look as follows:\r\n\r\n![image](https://github.com/matplotlib/matplotlib/assets/8880777/d4457f3e-f7f3-4d42-bafd-1c212a0bdcfc)\r\n\n> > > Therefore I'd expect it produces something more sensible than a fill with a slanted line connecting start and end point of the dataset?\r\n> > \r\n> > \r\n> > I think joining the first and last points is a reasonable default. I don't think we would change it at this point.\r\n> \r\n> I'm struggling to think of a single use case where an outcome that creates slanted shading like presented above would be a desired outcome.\r\n> \r\n> Perhaps, a better default would be to set the baseline to `min(y)` if `baseline=None`?\r\n\r\n<s>I agree with that.</s>\r\n\r\nActually, the better approach would be to add a new option `baseline='min'` for that. This is more explicit that `None` and has the advantage that there is no API breakage involved.\nUnfortunately we can not, with a single Artist, get the desired effect.  Looking at the combinations of fill and baseline, we see:\r\n\r\n```python\r\nfrom cycler import cycler\r\nimport matplotlib.pyplot as plt\r\n\r\nfig, axs = plt.subplots(2, 2, layout=\"constrained\")\r\n\r\ncycle = cycler(\"baseline\", [0, None]) * cycler(\"fill\", [False, True])\r\n\r\n\r\nfor kwargs, ax in zip(cycle, axs.ravel()):\r\n    ax.stairs(\r\n        [4, 5, 1, 0, 2],\r\n        [1, 2, 3, 4, 5, 6],\r\n        facecolor=\"blue\",\r\n        lw=5,\r\n        edgecolor=\"k\",\r\n        **kwargs\r\n    )\r\n\r\n    ax.set_title(\"baseline={baseline} fill={fill}\".format(**kwargs))\r\n```\r\n![so](https://github.com/matplotlib/matplotlib/assets/199813/ce198f16-29aa-4807-9458-fbf5b1ecafce)\r\n\r\nso 3 out of 4 of them make sense!\r\n\r\n\r\nThe issue is that for stairs we draw the output as a single path. A path has a facecolor (the fill) and the edgecolor (the stroke).  There in no way to stroke _part_ of a Path, either we stroke it with a fixed width or color or not (leaving aside some really wild things with paths that are smaller than their line widths).  The one minor escape hatch we have is that if you fill an open path you can get exactly one edge not stroked which will go straight from the last to first point. This behavior is about the only sensible thing to do as the other options are error, silently not fill, or to fill all space.\r\n\r\nIt is not possible to draw the stairs missing the stroke on 3 edges (bottom and the two \"sides\") using a single path.  Either you include the baseline points, and then we will stroke the front and back, or you do not include them and then the fill is sensible but not at all what you want.\r\n\r\nI think the best you can do is two calls to stairs like\r\n\r\n```python\r\nfig, ax = plt.subplots()\r\nax.stairs(\r\n        [4, 5, 1, 0, 2],\r\n        [1, 2, 3, 4, 5, 6],\r\n        facecolor=\"blue\",\r\n        lw=0,\r\n        fill=True,\r\n        baseline=0\r\n    )\r\nax.stairs(\r\n        [4, 5, 1, 0, 2],\r\n        [1, 2, 3, 4, 5, 6],\r\n        lw=5,\r\n        edgecolor=\"k\",\r\n        fill=False,\r\n        baseline=None\r\n    )\r\n\r\n```\r\n\r\n![so](https://github.com/matplotlib/matplotlib/assets/199813/afea74e3-f99c-4a78-9345-f9a1386e6e77)\r\n\n> Unfortunately we can not, with a single Artist, get the desired effect. Looking at the combinations of fill and baseline, we see:\r\n> \r\n> ```python\r\n> from cycler import cycler\r\n> import matplotlib.pyplot as plt\r\n> \r\n> fig, axs = plt.subplots(2, 2, layout=\"constrained\")\r\n> \r\n> cycle = cycler(\"baseline\", [0, None]) * cycler(\"fill\", [False, True])\r\n> \r\n> \r\n> for kwargs, ax in zip(cycle, axs.ravel()):\r\n>     ax.stairs(\r\n>         [4, 5, 1, 0, 2],\r\n>         [1, 2, 3, 4, 5, 6],\r\n>         facecolor=\"blue\",\r\n>         lw=5,\r\n>         edgecolor=\"k\",\r\n>         **kwargs\r\n>     )\r\n> \r\n>     ax.set_title(\"baseline={baseline} fill={fill}\".format(**kwargs))\r\n> ```\r\n> \r\n> ![so](https://user-images.githubusercontent.com/199813/270037268-ce198f16-29aa-4807-9458-fbf5b1ecafce.png)\r\n> \r\n> so 3 out of 4 of them make sense!\r\n> \r\n> The issue is that for stairs we draw the output as a single path. A path has a facecolor (the fill) and the edgecolor (the stroke). There in no way to stroke _part_ of a Path, either we stroke it with a fixed width or color or not (leaving aside some really wild things with paths that are smaller than their line widths). The one minor escape hatch we have is that if you fill an open path you can get exactly one edge not stroked which will go straight from the last to first point. This behavior is about the only sensible thing to do as the other options are error, silently not fill, or to fill all space.\r\n> \r\n> It is not possible to draw the stairs missing the stroke on 3 edges (bottom and the two \"sides\") using a single path. Either you include the baseline points, and then we will stroke the front and back, or you do not include them and then the fill is sensible but not at all what you want.\r\n> \r\n> I think the best you can do is two calls to stairs like\r\n> \r\n> ```python\r\n> fig, ax = plt.subplots()\r\n> ax.stairs(\r\n>         [4, 5, 1, 0, 2],\r\n>         [1, 2, 3, 4, 5, 6],\r\n>         facecolor=\"blue\",\r\n>         lw=0,\r\n>         fill=True,\r\n>         baseline=0\r\n>     )\r\n> ax.stairs(\r\n>         [4, 5, 1, 0, 2],\r\n>         [1, 2, 3, 4, 5, 6],\r\n>         lw=5,\r\n>         edgecolor=\"k\",\r\n>         fill=False,\r\n>         baseline=None\r\n>     )\r\n> ```\r\n> \r\n> ![so](https://user-images.githubusercontent.com/199813/270039277-afea74e3-f99c-4a78-9345-f9a1386e6e77.png)\r\n\r\nI accept this explanation and it makes sense it might not be worth the effort to make any changes if the function works in majority of use cases.\r\n\r\nAnd one thing that you showed me is that you actually can set fill and edge colour in one call to `ax.stairs`.\r\n\r\nHowever one thing that bothers me now as a bit of inconsistency is that if you don't explicitly specify the `lw` parameter inside the `ax.stairs()`, then the default values are:\r\n* `lw=1` if `fill=False`\r\n* `lw=0` if `fill=True`\r\n\r\nWhy can't it always be `lw=1`?\r\n\r\nI discovered this by playing with your code:\r\n```python\r\nfrom cycler import cycler\r\nimport matplotlib.pyplot as plt\r\n\r\nfig, axs = plt.subplots(2, 2, layout=\"constrained\")\r\n\r\ncycle = cycler(\"baseline\", [0, None]) * cycler(\"fill\", [False, True])\r\n\r\nartists=[]\r\n\r\nfor kwargs, ax in zip(cycle, axs.ravel()):\r\n    a = ax.stairs(\r\n        [4, 5, 1, 0, 2],\r\n        [1, 2, 3, 4, 5, 6],\r\n        facecolor=\"blue\",\r\n        # lw=5,\r\n        edgecolor=\"k\",\r\n        **kwargs\r\n    )\r\n    artists.append(a)\r\n\r\n    ax.set_title(\"baseline={baseline} fill={fill}\".format(**kwargs))\r\n```\r\n\r\nIt gives you this:\r\n\r\n![image](https://github.com/matplotlib/matplotlib/assets/8880777/d07e124a-eee5-4c5f-b0df-e8cb9bad84e1)\r\n\r\nAt first I thought that perhaps the line is so thin and it somehow get printed behind the fill and that's why you can't see it. But when I checked the actual value, it indicated zero:\r\n\r\n```python\r\nfor a in artists:\r\n    print(a.get_linewidth())\r\n\r\n# Output:\r\n1.0\r\n0.0\r\n1.0\r\n0.0\r\n```\r\n\nAs part of the 2.0 style change we dropped edges on all filled things by default, but if there is no fill then we _have_ to draw the edge (or it is invisible!).", "created_at": "2024-04-05T20:25:31Z"}
{"repo": "matplotlib/matplotlib", "pull_number": 28032, "instance_id": "matplotlib__matplotlib-28032", "issue_numbers": ["28020"], "base_commit": "2723052176c2e1e5cc192061121423ad6685c954", "patch": "diff --git a/lib/matplotlib/image.py b/lib/matplotlib/image.py\nindex 5b0152505397..2e13293028ca 100644\n--- a/lib/matplotlib/image.py\n+++ b/lib/matplotlib/image.py\n@@ -1640,6 +1640,7 @@ def imsave(fname, arr, vmin=None, vmax=None, cmap=None, format=None,\n             # we modify this below, so make a copy (don't modify caller's dict)\n             pil_kwargs = pil_kwargs.copy()\n         pil_shape = (rgba.shape[1], rgba.shape[0])\n+        rgba = np.require(rgba, requirements='C')\n         image = PIL.Image.frombuffer(\n             \"RGBA\", pil_shape, rgba, \"raw\", \"RGBA\", 0, 1)\n         if format == \"png\":\n", "test_patch": "diff --git a/lib/matplotlib/tests/test_image.py b/lib/matplotlib/tests/test_image.py\nindex fdbba7299d2b..1602f86716cb 100644\n--- a/lib/matplotlib/tests/test_image.py\n+++ b/lib/matplotlib/tests/test_image.py\n@@ -205,6 +205,14 @@ def test_imsave(fmt):\n     assert_array_equal(arr_dpi1, arr_dpi100)\n \n \n+@pytest.mark.parametrize(\"origin\", [\"upper\", \"lower\"])\n+def test_imsave_rgba_origin(origin):\n+    # test that imsave always passes c-contiguous arrays down to pillow\n+    buf = io.BytesIO()\n+    result = np.zeros((10, 10, 4), dtype='uint8')\n+    mimage.imsave(buf, arr=result, format=\"png\", origin=origin)\n+\n+\n @pytest.mark.parametrize(\"fmt\", [\"png\", \"pdf\", \"ps\", \"eps\", \"svg\"])\n def test_imsave_fspath(fmt):\n     plt.imsave(Path(os.devnull), np.array([[0, 1]]), format=fmt)\n", "problem_statement": "[Bug]: imsave fails on RGBA data when origin is set to lower\n### Bug summary\r\n\r\nUnder certain conditions pyplot's imsave() function will fail, with the underlying PIL library throwing an \"array is not C-contiguous\" error (while the array provided to imsave is C-contiguous).\r\n\r\n### Code for reproduction\r\n\r\n```Python\r\nimport numpy as np\r\nimport matplotlib.pyplot as plt\r\n\r\nresult = np.zeros((100, 100, 4), dtype='uint8')\r\n\r\nprint(result.flags) # the ndarray is actually C-contiguous\r\n\r\nplt.imsave(fname=\"test_upper.png\", arr=result, format=\"png\", origin=\"upper\")# no problem\r\nplt.imsave(fname=\"test_lower.png\", arr=result, format=\"png\", origin=\"lower\")# error\r\n```\r\n\r\n\r\n### Actual outcome\r\n\r\n```\r\nFile [/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/matplotlib/pyplot.py:2200](http://localhost:8888/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/matplotlib/pyplot.py#line=2199), in imsave(fname, arr, **kwargs)\r\n   2198 @_copy_docstring_and_deprecators(matplotlib.image.imsave)\r\n   2199 def imsave(fname, arr, **kwargs):\r\n-> 2200     return matplotlib.image.imsave(fname, arr, **kwargs)\r\n\r\nFile [/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/matplotlib/image.py:1659](http://localhost:8888/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/matplotlib/image.py#line=1658), in imsave(fname, arr, vmin, vmax, cmap, format, origin, dpi, metadata, pil_kwargs)\r\n   1657     pil_kwargs = pil_kwargs.copy()\r\n   1658 pil_shape = (rgba.shape[1], rgba.shape[0])\r\n-> 1659 image = PIL.Image.frombuffer(\r\n   1660     \"RGBA\", pil_shape, rgba, \"raw\", \"RGBA\", 0, 1)\r\n   1661 if format == \"png\":\r\n   1662     # Only use the metadata kwarg if pnginfo is not set, because the\r\n   1663     # semantics of duplicate keys in pnginfo is unclear.\r\n   1664     if \"pnginfo\" in pil_kwargs:\r\n\r\nFile [/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/PIL/Image.py:3020](http://localhost:8888/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/PIL/Image.py#line=3019), in frombuffer(mode, size, data, decoder_name, *args)\r\n   3018 if args[0] in _MAPMODES:\r\n   3019     im = new(mode, (1, 1))\r\n-> 3020     im = im._new(core.map_buffer(data, size, decoder_name, 0, args))\r\n   3021     if mode == \"P\":\r\n   3022         from . import ImagePalette\r\n\r\nValueError: ndarray is not C-contiguous\r\n```\r\n\r\n### Expected outcome\r\n\r\nsaved image\r\n\r\n### Additional information\r\n\r\n- The input must be an input of size MxNx4. RGBA fails but RGB works.\r\n- The dtype must be uint8.\r\n- origin must be set to \"lower\"\r\n- Image file type can be set to png, jpg, gif, or tiff, and all trigger the same issue. It's likely not a codec-specific problem.\r\n- The data in the image does not matter.\r\n\r\nSuggestion from stackoverflow user Nick ODell:\r\n[https://github.com/matplotlib/matplotlib/blob/v3.8.3/lib/matplotlib/image.py#L1605](link to code)\r\n\r\nIf origin == \"lower\", then the array is reversed in a zero-copy fashion. If this happens, then arr is no longer C contiguous. It then uses ScalarMappable to convert to rgba. However, if the input is already in rgba, it does not copy it. Because of this, using RGB masks the bug, because the copy would be C contiguous.\r\n\r\nIt then calls PIL.Image.frombuffer, which appears to assume that its input is C contiguous. (Pillow doesn't appear to document this assumption, so this may actually be a Pillow bug?)\r\n\r\n### Operating system\r\n\r\n_No response_\r\n\r\n### Matplotlib Version\r\n\r\n3.8.3\r\n\r\n### Matplotlib Backend\r\n\r\n_No response_\r\n\r\n### Python version\r\n\r\n_No response_\r\n\r\n### Jupyter version\r\n\r\n_No response_\r\n\r\n### Installation\r\n\r\nNone\n", "hints_text": "I will call attention to Pillow's [`Image.fromarray`](https://pillow.readthedocs.io/en/stable/reference/Image.html#PIL.Image.fromarray) which calls out:\r\n\r\n> If `obj` is not contiguous, then the `tobytes` method is called and [`frombuffer()`](https://pillow.readthedocs.io/en/stable/reference/Image.html#PIL.Image.frombuffer) is used.\r\n\r\nWhich both points to this being intentional on the part of Pillow that `frombuffer` requires contiguous data (which honestly aligns with the name \"buffer\", though perhaps could be made more explicit) and suggests that we may be able to fix it by calling the alternate method.\ncan we pay the copy cost?\nTo be clear, `fromarray` is a thin wrapper of `frombuffer`, which does shape (and dtype, though only if `mode` is not explicit) validation, calls `tobytes` if and only if `strides != None` and calls `frombuffer`.\r\n\r\nSo a copy is only made if one is necessary*\r\n\r\n\\* technically, if the the strides given by `obj.__array_interface__.get(\"strides\")` are the tuple form of C-contiguous strides, rather than the implicit \"I'm C Contiguous\" marker `None`, then a copy will be made unnecessarily. By default, numpy arrays _do_ have None in that dictionary when c contiguous from what I see (including views made by reversing an axis and reversing back). but I think it would be valid to have the tuple spelled out.\r\n", "created_at": "2024-04-05T18:13:58Z"}
{"repo": "matplotlib/matplotlib", "pull_number": 28030, "instance_id": "matplotlib__matplotlib-28030", "issue_numbers": ["28016"], "base_commit": "d9210dfb6faa03b4583780a208ccc263a5bb8801", "patch": "diff --git a/lib/matplotlib/axes/_axes.py b/lib/matplotlib/axes/_axes.py\nindex 26a3a580ba3e..0df3b577fdde 100644\n--- a/lib/matplotlib/axes/_axes.py\n+++ b/lib/matplotlib/axes/_axes.py\n@@ -7272,14 +7272,14 @@ def stairs(self, values, edges=None, *,\n                 \"very likely that the resulting fill patterns is not the desired \"\n                 \"result.\"\n             )\n-        if baseline is None:\n-            baseline = 0\n-        if orientation == 'vertical':\n-            patch.sticky_edges.y.append(np.min(baseline))\n-            self.update_datalim([(edges[0], np.min(baseline))])\n-        else:\n-            patch.sticky_edges.x.append(np.min(baseline))\n-            self.update_datalim([(np.min(baseline), edges[0])])\n+\n+        if baseline is not None:\n+            if orientation == 'vertical':\n+                patch.sticky_edges.y.append(np.min(baseline))\n+                self.update_datalim([(edges[0], np.min(baseline))])\n+            else:\n+                patch.sticky_edges.x.append(np.min(baseline))\n+                self.update_datalim([(np.min(baseline), edges[0])])\n         self._request_autoscale_view()\n         return patch\n \n", "test_patch": "diff --git a/lib/matplotlib/tests/test_axes.py b/lib/matplotlib/tests/test_axes.py\nindex 3644f0861d1b..c024095b1c20 100644\n--- a/lib/matplotlib/tests/test_axes.py\n+++ b/lib/matplotlib/tests/test_axes.py\n@@ -2449,16 +2449,17 @@ def test_stairs_update(fig_test, fig_ref):\n \n \n @check_figures_equal(extensions=['png'])\n-def test_stairs_baseline_0(fig_test, fig_ref):\n-    # Test\n-    test_ax = fig_test.add_subplot()\n-    test_ax.stairs([5, 6, 7], baseline=None)\n+def test_stairs_baseline_None(fig_test, fig_ref):\n+    x = np.array([0, 2, 3, 5, 10])\n+    y = np.array([1.148, 1.231, 1.248, 1.25])\n+\n+    test_axes = fig_test.add_subplot()\n+    test_axes.stairs(y, x, baseline=None)\n \n-    # Ref\n-    ref_ax = fig_ref.add_subplot()\n     style = {'solid_joinstyle': 'miter', 'solid_capstyle': 'butt'}\n-    ref_ax.plot(range(4), [5, 6, 7, 7], drawstyle='steps-post', **style)\n-    ref_ax.set_ylim(0, None)\n+\n+    ref_axes = fig_ref.add_subplot()\n+    ref_axes.plot(x, np.append(y, y[-1]), drawstyle='steps-post', **style)\n \n \n def test_stairs_empty():\n", "problem_statement": "[Bug]: Unexpected ylim of stairs with baseline=None\n### Bug summary\n\nI am not sure if this is a bug or a feature:\r\nI wanted to do the following plot:\r\n![image](https://github.com/matplotlib/matplotlib/assets/59893197/0435e50f-d9d4-41e4-ab60-de390f8530f1)\r\n\r\nwhich can be done using the stairs method with `baseline=None` since I don't want the vertical lines in the extremes. But the plot I get is the following:\r\n![image](https://github.com/matplotlib/matplotlib/assets/59893197/576e32ed-35fa-40ac-8b35-fdd4090b3753)\r\n\r\nAs I was saying, I don't know if this is the expected behaviour of stairs, but I cannot think of a case where one would like to have the lower limit fixed to 0.\n\n### Code for reproduction\n\n```Python\nimport matplotlib.pyplot as plt\r\n\r\nbins = [0, 2, 3, 5, 10]\r\nx = [1.148, 1.231, 1.248, 1.25]\r\n\r\n# Plot using stairs\r\nplt.stairs(x, edges=bins, baseline=None)\r\n\r\n# Plot using step, which is less convenient, but handles the limits correctly\r\n# plt.step(bins, (*x, x[-1]), where='post')\r\n\r\n# plt.ylim(1.1429, 1.2551)\n```\n\n\n### Actual outcome\n\n![image](https://github.com/matplotlib/matplotlib/assets/59893197/576e32ed-35fa-40ac-8b35-fdd4090b3753)\r\n\n\n### Expected outcome\n\n![image](https://github.com/matplotlib/matplotlib/assets/59893197/0435e50f-d9d4-41e4-ab60-de390f8530f1)\n\n### Additional information\n\nThe problem originates from the lines inside the stairs function\r\n```\r\nif baseline is None:\r\n    baseline = 0\r\nif orientation == 'vertical':\r\n    patch.sticky_edges.y.append(np.min(baseline))\r\n    self.update_datalim([(edges[0], np.min(baseline))])\r\nelse:\r\n    patch.sticky_edges.x.append(np.min(baseline))\r\n    self.update_datalim([(np.min(baseline), edges[0])])\r\n```\r\n\r\nI think that the sticky_edges should not be used when baseline is None. If that is not possible for some other reason, setting `baseline = values` instead of 0 would probably be more intuitive, or something like `baseline = (1 + self._ymargin) * np.min(values) - self._ymargin * np.max(values)`.\n\n### Operating system\n\n_No response_\n\n### Matplotlib Version\n\n3.7.1\n\n### Matplotlib Backend\n\n_No response_\n\n### Python version\n\n_No response_\n\n### Jupyter version\n\n_No response_\n\n### Installation\n\nNone\n", "hints_text": "> I think that the sticky_edges should not be used when baseline is None.\r\n\r\nI agree. Do you want to create a pull request with a fix?\nI think the documentation of the parameter is a bit lacking of what `baseline=None` means as well; is it really \"no baseline\"? Also, what happens with `fill=True`?\n`None` really means no baseline, it leaves out the horizontal edges at the far left and right side. That can be desirable in certain situations. It's a feature. And yes fill becomes awkward in that case, see #26752.\r\n\r\nIf we want something else, https://github.com/matplotlib/matplotlib/issues/26752#issuecomment-1719178161 would be a reasonable extension.\n> I agree. Do you want to create a pull request with a fix?\r\n\r\nI don't have the time right now to do a PR in conditions, so if anyone else wants to implement this, go ahead. Otherwise, I can give it a shot in 1 or 2 months when I have some free time.\nI can create a PR for this issue\nGo for it.", "created_at": "2024-04-05T09:17:09Z"}
{"repo": "matplotlib/matplotlib", "pull_number": 27992, "instance_id": "matplotlib__matplotlib-27992", "issue_numbers": ["27978", "0000"], "base_commit": "55cf8c70214be559268719f0f1049f98c6c6731a", "patch": "diff --git a/lib/matplotlib/pyplot.py b/lib/matplotlib/pyplot.py\nindex 3b1a01c28408..52850f128cae 100644\n--- a/lib/matplotlib/pyplot.py\n+++ b/lib/matplotlib/pyplot.py\n@@ -983,30 +983,42 @@ def figure(\n     `~matplotlib.rcParams` defines the default values, which can be modified\n     in the matplotlibrc file.\n     \"\"\"\n+    allnums = get_fignums()\n+\n     if isinstance(num, FigureBase):\n         # type narrowed to `Figure | SubFigure` by combination of input and isinstance\n         if num.canvas.manager is None:\n             raise ValueError(\"The passed figure is not managed by pyplot\")\n+        elif any([figsize, dpi, facecolor, edgecolor, not frameon,\n+                  kwargs]) and num.canvas.manager.num in allnums:\n+            _api.warn_external(\n+                \"Ignoring specified arguments in this call \"\n+                f\"because figure with num: {num.canvas.manager.num} already exists\")\n         _pylab_helpers.Gcf.set_active(num.canvas.manager)\n         return num.figure\n \n-    allnums = get_fignums()\n     next_num = max(allnums) + 1 if allnums else 1\n     fig_label = ''\n     if num is None:\n         num = next_num\n-    elif isinstance(num, str):\n-        fig_label = num\n-        all_labels = get_figlabels()\n-        if fig_label not in all_labels:\n-            if fig_label == 'all':\n-                _api.warn_external(\"close('all') closes all existing figures.\")\n-            num = next_num\n-        else:\n-            inum = all_labels.index(fig_label)\n-            num = allnums[inum]\n     else:\n-        num = int(num)  # crude validation of num argument\n+        if any([figsize, dpi, facecolor, edgecolor, not frameon,\n+                kwargs]) and num in allnums:\n+            _api.warn_external(\n+                \"Ignoring specified arguments in this call \"\n+                f\"because figure with num: {num} already exists\")\n+        if isinstance(num, str):\n+            fig_label = num\n+            all_labels = get_figlabels()\n+            if fig_label not in all_labels:\n+                if fig_label == 'all':\n+                    _api.warn_external(\"close('all') closes all existing figures.\")\n+                num = next_num\n+            else:\n+                inum = all_labels.index(fig_label)\n+                num = allnums[inum]\n+        else:\n+            num = int(num)  # crude validation of num argument\n \n     # Type of \"num\" has narrowed to int, but mypy can't quite see it\n     manager = _pylab_helpers.Gcf.get_fig_manager(num)  # type: ignore[arg-type]\n", "test_patch": "diff --git a/lib/matplotlib/tests/test_pyplot.py b/lib/matplotlib/tests/test_pyplot.py\nindex a077aede8f8b..63dc239df2e8 100644\n--- a/lib/matplotlib/tests/test_pyplot.py\n+++ b/lib/matplotlib/tests/test_pyplot.py\n@@ -457,3 +457,22 @@ def test_figure_hook():\n         fig = plt.figure()\n \n     assert fig._test_was_here\n+\n+\n+def test_multiple_same_figure_calls():\n+    fig = mpl.pyplot.figure(1, figsize=(1, 2))\n+    with pytest.warns(UserWarning, match=\"Ignoring specified arguments in this call\"):\n+        fig2 = mpl.pyplot.figure(1, figsize=(3, 4))\n+    with pytest.warns(UserWarning, match=\"Ignoring specified arguments in this call\"):\n+        mpl.pyplot.figure(fig, figsize=(5, 6))\n+    assert fig is fig2\n+    fig3 = mpl.pyplot.figure(1)  # Checks for false warnings\n+    assert fig is fig3\n+\n+\n+def test_close_all_warning():\n+    fig1 = plt.figure()\n+\n+    # Check that the warning is issued when 'all' is passed to plt.figure\n+    with pytest.warns(UserWarning, match=\"closes all existing figures\"):\n+        fig2 = plt.figure(\"all\")\n", "problem_statement": "[Bug]:  strange behaviour when redefining figure size\n### Bug summary\r\n\r\nsetting figure size using the figsize parameter to matplotlib.pyplot.figure works just fine, but setting it to a different value in the same script fails in case the first argument to the figure call is an identifier.\r\n\r\n### Code for reproduction\r\n\r\n```Python\r\nimport matplotlib.pyplot\r\n# first call\r\nfig = matplotlib.pyplot.figure(1,figsize=(1,2))\r\nfig.get_figheight()\r\nfig.get_figwidth()\r\n# second call\r\nfig = matplotlib.pyplot.figure(1,figsize=(3,4))\r\nfig.get_figheight()\r\nfig.get_figwidth()\r\n```\r\n\r\n\r\n### Actual outcome\r\n\r\n```Python\r\n>>> import matplotlib.pyplot\r\n>>> # first call\r\n>>> fig = matplotlib.pyplot.figure(1,figsize=(1,2))\r\nQt: Session management error: Could not open network socket\r\n>>> fig.get_figheight()\r\n2.0\r\n>>> fig.get_figwidth()\r\n1.0\r\n>>> # second call\r\n>>> fig = matplotlib.pyplot.figure(1,figsize=(3,4))\r\n>>> fig.get_figheight()\r\n2.0\r\n>>> fig.get_figwidth()\r\n1.0\r\n>>> \r\n```\r\n\r\n### Expected outcome\r\n\r\nThe second call should change the figure size and the get_figheight/get_figwidth methods should report the changed size.\r\n\r\n### Additional information\r\n\r\nNote that the problem does not occur if no identifier is provided to the figure call, so this works just fine:\r\n```Python\r\nfig = matplotlib.pyplot.figure(figsize=(3,4))\r\nfig.get_figheight()\r\nfig.get_figwidth()\r\n```\r\n### Operating system\r\n\r\nFedora 39 linux\r\n\r\n### Matplotlib Version\r\n\r\n3.8.2\r\n\r\n### Matplotlib Backend\r\n\r\nQtAgg\r\n\r\n### Python version\r\n\r\nPython 3.12.2\r\n\r\n### Jupyter version\r\n\r\nn.a.\r\n\r\n### Installation\r\n\r\nLinux package manager\n", "hints_text": "`figure(1, ...)` returns a figure with the given id if that exists, or creates one if not.\r\n\r\nThe second call just returns the same figure again. Kim against modifying an existing figure through the interface. We may discuss whether we want to warn on that. I think a recall should not have any parameters. Currently, they are ignored. The only downside would be that you can now do the exact same call twice. But I argue that creation and recall are fundamentally different and the user should know which one they want. (This does not improve the situation for. the no kwargs case, but at least does not yield a figure other than expected.\nWell, this behaviour clearly surprised me, and it took me some time to find the issue when working on some code that I did not write myself.\r\nYes, I think it would be good to issue a warning if a user tries to add additional parameters on a second call.\r\nThe syntax of the call suggests that this is an instantiation of a class and therefore would create a new figure with new settings, but clearly this is not the case for the second call.\r\nI think it would be much more clear if there was a second function, called something like get_figure(identifier) to retrieve an already existing figure. Without identifier it could just be the same as gcf()\nFor context, the current behavior derives from how Matlab behaves. In\r\nMatlab, calling `figure(1)` either creates a new figure with that id, or\r\ngives you back the existing figure. I do think a warning would be\r\nappropriate. Maybe we keep an internal dictionary mapping the figure id to\r\nits instantiation arguments (or perhaps more robustly, store them in the\r\nFigure object itself?).\r\n\r\nOn Tue, Mar 26, 2024 at 9:54\u202fAM Jos de Kloe ***@***.***>\r\nwrote:\r\n\r\n> Well, this behaviour clearly surprised me, and it took me some time to\r\n> find the issue when working on some code that I did not write myself.\r\n> Yes, I think it would be good to issue a warning if a user tries to add\r\n> additional parameters on a second call.\r\n> The syntax of the call suggests that this is an instantiation of a class\r\n> and therefore would create a new figure with new settings, but clearly this\r\n> is not the case for the second call.\r\n> I think it would be much more clear if there was a second function, called\r\n> something like get_figure(identifier) to retrieve an already existing\r\n> figure. Without identifier it could just be the same as gcf()\r\n>\r\n> \u2014\r\n> Reply to this email directly, view it on GitHub\r\n> <https://github.com/matplotlib/matplotlib/issues/27978#issuecomment-2020492797>,\r\n> or unsubscribe\r\n> <https://github.com/notifications/unsubscribe-auth/AACHF6C7HIT2A6FP6DWYNW3Y2FVXJAVCNFSM6AAAAABFIZKWRKVHI2DSMVQWIX3LMV43OSLTON2WKQ3PNVWWK3TUHMZDAMRQGQ4TENZZG4>\r\n> .\r\n> You are receiving this because you are subscribed to this thread.Message\r\n> ID: ***@***.***>\r\n>\r\n\nI agree we should we warning if user input is ignored.  I have a vague memory that we have talked about this before but got stuck on what should we do in the case of\r\n\r\n```python\r\nimport matplotlib.pyplot\r\n# first call\r\nfig = matplotlib.pyplot.figure(1,figsize=(1,2))\r\nfig.get_figheight()\r\nfig.get_figwidth()\r\n# second call\r\nfig = matplotlib.pyplot.figure(1,figsize=(1,2))\r\nfig.get_figheight()\r\nfig.get_figwidth()\r\n```\r\n\r\nOn one hand, we should warn because we are reusing the figure and ignoring all of the users input, on the other hand the values match the values that are already on the existing figure so we should not warn because they actually got what the wanted.\r\n\r\nIt is possible I may be remembering a similar discussion about reusing existing axes?\nI can see an argument to warn also for a second identical call with kwargs: while you get the same type of figure, in any non-trivial use case, you\u2018ll get an empty figure for the first call and a non-empty figure for the second call. These are so fundamentally different that it\u2018s unlikely you can work with them correctly if you don\u2018t know from context which one you\u2019ll get. And if you know the figure exists, `figure(N)` just means \u201emake figure N active\u201c no need to repeat its arguments. Also since this is likely used interactively, the short version without arguments is more convenient.\r\n\r\n--\r\n\r\nEdit: To give context: What options do we have?\r\n\r\n#### Do nothing at all\r\n\r\nDisadvantage: The above example: You call with an explicit parameter but get back something different\r\n\r\n```\r\n>>> fig = plt.figure(1,figsize=(1,2))\r\n>>> fig = plt.figure(1,figsize=(3,4))\r\n>>> fig.get_figheight()\r\n2.0\r\n>>> fig.get_figwidth()\r\n1.0\r\n```\r\n\r\n#### Only warn if the given parameters do not match\r\n\r\nTechnical note: Detecting this correctly is somewhat cumbersome. You have to store the called parameters; and maybe normalize (e.g. positional vs. kwarg usage).\r\n\r\nUsability note: Would we require to replicate all args for the recall, or should we accept the bare `figure(1)` as well even if the first call had the arguments? - IMHO clearly the second. This is primarily for interactive use and forcing to type out all kwargs again would be annoying.\r\n\r\n#### Always warn if parameters are given for a recall.\r\n\r\nWhile one could argue that `plt.figure(1)` returning a figure with non-standard parameters is surprising, you really don't know what you are getting from the code because lots of configuration is determined by `rcParams`.\r\n\r\nSecond, as stated above, recall is mainly for interactive usage, so the short version is desireable, and nobody should need to type out the parameters again. So warning on two identical kwarg calls is ok - it may even be helpful, because you may think you get a new figure, but you don't.\r\n\r\n---\r\n\r\nOverall for simplicity and safety, I propose to always warn if parameters are given for a recall.\n> Overall for simplicity and safety, I propose to always warn if parameters are given for a recall.\r\n\r\nI agree with this proposal.", "created_at": "2024-03-29T16:20:44Z"}
{"repo": "matplotlib/matplotlib", "pull_number": 27964, "instance_id": "matplotlib__matplotlib-27964", "issue_numbers": ["27820", "0000"], "base_commit": "a218d5cace6408e7dc79aa6fbccd8f8c1eec5998", "patch": "diff --git a/lib/matplotlib/image.py b/lib/matplotlib/image.py\nindex 5b0152505397..43b8c007a867 100644\n--- a/lib/matplotlib/image.py\n+++ b/lib/matplotlib/image.py\n@@ -1085,12 +1085,16 @@ def make_image(self, renderer, magnification=1.0, unsampled=False):\n                 B[:, :, 0:3] = A\n                 B[:, :, 3] = 255\n                 A = B\n-        vl = self.axes.viewLim\n         l, b, r, t = self.axes.bbox.extents\n         width = int(((round(r) + 0.5) - (round(l) - 0.5)) * magnification)\n         height = int(((round(t) + 0.5) - (round(b) - 0.5)) * magnification)\n-        x_pix = np.linspace(vl.x0, vl.x1, width)\n-        y_pix = np.linspace(vl.y0, vl.y1, height)\n+\n+        invertedTransform = self.axes.transData.inverted()\n+        x_pix = invertedTransform.transform(\n+            [(x, b) for x in np.linspace(l, r, width)])[:, 0]\n+        y_pix = invertedTransform.transform(\n+            [(l, y) for y in np.linspace(b, t, height)])[:, 1]\n+\n         if self._interpolation == \"nearest\":\n             x_mid = (self._Ax[:-1] + self._Ax[1:]) / 2\n             y_mid = (self._Ay[:-1] + self._Ay[1:]) / 2\n", "test_patch": "diff --git a/lib/matplotlib/tests/baseline_images/test_image/nonuniform_and_pcolor.png b/lib/matplotlib/tests/baseline_images/test_image/nonuniform_and_pcolor.png\nindex cb0aa4815c4e..0d6060411751 100644\nBinary files a/lib/matplotlib/tests/baseline_images/test_image/nonuniform_and_pcolor.png and b/lib/matplotlib/tests/baseline_images/test_image/nonuniform_and_pcolor.png differ\ndiff --git a/lib/matplotlib/tests/baseline_images/test_image/nonuniform_logscale.png b/lib/matplotlib/tests/baseline_images/test_image/nonuniform_logscale.png\nnew file mode 100644\nindex 000000000000..da2c0467864e\nBinary files /dev/null and b/lib/matplotlib/tests/baseline_images/test_image/nonuniform_logscale.png differ\ndiff --git a/lib/matplotlib/tests/test_image.py b/lib/matplotlib/tests/test_image.py\nindex fdbba7299d2b..dea5fc991e06 100644\n--- a/lib/matplotlib/tests/test_image.py\n+++ b/lib/matplotlib/tests/test_image.py\n@@ -1406,6 +1406,27 @@ def test_nonuniform_and_pcolor():\n         ax.set(xlim=(0, 10))\n \n \n+@image_comparison([\"nonuniform_logscale.png\"], style=\"mpl20\")\n+def test_nonuniform_logscale():\n+    _, axs = plt.subplots(ncols=3, nrows=1)\n+\n+    for i in range(3):\n+        ax = axs[i]\n+        im = NonUniformImage(ax)\n+        im.set_data(np.arange(1, 4) ** 2, np.arange(1, 4) ** 2,\n+                    np.arange(9).reshape((3, 3)))\n+        ax.set_xlim(1, 16)\n+        ax.set_ylim(1, 16)\n+        ax.set_box_aspect(1)\n+        if i == 1:\n+            ax.set_xscale(\"log\", base=2)\n+            ax.set_yscale(\"log\", base=2)\n+        if i == 2:\n+            ax.set_xscale(\"log\", base=4)\n+            ax.set_yscale(\"log\", base=4)\n+        ax.add_image(im)\n+\n+\n @image_comparison(\n     ['rgba_antialias.png'], style='mpl20', remove_text=True,\n     tol=0 if platform.machine() == 'x86_64' else 0.007)\n", "problem_statement": "[Bug]: Logscale Axis + NonUniformImage + GUI move tool = Distortion\n### Bug summary\n\nRun the code below, which uses set.xscale(\"log\") and NonUniformImage. Choose the move tool (Arrows in all 4 directions) and try to pan the image around. Instead of panning, image distorts.\n\n### Code for reproduction\n\n```Python\nimport numpy as np\r\nimport matplotlib.pyplot as plt\r\nfrom matplotlib.image import NonUniformImage\r\n\r\nchg=np.logspace(0,1,10)\r\nchg1=chg[:,None]\r\nchg2=chg[None,:]\r\ng=chg1+chg2\r\ng+=50*(np.add.outer(np.arange(10),np.arange(10))%2)\r\n#checkerboard, to make effect clearer\r\nfig,ax=plt.subplots()\r\nax.set_xscale(\"log\")\r\nax.set_yscale(\"log\")\r\nim=NonUniformImage(ax,extent=[chg[0],chg[-1],chg[0],chg[-1]],origin=\"lower\")\r\n\r\n\r\nim.set_data(np.linspace(1,10,10),np.linspace(1,10,10),g)\r\nax.add_image(im)\r\n\r\nplt.show()\n```\n\n\n### Actual outcome\n\n![image](https://github.com/matplotlib/matplotlib/assets/12258311/a4f872e8-35b5-4ec1-bf03-ec07664611f1)\r\n![image](https://github.com/matplotlib/matplotlib/assets/12258311/9059a6ee-a489-4848-9f37-b178ca2c31e7)\r\n\r\nThese are supposed to be the same image. I just used the pan tool. \r\nBut the aspect ratio has changed. And the boundary of the rightmost colour change has gone from 0.75 to 0.5.\r\n\r\nClicking and dragging produces behaviour that is visually obviously not-right. \r\n\n\n### Expected outcome\n\nThe image should pan around. \n\n### Additional information\n\n No bug appears when I use a plt.imshow on the log scale axis. Or when I use the same NonUniformImage code without the logscale axis. The bug only appears with all 3 conditions are met.\r\n\r\nI was trying to find a sensible way to display an image on log-log axes with constant screen space per pixel, when I discovered this bug. \r\n\n\n### Operating system\n\nUbuntu\n\n### Matplotlib Version\n\n3.8.0\n\n### Matplotlib Backend\n\nQtAgg\n\n### Python version\n\nPython 3.11.5\n\n### Jupyter version\n\n_No response_\n\n### Installation\n\nconda\n", "hints_text": "Suggest using pcolormesh for this.  \nThe boundaries not being correct does actually behave the same way on a linear scale - if you scroll past the lower limit (1) in the example above the axes stays blue, instead of scrolling past the image into an empty white area.", "created_at": "2024-03-22T17:14:33Z"}
{"repo": "matplotlib/matplotlib", "pull_number": 27952, "instance_id": "matplotlib__matplotlib-27952", "issue_numbers": ["22376", "0000"], "base_commit": "394b80d59755c07e7f7ae2122a66f4191d9d6cf7", "patch": "diff --git a/doc/api/figure_api.rst b/doc/api/figure_api.rst\nindex 937020afd8fc..2371e5a9a863 100644\n--- a/doc/api/figure_api.rst\n+++ b/doc/api/figure_api.rst\n@@ -71,6 +71,7 @@ Annotating\n    Figure.align_labels\n    Figure.align_xlabels\n    Figure.align_ylabels\n+   Figure.align_titles\n    Figure.autofmt_xdate\n \n \n@@ -264,6 +265,7 @@ Annotating\n    SubFigure.align_labels\n    SubFigure.align_xlabels\n    SubFigure.align_ylabels\n+   SubFigure.align_titles\n \n Adding and getting Artists\n --------------------------\ndiff --git a/doc/users/next_whats_new/figure_align_titles.rst b/doc/users/next_whats_new/figure_align_titles.rst\nnew file mode 100644\nindex 000000000000..230e5f0a8990\n--- /dev/null\n+++ b/doc/users/next_whats_new/figure_align_titles.rst\n@@ -0,0 +1,7 @@\n+subplot titles can now be automatically aligned\n+-----------------------------------------------\n+\n+Subplot axes titles can be misaligned vertically if tick labels or\n+xlabels are placed at the top of one subplot. The new method on the\n+`.Figure` class: `.Figure.align_titles` will now align the titles\n+vertically.\ndiff --git a/galleries/examples/subplots_axes_and_figures/align_labels_demo.py b/galleries/examples/subplots_axes_and_figures/align_labels_demo.py\nindex 88f443ca0076..4935878ee027 100644\n--- a/galleries/examples/subplots_axes_and_figures/align_labels_demo.py\n+++ b/galleries/examples/subplots_axes_and_figures/align_labels_demo.py\n@@ -1,37 +1,43 @@\n \"\"\"\n-===============\n-Aligning Labels\n-===============\n+==========================\n+Aligning Labels and Titles\n+==========================\n \n-Aligning xlabel and ylabel using `.Figure.align_xlabels` and\n-`.Figure.align_ylabels`\n+Aligning xlabel, ylabel, and title using `.Figure.align_xlabels`,\n+`.Figure.align_ylabels`, and `.Figure.align_titles`.\n \n-`.Figure.align_labels` wraps these two functions.\n+`.Figure.align_labels` wraps the x and y label functions.\n \n Note that the xlabel \"XLabel1 1\" would normally be much closer to the\n-x-axis, and \"YLabel1 0\" would be much closer to the y-axis of their\n-respective axes.\n+x-axis, \"YLabel0 0\" would be much closer to the y-axis, and title\n+\"Title0 0\" would be much closer to the top of their respective axes.\n \"\"\"\n import matplotlib.pyplot as plt\n import numpy as np\n \n-import matplotlib.gridspec as gridspec\n+fig, axs = plt.subplots(2, 2, layout='constrained')\n \n-fig = plt.figure(tight_layout=True)\n-gs = gridspec.GridSpec(2, 2)\n-\n-ax = fig.add_subplot(gs[0, :])\n+ax = axs[0][0]\n ax.plot(np.arange(0, 1e6, 1000))\n-ax.set_ylabel('YLabel0')\n-ax.set_xlabel('XLabel0')\n+ax.set_title('Title0 0')\n+ax.set_ylabel('YLabel0 0')\n+\n+ax = axs[0][1]\n+ax.plot(np.arange(1., 0., -0.1) * 2000., np.arange(1., 0., -0.1))\n+ax.set_title('Title0 1')\n+ax.xaxis.tick_top()\n+ax.tick_params(axis='x', rotation=55)\n+\n \n for i in range(2):\n-    ax = fig.add_subplot(gs[1, i])\n+    ax = axs[1][i]\n     ax.plot(np.arange(1., 0., -0.1) * 2000., np.arange(1., 0., -0.1))\n     ax.set_ylabel('YLabel1 %d' % i)\n     ax.set_xlabel('XLabel1 %d' % i)\n     if i == 0:\n         ax.tick_params(axis='x', rotation=55)\n+\n fig.align_labels()  # same as fig.align_xlabels(); fig.align_ylabels()\n+fig.align_titles()\n \n plt.show()\ndiff --git a/lib/matplotlib/axes/_base.py b/lib/matplotlib/axes/_base.py\nindex 23cc1c869c07..0164f4e11169 100644\n--- a/lib/matplotlib/axes/_base.py\n+++ b/lib/matplotlib/axes/_base.py\n@@ -2985,8 +2985,13 @@ def _update_title_position(self, renderer):\n \n         titles = (self.title, self._left_title, self._right_title)\n \n-        # Need to check all our twins too, and all the children as well.\n-        axs = self._twinned_axes.get_siblings(self) + self.child_axes\n+        # Need to check all our twins too, aligned axes, and all the children\n+        # as well.\n+        axs = set()\n+        axs.update(self.child_axes)\n+        axs.update(self._twinned_axes.get_siblings(self))\n+        axs.update(self.figure._align_label_groups['title'].get_siblings(self))\n+\n         for ax in self.child_axes:  # Child positions must be updated first.\n             locator = ax.get_axes_locator()\n             ax.apply_aspect(locator(self, renderer) if locator else None)\ndiff --git a/lib/matplotlib/figure.py b/lib/matplotlib/figure.py\nindex 087c193d48c3..0a0ff01a2571 100644\n--- a/lib/matplotlib/figure.py\n+++ b/lib/matplotlib/figure.py\n@@ -132,10 +132,14 @@ def __init__(self, **kwargs):\n         self._supxlabel = None\n         self._supylabel = None\n \n-        # groupers to keep track of x and y labels we want to align.\n-        # see self.align_xlabels and self.align_ylabels and\n-        # axis._get_tick_boxes_siblings\n-        self._align_label_groups = {\"x\": cbook.Grouper(), \"y\": cbook.Grouper()}\n+        # groupers to keep track of x, y labels and title we want to align.\n+        # see self.align_xlabels, self.align_ylabels,\n+        # self.align_titles, and axis._get_tick_boxes_siblings\n+        self._align_label_groups = {\n+            \"x\": cbook.Grouper(),\n+            \"y\": cbook.Grouper(),\n+            \"title\": cbook.Grouper()\n+        }\n \n         self._localaxes = []  # track all Axes\n         self.artists = []\n@@ -1293,7 +1297,7 @@ def subplots_adjust(self, left=None, bottom=None, right=None, top=None,\n \n     def align_xlabels(self, axs=None):\n         \"\"\"\n-        Align the xlabels of subplots in the same subplot column if label\n+        Align the xlabels of subplots in the same subplot row if label\n         alignment is being done automatically (i.e. the label position is\n         not manually set).\n \n@@ -1314,6 +1318,7 @@ def align_xlabels(self, axs=None):\n         See Also\n         --------\n         matplotlib.figure.Figure.align_ylabels\n+        matplotlib.figure.Figure.align_titles\n         matplotlib.figure.Figure.align_labels\n \n         Notes\n@@ -1375,6 +1380,7 @@ def align_ylabels(self, axs=None):\n         See Also\n         --------\n         matplotlib.figure.Figure.align_xlabels\n+        matplotlib.figure.Figure.align_titles\n         matplotlib.figure.Figure.align_labels\n \n         Notes\n@@ -1412,6 +1418,53 @@ def align_ylabels(self, axs=None):\n                         # grouper for groups of ylabels to align\n                         self._align_label_groups['y'].join(ax, axc)\n \n+    def align_titles(self, axs=None):\n+        \"\"\"\n+        Align the titles of subplots in the same subplot row if title\n+        alignment is being done automatically (i.e. the title position is\n+        not manually set).\n+\n+        Alignment persists for draw events after this is called.\n+\n+        Parameters\n+        ----------\n+        axs : list of `~matplotlib.axes.Axes`\n+            Optional list of (or ndarray) `~matplotlib.axes.Axes`\n+            to align the titles.\n+            Default is to align all Axes on the figure.\n+\n+        See Also\n+        --------\n+        matplotlib.figure.Figure.align_xlabels\n+        matplotlib.figure.Figure.align_ylabels\n+        matplotlib.figure.Figure.align_labels\n+\n+        Notes\n+        -----\n+        This assumes that ``axs`` are from the same `.GridSpec`, so that\n+        their `.SubplotSpec` positions correspond to figure positions.\n+\n+        Examples\n+        --------\n+        Example with titles::\n+\n+            fig, axs = plt.subplots(1, 2)\n+            axs[0].set_aspect('equal')\n+            axs[0].set_title('Title 0')\n+            axs[1].set_title('Title 1')\n+            fig.align_titles()\n+        \"\"\"\n+        if axs is None:\n+            axs = self.axes\n+        axs = [ax for ax in np.ravel(axs) if ax.get_subplotspec() is not None]\n+        for ax in axs:\n+            _log.debug(' Working on: %s', ax.get_title())\n+            rowspan = ax.get_subplotspec().rowspan\n+            for axc in axs:\n+                rowspanc = axc.get_subplotspec().rowspan\n+                if (rowspan.start == rowspanc.start):\n+                    self._align_label_groups['title'].join(ax, axc)\n+\n     def align_labels(self, axs=None):\n         \"\"\"\n         Align the xlabels and ylabels of subplots with the same subplots\n@@ -1430,8 +1483,8 @@ def align_labels(self, axs=None):\n         See Also\n         --------\n         matplotlib.figure.Figure.align_xlabels\n-\n         matplotlib.figure.Figure.align_ylabels\n+        matplotlib.figure.Figure.align_titles\n         \"\"\"\n         self.align_xlabels(axs=axs)\n         self.align_ylabels(axs=axs)\ndiff --git a/lib/matplotlib/figure.pyi b/lib/matplotlib/figure.pyi\nindex 687ae9e500d0..eae21c2614f0 100644\n--- a/lib/matplotlib/figure.pyi\n+++ b/lib/matplotlib/figure.pyi\n@@ -161,6 +161,7 @@ class FigureBase(Artist):\n     ) -> None: ...\n     def align_xlabels(self, axs: Iterable[Axes] | None = ...) -> None: ...\n     def align_ylabels(self, axs: Iterable[Axes] | None = ...) -> None: ...\n+    def align_titles(self, axs: Iterable[Axes] | None = ...) -> None: ...\n     def align_labels(self, axs: Iterable[Axes] | None = ...) -> None: ...\n     def add_gridspec(self, nrows: int = ..., ncols: int = ..., **kwargs) -> GridSpec: ...\n     @overload\n", "test_patch": "diff --git a/lib/matplotlib/tests/baseline_images/test_figure/figure_align_titles_constrained.png b/lib/matplotlib/tests/baseline_images/test_figure/figure_align_titles_constrained.png\nnew file mode 100644\nindex 000000000000..78dffc18e20c\nBinary files /dev/null and b/lib/matplotlib/tests/baseline_images/test_figure/figure_align_titles_constrained.png differ\ndiff --git a/lib/matplotlib/tests/baseline_images/test_figure/figure_align_titles_tight.png b/lib/matplotlib/tests/baseline_images/test_figure/figure_align_titles_tight.png\nnew file mode 100644\nindex 000000000000..f719ae6931f0\nBinary files /dev/null and b/lib/matplotlib/tests/baseline_images/test_figure/figure_align_titles_tight.png differ\ndiff --git a/lib/matplotlib/tests/test_figure.py b/lib/matplotlib/tests/test_figure.py\nindex 8ee6aae99361..58aecd3dea8b 100644\n--- a/lib/matplotlib/tests/test_figure.py\n+++ b/lib/matplotlib/tests/test_figure.py\n@@ -66,6 +66,32 @@ def test_align_labels():\n     fig.align_labels()\n \n \n+@image_comparison(['figure_align_titles_tight.png',\n+                   'figure_align_titles_constrained.png'],\n+                  tol=0 if platform.machine() == 'x86_64' else 0.022,\n+                  style='mpl20')\n+def test_align_titles():\n+    for layout in ['tight', 'constrained']:\n+        fig, axs = plt.subplots(1, 2, layout=layout, width_ratios=[2, 1])\n+\n+        ax = axs[0]\n+        ax.plot(np.arange(0, 1e6, 1000))\n+        ax.set_title('Title0 left', loc='left')\n+        ax.set_title('Title0 center', loc='center')\n+        ax.set_title('Title0 right', loc='right')\n+\n+        ax = axs[1]\n+        ax.plot(np.arange(0, 1e4, 100))\n+        ax.set_title('Title1')\n+        ax.set_xlabel('Xlabel0')\n+        ax.xaxis.set_label_position(\"top\")\n+        ax.xaxis.tick_top()\n+        for tick in ax.get_xticklabels():\n+            tick.set_rotation(90)\n+\n+        fig.align_titles()\n+\n+\n def test_align_labels_stray_axes():\n     fig, axs = plt.subplots(2, 2)\n     for nn, ax in enumerate(axs.flat):\n", "problem_statement": "[ENH]: align_titles\n### Problem\n\nThere's align_xlabels and align_ylabels to align the x and y labels, but no align_titles; this would be useful e.g. for\r\n```python\r\nfrom pylab import *\r\nfig, axs = subplots(1, 2, subplot_kw={\"xlabel\": \"x\", \"ylabel\": \"y\", \"title\": \"t\"})\r\naxs[0].imshow(zeros((3, 5)))\r\naxs[1].imshow(zeros((5, 3)))\r\nfig.align_labels()\r\n```\r\n![test](https://user-images.githubusercontent.com/1322974/152163429-d1169ce2-8818-4fb2-9a9b-545780a49a10.png)\n\n### Proposed solution\n\nAdd Figure.align_titles.\n", "hints_text": "This is _probably_ a good first issue; you have to copy what `align_xlabels` does, but using the title texts.\n@QuLogic / @anntzer  - I would like to work on this, can I give it a try? :)\nGo for it.\nThanks @anntzer . Will start working on it\n@pradhanvickey are you still working on this issue?\r\n\nWe tend not to reserve issues.  If there is no PR feel free to submit one.  \n@QuLogic / @anntzer. Both @lijake8 and myself would like to work on this. Is this okay?\r\n\r\nTake\nIs this issue still open?\r\nIf yes can you assign me @anntzer ?\r\n\nSee https://matplotlib.org/devdocs/devel/contributing.html#issues-for-new-contributors.\nI don\u2019t see any PR on the issue but probably @neil-gurnani  is still working on it. I\u2019ll wait a couple of days or look for a different issue.\nI've been looking at this for a couple weeks -- it doesn't appear to be as easy as expected. We can replicate the grouping of axes with the the same rowspans, as done in align_xlabels(), however, updating the title location is done in the _AxesBase class, while the label updates are done in the Figure class. Importantly, the Figure class has access to subplots, but the axesBase class does not have a way to access the subplots or a grouper we make in the figure class, where align_titles() would exist. @anntzer  I'm new to Matplotlib, was wondering if there is some workaround I'm missing to share the relevant data between the classes.\r\n\r\nBasically, we'd need to share either a grouper object or subplot location information from the Figure class (where the align_titles function would be written) to the axesBase class (where the title update occurs). Do you have any thoughts or are we missing anthing?\nthe title moving logic was copied from the x/ylabel moving logic,  so aligning the titles should be possible after the automated moving that happens in `Axes`, just as its possible to align the x/y labels. \nI took a quick look at this again.  The logic in `axis.py` is exactly the same logic you would need to use in `_base.py` in `_update_title_position`.  You can just make another `_align_label_groups['titles']`.  I think there are some details to work out, but the information flow is exactly the same as for the way it is set up now.  \nThank you for the response! That's what I tried, but I don't see how the AxesBase class in` _base.py `has access to the `_align_label_groups['titles']` which is part of the FigureBase class.\nEach axes has a self.figure.  \n@jklymak That helped! We figured it out and are working on testing and documentation\r\n", "created_at": "2024-03-20T16:02:30Z"}
{"repo": "matplotlib/matplotlib", "pull_number": 27948, "instance_id": "matplotlib__matplotlib-27948", "issue_numbers": ["27663"], "base_commit": "4cbef2d4c049aa5c748d646e38fd9803278a5695", "patch": "diff --git a/doc/users/next_whats_new/backend_registry.rst b/doc/users/next_whats_new/backend_registry.rst\nindex 61b65a9d6470..7632c978f9c5 100644\n--- a/doc/users/next_whats_new/backend_registry.rst\n+++ b/doc/users/next_whats_new/backend_registry.rst\n@@ -3,4 +3,15 @@ BackendRegistry\n \n New :class:`~matplotlib.backends.registry.BackendRegistry` class is the single\n source of truth for available backends. The singleton instance is\n-``matplotlib.backends.backend_registry``.\n+``matplotlib.backends.backend_registry``. It is used internally by Matplotlib,\n+and also IPython (and therefore Jupyter) starting with IPython 8.24.0.\n+\n+There are three sources of backends: built-in (source code is within the\n+Matplotlib repository), explicit ``module://some.backend`` syntax (backend is\n+obtained by loading the module), or via an entry point (self-registering\n+backend in an external package).\n+\n+To obtain a list of all registered backends use:\n+\n+    >>> from matplotlib.backends import backend_registry\n+    >>> backend_registry.list_all()\ndiff --git a/galleries/users_explain/figure/backends.rst b/galleries/users_explain/figure/backends.rst\nindex 0aa20fc58862..dc6d8a89457d 100644\n--- a/galleries/users_explain/figure/backends.rst\n+++ b/galleries/users_explain/figure/backends.rst\n@@ -175,7 +175,8 @@ QtAgg     Agg rendering in a Qt_ canvas (requires PyQt_ or `Qt for Python`_,\n           more details.\n ipympl    Agg rendering embedded in a Jupyter widget (requires ipympl_).\n           This backend can be enabled in a Jupyter notebook with\n-          ``%matplotlib ipympl``.\n+          ``%matplotlib ipympl`` or ``%matplotlib widget``.  Works with\n+          Jupyter ``lab`` and ``notebook>=7``.\n GTK3Agg   Agg rendering to a GTK_ 3.x canvas (requires PyGObject_ and\n           pycairo_).  This backend can be activated in IPython with\n           ``%matplotlib gtk3``.\n@@ -188,7 +189,8 @@ TkAgg     Agg rendering to a Tk_ canvas (requires TkInter_). This\n           backend can be activated in IPython with ``%matplotlib tk``.\n nbAgg     Embed an interactive figure in a Jupyter classic notebook.  This\n           backend can be enabled in Jupyter notebooks via\n-          ``%matplotlib notebook``.\n+          ``%matplotlib notebook`` or ``%matplotlib nbagg``.  Works with\n+          Jupyter ``notebook<7`` and ``nbclassic``.\n WebAgg    On ``show()`` will start a tornado server with an interactive\n           figure.\n GTK3Cairo Cairo rendering to a GTK_ 3.x canvas (requires PyGObject_ and\n@@ -200,7 +202,7 @@ wxAgg     Agg rendering to a wxWidgets_ canvas (requires wxPython_ 4).\n ========= ================================================================\n \n .. note::\n-   The names of builtin backends case-insensitive; e.g., 'QtAgg' and\n+   The names of builtin backends are case-insensitive; e.g., 'QtAgg' and\n    'qtagg' are equivalent.\n \n .. _`Anti-Grain Geometry`: http://agg.sourceforge.net/antigrain.com/\n@@ -222,11 +224,13 @@ wxAgg     Agg rendering to a wxWidgets_ canvas (requires wxPython_ 4).\n .. _wxWidgets: https://www.wxwidgets.org/\n .. _ipympl: https://www.matplotlib.org/ipympl\n \n+.. _ipympl_install:\n+\n ipympl\n ^^^^^^\n \n-The Jupyter widget ecosystem is moving too fast to support directly in\n-Matplotlib.  To install ipympl:\n+The ipympl backend is in a separate package that must be explicitly installed\n+if you wish to use it, for example:\n \n .. code-block:: bash\n \ndiff --git a/galleries/users_explain/figure/figure_intro.rst b/galleries/users_explain/figure/figure_intro.rst\nindex 462a3fc848dc..80cbb3aeeb45 100644\n--- a/galleries/users_explain/figure/figure_intro.rst\n+++ b/galleries/users_explain/figure/figure_intro.rst\n@@ -52,14 +52,20 @@ Notebooks and IDEs\n \n If you are using a Notebook (e.g. `Jupyter <https://jupyter.org>`_) or an IDE\n that renders Notebooks (PyCharm, VSCode, etc), then they have a backend that\n-will render the Matplotlib Figure when a code cell is executed.  One thing to\n-be aware of is that the default Jupyter backend (``%matplotlib inline``) will\n+will render the Matplotlib Figure when a code cell is executed.  The default\n+Jupyter backend (``%matplotlib inline``) creates static plots that\n by default trim or expand the figure size to have a tight box around Artists\n-added to the Figure (see :ref:`saving_figures`, below).  If you use a backend\n-other than the default \"inline\" backend, you will likely need to use an ipython\n-\"magic\" like ``%matplotlib notebook`` for the Matplotlib :ref:`notebook\n-<jupyter_notebooks_jupyterlab>` or ``%matplotlib widget`` for the  `ipympl\n-<https://matplotlib.org/ipympl/>`_ backend.\n+added to the Figure (see :ref:`saving_figures`, below).  For interactive plots\n+in Jupyter you will need to use an ipython \"magic\" like ``%matplotlib widget``\n+for the  `ipympl <https://matplotlib.org/ipympl/>`_ backend in ``jupyter lab``\n+or ``notebook>=7``, or ``%matplotlib notebook`` for the Matplotlib\n+:ref:`notebook <jupyter_notebooks_jupyterlab>` in ``notebook<7`` or\n+``nbclassic``.\n+\n+.. note::\n+\n+    The  `ipympl <https://matplotlib.org/ipympl/>`_ backend is in a separate\n+    package, see :ref:`Installing ipympl <ipympl_install>`.\n \n .. figure:: /_static/FigureNotebook.png\n     :alt: Image of figure generated in Jupyter Notebook with notebook\n@@ -75,15 +81,6 @@ other than the default \"inline\" backend, you will likely need to use an ipython\n .. seealso::\n     :ref:`interactive_figures`.\n \n-.. note::\n-\n-   If you only need to use the classic notebook (i.e. ``notebook<7``),\n-   you can use:\n-\n-   .. sourcecode:: ipython\n-\n-   %matplotlib notebook\n-\n .. _standalone-scripts-and-interactive-use:\n \n Standalone scripts and interactive use\n@@ -104,7 +101,7 @@ backend.  These are typically chosen either in the user's :ref:`matplotlibrc\n     QtAgg backend.\n \n When run from a script, or interactively (e.g. from an\n-`iPython shell <https://ipython.readthedocs.io/en/stable/>`_) the Figure\n+`IPython shell <https://ipython.readthedocs.io/en/stable/>`_) the Figure\n will not be shown until we call ``plt.show()``. The Figure will appear in\n a new GUI window, and usually will have a toolbar with Zoom, Pan, and other tools\n for interacting with the Figure.  By default, ``plt.show()`` blocks\ndiff --git a/galleries/users_explain/figure/writing_a_backend_pyplot_interface.rst b/galleries/users_explain/figure/writing_a_backend_pyplot_interface.rst\nindex 452f4d7610bb..c8dccc24da43 100644\n--- a/galleries/users_explain/figure/writing_a_backend_pyplot_interface.rst\n+++ b/galleries/users_explain/figure/writing_a_backend_pyplot_interface.rst\n@@ -84,3 +84,47 @@ Function-based API\n 2. **Showing figures**: `.pyplot.show()` calls a module-level ``show()``\n    function, which is typically generated via the ``ShowBase`` class and its\n    ``mainloop`` method.\n+\n+Registering a backend\n+---------------------\n+\n+For a new backend to be usable via ``matplotlib.use()`` or IPython\n+``%matplotlib`` magic command, it must be compatible with one of the three ways\n+supported by the :class:`~matplotlib.backends.registry.BackendRegistry`:\n+\n+Built-in\n+^^^^^^^^\n+\n+A backend built into Matplotlib must have its name and\n+``FigureCanvas.required_interactive_framework`` hard-coded in the\n+:class:`~matplotlib.backends.registry.BackendRegistry`.  If the backend module\n+is not ``f\"matplotlib.backends.backend_{backend_name.lower()}\"`` then there\n+must also be an entry in the ``BackendRegistry._name_to_module``.\n+\n+module:// syntax\n+^^^^^^^^^^^^^^^^\n+\n+Any backend in a separate module (not built into Matplotlib) can be used by\n+specifying the path to the module in the form ``module://some.backend.module``.\n+An example is ``module://mplcairo.qt`` for\n+`mplcairo <https:////github.com/matplotlib/mplcairo>`_.  The backend's\n+interactive framework will be taken from its\n+``FigureCanvas.required_interactive_framework``.\n+\n+Entry point\n+^^^^^^^^^^^\n+\n+An external backend module can self-register as a backend using an\n+``entry point`` in its ``pyproject.toml`` such as the one used by\n+``matplotlib-inline``:\n+\n+.. code-block:: toml\n+\n+    [project.entry-points.\"matplotlib.backend\"]\n+    inline = \"matplotlib_inline.backend_inline\"\n+\n+The backend's interactive framework will be taken from its\n+``FigureCanvas.required_interactive_framework``.  All entry points are loaded\n+together but only when first needed, such as when a backend name is not\n+recognised as a built-in backend, or when\n+:meth:`~matplotlib.backends.registry.BackendRegistry.list_all` is first called.\ndiff --git a/lib/matplotlib/__init__.py b/lib/matplotlib/__init__.py\nindex cc94e530133b..9e9325a27d73 100644\n--- a/lib/matplotlib/__init__.py\n+++ b/lib/matplotlib/__init__.py\n@@ -1208,7 +1208,7 @@ def use(backend, *, force=True):\n         backend names, which are case-insensitive:\n \n         - interactive backends:\n-          GTK3Agg, GTK3Cairo, GTK4Agg, GTK4Cairo, MacOSX, nbAgg, QtAgg,\n+          GTK3Agg, GTK3Cairo, GTK4Agg, GTK4Cairo, MacOSX, nbAgg, notebook, QtAgg,\n           QtCairo, TkAgg, TkCairo, WebAgg, WX, WXAgg, WXCairo, Qt5Agg, Qt5Cairo\n \n         - non-interactive backends:\n@@ -1216,6 +1216,8 @@ def use(backend, *, force=True):\n \n         or a string of the form: ``module://my.module.name``.\n \n+        notebook is a synonym for nbAgg.\n+\n         Switching to an interactive backend is not possible if an unrelated\n         event loop has already been started (e.g., switching to GTK3Agg if a\n         TkAgg window has already been opened).  Switching to a non-interactive\ndiff --git a/lib/matplotlib/backend_bases.py b/lib/matplotlib/backend_bases.py\nindex e90c110c193b..d7430a4494fd 100644\n--- a/lib/matplotlib/backend_bases.py\n+++ b/lib/matplotlib/backend_bases.py\n@@ -1766,8 +1766,16 @@ def _fix_ipython_backend2gui(cls):\n         # `ipython --auto`).  This cannot be done at import time due to\n         # ordering issues, so we do it when creating a canvas, and should only\n         # be done once per class (hence the `cache`).\n-        if sys.modules.get(\"IPython\") is None:\n+\n+        # This function will not be needed when Python 3.12, the latest version\n+        # supported by IPython < 8.24, reaches end-of-life in late 2028.\n+        # At that time this function can be made a no-op and deprecated.\n+        mod_ipython = sys.modules.get(\"IPython\")\n+        if mod_ipython is None or mod_ipython.version_info[:2] >= (8, 24):\n+            # Use of backend2gui is not needed for IPython >= 8.24 as the\n+            # functionality has been moved to Matplotlib.\n             return\n+\n         import IPython\n         ip = IPython.get_ipython()\n         if not ip:\n@@ -2030,9 +2038,8 @@ def _switch_canvas_and_return_print_method(self, fmt, backend=None):\n         canvas = None\n         if backend is not None:\n             # Return a specific canvas class, if requested.\n-            canvas_class = (\n-                importlib.import_module(cbook._backend_module_name(backend))\n-                .FigureCanvas)\n+            from .backends.registry import backend_registry\n+            canvas_class = backend_registry.load_backend_module(backend).FigureCanvas\n             if not hasattr(canvas_class, f\"print_{fmt}\"):\n                 raise ValueError(\n                     f\"The {backend!r} backend does not support {fmt} output\")\ndiff --git a/lib/matplotlib/backends/registry.py b/lib/matplotlib/backends/registry.py\nindex 484d6ed5f26d..19b4cba254ab 100644\n--- a/lib/matplotlib/backends/registry.py\n+++ b/lib/matplotlib/backends/registry.py\n@@ -1,4 +1,5 @@\n from enum import Enum\n+import importlib\n \n \n class BackendFilter(Enum):\n@@ -20,36 +21,168 @@ class BackendRegistry:\n     All use of ``BackendRegistry`` should be via the singleton instance\n     ``backend_registry`` which can be imported from ``matplotlib.backends``.\n \n+    Each backend has a name, a module name containing the backend code, and an\n+    optional GUI framework that must be running if the backend is interactive.\n+    There are three sources of backends: built-in (source code is within the\n+    Matplotlib repository), explicit ``module://some.backend`` syntax (backend is\n+    obtained by loading the module), or via an entry point (self-registering\n+    backend in an external package).\n+\n     .. versionadded:: 3.9\n     \"\"\"\n-    # Built-in backends are those which are included in the Matplotlib repo.\n-    # A backend with name 'name' is located in the module\n-    # f'matplotlib.backends.backend_{name.lower()}'\n-\n-    # The capitalized forms are needed for ipython at present; this may\n-    # change for later versions.\n-    _BUILTIN_INTERACTIVE = [\n-        \"GTK3Agg\", \"GTK3Cairo\", \"GTK4Agg\", \"GTK4Cairo\",\n-        \"MacOSX\",\n-        \"nbAgg\",\n-        \"QtAgg\", \"QtCairo\", \"Qt5Agg\", \"Qt5Cairo\",\n-        \"TkAgg\", \"TkCairo\",\n-        \"WebAgg\",\n-        \"WX\", \"WXAgg\", \"WXCairo\",\n-    ]\n-    _BUILTIN_NOT_INTERACTIVE = [\n-        \"agg\", \"cairo\", \"pdf\", \"pgf\", \"ps\", \"svg\", \"template\",\n-    ]\n-    _GUI_FRAMEWORK_TO_BACKEND_MAPPING = {\n-        \"qt\": \"qtagg\",\n+    # Mapping of built-in backend name to GUI framework, or \"headless\" for no\n+    # GUI framework. Built-in backends are those which are included in the\n+    # Matplotlib repo. A backend with name 'name' is located in the module\n+    # f\"matplotlib.backends.backend_{name.lower()}\"\n+    _BUILTIN_BACKEND_TO_GUI_FRAMEWORK = {\n+        \"gtk3agg\": \"gtk3\",\n+        \"gtk3cairo\": \"gtk3\",\n+        \"gtk4agg\": \"gtk4\",\n+        \"gtk4cairo\": \"gtk4\",\n+        \"macosx\": \"macosx\",\n+        \"nbagg\": \"nbagg\",\n+        \"notebook\": \"nbagg\",\n+        \"qtagg\": \"qt\",\n+        \"qtcairo\": \"qt\",\n+        \"qt5agg\": \"qt5\",\n+        \"qt5cairo\": \"qt5\",\n+        \"tkagg\": \"tk\",\n+        \"tkcairo\": \"tk\",\n+        \"webagg\": \"webagg\",\n+        \"wx\": \"wx\",\n+        \"wxagg\": \"wx\",\n+        \"wxcairo\": \"wx\",\n+        \"agg\": \"headless\",\n+        \"cairo\": \"headless\",\n+        \"pdf\": \"headless\",\n+        \"pgf\": \"headless\",\n+        \"ps\": \"headless\",\n+        \"svg\": \"headless\",\n+        \"template\": \"headless\",\n+    }\n+\n+    # Reverse mapping of gui framework to preferred built-in backend.\n+    _GUI_FRAMEWORK_TO_BACKEND = {\n         \"gtk3\": \"gtk3agg\",\n         \"gtk4\": \"gtk4agg\",\n-        \"wx\": \"wxagg\",\n-        \"tk\": \"tkagg\",\n-        \"macosx\": \"macosx\",\n         \"headless\": \"agg\",\n+        \"macosx\": \"macosx\",\n+        \"qt\": \"qtagg\",\n+        \"qt5\": \"qt5agg\",\n+        \"qt6\": \"qtagg\",\n+        \"tk\": \"tkagg\",\n+        \"wx\": \"wxagg\",\n     }\n \n+    def __init__(self):\n+        # Only load entry points when first needed.\n+        self._loaded_entry_points = False\n+\n+        # Mapping of non-built-in backend to GUI framework, added dynamically from\n+        # entry points and from matplotlib.use(\"module://some.backend\") format.\n+        # New entries have an \"unknown\" GUI framework that is determined when first\n+        # needed by calling _get_gui_framework_by_loading.\n+        self._backend_to_gui_framework = {}\n+\n+        # Mapping of backend name to module name, where different from\n+        # f\"matplotlib.backends.backend_{backend_name.lower()}\". These are either\n+        # hardcoded for backward compatibility, or loaded from entry points or\n+        # \"module://some.backend\" syntax.\n+        self._name_to_module = {\n+            \"notebook\": \"nbagg\",\n+        }\n+\n+    def _backend_module_name(self, backend):\n+        # Return name of module containing the specified backend.\n+        # Does not check if the backend is valid, use is_valid_backend for that.\n+        backend = backend.lower()\n+\n+        # Check if have specific name to module mapping.\n+        backend = self._name_to_module.get(backend, backend)\n+\n+        return (backend[9:] if backend.startswith(\"module://\")\n+                else f\"matplotlib.backends.backend_{backend}\")\n+\n+    def _clear(self):\n+        # Clear all dynamically-added data, used for testing only.\n+        self.__init__()\n+\n+    def _ensure_entry_points_loaded(self):\n+        # Load entry points, if they have not already been loaded.\n+        if not self._loaded_entry_points:\n+            entries = self._read_entry_points()\n+            self._validate_and_store_entry_points(entries)\n+            self._loaded_entry_points = True\n+\n+    def _get_gui_framework_by_loading(self, backend):\n+        # Determine GUI framework for a backend by loading its module and reading the\n+        # FigureCanvas.required_interactive_framework attribute.\n+        # Returns \"headless\" if there is no GUI framework.\n+        module = self.load_backend_module(backend)\n+        canvas_class = module.FigureCanvas\n+        return canvas_class.required_interactive_framework or \"headless\"\n+\n+    def _read_entry_points(self):\n+        # Read entry points of modules that self-advertise as Matplotlib backends.\n+        # Expects entry points like this one from matplotlib-inline (in pyproject.toml\n+        # format):\n+        #   [project.entry-points.\"matplotlib.backend\"]\n+        #   inline = \"matplotlib_inline.backend_inline\"\n+        import importlib.metadata as im\n+        import sys\n+\n+        # entry_points group keyword not available before Python 3.10\n+        group = \"matplotlib.backend\"\n+        if sys.version_info >= (3, 10):\n+            entry_points = im.entry_points(group=group)\n+        else:\n+            entry_points = im.entry_points().get(group, ())\n+        entries = [(entry.name, entry.value) for entry in entry_points]\n+\n+        # For backward compatibility, if matplotlib-inline and/or ipympl are installed\n+        # but too old to include entry points, create them. Do not import ipympl\n+        # directly as this calls matplotlib.use() whilst in this function.\n+        def backward_compatible_entry_points(\n+                entries, module_name, threshold_version, names, target):\n+            from matplotlib import _parse_to_version_info\n+            try:\n+                module_version = im.version(module_name)\n+                if _parse_to_version_info(module_version) < threshold_version:\n+                    for name in names:\n+                        entries.append((name, target))\n+            except im.PackageNotFoundError:\n+                pass\n+\n+        names = [entry[0] for entry in entries]\n+        if \"inline\" not in names:\n+            backward_compatible_entry_points(\n+                entries, \"matplotlib_inline\", (0, 1, 7), [\"inline\"],\n+                \"matplotlib_inline.backend_inline\")\n+        if \"ipympl\" not in names:\n+            backward_compatible_entry_points(\n+                entries, \"ipympl\", (0, 9, 4), [\"ipympl\", \"widget\"],\n+                \"ipympl.backend_nbagg\")\n+\n+        return entries\n+\n+    def _validate_and_store_entry_points(self, entries):\n+        # Validate and store entry points so that they can be used via matplotlib.use()\n+        # in the normal manner. Entry point names cannot be of module:// format, cannot\n+        # shadow a built-in backend name, and cannot be duplicated.\n+        for name, module in entries:\n+            name = name.lower()\n+            if name.startswith(\"module://\"):\n+                raise RuntimeError(\n+                    f\"Entry point name '{name}' cannot start with 'module://'\")\n+            if name in self._BUILTIN_BACKEND_TO_GUI_FRAMEWORK:\n+                raise RuntimeError(f\"Entry point name '{name}' is a built-in backend\")\n+            if name in self._backend_to_gui_framework:\n+                raise RuntimeError(f\"Entry point name '{name}' duplicated\")\n+\n+            self._name_to_module[name] = \"module://\" + module\n+            # Do not yet know backend GUI framework, determine it only when necessary.\n+            self._backend_to_gui_framework[name] = \"unknown\"\n+\n     def backend_for_gui_framework(self, framework):\n         \"\"\"\n         Return the name of the backend corresponding to the specified GUI framework.\n@@ -61,10 +194,74 @@ def backend_for_gui_framework(self, framework):\n \n         Returns\n         -------\n-        str\n-            Backend name.\n+        str or None\n+            Backend name or None if GUI framework not recognised.\n+        \"\"\"\n+        return self._GUI_FRAMEWORK_TO_BACKEND.get(framework.lower())\n+\n+    def is_valid_backend(self, backend):\n+        \"\"\"\n+        Return True if the backend name is valid, False otherwise.\n+\n+        A backend name is valid if it is one of the built-in backends or has been\n+        dynamically added via an entry point. Those beginning with ``module://`` are\n+        always considered valid and are added to the current list of all backends\n+        within this function.\n+\n+        Even if a name is valid, it may not be importable or usable. This can only be\n+        determined by loading and using the backend module.\n+\n+        Parameters\n+        ----------\n+        backend : str\n+            Name of backend.\n+\n+        Returns\n+        -------\n+        bool\n+            True if backend is valid, False otherwise.\n+        \"\"\"\n+        backend = backend.lower()\n+\n+        # For backward compatibility, convert ipympl and matplotlib-inline long\n+        # module:// names to their shortened forms.\n+        backwards_compat = {\n+            \"module://ipympl.backend_nbagg\": \"widget\",\n+            \"module://matplotlib_inline.backend_inline\": \"inline\",\n+        }\n+        backend = backwards_compat.get(backend, backend)\n+\n+        if (backend in self._BUILTIN_BACKEND_TO_GUI_FRAMEWORK or\n+                backend in self._backend_to_gui_framework):\n+            return True\n+\n+        if backend.startswith(\"module://\"):\n+            self._backend_to_gui_framework[backend] = \"unknown\"\n+            return True\n+\n+        # Only load entry points if really need to and not already done so.\n+        self._ensure_entry_points_loaded()\n+        if backend in self._backend_to_gui_framework:\n+            return True\n+\n+        return False\n+\n+    def list_all(self):\n+        \"\"\"\n+        Return list of all known backends.\n+\n+        These include built-in backends and those obtained at runtime either from entry\n+        points or explicit ``module://some.backend`` syntax.\n+\n+        Entry points will be loaded if they haven't been already.\n+\n+        Returns\n+        -------\n+        list of str\n+            Backend names.\n         \"\"\"\n-        return self._GUI_FRAMEWORK_TO_BACKEND_MAPPING.get(framework)\n+        self._ensure_entry_points_loaded()\n+        return [*self.list_builtin(), *self._backend_to_gui_framework]\n \n     def list_builtin(self, filter_=None):\n         \"\"\"\n@@ -82,11 +279,132 @@ def list_builtin(self, filter_=None):\n             Backend names.\n         \"\"\"\n         if filter_ == BackendFilter.INTERACTIVE:\n-            return self._BUILTIN_INTERACTIVE\n+            return [k for k, v in self._BUILTIN_BACKEND_TO_GUI_FRAMEWORK.items()\n+                    if v != \"headless\"]\n         elif filter_ == BackendFilter.NON_INTERACTIVE:\n-            return self._BUILTIN_NOT_INTERACTIVE\n+            return [k for k, v in self._BUILTIN_BACKEND_TO_GUI_FRAMEWORK.items()\n+                    if v == \"headless\"]\n+\n+        return [*self._BUILTIN_BACKEND_TO_GUI_FRAMEWORK]\n+\n+    def list_gui_frameworks(self):\n+        \"\"\"\n+        Return list of GUI frameworks used by Matplotlib backends.\n+\n+        Returns\n+        -------\n+        list of str\n+            GUI framework names.\n+        \"\"\"\n+        return [k for k in self._GUI_FRAMEWORK_TO_BACKEND if k != \"headless\"]\n+\n+    def load_backend_module(self, backend):\n+        \"\"\"\n+        Load and return the module containing the specified backend.\n+\n+        Parameters\n+        ----------\n+        backend : str\n+            Name of backend to load.\n+\n+        Returns\n+        -------\n+        Module\n+            Module containing backend.\n+        \"\"\"\n+        module_name = self._backend_module_name(backend)\n+        return importlib.import_module(module_name)\n+\n+    def resolve_backend(self, backend):\n+        \"\"\"\n+        Return the backend and GUI framework for the specified backend name.\n+\n+        If the GUI framework is not yet known then it will be determined by loading the\n+        backend module and checking the ``FigureCanvas.required_interactive_framework``\n+        attribute.\n+\n+        This function only loads entry points if they have not already been loaded and\n+        the backend is not built-in and not of ``module://some.backend`` format.\n+\n+        Parameters\n+        ----------\n+        backend : str or None\n+            Name of backend, or None to use the default backend.\n+\n+        Returns\n+        -------\n+        backend : str\n+            The backend name.\n+        framework : str or None\n+            The GUI framework, which will be None for a backend that is non-interactive.\n+        \"\"\"\n+        if isinstance(backend, str):\n+            backend = backend.lower()\n+        else:  # Might be _auto_backend_sentinel or None\n+            # Use whatever is already running...\n+            from matplotlib import get_backend\n+            backend = get_backend()\n+\n+        # Is backend already known (built-in or dynamically loaded)?\n+        gui = (self._BUILTIN_BACKEND_TO_GUI_FRAMEWORK.get(backend) or\n+               self._backend_to_gui_framework.get(backend))\n+\n+        # Is backend \"module://something\"?\n+        if gui is None and isinstance(backend, str) and backend.startswith(\"module://\"):\n+            gui = \"unknown\"\n+\n+        # Is backend a possible entry point?\n+        if gui is None and not self._loaded_entry_points:\n+            self._ensure_entry_points_loaded()\n+            gui = self._backend_to_gui_framework.get(backend)\n+\n+        # Backend known but not its gui framework.\n+        if gui == \"unknown\":\n+            gui = self._get_gui_framework_by_loading(backend)\n+            self._backend_to_gui_framework[backend] = gui\n+\n+        if gui is None:\n+            raise RuntimeError(f\"'{backend}' is not a recognised backend name\")\n+\n+        return backend, gui if gui != \"headless\" else None\n+\n+    def resolve_gui_or_backend(self, gui_or_backend):\n+        \"\"\"\n+        Return the backend and GUI framework for the specified string that may be\n+        either a GUI framework or a backend name, tested in that order.\n+\n+        This is for use with the IPython %matplotlib magic command which may be a GUI\n+        framework such as ``%matplotlib qt`` or a backend name such as\n+        ``%matplotlib qtagg``.\n+\n+        This function only loads entry points if they have not already been loaded and\n+        the backend is not built-in and not of ``module://some.backend`` format.\n+\n+        Parameters\n+        ----------\n+        gui_or_backend : str or None\n+            Name of GUI framework or backend, or None to use the default backend.\n+\n+        Returns\n+        -------\n+        backend : str\n+            The backend name.\n+        framework : str or None\n+            The GUI framework, which will be None for a backend that is non-interactive.\n+        \"\"\"\n+        gui_or_backend = gui_or_backend.lower()\n+\n+        # First check if it is a gui loop name.\n+        backend = self.backend_for_gui_framework(gui_or_backend)\n+        if backend is not None:\n+            return backend, gui_or_backend if gui_or_backend != \"headless\" else None\n \n-        return self._BUILTIN_INTERACTIVE + self._BUILTIN_NOT_INTERACTIVE\n+        # Then check if it is a backend name.\n+        try:\n+            return self.resolve_backend(gui_or_backend)\n+        except Exception:  # KeyError ?\n+            raise RuntimeError(\n+                f\"'{gui_or_backend} is not a recognised GUI loop or backend name\")\n \n \n # Singleton\ndiff --git a/lib/matplotlib/backends/registry.pyi b/lib/matplotlib/backends/registry.pyi\nindex e48531be471d..e1ae5b3e7d3a 100644\n--- a/lib/matplotlib/backends/registry.pyi\n+++ b/lib/matplotlib/backends/registry.pyi\n@@ -1,4 +1,5 @@\n from enum import Enum\n+from types import ModuleType\n \n \n class BackendFilter(Enum):\n@@ -7,8 +8,28 @@ class BackendFilter(Enum):\n \n \n class BackendRegistry:\n-    def backend_for_gui_framework(self, interactive_framework: str) -> str | None: ...\n+    _BUILTIN_BACKEND_TO_GUI_FRAMEWORK: dict[str, str]\n+    _GUI_FRAMEWORK_TO_BACKEND: dict[str, str]\n+\n+    _loaded_entry_points: bool\n+    _backend_to_gui_framework: dict[str, str]\n+    _name_to_module: dict[str, str]\n+\n+    def _backend_module_name(self, backend: str) -> str: ...\n+    def _clear(self) -> None: ...\n+    def _ensure_entry_points_loaded(self) -> None: ...\n+    def _get_gui_framework_by_loading(self, backend: str) -> str: ...\n+    def _read_entry_points(self) -> list[tuple[str, str]]: ...\n+    def _validate_and_store_entry_points(self, entries: list[tuple[str, str]]) -> None: ...\n+\n+    def backend_for_gui_framework(self, framework: str) -> str | None: ...\n+    def is_valid_backend(self, backend: str) -> bool: ...\n+    def list_all(self) -> list[str]: ...\n     def list_builtin(self, filter_: BackendFilter | None) -> list[str]: ...\n+    def list_gui_frameworks(self) -> list[str]: ...\n+    def load_backend_module(self, backend: str) -> ModuleType: ...\n+    def resolve_backend(self, backend: str | None) -> tuple[str, str | None]: ...\n+    def resolve_gui_or_backend(self, gui_or_backend: str | None) -> tuple[str, str | None]: ...\n \n \n backend_registry: BackendRegistry\ndiff --git a/lib/matplotlib/cbook.py b/lib/matplotlib/cbook.py\nindex d6d48ecc928c..e4f60aac37a8 100644\n--- a/lib/matplotlib/cbook.py\n+++ b/lib/matplotlib/cbook.py\n@@ -2224,15 +2224,6 @@ def _check_and_log_subprocess(command, logger, **kwargs):\n     return proc.stdout\n \n \n-def _backend_module_name(name):\n-    \"\"\"\n-    Convert a backend name (either a standard backend -- \"Agg\", \"TkAgg\", ... --\n-    or a custom backend -- \"module://...\") to the corresponding module name).\n-    \"\"\"\n-    return (name[9:] if name.startswith(\"module://\")\n-            else f\"matplotlib.backends.backend_{name.lower()}\")\n-\n-\n def _setup_new_guiapp():\n     \"\"\"\n     Perform OS-dependent setup when Matplotlib creates a new GUI application.\ndiff --git a/lib/matplotlib/cbook.pyi b/lib/matplotlib/cbook.pyi\nindex 3216c4c92b9e..d727b8065b7a 100644\n--- a/lib/matplotlib/cbook.pyi\n+++ b/lib/matplotlib/cbook.pyi\n@@ -176,7 +176,6 @@ class _OrderedSet(collections.abc.MutableSet):\n     def add(self, key) -> None: ...\n     def discard(self, key) -> None: ...\n \n-def _backend_module_name(name: str) -> str: ...\n def _setup_new_guiapp() -> None: ...\n def _format_approx(number: float, precision: int) -> str: ...\n def _g_sig_digits(value: float, delta: float) -> int: ...\ndiff --git a/lib/matplotlib/pyplot.py b/lib/matplotlib/pyplot.py\nindex 2376c6243929..b1354341617d 100644\n--- a/lib/matplotlib/pyplot.py\n+++ b/lib/matplotlib/pyplot.py\n@@ -295,11 +295,16 @@ def install_repl_displayhook() -> None:\n     ip.events.register(\"post_execute\", _draw_all_if_interactive)\n     _REPL_DISPLAYHOOK = _ReplDisplayHook.IPYTHON\n \n-    from IPython.core.pylabtools import backend2gui\n-    # trigger IPython's eventloop integration, if available\n-    ipython_gui_name = backend2gui.get(get_backend())\n-    if ipython_gui_name:\n-        ip.enable_gui(ipython_gui_name)\n+    if mod_ipython.version_info[:2] < (8, 24):\n+        # Use of backend2gui is not needed for IPython >= 8.24 as that functionality\n+        # has been moved to Matplotlib.\n+        # This code can be removed when Python 3.12, the latest version supported by\n+        # IPython < 8.24, reaches end-of-life in late 2028.\n+        from IPython.core.pylabtools import backend2gui\n+        # trigger IPython's eventloop integration, if available\n+        ipython_gui_name = backend2gui.get(get_backend())\n+        if ipython_gui_name:\n+            ip.enable_gui(ipython_gui_name)\n \n \n def uninstall_repl_displayhook() -> None:\n@@ -402,7 +407,7 @@ def switch_backend(newbackend: str) -> None:\n     # have to escape the switch on access logic\n     old_backend = dict.__getitem__(rcParams, 'backend')\n \n-    module = importlib.import_module(cbook._backend_module_name(newbackend))\n+    module = backend_registry.load_backend_module(newbackend)\n     canvas_class = module.FigureCanvas\n \n     required_framework = canvas_class.required_interactive_framework\n@@ -477,6 +482,18 @@ def draw_if_interactive() -> None:\n     _log.debug(\"Loaded backend %s version %s.\",\n                newbackend, backend_mod.backend_version)\n \n+    if newbackend in (\"ipympl\", \"widget\"):\n+        # ipympl < 0.9.4 expects rcParams[\"backend\"] to be the fully-qualified backend\n+        # name \"module://ipympl.backend_nbagg\" not short names \"ipympl\" or \"widget\".\n+        import importlib.metadata as im\n+        from matplotlib import _parse_to_version_info  # type: ignore[attr-defined]\n+        try:\n+            module_version = im.version(\"ipympl\")\n+            if _parse_to_version_info(module_version) < (0, 9, 4):\n+                newbackend = \"module://ipympl.backend_nbagg\"\n+        except im.PackageNotFoundError:\n+            pass\n+\n     rcParams['backend'] = rcParamsDefault['backend'] = newbackend\n     _backend_mod = backend_mod\n     for func_name in [\"new_figure_manager\", \"draw_if_interactive\", \"show\"]:\n@@ -2586,7 +2603,7 @@ def polar(*args, **kwargs) -> list[Line2D]:\n if (rcParams[\"backend_fallback\"]\n         and rcParams._get_backend_or_none() in (  # type: ignore[attr-defined]\n             set(backend_registry.list_builtin(BackendFilter.INTERACTIVE)) -\n-            {'WebAgg', 'nbAgg'})\n+            {'webagg', 'nbagg'})\n         and cbook._get_running_interactive_framework()):\n     rcParams._set(\"backend\", rcsetup._auto_backend_sentinel)\n \ndiff --git a/lib/matplotlib/rcsetup.py b/lib/matplotlib/rcsetup.py\nindex a326d22f039a..b0cd22098489 100644\n--- a/lib/matplotlib/rcsetup.py\n+++ b/lib/matplotlib/rcsetup.py\n@@ -266,16 +266,16 @@ def validate_fonttype(s):\n         return fonttype\n \n \n-_validate_standard_backends = ValidateInStrings(\n-    'backend', backend_registry.list_builtin(), ignorecase=True)\n _auto_backend_sentinel = object()\n \n \n def validate_backend(s):\n-    backend = (\n-        s if s is _auto_backend_sentinel or s.startswith(\"module://\")\n-        else _validate_standard_backends(s))\n-    return backend\n+    if s is _auto_backend_sentinel or backend_registry.is_valid_backend(s):\n+        return s\n+    else:\n+        msg = (f\"'{s}' is not a valid value for backend; supported values are \"\n+               f\"{backend_registry.list_all()}\")\n+        raise ValueError(msg)\n \n \n def _validate_toolbar(s):\n", "test_patch": "diff --git a/.github/workflows/tests.yml b/.github/workflows/tests.yml\nindex fcd00e9c41e2..e6608cff6bc4 100644\n--- a/.github/workflows/tests.yml\n+++ b/.github/workflows/tests.yml\n@@ -59,7 +59,8 @@ jobs:\n             delete-font-cache: true\n           - os: ubuntu-20.04\n             python-version: 3.9\n-            extra-requirements: '-r requirements/testing/extra.txt'\n+            # One CI run tests ipython/matplotlib-inline before backend mapping moved to mpl\n+            extra-requirements: '-r requirements/testing/extra.txt \"ipython<8.24\" \"matplotlib-inline<0.1.7\"'\n             CFLAGS: \"-fno-lto\"  # Ensure that disabling LTO works.\n             # https://github.com/matplotlib/matplotlib/pull/26052#issuecomment-1574595954\n             # https://www.riverbankcomputing.com/pipermail/pyqt/2023-November/045606.html\ndiff --git a/lib/matplotlib/testing/__init__.py b/lib/matplotlib/testing/__init__.py\nindex 685b98cd99ec..779149dec2dc 100644\n--- a/lib/matplotlib/testing/__init__.py\n+++ b/lib/matplotlib/testing/__init__.py\n@@ -177,3 +177,41 @@ def _has_tex_package(package):\n         return True\n     except FileNotFoundError:\n         return False\n+\n+\n+def ipython_in_subprocess(\n+    requested_backend_or_gui_framework,\n+    expected_backend_old_ipython,  # IPython < 8.24\n+    expected_backend_new_ipython,  # IPython >= 8.24\n+):\n+    import pytest\n+    IPython = pytest.importorskip(\"IPython\")\n+\n+    if sys.platform == \"win32\":\n+        pytest.skip(\"Cannot change backend running IPython in subprocess on Windows\")\n+\n+    if (IPython.version_info[:3] == (8, 24, 0) and\n+            requested_backend_or_gui_framework == \"osx\"):\n+        pytest.skip(\"Bug using macosx backend in IPython 8.24.0 fixed in 8.24.1\")\n+\n+    if IPython.version_info[:2] >= (8, 24):\n+        expected_backend = expected_backend_new_ipython\n+    else:\n+        # This code can be removed when Python 3.12, the latest version supported by\n+        # IPython < 8.24, reaches end-of-life in late 2028.\n+        expected_backend = expected_backend_old_ipython\n+\n+    code = (\"import matplotlib as mpl, matplotlib.pyplot as plt;\"\n+            \"fig, ax=plt.subplots(); ax.plot([1, 3, 2]); mpl.get_backend()\")\n+    proc = subprocess_run_for_testing(\n+        [\n+            \"ipython\",\n+            \"--no-simple-prompt\",\n+            f\"--matplotlib={requested_backend_or_gui_framework}\",\n+            \"-c\", code,\n+        ],\n+        check=True,\n+        capture_output=True,\n+    )\n+\n+    assert proc.stdout.strip() == f\"Out[1]: '{expected_backend}'\"\ndiff --git a/lib/matplotlib/testing/__init__.pyi b/lib/matplotlib/testing/__init__.pyi\nindex 30cfd9a9ed2e..b0399476b6aa 100644\n--- a/lib/matplotlib/testing/__init__.pyi\n+++ b/lib/matplotlib/testing/__init__.pyi\n@@ -47,3 +47,8 @@ def subprocess_run_helper(\n ) -> subprocess.CompletedProcess[str]: ...\n def _check_for_pgf(texsystem: str) -> bool: ...\n def _has_tex_package(package: str) -> bool: ...\n+def ipython_in_subprocess(\n+    requested_backend_or_gui_framework: str,\n+    expected_backend_old_ipython: str,\n+    expected_backend_new_ipython: str,\n+) -> None: ...\ndiff --git a/lib/matplotlib/tests/test_backend_inline.py b/lib/matplotlib/tests/test_backend_inline.py\nnew file mode 100644\nindex 000000000000..6f0d67d51756\n--- /dev/null\n+++ b/lib/matplotlib/tests/test_backend_inline.py\n@@ -0,0 +1,46 @@\n+import os\n+from pathlib import Path\n+from tempfile import TemporaryDirectory\n+\n+import pytest\n+\n+from matplotlib.testing import subprocess_run_for_testing\n+\n+nbformat = pytest.importorskip('nbformat')\n+pytest.importorskip('nbconvert')\n+pytest.importorskip('ipykernel')\n+pytest.importorskip('matplotlib_inline')\n+\n+\n+def test_ipynb():\n+    nb_path = Path(__file__).parent / 'test_inline_01.ipynb'\n+\n+    with TemporaryDirectory() as tmpdir:\n+        out_path = Path(tmpdir, \"out.ipynb\")\n+\n+        subprocess_run_for_testing(\n+            [\"jupyter\", \"nbconvert\", \"--to\", \"notebook\",\n+             \"--execute\", \"--ExecutePreprocessor.timeout=500\",\n+             \"--output\", str(out_path), str(nb_path)],\n+            env={**os.environ, \"IPYTHONDIR\": tmpdir},\n+            check=True)\n+        with out_path.open() as out:\n+            nb = nbformat.read(out, nbformat.current_nbformat)\n+\n+    errors = [output for cell in nb.cells for output in cell.get(\"outputs\", [])\n+              if output.output_type == \"error\"]\n+    assert not errors\n+\n+    import IPython\n+    if IPython.version_info[:2] >= (8, 24):\n+        expected_backend = \"inline\"\n+    else:\n+        # This code can be removed when Python 3.12, the latest version supported by\n+        # IPython < 8.24, reaches end-of-life in late 2028.\n+        expected_backend = \"module://matplotlib_inline.backend_inline\"\n+    backend_outputs = nb.cells[2][\"outputs\"]\n+    assert backend_outputs[0][\"data\"][\"text/plain\"] == f\"'{expected_backend}'\"\n+\n+    image = nb.cells[1][\"outputs\"][1][\"data\"]\n+    assert image[\"text/plain\"] == \"<Figure size 300x200 with 1 Axes>\"\n+    assert \"image/png\" in image\ndiff --git a/lib/matplotlib/tests/test_backend_macosx.py b/lib/matplotlib/tests/test_backend_macosx.py\nindex c460da374c8c..a4350fe3b6c6 100644\n--- a/lib/matplotlib/tests/test_backend_macosx.py\n+++ b/lib/matplotlib/tests/test_backend_macosx.py\n@@ -44,3 +44,8 @@ def new_choose_save_file(title, directory, filename):\n         # Check the savefig.directory rcParam got updated because\n         # we added a subdirectory \"test\"\n         assert mpl.rcParams[\"savefig.directory\"] == f\"{tmp_path}/test\"\n+\n+\n+def test_ipython():\n+    from matplotlib.testing import ipython_in_subprocess\n+    ipython_in_subprocess(\"osx\", \"MacOSX\", \"macosx\")\ndiff --git a/lib/matplotlib/tests/test_backend_nbagg.py b/lib/matplotlib/tests/test_backend_nbagg.py\nindex 40bee8f85c43..23af88d95086 100644\n--- a/lib/matplotlib/tests/test_backend_nbagg.py\n+++ b/lib/matplotlib/tests/test_backend_nbagg.py\n@@ -30,3 +30,13 @@ def test_ipynb():\n     errors = [output for cell in nb.cells for output in cell.get(\"outputs\", [])\n               if output.output_type == \"error\"]\n     assert not errors\n+\n+    import IPython\n+    if IPython.version_info[:2] >= (8, 24):\n+        expected_backend = \"notebook\"\n+    else:\n+        # This code can be removed when Python 3.12, the latest version supported by\n+        # IPython < 8.24, reaches end-of-life in late 2028.\n+        expected_backend = \"nbAgg\"\n+    backend_outputs = nb.cells[2][\"outputs\"]\n+    assert backend_outputs[0][\"data\"][\"text/plain\"] == f\"'{expected_backend}'\"\ndiff --git a/lib/matplotlib/tests/test_backend_qt.py b/lib/matplotlib/tests/test_backend_qt.py\nindex f4a7ef6755f2..026a49b1441e 100644\n--- a/lib/matplotlib/tests/test_backend_qt.py\n+++ b/lib/matplotlib/tests/test_backend_qt.py\n@@ -14,7 +14,6 @@\n from matplotlib._pylab_helpers import Gcf\n from matplotlib import _c_internal_utils\n \n-\n try:\n     from matplotlib.backends.qt_compat import QtGui, QtWidgets  # type: ignore # noqa\n     from matplotlib.backends.qt_editor import _formlayout\n@@ -375,3 +374,8 @@ def custom_handler(signum, frame):\n     finally:\n         # Reset SIGINT handler to what it was before the test\n         signal.signal(signal.SIGINT, original_handler)\n+\n+\n+def test_ipython():\n+    from matplotlib.testing import ipython_in_subprocess\n+    ipython_in_subprocess(\"qt\", \"QtAgg\", \"qtagg\")\ndiff --git a/lib/matplotlib/tests/test_backend_registry.py b/lib/matplotlib/tests/test_backend_registry.py\nindex aed258f36413..eaf8417e7a5f 100644\n--- a/lib/matplotlib/tests/test_backend_registry.py\n+++ b/lib/matplotlib/tests/test_backend_registry.py\n@@ -7,6 +7,15 @@\n from matplotlib.backends import BackendFilter, backend_registry\n \n \n+@pytest.fixture\n+def clear_backend_registry():\n+    # Fixture that clears the singleton backend_registry before and after use\n+    # so that the test state remains isolated.\n+    backend_registry._clear()\n+    yield\n+    backend_registry._clear()\n+\n+\n def has_duplicates(seq: Sequence[Any]) -> bool:\n     return len(seq) > len(set(seq))\n \n@@ -33,9 +42,10 @@ def test_list_builtin():\n     assert not has_duplicates(backends)\n     # Compare using sets as order is not important\n     assert {*backends} == {\n-        'GTK3Agg', 'GTK3Cairo', 'GTK4Agg', 'GTK4Cairo', 'MacOSX', 'nbAgg', 'QtAgg',\n-        'QtCairo', 'Qt5Agg', 'Qt5Cairo', 'TkAgg', 'TkCairo', 'WebAgg', 'WX', 'WXAgg',\n-        'WXCairo', 'agg', 'cairo', 'pdf', 'pgf', 'ps', 'svg', 'template',\n+        'gtk3agg', 'gtk3cairo', 'gtk4agg', 'gtk4cairo', 'macosx', 'nbagg', 'notebook',\n+        'qtagg', 'qtcairo', 'qt5agg', 'qt5cairo', 'tkagg',\n+        'tkcairo', 'webagg', 'wx', 'wxagg', 'wxcairo', 'agg', 'cairo', 'pdf', 'pgf',\n+        'ps', 'svg', 'template',\n     }\n \n \n@@ -43,9 +53,9 @@ def test_list_builtin():\n     'filter,expected',\n     [\n         (BackendFilter.INTERACTIVE,\n-         ['GTK3Agg', 'GTK3Cairo', 'GTK4Agg', 'GTK4Cairo', 'MacOSX', 'nbAgg', 'QtAgg',\n-          'QtCairo', 'Qt5Agg', 'Qt5Cairo', 'TkAgg', 'TkCairo', 'WebAgg', 'WX', 'WXAgg',\n-           'WXCairo']),\n+         ['gtk3agg', 'gtk3cairo', 'gtk4agg', 'gtk4cairo', 'macosx', 'nbagg', 'notebook',\n+          'qtagg', 'qtcairo', 'qt5agg', 'qt5cairo', 'tkagg',\n+          'tkcairo', 'webagg', 'wx', 'wxagg', 'wxcairo']),\n         (BackendFilter.NON_INTERACTIVE,\n          ['agg', 'cairo', 'pdf', 'pgf', 'ps', 'svg', 'template']),\n     ]\n@@ -57,6 +67,25 @@ def test_list_builtin_with_filter(filter, expected):\n     assert {*backends} == {*expected}\n \n \n+def test_list_gui_frameworks():\n+    frameworks = backend_registry.list_gui_frameworks()\n+    assert not has_duplicates(frameworks)\n+    # Compare using sets as order is not important\n+    assert {*frameworks} == {\n+        \"gtk3\", \"gtk4\", \"macosx\", \"qt\", \"qt5\", \"qt6\", \"tk\", \"wx\",\n+    }\n+\n+\n+@pytest.mark.parametrize(\"backend, is_valid\", [\n+    (\"agg\", True),\n+    (\"QtAgg\", True),\n+    (\"module://anything\", True),\n+    (\"made-up-name\", False),\n+])\n+def test_is_valid_backend(backend, is_valid):\n+    assert backend_registry.is_valid_backend(backend) == is_valid\n+\n+\n def test_deprecated_rcsetup_attributes():\n     match = \"was deprecated in Matplotlib 3.9\"\n     with pytest.warns(mpl.MatplotlibDeprecationWarning, match=match):\n@@ -65,3 +94,67 @@ def test_deprecated_rcsetup_attributes():\n         mpl.rcsetup.non_interactive_bk\n     with pytest.warns(mpl.MatplotlibDeprecationWarning, match=match):\n         mpl.rcsetup.all_backends\n+\n+\n+def test_entry_points_inline():\n+    pytest.importorskip('matplotlib_inline')\n+    backends = backend_registry.list_all()\n+    assert 'inline' in backends\n+\n+\n+def test_entry_points_ipympl():\n+    pytest.importorskip('ipympl')\n+    backends = backend_registry.list_all()\n+    assert 'ipympl' in backends\n+    assert 'widget' in backends\n+\n+\n+def test_entry_point_name_shadows_builtin(clear_backend_registry):\n+    with pytest.raises(RuntimeError):\n+        backend_registry._validate_and_store_entry_points(\n+            [('qtagg', 'module1')])\n+\n+\n+def test_entry_point_name_duplicate(clear_backend_registry):\n+    with pytest.raises(RuntimeError):\n+        backend_registry._validate_and_store_entry_points(\n+            [('some_name', 'module1'), ('some_name', 'module2')])\n+\n+\n+def test_entry_point_name_is_module(clear_backend_registry):\n+    with pytest.raises(RuntimeError):\n+        backend_registry._validate_and_store_entry_points(\n+            [('module://backend.something', 'module1')])\n+\n+\n+@pytest.mark.parametrize('backend', [\n+    'agg',\n+    'module://matplotlib.backends.backend_agg',\n+])\n+def test_load_entry_points_only_if_needed(clear_backend_registry, backend):\n+    assert not backend_registry._loaded_entry_points\n+    check = backend_registry.resolve_backend(backend)\n+    assert check == (backend, None)\n+    assert not backend_registry._loaded_entry_points\n+    backend_registry.list_all()  # Force load of entry points\n+    assert backend_registry._loaded_entry_points\n+\n+\n+@pytest.mark.parametrize(\n+    'gui_or_backend, expected_backend, expected_gui',\n+    [\n+        ('agg', 'agg', None),\n+        ('qt', 'qtagg', 'qt'),\n+        ('TkCairo', 'tkcairo', 'tk'),\n+    ]\n+)\n+def test_resolve_gui_or_backend(gui_or_backend, expected_backend, expected_gui):\n+    backend, gui = backend_registry.resolve_gui_or_backend(gui_or_backend)\n+    assert backend == expected_backend\n+    assert gui == expected_gui\n+\n+\n+def test_resolve_gui_or_backend_invalid():\n+    match = \"is not a recognised GUI loop or backend name\"\n+    with pytest.raises(RuntimeError, match=match):\n+        backend_registry.resolve_gui_or_backend('no-such-name')\ndiff --git a/lib/matplotlib/tests/test_backends_interactive.py b/lib/matplotlib/tests/test_backends_interactive.py\nindex e021405c56b7..6830e7d5c845 100644\n--- a/lib/matplotlib/tests/test_backends_interactive.py\n+++ b/lib/matplotlib/tests/test_backends_interactive.py\n@@ -291,7 +291,7 @@ def _test_thread_impl():\n     plt.pause(0.5)  # flush_events fails here on at least Tkagg (bpo-41176)\n     future.result()  # Joins the thread; rethrows any exception.\n     plt.close()  # backend is responsible for flushing any events here\n-    if plt.rcParams[\"backend\"].startswith(\"WX\"):\n+    if plt.rcParams[\"backend\"].lower().startswith(\"wx\"):\n         # TODO: debug why WX needs this only on py >= 3.8\n         fig.canvas.flush_events()\n \ndiff --git a/lib/matplotlib/tests/test_inline_01.ipynb b/lib/matplotlib/tests/test_inline_01.ipynb\nnew file mode 100644\nindex 000000000000..b87ae095bdbe\n--- /dev/null\n+++ b/lib/matplotlib/tests/test_inline_01.ipynb\n@@ -0,0 +1,79 @@\n+{\n+ \"cells\": [\n+  {\n+   \"cell_type\": \"code\",\n+   \"execution_count\": null,\n+   \"metadata\": {},\n+   \"outputs\": [],\n+   \"source\": [\n+    \"%matplotlib inline\\n\",\n+    \"import matplotlib.pyplot as plt\"\n+   ]\n+  },\n+  {\n+   \"cell_type\": \"code\",\n+   \"execution_count\": null,\n+   \"metadata\": {\n+    \"jupyter\": {\n+     \"outputs_hidden\": false\n+    }\n+   },\n+   \"outputs\": [],\n+   \"source\": [\n+    \"fig, ax = plt.subplots(figsize=(3, 2))\\n\",\n+    \"ax.plot([1, 3, 2])\"\n+   ]\n+  },\n+  {\n+   \"cell_type\": \"code\",\n+   \"execution_count\": null,\n+   \"metadata\": {},\n+   \"outputs\": [],\n+   \"source\": [\n+    \"import matplotlib\\n\",\n+    \"matplotlib.get_backend()\"\n+   ]\n+  }\n+ ],\n+ \"metadata\": {\n+  \"kernelspec\": {\n+   \"display_name\": \"Python 3 (ipykernel)\",\n+   \"language\": \"python\",\n+   \"name\": \"python3\"\n+  },\n+  \"language_info\": {\n+   \"codemirror_mode\": {\n+    \"name\": \"ipython\",\n+    \"version\": 3\n+   },\n+   \"file_extension\": \".py\",\n+   \"mimetype\": \"text/x-python\",\n+   \"name\": \"python\",\n+   \"nbconvert_exporter\": \"python\",\n+   \"pygments_lexer\": \"ipython3\",\n+   \"version\": \"3.12.2\"\n+  },\n+  \"toc\": {\n+   \"colors\": {\n+    \"hover_highlight\": \"#DAA520\",\n+    \"running_highlight\": \"#FF0000\",\n+    \"selected_highlight\": \"#FFD700\"\n+   },\n+   \"moveMenuLeft\": true,\n+   \"nav_menu\": {\n+    \"height\": \"12px\",\n+    \"width\": \"252px\"\n+   },\n+   \"navigate_menu\": true,\n+   \"number_sections\": true,\n+   \"sideBar\": true,\n+   \"threshold\": 4,\n+   \"toc_cell\": false,\n+   \"toc_section_display\": \"block\",\n+   \"toc_window_display\": false,\n+   \"widenNotebook\": false\n+  }\n+ },\n+ \"nbformat\": 4,\n+ \"nbformat_minor\": 4\n+}\ndiff --git a/lib/matplotlib/tests/test_matplotlib.py b/lib/matplotlib/tests/test_matplotlib.py\nindex a2f467ac48de..37b41fafdb78 100644\n--- a/lib/matplotlib/tests/test_matplotlib.py\n+++ b/lib/matplotlib/tests/test_matplotlib.py\n@@ -54,7 +54,7 @@ def parse(key):\n         for line in matplotlib.use.__doc__.split(key)[1].split('\\n'):\n             if not line.strip():\n                 break\n-            backends += [e.strip() for e in line.split(',') if e]\n+            backends += [e.strip().lower() for e in line.split(',') if e]\n         return backends\n \n     from matplotlib.backends import BackendFilter, backend_registry\ndiff --git a/lib/matplotlib/tests/test_nbagg_01.ipynb b/lib/matplotlib/tests/test_nbagg_01.ipynb\nindex 8505e057fdc3..bd18aa4192b7 100644\n--- a/lib/matplotlib/tests/test_nbagg_01.ipynb\n+++ b/lib/matplotlib/tests/test_nbagg_01.ipynb\n@@ -8,9 +8,8 @@\n    },\n    \"outputs\": [],\n    \"source\": [\n-    \"import numpy as np\\n\",\n-    \"import matplotlib.pyplot as plt\\n\",\n-    \"%matplotlib notebook\\n\"\n+    \"%matplotlib notebook\\n\",\n+    \"import matplotlib.pyplot as plt\"\n    ]\n   },\n   {\n@@ -826,17 +825,31 @@\n    ],\n    \"source\": [\n     \"fig, ax = plt.subplots()\\n\",\n-    \"ax.plot(range(10))\\n\"\n+    \"ax.plot(range(10))\"\n    ]\n   },\n   {\n    \"cell_type\": \"code\",\n-   \"execution_count\": null,\n+   \"execution_count\": 3,\n    \"metadata\": {\n     \"collapsed\": true\n    },\n-   \"outputs\": [],\n-   \"source\": []\n+   \"outputs\": [\n+    {\n+     \"data\": {\n+      \"text/plain\": [\n+       \"'notebook'\"\n+      ]\n+     },\n+     \"execution_count\": 3,\n+     \"metadata\": {},\n+     \"output_type\": \"execute_result\"\n+    }\n+   ],\n+   \"source\": [\n+    \"import matplotlib\\n\",\n+    \"matplotlib.get_backend()\"\n+   ]\n   }\n  ],\n  \"metadata\": {\n", "problem_statement": "[MNT]: Move Matplotlib backend mapping from IPython and support backends self-registering\n### Summary\n\nI propose to move the Matplotlib backend mapping that is currently in IPython into Matplotlib, and extend it to support backends registering themselves via `entry_points`. This was originally discussed in #19482 and Tom summarised and proposed a solution in https://github.com/matplotlib/matplotlib/pull/19482#issuecomment-1042511334.\n\n### Proposed fix\n\n# Background\r\n\r\nIPython supports the use of the `%matplotlib` magic in two ways:\r\n- `%matplotlib <backend_name>` to use the named Matplotlib backend.\r\n- `%matplotlib --list` to list available backends.\r\n\r\nIPython contains hard-coded information about which backends exist, and which GUI interactive framework they support. The current information consists of backends that are built-into mpl itself (e.g. qt, notebook, webagg) and those in external libraries (ipympl and inline) which are Jupyter-based.\r\n\r\n# Problems\r\n\r\n- This is unnecessarily difficult to maintain as new backends require changes in IPython.\r\n- There is no support in IPython for backends specified using `\"module://whatever.backend.module\"`\r\n\r\n# Proposal\r\n\r\n1. Keep the same `%matplotlib` magic functionality in IPython but defer responsibility for the backend naming and interactive framework identification to Matplotlib, with a version check of Matplotlib to fallback to the existing behaviour if necessary.\r\n2. Add a backend registry to Matplotlib. Whether this is literally a `BackendRegistry` singleton or not is an implementation detail.\r\n3. The registry will allow use of backends for both IPython and `matplotlib.use` in three different categories:\r\n    a. Backends that are built into the Matplotlib code base.\r\n    b. Backends that can be dynamically loaded using `\"module://backend.name\"` such as MplCairo.\r\n    c. Backends that register themselves using an `entry_point`. Initially this will be `ipympl` and `matplotlib-inline`.\r\n4. Need to handle error situations of multiple backends registering under the same name, or registering with the same name as a built-in backend.\r\n5. Matplotlib needs a new `list_backends` function for IPython\u2019s `%matplotlib --list`. This will include all backends in items 3a and 3c above, as well as any `\u201cmodule://\u2026\u201d` backends (3b) that have already been loaded. The latter is so that if you use `%matplotlib module://\u2026` in IPython a subsequent `%matplotlib \u2013list` will include the backend you are using.\r\n6. The `list_backends` function may as well be public within Matplotlib as it is a feature that is requested every so often. It will have to be clearly stated that this contains \u201cbackends that mpl is aware of\u201d rather than an exhaustive list.\r\n\r\nThis isn\u2019t the full set of functionality listed at https://github.com/matplotlib/matplotlib/pull/19482#issuecomment-1042511334 as it does not include use of `\"m://\u2026\"` form for example.\r\n\r\nChanges will be required in the following projects:\r\n1. Matplotlib = new registry, looking up entry points, docs.\r\n2. Matplotlib-inline = add entry point.\r\n3. Ipympl = add entry point.\r\n4. IPython = call Matplotlib backend registry for backend info, docs.\r\n\r\nChanges 1-3 will need to be published in releases before 4 can be merged and released.\r\n\n", "hints_text": "Can we put this on the agenda for the meeting tomorrow?\nYes, I can attend the meeting.\nattn @anntzer \nI'll try to attend tomorrow as well.\nFollowing discussion at the weekly meeting (https://hackmd.io/l9vkn_T4RSmk147H_ZPPBA#ipython--Matplotlib-integration) I am going ahead with an implementation of this and we will see what problems come up.", "created_at": "2024-03-19T11:43:22Z"}
{"repo": "matplotlib/matplotlib", "pull_number": 27943, "instance_id": "matplotlib__matplotlib-27943", "issue_numbers": ["27828", "0000"], "base_commit": "5300bd67702e4fb8196cdf032bfcb47aa57e6ec1", "patch": "diff --git a/doc/api/next_api_changes/behavior/27943-AL.rst b/doc/api/next_api_changes/behavior/27943-AL.rst\nnew file mode 100644\nindex 000000000000..1314b763987e\n--- /dev/null\n+++ b/doc/api/next_api_changes/behavior/27943-AL.rst\n@@ -0,0 +1,10 @@\n+plot() shorthand format interprets \"Cn\" (n>9) as a color-cycle color\n+~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n+Previously, ``plot(..., \"-C11\")`` would be interpreted as requesting a plot\n+using linestyle \"-\", color \"C1\" (color #1 of the color cycle), and marker \"1\"\n+(\"tri-down\").  It is now interpreted as requesting linestyle \"-\" and color\n+\"C11\" (color #11 of the color cycle).\n+\n+It is recommended to pass ambiguous markers (such as \"1\") explicitly using the\n+*marker* keyword argument.  If the shorthand form is desired, such markers can\n+also be unambiguously set by putting them *before* the color string.\ndiff --git a/lib/matplotlib/axes/_base.py b/lib/matplotlib/axes/_base.py\nindex be0aacd81bb0..36e146f31af1 100644\n--- a/lib/matplotlib/axes/_base.py\n+++ b/lib/matplotlib/axes/_base.py\n@@ -5,6 +5,7 @@\n import logging\n from numbers import Real\n from operator import attrgetter\n+import re\n import types\n \n import numpy as np\n@@ -189,13 +190,14 @@ def _process_plot_format(fmt, *, ambiguous_fmt_datakey=False):\n                 raise ValueError(errfmt.format(fmt, \"two color symbols\"))\n             color = c\n             i += 1\n-        elif c == 'C' and i < len(fmt) - 1:\n-            color_cycle_number = int(fmt[i + 1])\n-            color = mcolors.to_rgba(f\"C{color_cycle_number}\")\n-            i += 2\n+        elif c == \"C\":\n+            cn_color = re.match(r\"C\\d+\", fmt[i:])\n+            if not cn_color:\n+                raise ValueError(errfmt.format(fmt, \"'C' must be followed by a number\"))\n+            color = mcolors.to_rgba(cn_color[0])\n+            i += len(cn_color[0])\n         else:\n-            raise ValueError(\n-                errfmt.format(fmt, f\"unrecognized character {c!r}\"))\n+            raise ValueError(errfmt.format(fmt, f\"unrecognized character {c!r}\"))\n \n     if linestyle is None and marker is None:\n         linestyle = mpl.rcParams['lines.linestyle']\n", "test_patch": "diff --git a/lib/matplotlib/tests/test_axes.py b/lib/matplotlib/tests/test_axes.py\nindex 4e659a4d841d..5af508479592 100644\n--- a/lib/matplotlib/tests/test_axes.py\n+++ b/lib/matplotlib/tests/test_axes.py\n@@ -8511,6 +8511,8 @@ def test_empty_line_plots():\n     (\":-\", r\"':-' is not a valid format string \\(two linestyle symbols\\)\"),\n     (\"rk\", r\"'rk' is not a valid format string \\(two color symbols\\)\"),\n     (\":o-r\", r\"':o-r' is not a valid format string \\(two linestyle symbols\\)\"),\n+    (\"C\", r\"'C' is not a valid format string \\('C' must be followed by a number\\)\"),\n+    (\".C\", r\"'.C' is not a valid format string \\('C' must be followed by a number\\)\"),\n ))\n @pytest.mark.parametrize(\"data\", [None, {\"string\": range(3)}])\n def test_plot_format_errors(fmt, match, data):\n@@ -8543,6 +8545,11 @@ def test_plot_format():\n     line = ax.plot([1, 2, 3], 'k3')\n     assert line[0].get_marker() == '3'\n     assert line[0].get_color() == 'k'\n+    fig, ax = plt.subplots()\n+    line = ax.plot([1, 2, 3], '.C12:')\n+    assert line[0].get_marker() == '.'\n+    assert line[0].get_color() == mcolors.to_rgba('C12')\n+    assert line[0].get_linestyle() == ':'\n \n \n def test_automatic_legend():\n", "problem_statement": "[Bug]: \".C10\" does not work as plot shorthand format spec\n### Bug summary\r\n\r\nThe plot shorthand format spec does not work when combining a Cn color with n>=10 with a linestyle or a markerstyle, e.g. \".C10\".  Somewhat inconsistently, it does work when a Cn color is given by itself.\r\n\r\n### Code for reproduction\r\n\r\n```Python\r\nfrom pylab import *; plot([0, 1], \".C10\") \r\n# plot([0, 1], \"C10\") works; note that this also goes through the shorthand route\r\n# unlike plot([0, 1], c=\"C10\")\r\n```\r\n\r\n\r\n### Actual outcome\r\n\r\nValueError: '.C10' is not a valid format string (unrecognized character '0')\r\n\r\n### Expected outcome\r\n\r\nNo error.\r\n\r\n### Additional information\r\n\r\n_No response_\r\n\r\n### Operating system\r\n\r\nmacos\r\n\r\n### Matplotlib Version\r\n\r\n3.9.0.dev1178+g88d64e5f0c\r\n\r\n### Matplotlib Backend\r\n\r\nany\r\n\r\n### Python version\r\n\r\n3.12\r\n\r\n### Jupyter version\r\n\r\nnone\r\n\r\n### Installation\r\n\r\ngit checkout\n", "hints_text": "The relevant code is:\r\n\r\nhttps://github.com/matplotlib/matplotlib/blob/5e347777192b37ac77decc4f975e53ed9d87973b/lib/matplotlib/axes/_base.py#L192-L195\r\n\r\nThis is the case from the long if-elif chain that is handling the Cn colors. It only looks one character ahead (and advances the current index by exactly 2 as a result.\r\n\r\n(If only color is provided, and multidigit `Cn` colors count for this, then that is handled prior to parsing the individual parts in this if/elif chain)", "created_at": "2024-03-18T14:08:18Z"}
{"repo": "matplotlib/matplotlib", "pull_number": 27850, "instance_id": "matplotlib__matplotlib-27850", "issue_numbers": ["8072", "0000"], "base_commit": "365c950ea98a55ef34e55c653fcb6a62665ac4e8", "patch": "diff --git a/doc/api/next_api_changes/deprecations/27850-REC.rst b/doc/api/next_api_changes/deprecations/27850-REC.rst\nnew file mode 100644\nindex 000000000000..2021c2737ecd\n--- /dev/null\n+++ b/doc/api/next_api_changes/deprecations/27850-REC.rst\n@@ -0,0 +1,10 @@\n+``plot_date``\n+~~~~~~~~~~~~~\n+\n+Use of `~.Axes.plot_date` has been discouraged since Matplotlib 3.5 and the\n+function is now formally deprecated.\n+\n+- ``datetime``-like data should directly be plotted using `~.Axes.plot`.\n+-  If you need to plot plain numeric data as :ref:`date-format` or need to set\n+   a timezone, call ``ax.xaxis.axis_date`` / ``ax.yaxis.axis_date`` before\n+   `~.Axes.plot`. See `.Axis.axis_date`.\ndiff --git a/lib/matplotlib/axes/_axes.py b/lib/matplotlib/axes/_axes.py\nindex 60921f69fc1b..3a1cc2fb9fb6 100644\n--- a/lib/matplotlib/axes/_axes.py\n+++ b/lib/matplotlib/axes/_axes.py\n@@ -1742,17 +1742,17 @@ def plot(self, *args, scalex=True, scaley=True, data=None, **kwargs):\n             self._request_autoscale_view(\"y\")\n         return lines\n \n+    @_api.deprecated(\"3.9\", alternative=\"plot\")\n     @_preprocess_data(replace_names=[\"x\", \"y\"], label_namer=\"y\")\n     @_docstring.dedent_interpd\n     def plot_date(self, x, y, fmt='o', tz=None, xdate=True, ydate=False,\n                   **kwargs):\n         \"\"\"\n-        [*Discouraged*] Plot coercing the axis to treat floats as dates.\n+        Plot coercing the axis to treat floats as dates.\n \n-        .. admonition:: Discouraged\n+        .. deprecated:: 3.9\n \n-            This method exists for historic reasons and will be deprecated in\n-            the future.\n+            This method exists for historic reasons and will be removed in version 3.11.\n \n             - ``datetime``-like data should directly be plotted using\n               `~.Axes.plot`.\n", "test_patch": "diff --git a/lib/matplotlib/tests/test_axes.py b/lib/matplotlib/tests/test_axes.py\nindex 8c43b04e0eb7..fbcafa76dcea 100644\n--- a/lib/matplotlib/tests/test_axes.py\n+++ b/lib/matplotlib/tests/test_axes.py\n@@ -870,7 +870,8 @@ def test_single_date():\n     data1 = [-65.54]\n \n     fig, ax = plt.subplots(2, 1)\n-    ax[0].plot_date(time1 + dt, data1, 'o', color='r')\n+    with pytest.warns(mpl.MatplotlibDeprecationWarning):\n+        ax[0].plot_date(time1 + dt, data1, 'o', color='r')\n     ax[1].plot(time1, data1, 'o', color='r')\n \n \n@@ -6897,11 +6898,13 @@ def test_date_timezone_x():\n     # Same Timezone\n     plt.figure(figsize=(20, 12))\n     plt.subplot(2, 1, 1)\n-    plt.plot_date(time_index, [3] * 3, tz='Canada/Eastern')\n+    with pytest.warns(mpl.MatplotlibDeprecationWarning):\n+        plt.plot_date(time_index, [3] * 3, tz='Canada/Eastern')\n \n     # Different Timezone\n     plt.subplot(2, 1, 2)\n-    plt.plot_date(time_index, [3] * 3, tz='UTC')\n+    with pytest.warns(mpl.MatplotlibDeprecationWarning):\n+        plt.plot_date(time_index, [3] * 3, tz='UTC')\n \n \n @image_comparison(['date_timezone_y.png'])\n@@ -6914,12 +6917,13 @@ def test_date_timezone_y():\n     # Same Timezone\n     plt.figure(figsize=(20, 12))\n     plt.subplot(2, 1, 1)\n-    plt.plot_date([3] * 3,\n-                  time_index, tz='Canada/Eastern', xdate=False, ydate=True)\n+    with pytest.warns(mpl.MatplotlibDeprecationWarning):\n+        plt.plot_date([3] * 3, time_index, tz='Canada/Eastern', xdate=False, ydate=True)\n \n     # Different Timezone\n     plt.subplot(2, 1, 2)\n-    plt.plot_date([3] * 3, time_index, tz='UTC', xdate=False, ydate=True)\n+    with pytest.warns(mpl.MatplotlibDeprecationWarning):\n+        plt.plot_date([3] * 3, time_index, tz='UTC', xdate=False, ydate=True)\n \n \n @image_comparison(['date_timezone_x_and_y.png'], tol=1.0)\n@@ -6932,11 +6936,13 @@ def test_date_timezone_x_and_y():\n     # Same Timezone\n     plt.figure(figsize=(20, 12))\n     plt.subplot(2, 1, 1)\n-    plt.plot_date(time_index, time_index, tz='UTC', ydate=True)\n+    with pytest.warns(mpl.MatplotlibDeprecationWarning):\n+        plt.plot_date(time_index, time_index, tz='UTC', ydate=True)\n \n     # Different Timezone\n     plt.subplot(2, 1, 2)\n-    plt.plot_date(time_index, time_index, tz='US/Eastern', ydate=True)\n+    with pytest.warns(mpl.MatplotlibDeprecationWarning):\n+        plt.plot_date(time_index, time_index, tz='US/Eastern', ydate=True)\n \n \n @image_comparison(['axisbelow.png'], remove_text=True)\ndiff --git a/lib/matplotlib/tests/test_datetime.py b/lib/matplotlib/tests/test_datetime.py\nindex 104a649e1464..4b693eb7d1ca 100644\n--- a/lib/matplotlib/tests/test_datetime.py\n+++ b/lib/matplotlib/tests/test_datetime.py\n@@ -657,9 +657,10 @@ def test_plot_date(self):\n         x_ranges = np.array(range(1, range_threshold))\n         y_ranges = np.array(range(1, range_threshold))\n \n-        ax1.plot_date(x_dates, y_dates)\n-        ax2.plot_date(x_dates, y_ranges)\n-        ax3.plot_date(x_ranges, y_dates)\n+        with pytest.warns(mpl.MatplotlibDeprecationWarning):\n+            ax1.plot_date(x_dates, y_dates)\n+            ax2.plot_date(x_dates, y_ranges)\n+            ax3.plot_date(x_ranges, y_dates)\n \n     @pytest.mark.xfail(reason=\"Test for quiver not written yet\")\n     @mpl.style.context(\"default\")\ndiff --git a/lib/mpl_toolkits/axes_grid1/tests/test_axes_grid1.py b/lib/mpl_toolkits/axes_grid1/tests/test_axes_grid1.py\nindex 328bb6e33fdf..b1a18d77747e 100644\n--- a/lib/mpl_toolkits/axes_grid1/tests/test_axes_grid1.py\n+++ b/lib/mpl_toolkits/axes_grid1/tests/test_axes_grid1.py\n@@ -93,7 +93,8 @@ def test_twin_axes_empty_and_removed():\n \n def test_twin_axes_both_with_units():\n     host = host_subplot(111)\n-    host.plot_date([0, 1, 2], [0, 1, 2], xdate=False, ydate=True)\n+    with pytest.warns(mpl.MatplotlibDeprecationWarning):\n+        host.plot_date([0, 1, 2], [0, 1, 2], xdate=False, ydate=True)\n     twin = host.twinx()\n     twin.plot([\"a\", \"b\", \"c\"])\n     assert host.get_yticklabels()[0].get_text() == \"00:00:00\"\n", "problem_statement": "plot_date() ignores timezone in matplotlib version 2.0.0\n### Bug report\r\n\r\n**Bug summary**\r\n\r\n- It is a reopen bug report, same to #5575. The bug still exists for version 2.0.0.\r\n\r\ncopy paste the code from #5575 \r\n\r\n```python\r\nimport pytz\r\nimport matplotlib.pyplot as plt\r\nfrom datetime import datetime\r\ntime_index = [pytz.timezone('Europe/Berlin').localize(datetime(year=2015, month=11, day=27, hour=x)) for x in range(4)]\r\nplt.plot_date(time_index, [4]*4, tz='Europe/Berlin')\r\nplt.plot_date(time_index, [3]*4, tz='UTC')\r\n```\r\n\r\n**Actual outcome**\r\n\r\n- The output gives no difference in xaxis, implying tz is not working.\n", "hints_text": "For reference, this works fine if the two plots are on different axes, which is all #6091 tests for. The problem happens if two plots with different timezones are done on the same axis.\nWhat timezone would you expect the axes to be in if you pass in data with different timezones (which may be considered 'different units')?\nIt seems natural enough to convert everything to the axis' tz?\nIs there any confirmation on whether this is going to be fixed in v3.0?\nI don't think there is a fix for this right now.  OTOH, I suspect its not too hard to do.  PR would be welcome...\nActually, I take that back.  The problem is that `axis.update_units` only checks that the converter is appropriate for the data, not the actual units of the data. So the fix is to fix the units machinery, but thats under review.  \nThanks for providing this information. Looking forward to the fix!\nI agree that the documentation shouldn't claim that this works.  Not sure how we indicate that a kwarg actually has no effect, but that we'd like it to someday...\r\n\r\nI wouldn't expect this in the forseable future, as it gets at the root of our units handling, which is currently not set up to change units on the fly.  Safest is to convert all your datetime objects to one timezone and then plot.\nThis issue has been marked \"inactive\" because it has been 365 days since the last comment. If this issue is still present in recent Matplotlib releases, or the feature request is still wanted, please leave a comment and this label will be removed. If there are no updates in another 30 days, this issue will be automatically closed, but you are free to re-open or create a new issue if needed. We value issue reports, and this procedure is meant to help us resurface and prioritize issues that have not been addressed yet, not make them disappear.  Thanks for your help!\nStill seems to be an issue on current main, so I'll keep this open.\nSince plot_date is discouraged anyway, it\u2019s unlikely that we\u2019ll change behavior.\r\n\r\nI suggest we close this by better documenting, that tz is only used for  [axis_date](https://matplotlib.org/stable/api/_as_gen/matplotlib.axis.Axis.axis_date.html#matplotlib.axis.Axis.axis_date), so affects the axis labeling, but does not directly imply the timezone of the data.\nI'm guessing this is still and issue with plain `plot()` though, and I don't see why taking the timezone into account when doing the unit conversion isn't a valid feature request (or even a bug fix)?\nOk, but then let\u2019s rephrase this into a new issue using `plot` only.\nWith v3.8.2 I have\r\n\r\n```python\r\nimport pytz\r\nimport matplotlib.pyplot as plt\r\nfrom datetime import datetime\r\n\r\ntime_index_berlin = [pytz.timezone('Europe/Berlin').localize(datetime(year=2015, month=11, day=27, hour=x)) for x in range(4)]\r\ntime_index_utc = [pytz.timezone('UTC').localize(datetime(year=2015, month=11, day=27, hour=x)) for x in range(4)]\r\n\r\n\r\nfig, ax = plt.subplots()\r\n\r\nax.plot(time_index_berlin, [4]*4, label='Berlin')\r\nax.plot(time_index_utc, [3]*4, label='UTC')\r\n\r\nax.legend()\r\nfig.autofmt_xdate()\r\n\r\nplt.show()\r\n```\r\n![image](https://github.com/matplotlib/matplotlib/assets/10599679/9e9145f0-6732-4ea9-8438-b3dc3f27374d)\r\n\r\nIf I reverse the order of plotting:\r\n\r\n```python\r\nax.plot(time_index_utc, [3]*4, label='UTC')\r\nax.plot(time_index_berlin, [4]*4, label='Berlin')\r\n```\r\n\r\n![image](https://github.com/matplotlib/matplotlib/assets/10599679/c463e0e5-8011-4bd8-8b47-971e95243c88)\r\n\r\nSo it seems we plot in whichever timezone came first.\n> it seems we plot in whichever timezone came first.\r\n\r\nWhich is reasonable. So, if I understand correctly, we don\u2019t have an issue with pure `plot()`.\nAh fair enough, sorry for not checking... if we're not fixing anything on `plot_date()` now happy for this to be closed as wont fix \ud83d\udc4d \nI'm confused - are we saying `plot_date` is broken, but `plot` works?  I wasn't aware `plot_date` did anything different that `plot`.  \nYet again, my bad for not actually checking... `plot_date` does seem to be working fine if given dates with different timezones. But this issue is about the `tz` argument to `plot_date` which AFAIK has no equivalent with `plot`?\r\n\r\n(as an aside, in the above plot https://github.com/matplotlib/matplotlib/issues/8072#issuecomment-1919262892 I'm a bit confused, isn't Berlin one hour ahead of UTC, which means the lines are the wrong way round (Berlin should be one hour to the right of UTC instead of one hour to the left)??)\nConfirmed, `plot` errors if you pass it the _tz_ parameter.\r\n\r\nYes, Berlin is an hour ahead of UTC (in winter).  So when it's midnight in Berlin, it's only 11pm UTC.  So I think the plot is correct (note both lines start at midnight).\nhttps://github.com/matplotlib/matplotlib/blob/41d4149f84b40d3a90a70f81b940985b8485f04a/lib/matplotlib/axes/_axes.py#L1820-L1824\r\n\r\nThis is the implementation of `plot_date` as it stands.\r\n\r\nThe consequences of this implementation are as follows:\r\n\r\n- Only the last `tz` passed is used and is used to interpret _all_ floating point inputs (regardless of what `tz` was passed with a particular floating point input)\r\n   - we do not add the tz to the source data, just set it as the active interpretation of floats\r\n- If no `tz` is provided, it will use the :rc:`timezone` (defaults to UTC)\r\n- `datetime` objects will still translate to the timezone as they hold their timezone info themselves\r\n- `datetime64` does _not_ store timezone info (though will parse it)... there is some handling of `datetime64` in `date2num`/`num2date` that looks like there either _was_ once some tz info or _is_ on some sub dtypes we support (pandas?, not sure, but `astimezone` is not a numpy thing)\r\n   - As such, I believe they are always interpreted as UTC, but might be :rc:`timezone`, didn't spend the time to differentiate that.\r\n- `float` inputs _will_ change (since changing the tz changes what the floating point number isformatted as/translates to as a date, and the tz is not attached to it.\r\n\r\nThe equivalent to passing the `tz` argument is to call `ax.xaxis_date(tz)` (or y axis, but by default x is the only one set).\r\n\r\nSo, in the example, both plots are using `datetime` objects which _are_ carrying timezone information as the `x` values... I do _not_ think we should be applying a new timezone to them in `plot_date` when they are given as timezoned values. I could see _an_ argument for attaching the tz to float inputs (e.g. by instead of doing `self.plot(x, y, **kwargs)` doing `self.plot(num2date(x, tz=tz), y, **kwargs)` (modulo x and y bool flag handling...) but even that I would think would only apply to _float_ inputs, not `datetime` inputs as is here... and even then am not sure it's actually expected behavior)\r\n\r\nGiven the admonition that very explicitly states \"Do not use this for `datetime` inputs, use `plot` instead\" (in current mpl, such text was not present when this issue was opened in fairness), my opinion is that this should be closed as \"expected behavior\". The admonition (which was added in #18346) also does give information about calling `axis_date` (though does reach in to the `axis` instead of using the `axes` method which exists... but just is a wrapper so doesn't really change anything)\nI do wonder if we should go a step further and hard deprecate this method.  Datetime with timezones are confusing enough without slightly different semantics.  \r\n\r\n\nFrom the discussion at #18346, it seems the intention at the time had been to pre-deprecate `plot_date` but the `PendingDeprecationWarning` was causing an issue with Sphinx :eyes: \nI'm fine with deprecating now. We've even already announced that we we will do this in the admonition at https://matplotlib.org/devdocs/api/_as_gen/matplotlib.axes.Axes.plot_date.html#matplotlib.axes.Axes.plot_date", "created_at": "2024-03-03T18:14:08Z"}
{"repo": "matplotlib/matplotlib", "pull_number": 27848, "instance_id": "matplotlib__matplotlib-27848", "issue_numbers": ["27301", "0000"], "base_commit": "efcca8deaf720b2652e2d3d8876ab5187808abb8", "patch": "diff --git a/lib/matplotlib/cm.py b/lib/matplotlib/cm.py\nindex 7e46cf567f70..e9a7aad6c456 100644\n--- a/lib/matplotlib/cm.py\n+++ b/lib/matplotlib/cm.py\n@@ -328,7 +328,7 @@ def to_rgba(self, x, alpha=None, bytes=False, norm=True):\n         treated as an RGB or RGBA array, and no mapping will be done.\n         The array can be `~numpy.uint8`, or it can be floats with\n         values in the 0-1 range; otherwise a ValueError will be raised.\n-        If it is a masked array, any masked elements will be set to 0 alpha.\n+        Any NaNs or masked elements will be set to 0 alpha.\n         If the last dimension is 3, the *alpha* kwarg (defaulting to 1)\n         will be used to fill in the transparency.  If the last dimension\n         is 4, the *alpha* kwarg is ignored; it does not\n@@ -360,6 +360,12 @@ def to_rgba(self, x, alpha=None, bytes=False, norm=True):\n                 else:\n                     raise ValueError(\"Third dimension must be 3 or 4\")\n                 if xx.dtype.kind == 'f':\n+                    # If any of R, G, B, or A is nan, set to 0\n+                    if np.any(nans := np.isnan(x)):\n+                        if xx.shape[2] == 4:\n+                            xx = xx.copy()\n+                        xx[np.any(nans, axis=2), :] = 0\n+\n                     if norm and (xx.max() > 1 or xx.min() < 0):\n                         raise ValueError(\"Floating point image RGB values \"\n                                          \"must be in the 0..1 range.\")\n", "test_patch": "diff --git a/lib/matplotlib/tests/test_colors.py b/lib/matplotlib/tests/test_colors.py\nindex 2d71fea83472..5b5332100c2a 100644\n--- a/lib/matplotlib/tests/test_colors.py\n+++ b/lib/matplotlib/tests/test_colors.py\n@@ -1352,6 +1352,32 @@ def test_scalarmappable_to_rgba(bytes):\n     np.testing.assert_almost_equal(sm.to_rgba(xm[..., :3], bytes=bytes), expected)\n \n \n+@pytest.mark.parametrize(\"bytes\", (True, False))\n+def test_scalarmappable_nan_to_rgba(bytes):\n+    sm = cm.ScalarMappable()\n+\n+    # RGBA\n+    x = np.ones((2, 3, 4), dtype=float) * 0.5\n+    x[0, 0, 0] = np.nan\n+    expected = x.copy()\n+    expected[0, 0, :] = 0\n+    if bytes:\n+        expected = (expected * 255).astype(np.uint8)\n+    np.testing.assert_almost_equal(sm.to_rgba(x, bytes=bytes), expected)\n+    assert np.any(np.isnan(x))  # Input array should not be changed\n+\n+    # RGB\n+    expected[..., 3] = 255 if bytes else 1\n+    expected[0, 0, 3] = 0\n+    np.testing.assert_almost_equal(sm.to_rgba(x[..., :3], bytes=bytes), expected)\n+    assert np.any(np.isnan(x))  # Input array should not be changed\n+\n+    # Out-of-range fail\n+    x[1, 0, 0] = 42\n+    with pytest.raises(ValueError, match='0..1 range'):\n+        sm.to_rgba(x[..., :3], bytes=bytes)\n+\n+\n def test_failed_conversions():\n     with pytest.raises(ValueError):\n         mcolors.to_rgba('5')\n", "problem_statement": "[Bug]: `imshow` allows RGB(A) images with `np.nan` values to pass\n### Bug summary\r\n\r\nUsing `imshow` to visualize a 2x2x1 array with nans scattered throughout works as expected. With the default \"bad\" color of black with alpha = 0, you'll see an axis' `facecolor` where the `nan`s are.\r\n\r\nWith a 2x2x3 array, the `nan`s are always black.\r\n\r\nWith a 2x2x4 array, and the alpha manually set to 0 where the `nan`s are, you get the correct behavior (i.e. you can see the axis where the nans are).\r\n\r\n### Code for reproduction\r\n\r\n```python\r\nimport numpy\r\nfrom matplotlib import pyplot\r\n\r\nimg = numpy.ones((2, 2))  # single channel 2x2\r\nimg_nan = img.copy()\r\nimg_nan[0, 0] = float('nan')\r\n\r\nimg3 = numpy.ones((2, 2, 3))  # RGB 2x2\r\nimg3_nan = img3.copy()\r\nimg3_nan[0, 0, :] = float('nan')\r\n\r\nimg4 = numpy.ones((2, 2, 4))  # RGBA 2x2\r\nimg4_nan = img4.copy()\r\nimg4_nan[0, 0, :] = float('nan')\r\nimg4_nan[0, 0, 3] = 0  # alpha\r\n\r\n\r\ndef imshow(a):\r\n    pyplot.figure()\r\n    im = pyplot.imshow(a)\r\n    # im.get_cmap().set_bad(color='y', alpha=1) # only works for single channel images\r\n    im.get_cmap().set_bad(alpha=0)\r\n    pyplot.gca().set_facecolor('y')\r\n\r\n\r\nimshow(img_nan)   # nan shows up as 'y'\r\nimshow(img3_nan)  # nan shows up as black\r\nimshow(img4_nan)  # nan shows up as 'y'\r\n\r\n\r\npyplot.show()\r\n```\r\n\r\n\r\n### Actual outcome\r\n\r\n![image](https://github.com/matplotlib/matplotlib/assets/26465923/bc067e95-da1a-4ddf-b55b-929b8a18054b)\r\n![image](https://github.com/matplotlib/matplotlib/assets/26465923/7afe79b4-64cc-4b41-a909-d2d6fe966af0)\r\n![image](https://github.com/matplotlib/matplotlib/assets/26465923/ef71c33e-991d-4fd5-95a2-80ce3a66584c)\r\n\r\n\r\n### Expected outcome\r\n\r\nFigures 2 and 3 above should look identical.\r\n\r\n### Additional information\r\n\r\nI traced through `imshow` and cannot see any difference between the single- and 3-channel image; the mask is there and it's correct in both cases. So I wonder if this is a backend issue?\r\n\r\n### Operating system\r\n\r\nWindows\r\n\r\n### Matplotlib Version\r\n\r\n3.7.3\r\n\r\n### Matplotlib Backend\r\n\r\nQtAgg\r\n\r\n### Python version\r\n\r\n3.8.10  \r\n\r\n### Jupyter version\r\n\r\n_No response_\r\n\r\n### Installation\r\n\r\npip\n", "hints_text": "colormaps aren't used for 3 or 4 channel imshow()'s, so the \"bad\" is never\r\napplicable there. With the 4 channel one, having an alpha of zero just\r\nreveals the color underneath.\r\n\r\nOn Thu, Nov 9, 2023 at 4:37\u202fPM Emilio Graff ***@***.***>\r\nwrote:\r\n\r\n> Bug summary\r\n>\r\n> Using imshow to visualize a 2x2x1 array with nans scattered throughout\r\n> works as expected. With the default \"bad\" color of black with alpha = 0,\r\n> you'll see an axis' facecolor where the nans are.\r\n>\r\n> With a 2x2x3 array, the nans are always black.\r\n>\r\n> With a 2x2x4 array, and the alpha manually set to 0 where the nans are,\r\n> you get the correct behavior (i.e. you can see the axis where the nans are.\r\n> Code for reproduction\r\n>\r\n> import numpyfrom matplotlib import pyplot\r\n> img = numpy.ones((2, 2))  # single channel 2x2img_nan = img.copy()img_nan[0, 0] = float('nan')\r\n> img3 = numpy.ones((2, 2, 3))  # RGB 2x2img3_nan = img3.copy()img3_nan[0, 0, :] = float('nan')\r\n> img4 = numpy.ones((2, 2, 4))  # RGBA 2x2img4_nan = img4.copy()img4_nan[0, 0, :] = float('nan')img4_nan[0, 0, 3] = 0  # alpha\r\n>\r\n> def imshow(a):\r\n>     pyplot.figure()\r\n>     im = pyplot.imshow(a)\r\n>     # im.get_cmap().set_bad(color='y', alpha=1) # only works for single channel images\r\n>     im.get_cmap().set_bad(alpha=0)\r\n>     pyplot.gca().set_facecolor('y')\r\n>\r\n> imshow(img_nan)   # nan shows up as 'y'imshow(img3_nan)  # nan shows up as blackimshow(img4_nan)  # nan shows up as 'y'\r\n>\r\n> pyplot.show()\r\n>\r\n> Actual outcome\r\n>\r\n> [image: image]\r\n> <https://user-images.githubusercontent.com/26465923/281868384-bc067e95-da1a-4ddf-b55b-929b8a18054b.png>\r\n> [image: image]\r\n> <https://user-images.githubusercontent.com/26465923/281868405-7afe79b4-64cc-4b41-a909-d2d6fe966af0.png>\r\n> [image: image]\r\n> <https://user-images.githubusercontent.com/26465923/281868433-ef71c33e-991d-4fd5-95a2-80ce3a66584c.png>\r\n> Expected outcome\r\n>\r\n> Figures 2 and 3 above should look identical.\r\n> Additional information\r\n>\r\n> I traced through imshow and cannot see any difference between the single-\r\n> and 3-channel image; the mask is there and it's correct in both cases. So I\r\n> wonder if this is a backend issue?\r\n> Operating system\r\n>\r\n> Windows\r\n> Matplotlib Version\r\n>\r\n> 3.7.3\r\n> Matplotlib Backend\r\n>\r\n> QtAgg\r\n> Python version\r\n>\r\n> 3.8.10\r\n> Jupyter version\r\n>\r\n> *No response*\r\n> Installation\r\n>\r\n> pip\r\n>\r\n> \u2014\r\n> Reply to this email directly, view it on GitHub\r\n> <https://github.com/matplotlib/matplotlib/issues/27301>, or unsubscribe\r\n> <https://github.com/notifications/unsubscribe-auth/AACHF6FMWP2UDJGCCPC3SILYDVEJRAVCNFSM6AAAAAA7FHKK6KVHI2DSMVQWIX3LMV43ASLTON2WKOZRHE4DMNBUGA4DGOA>\r\n> .\r\n> You are receiving this because you are subscribed to this thread.Message\r\n> ID: ***@***.***>\r\n>\r\n\nThere's an additional thing here.\r\n\r\nMoving the mouse pointer over the image:\r\n1. In the 1- and 3-channel case, the area where the `nan` is shows `[]`\r\n2. in the 4-channel case, it shows `[0]`\n> colormaps aren't used for 3 or 4 channel imshow()'s, so the \"bad\" is never applicable there. With the 4 channel one, having an alpha of zero just reveals the color underneath.\r\n\r\nOK fine, colormaps are ignored for 3- and 4-channel images. I guess I'm arguing that masking out `nan` should still happen. It actually is, and then getting thrown out / ignored somewhere down the line.\nFor float RGB(A) images I am not sure what I would expect `np.nan` to do.  Empirically, it looks like it is getting converted to `0` by Agg (as `ScalarMappable.to_rgba` appears to pass it through just fine and does not trigger any of the warnings as the `np.nan` poisons the min/max computations and reports false for all comparisons).\r\n\r\nMy inclination is that the second two cases should be raising on invalid input (as they would if you passed `2` for one of the channels.\nand the reason the second RGB(A) case looks like it works is that the alpha channel is 0 so it does not matter what the RGB channels do.\n@tacaswell, if I understand correctly, you're now going to raise an exception if an RGB image has `nan`s in it?\r\n\r\nThis seems quite harsh, since single-channel images are allowed to have `nan`s and even have a mechanism to control their display with `set_bad`.\r\n\r\nMy RGBA example is a workaround; in our application, I went that route because I want 1- and 3- channel images to behave the same with regards to `nan`.\nI think I would expect points with nans to be treated the same as masked points.  We have explicit handling that sets the alpha to zero if any of the channels are masked at the given point:\r\n\r\nhttps://github.com/matplotlib/matplotlib/blob/c0e9ebc10d28daa337fba4884fd52caddc4b732c/lib/matplotlib/cm.py#L501-L504", "created_at": "2024-03-03T15:47:47Z"}
{"repo": "matplotlib/matplotlib", "pull_number": 27840, "instance_id": "matplotlib__matplotlib-27840", "issue_numbers": ["27792", "0000"], "base_commit": "5300bd67702e4fb8196cdf032bfcb47aa57e6ec1", "patch": "diff --git a/doc/users/next_whats_new/boxplot_legend_support.rst b/doc/users/next_whats_new/boxplot_legend_support.rst\nnew file mode 100644\nindex 000000000000..44802960d9bb\n--- /dev/null\n+++ b/doc/users/next_whats_new/boxplot_legend_support.rst\n@@ -0,0 +1,60 @@\n+Legend support for Boxplot\n+~~~~~~~~~~~~~~~~~~~~~~~~~~\n+Boxplots now support a *label* parameter to create legend entries.\n+\n+Legend labels can be passed as a list of strings to label multiple boxes in a single\n+`.Axes.boxplot` call:\n+\n+\n+.. plot::\n+    :include-source: true\n+    :alt: Example of creating 3 boxplots and assigning legend labels as a sequence.\n+\n+    import matplotlib.pyplot as plt\n+    import numpy as np\n+\n+    np.random.seed(19680801)\n+    fruit_weights = [\n+        np.random.normal(130, 10, size=100),\n+        np.random.normal(125, 20, size=100),\n+        np.random.normal(120, 30, size=100),\n+    ]\n+    labels = ['peaches', 'oranges', 'tomatoes']\n+    colors = ['peachpuff', 'orange', 'tomato']\n+\n+    fig, ax = plt.subplots()\n+    ax.set_ylabel('fruit weight (g)')\n+\n+    bplot = ax.boxplot(fruit_weights,\n+                       patch_artist=True,  # fill with color\n+                       label=labels)\n+\n+    # fill with colors\n+    for patch, color in zip(bplot['boxes'], colors):\n+        patch.set_facecolor(color)\n+\n+    ax.set_xticks([])\n+    ax.legend()\n+\n+\n+Or as a single string to each individual `.Axes.boxplot`:\n+\n+.. plot::\n+    :include-source: true\n+    :alt: Example of creating 2 boxplots and assigning each legend label as a string.\n+\n+    import matplotlib.pyplot as plt\n+    import numpy as np\n+\n+    fig, ax = plt.subplots()\n+\n+    data_A = np.random.random((100, 3))\n+    data_B = np.random.random((100, 3)) + 0.2\n+    pos = np.arange(3)\n+\n+    ax.boxplot(data_A, positions=pos - 0.2, patch_artist=True, label='Box A',\n+               boxprops={'facecolor': 'steelblue'})\n+    ax.boxplot(data_B, positions=pos + 0.2, patch_artist=True, label='Box B',\n+               boxprops={'facecolor': 'lightblue'})\n+\n+    ax.legend()\ndiff --git a/lib/matplotlib/axes/_axes.py b/lib/matplotlib/axes/_axes.py\nindex 627dd2c36d40..44d82184c3c8 100644\n--- a/lib/matplotlib/axes/_axes.py\n+++ b/lib/matplotlib/axes/_axes.py\n@@ -3798,7 +3798,7 @@ def boxplot(self, x, notch=None, sym=None, vert=None, whis=None,\n                 tick_labels=None, flierprops=None, medianprops=None,\n                 meanprops=None, capprops=None, whiskerprops=None,\n                 manage_ticks=True, autorange=False, zorder=None,\n-                capwidths=None):\n+                capwidths=None, label=None):\n         \"\"\"\n         Draw a box and whisker plot.\n \n@@ -3985,6 +3985,20 @@ def boxplot(self, x, notch=None, sym=None, vert=None, whis=None,\n             The style of the median.\n         meanprops : dict, default: None\n             The style of the mean.\n+        label : str or list of str, optional\n+            Legend labels. Use a single string when all boxes have the same style and\n+            you only want a single legend entry for them. Use a list of strings to\n+            label all boxes individually. To be distinguishable, the boxes should be\n+            styled individually, which is currently only possible by modifying the\n+            returned artists, see e.g. :doc:`/gallery/statistics/boxplot_demo`.\n+\n+            In the case of a single string, the legend entry will technically be\n+            associated with the first box only. By default, the legend will show the\n+            median line (``result[\"medians\"]``); if *patch_artist* is True, the legend\n+            will show the box `.Patch` artists (``result[\"boxes\"]``) instead.\n+\n+            .. versionadded:: 3.9\n+\n         data : indexable object, optional\n             DATA_PARAMETER_PLACEHOLDER\n \n@@ -4105,7 +4119,7 @@ def boxplot(self, x, notch=None, sym=None, vert=None, whis=None,\n                            meanline=meanline, showfliers=showfliers,\n                            capprops=capprops, whiskerprops=whiskerprops,\n                            manage_ticks=manage_ticks, zorder=zorder,\n-                           capwidths=capwidths)\n+                           capwidths=capwidths, label=label)\n         return artists\n \n     def bxp(self, bxpstats, positions=None, widths=None, vert=True,\n@@ -4114,7 +4128,7 @@ def bxp(self, bxpstats, positions=None, widths=None, vert=True,\n             boxprops=None, whiskerprops=None, flierprops=None,\n             medianprops=None, capprops=None, meanprops=None,\n             meanline=False, manage_ticks=True, zorder=None,\n-            capwidths=None):\n+            capwidths=None, label=None):\n         \"\"\"\n         Draw a box and whisker plot from pre-computed statistics.\n \n@@ -4197,6 +4211,20 @@ def bxp(self, bxpstats, positions=None, widths=None, vert=True,\n           If True, the tick locations and labels will be adjusted to match the\n           boxplot positions.\n \n+        label : str or list of str, optional\n+            Legend labels. Use a single string when all boxes have the same style and\n+            you only want a single legend entry for them. Use a list of strings to\n+            label all boxes individually. To be distinguishable, the boxes should be\n+            styled individually, which is currently only possible by modifying the\n+            returned artists, see e.g. :doc:`/gallery/statistics/boxplot_demo`.\n+\n+            In the case of a single string, the legend entry will technically be\n+            associated with the first box only. By default, the legend will show the\n+            median line (``result[\"medians\"]``); if *patch_artist* is True, the legend\n+            will show the box `.Patch` artists (``result[\"boxes\"]``) instead.\n+\n+            .. versionadded:: 3.9\n+\n         zorder : float, default: ``Line2D.zorder = 2``\n           The zorder of the resulting boxplot.\n \n@@ -4361,6 +4389,7 @@ def do_patch(xs, ys, **kwargs):\n             if showbox:\n                 do_box = do_patch if patch_artist else do_plot\n                 boxes.append(do_box(box_x, box_y, **box_kw))\n+                median_kw.setdefault('label', '_nolegend_')\n             # draw the whiskers\n             whisker_kw.setdefault('label', '_nolegend_')\n             whiskers.append(do_plot(whis_x, whislo_y, **whisker_kw))\n@@ -4371,7 +4400,6 @@ def do_patch(xs, ys, **kwargs):\n                 caps.append(do_plot(cap_x, cap_lo, **cap_kw))\n                 caps.append(do_plot(cap_x, cap_hi, **cap_kw))\n             # draw the medians\n-            median_kw.setdefault('label', '_nolegend_')\n             medians.append(do_plot(med_x, med_y, **median_kw))\n             # maybe draw the means\n             if showmeans:\n@@ -4389,6 +4417,18 @@ def do_patch(xs, ys, **kwargs):\n                 flier_y = stats['fliers']\n                 fliers.append(do_plot(flier_x, flier_y, **flier_kw))\n \n+        # Set legend labels\n+        if label:\n+            box_or_med = boxes if showbox and patch_artist else medians\n+            if cbook.is_scalar_or_string(label):\n+                # assign the label only to the first box\n+                box_or_med[0].set_label(label)\n+            else:  # label is a sequence\n+                if len(box_or_med) != len(label):\n+                    raise ValueError(datashape_message.format(\"label\"))\n+                for artist, lbl in zip(box_or_med, label):\n+                    artist.set_label(lbl)\n+\n         if manage_ticks:\n             axis_name = \"x\" if vert else \"y\"\n             interval = getattr(self.dataLim, f\"interval{axis_name}\")\ndiff --git a/lib/matplotlib/axes/_axes.pyi b/lib/matplotlib/axes/_axes.pyi\nindex 18c10c1452ba..b70d330aa442 100644\n--- a/lib/matplotlib/axes/_axes.pyi\n+++ b/lib/matplotlib/axes/_axes.pyi\n@@ -372,6 +372,7 @@ class Axes(_AxesBase):\n         autorange: bool = ...,\n         zorder: float | None = ...,\n         capwidths: float | ArrayLike | None = ...,\n+        label: Sequence[str] | None = ...,\n         *,\n         data=...,\n     ) -> dict[str, Any]: ...\n@@ -397,6 +398,7 @@ class Axes(_AxesBase):\n         manage_ticks: bool = ...,\n         zorder: float | None = ...,\n         capwidths: float | ArrayLike | None = ...,\n+        label: Sequence[str] | None = ...,\n     ) -> dict[str, Any]: ...\n     def scatter(\n         self,\ndiff --git a/lib/matplotlib/pyplot.py b/lib/matplotlib/pyplot.py\nindex 04d889ec0616..81a6622db77e 100644\n--- a/lib/matplotlib/pyplot.py\n+++ b/lib/matplotlib/pyplot.py\n@@ -2871,6 +2871,7 @@ def boxplot(\n     autorange: bool = False,\n     zorder: float | None = None,\n     capwidths: float | ArrayLike | None = None,\n+    label: Sequence[str] | None = None,\n     *,\n     data=None,\n ) -> dict[str, Any]:\n@@ -2902,6 +2903,7 @@ def boxplot(\n         autorange=autorange,\n         zorder=zorder,\n         capwidths=capwidths,\n+        label=label,\n         **({\"data\": data} if data is not None else {}),\n     )\n \n", "test_patch": "diff --git a/lib/matplotlib/tests/test_legend.py b/lib/matplotlib/tests/test_legend.py\nindex 3b3145006427..9b7a6dfd10c9 100644\n--- a/lib/matplotlib/tests/test_legend.py\n+++ b/lib/matplotlib/tests/test_legend.py\n@@ -1435,3 +1435,35 @@ def test_legend_text():\n         leg_bboxes.append(\n             leg.get_window_extent().transformed(ax.transAxes.inverted()))\n     assert_allclose(leg_bboxes[1].bounds, leg_bboxes[0].bounds)\n+\n+\n+def test_boxplot_legend_labels():\n+    # Test that legend entries are generated when passing `label`.\n+    np.random.seed(19680801)\n+    data = np.random.random((10, 4))\n+    fig, axs = plt.subplots(nrows=1, ncols=4)\n+    legend_labels = ['box A', 'box B', 'box C', 'box D']\n+\n+    # Testing legend labels and patch passed to legend.\n+    bp1 = axs[0].boxplot(data, patch_artist=True, label=legend_labels)\n+    assert [v.get_label() for v in bp1['boxes']] == legend_labels\n+    handles, labels = axs[0].get_legend_handles_labels()\n+    assert labels == legend_labels\n+    assert all(isinstance(h, mpl.patches.PathPatch) for h in handles)\n+\n+    # Testing legend without `box`.\n+    bp2 = axs[1].boxplot(data, label=legend_labels, showbox=False)\n+    # Without a box, The legend entries should be passed from the medians.\n+    assert [v.get_label() for v in bp2['medians']] == legend_labels\n+    handles, labels = axs[1].get_legend_handles_labels()\n+    assert labels == legend_labels\n+    assert all(isinstance(h, mpl.lines.Line2D) for h in handles)\n+\n+    # Testing legend with number of labels different from number of boxes.\n+    with pytest.raises(ValueError, match='values must have same the length'):\n+        bp3 = axs[2].boxplot(data, label=legend_labels[:-1])\n+\n+    # Test that for a string label, only the first box gets a label.\n+    bp4 = axs[3].boxplot(data, label='box A')\n+    assert bp4['medians'][0].get_label() == 'box A'\n+    assert all(x.get_label().startswith(\"_\") for x in bp4['medians'][1:])\n", "problem_statement": "[ENH]: Legend entries for boxplot\n### Problem\r\n\r\nCurrently, boxplots do not get legend entries. #27711 was an attempt to introduce them but only solved one very particular usecase and did not generalize well. See https://github.com/matplotlib/matplotlib/pull/27780.\r\n\r\nThere is a `labels` parameter, but that only sets x-tick labels. And it has one entry per box. For the legend we should have only one entry per `boxplot()` call no matter how many boxes that has, because `boxplot` draws N identically styled boxes and it does not make sense to have N identical handles with different labels.\r\n\r\nBecause of the x-tick relation of  `labels` and it's relation to individual boxes, this parameter is not suited for the legend labels. \r\n\r\n### Proposed solution\r\n\r\nWe need a separate parameter. There are basically two options:\r\n\r\n#### Variant 1) `legend_label: str`\r\n\r\n*pro*: simple and clear, no interference with the existing API\r\n*con*: inconsistent with the rest of the library: all other functions use `label` for the legend entry.\r\n\r\n\r\n#### Variant 2) `label: str`\r\n*pro*: consistent with the rest of the library\r\n*con*: Having `label` alongside `labels` is quite confusing and easily leads to errors. (We could runtime-check for the type str vs list of str, to give helpful error messages but still ...)\r\nIf we want to go this way, we should rename `labels` to `tick_labels` or similar.\r\n\n", "hints_text": "Side note: We may later allow a list of labels if we want to ease labeling when styling individually, e.g. (currently not working code):\r\n\r\n```\r\nbplot = ax.boxplot(fruit_weights, patch_artist=True, legend_labels=labels)\r\nfor patch, color in zip(bplot['boxes'], colors):\r\n    patch.set_facecolor(color)\r\n```\r\n![grafik](https://github.com/matplotlib/matplotlib/assets/2836374/905f4713-15d5-4128-8d98-cdd2bf660b33)\r\n\nI'm unconvinced we would need to support passing multiple legend labels.  If you are already looping through your artists to set the colours, you can set the labels at the same time.  This works with v3.8.2:\r\n\r\n```python\r\nimport matplotlib.pyplot as plt\r\nimport numpy as np\r\n\r\nnp.random.seed(19680801)\r\nfruit_weights = [\r\n    np.random.normal(130, 10, size=100),\r\n    np.random.normal(125, 20, size=100),\r\n    np.random.normal(120, 30, size=100),\r\n]\r\nlabels = ['peaches', 'oranges', 'tomatoes']\r\ncolors = ['peachpuff', 'orange', 'tomato']\r\n\r\nfig, ax = plt.subplots()\r\nax.set_ylabel('fruit weight (g)')\r\n\r\nbplot = ax.boxplot(fruit_weights,\r\n                   patch_artist=True)  # fill with color\r\n\r\n# fill with colors and add legend labels\r\nfor patch, color, label in zip(bplot['boxes'], colors, labels):\r\n    patch.set_facecolor(color)\r\n    patch.set_label(label)\r\n    \r\nax.legend()\r\nax.get_xaxis().set_visible(False)\r\n\r\nplt.show()\r\n```\r\n![image](https://github.com/matplotlib/matplotlib/assets/10599679/3795eee8-e663-4e41-bf82-38ed1845240c)\r\n\r\n\n> I'm unconvinced we would need to support passing multiple legend labels. \r\n\r\nTrue. OTOH it doesn't cost us much. And it leaves the theoretical option open to add per-box coloring later (note that we've recently done this for `bar` (see https://matplotlib.org/stable/gallery/lines_bars_and_markers/bar_colors.html). Not that I have any concrete plans to do this, but it's not unreasonable.\r\n\r\nWhat I actually wanted to say with this is that extensions in that directions are possible in a consistent way.\n> Because of the x-tick relation of labels and it's relation to individual boxes, this parameter is not suited for the legend labels.\r\n> If we want to go this way, we should rename labels to tick_labels or similar.\r\n\r\nHow bad would it be to do a shuffle `labels->tick_labels` then `labels` gets used for legend like everywhere else? \r\n\nNote: There`s currently `labels` (plural). If anything the new one would be `label` (singular). So strictly there's no overlap.\r\n\r\nBut\r\n\r\n- if you don't rename `labels`, as said above having `labels` and `label` would be really confusing.\r\n- if you rename `labels`, I assume that will break about every boxplot. As soon as you have two boxes `labels` is by far the most simple solution to identify them.\r\n\n>  If anything the new one would belabel` (singular).\r\n\r\nYeah, sorry missed that `label` is what gets used everywhere for legend. Then variant 2 + rename makes sense- I assume the rename will go through a deprecation process to not break everything?\r\n\nDisregarding the existing API and how we would migrate, would `label` +  `tick_labels` be good?\r\n\r\n- yes in terms of API consistency\r\n- meh in terms of `label` is generic `tick_labels` is specific. - As long as you only have one label (like in `plot`), generic is ok. The alternative here would be to have two specific names `legend_label` + `tick_labels`.\nCould we introduce `tick_labels` and `legend_label` and have a longer-than-usual deprecation period for `labels`?\nI lean towards `label`>`legend_label` b/c  API consistency >> name specificity. \n Note to self/ to whoever is interested (I haven't made up my mind on this yet):\r\n\r\nShould `positions` also support str labels - in other functions we allow str as inputs on coordinate labels (e.g. x in `bar()`).\r\nAnd if so, should we then remove the current `labels`. - While a little less capable (one can currently use `labels` alongside positions to create str labeled boxes at arbitrary positions), the main use case for simple labeling would be covered.\n`bar(h)` also uses the `tick_label` and `label` semantics so this would be consistent with that. \r\n\r\n> How bad would it be to do a shuffle `labels->tick_labels` then `labels` gets used for legend like everywhere else?\r\n\r\nI have a solution almost ready for this using variant 2 where the labels are set this way:\r\n\r\n```py\r\nlabels = ['peaches', 'oranges', 'tomatoes']\r\nticklabels = ['a', 'b', 'c']\r\n\r\nbplot = ax.boxplot(fruit_weights,\r\n                   tick_labels=ticklabels, \r\n                   label=labels) # legend labels\r\nax.legend()\r\n```\r\nI can send in a PR as it is, unless you want to discuss this more (I don't want to create a bias for this variant.)\n> `bar(h)` also uses the `tick_label` and `label` semantics so this would be consistent with that.\r\n\r\nThis is a very good point. Let's go with that.\r\n\r\n\r\n> I have a solution almost ready for this using variant 2 where the labels are set this way:\r\n> \r\n> ```python\r\n> labels = ['peaches', 'oranges', 'tomatoes']\r\n> ticklabels = ['a', 'b', 'c']\r\n> \r\n> bplot = ax.boxplot(fruit_weights,\r\n>                    tick_labels=ticklabels, \r\n>                    label=labels) # legend labels\r\n> ax.legend()\r\n> ```\r\n> \r\n> I can send in a PR as it is, unless you want to discuss this more (I don't want to create a bias for this variant.)\r\n\r\nGo for it! Please note that `label` should accept str and list of str, as with `bar()`.", "created_at": "2024-03-01T06:26:23Z"}
{"repo": "matplotlib/matplotlib", "pull_number": 27833, "instance_id": "matplotlib__matplotlib-27833", "issue_numbers": ["27831", "0000"], "base_commit": "c0071b825b5b1d97b9216acd7b67b47004375ef2", "patch": "diff --git a/doc/api/next_api_changes/behavior/27833-JA.rst b/doc/api/next_api_changes/behavior/27833-JA.rst\nnew file mode 100644\nindex 000000000000..59323f56108f\n--- /dev/null\n+++ b/doc/api/next_api_changes/behavior/27833-JA.rst\n@@ -0,0 +1,8 @@\n+SVG output: improved reproducibility\n+~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n+\n+Some SVG-format plots `produced different output on each render <https://github.com/matplotlib/matplotlib/issues/27831>`__, even with a static ``svg.hashsalt`` value configured.\n+\n+The problem was a non-deterministic ID-generation scheme for clip paths; the fix introduces a repeatable, monotonically increasing integer ID scheme as a replacement.\n+\n+Provided that plots add clip paths themselves in deterministic order, this enables repeatable (a.k.a. reproducible, deterministic) SVG output.\ndiff --git a/lib/matplotlib/backends/backend_svg.py b/lib/matplotlib/backends/backend_svg.py\nindex 72354b81862b..51eee57a6a84 100644\n--- a/lib/matplotlib/backends/backend_svg.py\n+++ b/lib/matplotlib/backends/backend_svg.py\n@@ -302,6 +302,7 @@ def __init__(self, width, height, svgwriter, basename=None, image_dpi=72,\n \n         self._groupd = {}\n         self._image_counter = itertools.count()\n+        self._clip_path_ids = {}\n         self._clipd = {}\n         self._markers = {}\n         self._path_collection_id = 0\n@@ -325,6 +326,20 @@ def __init__(self, width, height, svgwriter, basename=None, image_dpi=72,\n         self._write_metadata(metadata)\n         self._write_default_style()\n \n+    def _get_clippath_id(self, clippath):\n+        \"\"\"\n+        Returns a stable and unique identifier for the *clippath* argument\n+        object within the current rendering context.\n+\n+        This allows plots that include custom clip paths to produce identical\n+        SVG output on each render, provided that the :rc:`svg.hashsalt` config\n+        setting and the ``SOURCE_DATE_EPOCH`` build-time environment variable\n+        are set to fixed values.\n+        \"\"\"\n+        if clippath not in self._clip_path_ids:\n+            self._clip_path_ids[clippath] = len(self._clip_path_ids)\n+        return self._clip_path_ids[clippath]\n+\n     def finalize(self):\n         self._write_clips()\n         self._write_hatches()\n@@ -590,7 +605,7 @@ def _get_clip_attrs(self, gc):\n         clippath, clippath_trans = gc.get_clip_path()\n         if clippath is not None:\n             clippath_trans = self._make_flip_transform(clippath_trans)\n-            dictkey = (id(clippath), str(clippath_trans))\n+            dictkey = (self._get_clippath_id(clippath), str(clippath_trans))\n         elif cliprect is not None:\n             x, y, w, h = cliprect.bounds\n             y = self.height-(y+h)\n@@ -605,7 +620,7 @@ def _get_clip_attrs(self, gc):\n             else:\n                 self._clipd[dictkey] = (dictkey, oid)\n         else:\n-            clip, oid = clip\n+            _, oid = clip\n         return {'clip-path': f'url(#{oid})'}\n \n     def _write_clips(self):\n", "test_patch": "diff --git a/lib/matplotlib/tests/test_backend_svg.py b/lib/matplotlib/tests/test_backend_svg.py\nindex 01edbf870fb4..b694bb297912 100644\n--- a/lib/matplotlib/tests/test_backend_svg.py\n+++ b/lib/matplotlib/tests/test_backend_svg.py\n@@ -10,6 +10,7 @@\n \n import matplotlib as mpl\n from matplotlib.figure import Figure\n+from matplotlib.patches import Circle\n from matplotlib.text import Text\n import matplotlib.pyplot as plt\n from matplotlib.testing.decorators import check_figures_equal, image_comparison\n@@ -299,6 +300,33 @@ def include(gid, obj):\n             assert gid in buf\n \n \n+def test_clip_path_ids_reuse():\n+    fig, circle = Figure(), Circle((0, 0), radius=10)\n+    for i in range(5):\n+        ax = fig.add_subplot()\n+        aimg = ax.imshow([[i]])\n+        aimg.set_clip_path(circle)\n+\n+    inner_circle = Circle((0, 0), radius=1)\n+    ax = fig.add_subplot()\n+    aimg = ax.imshow([[0]])\n+    aimg.set_clip_path(inner_circle)\n+\n+    with BytesIO() as fd:\n+        fig.savefig(fd, format='svg')\n+        buf = fd.getvalue()\n+\n+    tree = xml.etree.ElementTree.fromstring(buf)\n+    ns = 'http://www.w3.org/2000/svg'\n+\n+    clip_path_ids = set()\n+    for node in tree.findall(f'.//{{{ns}}}clipPath[@id]'):\n+        node_id = node.attrib['id']\n+        assert node_id not in clip_path_ids  # assert ID uniqueness\n+        clip_path_ids.add(node_id)\n+    assert len(clip_path_ids) == 2  # only two clipPaths despite reuse in multiple axes\n+\n+\n def test_savefig_tight():\n     # Check that the draw-disabled renderer correctly disables open/close_group\n     # as well.\ndiff --git a/lib/matplotlib/tests/test_determinism.py b/lib/matplotlib/tests/test_determinism.py\nindex 3865dbc7fa43..2ecc40dbd3c0 100644\n--- a/lib/matplotlib/tests/test_determinism.py\n+++ b/lib/matplotlib/tests/test_determinism.py\n@@ -8,13 +8,21 @@\n import pytest\n \n import matplotlib as mpl\n-import matplotlib.testing.compare\n from matplotlib import pyplot as plt\n-from matplotlib.testing._markers import needs_ghostscript, needs_usetex\n+from matplotlib.cbook import get_sample_data\n+from matplotlib.collections import PathCollection\n+from matplotlib.image import BboxImage\n+from matplotlib.offsetbox import AnchoredOffsetbox, AuxTransformBox\n+from matplotlib.patches import Circle, PathPatch\n+from matplotlib.path import Path\n from matplotlib.testing import subprocess_run_for_testing\n+from matplotlib.testing._markers import needs_ghostscript, needs_usetex\n+import matplotlib.testing.compare\n+from matplotlib.text import TextPath\n+from matplotlib.transforms import IdentityTransform\n \n \n-def _save_figure(objects='mhi', fmt=\"pdf\", usetex=False):\n+def _save_figure(objects='mhip', fmt=\"pdf\", usetex=False):\n     mpl.use(fmt)\n     mpl.rcParams.update({'svg.hashsalt': 'asdf', 'text.usetex': usetex})\n \n@@ -50,6 +58,76 @@ def _save_figure(objects='mhi', fmt=\"pdf\", usetex=False):\n         A = [[2, 3, 1], [1, 2, 3], [2, 1, 3]]\n         fig.add_subplot(1, 6, 5).imshow(A, interpolation='bicubic')\n \n+    if 'p' in objects:\n+\n+        # clipping support class, copied from demo_text_path.py gallery example\n+        class PathClippedImagePatch(PathPatch):\n+            \"\"\"\n+            The given image is used to draw the face of the patch. Internally,\n+            it uses BboxImage whose clippath set to the path of the patch.\n+\n+            FIXME : The result is currently dpi dependent.\n+            \"\"\"\n+\n+            def __init__(self, path, bbox_image, **kwargs):\n+                super().__init__(path, **kwargs)\n+                self.bbox_image = BboxImage(\n+                    self.get_window_extent, norm=None, origin=None)\n+                self.bbox_image.set_data(bbox_image)\n+\n+            def set_facecolor(self, color):\n+                \"\"\"Simply ignore facecolor.\"\"\"\n+                super().set_facecolor(\"none\")\n+\n+            def draw(self, renderer=None):\n+                # the clip path must be updated every draw. any solution? -JJ\n+                self.bbox_image.set_clip_path(self._path, self.get_transform())\n+                self.bbox_image.draw(renderer)\n+                super().draw(renderer)\n+\n+        # add a polar projection\n+        px = fig.add_subplot(projection=\"polar\")\n+        pimg = px.imshow([[2]])\n+        pimg.set_clip_path(Circle((0, 1), radius=0.3333))\n+\n+        # add a text-based clipping path (origin: demo_text_path.py)\n+        (ax1, ax2) = fig.subplots(2)\n+        arr = plt.imread(get_sample_data(\"grace_hopper.jpg\"))\n+        text_path = TextPath((0, 0), \"!?\", size=150)\n+        p = PathClippedImagePatch(text_path, arr, ec=\"k\")\n+        offsetbox = AuxTransformBox(IdentityTransform())\n+        offsetbox.add_artist(p)\n+        ao = AnchoredOffsetbox(loc='upper left', child=offsetbox, frameon=True,\n+                               borderpad=0.2)\n+        ax1.add_artist(ao)\n+\n+        # add a 2x2 grid of path-clipped axes (origin: test_artist.py)\n+        exterior = Path.unit_rectangle().deepcopy()\n+        exterior.vertices *= 4\n+        exterior.vertices -= 2\n+        interior = Path.unit_circle().deepcopy()\n+        interior.vertices = interior.vertices[::-1]\n+        clip_path = Path.make_compound_path(exterior, interior)\n+\n+        star = Path.unit_regular_star(6).deepcopy()\n+        star.vertices *= 2.6\n+\n+        (row1, row2) = fig.subplots(2, 2, sharex=True, sharey=True)\n+        for row in (row1, row2):\n+            ax1, ax2 = row\n+            collection = PathCollection([star], lw=5, edgecolor='blue',\n+                                        facecolor='red', alpha=0.7, hatch='*')\n+            collection.set_clip_path(clip_path, ax1.transData)\n+            ax1.add_collection(collection)\n+\n+            patch = PathPatch(star, lw=5, edgecolor='blue', facecolor='red',\n+                              alpha=0.7, hatch='*')\n+            patch.set_clip_path(clip_path, ax2.transData)\n+            ax2.add_patch(patch)\n+\n+            ax1.set_xlim([-3, 3])\n+            ax1.set_ylim([-3, 3])\n+\n     x = range(5)\n     ax = fig.add_subplot(1, 6, 6)\n     ax.plot(x, x)\n@@ -67,12 +145,13 @@ def _save_figure(objects='mhi', fmt=\"pdf\", usetex=False):\n         (\"m\", \"pdf\", False),\n         (\"h\", \"pdf\", False),\n         (\"i\", \"pdf\", False),\n-        (\"mhi\", \"pdf\", False),\n-        (\"mhi\", \"ps\", False),\n+        (\"mhip\", \"pdf\", False),\n+        (\"mhip\", \"ps\", False),\n         pytest.param(\n-            \"mhi\", \"ps\", True, marks=[needs_usetex, needs_ghostscript]),\n-        (\"mhi\", \"svg\", False),\n-        pytest.param(\"mhi\", \"svg\", True, marks=needs_usetex),\n+            \"mhip\", \"ps\", True, marks=[needs_usetex, needs_ghostscript]),\n+        (\"p\", \"svg\", False),\n+        (\"mhip\", \"svg\", False),\n+        pytest.param(\"mhip\", \"svg\", True, marks=needs_usetex),\n     ]\n )\n def test_determinism_check(objects, fmt, usetex):\n@@ -84,7 +163,7 @@ def test_determinism_check(objects, fmt, usetex):\n     ----------\n     objects : str\n         Objects to be included in the test document: 'm' for markers, 'h' for\n-        hatch patterns, 'i' for images.\n+        hatch patterns, 'i' for images, and 'p' for paths.\n     fmt : {\"pdf\", \"ps\", \"svg\"}\n         Output format.\n     \"\"\"\n", "problem_statement": "[Bug]: Nondeterminism in SVG clipPath element id attributes\n### Bug summary\r\n\r\nHello - I'm trying to make the [`astroplan`](https://github.com/astropy/astroplan) documentation build [reproducibly](https://reproducible-builds.org/) in Debian, and have found a snag: despite configuring the [`svg.hashsalt`](https://matplotlib.org/stable/users/explain/customizing.html?highlight=svg.hashsalt#matplotlibrc-sample) to successfully make `path` identifiers in some SVG plots generated by `matplotlib` deterministic, there is a remaining problem that `clipPath` identifiers are nondeterministic.\r\n\r\nThe cause appears to be the use of Python object ID (via [`id(...)` calls here](https://github.com/matplotlib/matplotlib/blob/c23ccdde6f0f8c071b09a88770e24452f2859e99/lib/matplotlib/backends/backend_svg.py#L622)) when [generating `clippath` IDs](https://github.com/matplotlib/matplotlib/blob/c23ccdde6f0f8c071b09a88770e24452f2859e99/lib/matplotlib/backends/backend_svg.py#L631).\r\n\r\n### Code for reproduction\r\n\r\n```Python\r\nimport matplotlib as mpl\r\nimport matplotlib.pyplot as plt\r\nimport sys\r\n\r\nmpl.rcParams[\"svg.hashsalt\"] = \"fixed-salt\"\r\n\r\nfig = plt.gcf()\r\nfig.add_subplot(projection=\"polar\")\r\n\r\nplt.savefig(sys.stdout.buffer, format=\"svg\")\r\n```\r\n\r\n\r\n### Actual outcome\r\n\r\nDifferences appear in the `clipPath` identifiers and their references from elsewhere in the SVG output.\r\n\r\n### Expected outcome\r\n\r\nWhen an `svg.hashsalt` value is configured, the SVG output should be deterministic.\r\n\r\n### Additional information\r\n\r\nThis could arguably be an enhancement request rather than a bug.\r\n\r\nConfiguring a static `PYTHONHASHSEED` value does not help to produce deterministic results.\r\n\r\n### Operating system\r\n\r\nDebian GNU/Linux (trixie)\r\n\r\n### Matplotlib Version\r\n\r\n3.6.3\r\n\r\n### Matplotlib Backend\r\n\r\nTkAgg\r\n\r\n### Python version\r\n\r\nPython 3.11.8\r\n\r\n### Jupyter version\r\n\r\nN/A\r\n\r\n### Installation\r\n\r\nLinux package manager\n", "hints_text": "### Good first issue - notes for new contributors\n\nThis issue is suited to new contributors because it does not require understanding of the\nMatplotlib internals. To get started, please see our [contributing\nguide](https://matplotlib.org/stable/devel/index).\n\n**We do not assign issues**. Check the *Development* section in the sidebar for linked pull\nrequests (PRs). If there are none, feel free to start working on it. If there is an open PR, please\ncollaborate on the work by reviewing it rather than duplicating it in a competing PR.\n\nIf something is unclear, please reach out on any of our [communication\nchannels](https://matplotlib.org/stable/devel/contributing.html#get-connected).", "created_at": "2024-02-28T23:25:16Z"}
{"repo": "matplotlib/matplotlib", "pull_number": 27773, "instance_id": "matplotlib__matplotlib-27773", "issue_numbers": ["27770"], "base_commit": "641e3def2c8f915f741937ddfc7ff28ca86a6370", "patch": "diff --git a/lib/matplotlib/axes/_axes.py b/lib/matplotlib/axes/_axes.py\nindex b1aeb87e6b45..711d930a1253 100644\n--- a/lib/matplotlib/axes/_axes.py\n+++ b/lib/matplotlib/axes/_axes.py\n@@ -5883,7 +5883,7 @@ def _pcolorargs(self, funcname, *args, shading='auto', **kwargs):\n                 def _interp_grid(X):\n                     # helper for below\n                     if np.shape(X)[1] > 1:\n-                        dX = np.diff(X, axis=1)/2.\n+                        dX = np.diff(X, axis=1) * 0.5\n                         if not (np.all(dX >= 0) or np.all(dX <= 0)):\n                             _api.warn_external(\n                                 f\"The input coordinates to {funcname} are \"\n", "test_patch": "diff --git a/lib/matplotlib/tests/test_axes.py b/lib/matplotlib/tests/test_axes.py\nindex 5bf5b5e19971..f2f74f845338 100644\n--- a/lib/matplotlib/tests/test_axes.py\n+++ b/lib/matplotlib/tests/test_axes.py\n@@ -1517,6 +1517,19 @@ def test_pcolorargs():\n         ax.pcolormesh(X, Y, Z, shading='auto')\n \n \n+def test_pcolormesh_underflow_error():\n+    \"\"\"\n+    Test that underflow errors don't crop up in pcolormesh.  Probably\n+    a numpy bug (https://github.com/numpy/numpy/issues/25810).\n+    \"\"\"\n+    with np.errstate(under=\"raise\"):\n+        x = np.arange(0, 3, 0.1)\n+        y = np.arange(0, 6, 0.1)\n+        z = np.random.randn(len(y), len(x))\n+        fig, ax = plt.subplots()\n+        ax.pcolormesh(x, y, z)\n+\n+\n def test_pcolorargs_with_read_only():\n     x = np.arange(6).reshape(2, 3)\n     xmask = np.broadcast_to([False, True, False], x.shape)  # read-only array\n", "problem_statement": "[Bug]: pcolormesh issue with np.seterr(under='raise')\n### Bug summary\n\nWhen `np.seterr(under=\"raise\")` is set, the pcolormesh fails.  Maybe this should be internally disabled?\n\n### Code for reproduction\n\n```python\nimport numpy as np\r\nimport matplotlib.pylab as plt\r\n\r\nca=array([0.5, 0.6, 0.7, 0.8, 0.9, 1. , 1.1, 1.2, 1.3, 1.4, 1.5, 1.6, 1.7,\r\n       1.8, 1.9, 2. ])\r\na3=array([0.75, 0.8 , 0.85, 0.9 , 0.95, 1.  , 1.05, 1.1 , 1.15, 1.2 , 1.25])\r\ndata=array([[1.2713495 , 1.27445031, 1.28460717, 1.29130818, 1.29799399,\r\n        1.28663907, 1.31302497, 1.300941  , 1.30953053, 1.28866943,\r\n        1.27942581],\r\n       [1.26072153, 1.34242149, 1.39931996, 1.36029362, 1.27837626,\r\n        1.26751629, 1.27348899, 1.29718153, 1.29149684, 1.29825976,\r\n        1.29844045],\r\n       [6.08656104, 1.30067448, 1.25214664, 1.26035875, 1.36715818,\r\n        1.32552442, 1.39957926, 1.26443228, 1.27086277, 1.27747337,\r\n        1.27804707],\r\n       [3.00639509, 3.71437317, 6.09823091, 5.08496857, 1.33917387,\r\n        1.275968  , 1.276208  , 5.85914639, 1.3672074 , 1.3054208 ,\r\n        1.29196619],\r\n       [1.40590936, 2.7645637 , 1.59388749, 3.00583827, 6.09541914,\r\n        6.10693772, 1.43934882, 1.4218234 , 1.24456015, 1.2583217 ,\r\n        4.73126518],\r\n       [1.51797233, 4.07758869, 1.35024387, 6.16087726, 6.16087726,\r\n        2.99797873, 1.4925019 , 6.15846305, 6.16087726, 6.17099357,\r\n        6.16087726],\r\n       [1.42225226, 6.20368688, 3.77458528, 1.63940466, 3.05123787,\r\n        1.4034648 , 2.78257648, 6.1955168 , 1.63842382, 3.01200839,\r\n        3.83237647],\r\n       [6.12860987, 1.52526702, 6.12860987, 3.4192525 , 1.66872783,\r\n        3.03455313, 1.32343997, 1.40334972, 2.73661128, 6.13119387,\r\n        1.60614133],\r\n       [2.91161999, 6.1955168 , 6.20368688, 1.56871188, 1.38913448,\r\n        6.21100954, 3.38222841, 2.95083762, 3.06491493, 6.20368688,\r\n        1.50694172],\r\n       [1.74007769, 2.92087855, 6.22356158, 6.23099418, 6.22356158,\r\n        1.53980699, 1.39476663, 6.22356158, 3.34994297, 1.57842062,\r\n        2.96292181],\r\n       [1.73497151, 1.7467381 , 2.92083986, 1.77700437, 6.20368688,\r\n        6.20368688, 1.68301207, 1.48597638, 1.38461998, 3.04317972,\r\n        3.42806827],\r\n       [1.71963249, 1.72142379, 1.73780007, 1.72713968, 2.92199405,\r\n        1.78053682, 6.14481403, 6.14481403, 1.55941905, 1.41043732,\r\n        6.14481403],\r\n       [2.91315155, 1.742551  , 1.72151811, 1.73169847, 1.7398712 ,\r\n        2.92240585, 2.91794373, 6.15232143, 6.14481403, 6.14481403,\r\n        1.54133219],\r\n       [6.14481403, 6.15232143, 2.92461883, 1.73502069, 1.7412515 ,\r\n        1.74323843, 2.92054641, 1.78489886, 1.75280085, 6.15232143,\r\n        6.14481403],\r\n       [6.27016475, 6.27016475, 6.27016475, 2.90887762, 2.9217294 ,\r\n        2.92487936, 2.92513504, 2.92124614, 2.91207688, 2.90331518,\r\n        2.86488642],\r\n       [6.17730685, 6.17730685, 6.18773682, 6.17730685, 2.92253426,\r\n        1.76412583, 1.76438894, 1.75630465, 1.76600374, 2.91196777,\r\n        2.90819997]])\r\n\r\nplt.pcolormesh(ca, a3, data.T)\n```\n\n\n### Actual outcome\n\n```\r\nIn [83]: plt.pcolormesh(ca, a3, data.T)\r\n---------------------------------------------------------------------------\r\nFloatingPointError                        Traceback (most recent call last)\r\nCell In[83], line 1\r\n----> 1 plt.pcolormesh(ca, a3, data.T)\r\n\r\nFile ~/Python/lib/python3.11/site-packages/matplotlib/pyplot.py:3478, in pcolormesh(alpha, norm, cmap, vmin, vmax, shading, antialiased, data, *args, **kwargs)\r\n   3465 @_copy_docstring_and_deprecators(Axes.pcolormesh)\r\n   3466 def pcolormesh(\r\n   3467     *args: ArrayLike,\r\n   (...)\r\n   3476     **kwargs,\r\n   3477 ) -> QuadMesh:\r\n-> 3478     __ret = gca().pcolormesh(\r\n   3479         *args,\r\n   3480         alpha=alpha,\r\n   3481         norm=norm,\r\n   3482         cmap=cmap,\r\n   3483         vmin=vmin,\r\n   3484         vmax=vmax,\r\n   3485         shading=shading,\r\n   3486         antialiased=antialiased,\r\n   3487         **({\"data\": data} if data is not None else {}),\r\n   3488         **kwargs,\r\n   3489     )\r\n   3490     sci(__ret)\r\n   3491     return __ret\r\n\r\nFile ~/Python/lib/python3.11/site-packages/matplotlib/__init__.py:1465, in _preprocess_data.<locals>.inner(ax, data, *args, **kwargs)\r\n   1462 @functools.wraps(func)\r\n   1463 def inner(ax, *args, data=None, **kwargs):\r\n   1464     if data is None:\r\n-> 1465         return func(ax, *map(sanitize_sequence, args), **kwargs)\r\n   1467     bound = new_sig.bind(ax, *args, **kwargs)\r\n   1468     auto_label = (bound.arguments.get(label_namer)\r\n   1469                   or bound.kwargs.get(label_namer))\r\n\r\nFile ~/Python/lib/python3.11/site-packages/matplotlib/axes/_axes.py:6289, in Axes.pcolormesh(self, alpha, norm, cmap, vmin, vmax, shading, antialiased, *args, **kwargs)\r\n   6286 shading = shading.lower()\r\n   6287 kwargs.setdefault('edgecolors', 'none')\r\n-> 6289 X, Y, C, shading = self._pcolorargs('pcolormesh', *args,\r\n   6290                                     shading=shading, kwargs=kwargs)\r\n   6291 coords = np.stack([X, Y], axis=-1)\r\n   6293 kwargs.setdefault('snap', mpl.rcParams['pcolormesh.snap'])\r\n\r\nFile ~/Python/lib/python3.11/site-packages/matplotlib/axes/_axes.py:5873, in Axes._pcolorargs(self, funcname, shading, *args, **kwargs)\r\n   5870     return X\r\n   5872 if ncols == Nx:\r\n-> 5873     X = _interp_grid(X)\r\n   5874     Y = _interp_grid(Y)\r\n   5875 if nrows == Ny:\r\n\r\nFile ~/Python/lib/python3.11/site-packages/matplotlib/axes/_axes.py:5852, in Axes._pcolorargs.<locals>._interp_grid(X)\r\n   5849 def _interp_grid(X):\r\n   5850     # helper for below\r\n   5851     if np.shape(X)[1] > 1:\r\n-> 5852         dX = np.diff(X, axis=1)/2.\r\n   5853         if not (np.all(dX >= 0) or np.all(dX <= 0)):\r\n   5854             _api.warn_external(\r\n   5855                 f\"The input coordinates to {funcname} are \"\r\n   5856                 \"interpreted as cell centers, but are not \"\r\n   (...)\r\n   5859                 \"edges, in which case, please supply \"\r\n   5860                 f\"explicit cell edges to {funcname}.\")\r\n\r\nFile ~/Python/lib/python3.11/site-packages/numpy/ma/core.py:4275, in MaskedArray.__truediv__(self, other)\r\n   4273 if self._delegate_binop(other):\r\n   4274     return NotImplemented\r\n-> 4275 return true_divide(self, other)\r\n\r\nFile ~/Python/lib/python3.11/site-packages/numpy/ma/core.py:1171, in _DomainedBinaryOperation.__call__(self, a, b, *args, **kwargs)\r\n   1169 domain = ufunc_domain.get(self.f, None)\r\n   1170 if domain is not None:\r\n-> 1171     m |= domain(da, db)\r\n   1172 # Take care of the scalar case first\r\n   1173 if not m.ndim:\r\n\r\nFile ~/Python/lib/python3.11/site-packages/numpy/ma/core.py:858, in _DomainSafeDivide.__call__(self, a, b)\r\n    856 a, b = np.asarray(a), np.asarray(b)\r\n    857 with np.errstate(invalid='ignore'):\r\n--> 858     return umath.absolute(a) * self.tolerance >= umath.absolute(b)\r\n\r\nFloatingPointError: underflow encountered in multiply\r\n\r\n```\n\n### Expected outcome\n\na plot\n\n### Additional information\n\nseems to be generic, but specific to this dataset\n\n### Operating system\n\nFedora 39\n\n### Matplotlib Version\n\n3.8.2\n\n### Matplotlib Backend\n\nGTK4Agg\n\n### Python version\n\n3.11.8 \n\n### Jupyter version\n\nIPython 8.21.0\n\n### Installation\n\npip\n", "hints_text": "This seems a bug upstream in numpy:\r\n\r\n```\r\nnp.seterr(under=\"raise\")\r\nx=np.arange(0, 3, 0.1)\r\ndX = np.diff(x)\r\nX = np.ma.array(x)\r\ndX = np.diff(X)\r\ndX = dX / 2.0\r\n```\r\nreturns\r\n\r\n```\r\nTraceback (most recent call last):\r\n  File \"/Users/jklymak/matplotlib/testit.py\", line 9, in <module>\r\n    dX = dX / 2.0\r\n         ~~~^~~~~\r\n  File \"/Users/jklymak/mambaforge/envs/mpl-dev/lib/python3.11/site-packages/numpy/ma/core.py\", line 4275, in __truediv__\r\n    return true_divide(self, other)\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/Users/jklymak/mambaforge/envs/mpl-dev/lib/python3.11/site-packages/numpy/ma/core.py\", line 1171, in __call__\r\n    m |= domain(da, db)\r\n         ^^^^^^^^^^^^^^\r\n  File \"/Users/jklymak/mambaforge/envs/mpl-dev/lib/python3.11/site-packages/numpy/ma/core.py\", line 858, in __call__\r\n    return umath.absolute(a) * self.tolerance >= umath.absolute(b)\r\n           ~~~~~~~~~~~~~~~~~~^~~~~~~~~~~~~~~~\r\nFloatingPointError: underflow encountered in multiply\r\n```\r\nNote that you need to divide by 2 to get the error.  \r\n\r\nA work around for us is to multiply by 0.5 instead.\r\n\r\n", "created_at": "2024-02-12T02:17:53Z"}
{"repo": "matplotlib/matplotlib", "pull_number": 27768, "instance_id": "matplotlib__matplotlib-27768", "issue_numbers": ["27745", "0000"], "base_commit": "d2cc4d0b0a2e1e9e8a5c1f311f0e10ef8acdb9ef", "patch": "diff --git a/doc/api/next_api_changes/deprecations/27768-REC.rst b/doc/api/next_api_changes/deprecations/27768-REC.rst\nnew file mode 100644\nindex 000000000000..357545a41efe\n--- /dev/null\n+++ b/doc/api/next_api_changes/deprecations/27768-REC.rst\n@@ -0,0 +1,5 @@\n+``[XYZ]Axis.draw``, ``*Image.draw`` *args* and *kwargs*...\n+~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n+\n+... are deprecated because they have no effect.  This will make the calling sequence\n+consistent with the ``draw`` method of other artists.\ndiff --git a/galleries/examples/misc/demo_ribbon_box.py b/galleries/examples/misc/demo_ribbon_box.py\nindex 6e79e6f9fde1..d5121ba6ff5c 100644\n--- a/galleries/examples/misc/demo_ribbon_box.py\n+++ b/galleries/examples/misc/demo_ribbon_box.py\n@@ -49,7 +49,7 @@ def __init__(self, ax, bbox, color, *, extent=(0, 1, 0, 1), **kwargs):\n         self._ribbonbox = RibbonBox(color)\n         self.set_transform(BboxTransformTo(bbox))\n \n-    def draw(self, renderer, *args, **kwargs):\n+    def draw(self, renderer):\n         stretch_factor = self._bbox.height / self._bbox.width\n \n         ny = int(stretch_factor*self._ribbonbox.nx)\n@@ -57,7 +57,7 @@ def draw(self, renderer, *args, **kwargs):\n             arr = self._ribbonbox.get_stretched_image(stretch_factor)\n             self.set_array(arr)\n \n-        super().draw(renderer, *args, **kwargs)\n+        super().draw(renderer)\n \n \n def main():\ndiff --git a/lib/matplotlib/axis.py b/lib/matplotlib/axis.py\nindex 9d478d30f77c..b4d2810b67b8 100644\n--- a/lib/matplotlib/axis.py\n+++ b/lib/matplotlib/axis.py\n@@ -1373,6 +1373,8 @@ def get_tick_padding(self):\n             values.append(self.minorTicks[0].get_tick_padding())\n         return max(values, default=0)\n \n+    @_api.delete_parameter('3.9', 'args')\n+    @_api.delete_parameter('3.9', 'kwargs')\n     @martist.allow_rasterization\n     def draw(self, renderer, *args, **kwargs):\n         # docstring inherited\ndiff --git a/lib/matplotlib/image.py b/lib/matplotlib/image.py\nindex e3269062699c..4673c6c4d529 100644\n--- a/lib/matplotlib/image.py\n+++ b/lib/matplotlib/image.py\n@@ -626,6 +626,8 @@ def _check_unsampled_image(self):\n         \"\"\"\n         return False\n \n+    @_api.delete_parameter('3.9', 'args')\n+    @_api.delete_parameter('3.9', 'kwargs')\n     @martist.allow_rasterization\n     def draw(self, renderer, *args, **kwargs):\n         # if not visible, declare victory and return\n", "test_patch": "diff --git a/tools/stubtest.py b/tools/stubtest.py\nindex 7c93d2dae157..77676595cbf8 100644\n--- a/tools/stubtest.py\n+++ b/tools/stubtest.py\n@@ -18,14 +18,33 @@ def __init__(self, filepath, output):\n         self.output = output\n \n     def visit_FunctionDef(self, node):\n-        if any(\"delete_parameter\" in ast.unparse(line) for line in node.decorator_list):\n-            parents = []\n-            if hasattr(node, \"parent\"):\n-                parent = node.parent\n-                while hasattr(parent, \"parent\") and not isinstance(parent, ast.Module):\n-                    parents.insert(0, parent.name)\n-                    parent = parent.parent\n-            self.output.write(f\"{'.'.join(self.context + parents)}.{node.name}\\n\")\n+        # delete_parameter adds a private sentinel value that leaks\n+        # we do not want that sentinel value in the type hints but it breaks typing\n+        # Does not apply to variadic arguments (args/kwargs)\n+        for dec in node.decorator_list:\n+            if \"delete_parameter\" in ast.unparse(dec):\n+                deprecated_arg = dec.args[1].value\n+                if (\n+                    node.args.vararg is not None\n+                    and node.args.vararg.arg == deprecated_arg\n+                ):\n+                    continue\n+                if (\n+                    node.args.kwarg is not None\n+                    and node.args.kwarg.arg == deprecated_arg\n+                ):\n+                    continue\n+\n+                parents = []\n+                if hasattr(node, \"parent\"):\n+                    parent = node.parent\n+                    while hasattr(parent, \"parent\") and not isinstance(\n+                        parent, ast.Module\n+                    ):\n+                        parents.insert(0, parent.name)\n+                        parent = parent.parent\n+                self.output.write(f\"{'.'.join(self.context + parents)}.{node.name}\\n\")\n+                break\n \n     def visit_ClassDef(self, node):\n         for dec in node.decorator_list:\n", "problem_statement": "[MNT]: `_ImageBase.draw` and `Axis.draw` args and kwargs\n### Summary\n\nThe `draw` methods of [_ImageBase](https://github.com/matplotlib/matplotlib/blob/525349b33bd40108f1f9f830323b3270f12dd72f/lib/matplotlib/image.py#L630) and [Axis](https://github.com/matplotlib/matplotlib/blob/525349b33bd40108f1f9f830323b3270f12dd72f/lib/matplotlib/axis.py#L1377) take `*args` and `**kwargs` but do not do anything with them.  The [Ribbon Box](https://matplotlib.org/stable/gallery/misc/demo_ribbon_box.html) example has an artist that inherits from `AxesImage` and also passes `*args` and `**kwargs` through `draw`.\n\n### Proposed fix\n\nBased on #16022 my guess is that `*args` and `**kwargs` should be removed from the signatures, though I don't know much about when and how `draw` gets called.  If they should be removed, do we need a deprecation period?\n", "hints_text": "This is internal API (it is called by the Aritsts parent as part of rendering the figure (the update methods in the GUIs and the `savefig` methods eventually create a `Renderer` instance and then call `Figure.draw(renderer)` which is turn uses the visitor pattern to pass the renderer to all of the (nested) children and the result is the accumulated state on the renderer (for Agg that is an RGBA buffer we can extract, for svg it is a file-like we have been streaming text into).). \r\n\r\nNo one should be calling this outside of the draw process so I don't think we need an deprecation period, but we should highlight it in the release notes (and be prepared to add a deprecation period if we actually broke somenone).\nThanks for the explanation @tacaswell!  I ended up here because I was looking at an artist in Cartopy whose `draw` method will update colors, etc. from `kwargs` if passed.  I couldn\u2019t think under what circumstances they would be passed so went grepping for other examples, but didn\u2019t get any less confused!\nIf we want to be on the very safe side, we can still do a deprecation. There's no hurry in removing the arguments.\nOnce you are down the path of writing your own `draw` methods you could have a class that calls subsequent classes and does pass something meaningful across the function call, but if downstream libraries are doing that, that is between them and themselves (so long as they do not _require_ the kwargs it matches our expectations and I see no reason we should care if they are optional).", "created_at": "2024-02-10T14:56:09Z"}
{"repo": "matplotlib/matplotlib", "pull_number": 27767, "instance_id": "matplotlib__matplotlib-27767", "issue_numbers": ["27762", "0000"], "base_commit": "4052a10fdfd34d08ae72ef078b6cc43b95b1c723", "patch": "diff --git a/doc/api/next_api_changes/behavior/27767-REC.rst b/doc/api/next_api_changes/behavior/27767-REC.rst\nnew file mode 100644\nindex 000000000000..f6b4dc156732\n--- /dev/null\n+++ b/doc/api/next_api_changes/behavior/27767-REC.rst\n@@ -0,0 +1,7 @@\n+Legend labels for ``plot``\n+~~~~~~~~~~~~~~~~~~~~~~~~~~\n+\n+Previously if a sequence was passed to the *label* parameter of `~.Axes.plot` when\n+plotting a single dataset, the sequence was automatically cast to string for the legend\n+label.  Now, if the sequence has only one element, that element will be the legend\n+label.  To keep the old behavior, cast the sequence to string before passing.\ndiff --git a/doc/api/next_api_changes/deprecations/27767-REC.rst b/doc/api/next_api_changes/deprecations/27767-REC.rst\nnew file mode 100644\nindex 000000000000..68781090df0a\n--- /dev/null\n+++ b/doc/api/next_api_changes/deprecations/27767-REC.rst\n@@ -0,0 +1,9 @@\n+Legend labels for ``plot``\n+~~~~~~~~~~~~~~~~~~~~~~~~~~\n+\n+Previously if a sequence was passed to the *label* parameter of `~.Axes.plot` when\n+plotting a single dataset, the sequence was automatically cast to string for the legend\n+label.  This behavior is now deprecated and in future will error if the sequence length\n+is not one (consistent with multi-dataset behavior, where the number of elements must\n+match the number of datasets).  To keep the old behavior, cast the sequence to string\n+before passing.\ndiff --git a/lib/matplotlib/axes/_base.py b/lib/matplotlib/axes/_base.py\nindex 51347f08b989..0617fc7681bd 100644\n--- a/lib/matplotlib/axes/_base.py\n+++ b/lib/matplotlib/axes/_base.py\n@@ -513,14 +513,22 @@ def _plot_args(self, axes, tup, kwargs, *,\n \n         label = kwargs.get('label')\n         n_datasets = max(ncx, ncy)\n-        if n_datasets > 1 and not cbook.is_scalar_or_string(label):\n-            if len(label) != n_datasets:\n-                raise ValueError(f\"label must be scalar or have the same \"\n-                                 f\"length as the input data, but found \"\n-                                 f\"{len(label)} for {n_datasets} datasets.\")\n+\n+        if cbook.is_scalar_or_string(label):\n+            labels = [label] * n_datasets\n+        elif len(label) == n_datasets:\n             labels = label\n+        elif n_datasets == 1:\n+            msg = (f'Passing label as a length {len(label)} sequence when '\n+                    'plotting a single dataset is deprecated in Matplotlib 3.9 '\n+                    'and will error in 3.11.  To keep the current behavior, '\n+                    'cast the sequence to string before passing.')\n+            _api.warn_deprecated('3.9', message=msg)\n+            labels = [label]\n         else:\n-            labels = [label] * n_datasets\n+            raise ValueError(\n+                f\"label must be scalar or have the same length as the input \"\n+                f\"data, but found {len(label)} for {n_datasets} datasets.\")\n \n         result = (make_artist(axes, x[:, j % ncx], y[:, j % ncy], kw,\n                               {**kwargs, 'label': label})\n", "test_patch": "diff --git a/lib/matplotlib/tests/test_legend.py b/lib/matplotlib/tests/test_legend.py\nindex b23649f22e48..73892698882c 100644\n--- a/lib/matplotlib/tests/test_legend.py\n+++ b/lib/matplotlib/tests/test_legend.py\n@@ -1197,12 +1197,20 @@ def test_plot_single_input_multiple_label(label_array):\n     x = [1, 2, 3]\n     y = [2, 5, 6]\n     fig, ax = plt.subplots()\n-    ax.plot(x, y, label=label_array)\n+    with pytest.warns(mpl.MatplotlibDeprecationWarning,\n+                      match='Passing label as a length 2 sequence'):\n+        ax.plot(x, y, label=label_array)\n     leg = ax.legend()\n     assert len(leg.get_texts()) == 1\n     assert leg.get_texts()[0].get_text() == str(label_array)\n \n \n+def test_plot_single_input_list_label():\n+    fig, ax = plt.subplots()\n+    line, = ax.plot([[0], [1]], label=['A'])\n+    assert line.get_label() == 'A'\n+\n+\n def test_plot_multiple_label_incorrect_length_exception():\n     # check that exception is raised if multiple labels\n     # are given, but number of on labels != number of lines\n", "problem_statement": "[Bug]: Inconsistent treatment of list of labels in `plot` when the input is a dataframe\n### Bug summary\n\n`plt.plot` interprets a dataframe as a sequence of series to be plotted, one per column. Labels can be specified by setting `label` to a list of labels matching the number of columns. If the dataframe has only one column, though, the `label` argument is interpreted as a single label, instead of a list with one element.\n\n### Code for reproduction\n\n```python\nfrom matplotlib import pyplot as plt\r\nimport pandas as pd\r\nimport numpy as np\r\n\r\nx = np.arange(5)\r\ny = pd.DataFrame({'a': x, 'b': x + 1})\r\n\r\nplt.figure('double', clear=True)\r\nplt.plot(x, y, label=['A', 'B'])\r\nplt.legend() # -> ok\r\n\r\nplt.figure('single', clear=True)\r\nplt.plot(x, y.drop('b', axis=1), label=['A'])\r\nplt.legend() # -> legend label is \"['A']\"\r\n\r\nplt.show()\n```\n\n\n### Actual outcome\n\n<img width=\"592\" alt=\"immagine\" src=\"https://github.com/matplotlib/matplotlib/assets/9684110/aa6abbcc-dd05-459b-b4ae-acb8a0d2e998\">\r\n\n\n### Expected outcome\n\n<img width=\"573\" alt=\"immagine\" src=\"https://github.com/matplotlib/matplotlib/assets/9684110/4dd88c38-216d-446b-a8d4-de70e299f39e\">\r\n\n\n### Additional information\n\n_No response_\n\n### Operating system\n\nmacOS 14.2.1\n\n### Matplotlib Version\n\n3.8.2\n\n### Matplotlib Backend\n\nMacOSX\n\n### Python version\n\n3.12.1 | packaged by conda-forge | (main, Dec 23 2023, 08:01:35) [Clang 16.0.6 ]\n\n### Jupyter version\n\n_No response_\n\n### Installation\n\nconda\n", "hints_text": "This isn't specific to dataframes.  The same behaviour can be seen with\r\n\r\n```python\r\nimport matplotlib.pyplot as plt\r\n\r\nfig, ax = plt.subplots()\r\nax.plot([[0, 0], [1, 2]], label=['A', 'B'])\r\nax.legend()\r\nplt.show()\r\n```\r\n![image](https://github.com/matplotlib/matplotlib/assets/10599679/b4d55fae-0762-4c77-a95a-a23de20985fa)\r\n\r\n```python\r\nfig, ax = plt.subplots()\r\nax.plot([[0], [1]], label=['A'])\r\nax.legend()\r\nplt.show()\r\n```\r\n![image](https://github.com/matplotlib/matplotlib/assets/10599679/8e93a686-fe41-431b-ae31-238b0ddff189)\nI'm not aware that we make any guarantees that one can pass a single-element list for single data. - I think the behavior is undefined in this case. For context, multiple label support was introduced in #16178.\r\n\r\nBut if we want to support this, that'd need to be handled here:\r\n\r\nhttps://github.com/matplotlib/matplotlib/blob/d2cc4d0b0a2e1e9e8a5c1f311f0e10ef8acdb9ef/lib/matplotlib/axes/_base.py#L522-L523\r\n\nI tried poking the code that @timhoffm highlighted, but it seems the current behaviour is very much expected:\r\n\r\nhttps://github.com/matplotlib/matplotlib/blob/d2cc4d0b0a2e1e9e8a5c1f311f0e10ef8acdb9ef/lib/matplotlib/tests/test_legend.py#L1191-L1203\nI think the current behavior is like if `np.array([1])` yielded a 0-d array. It breaks agnostic coding patterns that do not depend on the length of things.\n> I tried poking the code that @timhoffm highlighted, but it seems the current behaviour is very much expected:\r\n\r\nMy vague recollection is that #16178 should only affect the multiple-data case. Changes to the single-data case were out of scope. I believe, the test is just ensurging the single-data case is kept as is; i.e. anything passed to `label` is converted using `str`. So in a way, this behavior is expected as the de-facto behavior, but I would not claim it's necessarily intended.\r\n\r\nWe have a generalization ambiguity problem. We cannot have both:\r\n1. For single data, convert any label object to str.\r\n2. For N data, support a list of labels of length N.\r\n\r\nWhile I see the motivation for 2 with the N=1 case, supporting that would mean to break 1. We certainly have to go through a deprecation period with this. And we'd have to consider how to handle the case one dataset, but >1 labels (as in the test). I think, if one dataset, length-1 label list gives the one element as label, the >1 labels case should error out and not create the str anymore.\r\n\r\nI'd fundamentally support the idea of not converting iterables to str anymore - if anybody wants to take on the deprecation effort.\n> I'd fundamentally support the idea of not converting iterables to str anymore - if anybody wants to take on the deprecation effort.\r\n\r\nI think we should do this - I can't think of a situation where a user would want the result above, and if for some weird reason they do, they can convert to a single string themselves.  I think the current behaviour is undesirable enough that I'm not even sure we need a full deprecation cycle for it?\nI would bet that there are people who for some reason have a list as identifier for their dataset and they don't care enough to format that explicitly (`['A', 'B']` in the legend was good enough for them). Therefore, I advocate for a regular deprecation.\nSo what should happen for the single element list during the deprecation period?  Can we implement new behaviour for that right away?", "created_at": "2024-02-10T14:10:30Z"}
{"repo": "matplotlib/matplotlib", "pull_number": 27756, "instance_id": "matplotlib__matplotlib-27756", "issue_numbers": ["27753", "0000"], "base_commit": "c2aa4ee1177452dc778813e3034c3f57d7db83d8", "patch": "diff --git a/lib/matplotlib/bezier.py b/lib/matplotlib/bezier.py\nindex f310f287e2c0..069e20d05916 100644\n--- a/lib/matplotlib/bezier.py\n+++ b/lib/matplotlib/bezier.py\n@@ -171,9 +171,17 @@ def find_bezier_t_intersecting_with_closedpath(\n \n         if start_inside ^ middle_inside:\n             t1 = middle_t\n+            if end == middle:\n+                # Edge case where infinite loop is possible\n+                # Caused by large numbers relative to tolerance\n+                return t0, t1\n             end = middle\n         else:\n             t0 = middle_t\n+            if start == middle:\n+                # Edge case where infinite loop is possible\n+                # Caused by large numbers relative to tolerance\n+                return t0, t1\n             start = middle\n             start_inside = middle_inside\n \n", "test_patch": "diff --git a/lib/matplotlib/tests/test_bezier.py b/lib/matplotlib/tests/test_bezier.py\nnew file mode 100644\nindex 000000000000..65e2c616e738\n--- /dev/null\n+++ b/lib/matplotlib/tests/test_bezier.py\n@@ -0,0 +1,17 @@\n+\"\"\"\n+Tests specific to the bezier module.\n+\"\"\"\n+\n+from matplotlib.bezier import inside_circle, split_bezier_intersecting_with_closedpath\n+\n+\n+def test_split_bezier_with_large_values():\n+    # These numbers come from gh-27753\n+    arrow_path = [(96950809781500.0, 804.7503795623779),\n+                  (96950809781500.0, 859.6242585800646),\n+                  (96950809781500.0, 914.4981375977513)]\n+    in_f = inside_circle(96950809781500.0, 804.7503795623779, 0.06)\n+    split_bezier_intersecting_with_closedpath(arrow_path, in_f)\n+    # All we are testing is that this completes\n+    # The failure case is an infinite loop resulting from floating point precision\n+    # pytest will timeout if that occurs\n", "problem_statement": "[Bug]:  `split_bezier_intersecting_with_closedpath` fails to return\n### Bug summary\n\nIt looks like, for some inputs, `split_bezier_intersecting_with_closedpath`  never returns, as the `while True:` loop inside `find_bezier_t_intersecting_with_closedpath` fails to converge.\n\n### Code for reproduction\n\n```python\nfrom matplotlib.patches import inside_circle, split_bezier_intersecting_with_closedpath\r\n\r\narrow_path = [(96950809781500.0, 804.7503795623779), (96950809781500.0, 859.6242585800646), (96950809781500.0, 914.4981375977513)]\r\nin_f = inside_circle(96950809781500.0, 804.7503795623779, 0.06)\r\nsplit_bezier_intersecting_with_closedpath(arrow_path, in_f)\n```\n\n\n### Actual outcome\n\nThe call to `split_bezier_intersecting_with_closedpath` never returns.\n\n### Expected outcome\n\nThe call to `split_bezier_intersecting_with_closedpath` should return the split segment.\n\n### Additional information\n\n_No response_\n\n### Operating system\n\nconfirmed on Arch and Ubuntu 22.04 LTS\n\n### Matplotlib Version\n\n3.8.2\n\n### Matplotlib Backend\n\nagg\n\n### Python version\n\n3.11.6 (Arch) and 3.10.12 (Ubuntu)\n\n### Jupyter version\n\n4.0.11  (note: reproducible outside jupyter)\n\n### Installation\n\nNone\n", "hints_text": "I'm not sure there is a whole lot we can do here... this ultimately just comes down to floating point precision being asked to compare a tolerance that is smaller than it can actually distinguish at the scale of the numbers you are working with.\r\n\r\nThe default tolerance is 0.01 and the `np.spacing` on the largest of the numbers you are working with is `0.015625`... Thus it is impossible (or at least within rounding modes on the least significant bit of the floating point calculation) to be better than the tolerance requested, but it is not within tolerance, so it doesn't stop.\r\n\r\nIncreasing the tolerance (the third parameter to the `split_bezier_intersecting_with_closedpath` function) will help, but note you are still at the edges of floating point precision with some of these, so be a little careful. This particular example I was able to get to converge with a tolerance of `0.014`, though I would be weary of anything that is below at least about 4x `np.spacing` of your largest values (maybe even 10x, honestly)\r\n\r\nI'm inclined to close this as \"won't fix\" since the only real alternative would be to detect stable cycles (this one was just repeating the same values, so maybe just looking for repeated consecutive values would be enough) and either error, or warn and return the closest values... But neither of those options seem great and it introduces some complexity only for some pretty rare edge cases. Though I will give other maintainers the opportunity to weigh in before actually closing.\r\n\r\nRegardless, the tools exist to allow you to get what you want (i.e. specifying a larger tolerance)q\r\n\r\nI could also see an argument for scaling the default `tolerance` to the magnitude of the values given, I suppose, as 0.01 is not a good value for really large (as here) or really small coordinate values (where it will terminate potentially too _early_ instead). But that would be a behavior change that may even need to go through deprecation cycles.\n> Increasing the tolerance (the third parameter to the split_bezier_intersecting_with_closedpath function) \r\n\r\nThis is actually  happening inside `ax.add_patch(arrow)` (where `arrow` is a `FancyArrowPatch`) , and I'm not specifying the tolerances directly (not sure at this stage where they comeform).  Can I somehow define the tolenrance for the `FancyArrowPatch` or the axes, or a somesort of global `matplotlib` config?\r\n\r\n\r\n> I'm not sure there is a whole lot we can do here... this ultimately just comes down to floating point precision being asked to compare a tolerance that is smaller than it can actually distinguish at the scale of the numbers you are working with.\r\n\r\nIs this something that can be detected and adjusted/raised as an error  auotmatically by checking the values?  Or alternatively, is this something I can guard against when creating the `FancyArrowPatch`?\r\n", "created_at": "2024-02-07T22:10:03Z"}
{"repo": "matplotlib/matplotlib", "pull_number": 27754, "instance_id": "matplotlib__matplotlib-27754", "issue_numbers": ["11759", "0000"], "base_commit": "c2aa4ee1177452dc778813e3034c3f57d7db83d8", "patch": "diff --git a/lib/mpl_toolkits/mplot3d/axes3d.py b/lib/mpl_toolkits/mplot3d/axes3d.py\nindex 4d8c7e6b8e84..74348d17730d 100644\n--- a/lib/mpl_toolkits/mplot3d/axes3d.py\n+++ b/lib/mpl_toolkits/mplot3d/axes3d.py\n@@ -2984,15 +2984,10 @@ def calc_arrows(UVW):\n         UVW = np.column_stack(input_args[3:]).astype(float)\n \n         # Normalize rows of UVW\n-        norm = np.linalg.norm(UVW, axis=1)\n-\n-        # If any row of UVW is all zeros, don't make a quiver for it\n-        mask = norm > 0\n-        XYZ = XYZ[mask]\n         if normalize:\n-            UVW = UVW[mask] / norm[mask].reshape((-1, 1))\n-        else:\n-            UVW = UVW[mask]\n+            norm = np.linalg.norm(UVW, axis=1)\n+            norm[norm == 0] = 1\n+            UVW = UVW / norm.reshape((-1, 1))\n \n         if len(XYZ) > 0:\n             # compute the shaft lines all at once with an outer product\n@@ -3006,7 +3001,7 @@ def calc_arrows(UVW):\n             # transpose to get a list of lines\n             heads = heads.swapaxes(0, 1)\n \n-            lines = [*shafts, *heads]\n+            lines = [*shafts, *heads[::2], *heads[1::2]]\n         else:\n             lines = []\n \n", "test_patch": "diff --git a/lib/mpl_toolkits/mplot3d/tests/baseline_images/test_axes3d/quiver3d_colorcoded.png b/lib/mpl_toolkits/mplot3d/tests/baseline_images/test_axes3d/quiver3d_colorcoded.png\nnew file mode 100644\nindex 000000000000..09b27c306c61\nBinary files /dev/null and b/lib/mpl_toolkits/mplot3d/tests/baseline_images/test_axes3d/quiver3d_colorcoded.png differ\ndiff --git a/lib/mpl_toolkits/mplot3d/tests/test_axes3d.py b/lib/mpl_toolkits/mplot3d/tests/test_axes3d.py\nindex 1c6bbdd91670..2b7bfc117f88 100644\n--- a/lib/mpl_toolkits/mplot3d/tests/test_axes3d.py\n+++ b/lib/mpl_toolkits/mplot3d/tests/test_axes3d.py\n@@ -836,7 +836,8 @@ def test_mixedsamplesraises():\n         ax.plot_surface(X, Y, Z, cstride=50, rcount=10)\n \n \n-@mpl3d_image_comparison(['quiver3d.png'], style='mpl20')\n+# remove tolerance when regenerating the test image\n+@mpl3d_image_comparison(['quiver3d.png'], style='mpl20', tol=0.003)\n def test_quiver3d():\n     plt.rcParams['axes3d.automargin'] = True  # Remove when image is regenerated\n     fig = plt.figure()\n@@ -884,6 +885,19 @@ def test_quiver3d_masked():\n     ax.quiver(x, y, z, u, v, w, length=0.1, pivot='tip', normalize=True)\n \n \n+@mpl3d_image_comparison(['quiver3d_colorcoded.png'], style='mpl20')\n+def test_quiver3d_colorcoded():\n+    fig = plt.figure()\n+    ax = fig.add_subplot(projection='3d')\n+\n+    x = y = dx = dz = np.zeros(10)\n+    z = dy = np.arange(10.)\n+\n+    color = plt.cm.Reds(dy/dy.max())\n+    ax.quiver(x, y, z, dx, dy, dz, colors=color)\n+    ax.set_ylim(0, 10)\n+\n+\n def test_patch_modification():\n     fig = plt.figure()\n     ax = fig.add_subplot(projection=\"3d\")\n@@ -1555,7 +1569,8 @@ def test_minor_ticks():\n     ax.set_zticklabels([\"half\"], minor=True)\n \n \n-@mpl3d_image_comparison(['errorbar3d_errorevery.png'], style='mpl20')\n+# remove tolerance when regenerating the test image\n+@mpl3d_image_comparison(['errorbar3d_errorevery.png'], style='mpl20', tol=0.003)\n def test_errorbar3d_errorevery():\n     \"\"\"Tests errorevery functionality for 3D errorbars.\"\"\"\n     t = np.arange(0, 2*np.pi+.1, 0.01)\n", "problem_statement": "The color of the 3D arrow head does not match that of the arrow body\n<!--To help us understand and resolve your issue, please fill out the form to the best of your ability.-->\r\n<!--You can feel free to delete the sections that do not apply.-->\r\n\r\n### Bug report\r\n\r\n**Bug summary**\r\n\r\nThe color of the 3D arrow head does not match that of the arrow body. (In fact, the two segments of head itself don't even match.)\r\n\r\nNot sure if it is related to #11746, so I posted it separately just to make things clearer.\r\n<!--A short 1-2 sentences that succinctly describes the bug-->\r\n\r\n**Code for reproduction**\r\n\r\n<!--A minimum code snippet required to reproduce the bug, also minimizing the number of dependencies required-->\r\n\r\n```python\r\nimport numpy as np\r\nimport matplotlib.pyplot as plt\r\nfrom mpl_toolkits.mplot3d import Axes3D\r\n\r\nx = np.zeros(10)\r\ny = np.zeros(10)\r\nz = np.arange(10.)\r\ndx = np.zeros(10)\r\ndy = np.arange(10.)\r\ndz = np.zeros(10)\r\n\r\nax = plt.figure().add_subplot(projection='3d')\r\n\r\narrow_color = plt.cm.Reds(dy/dy.max())\r\n\r\nax.quiver(x, y, z, dx, dy, dz, colors=arrow_color)\r\nax.set_ylim(0,10)\r\nplt.show()\r\n```\r\n\r\n**Actual outcome**\r\n\r\n<!--The output produced by the above code, which may be a screenshot, console output, etc.-->\r\n![test_arrow_head_color](https://user-images.githubusercontent.com/3490251/43104856-ae975e88-8e87-11e8-827f-5d7e7ae07c14.png)\r\n\r\n**Expected outcome**\r\n\r\n<!--A description of the expected outcome from the code snippet-->\r\n<!--If this used to work in an earlier version of Matplotlib, please note the version it used to work on-->\r\n\r\nThe entire arrow should have a single color.\r\n\r\n**Matplotlib version**\r\n<!--Please specify your platform and versions of the relevant libraries you are using:-->\r\n  * Operating system: macOS 10.13.6\r\n  * Matplotlib version: 2.2.2\r\n  * Matplotlib backend (`print(matplotlib.get_backend())`): MacOSX\r\n  * Python version: 2.7.15\r\n  * Jupyter version (if applicable): 5.6.0\r\n  * Other libraries: \r\n\r\n<!--Please tell us how you installed matplotlib and python e.g., from source, pip, conda-->\r\n<!--If you installed from conda, please specify which channel you used if not the default-->\r\n\r\nmatplotlib and Python were installed with Anaconda.\n", "hints_text": "This issue has been marked \"inactive\" because it has been 365 days since the last comment. If this issue is still present in recent Matplotlib releases, or the feature request is still wanted, please leave a comment and this label will be removed. If there are no updates in another 30 days, this issue will be automatically closed, but you are free to re-open or create a new issue if needed. We value issue reports, and this procedure is meant to help us resurface and prioritize issues that have not been addressed yet, not make them disappear.  Thanks for your help!", "created_at": "2024-02-07T20:29:34Z"}
{"repo": "matplotlib/matplotlib", "pull_number": 27692, "instance_id": "matplotlib__matplotlib-27692", "issue_numbers": ["14217", "0000"], "base_commit": "ff0497cc042332313afd3d2e9ba8f949c3857896", "patch": "diff --git a/doc/users/next_whats_new/update_arrow_patch.rst b/doc/users/next_whats_new/update_arrow_patch.rst\nnew file mode 100644\nindex 000000000000..894090587b5d\n--- /dev/null\n+++ b/doc/users/next_whats_new/update_arrow_patch.rst\n@@ -0,0 +1,30 @@\n+Update the position of arrow patch\n+~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n+Adds a setter method that allows the user to update the position of the\n+`.patches.Arrow` object without requiring a full re-draw.\n+\n+.. plot::\n+    :include-source: true\n+    :alt: Example of changing the position of the arrow with the new ``set_data`` method.\n+\n+    import matplotlib as mpl\n+    import matplotlib.pyplot as plt\n+    from matplotlib.patches import Arrow\n+    import matplotlib.animation as animation\n+\n+    fig, ax = plt.subplots()\n+    ax.set_xlim(0, 10)\n+    ax.set_ylim(0, 10)\n+\n+    a = mpl.patches.Arrow(2, 0, 0, 10)\n+    ax.add_patch(a)\n+\n+\n+    # code for modifying the arrow\n+    def update(i):\n+        a.set_data(x=.5, dx=i, dy=6, width=2)\n+\n+\n+    ani = animation.FuncAnimation(fig, update, frames=15, interval=90, blit=False)\n+\n+    plt.show()\ndiff --git a/lib/matplotlib/patches.py b/lib/matplotlib/patches.py\nindex ef52a00b059b..fc9d2c88897d 100644\n--- a/lib/matplotlib/patches.py\n+++ b/lib/matplotlib/patches.py\n@@ -1297,12 +1297,7 @@ def __init__(self, x, y, dx, dy, *, width=1.0, **kwargs):\n             properties.\n         \"\"\"\n         super().__init__(**kwargs)\n-        self._patch_transform = (\n-            transforms.Affine2D()\n-            .scale(np.hypot(dx, dy), width)\n-            .rotate(np.arctan2(dy, dx))\n-            .translate(x, y)\n-            .frozen())\n+        self.set_data(x, y, dx, dy, width)\n \n     def get_path(self):\n         return self._path\n@@ -1310,6 +1305,39 @@ def get_path(self):\n     def get_patch_transform(self):\n         return self._patch_transform\n \n+    def set_data(self, x=None, y=None, dx=None, dy=None, width=None):\n+        \"\"\"\n+        Set `.Arrow` x, y, dx, dy and width.\n+        Values left as None will not be updated.\n+\n+        Parameters\n+        ----------\n+        x, y : float or None, default: None\n+            The x and y coordinates of the arrow base.\n+\n+        dx, dy : float or None, default: None\n+            The length of the arrow along x and y direction.\n+\n+        width : float or None, default: None\n+            Width of full arrow tail.\n+        \"\"\"\n+        if x is not None:\n+            self._x = x\n+        if y is not None:\n+            self._y = y\n+        if dx is not None:\n+            self._dx = dx\n+        if dy is not None:\n+            self._dy = dy\n+        if width is not None:\n+            self._width = width\n+        self._patch_transform = (\n+            transforms.Affine2D()\n+            .scale(np.hypot(self._dx, self._dy), self._width)\n+            .rotate(np.arctan2(self._dy, self._dx))\n+            .translate(self._x, self._y)\n+            .frozen())\n+\n \n class FancyArrow(Polygon):\n     \"\"\"\ndiff --git a/lib/matplotlib/patches.pyi b/lib/matplotlib/patches.pyi\nindex 287ea0f738ab..f6c9ddf75839 100644\n--- a/lib/matplotlib/patches.pyi\n+++ b/lib/matplotlib/patches.pyi\n@@ -181,7 +181,14 @@ class Arrow(Patch):\n     def __init__(\n         self, x: float, y: float, dx: float, dy: float, *, width: float = ..., **kwargs\n     ) -> None: ...\n-\n+    def set_data(\n+        self,\n+        x: float | None = ...,\n+        y: float | None = ...,\n+        dx: float | None = ...,\n+        dy: float | None = ...,\n+        width: float | None = ...,\n+    ) -> None: ...\n class FancyArrow(Polygon):\n     def __init__(\n         self,\n", "test_patch": "diff --git a/lib/matplotlib/tests/test_patches.py b/lib/matplotlib/tests/test_patches.py\nindex b1af0abbc573..9530bcd19130 100644\n--- a/lib/matplotlib/tests/test_patches.py\n+++ b/lib/matplotlib/tests/test_patches.py\n@@ -931,3 +931,32 @@ def test_modifying_arc(fig_test, fig_ref):\n     fig_test.subplots().add_patch(arc2)\n     arc2.set_width(.5)\n     arc2.set_angle(20)\n+\n+\n+def test_arrow_set_data():\n+    fig, ax = plt.subplots()\n+    arrow = mpl.patches.Arrow(2, 0, 0, 10)\n+    expected1 = np.array(\n+       [[1.9,  0.],\n+        [2.1, -0.],\n+        [2.1, 8.],\n+        [2.3, 8.],\n+        [2., 10.],\n+        [1.7, 8.],\n+        [1.9, 8.],\n+        [1.9, 0.]]\n+    )\n+    assert np.allclose(expected1, np.round(arrow.get_verts(), 2))\n+\n+    expected2 = np.array(\n+        [[0.39, 0.04],\n+         [0.61, -0.04],\n+         [3.01, 6.36],\n+         [3.24, 6.27],\n+         [3.5, 8.],\n+         [2.56, 6.53],\n+         [2.79, 6.44],\n+         [0.39, 0.04]]\n+    )\n+    arrow.set_data(x=.5, dx=3, dy=8, width=1.2)\n+    assert np.allclose(expected2, np.round(arrow.get_verts(), 2))\n", "problem_statement": "[Feature request] Add a way to update the position of the Arrow patch.\nHi,\r\n\r\nCurrently, the `arrow` class doesn't let you update the coordinates after creating the patch. That is, one **must** remove the old patch and create a new one just to move the arrows. This seems fairly inefficient.\r\n\r\nWould it be possible to add some setter methods to let one change the arrow position and size without recreating a new one?\r\n\r\nThe motivation for this is that removing and adding a new patch requires a full re-draw (afaik) which is slow.\r\n\r\nThanks!\r\n\r\n**Matplotlib version**\r\n<!--Please specify your platform and versions of the relevant libraries you are using:-->\r\n  * Operating system: Windows 10\r\n  * Matplotlib version: 3.0.3\r\n  * Matplotlib backend (`print(matplotlib.get_backend())`): qt5agg\r\n  * Python version: 3.7\r\n\n", "hints_text": "### What needs  to be done:\r\n\r\n- The `_path` of the `Arrow` itself is stored in normalized coordinates and not modified.\r\n- Positioning is performed by the `_patch_transform`. This has to be recreated when chaning the position.\r\n- It's probably best to store `x, y, dx, dy, width` in private variables so that they can be reused for recreating the transform.\r\n\r\nThis can be used as an example to start with:\r\n\r\n~~~\r\nimport matplotlib.pyplot as plt\r\nfrom matplotlib.patches import Arrow\r\n\r\nfig, ax = plt.subplots()\r\nax.plot([0, 4], [10, 0])\r\n\r\na = Arrow(2, 0, 0, 10)\r\nax.add_patch(a)\r\n\r\n# code for modifing the arrow goes here.\r\n\r\nplt.show()\r\n~~~\nGiven that the transform needs to be recreated, I would not expect updating to be any faster than removing and recreating the arrow.  \r\nPossibly, making the `FancyArrowPatch` more user-friendly could be of higher priority.\nIt seems indeed, that the use of `Arrow` should be discouraged or even deprecated, because it suffers from the transform distorting it. This is essentially never desired.\nThis issue has been marked \"inactive\" because it has been 365 days since the last comment. If this issue is still present in recent Matplotlib releases, or the feature request is still wanted, please leave a comment and this label will be removed. If there are no updates in another 30 days, this issue will be automatically closed, but you are free to re-open or create a new issue if needed. We value issue reports, and this procedure is meant to help us resurface and prioritize issues that have not been addressed yet, not make them disappear.  Thanks for your help!\nProbably still relevant ", "created_at": "2024-01-24T09:14:57Z"}
{"repo": "matplotlib/matplotlib", "pull_number": 27657, "instance_id": "matplotlib__matplotlib-27657", "issue_numbers": ["27645", "0000"], "base_commit": "c447b60486e196fd4c76d72c848a22662fbed0e4", "patch": "diff --git a/lib/matplotlib/pylab.py b/lib/matplotlib/pylab.py\nindex 77eb6506d87f..a50779cf6d26 100644\n--- a/lib/matplotlib/pylab.py\n+++ b/lib/matplotlib/pylab.py\n@@ -60,6 +60,8 @@\n bytes = __import__(\"builtins\").bytes\n # We also don't want the numpy version of these functions\n abs = __import__(\"builtins\").abs\n+bool = __import__(\"builtins\").bool\n max = __import__(\"builtins\").max\n min = __import__(\"builtins\").min\n+pow = __import__(\"builtins\").pow\n round = __import__(\"builtins\").round\n", "test_patch": "diff --git a/lib/matplotlib/tests/test_axes.py b/lib/matplotlib/tests/test_axes.py\nindex 5cafcdb5d2e9..530fddf127a8 100644\n--- a/lib/matplotlib/tests/test_axes.py\n+++ b/lib/matplotlib/tests/test_axes.py\n@@ -5743,7 +5743,12 @@ def test_text_labelsize():\n     ax.tick_params(direction='out')\n \n \n-@image_comparison(['pie_default.png'])\n+# Note: The `pie` image tests were affected by Numpy 2.0 changing promotions\n+# (NEP 50). While the changes were only marginal, tolerances were introduced.\n+# These tolerances could likely go away when numpy 2.0 is the minimum supported\n+# numpy and the images are regenerated.\n+\n+@image_comparison(['pie_default.png'], tol=0.01)\n def test_pie_default():\n     # The slices will be ordered and plotted counter-clockwise.\n     labels = 'Frogs', 'Hogs', 'Dogs', 'Logs'\n@@ -5756,7 +5761,7 @@ def test_pie_default():\n \n \n @image_comparison(['pie_linewidth_0', 'pie_linewidth_0', 'pie_linewidth_0'],\n-                  extensions=['png'], style='mpl20')\n+                  extensions=['png'], style='mpl20', tol=0.01)\n def test_pie_linewidth_0():\n     # The slices will be ordered and plotted counter-clockwise.\n     labels = 'Frogs', 'Hogs', 'Dogs', 'Logs'\n@@ -5788,7 +5793,7 @@ def test_pie_linewidth_0():\n     plt.axis('equal')\n \n \n-@image_comparison(['pie_center_radius.png'], style='mpl20')\n+@image_comparison(['pie_center_radius.png'], style='mpl20', tol=0.005)\n def test_pie_center_radius():\n     # The slices will be ordered and plotted counter-clockwise.\n     labels = 'Frogs', 'Hogs', 'Dogs', 'Logs'\n@@ -5808,7 +5813,7 @@ def test_pie_center_radius():\n     plt.axis('equal')\n \n \n-@image_comparison(['pie_linewidth_2.png'], style='mpl20')\n+@image_comparison(['pie_linewidth_2.png'], style='mpl20', tol=0.01)\n def test_pie_linewidth_2():\n     # The slices will be ordered and plotted counter-clockwise.\n     labels = 'Frogs', 'Hogs', 'Dogs', 'Logs'\n@@ -5823,7 +5828,7 @@ def test_pie_linewidth_2():\n     plt.axis('equal')\n \n \n-@image_comparison(['pie_ccw_true.png'], style='mpl20')\n+@image_comparison(['pie_ccw_true.png'], style='mpl20', tol=0.01)\n def test_pie_ccw_true():\n     # The slices will be ordered and plotted counter-clockwise.\n     labels = 'Frogs', 'Hogs', 'Dogs', 'Logs'\n@@ -5838,7 +5843,7 @@ def test_pie_ccw_true():\n     plt.axis('equal')\n \n \n-@image_comparison(['pie_frame_grid.png'], style='mpl20')\n+@image_comparison(['pie_frame_grid.png'], style='mpl20', tol=0.002)\n def test_pie_frame_grid():\n     # The slices will be ordered and plotted counter-clockwise.\n     labels = 'Frogs', 'Hogs', 'Dogs', 'Logs'\n@@ -5865,7 +5870,7 @@ def test_pie_frame_grid():\n     plt.axis('equal')\n \n \n-@image_comparison(['pie_rotatelabels_true.png'], style='mpl20')\n+@image_comparison(['pie_rotatelabels_true.png'], style='mpl20', tol=0.009)\n def test_pie_rotatelabels_true():\n     # The slices will be ordered and plotted counter-clockwise.\n     labels = 'Hogwarts', 'Frogs', 'Dogs', 'Logs'\n@@ -5880,7 +5885,7 @@ def test_pie_rotatelabels_true():\n     plt.axis('equal')\n \n \n-@image_comparison(['pie_no_label.png'])\n+@image_comparison(['pie_no_label.png'], tol=0.01)\n def test_pie_nolabel_but_legend():\n     labels = 'Frogs', 'Hogs', 'Dogs', 'Logs'\n     sizes = [15, 30, 45, 10]\n@@ -5894,7 +5899,7 @@ def test_pie_nolabel_but_legend():\n     plt.legend()\n \n \n-@image_comparison(['pie_shadow.png'], style='mpl20')\n+@image_comparison(['pie_shadow.png'], style='mpl20', tol=0.002)\n def test_pie_shadow():\n     # Also acts as a test for the shade argument of Shadow\n     sizes = [15, 30, 45, 10]\ndiff --git a/lib/matplotlib/tests/test_colors.py b/lib/matplotlib/tests/test_colors.py\nindex d77077340e8c..30cd5dfa844b 100644\n--- a/lib/matplotlib/tests/test_colors.py\n+++ b/lib/matplotlib/tests/test_colors.py\n@@ -1379,38 +1379,38 @@ def test_scalarmappable_to_rgba(bytes):\n     # uint8 RGBA\n     x = np.ones((2, 3, 4), dtype=np.uint8)\n     expected = x.copy() if bytes else x.astype(np.float32)/255\n-    np.testing.assert_array_equal(sm.to_rgba(x, bytes=bytes), expected)\n+    np.testing.assert_almost_equal(sm.to_rgba(x, bytes=bytes), expected)\n     # uint8 RGB\n     expected[..., 3] = alpha_1\n-    np.testing.assert_array_equal(sm.to_rgba(x[..., :3], bytes=bytes), expected)\n+    np.testing.assert_almost_equal(sm.to_rgba(x[..., :3], bytes=bytes), expected)\n     # uint8 masked RGBA\n     xm = np.ma.masked_array(x, mask=np.zeros_like(x))\n     xm.mask[0, 0, 0] = True\n     expected = x.copy() if bytes else x.astype(np.float32)/255\n     expected[0, 0, 3] = 0\n-    np.testing.assert_array_equal(sm.to_rgba(xm, bytes=bytes), expected)\n+    np.testing.assert_almost_equal(sm.to_rgba(xm, bytes=bytes), expected)\n     # uint8 masked RGB\n     expected[..., 3] = alpha_1\n     expected[0, 0, 3] = 0\n-    np.testing.assert_array_equal(sm.to_rgba(xm[..., :3], bytes=bytes), expected)\n+    np.testing.assert_almost_equal(sm.to_rgba(xm[..., :3], bytes=bytes), expected)\n \n     # float RGBA\n     x = np.ones((2, 3, 4), dtype=float) * 0.5\n     expected = (x * 255).astype(np.uint8) if bytes else x.copy()\n-    np.testing.assert_array_equal(sm.to_rgba(x, bytes=bytes), expected)\n+    np.testing.assert_almost_equal(sm.to_rgba(x, bytes=bytes), expected)\n     # float RGB\n     expected[..., 3] = alpha_1\n-    np.testing.assert_array_equal(sm.to_rgba(x[..., :3], bytes=bytes), expected)\n+    np.testing.assert_almost_equal(sm.to_rgba(x[..., :3], bytes=bytes), expected)\n     # float masked RGBA\n     xm = np.ma.masked_array(x, mask=np.zeros_like(x))\n     xm.mask[0, 0, 0] = True\n     expected = (x * 255).astype(np.uint8) if bytes else x.copy()\n     expected[0, 0, 3] = 0\n-    np.testing.assert_array_equal(sm.to_rgba(xm, bytes=bytes), expected)\n+    np.testing.assert_almost_equal(sm.to_rgba(xm, bytes=bytes), expected)\n     # float masked RGB\n     expected[..., 3] = alpha_1\n     expected[0, 0, 3] = 0\n-    np.testing.assert_array_equal(sm.to_rgba(xm[..., :3], bytes=bytes), expected)\n+    np.testing.assert_almost_equal(sm.to_rgba(xm[..., :3], bytes=bytes), expected)\n \n \n def test_failed_conversions():\n", "problem_statement": "[TST] Upcoming dependency test failures\nThe weekly build with nightly wheels from numpy and pandas\nhas failed. Check the logs for any updates that need to be\nmade in matplotlib.\nhttps://github.com/matplotlib/matplotlib/actions/runs/7510637551\n", "hints_text": "Some of this is #27624, but there are a number of image comparison failures  (and one array comparison failure) that are caused by something else (that I haven't tracked down yet)... very low RMS, but _something_ changed. \r\n\r\nMy entirely unproven (as yet) suspicion is that it is numpy 2.0 related changing some behavior. \nOkay, I have bisected at least the majority of the errors to:\r\n\r\nhttps://github.com/numpy/numpy/pull/23912/commits/197e61c6bbca7b35414f341f0596391ecf17a31f\r\n\r\n(From numpy/numpy#23912)\r\n\r\nWhich are related to [NEP50](https://numpy.org/neps/nep-0050-scalar-promotion.html)\r\n\r\nI'm a little iffy on the timing, as that was merged in October, but we only started seeing the failure within the last 2-3 weeks.\r\n\r\nThat said, the specific commit is changing the default value which can be overridden by env var, and changing back to \"legacy\" mode (i.e. disabling NEP 50 behavior) does in fact pass the tests.\r\n\r\nHowever, I think it is clear that at least as far as the `pie` changes go, it is a negligible result of different dtype rules in intermediate calculations and we can just add a tolerance to the tests.\r\n\r\nThere are two additional tests that I've not yet fully tracked down:\r\n\r\n- `FAILED lib/matplotlib/tests/test_basic.py::test_override_builtins`\r\n  - Likely related to numpy namespace changes, probably needs a slight adjustment to account for that change\r\n- `FAILED lib/matplotlib/tests/test_colors.py::test_scalarmappable_to_rgba[False] - AssertionError: `\r\n  - Appears to be caused by the same numpy change, may just need to be `np.assert_almost_equal` instead of `assert_equal`, as there is a slight amount of floating point rounding going on there.\nIndeed the `test_override_builtins` is related to numpy/numpy#25086\r\n\r\nThe extra things that are affected are `pow` and `bool`, I think I will add those to the list of things we set back as the `builtins` version at the bottom of `pylab.py`, and maintain current behavior there.", "created_at": "2024-01-15T22:52:32Z"}
{"repo": "matplotlib/matplotlib", "pull_number": 27613, "instance_id": "matplotlib__matplotlib-27613", "issue_numbers": ["27596", "0000"], "base_commit": "83aa3e41bf9d4de308e306521e0cb3f688952942", "patch": "diff --git a/lib/matplotlib/rcsetup.py b/lib/matplotlib/rcsetup.py\nindex cf4dd07a6b98..f730db0dee3b 100644\n--- a/lib/matplotlib/rcsetup.py\n+++ b/lib/matplotlib/rcsetup.py\n@@ -209,6 +209,20 @@ def validator(s):\n     validate_float, doc='return a list of floats')\n \n \n+def _validate_marker(s):\n+    try:\n+        return validate_int(s)\n+    except ValueError as e:\n+        try:\n+            return validate_string(s)\n+        except ValueError as e:\n+            raise ValueError('Supported markers are [string, int]') from e\n+\n+\n+_validate_markerlist = _listify_validator(\n+    _validate_marker, doc='return a list of markers')\n+\n+\n def _validate_pathlike(s):\n     if isinstance(s, (str, os.PathLike)):\n         # Store value as str because savefig.directory needs to distinguish\n@@ -645,7 +659,7 @@ def _validate_minor_tick_ndivs(n):\n         'markeredgecolor': validate_colorlist,\n         'markevery': validate_markeverylist,\n         'alpha': validate_floatlist,\n-        'marker': validate_stringlist,\n+        'marker': _validate_markerlist,\n         'hatch': validate_hatchlist,\n         'dashes': validate_dashlist,\n     }\n@@ -908,7 +922,7 @@ def _convert_validator_spec(key, conv):\n     \"lines.linewidth\":       validate_float,  # line width in points\n     \"lines.linestyle\":       _validate_linestyle,  # solid line\n     \"lines.color\":           validate_color,  # first color in color cycle\n-    \"lines.marker\":          validate_string,  # marker name\n+    \"lines.marker\":          _validate_marker,  # marker name\n     \"lines.markerfacecolor\": validate_color_or_auto,  # default color\n     \"lines.markeredgecolor\": validate_color_or_auto,  # default color\n     \"lines.markeredgewidth\": validate_float,\n@@ -957,7 +971,7 @@ def _convert_validator_spec(key, conv):\n     \"boxplot.meanline\":    validate_bool,\n \n     \"boxplot.flierprops.color\":           validate_color,\n-    \"boxplot.flierprops.marker\":          validate_string,\n+    \"boxplot.flierprops.marker\":          _validate_marker,\n     \"boxplot.flierprops.markerfacecolor\": validate_color_or_auto,\n     \"boxplot.flierprops.markeredgecolor\": validate_color,\n     \"boxplot.flierprops.markeredgewidth\": validate_float,\n@@ -982,7 +996,7 @@ def _convert_validator_spec(key, conv):\n     \"boxplot.medianprops.linestyle\": _validate_linestyle,\n \n     \"boxplot.meanprops.color\":           validate_color,\n-    \"boxplot.meanprops.marker\":          validate_string,\n+    \"boxplot.meanprops.marker\":          _validate_marker,\n     \"boxplot.meanprops.markerfacecolor\": validate_color,\n     \"boxplot.meanprops.markeredgecolor\": validate_color,\n     \"boxplot.meanprops.markersize\":      validate_float,\n@@ -1107,7 +1121,7 @@ def _convert_validator_spec(key, conv):\n     \"axes3d.zaxis.panecolor\":    validate_color,  # 3d background pane\n \n     # scatter props\n-    \"scatter.marker\":     validate_string,\n+    \"scatter.marker\":     _validate_marker,\n     \"scatter.edgecolors\": validate_string,\n \n     \"date.epoch\": _validate_date,\ndiff --git a/lib/matplotlib/rcsetup.pyi b/lib/matplotlib/rcsetup.pyi\nindex 70e94a7694a9..1538dac7510e 100644\n--- a/lib/matplotlib/rcsetup.pyi\n+++ b/lib/matplotlib/rcsetup.pyi\n@@ -39,6 +39,8 @@ def validate_int_or_None(s: Any) -> int | None: ...\n def validate_float(s: Any) -> float: ...\n def validate_float_or_None(s: Any) -> float | None: ...\n def validate_floatlist(s: Any) -> list[float]: ...\n+def _validate_marker(s: Any) -> int | str: ...\n+def _validate_markerlist(s: Any) -> list[int | str]: ...\n def validate_fonttype(s: Any) -> int: ...\n \n _auto_backend_sentinel: object\n", "test_patch": "diff --git a/lib/matplotlib/tests/test_cycles.py b/lib/matplotlib/tests/test_cycles.py\nindex 9bbb9bc9f19c..4fa261619490 100644\n--- a/lib/matplotlib/tests/test_cycles.py\n+++ b/lib/matplotlib/tests/test_cycles.py\n@@ -27,6 +27,11 @@ def test_marker_cycle():\n     assert [l.get_marker() for l in ax.lines] == ['.', '*', 'x', '.']\n \n \n+def test_valid_marker_cycles():\n+    fig, ax = plt.subplots()\n+    ax.set_prop_cycle(cycler(marker=[1, \"+\", \".\", 4]))\n+\n+\n def test_marker_cycle_kwargs_arrays_iterators():\n     fig, ax = plt.subplots()\n     ax.set_prop_cycle(c=np.array(['r', 'g', 'y']),\n", "problem_statement": "[Bug]: Markers with numeric name like CARETLEFT cannot be specified using a cycler\n### Bug summary\n\nI want to cycle between multiple markerstyles, including those with a numeric value like CARETRIGHT as documented [here](https://matplotlib.org/stable/api/markers_api.html#module-matplotlib.markers), but I get an exception if I add one of those.\n\n### Code for reproduction\n\n```python\n#!/usr/bin/env python3\r\n\r\nfrom cycler import cycler\r\nimport matplotlib.pyplot as plt\r\nimport matplotlib.markers as mk\r\n\r\ncycle = cycler(marker=[\"+\",mk.CARETRIGHT])\r\n\r\nt=[0,1]\r\ny=[5,6]\r\n\r\nplt.rc('axes', prop_cycle=cycle)\r\nplt.plot(t,y)\r\nplt.show()\n```\n\n\n### Actual outcome\n\n```\r\nTraceback (most recent call last):\r\n  File \"/home/mcd/bugs/bug-cycler.py\", line 11, in <module>\r\n    plt.rc('axes', prop_cycle=cycle)\r\n  File \"/usr/lib/python3.11/site-packages/matplotlib/pyplot.py\", line 670, in rc\r\n    matplotlib.rc(group, **kwargs)\r\n  File \"/usr/lib/python3.11/site-packages/matplotlib/__init__.py\", line 1062, in rc\r\n    rcParams[key] = v\r\n    ~~~~~~~~^^^^^\r\n  File \"/usr/lib/python3.11/site-packages/matplotlib/__init__.py\", line 734, in __setitem__\r\n    raise ValueError(f\"Key {key}: {ve}\") from None\r\nValueError: Key axes.prop_cycle: Could not convert 5 to str\r\n```\n\n### Expected outcome\n\nA plot using CARETLEFT as marker.\n\n### Additional information\n\nThis seems like it has to do with the fact, that some markers are referred to by number and not by a string like \"+\".\r\nI don't know whether the problem is in matplotlib, cycler or the combination of both.\n\n### Operating system\n\nArtix Linux\n\n### Matplotlib Version\n\n3.8.1\n\n### Matplotlib Backend\n\nGTK4Agg\n\n### Python version\n\nPython 3.11.6\n\n### Jupyter version\n\n_No response_\n\n### Installation\n\nLinux package manager\n", "hints_text": "Looks like the validator for the `marker` property is a stringlist\r\nvalidator, so it is trying to coerce things into strings. Probably should\r\nupdate the validator.\r\n\r\nOn Wed, Jan 3, 2024 at 1:06\u202fPM castilma ***@***.***> wrote:\r\n\r\n> Bug summary\r\n>\r\n> I want to cycle between multiple markerstyles, including those with a\r\n> numeric value like CARETRIGHT as documented here\r\n> <https://matplotlib.org/stable/api/markers_api.html#module-matplotlib.markers>,\r\n> but I get an exception if I add one of those.\r\n> Code for reproduction\r\n>\r\n> #!/usr/bin/env python3\r\n> from cycler import cyclerimport matplotlib.pyplot as pltimport matplotlib.markers as mk\r\n> cycle = cycler(marker=[\"+\",mk.CARETRIGHT])\r\n> t=[0,1]y=[5,6]\r\n> plt.rc('axes', prop_cycle=cycle)plt.plot(t,y)plt.show()\r\n>\r\n> Actual outcome\r\n>\r\n> Traceback (most recent call last):\r\n>   File \"/home/mcd/bugs/bug-cycler.py\", line 11, in <module>\r\n>     plt.rc('axes', prop_cycle=cycle)\r\n>   File \"/usr/lib/python3.11/site-packages/matplotlib/pyplot.py\", line 670, in rc\r\n>     matplotlib.rc(group, **kwargs)\r\n>   File \"/usr/lib/python3.11/site-packages/matplotlib/__init__.py\", line 1062, in rc\r\n>     rcParams[key] = v\r\n>     ~~~~~~~~^^^^^\r\n>   File \"/usr/lib/python3.11/site-packages/matplotlib/__init__.py\", line 734, in __setitem__\r\n>     raise ValueError(f\"Key {key}: {ve}\") from None\r\n> ValueError: Key axes.prop_cycle: Could not convert 5 to str\r\n>\r\n> Expected outcome\r\n>\r\n> A plot using CARETLEFT as marker.\r\n> Additional information\r\n>\r\n> This seems like it has to do with the fact, that some markers are referred\r\n> to by number and not by a string like \"+\".\r\n> I don't know whether the problem is in matplotlib, cycler or the\r\n> combination of both.\r\n> Operating system\r\n>\r\n> Artix Linux\r\n> Matplotlib Version\r\n>\r\n> 3.8.1\r\n> Matplotlib Backend\r\n>\r\n> GTK4Agg\r\n> Python version\r\n>\r\n> Python 3.11.6\r\n> Jupyter version\r\n>\r\n> *No response*\r\n> Installation\r\n>\r\n> Linux package manager\r\n>\r\n> \u2014\r\n> Reply to this email directly, view it on GitHub\r\n> <https://github.com/matplotlib/matplotlib/issues/27596>, or unsubscribe\r\n> <https://github.com/notifications/unsubscribe-auth/AACHF6ELTISA2WV6D5ACXBLYMWM3TAVCNFSM6AAAAABBLZNEFCVHI2DSMVQWIX3LMV43ASLTON2WKOZSGA3DINBUGUZTKOI>\r\n> .\r\n> You are receiving this because you are subscribed to this thread.Message\r\n> ID: ***@***.***>\r\n>\r\n\nMore specifically https://github.com/matplotlib/matplotlib/blob/8703dc5682d3655258d8917c1f8ef63cb1576dbb/lib/matplotlib/rcsetup.py#L648  needs to be updated to accept the int(/enum) values.\r\n\r\n```python\r\nIn [13]: plt.rcParams['lines.marker'] = mk.CARETRIGHT\r\n---------------------------------------------------------------------------\r\nValueError                                Traceback (most recent call last)\r\nCell In[13], line 1\r\n----> 1 plt.rcParams['lines.marker'] = mk.CARETRIGHT\r\n\r\nFile /usr/lib/python3.11/site-packages/matplotlib/__init__.py:734, in RcParams.__setitem__(self, key, val)\r\n    732         cval = self.validate[key](val)\r\n    733     except ValueError as ve:\r\n--> 734         raise ValueError(f\"Key {key}: {ve}\") from None\r\n    735     self._set(key, cval)\r\n    736 except KeyError as err:\r\n\r\nValueError: Key lines.marker: Could not convert 5 to str\r\n```\r\n\r\nis a simpler way exercise the same issue.\n### Good first issue - notes for new contributors\n\nThis issue is suited to new contributors because it does not require understanding of the Matplotlib internals. To get started, please see our [contributing guide](https://matplotlib.org/stable/devel/index).\n\n**We do not assign issues**. Check the *Development* section in the sidebar for linked pull requests (PRs). If there are none, feel free to start working on it. If there is an open PR, please collaborate on the work by reviewing it rather than duplicating it in a competing PR.\n\nIf something is unclear, please reach out on any of our [communication channels](https://matplotlib.org/stable/devel/contributing.html#get-connected).\nSteps:\r\n\r\n - update the marker validator to accept all valid marker specifications (atleast the integers, maybe the path and `Marker` classes as well)\r\n - add a test\r\n - add a whats new (if extended past integers)\r\n\r\nGood first issue because this is very narrowly scoped, but medium because there is some meta-programming in the validator code.  Some thought will need to be given to writing a validator that works for both \"live\" objects and for strings coming from reading and .matplotlibrc.\nThe problem might exist in several places such as\r\nhttps://github.com/matplotlib/matplotlib/blob/8703dc5682d3655258d8917c1f8ef63cb1576dbb/lib/matplotlib/rcsetup.py#L911\r\n\r\nOn Wed, Jan 3, 2024 at 1:38\u202fPM Thomas A Caswell ***@***.***>\r\nwrote:\r\n\r\n> Steps:\r\n>\r\n>    - update the marker validator to accept all valid marker\r\n>    specifications (atleast the integers, maybe the path and Marker\r\n>    classes as well)\r\n>    - add a test\r\n>    - add a whats new (if extended past integers)\r\n>\r\n> Good first issue because this is very narrowly scoped, but medium because\r\n> there is some meta-programming in the validator code. Some thought will\r\n> need to be given to writing a validator that works for both \"live\" objects\r\n> and for strings coming from reading and .matplotlibrc.\r\n>\r\n> \u2014\r\n> Reply to this email directly, view it on GitHub\r\n> <https://github.com/matplotlib/matplotlib/issues/27596#issuecomment-1875801971>,\r\n> or unsubscribe\r\n> <https://github.com/notifications/unsubscribe-auth/AACHF6GY7VSBKB7VZ77OGN3YMWQTFAVCNFSM6AAAAABBLZNEFCVHI2DSMVQWIX3LMV43OSLTON2WKQ3PNVWWK3TUHMYTQNZVHAYDCOJXGE>\r\n> .\r\n> You are receiving this because you commented.Message ID:\r\n> ***@***.***>\r\n>\r\n", "created_at": "2024-01-08T23:53:11Z"}
{"repo": "matplotlib/matplotlib", "pull_number": 27595, "instance_id": "matplotlib__matplotlib-27595", "issue_numbers": ["25995", "0000"], "base_commit": "8703dc5682d3655258d8917c1f8ef63cb1576dbb", "patch": "diff --git a/src/_path_wrapper.cpp b/src/_path_wrapper.cpp\nindex cdab886d86df..72774576574a 100644\n--- a/src/_path_wrapper.cpp\n+++ b/src/_path_wrapper.cpp\n@@ -707,8 +707,8 @@ static PyObject *Py_is_sorted_and_has_non_nan(PyObject *self, PyObject *obj)\n {\n     bool result;\n \n-    PyArrayObject *array = (PyArrayObject *)PyArray_FromAny(\n-        obj, NULL, 1, 1, 0, NULL);\n+    PyArrayObject *array = (PyArrayObject *)PyArray_CheckFromAny(\n+        obj, NULL, 1, 1, NPY_ARRAY_NOTSWAPPED, NULL);\n \n     if (array == NULL) {\n         return NULL;\n", "test_patch": "diff --git a/lib/matplotlib/tests/test_lines.py b/lib/matplotlib/tests/test_lines.py\nindex 68e378a20f88..80261b0ddb19 100644\n--- a/lib/matplotlib/tests/test_lines.py\n+++ b/lib/matplotlib/tests/test_lines.py\n@@ -246,6 +246,8 @@ def test_is_sorted_and_has_non_nan():\n     assert _path.is_sorted_and_has_non_nan(np.array([1, 2, 3]))\n     assert _path.is_sorted_and_has_non_nan(np.array([1, np.nan, 3]))\n     assert not _path.is_sorted_and_has_non_nan([3, 5] + [np.nan] * 100 + [0, 2])\n+    # [2, 256] byteswapped:\n+    assert not _path.is_sorted_and_has_non_nan(np.array([33554432, 65536], \">i4\"))\n     n = 2 * mlines.Line2D._subslice_optim_min_size\n     plt.plot([np.nan] * n, range(n))\n \n", "problem_statement": "[Bug]: _path.is_sorted is wrong for the non-native byteorder case\n### Bug summary\r\n\r\n_path.is_sorted always reads data from the buffer in native byteorder, thus it can give incorrect results when the input is in non-native byteorder.  (This is also true for is_sorted_and_has_non_nan in #25978.)\r\n\r\n### Code for reproduction\r\n\r\n```python\r\n# The array below reads as [2, 256] after byteswapping.\r\nmpl._path.is_sorted(np.array([33554432, 65536], \">i4\"))\r\n```\r\n\r\n\r\n### Actual outcome\r\n\r\nTrue\r\n\r\n### Expected outcome\r\n\r\nFalse\r\n\r\n### Additional information\r\n\r\nWe don't actually really need to support any case other than native-order floats in is_sorted (because we only ever call it with a freshly constructed float array), so we should just restrict support to that case.\r\nIt may also be useful to inspect the other C APIs which may likewise be impacted by wrong byteorderness.\r\n\r\nI also doubt that the speed gain from having a specialized C implementation of is_sorted (compared to the plain numpy `nanmask = np.isnan(x); x_finite = x[~nanmask]; x_finite.size and (x_finite[1:] >= x_finite[:-1]).all()` or similar -- note that we already compute nanmask and x_finite below) is really worth the trouble.\r\n\r\n### Operating system\r\n\r\nmacos\r\n\r\n### Matplotlib Version\r\n\r\n3.8.0.dev1128+g5438e94fa7\r\n\r\n### Matplotlib Backend\r\n\r\nany\r\n\r\n### Python version\r\n\r\n3.11\r\n\r\n### Jupyter version\r\n\r\n_No response_\r\n\r\n### Installation\r\n\r\ngit checkout\n", "hints_text": "", "created_at": "2024-01-03T10:38:33Z"}
{"repo": "matplotlib/matplotlib", "pull_number": 27562, "instance_id": "matplotlib__matplotlib-27562", "issue_numbers": ["27554", "0000"], "base_commit": "e5098e0dc2e5da26f659f44ce758d09c54f6b656", "patch": "diff --git a/lib/matplotlib/image.py b/lib/matplotlib/image.py\nindex e3e162a3d621..0ab02c403d0d 100644\n--- a/lib/matplotlib/image.py\n+++ b/lib/matplotlib/image.py\n@@ -555,11 +555,15 @@ def _make_image(self, A, in_bbox, out_bbox, clip_bbox, magnification=1.0,\n                 if A.ndim == 2:  # _interpolation_stage == 'rgba'\n                     self.norm.autoscale_None(A)\n                     A = self.to_rgba(A)\n-                if A.shape[2] == 3:\n-                    A = _rgb_to_rgba(A)\n                 alpha = self._get_scalar_alpha()\n-                output_alpha = _resample(  # resample alpha channel\n-                    self, A[..., 3], out_shape, t, alpha=alpha)\n+                if A.shape[2] == 3:\n+                    # No need to resample alpha or make a full array; NumPy will expand\n+                    # this out and cast to uint8 if necessary when it's assigned to the\n+                    # alpha channel below.\n+                    output_alpha = (255 * alpha) if A.dtype == np.uint8 else alpha\n+                else:\n+                    output_alpha = _resample(  # resample alpha channel\n+                        self, A[..., 3], out_shape, t, alpha=alpha)\n                 output = _resample(  # resample rgb channels\n                     self, _rgb_to_rgba(A[..., :3]), out_shape, t, alpha=alpha)\n                 output[..., 3] = output_alpha  # recombine rgb and alpha\n", "test_patch": "diff --git a/lib/matplotlib/tests/test_image.py b/lib/matplotlib/tests/test_image.py\nindex 4fb4e65137d4..9a40b9baa313 100644\n--- a/lib/matplotlib/tests/test_image.py\n+++ b/lib/matplotlib/tests/test_image.py\n@@ -268,6 +268,32 @@ def test_image_alpha():\n     ax3.imshow(Z, alpha=0.5, interpolation='nearest')\n \n \n+@mpl.style.context('mpl20')\n+@check_figures_equal(extensions=['png'])\n+def test_imshow_alpha(fig_test, fig_ref):\n+    np.random.seed(19680801)\n+\n+    rgbf = np.random.rand(6, 6, 3)\n+    rgbu = np.uint8(rgbf * 255)\n+    ((ax0, ax1), (ax2, ax3)) = fig_test.subplots(2, 2)\n+    ax0.imshow(rgbf, alpha=0.5)\n+    ax1.imshow(rgbf, alpha=0.75)\n+    ax2.imshow(rgbu, alpha=0.5)\n+    ax3.imshow(rgbu, alpha=0.75)\n+\n+    rgbaf = np.concatenate((rgbf, np.ones((6, 6, 1))), axis=2)\n+    rgbau = np.concatenate((rgbu, np.full((6, 6, 1), 255, np.uint8)), axis=2)\n+    ((ax0, ax1), (ax2, ax3)) = fig_ref.subplots(2, 2)\n+    rgbaf[:, :, 3] = 0.5\n+    ax0.imshow(rgbaf)\n+    rgbaf[:, :, 3] = 0.75\n+    ax1.imshow(rgbaf)\n+    rgbau[:, :, 3] = 127\n+    ax2.imshow(rgbau)\n+    rgbau[:, :, 3] = 191\n+    ax3.imshow(rgbau)\n+\n+\n def test_cursor_data():\n     from matplotlib.backend_bases import MouseEvent\n \n", "problem_statement": "[Bug]:  Large image draw performance deterioration in recent releases\n### Bug summary\r\n\r\nDraw performance for large images has deteriorated significantly between Matplotlib 3.1 and 3.8.  The biggest issue seems to arise when upgrading from 3.1. to 3.2\r\n\r\n### Code for reproduction\r\n\r\n```python\r\nimport cProfile\r\nfrom profilehooks import profile\r\nimport tkinter as tk\r\nimport matplotlib.pyplot as plt\r\nimport numpy as np\r\nfrom matplotlib.backends.backend_tkagg import (FigureCanvas)\r\nfrom PIL import Image\r\nimport time\r\n\r\nclass Application(tk.Frame):\r\n\r\n        SIZE = 16000\r\n\r\n        def __init__(self, master=None):\r\n            \r\n            super().__init__(master)\r\n            self.figure = plt.figure('Diagram')\r\n            self.canvas = FigureCanvas(self.figure, self)\r\n            self.ax = plt.axes()\r\n            self.canvas.mpl_connect('button_press_event', self.toggle)\r\n            \r\n            self.border = 0\r\n            random_image = self.image_gen()\r\n            self.image = self.ax.imshow(random_image)\r\n                 \r\n            self.canvas.get_tk_widget().pack(side=tk.TOP,fill=tk.BOTH, expand=1)\r\n            self.pack(side=tk.TOP,fill=tk.BOTH, expand=1)\r\n\r\n        @profile(immediate=True)\r\n        def toggle(self, event):\r\n            self.border = 0 if self.border == Application.SIZE /4 else Application.SIZE /4 \r\n            self.ax.set_xlim(self.border, Application.SIZE - self.border)\r\n            self.ax.set_ylim(self.border, Application.SIZE - self.border)\r\n            t1= time.process_time()\r\n            self.canvas.draw()\r\n            print(\"Draw time:\", time.process_time() - t1)\r\n\r\n        def image_gen(self):\r\n            black = np.zeros((int(Application.SIZE / 8) , int(Application.SIZE / 8), 3),dtype='uint8')\r\n            white = np.ones((int(Application.SIZE / 8) , int(Application.SIZE / 8), 3),dtype='uint8') * 255\r\n            col1 = np.concatenate([white, black, white, black, white, black, white, black], axis=0)\r\n            col2  = np.concatenate([black, white, black, white, black, white, black, white], axis=0)\r\n            output = np.concatenate([col1, col2, col1, col2,col1, col2, col1, col2], axis=1)\r\n            im = Image.fromarray(output, 'RGB')\r\n            return im\r\n                      \r\nif __name__ == '__main__':\r\n          \r\n    root = tk.Tk()\r\n    app = Application(master=root)\r\n    root.state('zoomed')\r\n    app.mainloop()\r\n```\r\n\r\n\r\n### Actual outcome\r\n\r\n**When running Matplotlib 3.8.2**\r\n```\r\n         35152 function calls (34234 primitive calls) in 6.264 seconds\r\n\r\n   Ordered by: cumulative time, internal time, call count\r\n   List reduced from 650 to 40 due to restriction <40>\r\n\r\n   ncalls  tottime  percall  cumtime  percall filename:lineno(function)\r\n        1    0.000    0.000    6.264    6.264 min_code.py:29(toggle)\r\n        1    0.000    0.000    6.255    6.255 backend_tkagg.py:9(draw)\r\n        1    0.000    0.000    6.175    6.175 backend_agg.py:381(draw)\r\n        1    0.000    0.000    6.168    6.168 artist.py:93(draw_wrapper)\r\n    130/1    0.001    0.000    6.168    6.168 artist.py:54(draw_wrapper)\r\n        1    0.000    0.000    6.168    6.168 figure.py:3134(draw)\r\n      2/1    0.000    0.000    6.161    6.161 image.py:113(_draw_list_compositing_images)\r\n        1    0.000    0.000    6.161    6.161 _base.py:3005(draw)\r\n        1    0.000    0.000    6.113    6.113 image.py:623(draw)\r\n        1    0.046    0.046    6.107    6.107 image.py:928(make_image)\r\n        1    0.041    0.041    6.061    6.061 image.py:333(_make_image)\r\n        2    3.877    1.939    3.877    1.939 image.py:215(_rgb_to_rgba)\r\n        2    0.000    0.000    2.142    1.071 image.py:160(_resample)\r\n        2    2.141    1.071    2.141    1.071 {built-in method matplotlib._image.resample}\r\n        1    0.000    0.000    0.080    0.080 backend_tkagg.py:13(blit)\r\n        1    0.000    0.000    0.080    0.080 _backend_tk.py:72(blit)\r\n      2/1    0.000    0.000    0.080    0.080 {method 'call' of '_tkinter.tkapp' objects}\r\n        1    0.000    0.000    0.080    0.080 _backend_tk.py:58(_blit)\r\n        1    0.080    0.080    0.080    0.080 {built-in method matplotlib.backends._tkagg.blit}\r\n        2    0.000    0.000    0.042    0.021 axis.py:1379(draw)\r\n       18    0.000    0.000    0.018    0.001 axis.py:287(draw)\r\n       39    0.001    0.000    0.013    0.000 text.py:915(get_window_extent)\r\n        4    0.000    0.000    0.013    0.003 axis.py:1311(_get_ticklabel_bboxes)\r\n        4    0.000    0.000    0.013    0.003 axis.py:1315(<listcomp>)\r\n       54    0.002    0.000    0.013    0.000 text.py:358(_get_layout)\r\n       43    0.001    0.000    0.012    0.000 text.py:734(draw)\r\n        6    0.000    0.000    0.010    0.002 patches.py:579(draw)\r\n        6    0.000    0.000    0.010    0.002 axis.py:1270(_update_ticks)\r\n        6    0.000    0.000    0.010    0.002 patches.py:530(_draw_paths_with_artist_properties)\r\n        6    0.000    0.000    0.009    0.001 backend_agg.py:95(draw_path)\r\n        6    0.009    0.001    0.009    0.001 {method 'draw_path' of 'matplotlib.backends._backend_agg.RendererAgg' objects}\r\n        1    0.000    0.000    0.009    0.009 {built-in method builtins.print}\r\n        4    0.000    0.000    0.009    0.002 run.py:448(write)\r\n        5    0.000    0.000    0.008    0.002 rpc.py:216(remotecall)\r\n        2    0.000    0.000    0.008    0.004 axis.py:2143(_get_tick_boxes_siblings)\r\n        5    0.000    0.000    0.008    0.002 rpc.py:246(asyncreturn)\r\n        5    0.000    0.000    0.008    0.002 rpc.py:290(getresponse)\r\n        5    0.000    0.000    0.008    0.002 rpc.py:306(_getresponse)\r\n        5    0.000    0.000    0.007    0.001 threading.py:280(wait)\r\n        4    0.000    0.000    0.007    0.002 rpc.py:606(__call__)\r\n```\r\n**When running Matplotlib 3.1.3**\r\n\r\n```\r\n         29643 function calls (28812 primitive calls) in 3.848 seconds\r\n\r\n   Ordered by: cumulative time, internal time, call count\r\n   List reduced from 661 to 40 due to restriction <40>\r\n\r\n   ncalls  tottime  percall  cumtime  percall filename:lineno(function)\r\n        1    0.000    0.000    3.848    3.848 min_code.py:29(toggle)\r\n        1    0.000    0.000    3.814    3.814 backend_tkagg.py:8(draw)\r\n        1    0.000    0.000    3.552    3.552 backend_agg.py:382(draw)\r\n    130/1    0.001    0.000    3.547    3.547 artist.py:30(draw_wrapper)\r\n        1    0.000    0.000    3.547    3.547 figure.py:1661(draw)\r\n      2/1    0.000    0.000    3.540    3.540 image.py:117(_draw_list_compositing_images)\r\n        1    0.000    0.000    3.540    3.540 _base.py:2573(draw)\r\n        1    0.000    0.000    3.494    3.494 image.py:595(draw)\r\n        1    0.091    0.091    3.490    3.490 image.py:872(make_image)\r\n        1    0.002    0.002    3.399    3.399 image.py:255(_make_image)\r\n        2    3.192    1.596    3.192    1.596 image.py:163(_rgb_to_rgba)\r\n        1    0.000    0.000    0.240    0.240 _backend_tk.py:58(blit)\r\n        1    0.235    0.235    0.235    0.235 {built-in method matplotlib.backends._tkagg.blit}\r\n        2    0.204    0.102    0.205    0.102 {built-in method matplotlib._image.resample}\r\n        2    0.000    0.000    0.040    0.020 axis.py:1195(draw)\r\n        1    0.000    0.000    0.034    0.034 {built-in method builtins.print}\r\n        4    0.000    0.000    0.034    0.008 run.py:354(write)\r\n        5    0.000    0.000    0.033    0.007 rpc.py:217(remotecall)\r\n        5    0.000    0.000    0.032    0.006 rpc.py:247(asyncreturn)\r\n        5    0.000    0.000    0.032    0.006 rpc.py:291(getresponse)\r\n        5    0.000    0.000    0.032    0.006 rpc.py:307(_getresponse)\r\n        5    0.000    0.000    0.032    0.006 threading.py:263(wait)\r\n       10    0.032    0.003    0.032    0.003 {method 'acquire' of '_thread.lock' objects}\r\n        2    0.026    0.013    0.026    0.013 {method 'call' of '_tkinter.tkapp' objects}\r\n        4    0.000    0.000    0.025    0.006 rpc.py:560(__getattr__)\r\n        1    0.000    0.000    0.025    0.025 rpc.py:578(__getmethods)\r\n        1    0.000    0.000    0.021    0.021 __init__.py:1178(update_idletasks)\r\n       18    0.000    0.000    0.015    0.001 axis.py:289(draw)\r\n        4    0.000    0.000    0.015    0.004 axis.py:1074(_update_ticks)\r\n        8    0.000    0.000    0.011    0.001 ticker.py:2079(__call__)\r\n        6    0.000    0.000    0.011    0.002 patches.py:563(draw)\r\n        8    0.000    0.000    0.011    0.001 ticker.py:2083(tick_values)\r\n        8    0.000    0.000    0.011    0.001 ticker.py:2019(_raw_ticks)\r\n        6    0.000    0.000    0.010    0.002 backend_agg.py:119(draw_path)\r\n        6    0.010    0.002    0.010    0.002 {method 'draw_path' of 'matplotlib.backends._backend_agg.RendererAgg' objects}\r\n        8    0.000    0.000    0.009    0.001 axis.py:56(__init__)\r\n        4    0.000    0.000    0.009    0.002 rpc.py:607(__call__)\r\n       43    0.001    0.000    0.009    0.000 text.py:655(draw)\r\n       39    0.000    0.000    0.008    0.000 text.py:852(get_window_extent)\r\n        4    0.000    0.000    0.008    0.002 axis.py:1147(_get_tick_bboxes)\r\n```\r\n### Expected outcome\r\n\r\nI would hope that performance remained reasonable consistent or improved between versions.\r\n\r\n### Additional information\r\n\r\nI have only been able to trace this as far as _make_image.  The issue seems to persist regardless of interpolation method.\r\n\r\n### Operating system\r\n\r\nWindows 11 64-bit\r\n\r\n### Matplotlib Version\r\n\r\n3.2 upward\r\n\r\n### Matplotlib Backend\r\n\r\nTkAgg\r\n\r\n### Python version\r\n\r\n3.6 for Matplotlib 3.1.3; 3.9 for Matplotlib 3.8.2\r\n\r\n### Jupyter version\r\n\r\nn/A\r\n\r\n### Installation\r\n\r\nconda\n", "hints_text": "I know you stated that \r\n\r\n> The issue seems to persist regardless of interpolation method.\r\n\r\nBut I just want to double check whether you have tried the \"nearest\" interpolation method, as that was the default prior to v3.2\r\nhttps://matplotlib.org/stable/api/prev_api_changes/api_changes_3.2.0.html#default-image-interpolation\nI have tried both and it does not appear to make a material difference for me.\nCan you make a reproducible example that doesn't rely on having tk installed?  \nAs requested below.  It actually appears that _rgb_to_rgba may be the culprit\r\n\r\n```\r\nimport cProfile\r\nfrom profilehooks import profile\r\nimport matplotlib.pyplot as plt\r\nimport numpy as np\r\nfrom PIL import Image\r\nimport time\r\n\r\n\r\nSIZE = 16000\r\n\r\n         \r\n@profile(immediate=True)\r\ndef toggle(event):\r\n        global ax, fig , border\r\n        border = 0 if border == SIZE /4 else SIZE /4 \r\n        ax.set_xlim(border, SIZE - border)\r\n        ax.set_ylim(border, SIZE - border)\r\n        t1= time.process_time()\r\n        fig.canvas.draw()\r\n        print(\"Draw time:\", time.process_time() - t1)\r\n\r\ndef image_gen():\r\n    black = np.zeros((int(SIZE / 8) , int(SIZE / 8), 3),dtype='uint8')\r\n    white = np.ones((int(SIZE / 8) , int(SIZE / 8), 3),dtype='uint8') * 255\r\n    col1 = np.concatenate([white, black, white, black, white, black, white, black], axis=0)\r\n    col2  = np.concatenate([black, white, black, white, black, white, black, white], axis=0)\r\n    output = np.concatenate([col1, col2, col1, col2,col1, col2, col1, col2], axis=1)\r\n    im = Image.fromarray(output, 'RGB')\r\n    return im\r\n              \r\n\r\n          \r\nfig, ax = plt.subplots()\r\nfig.canvas.mpl_connect('button_press_event', toggle)    \r\nborder = 0\r\nrandom_image = image_gen()\r\nimage = ax.imshow(random_image, interpolation='none')\r\nplt.show()\r\n```\nAs a further reference point, executing the same code with matplotlib 2.2.2 gives the results below:\r\n\r\n```\r\n        22416 function calls (21710 primitive calls) in 1.865 seconds\r\n\r\n   Ordered by: cumulative time, internal time, call count\r\n   List reduced from 656 to 40 due to restriction <40>\r\n\r\n   ncalls  tottime  percall  cumtime  percall filename:lineno(function)\r\n        1    0.000    0.000    1.865    1.865 min_code.py:12(toggle)\r\n        1    0.000    0.000    1.816    1.816 backend_agg.py:421(draw)\r\n     76/1    0.001    0.000    1.813    1.813 artist.py:47(draw_wrapper)\r\n        1    0.000    0.000    1.813    1.813 figure.py:1438(draw)\r\n      2/1    0.000    0.000    1.809    1.809 image.py:123(_draw_list_compositing_images)\r\n        1    0.000    0.000    1.809    1.809 _base.py:2528(draw)\r\n        1    0.000    0.000    1.785    1.785 image.py:569(draw)\r\n        1    0.034    0.034    1.780    1.780 image.py:832(make_image)\r\n        1    0.000    0.000    1.746    1.746 image.py:275(_make_image)\r\n        1    1.031    1.031    1.031    1.031 image.py:169(_rgb_to_rgba)\r\n        1    0.714    0.714    0.714    0.714 {built-in method matplotlib._image.resample}\r\n        1    0.000    0.000    0.049    0.049 {built-in method builtins.print}\r\n        4    0.000    0.000    0.049    0.012 run.py:354(write)\r\n        4    0.000    0.000    0.048    0.012 rpc.py:607(__call__)\r\n        4    0.000    0.000    0.048    0.012 rpc.py:217(remotecall)\r\n        4    0.000    0.000    0.048    0.012 rpc.py:247(asyncreturn)\r\n        4    0.000    0.000    0.048    0.012 rpc.py:291(getresponse)\r\n        4    0.000    0.000    0.048    0.012 rpc.py:307(_getresponse)\r\n        4    0.000    0.000    0.048    0.012 threading.py:263(wait)\r\n        8    0.048    0.006    0.048    0.006 {method 'acquire' of '_thread.lock' objects}\r\n        2    0.000    0.000    0.017    0.008 axis.py:1182(draw)\r\n        6    0.000    0.000    0.009    0.002 patches.py:507(draw)\r\n       18    0.000    0.000    0.008    0.000 axis.py:289(draw)\r\n        6    0.000    0.000    0.008    0.001 backend_agg.py:142(draw_path)\r\n        6    0.008    0.001    0.008    0.001 {method 'draw_path' of 'matplotlib.backends._backend_agg.RendererAgg' objects}\r\n        4    0.000    0.000    0.006    0.001 axis.py:1020(_update_ticks)\r\n        1    0.005    0.005    0.005    0.005 {method 'draw_image' of 'matplotlib.backends._backend_agg.RendererAgg' objects}\r\n       25    0.000    0.000    0.004    0.000 text.py:691(draw)\r\n       40    0.000    0.000    0.004    0.000 axis.py:967(iter_ticks)\r\n       18    0.000    0.000    0.004    0.000 lines.py:731(draw)\r\n        4    0.000    0.000    0.004    0.001 ticker.py:1943(__call__)\r\n        4    0.000    0.000    0.004    0.001 ticker.py:1947(tick_values)\r\n        4    0.000    0.000    0.003    0.001 ticker.py:1896(_raw_ticks)\r\n        1    0.000    0.000    0.003    0.003 backend_agg.py:442(get_renderer)\r\n        1    0.000    0.000    0.003    0.003 backend_agg.py:300(clear)\r\n        1    0.003    0.003    0.003    0.003 {method 'clear' of 'matplotlib.backends._backend_agg.RendererAgg' objects}\r\n       18    0.000    0.000    0.003    0.000 backend_agg.py:190(draw_text)\r\n        4    0.000    0.000    0.003    0.001 axis.py:74(__init__)\r\n  503/417    0.001    0.000    0.002    0.000 {built-in method numpy.core._multiarray_umath.implement_array_function}\r\n        4    0.000    0.000    0.002    0.000 axis.py:1119(_get_tick_bboxes)\r\n```\r\n\r\nSo, on my machine:\r\n2.2.2->1.865 seconds\r\n3.1.3->3.848 seconds\r\n3.2.8->6.264 seconds\nThis is still hard for me to debug because it has a mouse click, which zooms on my machine, changing the size of the canvas.  Does this require the interactive component? \nHere is a version that is not interactive.  For me this takes about 1 second to execute on version 2.2.2 and about 2.7 seconds on version 3.8.2.\r\n\r\n```\r\nimport cProfile\r\nfrom profilehooks import profile\r\nimport matplotlib\r\nmatplotlib.use('agg')       \r\nimport matplotlib.pyplot as plt\r\nimport numpy as np\r\nfrom PIL import Image\r\nimport time\r\n\r\n\r\nSIZE = 16000\r\n\r\n\r\n@profile(immediate=True)\r\ndef zoom():\r\n        global ax, fig , border\r\n        border = 0 if border == SIZE /4 else SIZE /4 \r\n        ax.set_xlim(border, SIZE - border)\r\n        ax.set_ylim(border, SIZE - border)\r\n        t1= time.process_time()\r\n        fig.canvas.draw()\r\n        print(\"Draw time:\", time.process_time() - t1)\r\n\r\ndef image_gen():\r\n    black = np.zeros((int(SIZE / 8) , int(SIZE / 8), 3),dtype='uint8')\r\n    white = np.ones((int(SIZE / 8) , int(SIZE / 8), 3),dtype='uint8') * 255\r\n    col1 = np.concatenate([white, black, white, black, white, black, white, black], axis=0)\r\n    col2  = np.concatenate([black, white, black, white, black, white, black, white], axis=0)\r\n    output = np.concatenate([col1, col2, col1, col2,col1, col2, col1, col2], axis=1)\r\n    im = Image.fromarray(output, 'RGB')\r\n    return im\r\n              \r\n\r\n   \r\nfig, ax = plt.subplots()\r\nborder = 0\r\nrandom_image = image_gen()\r\nimage = ax.imshow(random_image, interpolation='nearest')\r\nzoom()\r\nzoom()\r\n\r\n```\n`line_profiler` does point to `_rgb_to_rgba` as you've found:\r\n```\r\nTotal time: 3.64252 s\r\nFile: /home/elliott/code/matplotlib/lib/matplotlib/image.py\r\nFunction: _rgb_to_rgba at line 217\r\n\r\nLine #      Hits         Time  Per Hit   % Time  Line Contents\r\n==============================================================\r\n   217                                           @profile\r\n   218                                           def _rgb_to_rgba(A):\r\n   219                                               \"\"\"\r\n   220                                               Convert an RGB image to RGBA, as required by the image resample C++\r\n   221                                               extension.\r\n   222                                               \"\"\"\r\n   223         2         41.9     21.0      0.0      rgba = np.zeros((A.shape[0], A.shape[1], 4), dtype=A.dtype)\r\n   224         2    3446705.2    2e+06     94.6      rgba[:, :, :3] = A\r\n   225         2         14.3      7.1      0.0      if rgba.dtype == np.uint8:\r\n   226         2     195758.7  97879.4      5.4          rgba[:, :, 3] = 255\r\n   227                                               else:\r\n   228                                                   rgba[:, :, 3] = 1.0\r\n   229         2          1.9      0.9      0.0      return rgba\r\n```\r\n\r\nThere are two calls to it in `_make_image`:\r\n```\r\n   560         1          0.9      0.9      0.0                  if A.shape[2] == 3:\r\n   561         1    1840651.4    2e+06     48.5                      A = _rgb_to_rgba(A)\r\n   562         1          4.0      4.0      0.0                  alpha = self._get_scalar_alpha()\r\n   563         2     113653.9  56827.0      3.0                  output_alpha = _resample(  # resample alpha channel\r\n   564         1          4.0      4.0      0.0                      self, A[..., 3], out_shape, t, alpha=alpha)\r\n   565         2      36536.1  18268.0      1.0                  output = _resample(  # resample rgb channels\r\n   566         1    1801965.4    2e+06     47.5                      self, _rgb_to_rgba(A[..., :3]), out_shape, t, alpha=alpha)\r\n   567         1         64.7     64.7      0.0                  output[..., 3] = output_alpha  # recombine rgb and alpha\r\n   568\r\n```\r\n\r\nThe comments seem to indicate this is because the C++ extension needs it that way. But the first call to `_resample` is with just the alpha channel, which in this case is just 255, so that seems a waste (but there might be a real alpha channel in other cases.) The second call to `_resample` uses `_rgb_to_rgba(A[..., :3])`; in other words, it is using an opaque (255/1.0) alpha channel, not the original one. The other calls to `_resample` are with `A.ndim == 2`, aka 2D/non-RGB(A) data, in the earlier half of the `if` above this point of `_make_image`.\r\n\r\nSo if I've gone through all cases correctly, there is no Python code that _needs_ to call the resampler with RGBA data instead of RGB; it's just that way because it used to be that way?\nWe should be able to drop the first call with:\r\n```diff\r\ndiff --git a/lib/matplotlib/image.py b/lib/matplotlib/image.py\r\nindex 8b672e5ad2..249f58bcb2 100644\r\n--- a/lib/matplotlib/image.py\r\n+++ b/lib/matplotlib/image.py\r\n@@ -555,11 +555,14 @@ class _ImageBase(martist.Artist, cm.ScalarMappable):\r\n                 if A.ndim == 2:  # _interpolation_stage == 'rgba'\r\n                     self.norm.autoscale_None(A)\r\n                     A = self.to_rgba(A)\r\n-                if A.shape[2] == 3:\r\n-                    A = _rgb_to_rgba(A)\r\n                 alpha = self._get_scalar_alpha()\r\n-                output_alpha = _resample(  # resample alpha channel\r\n-                    self, A[..., 3], out_shape, t, alpha=alpha)\r\n+                if A.shape[2] == 3:\r\n+                    # No need to resample alpha or make a full array; NumPy will expand\r\n+                    # this out when it's assigned to the alpha channel below.\r\n+                    output_alpha = 255 if A.dtype == np.uint8 else 1.0\r\n+                else:\r\n+                    output_alpha = _resample(  # resample alpha channel\r\n+                        self, A[..., 3], out_shape, t, alpha=alpha)\r\n                 output = _resample(  # resample rgb channels\r\n                     self, _rgb_to_rgba(A[..., :3]), out_shape, t, alpha=alpha)\r\n                 output[..., 3] = output_alpha  # recombine rgb and alpha\r\n```\r\nwhich cuts the time in half again. Removing the second one would require some spelunking into the image extension, though I'm not sure it's possible as it also cuts in Agg as well.\n@QuLogic Thanks for working on this.\r\n\r\nYour patch gives me the following error:\r\n```\r\nFile \"..........\\lib\\site-packages\\matplotlib\\image.py\", line 207, in _resample\r\n    _image.resample(data, out, transform,\r\nValueError: If 3D, input and output arrays must be RGBA with shape (M, N, 4); got trailing dimensions of 3 and 3 respectively\r\n```\nSorry. Retract that.  My error in applying the diff.  That does indeed help\nHowever, even with that patch, version 3.8.2 is, still 2.5 times slower than 2.2.2.\nFWIW, `_rgb_to_rgba` has not been touched since it was added in 2.0. Hence, the different run-times is a bit strange (unless there are different underlying datatypes or NumPy has done something drastic...).\r\n\r\nThe second major time consumer seems to be `_image.resample`, but that code seems mainly untouched as well, primarily a bit of type refactoring for 3.8. \r\n\r\nAnyway, for 3.9, the wrapper code is moved to pybind11, which hopefully should not degrade the performance further if nothing else...\n@oscasgus I had similarly compared the code bases and did not see major differences.  I have also done some testing with NumPy 1.19 vs 1.26, which are the relevant versions for my installs, and could not uncover a cause there either.  \r\n\r\nI am little suspicious that it may have to do with memory allocation.  I have profiled using memory_profiler for 2.2.2 and 3.8.2 as shown in these images\r\n![2 2 2](https://github.com/matplotlib/matplotlib/assets/4304514/5c23ef8d-b9cf-4d78-a926-423b4c853631)\r\n![3 8 2](https://github.com/matplotlib/matplotlib/assets/4304514/f035cf71-fa46-4115-9475-334c001f83de)\r\n\r\nHere is the line level trace for 2.2.2\r\n```\r\nLine #    Mem usage    Increment  Occurrences   Line Contents\r\n=============================================================\r\n    15 2501.785 MiB 2501.785 MiB           1   @profile\r\n    16                                         def zoom():\r\n    17                                                 global ax, fig , border\r\n    18 2501.785 MiB    0.000 MiB           1           border = 0 if border == SIZE /4 else SIZE /4\r\n    19 2501.785 MiB    0.000 MiB           1           ax.set_xlim(border, SIZE - border)\r\n    20 2501.785 MiB    0.000 MiB           1           ax.set_ylim(border, SIZE - border)\r\n    21 2501.785 MiB    0.000 MiB           1           t1= time.process_time()\r\n    22 1772.469 MiB -729.316 MiB           1           fig.canvas.draw()\r\n    23 1772.473 MiB    0.004 MiB           1           print(\"Draw time:\", time.process_time() - t1)\r\n```\r\nAnd the line level trace for 3.8,2\r\n```\r\nLine #    Mem usage    Increment  Occurrences   Line Contents\r\n=============================================================\r\n    15 1772.359 MiB 1772.359 MiB           1   @profile\r\n    16                                         def zoom():\r\n    17                                                 global ax, fig , border\r\n    18 1772.359 MiB    0.000 MiB           1           border = 0 if border == SIZE /4 else SIZE /4\r\n    19 1772.359 MiB    0.000 MiB           1           ax.set_xlim(border, SIZE - border)\r\n    20 1772.359 MiB    0.000 MiB           1           ax.set_ylim(border, SIZE - border)\r\n    21 1772.359 MiB    0.000 MiB           1           t1= time.process_time()\r\n    22 1776.109 MiB    3.750 MiB           1           fig.canvas.draw()\r\n    23 1776.113 MiB    0.004 MiB           1           print(\"Draw time:\", time.process_time() - t1)\r\n```\r\nIt appears to me that with version 2.2.2, more memory is allocated to the image artist before the draw is called and that this memory is released after the draw completes.  With 3.8.2 it appears that the artist has less memory allocated before the draw and that it has to allocate more during the draw process, which therefore takes more time.\r\n\r\nHoping this might provide some additional clues?\nI am pursuing threads that I don't really understand, so I hope this is not distracting from the core issue, but one thing that interests me is that in [Issue 4567](https://github.com/matplotlib/matplotlib/issues/4567) it is suggested that no copy of the image data is made and yet in [image.py at line 686](https://github.com/matplotlib/matplotlib/blob/e5a85f960b2d47eac371cff709b830d52c36d267/lib/matplotlib/image.py#L686) a call is made to safe_masked_invalid that overrides copy=False to make a copy.\r\n\r\nWhile this seems like this may be an issue, even removing this check completely does not seem to have any effect on the issue I reported here, but I thought I should raise it in case it sheds any light on the matter.\nA quick note about memory. IIRC, a decision at one point was made to move\r\nfrom float64 to float32 for some internal image processing operations and\r\ndata representation. Mainly because matplotlib did not need that much color\r\ndepth representation.\r\n\r\nOn Fri, Dec 22, 2023 at 11:20\u202fAM ilopata1 ***@***.***> wrote:\r\n\r\n> I am pursuing threads that I don't really understand, so I hope this is\r\n> not distracting from the core issue, but one thing that interests me is\r\n> that in Issue 4567 <https://github.com/matplotlib/matplotlib/issues/4567>\r\n> it is suggested that no copy of the image data is made and yet in image.py\r\n> at line 686\r\n> <https://github.com/matplotlib/matplotlib/blob/e5a85f960b2d47eac371cff709b830d52c36d267/lib/matplotlib/image.py#L686>\r\n> a call is made to safe_masked_invalid that overrides copy=False to make a\r\n> copy.\r\n>\r\n> While this seems like this may be an issue, even removing this check\r\n> completely does not seem to have any effect on the issue I reported here,\r\n> but I thought I should raise it in case it sheds any light on the matter.\r\n>\r\n> \u2014\r\n> Reply to this email directly, view it on GitHub\r\n> <https://github.com/matplotlib/matplotlib/issues/27554#issuecomment-1867863427>,\r\n> or unsubscribe\r\n> <https://github.com/notifications/unsubscribe-auth/AACHF6BENKOLZ265RPJDNBDYKWXL7AVCNFSM6AAAAABA6QIQXGVHI2DSMVQWIX3LMV43OSLTON2WKQ3PNVWWK3TUHMYTQNRXHA3DGNBSG4>\r\n> .\r\n> You are receiving this because you are subscribed to this thread.Message\r\n> ID: ***@***.***>\r\n>\r\n\nThanks a lot for the reproducible example.  \r\n\r\nIf I change the call to \r\n`image = ax.imshow(random_image, interpolation='nearest', interpolation_stage='rgba')`\r\nI still get pretty slow speeds (3s on my machine per draw). (I changed it to this because the code is much simpler).  \r\n\r\nIf I remove the song and dance with alpha from \r\nhttps://github.com/matplotlib/matplotlib/blob/e5a85f960b2d47eac371cff709b830d52c36d267/lib/matplotlib/image.py#L560-L565\r\nthen the speed is much faster at 1.4 s or so, which is what I get for 2.2.2.  So I think QuLogic's idea above is sound, and thats probably the best we can do.  \nThank you all for you interest, help and support.  I think we can consider this closed.  My only outstanding question is whether QuLogic's code might get merged or whether I will need to maintain this as a patch for my own use?", "created_at": "2023-12-23T09:43:36Z"}
{"repo": "matplotlib/matplotlib", "pull_number": 27441, "instance_id": "matplotlib__matplotlib-27441", "issue_numbers": ["0000", "27383"], "base_commit": "bc1c5cc3be6972a3ca2485b6cb6db049e130a469", "patch": "diff --git a/galleries/examples/statistics/hexbin_demo.py b/galleries/examples/statistics/hexbin_demo.py\nindex 4bd0e0401424..b9a6206a934f 100644\n--- a/galleries/examples/statistics/hexbin_demo.py\n+++ b/galleries/examples/statistics/hexbin_demo.py\n@@ -29,7 +29,7 @@\n hb = ax1.hexbin(x, y, gridsize=50, bins='log', cmap='inferno')\n ax1.set(xlim=xlim, ylim=ylim)\n ax1.set_title(\"With a log color scale\")\n-cb = fig.colorbar(hb, ax=ax1, label='log10(N)')\n+cb = fig.colorbar(hb, ax=ax1, label='counts')\n \n plt.show()\n \ndiff --git a/lib/matplotlib/axes/_axes.py b/lib/matplotlib/axes/_axes.py\nindex da22d5366479..6a9353f45146 100644\n--- a/lib/matplotlib/axes/_axes.py\n+++ b/lib/matplotlib/axes/_axes.py\n@@ -5103,10 +5103,10 @@ def reduce_C_function(C: array) -> float\n             )\n \n         # Set normalizer if bins is 'log'\n-        if bins == 'log':\n+        if cbook._str_equal(bins, 'log'):\n             if norm is not None:\n                 _api.warn_external(\"Only one of 'bins' and 'norm' arguments \"\n-                                   f\"can be supplied, ignoring bins={bins}\")\n+                                   f\"can be supplied, ignoring {bins=}\")\n             else:\n                 norm = mcolors.LogNorm(vmin=vmin, vmax=vmax)\n                 vmin = vmax = None\n", "test_patch": "diff --git a/lib/matplotlib/tests/test_axes.py b/lib/matplotlib/tests/test_axes.py\nindex d5424f80c9e9..836485b434e5 100644\n--- a/lib/matplotlib/tests/test_axes.py\n+++ b/lib/matplotlib/tests/test_axes.py\n@@ -962,17 +962,18 @@ def test_hexbin_extent():\n     ax.hexbin(\"x\", \"y\", extent=[.1, .3, .6, .7], data=data)\n \n \n-@image_comparison(['hexbin_empty.png', 'hexbin_empty.png'], remove_text=True)\n+@image_comparison(['hexbin_empty.png'], remove_text=True)\n def test_hexbin_empty():\n     # From #3886: creating hexbin from empty dataset raises ValueError\n     fig, ax = plt.subplots()\n     ax.hexbin([], [])\n-    fig, ax = plt.subplots()\n     # From #23922: creating hexbin with log scaling from empty\n     # dataset raises ValueError\n     ax.hexbin([], [], bins='log')\n     # From #27103: np.max errors when handed empty data\n     ax.hexbin([], [], C=[], reduce_C_function=np.max)\n+    # No string-comparison warning from NumPy.\n+    ax.hexbin([], [], bins=np.arange(10))\n \n \n def test_hexbin_pickable():\n", "problem_statement": "[Bug]: Error in Hexbin plot in Matplotlib 3.0 onward\n### Bug summary\n\n First, I would like to thank you for creating a wonderful matplotlib for data visualization. \r\n\r\nI am writing to inform you about problems in hexbin plot in the Matplotlib 3.0 onward. When I was working on my data analysis, I noticed something was wrong when we plotted the distribution of the bin in the log scale.  Moreover, the hexbin plot is correct in the previous version of the matplotlib 2.2.5.  \r\n\r\nI've attached the files of the same. You can clearly observe that the main error is when we plot the bins in log scale. I hope you will look into the problem and update it accordingly. \r\n\r\n![hexplot_matplotlib3 10](https://github.com/matplotlib/matplotlib/assets/66845821/63eeb554-ab1c-4764-baac-cbe545ec56e6)\r\n![hexplot_matplotlib2 2 5](https://github.com/matplotlib/matplotlib/assets/66845821/89f04ff2-2533-484b-83a2-07646e971851)\r\n\n\n### Code for reproduction\n\n```python\nno code is available\n```\n\n\n### Actual outcome\n\nNA\n\n### Expected outcome\n\nNA\n\n### Additional information\n\n_No response_\n\n### Operating system\n\nWindows\n\n### Matplotlib Version\n\n3.8.2\n\n### Matplotlib Backend\n\n_No response_\n\n### Python version\n\npython 3\n\n### Jupyter version\n\n_No response_\n\n### Installation\n\nconda\n", "hints_text": "This was actually incorrect prior to version 3.5:\r\n\r\nhttps://matplotlib.org/3.5.3/api/prev_api_changes/api_changes_3.5.0.html#hexbin-with-a-log-norm\r\n\r\nWe had been adding 1 so every bin had a value, but 0 cannot be displayed on a logarithmically scaled colormap, so now it has no value (and thus are not displayed if zero). We no longer incorrectly add 1.\r\n\r\nThere was some changes during the early 3.8 series to the boundary conditions of hexbin, but default behavior should be what it used to be as of 3.8.2 (and more consistent with different modes of calling hexbin overall).\nHi,\r\nI understand the problem with zero in the log scale.\r\n\r\n\r\nMy concern is with the color bar labeling and scaling. The hexbin plot in\r\nmatplotbin2.2.5 looks okay. The hexbin says log scale means values are\r\ntaken log10(var), not the log10(var) with log scaling of colorbar, which is\r\npresent in matplotlib 3.0 onward version.\r\n\r\n\r\n*Example:* See the left plot where the color bar displays bin count. Let's\r\nsay the bin count is 500, then log10(500) = 2.69, which is expected to be\r\nshown in the colorbar (see plots for hexbin plot for matplotlib 2.2.5).\r\nUnfortunately, in the latex version of matplotlib, the value and colorbar\r\nare different.\r\n\r\n\r\nPlease clarify it for me. And do the necessary update.\r\n\r\nBest wishes,\r\nZubair Shaikh\r\n----------------------------------------------------------\r\n\r\n*Dr. Zubair Ibrahim Shaikh,*\r\n*Postdoctoral Researcher,Space Sciences Laboratory (SSL),*\r\n*University of California**, Berkeley,*\r\n*7 Gauss Way, CA 94720, USA*\r\n\r\n*email:* ***@***.*** ***@***.***>u*\r\n*website: **https://sites.google.com/view/shaikhzubair/\r\n<https://sites.google.com/view/shaikhzubair/>*\r\n*Orcid: https://orcid.org/0000-0002-9206-632\r\n<https://orcid.org/0000-0002-9206-6327>7*\r\n-------------------------------------------------------------------------\r\n\r\n\r\nOn Mon, Nov 27, 2023 at 5:08\u202fPM Kyle Sunden ***@***.***>\r\nwrote:\r\n\r\n> This was actually incorrect prior to version 3.5:\r\n>\r\n>\r\n> https://matplotlib.org/3.5.3/api/prev_api_changes/api_changes_3.5.0.html#hexbin-with-a-log-norm\r\n>\r\n> We had been adding 1 so every bin had a value, but 0 cannot be displayed\r\n> on a logarithmically scaled colormap, so now it has no value (and thus are\r\n> not displayed if zero). We no longer incorrectly add 1.\r\n>\r\n> There was some changes during the early 3.8 series to the boundary\r\n> conditions of hexbin, but default behavior should be what it used to be as\r\n> of 3.8.2 (and more consistent with different modes of calling hexbin\r\n> overall).\r\n>\r\n> \u2014\r\n> Reply to this email directly, view it on GitHub\r\n> <https://github.com/matplotlib/matplotlib/issues/27383#issuecomment-1828900038>,\r\n> or unsubscribe\r\n> <https://github.com/notifications/unsubscribe-auth/AP57Y7LRJSNCT4UBVUNSG7LYGU2R5AVCNFSM6AAAAAA74XVJYCVHI2DSMVQWIX3LMV43OSLTON2WKQ3PNVWWK3TUHMYTQMRYHEYDAMBTHA>\r\n> .\r\n> You are receiving this because you authored the thread.Message ID:\r\n> ***@***.***>\r\n>\r\n\nI agree that the label on the colorbar should be updated.\r\n\r\nAt some point we went from having to \"manually\" do the log scale to the color mapping / normalization machinery doing it for us.\nThank you for understanding the problem.\r\nI hope you will update it soon.\r\n\r\nBest wishes,\r\nZubair Shaikh\r\n----------------------------------------------------------\r\n\r\n*Dr. Zubair Ibrahim Shaikh,*\r\n*Postdoctoral Researcher,Space Sciences Laboratory (SSL),*\r\n*University of California**, Berkeley,*\r\n*7 Gauss Way, CA 94720, USA*\r\n\r\n*email:* ***@***.*** ***@***.***>u*\r\n*website: **https://sites.google.com/view/shaikhzubair/\r\n<https://sites.google.com/view/shaikhzubair/>*\r\n*Orcid: https://orcid.org/0000-0002-9206-632\r\n<https://orcid.org/0000-0002-9206-6327>7*\r\n-------------------------------------------------------------------------\r\n\r\n\r\nOn Mon, Dec 4, 2023 at 9:15\u202fAM Thomas A Caswell ***@***.***>\r\nwrote:\r\n\r\n> I agree that the label on the colorbar should be updated.\r\n>\r\n> At some point we went from having to \"manually\" do the log scale to the\r\n> color mapping / normalization machinery doing it for us.\r\n>\r\n> \u2014\r\n> Reply to this email directly, view it on GitHub\r\n> <https://github.com/matplotlib/matplotlib/issues/27383#issuecomment-1839107926>,\r\n> or unsubscribe\r\n> <https://github.com/notifications/unsubscribe-auth/AP57Y7K5Q2227K23ZOZO73LYHYAM5AVCNFSM6AAAAAA74XVJYCVHI2DSMVQWIX3LMV43OSLTON2WKQ3PNVWWK3TUHMYTQMZZGEYDOOJSGY>\r\n> .\r\n> You are receiving this because you authored the thread.Message ID:\r\n> ***@***.***>\r\n>\r\n\n### Good first issue - notes for new contributors\n\nThis issue is suited to new contributors because it does not require understanding of the Matplotlib internals. To get started, please see our [contributing guide](https://matplotlib.org/stable/devel/index).\n\n**We do not assign issues**. Check the *Development* section in the sidebar for linked pull requests (PRs). If there are none, feel free to start working on it. If there is an open PR, please collaborate on the work by reviewing it rather than duplicating it in a competing PR.\n\nIf something is unclear, please reach out on any of our [communication channels](https://matplotlib.org/stable/devel/contributing.html#get-connected).\nThe relevant change here was #9223, I believe.", "created_at": "2023-12-05T05:23:50Z"}
{"repo": "matplotlib/matplotlib", "pull_number": 27405, "instance_id": "matplotlib__matplotlib-27405", "issue_numbers": ["27399", "0000"], "base_commit": "e32cc6c71cf72c1416a19d03e1026fd2e7bd7d8b", "patch": "diff --git a/lib/matplotlib/axes/_axes.py b/lib/matplotlib/axes/_axes.py\nindex 2136ecb2eb94..90faa2ffab18 100644\n--- a/lib/matplotlib/axes/_axes.py\n+++ b/lib/matplotlib/axes/_axes.py\n@@ -3682,6 +3682,11 @@ def apply_mask(arrays, mask):\n                     f\"'{dep_axis}err' (shape: {np.shape(err)}) must be a \"\n                     f\"scalar or a 1D or (2, n) array-like whose shape matches \"\n                     f\"'{dep_axis}' (shape: {np.shape(dep)})\") from None\n+            if err.dtype is np.dtype(object) and np.any(err == None):  # noqa: E711\n+                raise ValueError(\n+                    f\"'{dep_axis}err' must not contain None. \"\n+                    \"Use NaN if you want to skip a value.\")\n+\n             res = np.zeros(err.shape, dtype=bool)  # Default in case of nan\n             if np.any(np.less(err, -err, out=res, where=(err == err))):\n                 # like err<0, but also works for timedelta and nan.\n", "test_patch": "diff --git a/lib/matplotlib/tests/test_axes.py b/lib/matplotlib/tests/test_axes.py\nindex dffbb2377a23..d5424f80c9e9 100644\n--- a/lib/matplotlib/tests/test_axes.py\n+++ b/lib/matplotlib/tests/test_axes.py\n@@ -4127,6 +4127,20 @@ def test_xerr_yerr_not_negative():\n                     yerr=datetime.timedelta(days=-10))\n \n \n+def test_xerr_yerr_not_none():\n+    ax = plt.figure().subplots()\n+\n+    with pytest.raises(ValueError,\n+                       match=\"'xerr' must not contain None\"):\n+        ax.errorbar(x=[0], y=[0], xerr=[[None], [1]], yerr=[[None], [1]])\n+    with pytest.raises(ValueError,\n+                       match=\"'xerr' must not contain None\"):\n+        ax.errorbar(x=[0], y=[0], xerr=[[None], [1]])\n+    with pytest.raises(ValueError,\n+                       match=\"'yerr' must not contain None\"):\n+        ax.errorbar(x=[0], y=[0], yerr=[[None], [1]])\n+\n+\n @check_figures_equal()\n def test_errorbar_every(fig_test, fig_ref):\n     x = np.linspace(0, 1, 15)\n", "problem_statement": "[Bug]: None in y or yerr arrays leads to TypeError when using errorbar\n### Bug summary\n\nWhen an element in the `y` or `yerr` arrays in `None` when using `errorbar`, a `TypeError` is raised.\n\n### Code for reproduction\n\n```python\nimport matplotlib.pyplot as plt\r\n\r\n# passes\r\na = [1,2,None]\r\nb = [0.1,0.2,0.3]\r\n\r\nplt.plot(a,b)\r\nplt.show()\r\nplt.close()\r\n\r\n# passes\r\na = [1,2,3]\r\nb = [0.1,0.2,None]\r\n\r\nplt.plot(a,b)\r\nplt.show()\r\nplt.close()\r\n\r\n# passes\r\na = [1,2,None]\r\nb = [0.1,0.2,0.3]\r\nberr = [0.04, 0.04, 0.04]\r\n\r\nplt.errorbar(a,b,yerr=berr)\r\nplt.show()\r\nplt.close()\r\n\r\n# fails\r\na = [1,2,3]\r\nb = [0.1,0.2,0.3]\r\nberr = [0.04, 0.04, None]\r\n\r\nplt.errorbar(a,b,yerr=berr)\r\nplt.show()\r\nplt.close()\r\n\r\n# fails\r\na = [1,2,3]\r\nb = [0.1,0.2,None]\r\nberr = [0.04, 0.04, 0.3]\r\n\r\nplt.errorbar(a,b,yerr=berr)\r\nplt.show()\r\nplt.close()\n```\n\n\n### Actual outcome\n\nThree graphs are successfully shown. The fourth one fails with:\r\n```\r\nTraceback (most recent call last):\r\n  File \"<mydirectory>/plot.py\", line 33, in <module>\r\n    plt.errorbar(a,b,yerr=berr)\r\n  File \"<mypythonpackagesdirectory>/matplotlib/pyplot.py\", line 2564, in errorbar\r\n    return gca().errorbar(\r\n           ^^^^^^^^^^^^^^^\r\n  File \"<mypythonpackagesdirectory>/matplotlib/__init__.py\", line 1446, in inner\r\n    return func(ax, *map(sanitize_sequence, args), **kwargs)\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"<mypythonpackagesdirectory>/matplotlib/axes/_axes.py\", line 3634, in errorbar\r\n    if np.any(np.less(err, -err, out=res, where=(err == err))):\r\n                           ^^^^\r\nTypeError: bad operand type for unary -: 'NoneType'\r\n```\n\n### Expected outcome\n\nI understand that there might not be a right outcome here but maybe, as done with `plt.plot`, a point where any of the `x`, `y`, `yerr` items are `None`, could simply not be plotted.\n\n### Additional information\n\n_No response_\n\n### Operating system\n\n_No response_\n\n### Matplotlib Version\n\n3.7.2\n\n### Matplotlib Backend\n\n_No response_\n\n### Python version\n\n3.11.4\n\n### Jupyter version\n\n_No response_\n\n### Installation\n\npip\n", "hints_text": "In general, the way to skip values in Matplotlib is to use NaN, so `np.nan` or `float('NaN')`, which should solve your issue short-term.\r\n\r\nOne can discuss how this should be handled though. Here, the error comes from checking that the errors does not contain negative values. `None` is clearly not a negative value and the way the code is written is to deal with timedelta and nan in a correct way. It should be possible to update the code to also ignore `None` (which may break something later on, but that remains to be seen).\nI checked this quickly and removing the check makes it now die on https://github.com/matplotlib/matplotlib/blob/88e4a4333fd36063dc04935891e228d65f5bb5cb/lib/matplotlib/axes/_axes.py#L3694\r\ntrying to multiply int and None.\r\n\r\nI see two options:\r\n1. Check for `None` in `err` and error with a better message (saying that `nan` should be used)\r\n2. Convert `None` to `nan`\r\n\r\n", "created_at": "2023-11-30T11:29:45Z"}
{"repo": "matplotlib/matplotlib", "pull_number": 27362, "instance_id": "matplotlib__matplotlib-27362", "issue_numbers": ["26593", "0000"], "base_commit": "02489d4002e7d46712ac51694ceb568673fc61ff", "patch": "diff --git a/lib/matplotlib/figure.py b/lib/matplotlib/figure.py\nindex cd26af84ccbe..11b42b1e1ac7 100644\n--- a/lib/matplotlib/figure.py\n+++ b/lib/matplotlib/figure.py\n@@ -1577,6 +1577,7 @@ def add_subfigure(self, subplotspec, **kwargs):\n         \"\"\"\n         sf = SubFigure(self, subplotspec, **kwargs)\n         self.subfigs += [sf]\n+        sf._remove_method = self.subfigs.remove\n         return sf\n \n     def sca(self, a):\n", "test_patch": "diff --git a/lib/matplotlib/tests/test_figure.py b/lib/matplotlib/tests/test_figure.py\nindex 6d6a3d772f4e..24d4f1c0f059 100644\n--- a/lib/matplotlib/tests/test_figure.py\n+++ b/lib/matplotlib/tests/test_figure.py\n@@ -1482,6 +1482,13 @@ def test_subfigures_wspace_hspace():\n     np.testing.assert_allclose(sub_figs[1, 2].bbox.max, [w, h * 0.4])\n \n \n+def test_subfigure_remove():\n+    fig = plt.figure()\n+    sfs = fig.subfigures(2, 2)\n+    sfs[1, 1].remove()\n+    assert len(fig.subfigs) == 3\n+\n+\n def test_add_subplot_kwargs():\n     # fig.add_subplot() always creates new axes, even if axes kwargs differ.\n     fig = plt.figure()\n", "problem_statement": "[ENH]: Support SubFigure.remove()\n### Problem\n\nCurrently SubFigures cannot be remove()d from the parent figure.  The API would be more consistent if that was possible.\n\n### Proposed solution\n\nImplement SubFigure.remove().\n", "hints_text": "Hi, can you explain with details what this new feature would be able to do? maybe a sample code to show what were you trying to do\n`sfig.remove()` would remove the subfigure and all its children from the figure.   Note that our removal machinery is non-trivial, but doing something similar as what is done for axes should work.  I'm not 100% sure how the tree gets traversed. \r\n\r\nIf someone works on this, it would be nice to write up your notes so we can document how `remove` is meant to work. ", "created_at": "2023-11-22T22:04:20Z"}
{"repo": "matplotlib/matplotlib", "pull_number": 27360, "instance_id": "matplotlib__matplotlib-27360", "issue_numbers": ["27329", "0000"], "base_commit": "02489d4002e7d46712ac51694ceb568673fc61ff", "patch": "diff --git a/lib/matplotlib/colorbar.py b/lib/matplotlib/colorbar.py\nindex b54211654d13..920c0d67722a 100644\n--- a/lib/matplotlib/colorbar.py\n+++ b/lib/matplotlib/colorbar.py\n@@ -1035,14 +1035,11 @@ def remove(self):\n         except AttributeError:\n             return\n         try:\n-            gs = ax.get_subplotspec().get_gridspec()\n-            subplotspec = gs.get_topmost_subplotspec()\n-        except AttributeError:\n-            # use_gridspec was False\n+            subplotspec = self.ax.get_subplotspec().get_gridspec()._subplot_spec\n+        except AttributeError:  # use_gridspec was False\n             pos = ax.get_position(original=True)\n             ax._set_position(pos)\n-        else:\n-            # use_gridspec was True\n+        else:  # use_gridspec was True\n             ax.set_subplotspec(subplotspec)\n \n     def _process_values(self):\n", "test_patch": "diff --git a/lib/matplotlib/tests/test_colorbar.py b/lib/matplotlib/tests/test_colorbar.py\nindex 0cf098e787ee..509d08dae183 100644\n--- a/lib/matplotlib/tests/test_colorbar.py\n+++ b/lib/matplotlib/tests/test_colorbar.py\n@@ -279,13 +279,16 @@ def test_colorbar_single_scatter():\n     plt.colorbar(cs)\n \n \n-@pytest.mark.parametrize('use_gridspec', [False, True],\n-                         ids=['no gridspec', 'with gridspec'])\n-def test_remove_from_figure(use_gridspec):\n-    \"\"\"\n-    Test `remove` with the specified ``use_gridspec`` setting\n-    \"\"\"\n-    fig, ax = plt.subplots()\n+@pytest.mark.parametrize('use_gridspec', [True, False])\n+@pytest.mark.parametrize('nested_gridspecs', [True, False])\n+def test_remove_from_figure(nested_gridspecs, use_gridspec):\n+    \"\"\"Test `remove` with the specified ``use_gridspec`` setting.\"\"\"\n+    fig = plt.figure()\n+    if nested_gridspecs:\n+        gs = fig.add_gridspec(2, 2)[1, 1].subgridspec(2, 2)\n+        ax = fig.add_subplot(gs[1, 1])\n+    else:\n+        ax = fig.add_subplot()\n     sc = ax.scatter([1, 2], [3, 4])\n     sc.set_array(np.array([5, 6]))\n     pre_position = ax.get_position()\n@@ -298,9 +301,7 @@ def test_remove_from_figure(use_gridspec):\n \n \n def test_remove_from_figure_cl():\n-    \"\"\"\n-    Test `remove` with constrained_layout\n-    \"\"\"\n+    \"\"\"Test `remove` with constrained_layout.\"\"\"\n     fig, ax = plt.subplots(constrained_layout=True)\n     sc = ax.scatter([1, 2], [3, 4])\n     sc.set_array(np.array([5, 6]))\n", "problem_statement": "[Bug]: Removing a colorbar for an axes positioned in a subgridspec restores the axes' position to the wrong place.\n### Bug summary\n\nDraw an image in an axes in a subgridspec (e.g. generated using nested subplot_mosaic), add a colorbar for that image, and then remove the colorbar.  The image-containing axes will move to the wrong place.\n\n### Code for reproduction\n\n```python\nfrom pylab import *\r\n\r\nfig = figure()\r\naxs = fig.subplot_mosaic([\r\n    [\"A\", \"B\"],\r\n    [\"C\", [[\"d\", \"e\"],\r\n           [\"f\", \"g\"]]]\r\n])\r\nim = axs[\"g\"].imshow([[1, 2]])\r\ncb = fig.colorbar(im)\r\ncb.remove()\r\nshow()\n```\n\n\n### Actual outcome\n\n![bad](https://github.com/matplotlib/matplotlib/assets/1322974/b8495fb8-bade-4d10-8f9b-59acf001363a)\r\n\n\n### Expected outcome\n\n![good](https://github.com/matplotlib/matplotlib/assets/1322974/e5a55d28-78a9-4125-8dce-cc62db4b97d7)\r\n\n\n### Additional information\n\nThis basically arises because the colorbar-removal-axes-restoring (Colorbar.remove) code uses get_topmost_subplotspec, which indiscriminately climbs up the entire nested gridspec tree.  Instead it should just climb up the correct number of levels to find the subplotspec where the axes should be restored.  (I'm not actually convinced that there are so many legitimate uses for get_topmost_subplotspec, and perhaps that function should be deprecated; likely all uses will fail if gridspecs are more nested than expected.)\r\n\r\nThe bug occurs even if using constrained_layout, which doesn't mess with gridspecs when placing colorbars, as Colorbar.remove actually checks the gridspec of ax, not the one of the colorbar axes cax.\n\n### Operating system\n\nmacos\n\n### Matplotlib Version\n\n3.8.1 or HEAD\n\n### Matplotlib Backend\n\nqtagg\n\n### Python version\n\n3.12\n\n### Jupyter version\n\nenosuchlib\n\n### Installation\n\nNone\n", "hints_text": "", "created_at": "2023-11-22T13:45:15Z"}
{"repo": "matplotlib/matplotlib", "pull_number": 27334, "instance_id": "matplotlib__matplotlib-27334", "issue_numbers": ["27333", "0000"], "base_commit": "b16031ce6f711b8c80c2122886b9b43149a0971f", "patch": "diff --git a/lib/matplotlib/contour.py b/lib/matplotlib/contour.py\nindex d3ae83c613b1..7404151e7699 100644\n--- a/lib/matplotlib/contour.py\n+++ b/lib/matplotlib/contour.py\n@@ -1339,15 +1339,18 @@ def _find_nearest_contour(self, xy, indices=None):\n \n         for idx_level in indices:\n             path = self._paths[idx_level]\n-            if not len(path.vertices):\n-                continue\n-            lc = self.get_transform().transform(path.vertices)\n-            d2, proj, leg = _find_closest_point_on_path(lc, xy)\n-            if d2 < d2min:\n-                d2min = d2\n-                idx_level_min = idx_level\n-                idx_vtx_min = leg[1]\n-                proj_min = proj\n+            idx_vtx_start = 0\n+            for subpath in path._iter_connected_components():\n+                if not len(subpath.vertices):\n+                    continue\n+                lc = self.get_transform().transform(subpath.vertices)\n+                d2, proj, leg = _find_closest_point_on_path(lc, xy)\n+                if d2 < d2min:\n+                    d2min = d2\n+                    idx_level_min = idx_level\n+                    idx_vtx_min = leg[1] + idx_vtx_start\n+                    proj_min = proj\n+                idx_vtx_start += len(subpath)\n \n         return idx_level_min, idx_vtx_min, proj_min\n \n", "test_patch": "diff --git a/lib/matplotlib/tests/test_contour.py b/lib/matplotlib/tests/test_contour.py\nindex db8ef03925cd..f79584be4086 100644\n--- a/lib/matplotlib/tests/test_contour.py\n+++ b/lib/matplotlib/tests/test_contour.py\n@@ -125,6 +125,25 @@ def test_contour_manual_labels(split_collections):\n     plt.clabel(cs, manual=pts, fontsize='small', colors=('r', 'g'))\n \n \n+def test_contour_manual_moveto():\n+    x = np.linspace(-10, 10)\n+    y = np.linspace(-10, 10)\n+\n+    X, Y = np.meshgrid(x, y)\n+\n+    Z = X**2 * 1 / Y**2 - 1\n+\n+    contours = plt.contour(X, Y, Z, levels=[0, 100])\n+\n+    # This point lies on the `MOVETO` line for the 100 contour\n+    # but is actually closest to the 0 contour\n+    point = (1.3, 1)\n+    clabels = plt.clabel(contours, manual=[point])\n+\n+    # Ensure that the 0 contour was chosen, not the 100 contour\n+    assert clabels[0].get_text() == \"0\"\n+\n+\n @pytest.mark.parametrize(\"split_collections\", [False, True])\n @image_comparison(['contour_disconnected_segments'],\n                   remove_text=True, style='mpl20', extensions=['png'])\n", "problem_statement": "[Bug]: Spurious lines added with some manually add contour labels\n### Bug summary\n\nWith Matplotlib 3.8+ I'm seeing spurious lines that get added with manually labeled contours via `clabel`.\r\n\r\nIt seems to only happen in locations where the contours are more complex or near those areas, but I haven't been able to track down why this happens.  \n\n### Code for reproduction\n\n```python\nExample code (here working with Matplotlib <3.8): https://geocat-examples.readthedocs.io/en/latest/gallery/Contours/NCL_coneff_8.html\r\n\r\nI'll work on stripping down this example though.\n```\n\n\n### Actual outcome\n\nwhen run in a script that provided a manual list of contour label locations:\r\n<img width=\"623\" alt=\"Screen Shot 2023-11-15 at 3 17 14 PM\" src=\"https://github.com/matplotlib/matplotlib/assets/7872563/a5815b2f-3160-4f10-a9ac-03894c203314\">\r\n\r\nwhen locations were manually clicked:\r\n<img width=\"763\" alt=\"Screen Shot 2023-11-15 at 3 21 19 PM\" src=\"https://github.com/matplotlib/matplotlib/assets/7872563/10f083da-5845-46a0-98ea-c6eb47371d23\">\r\n\r\n\n\n### Expected outcome\n\nsimilar, but without the spurious straight lines.\n\n### Additional information\n\nWhat are the conditions under which this bug happens?\r\n* happens with both \"clicked\" and specified manual contour labels in certain locations\r\n* seems to happen only near areas with more complex contours\r\n* interestingly, this also happens when you specify contour label locations this way on a cartopy map and the specified points are not on the projected map.  however, this is not the case here.\r\nHas this worked in earlier versions?\r\n* worked prior to 3.8\r\nDo you know why this bug is happening?\r\n* unfortunately, no.  will look into it a bit more though.\r\n\n\n### Operating system\n\nOS/X\n\n### Matplotlib Version\n\n3.8.1\n\n### Matplotlib Backend\n\nMacOSX\n\n### Python version\n\nPython 3.11.6\n\n### Jupyter version\n\n4.0.8\n\n### Installation\n\nconda\n", "hints_text": "Do you have a minimal (i.e. mpl + numpy only, preferably) reproducer of this?\r\n\r\nI know that there were some issues in 3.8.0 that seem similar at least, but I _thought_ I fixed them for 3.8.1 in #27045. Are you sure they persist in 3.8.1?\nSorry about that.  \r\n\r\nHere you go:\r\n\r\n```\r\nfrom matplotlib import pyplot as plt\r\nimport numpy as np\r\n\r\nlat = [-87.8638  , -85.09653 , -82.31291 , -79.525604, -76.7369  , -73.94752 ,\r\n       -71.15775 , -68.36776 , -65.57761 , -62.787354, -59.99702 , -57.20663 ,\r\n       -54.4162  , -51.625732, -48.83524 , -46.044727, -43.254196, -40.46365 ,\r\n       -37.673088, -34.882523, -32.091946, -29.30136 , -26.510769, -23.720175,\r\n       -20.929575, -18.138971, -15.348365, -12.557756,  -9.767145,  -6.976533]\r\nplev = [100000,  85000,  70000,  50000,  40000,  30000,  25000,  20000]\r\nu = np.array([[ 5.281284  ,  5.281284  ,  5.281284  ,  5.281284  ,  5.281284  ,\r\n         5.281284  ,  5.281284  ,  5.281284  ,  5.281284  ,  5.281284  ,\r\n         5.281284  ,  5.281284  ,  5.281284  ,  5.281284  ,  4.5694838 ,\r\n         8.355004  ,  8.594497  ,  7.364512  ,  5.3017035 ,  2.8804004 ,\r\n         0.5346078 , -1.9970245 , -4.043903  , -5.495614  , -6.4742966 ,\r\n        -6.86549   , -6.916672  , -6.6135497 , -5.824724  , -4.929174  ],\r\n       [-7.8476605 , -7.8476605 , -7.8476605 , -4.9444113 , -4.6574264 ,\r\n        -4.4306536 , -1.0847874 ,  0.23506624,  2.1887915 ,  6.6546087 ,\r\n        10.182983  , 12.602904  , 14.024249  , 14.453691  , 14.11188   ,\r\n        13.432743  , 12.298697  , 10.441111  ,  8.136927  ,  5.701264  ,\r\n         3.1575031 ,  0.8824925 , -0.8204733 , -2.142562  , -3.2946696 ,\r\n        -4.214696  , -5.014298  , -5.75503   , -5.797411  , -4.7429767 ],\r\n       [-4.7934184 , -3.987672  , -3.880484  , -3.8545942 , -3.400934  ,\r\n        -2.1740034 , -1.4144217 ,  1.8231349 ,  5.741105  ,  9.357849  ,\r\n        12.589281  , 15.095114  , 16.566757  , 17.07177   , 16.893904  ,\r\n        16.211683  , 15.016567  , 13.3146    , 11.277677  ,  9.180042  ,\r\n         7.2710013 ,  5.7038155 ,  4.5025063 ,  3.3811352 ,  1.9761666 ,\r\n         0.17865679, -1.848804  , -3.5658486 , -4.2557425 , -3.6108153 ],\r\n       [-0.6427475 , -1.3300483 , -1.8785819 , -1.8878341 , -1.1554126 ,\r\n         0.2460148 ,  2.640771  ,  5.841252  ,  9.352374  , 12.879071  ,\r\n        16.21606   , 19.04898   , 20.9498    , 21.753773  , 21.649551  ,\r\n        20.907742  , 19.693817  , 18.178251  , 16.707623  , 15.646201  ,\r\n        15.057117  , 14.641205  , 13.846154  , 12.143323  ,  9.386396  ,\r\n         5.9252477 ,  2.368536  , -0.5125828 , -2.0722165 , -2.2778945 ],\r\n       [-0.58929294, -1.2046508 , -1.4544653 , -1.0103273 ,  0.15982199,\r\n         1.9466033 ,  4.447282  ,  7.6771903 , 11.419675  , 15.136187  ,\r\n        18.620575  , 21.717804  , 23.922436  , 24.840185  , 24.701748  ,\r\n        23.987408  , 22.880804  , 21.526987  , 20.463743  , 20.20535   ,\r\n        20.610573  , 20.982576  , 20.493448  , 18.504211  , 14.933222  ,\r\n        10.389049  ,  5.7908807 ,  2.0268278 , -0.2654018 , -1.0479335 ],\r\n       [-0.4088514 , -0.7439224 , -0.6603948 ,  0.0878893 ,  1.6308761 ,\r\n         3.7945688 ,  6.51758   , 10.002526  , 14.048776  , 18.030323  ,\r\n        21.763384  , 25.12306   , 27.494097  , 28.48131   , 28.469887  ,\r\n        27.976196  , 27.148748  , 26.233028  , 25.929998  , 26.776876  ,\r\n        28.395657  , 29.60503   , 29.1222    , 26.262024  , 21.399248  ,\r\n        15.65298   , 10.07546   ,  5.45065   ,  2.312821  ,  0.5890202 ],\r\n       [-0.30047217, -0.4094708 , -0.09946479,  0.78269076,  2.5223484 ,\r\n         4.950463  ,  7.8729997 , 11.537473  , 15.756553  , 19.893959  ,\r\n        23.728504  , 27.066483  , 29.343843  , 30.36043   , 30.488892  ,\r\n        30.099907  , 29.479034  , 29.078144  , 29.513182  , 31.190378  ,\r\n        33.604244  , 35.186615  , 34.35078   , 30.635078  , 24.895414  ,\r\n        18.486992  , 12.361381  ,  7.0874414 ,  3.166243  ,  0.7561427 ],\r\n       [-0.11722137,  0.06281883,  0.64088964,  1.7681435 ,  3.7674735 ,\r\n         6.47419   ,  9.705322  , 13.647254  , 18.064777  , 22.31285   ,\r\n        26.111181  , 29.2265    , 31.215776  , 32.078777  , 32.2106    ,\r\n        31.913328  , 31.606083  , 31.906605  , 33.293755  , 35.880253  ,\r\n        38.87251   , 40.392326  , 38.82986   , 34.17306   , 27.61663   ,\r\n        20.4983    , 13.791601  ,  8.023929  ,  3.5063663 ,  0.5009983 ]])\r\n\r\ncontours = plt.contour(lat,plev,u,\r\n                             levels=13,\r\n                             vmin=-8,\r\n                             vmax=40,\r\n                             colors='black',\r\n                             linewidths=0.5,\r\n                             linestyles='solid')\r\n\r\n# Label the contours\r\nmanual = [(-70, 55000), (-80, 26000), (-58, 30000), (-25, 42000),\r\n          (-45, 69500), (-40, 34000), (-12, 39000), (-37, 75000),\r\n          (-72, 22500)]\r\n\r\nclabels = plt.clabel(contours,\r\n                     fontsize=12,\r\n                     colors=\"black\",\r\n                     fmt=\"%.0f\",\r\n                     manual=manual)\r\n```\r\n\r\nThere were some similar issues in maptlotlib 3.8 that seem to have cleared up now, but this is with 3.8.1\nOkay, what is happening here is that the \"nearest contour\" logic is picking the point along the `MOVETO` line (which isn't drawn), and needs to filter out results with `codes=MOVETO`)\r\n\r\nThe above with a few things drawn:\r\n\r\n```python\r\npath = contours.get_paths()[2]\r\nfullpath = path.deepcopy()\r\nfullpath.codes[1:] = 2\r\nplt.gca().add_artist(mpatches.PathPatch(path, facecolor=\"none\", edgecolor=\"C0\", lw=4))\r\nplt.gca().add_artist(mpatches.PathPatch(fullpath, facecolor=\"none\", edgecolor=\"C3\", lw=2))\r\n\r\nplt.plot([-72], [22500], \"C1o\")\r\n```\r\n\r\nShows that the offending point lies right on the omitted line.\r\n\r\nBlue is the 0 contour, red is the 0 contour with all \"LINETO\" codes in the path (After the first point), orange dot is the requested manual position for the offending contour.\r\n\r\n![Figure_1](https://github.com/matplotlib/matplotlib/assets/2501846/e098c639-72c6-4644-aaf5-81373c37b5ad)\r\n\r\nShould be relatively easy to fix, I think...", "created_at": "2023-11-16T18:23:32Z"}
{"repo": "matplotlib/matplotlib", "pull_number": 27267, "instance_id": "matplotlib__matplotlib-27267", "issue_numbers": ["25691", "0000"], "base_commit": "4524fdbdcabb5e986ad4fd6709ee5e607f3826df", "patch": "diff --git a/lib/matplotlib/axes/_secondary_axes.py b/lib/matplotlib/axes/_secondary_axes.py\nindex 4c757f61c7b6..7ee3c8b13c07 100644\n--- a/lib/matplotlib/axes/_secondary_axes.py\n+++ b/lib/matplotlib/axes/_secondary_axes.py\n@@ -6,6 +6,7 @@\n import matplotlib.ticker as mticker\n from matplotlib.axes._base import _AxesBase, _TransformedBoundsLocator\n from matplotlib.axis import Axis\n+from matplotlib.transforms import Transform\n \n \n class SecondaryAxis(_AxesBase):\n@@ -144,11 +145,17 @@ def set_functions(self, functions):\n             If a transform is supplied, then the transform must have an\n             inverse.\n         \"\"\"\n+\n         if (isinstance(functions, tuple) and len(functions) == 2 and\n                 callable(functions[0]) and callable(functions[1])):\n             # make an arbitrary convert from a two-tuple of functions\n             # forward and inverse.\n             self._functions = functions\n+        elif isinstance(functions, Transform):\n+            self._functions = (\n+                 functions.transform,\n+                 lambda x: functions.inverted().transform(x)\n+            )\n         elif functions is None:\n             self._functions = (lambda x: x, lambda x: x)\n         else:\n", "test_patch": "diff --git a/lib/matplotlib/tests/baseline_images/test_axes/secondary_xy.png b/lib/matplotlib/tests/baseline_images/test_axes/secondary_xy.png\nindex bbf9f9e13211..b69241a06bc6 100644\nBinary files a/lib/matplotlib/tests/baseline_images/test_axes/secondary_xy.png and b/lib/matplotlib/tests/baseline_images/test_axes/secondary_xy.png differ\ndiff --git a/lib/matplotlib/tests/test_axes.py b/lib/matplotlib/tests/test_axes.py\nindex 799bf5ddd774..3ae1a9376ceb 100644\n--- a/lib/matplotlib/tests/test_axes.py\n+++ b/lib/matplotlib/tests/test_axes.py\n@@ -7494,6 +7494,20 @@ def test_annotate_across_transforms():\n                 arrowprops=dict(arrowstyle=\"->\"))\n \n \n+class _Translation(mtransforms.Transform):\n+    input_dims = 1\n+    output_dims = 1\n+\n+    def __init__(self, dx):\n+        self.dx = dx\n+\n+    def transform(self, values):\n+        return values + self.dx\n+\n+    def inverted(self):\n+        return _Translation(-self.dx)\n+\n+\n @image_comparison(['secondary_xy.png'], style='mpl20')\n def test_secondary_xy():\n     fig, axs = plt.subplots(1, 2, figsize=(10, 5), constrained_layout=True)\n@@ -7513,6 +7527,7 @@ def invert(x):\n         secax(0.4, functions=(lambda x: 2 * x, lambda x: x / 2))\n         secax(0.6, functions=(lambda x: x**2, lambda x: x**(1/2)))\n         secax(0.8)\n+        secax(\"top\" if nn == 0 else \"right\", functions=_Translation(2))\n \n \n def test_secondary_fail():\n", "problem_statement": "[Bug]: Secondary axis does not support Transform as functions\n### Bug summary\n\nThe [documentation for `secondary_[xy]axis`](https://matplotlib.org/stable/api/_as_gen/matplotlib.axes.Axes.secondary_xaxis.html#matplotlib.axes.Axes.secondary_xaxis) claims to accept a `Transform` for the `functions` parameter.\r\n\r\nHowever, the checks in `set_functions` do not accept `Transform`:\r\nhttps://github.com/matplotlib/matplotlib/blob/3f4d4c10d40c1c60e9572b5e4702a463e2a06747/lib/matplotlib/axes/_secondary_axes.py#L147-L158\r\n\r\nand any usage of the internal attribute seems to assume a tuple of callables:\r\nhttps://github.com/matplotlib/matplotlib/blob/3f4d4c10d40c1c60e9572b5e4702a463e2a06747/lib/matplotlib/axes/_secondary_axes.py#L193-L194\r\nhttps://github.com/matplotlib/matplotlib/blob/3f4d4c10d40c1c60e9572b5e4702a463e2a06747/lib/matplotlib/axes/_secondary_axes.py#L216\r\n\r\nBoth this documentation and the checks have been in the code since it was added in #11859.\n\n### Code for reproduction\n\n```python\nimport matplotlib.pyplot as plt\r\nfrom matplotlib.transforms import IdentityTransform\r\n\r\nfig, ax = plt.subplots()\r\nsecax = ax.secondary_xaxis('top', functions=IdentityTransform)\r\n# OR:\r\nsecax = ax.secondary_xaxis('top', functions=IdentityTransform())\r\n# OR:\r\nsecax = ax.secondary_xaxis('top', functions=(IdentityTransform, IdentityTransform))\r\n# OR:\r\nsecax = ax.secondary_xaxis('top', functions=(IdentityTransform(), IdentityTransform()))\n```\n\n\n### Actual outcome\n\nWith a single transform (class or object), _or_ a tuple of transform objects, it fails in the setter:\r\n```pytb\r\nTraceback (most recent call last):\r\n  File \"galleries/examples/subplots_axes_and_figures/secondary_axis.py\", line 40, in <module>\r\n    secax = ax.secondary_xaxis('top', functions=IdentityTransform)\r\n  File \"lib/matplotlib/axes/_axes.py\", line 586, in secondary_xaxis\r\n    secondary_ax = SecondaryAxis(self, 'x', location, functions,\r\n  File \"lib/matplotlib/axes/_secondary_axes.py\", line 42, in __init__\r\n    self.set_functions(functions)\r\n  File \"lib/matplotlib/axes/_secondary_axes.py\", line 155, in set_functions\r\n    raise ValueError('functions argument of secondary axes '\r\nValueError: functions argument of secondary axes must be a two-tuple of callable functions with the first function being the transform and the second being the inverse\r\n```\r\nWith a tuple of transform classes, the setter allows it, but it fails when drawing:\r\n```\r\nTraceback (most recent call last):\r\n  File \"lib/matplotlib/backends/backend_qt.py\", line 461, in _draw_idle\r\n    self.draw()\r\n  File \"lib/matplotlib/backends/backend_agg.py\", line 401, in draw\r\n    self.figure.draw(self.renderer)\r\n  File \"lib/matplotlib/artist.py\", line 95, in draw_wrapper\r\n    result = draw(artist, renderer, *args, **kwargs)\r\n  File \"lib/matplotlib/artist.py\", line 72, in draw_wrapper\r\n    return draw(artist, renderer)\r\n  File \"lib/matplotlib/figure.py\", line 3115, in draw\r\n    artists = self._get_draw_artists(renderer)\r\n  File \"lib/matplotlib/figure.py\", line 225, in _get_draw_artists\r\n    child.apply_aspect(\r\n  File \"lib/matplotlib/axes/_secondary_axes.py\", line 120, in apply_aspect\r\n    self._set_lims()\r\n  File \"lib/matplotlib/axes/_secondary_axes.py\", line 216, in _set_lims\r\n    lims = self._functions[0](np.array(lims))\r\n  File \"lib/matplotlib/transforms.py\", line 1759, in __init__\r\n    super().__init__(*args, **kwargs)\r\n  File \"lib/matplotlib/transforms.py\", line 125, in __init__\r\n    self._shorthand_name = shorthand_name or ''\r\nValueError: The truth value of an array with more than one element is ambiguous. Use a.any() or a.all()\r\n```\n\n### Expected outcome\n\nAt least one of the options works, or it should not be documented as accepted.\n\n### Additional information\n\nI noticed this oddity in the types while reviewing #25224, but not sure what we intend here.\n\n### Operating system\n\n_No response_\n\n### Matplotlib Version\n\n3f4d4c10d40c1c60e9572b5e4702a463e2a06747\n\n### Matplotlib Backend\n\n_No response_\n\n### Python version\n\n_No response_\n\n### Jupyter version\n\n_No response_\n\n### Installation\n\ngit checkout\n", "hints_text": "That seems like an oversight, or something that got lost in the shuffle of adding a forward and inverse.  \r\n\r\nI don't think we should allow a tuple of transforms - one of the advantages of using a transform is that it has an inverse?  \n> I don't think we should allow a tuple of transforms - one of the advantages of using a transform is that it has an inverse?\r\n\r\nI don't think it's necessary; it's just something I tried to get past the checks and see if the internals were fine with it.", "created_at": "2023-11-05T00:05:19Z"}
