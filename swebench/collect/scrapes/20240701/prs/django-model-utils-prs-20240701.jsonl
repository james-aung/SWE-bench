{"url": "https://api.github.com/repos/jazzband/django-model-utils/pulls/624", "id": 1916852714, "node_id": "PR_kwDOAAWagc5yQNnq", "html_url": "https://github.com/jazzband/django-model-utils/pull/624", "diff_url": "https://github.com/jazzband/django-model-utils/pull/624.diff", "patch_url": "https://github.com/jazzband/django-model-utils/pull/624.patch", "issue_url": "https://api.github.com/repos/jazzband/django-model-utils/issues/624", "number": 624, "state": "closed", "locked": false, "title": "Remove catching of `AttributeError` in `DescriptorWrapper`", "user": {"login": "mthuurne", "id": 246676, "node_id": "MDQ6VXNlcjI0NjY3Ng==", "avatar_url": "https://avatars.githubusercontent.com/u/246676?v=4", "gravatar_id": "", "url": "https://api.github.com/users/mthuurne", "html_url": "https://github.com/mthuurne", "followers_url": "https://api.github.com/users/mthuurne/followers", "following_url": "https://api.github.com/users/mthuurne/following{/other_user}", "gists_url": "https://api.github.com/users/mthuurne/gists{/gist_id}", "starred_url": "https://api.github.com/users/mthuurne/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/mthuurne/subscriptions", "organizations_url": "https://api.github.com/users/mthuurne/orgs", "repos_url": "https://api.github.com/users/mthuurne/repos", "events_url": "https://api.github.com/users/mthuurne/events{/privacy}", "received_events_url": "https://api.github.com/users/mthuurne/received_events", "type": "User", "site_admin": false}, "body": "## Problem\r\n\r\nI was cleaning up the type annotations in `DescriptorWrapper.__get__()`:\r\n```py\r\n    def __get__(self, instance: models.Model | None, owner: type[models.Model]) -> DescriptorWrapper[T] | T:\r\n        if instance is None:\r\n            return self\r\n        was_deferred = self.field_name in instance.get_deferred_fields()\r\n        try:\r\n            value = self.descriptor.__get__(instance, owner)\r\n        except AttributeError:\r\n            value = self.descriptor\r\n        if was_deferred:\r\n            tracker_instance = getattr(instance, self.tracker_attname)\r\n            tracker_instance.saved_data[self.field_name] = lightweight_deepcopy(value)\r\n        return value\r\n```\r\n\r\nAfter being puzzled by the code for some time, I realized that the `value = self.descriptor` statement was inherently incompatible with the return type of the method. Also storing the descriptor rather than a value in `tracker_instance.saved_data` seems unlikely to be correct.\r\n\r\n## Solution\r\n\r\nI tried to find out when this exception handler runs, but it turned out it is never executed during unit testing.\r\n\r\nDigging deeper, I found that `AbstractModelTrackerTests` was supposed to cover this code, but that test suite was marked as `skip` because it had known test failures. Re-enabling it indeed led to 4 failing test cases, all from `ModelTrackerTests`. The reason for that was simple though: the test model `TrackedAbstract` used a `FieldTracker` rather than a `ModelTracker`. After fixing that, the test suite passed.\r\n\r\nThere used to be a [bug in Django](https://code.djangoproject.com/ticket/30427) that caused these tests to fail, according to the discussion of #370. That bug was fixed in Django 4.0.\r\n\r\nThis exception handler was introduced in #367, but subsequent discussion in #370, #381 and #382 suggests that it wasn't the proper solution. As we now have a working test and that test doesn't cause `AttributeError` to be raised, I think it is safe to remove the `try`/`except`.\r\n\r\n## Commandments\r\n\r\n- [x] Write PEP8 compliant code.\r\n- [x] Cover it with tests.\r\n- [ ] Update `CHANGES.rst` file to describe the changes, and quote according issue with `GH-<issue_number>`.\r\n- [x] Pay attention to backward compatibility, or if it breaks it, explain why.\r\n- [ ] Update documentation (if relevant).\r\n\r\nThis change should be invisible to end users, as it removes dead code. So I think the ChangeLog and docs steps can be skipped, but if you disagree, let me know and I'll update the PR.\r\n", "created_at": "2024-06-12T15:27:18Z", "updated_at": "2024-06-13T09:59:17Z", "closed_at": "2024-06-13T08:58:11Z", "merged_at": "2024-06-13T08:58:11Z", "merge_commit_sha": "e35c72427b0295d400f5228e2ac03ef197e464fd", "assignee": null, "assignees": [], "requested_reviewers": [], "requested_teams": [], "labels": [], "milestone": null, "draft": false, "commits_url": "https://api.github.com/repos/jazzband/django-model-utils/pulls/624/commits", "review_comments_url": "https://api.github.com/repos/jazzband/django-model-utils/pulls/624/comments", "review_comment_url": "https://api.github.com/repos/jazzband/django-model-utils/pulls/comments{/number}", "comments_url": "https://api.github.com/repos/jazzband/django-model-utils/issues/624/comments", "statuses_url": "https://api.github.com/repos/jazzband/django-model-utils/statuses/14cf1b0d40d5538e79e33527a2c13eb59c04893f", "head": {"label": "ProtixIT:DescriptorWrapper-no-catch", "ref": "DescriptorWrapper-no-catch", "sha": "14cf1b0d40d5538e79e33527a2c13eb59c04893f", "user": {"login": "ProtixIT", "id": 120380850, "node_id": "O_kgDOByzdsg", "avatar_url": "https://avatars.githubusercontent.com/u/120380850?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ProtixIT", "html_url": "https://github.com/ProtixIT", "followers_url": "https://api.github.com/users/ProtixIT/followers", "following_url": "https://api.github.com/users/ProtixIT/following{/other_user}", "gists_url": "https://api.github.com/users/ProtixIT/gists{/gist_id}", "starred_url": "https://api.github.com/users/ProtixIT/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ProtixIT/subscriptions", "organizations_url": "https://api.github.com/users/ProtixIT/orgs", "repos_url": "https://api.github.com/users/ProtixIT/repos", "events_url": "https://api.github.com/users/ProtixIT/events{/privacy}", "received_events_url": "https://api.github.com/users/ProtixIT/received_events", "type": "Organization", "site_admin": false}, "repo": {"id": 615058430, "node_id": "R_kgDOJKkL_g", "name": "django-model-utils", "full_name": "ProtixIT/django-model-utils", "private": false, "owner": {"login": "ProtixIT", "id": 120380850, "node_id": "O_kgDOByzdsg", "avatar_url": "https://avatars.githubusercontent.com/u/120380850?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ProtixIT", "html_url": "https://github.com/ProtixIT", "followers_url": "https://api.github.com/users/ProtixIT/followers", "following_url": "https://api.github.com/users/ProtixIT/following{/other_user}", "gists_url": "https://api.github.com/users/ProtixIT/gists{/gist_id}", "starred_url": "https://api.github.com/users/ProtixIT/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ProtixIT/subscriptions", "organizations_url": "https://api.github.com/users/ProtixIT/orgs", "repos_url": "https://api.github.com/users/ProtixIT/repos", "events_url": "https://api.github.com/users/ProtixIT/events{/privacy}", "received_events_url": "https://api.github.com/users/ProtixIT/received_events", "type": "Organization", "site_admin": false}, "html_url": "https://github.com/ProtixIT/django-model-utils", "description": "Django model mixins and utilities.", "fork": true, "url": "https://api.github.com/repos/ProtixIT/django-model-utils", "forks_url": "https://api.github.com/repos/ProtixIT/django-model-utils/forks", "keys_url": "https://api.github.com/repos/ProtixIT/django-model-utils/keys{/key_id}", "collaborators_url": "https://api.github.com/repos/ProtixIT/django-model-utils/collaborators{/collaborator}", "teams_url": "https://api.github.com/repos/ProtixIT/django-model-utils/teams", "hooks_url": "https://api.github.com/repos/ProtixIT/django-model-utils/hooks", "issue_events_url": "https://api.github.com/repos/ProtixIT/django-model-utils/issues/events{/number}", "events_url": "https://api.github.com/repos/ProtixIT/django-model-utils/events", "assignees_url": "https://api.github.com/repos/ProtixIT/django-model-utils/assignees{/user}", "branches_url": "https://api.github.com/repos/ProtixIT/django-model-utils/branches{/branch}", "tags_url": "https://api.github.com/repos/ProtixIT/django-model-utils/tags", "blobs_url": "https://api.github.com/repos/ProtixIT/django-model-utils/git/blobs{/sha}", "git_tags_url": "https://api.github.com/repos/ProtixIT/django-model-utils/git/tags{/sha}", "git_refs_url": "https://api.github.com/repos/ProtixIT/django-model-utils/git/refs{/sha}", "trees_url": "https://api.github.com/repos/ProtixIT/django-model-utils/git/trees{/sha}", "statuses_url": "https://api.github.com/repos/ProtixIT/django-model-utils/statuses/{sha}", "languages_url": "https://api.github.com/repos/ProtixIT/django-model-utils/languages", "stargazers_url": "https://api.github.com/repos/ProtixIT/django-model-utils/stargazers", "contributors_url": "https://api.github.com/repos/ProtixIT/django-model-utils/contributors", "subscribers_url": "https://api.github.com/repos/ProtixIT/django-model-utils/subscribers", "subscription_url": "https://api.github.com/repos/ProtixIT/django-model-utils/subscription", "commits_url": "https://api.github.com/repos/ProtixIT/django-model-utils/commits{/sha}", "git_commits_url": "https://api.github.com/repos/ProtixIT/django-model-utils/git/commits{/sha}", "comments_url": "https://api.github.com/repos/ProtixIT/django-model-utils/comments{/number}", "issue_comment_url": "https://api.github.com/repos/ProtixIT/django-model-utils/issues/comments{/number}", "contents_url": "https://api.github.com/repos/ProtixIT/django-model-utils/contents/{+path}", "compare_url": "https://api.github.com/repos/ProtixIT/django-model-utils/compare/{base}...{head}", "merges_url": "https://api.github.com/repos/ProtixIT/django-model-utils/merges", "archive_url": "https://api.github.com/repos/ProtixIT/django-model-utils/{archive_format}{/ref}", "downloads_url": "https://api.github.com/repos/ProtixIT/django-model-utils/downloads", "issues_url": "https://api.github.com/repos/ProtixIT/django-model-utils/issues{/number}", "pulls_url": "https://api.github.com/repos/ProtixIT/django-model-utils/pulls{/number}", "milestones_url": "https://api.github.com/repos/ProtixIT/django-model-utils/milestones{/number}", "notifications_url": "https://api.github.com/repos/ProtixIT/django-model-utils/notifications{?since,all,participating}", "labels_url": "https://api.github.com/repos/ProtixIT/django-model-utils/labels{/name}", "releases_url": "https://api.github.com/repos/ProtixIT/django-model-utils/releases{/id}", "deployments_url": "https://api.github.com/repos/ProtixIT/django-model-utils/deployments", "created_at": "2023-03-16T21:41:42Z", "updated_at": "2023-04-18T15:12:37Z", "pushed_at": "2024-06-19T20:04:01Z", "git_url": "git://github.com/ProtixIT/django-model-utils.git", "ssh_url": "git@github.com:ProtixIT/django-model-utils.git", "clone_url": "https://github.com/ProtixIT/django-model-utils.git", "svn_url": "https://github.com/ProtixIT/django-model-utils", "homepage": "https://django-model-utils.readthedocs.io", "size": 1014, "stargazers_count": 0, "watchers_count": 0, "language": "Python", "has_issues": false, "has_projects": true, "has_downloads": true, "has_wiki": true, "has_pages": false, "has_discussions": false, "forks_count": 0, "mirror_url": null, "archived": false, "disabled": false, "open_issues_count": 0, "license": {"key": "bsd-3-clause", "name": "BSD 3-Clause \"New\" or \"Revised\" License", "spdx_id": "BSD-3-Clause", "url": "https://api.github.com/licenses/bsd-3-clause", "node_id": "MDc6TGljZW5zZTU="}, "allow_forking": true, "is_template": false, "web_commit_signoff_required": false, "topics": [], "visibility": "public", "forks": 0, "open_issues": 0, "watchers": 0, "default_branch": "master"}}, "base": {"label": "jazzband:master", "ref": "master", "sha": "324ea2bd25b6ec34232ef43bb6760ed929564389", "user": {"login": "jazzband", "id": 15129049, "node_id": "MDEyOk9yZ2FuaXphdGlvbjE1MTI5MDQ5", "avatar_url": "https://avatars.githubusercontent.com/u/15129049?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jazzband", "html_url": "https://github.com/jazzband", "followers_url": "https://api.github.com/users/jazzband/followers", "following_url": "https://api.github.com/users/jazzband/following{/other_user}", "gists_url": "https://api.github.com/users/jazzband/gists{/gist_id}", "starred_url": "https://api.github.com/users/jazzband/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jazzband/subscriptions", "organizations_url": "https://api.github.com/users/jazzband/orgs", "repos_url": "https://api.github.com/users/jazzband/repos", "events_url": "https://api.github.com/users/jazzband/events{/privacy}", "received_events_url": "https://api.github.com/users/jazzband/received_events", "type": "Organization", "site_admin": false}, "repo": {"id": 367233, "node_id": "MDEwOlJlcG9zaXRvcnkzNjcyMzM=", "name": "django-model-utils", "full_name": "jazzband/django-model-utils", "private": false, "owner": {"login": "jazzband", "id": 15129049, "node_id": "MDEyOk9yZ2FuaXphdGlvbjE1MTI5MDQ5", "avatar_url": "https://avatars.githubusercontent.com/u/15129049?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jazzband", "html_url": "https://github.com/jazzband", "followers_url": "https://api.github.com/users/jazzband/followers", "following_url": "https://api.github.com/users/jazzband/following{/other_user}", "gists_url": "https://api.github.com/users/jazzband/gists{/gist_id}", "starred_url": "https://api.github.com/users/jazzband/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jazzband/subscriptions", "organizations_url": "https://api.github.com/users/jazzband/orgs", "repos_url": "https://api.github.com/users/jazzband/repos", "events_url": "https://api.github.com/users/jazzband/events{/privacy}", "received_events_url": "https://api.github.com/users/jazzband/received_events", "type": "Organization", "site_admin": false}, "html_url": "https://github.com/jazzband/django-model-utils", "description": "Django model mixins and utilities.", "fork": false, "url": "https://api.github.com/repos/jazzband/django-model-utils", "forks_url": "https://api.github.com/repos/jazzband/django-model-utils/forks", "keys_url": "https://api.github.com/repos/jazzband/django-model-utils/keys{/key_id}", "collaborators_url": "https://api.github.com/repos/jazzband/django-model-utils/collaborators{/collaborator}", "teams_url": "https://api.github.com/repos/jazzband/django-model-utils/teams", "hooks_url": "https://api.github.com/repos/jazzband/django-model-utils/hooks", "issue_events_url": "https://api.github.com/repos/jazzband/django-model-utils/issues/events{/number}", "events_url": "https://api.github.com/repos/jazzband/django-model-utils/events", "assignees_url": "https://api.github.com/repos/jazzband/django-model-utils/assignees{/user}", "branches_url": "https://api.github.com/repos/jazzband/django-model-utils/branches{/branch}", "tags_url": "https://api.github.com/repos/jazzband/django-model-utils/tags", "blobs_url": "https://api.github.com/repos/jazzband/django-model-utils/git/blobs{/sha}", "git_tags_url": "https://api.github.com/repos/jazzband/django-model-utils/git/tags{/sha}", "git_refs_url": "https://api.github.com/repos/jazzband/django-model-utils/git/refs{/sha}", "trees_url": "https://api.github.com/repos/jazzband/django-model-utils/git/trees{/sha}", "statuses_url": "https://api.github.com/repos/jazzband/django-model-utils/statuses/{sha}", "languages_url": "https://api.github.com/repos/jazzband/django-model-utils/languages", "stargazers_url": "https://api.github.com/repos/jazzband/django-model-utils/stargazers", "contributors_url": "https://api.github.com/repos/jazzband/django-model-utils/contributors", "subscribers_url": "https://api.github.com/repos/jazzband/django-model-utils/subscribers", "subscription_url": "https://api.github.com/repos/jazzband/django-model-utils/subscription", "commits_url": "https://api.github.com/repos/jazzband/django-model-utils/commits{/sha}", "git_commits_url": "https://api.github.com/repos/jazzband/django-model-utils/git/commits{/sha}", "comments_url": "https://api.github.com/repos/jazzband/django-model-utils/comments{/number}", "issue_comment_url": "https://api.github.com/repos/jazzband/django-model-utils/issues/comments{/number}", "contents_url": "https://api.github.com/repos/jazzband/django-model-utils/contents/{+path}", "compare_url": "https://api.github.com/repos/jazzband/django-model-utils/compare/{base}...{head}", "merges_url": "https://api.github.com/repos/jazzband/django-model-utils/merges", "archive_url": "https://api.github.com/repos/jazzband/django-model-utils/{archive_format}{/ref}", "downloads_url": "https://api.github.com/repos/jazzband/django-model-utils/downloads", "issues_url": "https://api.github.com/repos/jazzband/django-model-utils/issues{/number}", "pulls_url": "https://api.github.com/repos/jazzband/django-model-utils/pulls{/number}", "milestones_url": "https://api.github.com/repos/jazzband/django-model-utils/milestones{/number}", "notifications_url": "https://api.github.com/repos/jazzband/django-model-utils/notifications{?since,all,participating}", "labels_url": "https://api.github.com/repos/jazzband/django-model-utils/labels{/name}", "releases_url": "https://api.github.com/repos/jazzband/django-model-utils/releases{/id}", "deployments_url": "https://api.github.com/repos/jazzband/django-model-utils/deployments", "created_at": "2009-11-10T06:18:00Z", "updated_at": "2024-08-26T09:05:48Z", "pushed_at": "2024-08-05T17:55:08Z", "git_url": "git://github.com/jazzband/django-model-utils.git", "ssh_url": "git@github.com:jazzband/django-model-utils.git", "clone_url": "https://github.com/jazzband/django-model-utils.git", "svn_url": "https://github.com/jazzband/django-model-utils", "homepage": "https://django-model-utils.readthedocs.io", "size": 1094, "stargazers_count": 2637, "watchers_count": 2637, "language": "Python", "has_issues": true, "has_projects": true, "has_downloads": true, "has_wiki": true, "has_pages": false, "has_discussions": false, "forks_count": 363, "mirror_url": null, "archived": false, "disabled": false, "open_issues_count": 106, "license": {"key": "bsd-3-clause", "name": "BSD 3-Clause \"New\" or \"Revised\" License", "spdx_id": "BSD-3-Clause", "url": "https://api.github.com/licenses/bsd-3-clause", "node_id": "MDc6TGljZW5zZTU="}, "allow_forking": true, "is_template": false, "web_commit_signoff_required": false, "topics": [], "visibility": "public", "forks": 363, "open_issues": 106, "watchers": 2637, "default_branch": "master"}}, "_links": {"self": {"href": "https://api.github.com/repos/jazzband/django-model-utils/pulls/624"}, "html": {"href": "https://github.com/jazzband/django-model-utils/pull/624"}, "issue": {"href": "https://api.github.com/repos/jazzband/django-model-utils/issues/624"}, "comments": {"href": "https://api.github.com/repos/jazzband/django-model-utils/issues/624/comments"}, "review_comments": {"href": "https://api.github.com/repos/jazzband/django-model-utils/pulls/624/comments"}, "review_comment": {"href": "https://api.github.com/repos/jazzband/django-model-utils/pulls/comments{/number}"}, "commits": {"href": "https://api.github.com/repos/jazzband/django-model-utils/pulls/624/commits"}, "statuses": {"href": "https://api.github.com/repos/jazzband/django-model-utils/statuses/14cf1b0d40d5538e79e33527a2c13eb59c04893f"}}, "author_association": "CONTRIBUTOR", "auto_merge": null, "active_lock_reason": null, "resolved_issues": []}
