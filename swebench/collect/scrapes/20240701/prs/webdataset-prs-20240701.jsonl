{"url": "https://api.github.com/repos/webdataset/webdataset/pulls/347", "id": 1821168899, "node_id": "PR_kwDOC_xgxs5sjNUD", "html_url": "https://github.com/webdataset/webdataset/pull/347", "diff_url": "https://github.com/webdataset/webdataset/pull/347.diff", "patch_url": "https://github.com/webdataset/webdataset/pull/347.patch", "issue_url": "https://api.github.com/repos/webdataset/webdataset/issues/347", "number": 347, "state": "closed", "locked": false, "title": "seed is not used in _shuffle()", "user": {"login": "elicassion", "id": 11537907, "node_id": "MDQ6VXNlcjExNTM3OTA3", "avatar_url": "https://avatars.githubusercontent.com/u/11537907?v=4", "gravatar_id": "", "url": "https://api.github.com/users/elicassion", "html_url": "https://github.com/elicassion", "followers_url": "https://api.github.com/users/elicassion/followers", "following_url": "https://api.github.com/users/elicassion/following{/other_user}", "gists_url": "https://api.github.com/users/elicassion/gists{/gist_id}", "starred_url": "https://api.github.com/users/elicassion/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/elicassion/subscriptions", "organizations_url": "https://api.github.com/users/elicassion/orgs", "repos_url": "https://api.github.com/users/elicassion/repos", "events_url": "https://api.github.com/users/elicassion/events{/privacy}", "received_events_url": "https://api.github.com/users/elicassion/received_events", "type": "User", "site_admin": false}, "body": "Hi,\r\n\r\nThis PR is to fix `seed` is not used in `_shuffle()`. This causes dataloaders on the same dataset in different processes are not returning the same indices, which is not desired if we give a seed to it. \r\n\r\nTo reproduce the problem at the current release ([0.2.88](https://github.com/webdataset/webdataset/releases/tag/0.2.88)):\r\n```\r\nimport os\r\nimport random\r\nimport numpy as np\r\nimport webdataset as wds\r\nimport torch\r\nimport torch.distributed as dist\r\nfrom torch import default_generator\r\nfrom torch.utils.data import TensorDataset\r\n\r\ncol_1 = TensorDataset(torch.arange(0, 1000))\r\ncol_2 = TensorDataset(torch.arange(0, 1000))\r\ncol_3 = TensorDataset(torch.arange(0, 1000))\r\nds = [col_1, col_2, col_3]\r\n\r\ndef seed_everything(seed):\r\n    os.environ[\"PYTHON_SEED\"] = str(seed)\r\n    random.seed(seed)\r\n    np.random.seed(seed)\r\n    torch.manual_seed(seed)\r\n\r\ndef ddp_setup():\r\n    dist.init_process_group()\r\n\r\ndef ddp_cleanup():\r\n    dist.destroy_process_group()\r\n\r\ndef ddp_main():\r\n    ddp_setup()\r\n    rank, world_size = dist.get_rank(), dist.get_world_size()\r\n    \r\n    loaders = [\r\n        wds.WebLoader(\r\n            col,\r\n            batch_size=None,\r\n            generator=default_generator,\r\n        ).shuffle(25, seed=rank)\r\n        .batched(8)\r\n        for col in ds\r\n    ]\r\n\r\n    for i, data in enumerate(zip(*loaders)):\r\n        print (f\"proc-{rank}: {data}\")\r\n        if i > 1:\r\n            break\r\n\r\ndef main():\r\n    seed_everything(0)\r\n    ddp_main()\r\n\r\nif __name__ == \"__main__\":\r\n    main()\r\n\r\n```\r\n\r\nAnd below is the output I got, before and after my fix:\r\n\r\n```\r\n# ----------------before------------------\r\ntorchrun --nproc_per_node 2 --nnodes 1 --rdzv_backend c10d --rdzv_endpoint localhost:0 --master_addr=localhost wds_shuffle_bug.py\r\nproc-0: ([tensor([ 6,  7, 25, 16,  5, 12, 11, 19])], [tensor([13, 25,  6, 20, 19, 24, 26,  4])], [tensor([ 5, 25, 13, 20, 22,  4,  6, 12])])\r\nproc-1: ([tensor([16,  8, 18, 19,  4,  9, 12, 15])], [tensor([ 1, 20, 11,  9, 12, 18, 17, 16])], [tensor([17,  3, 19,  7, 22,  2, 29, 16])])\r\nproc-0: ([tensor([32,  4,  9,  2, 15, 18, 20, 37])], [tensor([ 8, 30, 27, 16, 35,  0, 21, 14])], [tensor([30,  9, 15, 19,  2, 21,  1, 36])])\r\nproc-1: ([tensor([13, 20,  6, 35, 32, 14,  5, 30])], [tensor([27, 31, 33, 26, 23, 14, 10, 36])], [tensor([14, 21,  1, 35, 25,  0, 38, 12])])\r\nproc-0: ([tensor([10, 13, 23, 39, 26,  3, 46, 45])], [tensor([12, 41, 23,  1,  7, 15, 32, 47])], [tensor([37, 28, 14, 29, 43, 10, 40, 23])])\r\nproc-1: ([tensor([31, 33, 36, 41,  0, 34, 43, 24])], [tensor([ 5, 22,  2, 30, 35,  7, 21,  4])], [tensor([20, 24, 26,  9, 32,  4, 34, 37])])\r\n\r\n# ----------------after------------------\r\ntorchrun --nproc_per_node 2 --nnodes 1 --rdzv_backend c10d --rdzv_endpoint localhost:0 --master_addr=localhost wds_shuffle_bug.py\r\nproc-0: ([tensor([12, 25, 13,  1,  8, 16, 15, 24])], [tensor([12, 25, 13,  1,  8, 16, 15, 24])], [tensor([12, 25, 13,  1,  8, 16, 15, 24])])\r\nproc-1: ([tensor([ 4, 18, 26,  2,  8,  3, 15, 31])], [tensor([ 4, 18, 26,  2,  8,  3, 15, 31])], [tensor([ 4, 18, 26,  2,  8,  3, 15, 31])])\r\nproc-0: ([tensor([ 9, 30, 11, 18,  6, 29,  4, 32])], [tensor([ 9, 30, 11, 18,  6, 29,  4, 32])], [tensor([ 9, 30, 11, 18,  6, 29,  4, 32])])\r\nproc-1: ([tensor([14, 30, 20, 12,  6, 29, 33,  0])], [tensor([14, 30, 20, 12,  6, 29, 33,  0])], [tensor([14, 30, 20, 12,  6, 29, 33,  0])])\r\nproc-0: ([tensor([38, 41,  3, 19, 28, 17, 22, 43])], [tensor([38, 41,  3, 19, 28, 17, 22, 43])], [tensor([38, 41,  3, 19, 28, 17, 22, 43])])\r\nproc-1: ([tensor([35, 13, 19, 43, 44, 39, 22, 32])], [tensor([35, 13, 19, 43, 44, 39, 22, 32])], [tensor([35, 13, 19, 43, 44, 39, 22, 32])])\r\n```\r\n", "created_at": "2024-04-13T01:58:58Z", "updated_at": "2024-05-14T21:02:21Z", "closed_at": "2024-05-14T21:02:21Z", "merged_at": "2024-05-14T21:02:21Z", "merge_commit_sha": "c58ff04559ab24d096e23910c32c3730b60059b1", "assignee": null, "assignees": [], "requested_reviewers": [], "requested_teams": [], "labels": [], "milestone": null, "draft": false, "commits_url": "https://api.github.com/repos/webdataset/webdataset/pulls/347/commits", "review_comments_url": "https://api.github.com/repos/webdataset/webdataset/pulls/347/comments", "review_comment_url": "https://api.github.com/repos/webdataset/webdataset/pulls/comments{/number}", "comments_url": "https://api.github.com/repos/webdataset/webdataset/issues/347/comments", "statuses_url": "https://api.github.com/repos/webdataset/webdataset/statuses/12d425d567c265d407383685975f2ae36d71491f", "head": {"label": "elicassion:elicassion/fix_shuffle_bug", "ref": "elicassion/fix_shuffle_bug", "sha": "12d425d567c265d407383685975f2ae36d71491f", "user": {"login": "elicassion", "id": 11537907, "node_id": "MDQ6VXNlcjExNTM3OTA3", "avatar_url": "https://avatars.githubusercontent.com/u/11537907?v=4", "gravatar_id": "", "url": "https://api.github.com/users/elicassion", "html_url": "https://github.com/elicassion", "followers_url": "https://api.github.com/users/elicassion/followers", "following_url": "https://api.github.com/users/elicassion/following{/other_user}", "gists_url": "https://api.github.com/users/elicassion/gists{/gist_id}", "starred_url": "https://api.github.com/users/elicassion/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/elicassion/subscriptions", "organizations_url": "https://api.github.com/users/elicassion/orgs", "repos_url": "https://api.github.com/users/elicassion/repos", "events_url": "https://api.github.com/users/elicassion/events{/privacy}", "received_events_url": "https://api.github.com/users/elicassion/received_events", "type": "User", "site_admin": false}, "repo": {"id": 785950341, "node_id": "R_kgDOLtimhQ", "name": "webdataset", "full_name": "elicassion/webdataset", "private": false, "owner": {"login": "elicassion", "id": 11537907, "node_id": "MDQ6VXNlcjExNTM3OTA3", "avatar_url": "https://avatars.githubusercontent.com/u/11537907?v=4", "gravatar_id": "", "url": "https://api.github.com/users/elicassion", "html_url": "https://github.com/elicassion", "followers_url": "https://api.github.com/users/elicassion/followers", "following_url": "https://api.github.com/users/elicassion/following{/other_user}", "gists_url": "https://api.github.com/users/elicassion/gists{/gist_id}", "starred_url": "https://api.github.com/users/elicassion/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/elicassion/subscriptions", "organizations_url": "https://api.github.com/users/elicassion/orgs", "repos_url": "https://api.github.com/users/elicassion/repos", "events_url": "https://api.github.com/users/elicassion/events{/privacy}", "received_events_url": "https://api.github.com/users/elicassion/received_events", "type": "User", "site_admin": false}, "html_url": "https://github.com/elicassion/webdataset", "description": "A high-performance Python-based I/O system for large (and small) deep learning problems, with strong support for PyTorch.", "fork": true, "url": "https://api.github.com/repos/elicassion/webdataset", "forks_url": "https://api.github.com/repos/elicassion/webdataset/forks", "keys_url": "https://api.github.com/repos/elicassion/webdataset/keys{/key_id}", "collaborators_url": "https://api.github.com/repos/elicassion/webdataset/collaborators{/collaborator}", "teams_url": "https://api.github.com/repos/elicassion/webdataset/teams", "hooks_url": "https://api.github.com/repos/elicassion/webdataset/hooks", "issue_events_url": "https://api.github.com/repos/elicassion/webdataset/issues/events{/number}", "events_url": "https://api.github.com/repos/elicassion/webdataset/events", "assignees_url": "https://api.github.com/repos/elicassion/webdataset/assignees{/user}", "branches_url": "https://api.github.com/repos/elicassion/webdataset/branches{/branch}", "tags_url": "https://api.github.com/repos/elicassion/webdataset/tags", "blobs_url": "https://api.github.com/repos/elicassion/webdataset/git/blobs{/sha}", "git_tags_url": "https://api.github.com/repos/elicassion/webdataset/git/tags{/sha}", "git_refs_url": "https://api.github.com/repos/elicassion/webdataset/git/refs{/sha}", "trees_url": "https://api.github.com/repos/elicassion/webdataset/git/trees{/sha}", "statuses_url": "https://api.github.com/repos/elicassion/webdataset/statuses/{sha}", "languages_url": "https://api.github.com/repos/elicassion/webdataset/languages", "stargazers_url": "https://api.github.com/repos/elicassion/webdataset/stargazers", "contributors_url": "https://api.github.com/repos/elicassion/webdataset/contributors", "subscribers_url": "https://api.github.com/repos/elicassion/webdataset/subscribers", "subscription_url": "https://api.github.com/repos/elicassion/webdataset/subscription", "commits_url": "https://api.github.com/repos/elicassion/webdataset/commits{/sha}", "git_commits_url": "https://api.github.com/repos/elicassion/webdataset/git/commits{/sha}", "comments_url": "https://api.github.com/repos/elicassion/webdataset/comments{/number}", "issue_comment_url": "https://api.github.com/repos/elicassion/webdataset/issues/comments{/number}", "contents_url": "https://api.github.com/repos/elicassion/webdataset/contents/{+path}", "compare_url": "https://api.github.com/repos/elicassion/webdataset/compare/{base}...{head}", "merges_url": "https://api.github.com/repos/elicassion/webdataset/merges", "archive_url": "https://api.github.com/repos/elicassion/webdataset/{archive_format}{/ref}", "downloads_url": "https://api.github.com/repos/elicassion/webdataset/downloads", "issues_url": "https://api.github.com/repos/elicassion/webdataset/issues{/number}", "pulls_url": "https://api.github.com/repos/elicassion/webdataset/pulls{/number}", "milestones_url": "https://api.github.com/repos/elicassion/webdataset/milestones{/number}", "notifications_url": "https://api.github.com/repos/elicassion/webdataset/notifications{?since,all,participating}", "labels_url": "https://api.github.com/repos/elicassion/webdataset/labels{/name}", "releases_url": "https://api.github.com/repos/elicassion/webdataset/releases{/id}", "deployments_url": "https://api.github.com/repos/elicassion/webdataset/deployments", "created_at": "2024-04-13T01:46:16Z", "updated_at": "2024-04-13T01:46:16Z", "pushed_at": "2024-04-13T01:47:57Z", "git_url": "git://github.com/elicassion/webdataset.git", "ssh_url": "git@github.com:elicassion/webdataset.git", "clone_url": "https://github.com/elicassion/webdataset.git", "svn_url": "https://github.com/elicassion/webdataset", "homepage": "", "size": 50862, "stargazers_count": 0, "watchers_count": 0, "language": null, "has_issues": false, "has_projects": true, "has_downloads": true, "has_wiki": true, "has_pages": false, "has_discussions": false, "forks_count": 0, "mirror_url": null, "archived": false, "disabled": false, "open_issues_count": 0, "license": {"key": "bsd-3-clause", "name": "BSD 3-Clause \"New\" or \"Revised\" License", "spdx_id": "BSD-3-Clause", "url": "https://api.github.com/licenses/bsd-3-clause", "node_id": "MDc6TGljZW5zZTU="}, "allow_forking": true, "is_template": false, "web_commit_signoff_required": false, "topics": [], "visibility": "public", "forks": 0, "open_issues": 0, "watchers": 0, "default_branch": "main"}}, "base": {"label": "webdataset:main", "ref": "main", "sha": "f11fd66c163722c607ec99475a6f3cb880ec35b8", "user": {"login": "webdataset", "id": 83745809, "node_id": "MDEyOk9yZ2FuaXphdGlvbjgzNzQ1ODA5", "avatar_url": "https://avatars.githubusercontent.com/u/83745809?v=4", "gravatar_id": "", "url": "https://api.github.com/users/webdataset", "html_url": "https://github.com/webdataset", "followers_url": "https://api.github.com/users/webdataset/followers", "following_url": "https://api.github.com/users/webdataset/following{/other_user}", "gists_url": "https://api.github.com/users/webdataset/gists{/gist_id}", "starred_url": "https://api.github.com/users/webdataset/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/webdataset/subscriptions", "organizations_url": "https://api.github.com/users/webdataset/orgs", "repos_url": "https://api.github.com/users/webdataset/repos", "events_url": "https://api.github.com/users/webdataset/events{/privacy}", "received_events_url": "https://api.github.com/users/webdataset/received_events", "type": "Organization", "site_admin": false}, "repo": {"id": 201089222, "node_id": "MDEwOlJlcG9zaXRvcnkyMDEwODkyMjI=", "name": "webdataset", "full_name": "webdataset/webdataset", "private": false, "owner": {"login": "webdataset", "id": 83745809, "node_id": "MDEyOk9yZ2FuaXphdGlvbjgzNzQ1ODA5", "avatar_url": "https://avatars.githubusercontent.com/u/83745809?v=4", "gravatar_id": "", "url": "https://api.github.com/users/webdataset", "html_url": "https://github.com/webdataset", "followers_url": "https://api.github.com/users/webdataset/followers", "following_url": "https://api.github.com/users/webdataset/following{/other_user}", "gists_url": "https://api.github.com/users/webdataset/gists{/gist_id}", "starred_url": "https://api.github.com/users/webdataset/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/webdataset/subscriptions", "organizations_url": "https://api.github.com/users/webdataset/orgs", "repos_url": "https://api.github.com/users/webdataset/repos", "events_url": "https://api.github.com/users/webdataset/events{/privacy}", "received_events_url": "https://api.github.com/users/webdataset/received_events", "type": "Organization", "site_admin": false}, "html_url": "https://github.com/webdataset/webdataset", "description": "A high-performance Python-based I/O system for large (and small) deep learning problems, with strong support for PyTorch.", "fork": false, "url": "https://api.github.com/repos/webdataset/webdataset", "forks_url": "https://api.github.com/repos/webdataset/webdataset/forks", "keys_url": "https://api.github.com/repos/webdataset/webdataset/keys{/key_id}", "collaborators_url": "https://api.github.com/repos/webdataset/webdataset/collaborators{/collaborator}", "teams_url": "https://api.github.com/repos/webdataset/webdataset/teams", "hooks_url": "https://api.github.com/repos/webdataset/webdataset/hooks", "issue_events_url": "https://api.github.com/repos/webdataset/webdataset/issues/events{/number}", "events_url": "https://api.github.com/repos/webdataset/webdataset/events", "assignees_url": "https://api.github.com/repos/webdataset/webdataset/assignees{/user}", "branches_url": "https://api.github.com/repos/webdataset/webdataset/branches{/branch}", "tags_url": "https://api.github.com/repos/webdataset/webdataset/tags", "blobs_url": "https://api.github.com/repos/webdataset/webdataset/git/blobs{/sha}", "git_tags_url": "https://api.github.com/repos/webdataset/webdataset/git/tags{/sha}", "git_refs_url": "https://api.github.com/repos/webdataset/webdataset/git/refs{/sha}", "trees_url": "https://api.github.com/repos/webdataset/webdataset/git/trees{/sha}", "statuses_url": "https://api.github.com/repos/webdataset/webdataset/statuses/{sha}", "languages_url": "https://api.github.com/repos/webdataset/webdataset/languages", "stargazers_url": "https://api.github.com/repos/webdataset/webdataset/stargazers", "contributors_url": "https://api.github.com/repos/webdataset/webdataset/contributors", "subscribers_url": "https://api.github.com/repos/webdataset/webdataset/subscribers", "subscription_url": "https://api.github.com/repos/webdataset/webdataset/subscription", "commits_url": "https://api.github.com/repos/webdataset/webdataset/commits{/sha}", "git_commits_url": "https://api.github.com/repos/webdataset/webdataset/git/commits{/sha}", "comments_url": "https://api.github.com/repos/webdataset/webdataset/comments{/number}", "issue_comment_url": "https://api.github.com/repos/webdataset/webdataset/issues/comments{/number}", "contents_url": "https://api.github.com/repos/webdataset/webdataset/contents/{+path}", "compare_url": "https://api.github.com/repos/webdataset/webdataset/compare/{base}...{head}", "merges_url": "https://api.github.com/repos/webdataset/webdataset/merges", "archive_url": "https://api.github.com/repos/webdataset/webdataset/{archive_format}{/ref}", "downloads_url": "https://api.github.com/repos/webdataset/webdataset/downloads", "issues_url": "https://api.github.com/repos/webdataset/webdataset/issues{/number}", "pulls_url": "https://api.github.com/repos/webdataset/webdataset/pulls{/number}", "milestones_url": "https://api.github.com/repos/webdataset/webdataset/milestones{/number}", "notifications_url": "https://api.github.com/repos/webdataset/webdataset/notifications{?since,all,participating}", "labels_url": "https://api.github.com/repos/webdataset/webdataset/labels{/name}", "releases_url": "https://api.github.com/repos/webdataset/webdataset/releases{/id}", "deployments_url": "https://api.github.com/repos/webdataset/webdataset/deployments", "created_at": "2019-08-07T16:42:04Z", "updated_at": "2024-08-26T10:52:56Z", "pushed_at": "2024-08-13T00:36:13Z", "git_url": "git://github.com/webdataset/webdataset.git", "ssh_url": "git@github.com:webdataset/webdataset.git", "clone_url": "https://github.com/webdataset/webdataset.git", "svn_url": "https://github.com/webdataset/webdataset", "homepage": "", "size": 51740, "stargazers_count": 2172, "watchers_count": 2172, "language": "Python", "has_issues": true, "has_projects": true, "has_downloads": true, "has_wiki": true, "has_pages": true, "has_discussions": false, "forks_count": 168, "mirror_url": null, "archived": false, "disabled": false, "open_issues_count": 116, "license": {"key": "bsd-3-clause", "name": "BSD 3-Clause \"New\" or \"Revised\" License", "spdx_id": "BSD-3-Clause", "url": "https://api.github.com/licenses/bsd-3-clause", "node_id": "MDc6TGljZW5zZTU="}, "allow_forking": true, "is_template": false, "web_commit_signoff_required": false, "topics": ["data-augmentation", "deep-learning", "pytorch", "webdataset", "webdataset-format"], "visibility": "public", "forks": 168, "open_issues": 116, "watchers": 2172, "default_branch": "main"}}, "_links": {"self": {"href": "https://api.github.com/repos/webdataset/webdataset/pulls/347"}, "html": {"href": "https://github.com/webdataset/webdataset/pull/347"}, "issue": {"href": "https://api.github.com/repos/webdataset/webdataset/issues/347"}, "comments": {"href": "https://api.github.com/repos/webdataset/webdataset/issues/347/comments"}, "review_comments": {"href": "https://api.github.com/repos/webdataset/webdataset/pulls/347/comments"}, "review_comment": {"href": "https://api.github.com/repos/webdataset/webdataset/pulls/comments{/number}"}, "commits": {"href": "https://api.github.com/repos/webdataset/webdataset/pulls/347/commits"}, "statuses": {"href": "https://api.github.com/repos/webdataset/webdataset/statuses/12d425d567c265d407383685975f2ae36d71491f"}}, "author_association": "CONTRIBUTOR", "auto_merge": null, "active_lock_reason": null, "resolved_issues": []}
