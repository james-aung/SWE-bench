{"url": "https://api.github.com/repos/hplt-project/sacremoses/pulls/146", "id": 1567000121, "node_id": "PR_kwDOB8RSPc5dZoY5", "html_url": "https://github.com/hplt-project/sacremoses/pull/146", "diff_url": "https://github.com/hplt-project/sacremoses/pull/146.diff", "patch_url": "https://github.com/hplt-project/sacremoses/pull/146.patch", "issue_url": "https://api.github.com/repos/hplt-project/sacremoses/issues/146", "number": 146, "state": "closed", "locked": false, "title": "Parity with perl normalize.", "user": {"login": "NIXBLACK11", "id": 91743459, "node_id": "U_kgDOBXfk4w", "avatar_url": "https://avatars.githubusercontent.com/u/91743459?v=4", "gravatar_id": "", "url": "https://api.github.com/users/NIXBLACK11", "html_url": "https://github.com/NIXBLACK11", "followers_url": "https://api.github.com/users/NIXBLACK11/followers", "following_url": "https://api.github.com/users/NIXBLACK11/following{/other_user}", "gists_url": "https://api.github.com/users/NIXBLACK11/gists{/gist_id}", "starred_url": "https://api.github.com/users/NIXBLACK11/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/NIXBLACK11/subscriptions", "organizations_url": "https://api.github.com/users/NIXBLACK11/orgs", "repos_url": "https://api.github.com/users/NIXBLACK11/repos", "events_url": "https://api.github.com/users/NIXBLACK11/events{/privacy}", "received_events_url": "https://api.github.com/users/NIXBLACK11/received_events", "type": "User", "site_admin": false}, "body": "In the modified Python script, several changes have been made to improve its functionality and maintain parity with the original Perl script. \r\n\r\n## Parity with perl normalize\r\n\r\n- The original perl script had regex (s/\u2019/\\\"/g) at line 47 this was ported to (\"\u2019\", r\"'\") at line 43 which was not correct,so I updated it to (\"\u2019\", r'\"').\r\n\r\n- The original perl script had regex (s/\u00a0\u00ab\u00a0/ \\\"/g) at line 52 this was ported to (\"\\u00A0\u00ab\\u00A0\", r'\"') at line 50 which was not correct,so I updated it to (\"\\u00A0\u00ab\\u00A0\", r' \"').\r\n\r\n- The original perl script had regex (s/\u00a0\u00bb\u00a0/\\\" /g) at line 55 this was ported to (\"\\u00A0\u00bb\\u00A0\", r'\"') at line 53 ,so I updated it to (\"\\u00A0\u00bb\\u00A0\", r'\" ').\r\n\r\n\r\n- A new argument named perl_parity has been introduced in the constructor. This argument is optional and defaults to False. It doesn't affect the script's behavior when using the default arguments. However, if set to True, it enforces certain changes to align the Python script more closely with the original Perl script.\r\n\r\n## Test plan\r\n\r\nThe test plan below runs the normalize function with both the default and newly added argument perl_parity=True on all of the FLORES200 dataset (408 files, totalling 409836 lines), and compares the outputs to that of the original perl script. With the default arguments, there are 188 files which are different to the perl script output. With the newly added argument, there no differences.\r\n\r\n```\r\nfrom pathlib import Path\r\nfrom sacremoses import MosesPunctNormalizer\r\nimport tempfile\r\nfrom subprocess import check_output\r\nimport asyncio\r\nimport typing as tp\r\nimport numpy as np\r\n\r\nasync def check_for_differences(data, norm_default, norm_updated) -> tp.Tuple[bool, bool]:\r\n    with tempfile.NamedTemporaryFile() as tmp_file:\r\n        with open(tmp_file.name, \"w\") as f:\r\n            f.write(data)\r\n        perl_output = (\r\n            check_output(\r\n                f\"cat {tmp_file.name} | perl normalize-punctuation.perl\", shell=True\r\n            ).decode(\"utf-8\").strip()\r\n        )\r\n        default_diff = norm_default.normalize(data).strip() != perl_output\r\n        updated_diff = norm_updated.normalize(data).strip() != perl_output\r\n    return (default_diff, updated_diff)\r\n\r\nasync def main():\r\n    flores_dir = Path(\"/path/to/flores200_dataset\")\r\n    all_files = [\r\n        file.read_text().strip()\r\n        for ext in [\"dev\", \"devtest\"]\r\n        for file in flores_dir.glob(f\"*/*.{ext}\")\r\n    ]\r\n    norm_default = MosesPunctNormalizer()\r\n    norm_updated = MosesPunctNormalizer(perl_parity=True)\r\n    differences = await asyncio.gather(\r\n        *[check_for_differences(file, norm_default, norm_updated) for file in all_files]\r\n    )\r\n    default_differences, updated_differences = np.asarray(differences).sum(axis=0)\r\n    print(f\"total files: {len(differences)}\")\r\n    print(f\"differences with default args: {default_differences}\")\r\n    print(f\"differences with 'perl_parity=True': {updated_differences}\")\r\n\r\nasyncio.run(main())\r\n```\r\n\r\nResults produced from this code\r\n```\r\ntotal files: 408\r\ndifferences with default args: 188\r\ndifferences with 'perl_parity=True': 0\r\n```", "created_at": "2023-10-20T16:19:14Z", "updated_at": "2023-10-26T15:48:51Z", "closed_at": "2023-10-26T15:48:51Z", "merged_at": "2023-10-26T15:48:51Z", "merge_commit_sha": "8d32b0ec27f2bc49fd6724067226a28759b1647c", "assignee": null, "assignees": [], "requested_reviewers": [{"login": "heffernankevin", "id": 73017975, "node_id": "MDQ6VXNlcjczMDE3OTc1", "avatar_url": "https://avatars.githubusercontent.com/u/73017975?v=4", "gravatar_id": "", "url": "https://api.github.com/users/heffernankevin", "html_url": "https://github.com/heffernankevin", "followers_url": "https://api.github.com/users/heffernankevin/followers", "following_url": "https://api.github.com/users/heffernankevin/following{/other_user}", "gists_url": "https://api.github.com/users/heffernankevin/gists{/gist_id}", "starred_url": "https://api.github.com/users/heffernankevin/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/heffernankevin/subscriptions", "organizations_url": "https://api.github.com/users/heffernankevin/orgs", "repos_url": "https://api.github.com/users/heffernankevin/repos", "events_url": "https://api.github.com/users/heffernankevin/events{/privacy}", "received_events_url": "https://api.github.com/users/heffernankevin/received_events", "type": "User", "site_admin": false}], "requested_teams": [], "labels": [], "milestone": null, "draft": false, "commits_url": "https://api.github.com/repos/hplt-project/sacremoses/pulls/146/commits", "review_comments_url": "https://api.github.com/repos/hplt-project/sacremoses/pulls/146/comments", "review_comment_url": "https://api.github.com/repos/hplt-project/sacremoses/pulls/comments{/number}", "comments_url": "https://api.github.com/repos/hplt-project/sacremoses/issues/146/comments", "statuses_url": "https://api.github.com/repos/hplt-project/sacremoses/statuses/4164186292ed9dd5ea84876c17cc1d5a8cb76bea", "head": {"label": "NIXBLACK11:parity-with-perl-normalize", "ref": "parity-with-perl-normalize", "sha": "4164186292ed9dd5ea84876c17cc1d5a8cb76bea", "user": {"login": "NIXBLACK11", "id": 91743459, "node_id": "U_kgDOBXfk4w", "avatar_url": "https://avatars.githubusercontent.com/u/91743459?v=4", "gravatar_id": "", "url": "https://api.github.com/users/NIXBLACK11", "html_url": "https://github.com/NIXBLACK11", "followers_url": "https://api.github.com/users/NIXBLACK11/followers", "following_url": "https://api.github.com/users/NIXBLACK11/following{/other_user}", "gists_url": "https://api.github.com/users/NIXBLACK11/gists{/gist_id}", "starred_url": "https://api.github.com/users/NIXBLACK11/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/NIXBLACK11/subscriptions", "organizations_url": "https://api.github.com/users/NIXBLACK11/orgs", "repos_url": "https://api.github.com/users/NIXBLACK11/repos", "events_url": "https://api.github.com/users/NIXBLACK11/events{/privacy}", "received_events_url": "https://api.github.com/users/NIXBLACK11/received_events", "type": "User", "site_admin": false}, "repo": {"id": 705225446, "node_id": "R_kgDOKgji5g", "name": "sacremoses-fork", "full_name": "NIXBLACK11/sacremoses-fork", "private": false, "owner": {"login": "NIXBLACK11", "id": 91743459, "node_id": "U_kgDOBXfk4w", "avatar_url": "https://avatars.githubusercontent.com/u/91743459?v=4", "gravatar_id": "", "url": "https://api.github.com/users/NIXBLACK11", "html_url": "https://github.com/NIXBLACK11", "followers_url": "https://api.github.com/users/NIXBLACK11/followers", "following_url": "https://api.github.com/users/NIXBLACK11/following{/other_user}", "gists_url": "https://api.github.com/users/NIXBLACK11/gists{/gist_id}", "starred_url": "https://api.github.com/users/NIXBLACK11/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/NIXBLACK11/subscriptions", "organizations_url": "https://api.github.com/users/NIXBLACK11/orgs", "repos_url": "https://api.github.com/users/NIXBLACK11/repos", "events_url": "https://api.github.com/users/NIXBLACK11/events{/privacy}", "received_events_url": "https://api.github.com/users/NIXBLACK11/received_events", "type": "User", "site_admin": false}, "html_url": "https://github.com/NIXBLACK11/sacremoses-fork", "description": "Python port of Moses tokenizer, truecaser and normalizer", "fork": true, "url": "https://api.github.com/repos/NIXBLACK11/sacremoses-fork", "forks_url": "https://api.github.com/repos/NIXBLACK11/sacremoses-fork/forks", "keys_url": "https://api.github.com/repos/NIXBLACK11/sacremoses-fork/keys{/key_id}", "collaborators_url": "https://api.github.com/repos/NIXBLACK11/sacremoses-fork/collaborators{/collaborator}", "teams_url": "https://api.github.com/repos/NIXBLACK11/sacremoses-fork/teams", "hooks_url": "https://api.github.com/repos/NIXBLACK11/sacremoses-fork/hooks", "issue_events_url": "https://api.github.com/repos/NIXBLACK11/sacremoses-fork/issues/events{/number}", "events_url": "https://api.github.com/repos/NIXBLACK11/sacremoses-fork/events", "assignees_url": "https://api.github.com/repos/NIXBLACK11/sacremoses-fork/assignees{/user}", "branches_url": "https://api.github.com/repos/NIXBLACK11/sacremoses-fork/branches{/branch}", "tags_url": "https://api.github.com/repos/NIXBLACK11/sacremoses-fork/tags", "blobs_url": "https://api.github.com/repos/NIXBLACK11/sacremoses-fork/git/blobs{/sha}", "git_tags_url": "https://api.github.com/repos/NIXBLACK11/sacremoses-fork/git/tags{/sha}", "git_refs_url": "https://api.github.com/repos/NIXBLACK11/sacremoses-fork/git/refs{/sha}", "trees_url": "https://api.github.com/repos/NIXBLACK11/sacremoses-fork/git/trees{/sha}", "statuses_url": "https://api.github.com/repos/NIXBLACK11/sacremoses-fork/statuses/{sha}", "languages_url": "https://api.github.com/repos/NIXBLACK11/sacremoses-fork/languages", "stargazers_url": "https://api.github.com/repos/NIXBLACK11/sacremoses-fork/stargazers", "contributors_url": "https://api.github.com/repos/NIXBLACK11/sacremoses-fork/contributors", "subscribers_url": "https://api.github.com/repos/NIXBLACK11/sacremoses-fork/subscribers", "subscription_url": "https://api.github.com/repos/NIXBLACK11/sacremoses-fork/subscription", "commits_url": "https://api.github.com/repos/NIXBLACK11/sacremoses-fork/commits{/sha}", "git_commits_url": "https://api.github.com/repos/NIXBLACK11/sacremoses-fork/git/commits{/sha}", "comments_url": "https://api.github.com/repos/NIXBLACK11/sacremoses-fork/comments{/number}", "issue_comment_url": "https://api.github.com/repos/NIXBLACK11/sacremoses-fork/issues/comments{/number}", "contents_url": "https://api.github.com/repos/NIXBLACK11/sacremoses-fork/contents/{+path}", "compare_url": "https://api.github.com/repos/NIXBLACK11/sacremoses-fork/compare/{base}...{head}", "merges_url": "https://api.github.com/repos/NIXBLACK11/sacremoses-fork/merges", "archive_url": "https://api.github.com/repos/NIXBLACK11/sacremoses-fork/{archive_format}{/ref}", "downloads_url": "https://api.github.com/repos/NIXBLACK11/sacremoses-fork/downloads", "issues_url": "https://api.github.com/repos/NIXBLACK11/sacremoses-fork/issues{/number}", "pulls_url": "https://api.github.com/repos/NIXBLACK11/sacremoses-fork/pulls{/number}", "milestones_url": "https://api.github.com/repos/NIXBLACK11/sacremoses-fork/milestones{/number}", "notifications_url": "https://api.github.com/repos/NIXBLACK11/sacremoses-fork/notifications{?since,all,participating}", "labels_url": "https://api.github.com/repos/NIXBLACK11/sacremoses-fork/labels{/name}", "releases_url": "https://api.github.com/repos/NIXBLACK11/sacremoses-fork/releases{/id}", "deployments_url": "https://api.github.com/repos/NIXBLACK11/sacremoses-fork/deployments", "created_at": "2023-10-15T12:17:56Z", "updated_at": "2023-10-15T12:17:57Z", "pushed_at": "2023-10-26T15:44:20Z", "git_url": "git://github.com/NIXBLACK11/sacremoses-fork.git", "ssh_url": "git@github.com:NIXBLACK11/sacremoses-fork.git", "clone_url": "https://github.com/NIXBLACK11/sacremoses-fork.git", "svn_url": "https://github.com/NIXBLACK11/sacremoses-fork", "homepage": "", "size": 708, "stargazers_count": 0, "watchers_count": 0, "language": null, "has_issues": false, "has_projects": true, "has_downloads": true, "has_wiki": true, "has_pages": false, "has_discussions": false, "forks_count": 0, "mirror_url": null, "archived": false, "disabled": false, "open_issues_count": 0, "license": {"key": "mit", "name": "MIT License", "spdx_id": "MIT", "url": "https://api.github.com/licenses/mit", "node_id": "MDc6TGljZW5zZTEz"}, "allow_forking": true, "is_template": false, "web_commit_signoff_required": false, "topics": [], "visibility": "public", "forks": 0, "open_issues": 0, "watchers": 0, "default_branch": "master"}}, "base": {"label": "hplt-project:master", "ref": "master", "sha": "303ae7f5f30f3011c50bc0d20883af820ffc8c9b", "user": {"login": "hplt-project", "id": 117281567, "node_id": "O_kgDOBv2THw", "avatar_url": "https://avatars.githubusercontent.com/u/117281567?v=4", "gravatar_id": "", "url": "https://api.github.com/users/hplt-project", "html_url": "https://github.com/hplt-project", "followers_url": "https://api.github.com/users/hplt-project/followers", "following_url": "https://api.github.com/users/hplt-project/following{/other_user}", "gists_url": "https://api.github.com/users/hplt-project/gists{/gist_id}", "starred_url": "https://api.github.com/users/hplt-project/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/hplt-project/subscriptions", "organizations_url": "https://api.github.com/users/hplt-project/orgs", "repos_url": "https://api.github.com/users/hplt-project/repos", "events_url": "https://api.github.com/users/hplt-project/events{/privacy}", "received_events_url": "https://api.github.com/users/hplt-project/received_events", "type": "Organization", "site_admin": false}, "repo": {"id": 130306621, "node_id": "MDEwOlJlcG9zaXRvcnkxMzAzMDY2MjE=", "name": "sacremoses", "full_name": "hplt-project/sacremoses", "private": false, "owner": {"login": "hplt-project", "id": 117281567, "node_id": "O_kgDOBv2THw", "avatar_url": "https://avatars.githubusercontent.com/u/117281567?v=4", "gravatar_id": "", "url": "https://api.github.com/users/hplt-project", "html_url": "https://github.com/hplt-project", "followers_url": "https://api.github.com/users/hplt-project/followers", "following_url": "https://api.github.com/users/hplt-project/following{/other_user}", "gists_url": "https://api.github.com/users/hplt-project/gists{/gist_id}", "starred_url": "https://api.github.com/users/hplt-project/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/hplt-project/subscriptions", "organizations_url": "https://api.github.com/users/hplt-project/orgs", "repos_url": "https://api.github.com/users/hplt-project/repos", "events_url": "https://api.github.com/users/hplt-project/events{/privacy}", "received_events_url": "https://api.github.com/users/hplt-project/received_events", "type": "Organization", "site_admin": false}, "html_url": "https://github.com/hplt-project/sacremoses", "description": "Python port of Moses tokenizer, truecaser and normalizer", "fork": false, "url": "https://api.github.com/repos/hplt-project/sacremoses", "forks_url": "https://api.github.com/repos/hplt-project/sacremoses/forks", "keys_url": "https://api.github.com/repos/hplt-project/sacremoses/keys{/key_id}", "collaborators_url": "https://api.github.com/repos/hplt-project/sacremoses/collaborators{/collaborator}", "teams_url": "https://api.github.com/repos/hplt-project/sacremoses/teams", "hooks_url": "https://api.github.com/repos/hplt-project/sacremoses/hooks", "issue_events_url": "https://api.github.com/repos/hplt-project/sacremoses/issues/events{/number}", "events_url": "https://api.github.com/repos/hplt-project/sacremoses/events", "assignees_url": "https://api.github.com/repos/hplt-project/sacremoses/assignees{/user}", "branches_url": "https://api.github.com/repos/hplt-project/sacremoses/branches{/branch}", "tags_url": "https://api.github.com/repos/hplt-project/sacremoses/tags", "blobs_url": "https://api.github.com/repos/hplt-project/sacremoses/git/blobs{/sha}", "git_tags_url": "https://api.github.com/repos/hplt-project/sacremoses/git/tags{/sha}", "git_refs_url": "https://api.github.com/repos/hplt-project/sacremoses/git/refs{/sha}", "trees_url": "https://api.github.com/repos/hplt-project/sacremoses/git/trees{/sha}", "statuses_url": "https://api.github.com/repos/hplt-project/sacremoses/statuses/{sha}", "languages_url": "https://api.github.com/repos/hplt-project/sacremoses/languages", "stargazers_url": "https://api.github.com/repos/hplt-project/sacremoses/stargazers", "contributors_url": "https://api.github.com/repos/hplt-project/sacremoses/contributors", "subscribers_url": "https://api.github.com/repos/hplt-project/sacremoses/subscribers", "subscription_url": "https://api.github.com/repos/hplt-project/sacremoses/subscription", "commits_url": "https://api.github.com/repos/hplt-project/sacremoses/commits{/sha}", "git_commits_url": "https://api.github.com/repos/hplt-project/sacremoses/git/commits{/sha}", "comments_url": "https://api.github.com/repos/hplt-project/sacremoses/comments{/number}", "issue_comment_url": "https://api.github.com/repos/hplt-project/sacremoses/issues/comments{/number}", "contents_url": "https://api.github.com/repos/hplt-project/sacremoses/contents/{+path}", "compare_url": "https://api.github.com/repos/hplt-project/sacremoses/compare/{base}...{head}", "merges_url": "https://api.github.com/repos/hplt-project/sacremoses/merges", "archive_url": "https://api.github.com/repos/hplt-project/sacremoses/{archive_format}{/ref}", "downloads_url": "https://api.github.com/repos/hplt-project/sacremoses/downloads", "issues_url": "https://api.github.com/repos/hplt-project/sacremoses/issues{/number}", "pulls_url": "https://api.github.com/repos/hplt-project/sacremoses/pulls{/number}", "milestones_url": "https://api.github.com/repos/hplt-project/sacremoses/milestones{/number}", "notifications_url": "https://api.github.com/repos/hplt-project/sacremoses/notifications{?since,all,participating}", "labels_url": "https://api.github.com/repos/hplt-project/sacremoses/labels{/name}", "releases_url": "https://api.github.com/repos/hplt-project/sacremoses/releases{/id}", "deployments_url": "https://api.github.com/repos/hplt-project/sacremoses/deployments", "created_at": "2018-04-20T03:59:25Z", "updated_at": "2024-08-19T12:04:07Z", "pushed_at": "2024-05-26T09:50:01Z", "git_url": "git://github.com/hplt-project/sacremoses.git", "ssh_url": "git@github.com:hplt-project/sacremoses.git", "clone_url": "https://github.com/hplt-project/sacremoses.git", "svn_url": "https://github.com/hplt-project/sacremoses", "homepage": "", "size": 741, "stargazers_count": 485, "watchers_count": 485, "language": "Python", "has_issues": true, "has_projects": true, "has_downloads": true, "has_wiki": true, "has_pages": false, "has_discussions": false, "forks_count": 59, "mirror_url": null, "archived": false, "disabled": false, "open_issues_count": 31, "license": {"key": "mit", "name": "MIT License", "spdx_id": "MIT", "url": "https://api.github.com/licenses/mit", "node_id": "MDc6TGljZW5zZTEz"}, "allow_forking": true, "is_template": false, "web_commit_signoff_required": false, "topics": ["machine-translation", "nlp", "tokenizer"], "visibility": "public", "forks": 59, "open_issues": 31, "watchers": 485, "default_branch": "master"}}, "_links": {"self": {"href": "https://api.github.com/repos/hplt-project/sacremoses/pulls/146"}, "html": {"href": "https://github.com/hplt-project/sacremoses/pull/146"}, "issue": {"href": "https://api.github.com/repos/hplt-project/sacremoses/issues/146"}, "comments": {"href": "https://api.github.com/repos/hplt-project/sacremoses/issues/146/comments"}, "review_comments": {"href": "https://api.github.com/repos/hplt-project/sacremoses/pulls/146/comments"}, "review_comment": {"href": "https://api.github.com/repos/hplt-project/sacremoses/pulls/comments{/number}"}, "commits": {"href": "https://api.github.com/repos/hplt-project/sacremoses/pulls/146/commits"}, "statuses": {"href": "https://api.github.com/repos/hplt-project/sacremoses/statuses/4164186292ed9dd5ea84876c17cc1d5a8cb76bea"}}, "author_association": "CONTRIBUTOR", "auto_merge": null, "active_lock_reason": null, "resolved_issues": []}
