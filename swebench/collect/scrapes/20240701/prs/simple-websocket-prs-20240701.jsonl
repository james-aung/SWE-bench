{"url": "https://api.github.com/repos/miguelgrinberg/simple-websocket/pulls/35", "id": 1670708276, "node_id": "PR_kwDOFWV1zM5jlPw0", "html_url": "https://github.com/miguelgrinberg/simple-websocket/pull/35", "diff_url": "https://github.com/miguelgrinberg/simple-websocket/pull/35.diff", "patch_url": "https://github.com/miguelgrinberg/simple-websocket/pull/35.patch", "issue_url": "https://api.github.com/repos/miguelgrinberg/simple-websocket/issues/35", "number": 35, "state": "closed", "locked": false, "title": "Improve handling of immediately closed sockets with Ping/Pong enabled", "user": {"login": "lkedziora", "id": 122814467, "node_id": "U_kgDOB1IAAw", "avatar_url": "https://avatars.githubusercontent.com/u/122814467?v=4", "gravatar_id": "", "url": "https://api.github.com/users/lkedziora", "html_url": "https://github.com/lkedziora", "followers_url": "https://api.github.com/users/lkedziora/followers", "following_url": "https://api.github.com/users/lkedziora/following{/other_user}", "gists_url": "https://api.github.com/users/lkedziora/gists{/gist_id}", "starred_url": "https://api.github.com/users/lkedziora/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/lkedziora/subscriptions", "organizations_url": "https://api.github.com/users/lkedziora/orgs", "repos_url": "https://api.github.com/users/lkedziora/repos", "events_url": "https://api.github.com/users/lkedziora/events{/privacy}", "received_events_url": "https://api.github.com/users/lkedziora/received_events", "type": "User", "site_admin": false}, "body": "This PR fixes two smaller issues around handling of disconnected sockets when Ping/Pong is enabled.\r\n1. When Ping/Pong is enabled, the handler thread first registers the socket in the chosen selector. However, it is possible for a different thread to call `ws.close()` before the handler thread gets a chance to run, which results in the thread dying with an exception when registering the (now closed) socket.\r\n2. Ping/Pong logic may attempt to send the Ping in an invalid WS state, which results in an exception.\r\n\r\n## Reproducing\r\n\r\nBoth of these issues can be reproduced using the following:\r\n\r\n`server.py`\r\n```python\r\nfrom flask import Flask, Response, request\r\nfrom simple_websocket import Server, ConnectionClosed\r\nimport logging\r\nimport traceback\r\n\r\napp = Flask(__name__)\r\n\r\ndef patch_server_for_cleaner_output():\r\n    original = Server._thread\r\n\r\n    def patched_wrapper(self, *args, **kwargs):\r\n        try:\r\n            original(self, *args, **kwargs)\r\n        except Exception as e:\r\n            print()\r\n            print(\"Caught exception in WebSocket handler thread:\", e, flush=True)\r\n            print(\"Socket state:\", self.sock, flush=True)\r\n            print(\"Is connected?\", self.connected, flush=True)\r\n            traceback.print_exc()\r\n\r\n    Server._thread = patched_wrapper\r\n\r\n# Comment this out for cleaner output\r\n# patch_server_for_cleaner_output()\r\n\r\n@app.route('/command', websocket=True)\r\ndef command():\r\n    # The issue only occurs when ping is enabled\r\n    ws = Server.accept(request.environ, ping_interval=25)\r\n\r\n    # Real-life scenario: the server can handle the client, but\r\n    # for whatever reason a process fails and the connection is\r\n    # closed very quickly.\r\n    # The key here is that the connection is closed before the\r\n    # handler thread has had the chance to run.\r\n    try:\r\n        ws.close(4000, \"server-side process failed\")\r\n    except ConnectionClosed:\r\n        pass\r\n\r\n    return Response()\r\n\r\nif __name__ == '__main__':\r\n    # Silence request logging\r\n    log = logging.getLogger('werkzeug')\r\n    log.setLevel(logging.ERROR)\r\n    app.run()\r\n\r\n```\r\n\r\n`client.py`\r\n```python\r\nfrom simple_websocket import Client\r\nimport time\r\n\r\ndef main():\r\n    # What the client does is generally irrelevant to both issues\r\n    # This just helps with quickly getting a reproduction\r\n    while True:\r\n        ws = Client.connect('ws://localhost:5000/command')\r\n        try:\r\n            _ = ws.receive()\r\n            ws.close()\r\n        except:\r\n            pass\r\n        time.sleep(0.1)\r\n\r\nif __name__ == \"__main__\":\r\n    main()\r\n\r\n```\r\n\r\nSteps for reproduction:\r\n\r\n1. `python server.py`\r\n2. `python client.py`\r\n3. Wait for the exceptions to occur on the server.\r\n\r\nOne of the following can occur:\r\n\r\n```\r\nException in thread Thread-120 (simple_websocket.Base._thread):\r\nTraceback (most recent call last):\r\n  File \"/usr/lib/python3.11/threading.py\", line 1038, in _bootstrap_inner\r\n    self.run()\r\n  File \"/usr/lib/python3.11/threading.py\", line 975, in run\r\n    self._target(*self._args, **self._kwargs)\r\n  File \"/sources/.venv/lib/python3.11/site-packages/simple_websocket/ws.py\", line 135, in _thread\r\n    sel.register(self.sock, selectors.EVENT_READ, True)\r\n  File \"/usr/lib/python3.11/selectors.py\", line 352, in register\r\n    key = super().register(fileobj, events, data)\r\n          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/lib/python3.11/selectors.py\", line 238, in register\r\n    key = SelectorKey(fileobj, self._fileobj_lookup(fileobj), events, data)\r\n                               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/lib/python3.11/selectors.py\", line 225, in _fileobj_lookup\r\n    return _fileobj_to_fd(fileobj)\r\n           ^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/lib/python3.11/selectors.py\", line 42, in _fileobj_to_fd\r\n    raise ValueError(\"Invalid file descriptor: {}\".format(fd))\r\nValueError: Invalid file descriptor: -1\r\n```\r\n\r\n```\r\nException in thread Thread-350 (simple_websocket.Base._thread):\r\nTraceback (most recent call last):\r\n  File \"/usr/lib/python3.11/threading.py\", line 1038, in _bootstrap_inner\r\n    self.run()\r\n  File \"/usr/lib/python3.11/threading.py\", line 975, in run\r\n    self._target(*self._args, **self._kwargs)\r\n  File \"/sources/.venv/lib/python3.11/site-packages/simple_websocket/ws.py\", line 148, in _thread\r\n    self.sock.send(self.ws.send(Ping()))\r\n                   ^^^^^^^^^^^^^^^^^^^^\r\n  File \"/sources/.venv/lib/python3.11/site-packages/wsproto/__init__.py\", line 64, in send\r\n    data += self.connection.send(event)\r\n            ^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/sources/.venv/lib/python3.11/site-packages/wsproto/connection.py\", line 107, in send\r\n    raise LocalProtocolError(\r\nwsproto.utilities.LocalProtocolError: Event Ping(payload=b'') cannot be sent in state ConnectionState.LOCAL_CLOSING.\r\n```\r\n\r\nThese are inherently racy, so it might take a bit for both of them to appear.\r\n", "created_at": "2024-01-09T14:09:12Z", "updated_at": "2024-01-10T07:02:35Z", "closed_at": "2024-01-10T00:10:17Z", "merged_at": "2024-01-10T00:10:17Z", "merge_commit_sha": "632ec52ce1fce4908b9733e3d24935b2a0514472", "assignee": null, "assignees": [], "requested_reviewers": [], "requested_teams": [], "labels": [], "milestone": null, "draft": false, "commits_url": "https://api.github.com/repos/miguelgrinberg/simple-websocket/pulls/35/commits", "review_comments_url": "https://api.github.com/repos/miguelgrinberg/simple-websocket/pulls/35/comments", "review_comment_url": "https://api.github.com/repos/miguelgrinberg/simple-websocket/pulls/comments{/number}", "comments_url": "https://api.github.com/repos/miguelgrinberg/simple-websocket/issues/35/comments", "statuses_url": "https://api.github.com/repos/miguelgrinberg/simple-websocket/statuses/96f66e6f48c5c064051a705dbe24604b9d1d39bf", "head": {"label": "antmicro:fix-closed-socket-exceptions", "ref": "fix-closed-socket-exceptions", "sha": "96f66e6f48c5c064051a705dbe24604b9d1d39bf", "user": {"login": "antmicro", "id": 927785, "node_id": "MDEyOk9yZ2FuaXphdGlvbjkyNzc4NQ==", "avatar_url": "https://avatars.githubusercontent.com/u/927785?v=4", "gravatar_id": "", "url": "https://api.github.com/users/antmicro", "html_url": "https://github.com/antmicro", "followers_url": "https://api.github.com/users/antmicro/followers", "following_url": "https://api.github.com/users/antmicro/following{/other_user}", "gists_url": "https://api.github.com/users/antmicro/gists{/gist_id}", "starred_url": "https://api.github.com/users/antmicro/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/antmicro/subscriptions", "organizations_url": "https://api.github.com/users/antmicro/orgs", "repos_url": "https://api.github.com/users/antmicro/repos", "events_url": "https://api.github.com/users/antmicro/events{/privacy}", "received_events_url": "https://api.github.com/users/antmicro/received_events", "type": "Organization", "site_admin": false}, "repo": {"id": 719559631, "node_id": "R_kgDOKuObzw", "name": "simple-websocket", "full_name": "antmicro/simple-websocket", "private": false, "owner": {"login": "antmicro", "id": 927785, "node_id": "MDEyOk9yZ2FuaXphdGlvbjkyNzc4NQ==", "avatar_url": "https://avatars.githubusercontent.com/u/927785?v=4", "gravatar_id": "", "url": "https://api.github.com/users/antmicro", "html_url": "https://github.com/antmicro", "followers_url": "https://api.github.com/users/antmicro/followers", "following_url": "https://api.github.com/users/antmicro/following{/other_user}", "gists_url": "https://api.github.com/users/antmicro/gists{/gist_id}", "starred_url": "https://api.github.com/users/antmicro/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/antmicro/subscriptions", "organizations_url": "https://api.github.com/users/antmicro/orgs", "repos_url": "https://api.github.com/users/antmicro/repos", "events_url": "https://api.github.com/users/antmicro/events{/privacy}", "received_events_url": "https://api.github.com/users/antmicro/received_events", "type": "Organization", "site_admin": false}, "html_url": "https://github.com/antmicro/simple-websocket", "description": "Simple WebSocket server and client for Python.", "fork": true, "url": "https://api.github.com/repos/antmicro/simple-websocket", "forks_url": "https://api.github.com/repos/antmicro/simple-websocket/forks", "keys_url": "https://api.github.com/repos/antmicro/simple-websocket/keys{/key_id}", "collaborators_url": "https://api.github.com/repos/antmicro/simple-websocket/collaborators{/collaborator}", "teams_url": "https://api.github.com/repos/antmicro/simple-websocket/teams", "hooks_url": "https://api.github.com/repos/antmicro/simple-websocket/hooks", "issue_events_url": "https://api.github.com/repos/antmicro/simple-websocket/issues/events{/number}", "events_url": "https://api.github.com/repos/antmicro/simple-websocket/events", "assignees_url": "https://api.github.com/repos/antmicro/simple-websocket/assignees{/user}", "branches_url": "https://api.github.com/repos/antmicro/simple-websocket/branches{/branch}", "tags_url": "https://api.github.com/repos/antmicro/simple-websocket/tags", "blobs_url": "https://api.github.com/repos/antmicro/simple-websocket/git/blobs{/sha}", "git_tags_url": "https://api.github.com/repos/antmicro/simple-websocket/git/tags{/sha}", "git_refs_url": "https://api.github.com/repos/antmicro/simple-websocket/git/refs{/sha}", "trees_url": "https://api.github.com/repos/antmicro/simple-websocket/git/trees{/sha}", "statuses_url": "https://api.github.com/repos/antmicro/simple-websocket/statuses/{sha}", "languages_url": "https://api.github.com/repos/antmicro/simple-websocket/languages", "stargazers_url": "https://api.github.com/repos/antmicro/simple-websocket/stargazers", "contributors_url": "https://api.github.com/repos/antmicro/simple-websocket/contributors", "subscribers_url": "https://api.github.com/repos/antmicro/simple-websocket/subscribers", "subscription_url": "https://api.github.com/repos/antmicro/simple-websocket/subscription", "commits_url": "https://api.github.com/repos/antmicro/simple-websocket/commits{/sha}", "git_commits_url": "https://api.github.com/repos/antmicro/simple-websocket/git/commits{/sha}", "comments_url": "https://api.github.com/repos/antmicro/simple-websocket/comments{/number}", "issue_comment_url": "https://api.github.com/repos/antmicro/simple-websocket/issues/comments{/number}", "contents_url": "https://api.github.com/repos/antmicro/simple-websocket/contents/{+path}", "compare_url": "https://api.github.com/repos/antmicro/simple-websocket/compare/{base}...{head}", "merges_url": "https://api.github.com/repos/antmicro/simple-websocket/merges", "archive_url": "https://api.github.com/repos/antmicro/simple-websocket/{archive_format}{/ref}", "downloads_url": "https://api.github.com/repos/antmicro/simple-websocket/downloads", "issues_url": "https://api.github.com/repos/antmicro/simple-websocket/issues{/number}", "pulls_url": "https://api.github.com/repos/antmicro/simple-websocket/pulls{/number}", "milestones_url": "https://api.github.com/repos/antmicro/simple-websocket/milestones{/number}", "notifications_url": "https://api.github.com/repos/antmicro/simple-websocket/notifications{?since,all,participating}", "labels_url": "https://api.github.com/repos/antmicro/simple-websocket/labels{/name}", "releases_url": "https://api.github.com/repos/antmicro/simple-websocket/releases{/id}", "deployments_url": "https://api.github.com/repos/antmicro/simple-websocket/deployments", "created_at": "2023-11-16T12:32:42Z", "updated_at": "2024-01-09T10:47:36Z", "pushed_at": "2024-01-10T11:42:51Z", "git_url": "git://github.com/antmicro/simple-websocket.git", "ssh_url": "git@github.com:antmicro/simple-websocket.git", "clone_url": "https://github.com/antmicro/simple-websocket.git", "svn_url": "https://github.com/antmicro/simple-websocket", "homepage": "", "size": 109, "stargazers_count": 0, "watchers_count": 0, "language": "Python", "has_issues": false, "has_projects": true, "has_downloads": true, "has_wiki": true, "has_pages": false, "has_discussions": false, "forks_count": 0, "mirror_url": null, "archived": false, "disabled": false, "open_issues_count": 0, "license": {"key": "mit", "name": "MIT License", "spdx_id": "MIT", "url": "https://api.github.com/licenses/mit", "node_id": "MDc6TGljZW5zZTEz"}, "allow_forking": true, "is_template": false, "web_commit_signoff_required": false, "topics": [], "visibility": "public", "forks": 0, "open_issues": 0, "watchers": 0, "default_branch": "main"}}, "base": {"label": "miguelgrinberg:main", "ref": "main", "sha": "5a5dbecd23e67c09780c21af586ca9e36c6b6417", "user": {"login": "miguelgrinberg", "id": 2715854, "node_id": "MDQ6VXNlcjI3MTU4NTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/2715854?v=4", "gravatar_id": "", "url": "https://api.github.com/users/miguelgrinberg", "html_url": "https://github.com/miguelgrinberg", "followers_url": "https://api.github.com/users/miguelgrinberg/followers", "following_url": "https://api.github.com/users/miguelgrinberg/following{/other_user}", "gists_url": "https://api.github.com/users/miguelgrinberg/gists{/gist_id}", "starred_url": "https://api.github.com/users/miguelgrinberg/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/miguelgrinberg/subscriptions", "organizations_url": "https://api.github.com/users/miguelgrinberg/orgs", "repos_url": "https://api.github.com/users/miguelgrinberg/repos", "events_url": "https://api.github.com/users/miguelgrinberg/events{/privacy}", "received_events_url": "https://api.github.com/users/miguelgrinberg/received_events", "type": "User", "site_admin": false}, "repo": {"id": 358970828, "node_id": "MDEwOlJlcG9zaXRvcnkzNTg5NzA4Mjg=", "name": "simple-websocket", "full_name": "miguelgrinberg/simple-websocket", "private": false, "owner": {"login": "miguelgrinberg", "id": 2715854, "node_id": "MDQ6VXNlcjI3MTU4NTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/2715854?v=4", "gravatar_id": "", "url": "https://api.github.com/users/miguelgrinberg", "html_url": "https://github.com/miguelgrinberg", "followers_url": "https://api.github.com/users/miguelgrinberg/followers", "following_url": "https://api.github.com/users/miguelgrinberg/following{/other_user}", "gists_url": "https://api.github.com/users/miguelgrinberg/gists{/gist_id}", "starred_url": "https://api.github.com/users/miguelgrinberg/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/miguelgrinberg/subscriptions", "organizations_url": "https://api.github.com/users/miguelgrinberg/orgs", "repos_url": "https://api.github.com/users/miguelgrinberg/repos", "events_url": "https://api.github.com/users/miguelgrinberg/events{/privacy}", "received_events_url": "https://api.github.com/users/miguelgrinberg/received_events", "type": "User", "site_admin": false}, "html_url": "https://github.com/miguelgrinberg/simple-websocket", "description": "Simple WebSocket server and client for Python.", "fork": false, "url": "https://api.github.com/repos/miguelgrinberg/simple-websocket", "forks_url": "https://api.github.com/repos/miguelgrinberg/simple-websocket/forks", "keys_url": "https://api.github.com/repos/miguelgrinberg/simple-websocket/keys{/key_id}", "collaborators_url": "https://api.github.com/repos/miguelgrinberg/simple-websocket/collaborators{/collaborator}", "teams_url": "https://api.github.com/repos/miguelgrinberg/simple-websocket/teams", "hooks_url": "https://api.github.com/repos/miguelgrinberg/simple-websocket/hooks", "issue_events_url": "https://api.github.com/repos/miguelgrinberg/simple-websocket/issues/events{/number}", "events_url": "https://api.github.com/repos/miguelgrinberg/simple-websocket/events", "assignees_url": "https://api.github.com/repos/miguelgrinberg/simple-websocket/assignees{/user}", "branches_url": "https://api.github.com/repos/miguelgrinberg/simple-websocket/branches{/branch}", "tags_url": "https://api.github.com/repos/miguelgrinberg/simple-websocket/tags", "blobs_url": "https://api.github.com/repos/miguelgrinberg/simple-websocket/git/blobs{/sha}", "git_tags_url": "https://api.github.com/repos/miguelgrinberg/simple-websocket/git/tags{/sha}", "git_refs_url": "https://api.github.com/repos/miguelgrinberg/simple-websocket/git/refs{/sha}", "trees_url": "https://api.github.com/repos/miguelgrinberg/simple-websocket/git/trees{/sha}", "statuses_url": "https://api.github.com/repos/miguelgrinberg/simple-websocket/statuses/{sha}", "languages_url": "https://api.github.com/repos/miguelgrinberg/simple-websocket/languages", "stargazers_url": "https://api.github.com/repos/miguelgrinberg/simple-websocket/stargazers", "contributors_url": "https://api.github.com/repos/miguelgrinberg/simple-websocket/contributors", "subscribers_url": "https://api.github.com/repos/miguelgrinberg/simple-websocket/subscribers", "subscription_url": "https://api.github.com/repos/miguelgrinberg/simple-websocket/subscription", "commits_url": "https://api.github.com/repos/miguelgrinberg/simple-websocket/commits{/sha}", "git_commits_url": "https://api.github.com/repos/miguelgrinberg/simple-websocket/git/commits{/sha}", "comments_url": "https://api.github.com/repos/miguelgrinberg/simple-websocket/comments{/number}", "issue_comment_url": "https://api.github.com/repos/miguelgrinberg/simple-websocket/issues/comments{/number}", "contents_url": "https://api.github.com/repos/miguelgrinberg/simple-websocket/contents/{+path}", "compare_url": "https://api.github.com/repos/miguelgrinberg/simple-websocket/compare/{base}...{head}", "merges_url": "https://api.github.com/repos/miguelgrinberg/simple-websocket/merges", "archive_url": "https://api.github.com/repos/miguelgrinberg/simple-websocket/{archive_format}{/ref}", "downloads_url": "https://api.github.com/repos/miguelgrinberg/simple-websocket/downloads", "issues_url": "https://api.github.com/repos/miguelgrinberg/simple-websocket/issues{/number}", "pulls_url": "https://api.github.com/repos/miguelgrinberg/simple-websocket/pulls{/number}", "milestones_url": "https://api.github.com/repos/miguelgrinberg/simple-websocket/milestones{/number}", "notifications_url": "https://api.github.com/repos/miguelgrinberg/simple-websocket/notifications{?since,all,participating}", "labels_url": "https://api.github.com/repos/miguelgrinberg/simple-websocket/labels{/name}", "releases_url": "https://api.github.com/repos/miguelgrinberg/simple-websocket/releases{/id}", "deployments_url": "https://api.github.com/repos/miguelgrinberg/simple-websocket/deployments", "created_at": "2021-04-17T19:59:47Z", "updated_at": "2024-08-14T21:38:08Z", "pushed_at": "2024-04-27T23:45:26Z", "git_url": "git://github.com/miguelgrinberg/simple-websocket.git", "ssh_url": "git@github.com:miguelgrinberg/simple-websocket.git", "clone_url": "https://github.com/miguelgrinberg/simple-websocket.git", "svn_url": "https://github.com/miguelgrinberg/simple-websocket", "homepage": "", "size": 113, "stargazers_count": 76, "watchers_count": 76, "language": "Python", "has_issues": true, "has_projects": true, "has_downloads": true, "has_wiki": true, "has_pages": false, "has_discussions": false, "forks_count": 17, "mirror_url": null, "archived": false, "disabled": false, "open_issues_count": 4, "license": {"key": "mit", "name": "MIT License", "spdx_id": "MIT", "url": "https://api.github.com/licenses/mit", "node_id": "MDc6TGljZW5zZTEz"}, "allow_forking": true, "is_template": false, "web_commit_signoff_required": false, "topics": ["websocket"], "visibility": "public", "forks": 17, "open_issues": 4, "watchers": 76, "default_branch": "main"}}, "_links": {"self": {"href": "https://api.github.com/repos/miguelgrinberg/simple-websocket/pulls/35"}, "html": {"href": "https://github.com/miguelgrinberg/simple-websocket/pull/35"}, "issue": {"href": "https://api.github.com/repos/miguelgrinberg/simple-websocket/issues/35"}, "comments": {"href": "https://api.github.com/repos/miguelgrinberg/simple-websocket/issues/35/comments"}, "review_comments": {"href": "https://api.github.com/repos/miguelgrinberg/simple-websocket/pulls/35/comments"}, "review_comment": {"href": "https://api.github.com/repos/miguelgrinberg/simple-websocket/pulls/comments{/number}"}, "commits": {"href": "https://api.github.com/repos/miguelgrinberg/simple-websocket/pulls/35/commits"}, "statuses": {"href": "https://api.github.com/repos/miguelgrinberg/simple-websocket/statuses/96f66e6f48c5c064051a705dbe24604b9d1d39bf"}}, "author_association": "CONTRIBUTOR", "auto_merge": null, "active_lock_reason": null, "resolved_issues": []}
